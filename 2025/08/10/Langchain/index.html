<!DOCTYPE html><html lang="zh-CN" theme-mode="dark"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1.0"><title>LangChainå…¥é—¨ | Zenith</title><link rel="icon" type="image/x-icon" href="/favicon.ico"><link rel="preload" as="font" crossorigin="anonymous" href="/font/Bender.ttf"><link rel="preload" as="font" crossorigin="anonymous" href="/font/BenderLight.ttf"><link rel="preload" as="font" crossorigin="anonymous" href="/font/JetBrainsMono-Regular.woff2"><link rel="stylesheet" href="/css/arknights.css"><style>@font-face {
  font-family: Bender;
  src: local('Bender'), url("/font/Bender.ttf"), url("/font/Bender.otf");
}
@font-face {
  font-family: BenderLight;
  src: local('BenderLight'), url("/font/BenderLight.ttf");
}
@font-face {
  font-family: 'JetBrains Mono';
  src: local('JetBrains Mono'), url('/font/JetBrainsMono-Regular.woff2') format('woff2');
}
</style><script>var config = {"root":"/","search":{"preload":false,"activeHolder":"Enter here","blurHolder":"Search","noResult":"Data \"$0\" not found"},"code":{"codeInfo":"$0 - $1 lines","copy":"copy"}}</script><link type="text/css" rel="stylesheet" href="/lib/encrypt/hbe.style.css"><script src="//unpkg.com/mermaid@10.5.0/dist/mermaid.min.js"></script><link type="text/css" rel="stylesheet" href="//unpkg.com/lightgallery@2.7.1/css/lightgallery.css"><link type="text/css" rel="stylesheet" href="//unpkg.com/lightgallery@2.7.1/css/lg-zoom.css"><link type="text/css" rel="stylesheet" href="//unpkg.com/lightgallery@2.7.1/css/lg-thumbnail.css"><link type="text/css" rel="stylesheet" href="/lib/fontawesome/css/all.min.css"><script>if (window.localStorage.getItem('theme-mode') === 'light')
 document.documentElement.setAttribute('theme-mode', 'light')
if (window.localStorage.getItem('theme-mode') === 'dark')
 document.documentElement.setAttribute('theme-mode', 'dark')</script><style>@font-face {
 font-family: BenderLight;
 src: local('Bender'), url("/font/BenderLight.woff2") format('woff2');
}
@font-face {
 font-family: 'JetBrains Mono';
 src: local('JetBrains Mono'), url('/font/JetBrainsMono-Regular.woff2') format('woff2');
}</style><style>:root {
 --dark-background: url('/img/yellow.jpg');
 --light-background: url('/img/green.jpg');
 --theme-encrypt-confirm: 'confirm'
}</style><script defer src="/js/arknights.js"></script><script defer src="/js/search.js"></script><script defer type="module">import mermaid from '//unpkg.com/mermaid@10.5.0/dist/mermaid.esm.mjs';
window.mermaid = mermaid;
code.paintMermaid();
</script><script async src="//unpkg.com/lightgallery@2.7.1/lightgallery.min.js"></script><script async src="//unpkg.com/lightgallery@2.7.1/plugins/zoom/lg-zoom.min.js"></script><script async src="//unpkg.com/lightgallery@2.7.1/plugins/thumbnail/lg-thumbnail.min.js"></script><script async src="/lib/encrypt/hbe.js"></script><script async src="/js/pjax.js"></script><script class="pjax-js">reset= () => {document.querySelector('.lg-container')?.remove()
lightGallery(document.getElementById('post-bg'), {
  plugins: [lgZoom,lgThumbnail],
  selector: '.item-img'})}</script><script>window.addEventListener("load",() => {pjax = new Pjax({
 cacheBust: false,
 selectors: ['title','article','#aside-block','.pjax-js','data-pjax','.busuanzi'],
 switches: {'article': Pjax.switches.sideBySide},
 switchesOptions: {
   'article': {
     classNames: {
       remove: "pjax-out",
       add: "pjax-in"
     }
   }
 }
});
document.addEventListener("pjax:complete", reset);reset()})</script><script class="pjax-js">reset= () => {document.querySelector('.lg-container')?.remove()
lightGallery(document.getElementById('post-bg'), {
  plugins: [lgZoom,lgThumbnail],
  selector: '.item-img'})}</script><script>window.addEventListener("load",() => {pjax = new Pjax({
 cacheBust: false,
 selectors: ['title','article','#aside-block','.pjax-js'],
 switches: {'article': Pjax.switches.sideBySide},
 switchesOptions: {
   'article': {
     classNames: {
       remove: "pjax-out",
       add: "pjax-in"
     }
   }
 }
});
document.addEventListener("pjax:complete", reset);reset()})</script><!-- çˆ†ç‚¸çº¢å¿ƒæ•ˆæœ -->
<canvas class="fireworks" style="position: fixed;left: 0;top: 0;z-index: 1; pointer-events: none;" ></canvas> 
<script type="text/javascript" src="//cdn.bootcss.com/animejs/2.2.0/anime.min.js"></script> 
<script type="text/javascript" src="/js/firework.js"></script><meta name="generator" content="Hexo 7.3.0"><link rel="alternate" href="/rss.xml" title="Zenith" type="application/rss+xml">
</head><body><script>(function () {  
    var a_idx = 0;  
    window.onclick = function (event) {  
        var a = new Array("è¿™ä¸€è·¯ä¸Šèµ°èµ°åœåœ","é¡ºç€å°‘å¹´æ¼‚æµçš„ç—•è¿¹","è¿ˆå‡ºè½¦ç«™çš„å‰ä¸€åˆ»","ç«Ÿæœ‰äº›çŠ¹è±«","ä¸ç¦ç¬‘è¿™è¿‘ä¹¡æƒ…æ€¯","ä»æ— æ³•é¿å…","è€Œé•¿é‡çš„å¤©","ä¾æ—§é‚£ä¹ˆæš–","é£å¹èµ·äº†ä»å‰",
        "ä»å‰åˆè¯†è¿™ä¸–é—´","ä¸‡èˆ¬æµè¿","çœ‹ç€å¤©è¾¹ä¼¼åœ¨çœ¼å‰","ä¹Ÿç”˜æ„¿èµ´æ±¤è¹ˆç«å»èµ°å®ƒä¸€é","å¦‚ä»Šèµ°è¿‡è¿™ä¸–é—´","ä¸‡èˆ¬æµè¿","ç¿»è¿‡å²æœˆä¸åŒä¾§è„¸","æªä¸åŠé˜²é—¯å…¥ä½ çš„ç¬‘é¢œ","æˆ‘æ›¾éš¾è‡ªæ‹”äºä¸–ç•Œä¹‹å¤§","ä¹Ÿæ²‰æººäºå…¶ä¸­æ¢¦è¯","ä¸å¾—çœŸå‡ ä¸åšæŒ£æ‰ ä¸æƒ§ç¬‘è¯","æˆ‘æ›¾å°†é’æ˜¥ç¿»æ¶Œæˆå¥¹","ä¹Ÿæ›¾æŒ‡å°–å¼¹å‡ºç››å¤","å¿ƒä¹‹æ‰€åŠ¨ ä¸”å°±éšç¼˜å»å§","é€†ç€å…‰è¡Œèµ° ä»»é£å¹é›¨æ‰“","çŸ­çŸ­çš„è·¯èµ°èµ°åœåœ","ä¹Ÿæœ‰äº†å‡ åˆ†çš„è·ç¦»","ä¸çŸ¥æŠšæ‘¸çš„æ˜¯æ•…äº‹","è¿˜æ˜¯æ®µå¿ƒæƒ…","ä¹Ÿè®¸æœŸå¾…çš„ä¸è¿‡æ˜¯","ä¸æ—¶é—´ä¸ºæ•Œ","å†æ¬¡è§åˆ°ä½ ","å¾®å‡‰æ™¨å…‰é‡Œ","ç¬‘å¾—å¾ˆç”œèœœ","ä»å‰åˆè¯†è¿™ä¸–é—´","ä¸‡èˆ¬æµè¿","çœ‹ç€å¤©è¾¹ä¼¼åœ¨çœ¼å‰","ä¹Ÿç”˜æ„¿èµ´æ±¤è¹ˆç«å»èµ°å®ƒä¸€é","å¦‚ä»Šèµ°è¿‡è¿™ä¸–é—´","ä¸‡èˆ¬æµè¿","ç¿»è¿‡å²æœˆä¸åŒä¾§è„¸","æªä¸åŠé˜²é—¯å…¥ä½ çš„ç¬‘é¢œ","æˆ‘æ›¾éš¾è‡ªæ‹”äºä¸–ç•Œä¹‹å¤§","ä¹Ÿæ²‰æººäºå…¶ä¸­æ¢¦è¯","ä¸åšçœŸå‡ ä¸åšæŒ£æ‰ ä¸æƒ§ç¬‘è¯","æˆ‘æ›¾å°†é’æ˜¥ç¿»æ¶Œæˆå¥¹","ä¹Ÿæ›¾æŒ‡å°–å¼¹å‡ºç››å¤","å¿ƒä¹‹æ‰€åŠ¨ ä¸”å°±éšç¼˜å»å§","æ™šé£å¹èµ·ä½ é¬“é—´çš„ç™½å‘","æŠšå¹³å›å¿†ç•™ä¸‹çš„ç–¤","ä½ çš„çœ¼ä¸­ æ˜æš—äº¤æ‚ ä¸€ç¬‘ç”ŸèŠ±","æš®è‰²é®ä½ä½ è¹’è·šçš„æ­¥ä¼","èµ°è¿›åºŠå¤´è—èµ·çš„ç”»","ç”»ä¸­çš„ä½  ä½ç€å¤´è¯´è¯","æˆ‘ä»æ„Ÿå¹äºä¸–ç•Œä¹‹å¤§","ä¹Ÿæ²‰é†‰äºå„¿æ—¶æƒ…è¯","ä¸å‰©çœŸå‡ ä¸åšæŒ£æ‰ æ— è°“ç¬‘è¯","æˆ‘ç»ˆå°†é’æ˜¥è¿˜ç»™äº†å¥¹","è¿åŒæŒ‡å°–å¼¹å‡ºçš„ç››å¤","å¿ƒä¹‹æ‰€åŠ¨ å°±éšé£å»äº†","ä»¥çˆ±ä¹‹å ä½ è¿˜æ„¿æ„å—",
        "è¿™ä¸€è·¯ä¸Šèµ°èµ°åœåœ","é¡ºç€å°‘å¹´æ¼‚æµçš„ç—•è¿¹","è¿ˆå‡ºè½¦ç«™çš„å‰ä¸€åˆ»","ç«Ÿæœ‰äº›çŠ¹è±«","ä¸ç¦ç¬‘è¿™è¿‘ä¹¡æƒ…æ€¯","ä»æ— æ³•é¿å…","è€Œé•¿é‡çš„å¤©","ä¾æ—§é‚£ä¹ˆæš–","é£å¹èµ·äº†ä»å‰",
        "ä»å‰åˆè¯†è¿™ä¸–é—´","ä¸‡èˆ¬æµè¿","çœ‹ç€å¤©è¾¹ä¼¼åœ¨çœ¼å‰","ä¹Ÿç”˜æ„¿èµ´æ±¤è¹ˆç«å»èµ°å®ƒä¸€é","å¦‚ä»Šèµ°è¿‡è¿™ä¸–é—´","ä¸‡èˆ¬æµè¿","ç¿»è¿‡å²æœˆä¸åŒä¾§è„¸","æªä¸åŠé˜²é—¯å…¥ä½ çš„ç¬‘é¢œ","æˆ‘æ›¾éš¾è‡ªæ‹”äºä¸–ç•Œä¹‹å¤§","ä¹Ÿæ²‰æººäºå…¶ä¸­æ¢¦è¯","ä¸å¾—çœŸå‡ ä¸åšæŒ£æ‰ ä¸æƒ§ç¬‘è¯","æˆ‘æ›¾å°†é’æ˜¥ç¿»æ¶Œæˆå¥¹","ä¹Ÿæ›¾æŒ‡å°–å¼¹å‡ºç››å¤","å¿ƒä¹‹æ‰€åŠ¨ ä¸”å°±éšç¼˜å»å§","é€†ç€å…‰è¡Œèµ° ä»»é£å¹é›¨æ‰“","çŸ­çŸ­çš„è·¯èµ°èµ°åœåœ","ä¹Ÿæœ‰äº†å‡ åˆ†çš„è·ç¦»","ä¸çŸ¥æŠšæ‘¸çš„æ˜¯æ•…äº‹","è¿˜æ˜¯æ®µå¿ƒæƒ…","ä¹Ÿè®¸æœŸå¾…çš„ä¸è¿‡æ˜¯","ä¸æ—¶é—´ä¸ºæ•Œ","å†æ¬¡è§åˆ°ä½ ","å¾®å‡‰æ™¨å…‰é‡Œ","ç¬‘å¾—å¾ˆç”œèœœ","ä»å‰åˆè¯†è¿™ä¸–é—´","ä¸‡èˆ¬æµè¿","çœ‹ç€å¤©è¾¹ä¼¼åœ¨çœ¼å‰","ä¹Ÿç”˜æ„¿èµ´æ±¤è¹ˆç«å»èµ°å®ƒä¸€é","å¦‚ä»Šèµ°è¿‡è¿™ä¸–é—´","ä¸‡èˆ¬æµè¿","ç¿»è¿‡å²æœˆä¸åŒä¾§è„¸","æªä¸åŠé˜²é—¯å…¥ä½ çš„ç¬‘é¢œ","æˆ‘æ›¾éš¾è‡ªæ‹”äºä¸–ç•Œä¹‹å¤§","ä¹Ÿæ²‰æººäºå…¶ä¸­æ¢¦è¯","ä¸åšçœŸå‡ ä¸åšæŒ£æ‰ ä¸æƒ§ç¬‘è¯","æˆ‘æ›¾å°†é’æ˜¥ç¿»æ¶Œæˆå¥¹","ä¹Ÿæ›¾æŒ‡å°–å¼¹å‡ºç››å¤","å¿ƒä¹‹æ‰€åŠ¨ ä¸”å°±éšç¼˜å»å§","æ™šé£å¹èµ·ä½ é¬“é—´çš„ç™½å‘","æŠšå¹³å›å¿†ç•™ä¸‹çš„ç–¤","ä½ çš„çœ¼ä¸­ æ˜æš—äº¤æ‚ ä¸€ç¬‘ç”ŸèŠ±","æš®è‰²é®ä½ä½ è¹’è·šçš„æ­¥ä¼","èµ°è¿›åºŠå¤´è—èµ·çš„ç”»","ç”»ä¸­çš„ä½  ä½ç€å¤´è¯´è¯","æˆ‘ä»æ„Ÿå¹äºä¸–ç•Œä¹‹å¤§","ä¹Ÿæ²‰é†‰äºå„¿æ—¶æƒ…è¯","ä¸å‰©çœŸå‡ ä¸åšæŒ£æ‰ æ— è°“ç¬‘è¯","æˆ‘ç»ˆå°†é’æ˜¥è¿˜ç»™äº†å¥¹","è¿åŒæŒ‡å°–å¼¹å‡ºçš„ç››å¤","å¿ƒä¹‹æ‰€åŠ¨ å°±éšé£å»äº†","ä»¥çˆ±ä¹‹å ä½ è¿˜æ„¿æ„å—",
        "è¿™ä¸€è·¯ä¸Šèµ°èµ°åœåœ","é¡ºç€å°‘å¹´æ¼‚æµçš„ç—•è¿¹","è¿ˆå‡ºè½¦ç«™çš„å‰ä¸€åˆ»","ç«Ÿæœ‰äº›çŠ¹è±«","ä¸ç¦ç¬‘è¿™è¿‘ä¹¡æƒ…æ€¯","ä»æ— æ³•é¿å…","è€Œé•¿é‡çš„å¤©","ä¾æ—§é‚£ä¹ˆæš–","é£å¹èµ·äº†ä»å‰",
        "ä»å‰åˆè¯†è¿™ä¸–é—´","ä¸‡èˆ¬æµè¿","çœ‹ç€å¤©è¾¹ä¼¼åœ¨çœ¼å‰","ä¹Ÿç”˜æ„¿èµ´æ±¤è¹ˆç«å»èµ°å®ƒä¸€é","å¦‚ä»Šèµ°è¿‡è¿™ä¸–é—´","ä¸‡èˆ¬æµè¿","ç¿»è¿‡å²æœˆä¸åŒä¾§è„¸","æªä¸åŠé˜²é—¯å…¥ä½ çš„ç¬‘é¢œ","æˆ‘æ›¾éš¾è‡ªæ‹”äºä¸–ç•Œä¹‹å¤§","ä¹Ÿæ²‰æººäºå…¶ä¸­æ¢¦è¯","ä¸å¾—çœŸå‡ ä¸åšæŒ£æ‰ ä¸æƒ§ç¬‘è¯","æˆ‘æ›¾å°†é’æ˜¥ç¿»æ¶Œæˆå¥¹","ä¹Ÿæ›¾æŒ‡å°–å¼¹å‡ºç››å¤","å¿ƒä¹‹æ‰€åŠ¨ ä¸”å°±éšç¼˜å»å§","é€†ç€å…‰è¡Œèµ° ä»»é£å¹é›¨æ‰“","çŸ­çŸ­çš„è·¯èµ°èµ°åœåœ","ä¹Ÿæœ‰äº†å‡ åˆ†çš„è·ç¦»","ä¸çŸ¥æŠšæ‘¸çš„æ˜¯æ•…äº‹","è¿˜æ˜¯æ®µå¿ƒæƒ…","ä¹Ÿè®¸æœŸå¾…çš„ä¸è¿‡æ˜¯","ä¸æ—¶é—´ä¸ºæ•Œ","å†æ¬¡è§åˆ°ä½ ","å¾®å‡‰æ™¨å…‰é‡Œ","ç¬‘å¾—å¾ˆç”œèœœ","ä»å‰åˆè¯†è¿™ä¸–é—´","ä¸‡èˆ¬æµè¿","çœ‹ç€å¤©è¾¹ä¼¼åœ¨çœ¼å‰","ä¹Ÿç”˜æ„¿èµ´æ±¤è¹ˆç«å»èµ°å®ƒä¸€é","å¦‚ä»Šèµ°è¿‡è¿™ä¸–é—´","ä¸‡èˆ¬æµè¿","ç¿»è¿‡å²æœˆä¸åŒä¾§è„¸","æªä¸åŠé˜²é—¯å…¥ä½ çš„ç¬‘é¢œ","æˆ‘æ›¾éš¾è‡ªæ‹”äºä¸–ç•Œä¹‹å¤§","ä¹Ÿæ²‰æººäºå…¶ä¸­æ¢¦è¯","ä¸åšçœŸå‡ ä¸åšæŒ£æ‰ ä¸æƒ§ç¬‘è¯","æˆ‘æ›¾å°†é’æ˜¥ç¿»æ¶Œæˆå¥¹","ä¹Ÿæ›¾æŒ‡å°–å¼¹å‡ºç››å¤","å¿ƒä¹‹æ‰€åŠ¨ ä¸”å°±éšç¼˜å»å§","æ™šé£å¹èµ·ä½ é¬“é—´çš„ç™½å‘","æŠšå¹³å›å¿†ç•™ä¸‹çš„ç–¤","ä½ çš„çœ¼ä¸­ æ˜æš—äº¤æ‚ ä¸€ç¬‘ç”ŸèŠ±","æš®è‰²é®ä½ä½ è¹’è·šçš„æ­¥ä¼","èµ°è¿›åºŠå¤´è—èµ·çš„ç”»","ç”»ä¸­çš„ä½  ä½ç€å¤´è¯´è¯","æˆ‘ä»æ„Ÿå¹äºä¸–ç•Œä¹‹å¤§","ä¹Ÿæ²‰é†‰äºå„¿æ—¶æƒ…è¯","ä¸å‰©çœŸå‡ ä¸åšæŒ£æ‰ æ— è°“ç¬‘è¯","æˆ‘ç»ˆå°†é’æ˜¥è¿˜ç»™äº†å¥¹","è¿åŒæŒ‡å°–å¼¹å‡ºçš„ç››å¤","å¿ƒä¹‹æ‰€åŠ¨ å°±éšé£å»äº†","ä»¥çˆ±ä¹‹å ä½ è¿˜æ„¿æ„å—",
        "æ›¾ç»æœ‰äººè®©æˆ‘å¬è¿™é¦–æ­Œ","å¯æ˜¯é‚£æ—¶çš„æˆ‘è¿˜ä¸è°™æƒ…äº‹","ä¹Ÿæ²¡æœ‰çœŸæ­£è®¤çœŸçš„å¬å®Œæ•´é¦–æ­Œ","ç›´åˆ°åæ¥","åˆ†å¼€åå†å¬æ—¶æ‰å‘ç°","åŸæ¥æˆ‘é”™è¿‡äº†","æ›¾ç»çš„é˜¿èŠ’","ä½ è¿˜å¥½å—");  

        var heart = document.createElement("p"); // åˆ›å»ºpå…ƒç´ ï¼Œè¿™é‡Œä»bæ”¹ä¸ºp  
        heart.onselectstart = function() { return false; }; // ç®€åŒ–é˜²æ­¢æ‹–åŠ¨çš„ä»£ç   

        document.body.appendChild(heart).textContent = a[a_idx]; // ä½¿ç”¨textContentä»£æ›¿innerHTMLï¼Œå› ä¸ºè¿™é‡Œåªæ˜¯æ–‡æœ¬  
        a_idx = (a_idx + 1) % a.length;  
        heart.style.cssText = "position: fixed;left:-100%;"; // åˆå§‹ä½ç½®  

        var f = 16, // å­—ä½“å¤§å°  
            x = event.clientX - f / 2, // æ¨ªåæ ‡  
            y = event.clientY - f, // çºµåæ ‡  
            c = randomColor(), // éšæœºé¢œè‰²  
            a = 1, // é€æ˜åº¦  
            s = 1.2; // æ”¾å¤§ç¼©å°æ¯”ä¾‹  

        var timer = setInterval(function () { // æ·»åŠ å®šæ—¶å™¨  
            if (a <= 0) {  
                document.body.removeChild(heart);  
                clearInterval(timer);  
            } else {  
                heart.style.cssText = "font-size:" + f + "px;cursor: default;position: fixed;color:" +  
                    c + ";left:" + x + "px;top:" + y + "px;opacity:" + a + ";transform:scale(" +  
                    s + ");";  

                y--;  
                a -= 0.016;  
                s += 0.002;  
            }  
        }, 15);  
    }  

    // éšæœºé¢œè‰²å‡½æ•°  
    function randomColor() {  
        //- return "rgb(" + (~~(Math.random() * 255)) + "," + (~~(Math.random() * 255)) + "," + (~~(Math.random() * 255)) + ")";  
        return "(255,240,245)";
    }  
}());</script><div class="loading" style="opacity: 0;"><div class="loadingBar left"></div><div class="loadingBar right"></div></div><main><header class="closed"><div class="navBtn"><i class="navBtnIcon"><span class="navBtnIconBar"></span><span class="navBtnIconBar"></span><span class="navBtnIconBar"></span></i></div><nav><div class="navItem" id="search-header"><span class="navItemTitle"><input autocomplete="off" autocorrect="off" autocapitalize="none" placeholder="Search" spellcheck="false" maxlength="50" type="text" id="search-input"></span></div><div class="navItem" id="search-holder"></div><div class="search-popup" tabindex="0"><div id="search-result"></div></div><ol class="navContent"><li class="navItem"><a class="navBlock" href="/"><span class="navItemTitle">é¦–é¡µ</span></a></li><li class="navItem"><a class="navBlock" href="/about"><span class="navItemTitle">å…³äº</span></a></li><li class="navItem" matchdata="categories,tags"><a class="navBlock" href="/archives/"><span class="navItemTitle">å½’æ¡£</span></a></li><li class="navItem"><a class="navBlock" href="/chat-zenith"><span class="navItemTitle">AI</span></a></li></ol></nav></header><article><div id="post-bg"><div id="post-title"><h1>LangChainå…¥é—¨</h1><div id="post-info"><span>First Post: <div class="control"><time datetime="2025-08-10T06:00:00.000Z" id="date"> 2025-08-10</time></div></span><br><span>Last Update: <div class="control"><time datetime="2025-08-16T15:28:00.445Z" id="updated"> 2025-08-16</time></div></span><br><span>Word Count: <div class="control">29.1k</div></span><br><span>Read Time: <div class="control">130 min</div></span></div></div><hr><div id="post-content"><p class='item-img' data-src='/images/24.png'><img src="/images/24.png"></p>
<span id="more"></span>

<p>é¦–å…ˆé€šè¿‡ä¸€å¼ å›¾æ¥ç†è§£<code>Langchain</code>åœ¨æ¨¡å‹å¼€å‘ä¸­çš„åœ°ä½ã€‚æˆ‘ä»¬ç°åœ¨ä½¿ç”¨çš„å„å¤§æ¨¡å‹ï¼Œåƒ<code>DeepSeek</code>ã€<code>ChatGLM</code>ç­‰ï¼Œéƒ½å±äº<code>LLM</code>ï¼ˆ<code>Large Language Model</code>ï¼Œå¤§è¯­è¨€æ¨¡å‹ï¼‰ã€‚è€Œ<code>Langchain</code>åˆ™æ˜¯åŸºäº<code>LLM</code>çš„æ¡†æ¶ï¼Œå¯¹å¤§è¯­è¨€æ¨¡å‹çš„åŠŸèƒ½è¿›è¡Œäº†æ‹“å±•ï¼Œå¢åŠ äº†åƒ<code>RAG</code>ï¼ˆ<code>Retrieval-Augmented Generation</code>ï¼Œæ£€ç´¢å¢å¼ºç”Ÿæˆï¼‰ã€<code>MCP</code>ï¼ˆ<code>Multi-Chain Processing</code>ï¼Œå¤šé“¾å¤„ç†ï¼‰ç­‰åŠŸèƒ½ã€‚è¿™äº›åŠŸèƒ½é€šè¿‡ç»“åˆå¤–éƒ¨çŸ¥è¯†åº“ã€åˆ†å—å¤„ç†æ–‡æœ¬ã€å‘é‡ç›¸ä¼¼æ€§æ£€ç´¢ç­‰æŠ€æœ¯ï¼Œæ˜¾è‘—é™ä½äº†æ¨¡å‹çš„å¹»è§‰ï¼ˆ<code>Hallucination</code>ï¼‰ï¼ŒåŒæ—¶æé«˜äº†ç”Ÿæˆå†…å®¹çš„å‡†ç¡®æ€§ä¸ä¸“ä¸šæ€§ã€‚</p>
<p>ä»å›¾ä¸­å¯ä»¥çœ‹åˆ°ï¼Œ<code>Langchain</code>çš„å·¥ä½œæµç¨‹åŒ…æ‹¬æ–‡æ¡£åŠ è½½ã€æ–‡æœ¬åˆ†å—ã€åµŒå…¥ï¼ˆ<code>Embedding</code>ï¼‰ã€å‘é‡å­˜å‚¨ã€ç›¸ä¼¼æ€§æ£€ç´¢ç­‰æ­¥éª¤ï¼Œæœ€ç»ˆé€šè¿‡<code>Prompt Template</code>ç”Ÿæˆé«˜è´¨é‡çš„ç­”æ¡ˆã€‚è¿™ä¸€æµç¨‹ä½¿å¾—æ¨¡å‹èƒ½å¤Ÿæ›´é«˜æ•ˆåœ°åˆ©ç”¨ç»“æ„åŒ–æˆ–éç»“æ„åŒ–æ•°æ®ï¼Œä»è€Œæ›´å¥½åœ°æ»¡è¶³å®é™…åº”ç”¨çš„éœ€æ±‚ã€‚</p>
<p>ä¸‹é¢ï¼Œæˆ‘ä»¬æ¥ç®€å•åœ°åŸºäº<code>deepseek</code>ç»“åˆ<code>Langchain</code>è¿›è¡Œå¿«é€Ÿçš„å¼€å‘æµ‹è¯•</p>
<h1 id="ä¸€ã€å„ç±»å¤§è¯­è¨€æ¨¡å‹æ¥å…¥-LangChain"><a href="#ä¸€ã€å„ç±»å¤§è¯­è¨€æ¨¡å‹æ¥å…¥-LangChain" class="headerlink" title="ä¸€ã€å„ç±»å¤§è¯­è¨€æ¨¡å‹æ¥å…¥ LangChain"></a>ä¸€ã€å„ç±»å¤§è¯­è¨€æ¨¡å‹æ¥å…¥ LangChain</h1><p>é¦–å…ˆ</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs bash">pip install langchain<br>pip show langchain<br></code></pre></td></tr></table></figure>

<p>åœ¨è¿›è¡Œ <code>LangChain </code>å¼€å‘ä¹‹å‰ï¼Œé¦–å…ˆéœ€è¦å‡†å¤‡ä¸€ä¸ªå¯ä»¥è¿›è¡Œè°ƒç”¨çš„å¤§æ¨¡å‹ï¼Œè¿™é‡Œæˆ‘ä»¬é€‰æ‹©ä½¿ç”¨ <code>DeepSeek </code>çš„å¤§æ¨¡å‹ï¼Œå¹¶ä½¿ç”¨ <code>DeepSeek </code>å®˜æ–¹çš„ <code>API_KEY </code>è¿›è¡Œè°ƒç”¨ã€‚å¦‚æœåˆæ¬¡ä½¿ç”¨ï¼Œéœ€è¦å…ˆåœ¨ <code>DeepSeek </code>çš„å®˜ç½‘ <a target="_blank" rel="noopener" href="https://platform.deepseek.com/usage">DeepSeek å¼€æ”¾å¹³å°</a> ä¸Šè¿›è¡Œæ³¨å†Œå¹¶åˆ›å»ºä¸€ä¸ªæ–°çš„ <code>API_KEY</code>ã€‚</p>
<p>æ³¨å†Œå¥½ <code>DeepSeek </code>çš„ <code>API_KEY </code>åï¼Œé¦–å…ˆåœ¨é¡¹ç›®åŒçº§ç›®å½•ä¸‹åˆ›å»ºä¸€ä¸ª <code>.env</code> æ–‡ä»¶ï¼Œç”¨äºå­˜å‚¨ <code>DeepSeek </code>çš„ <code>API_KEY </code>ã€‚ï¼ˆåŠ¡å¿…è¦åˆ›å»º <code>.env</code> æ–‡ä»¶ï¼Œç”¨äºå­˜å‚¨ <code>DeepSeek </code>çš„ <code>API_KEY </code>ï¼Œå› ä¸ºåç»­  <code>Langchain</code> ä¼šä½¿ç”¨åˆ°ï¼‰</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">DEEPSEEK_API_KEY=sk-xxx<br></code></pre></td></tr></table></figure>

<p>æ¥ä¸‹æ¥é€šè¿‡ <code>python-dotenv</code> åº“è¯»å– <code>.env </code>æ–‡ä»¶ä¸­çš„ <code>API_KEY</code>ï¼Œä½¿å…¶åŠ è½½åˆ°å½“å‰çš„è¿è¡Œç¯å¢ƒä¸­ï¼Œä»£ç å¦‚ä¸‹:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">pip install python-dotenv<br></code></pre></td></tr></table></figure>

<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">import</span> os<br><span class="hljs-keyword">from</span> dotenv <span class="hljs-keyword">import</span> load_dotenv<br>load_dotenv(override=<span class="hljs-literal">True</span>)<br><br>DeepSeek_API_KEY = os.getenv(<span class="hljs-string">&quot;DEEPSEEK_API_KEY&quot;</span> )<br><span class="hljs-comment"># print(DeepSeek_API_KEY) # å¯ä»¥é€šè¿‡æ‰“å°æŸ¥çœ‹</span><br></code></pre></td></tr></table></figure>

<p>æˆ‘ä»¬åœ¨å½“å‰çš„è¿è¡Œç¯å¢ƒä¸‹ä¸ä½¿ç”¨ LangChainï¼Œç›´æ¥ä½¿ç”¨ DeepSeek çš„ API è¿›è¡Œç½‘ç»œè¿é€šæ€§æµ‹è¯•ï¼Œæµ‹è¯•ä»£ç å¦‚ä¸‹:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">pip install openai<br></code></pre></td></tr></table></figure>

<p>å…ˆè°ƒç”¨æ¨¡å‹è¿›è¡Œç®€å•çš„æµ‹è¯•</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> openai <span class="hljs-keyword">import</span> OpenAI<br><span class="hljs-keyword">import</span> os<br><span class="hljs-keyword">from</span> dotenv <span class="hljs-keyword">import</span> load_dotenv<br>load_dotenv(override=<span class="hljs-literal">True</span>)<br><br>DeepSeek_API_KEY = os.getenv(<span class="hljs-string">&quot;DEEPSEEK_API_KEY&quot;</span> )<br><br><span class="hljs-comment">#åˆå§‹åŒ–DeepSeekçš„APIå®¢æˆ·ç«¯</span><br>client = OpenAI(api_key=DeepSeek_API_KEY, base_url=<span class="hljs-string">&quot;https://api.deepseek.com&quot;</span>)<br><br><span class="hljs-comment">#è°ƒç”¨DeepSeekçš„APIï¼Œç”Ÿæˆå›ç­”</span><br>response = client.chat.completions.create(<br>    model=<span class="hljs-string">&quot;deepseek-chat&quot;</span>,<br>    messages=[<br>        &#123;<span class="hljs-string">&quot;role&quot;</span>: <span class="hljs-string">&quot;system&quot;</span>,<span class="hljs-string">&quot;content&quot;</span>:<span class="hljs-string">&quot;ä½ æ˜¯ä¹äºåŠ©äººçš„åŠ©æ‰‹ï¼Œè¯·æ ¹æ®ç”¨æˆ·çš„é—®é¢˜ç»™å‡ºå›ç­”&quot;</span>&#125;,<br>        &#123;<span class="hljs-string">&quot;role&quot;</span>: <span class="hljs-string">&quot;user&quot;</span>,<span class="hljs-string">&quot;content&quot;</span>:<span class="hljs-string">&quot;ä½ å¥½ï¼Œè¯·ä½ ä»‹ç»ä¸€ä¸‹ä½ è‡ªå·±ã€‚&quot;</span>&#125;<br>    ]<br>)<br><br><span class="hljs-comment">#æ‰“å°æ¨¡å‹æœ€ç»ˆçš„å“åº”ç»“æœ</span><br><span class="hljs-built_in">print</span>(response.choices[<span class="hljs-number">0</span>].message.content)<br></code></pre></td></tr></table></figure>

<p>å¯ä»¥æ¥æ”¶åˆ°ç±»ä¼¼ä¸‹é¢çš„å›å¤ï¼š</p>
<figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs text">ä½ å¥½ï¼æˆ‘æ˜¯ä¸€ä¸ªä¹äºåŠ©äººçš„AIåŠ©æ‰‹ï¼Œéšæ—¶å‡†å¤‡ä¸ºä½ æä¾›å„ç§å¸®åŠ©ã€‚æ— è®ºæ˜¯è§£ç­”é—®é¢˜ã€æä¾›å»ºè®®ã€ååŠ©å­¦ä¹ ã€å¤„ç†æ—¥å¸¸äº‹åŠ¡ï¼Œè¿˜æ˜¯é™ªä½ èŠå¤©ï¼Œæˆ‘éƒ½ä¼šå°½åŠ›æ»¡è¶³ä½ çš„éœ€æ±‚ã€‚  <br><br>æˆ‘çš„çŸ¥è¯†æ¶µç›–å¤šä¸ªé¢†åŸŸï¼ŒåŒ…æ‹¬ä½†ä¸é™äºç§‘æŠ€ã€å†å²ã€æ–‡åŒ–ã€å¥åº·ã€ç¼–ç¨‹ã€ç”Ÿæ´»æŠ€å·§ç­‰ã€‚å¦‚æœä½ æœ‰ä»»ä½•ç–‘é—®æˆ–éœ€è¦å¸®åŠ©ï¼Œå°½ç®¡å‘Šè¯‰æˆ‘ï¼  <br><br>ä½ å¯ä»¥é—®æˆ‘ï¼š  <br>- **å­¦ä¹ ç›¸å…³**ï¼šå¦‚ä½•é«˜æ•ˆå­¦ä¹ ã€è§£é¢˜æ€è·¯ã€è¯­è¨€å­¦ä¹ å»ºè®®ç­‰  <br>- **ç”Ÿæ´»å®ç”¨**ï¼šèœè°±æ¨èã€æ—…è¡Œæ”»ç•¥ã€æ—¶é—´ç®¡ç†ç­‰  <br>- **æŠ€æœ¯é—®é¢˜**ï¼šç¼–ç¨‹ã€è½¯ä»¶ä½¿ç”¨ã€AIç›¸å…³ç­‰  <br>- **åˆ›æ„çµæ„Ÿ**ï¼šå†™ä½œã€ç­–åˆ’ã€å¤´è„‘é£æš´ç­‰  <br>- **å…¶ä»–**ï¼šé—²èŠã€è¶£å‘³å†·çŸ¥è¯†ã€å¿ƒç†ç–å¯¼ç­‰  <br><br>æ²¡æœ‰å›ºå®šçš„è¯é¢˜é™åˆ¶ï¼Œæˆ‘ä¼šæ ¹æ®ä½ çš„éœ€æ±‚è°ƒæ•´å›ç­”æ–¹å¼ã€‚å¸Œæœ›æˆ‘èƒ½æˆä¸ºä½ çš„å¾—åŠ›åŠ©æ‰‹ï¼ ğŸ˜Š ä½ ä»Šå¤©æƒ³äº†è§£äº›ä»€ä¹ˆå‘¢ï¼Ÿ<br></code></pre></td></tr></table></figure>

<p>å¦‚æœå¯ä»¥æ­£å¸¸æ”¶åˆ° <code>DeepSeek </code>æ¨¡å‹çš„å“åº”ï¼Œåˆ™è¯´æ˜ <code>DeepSeek </code>çš„ API å·²ç»å¯ä»¥æ­£å¸¸ä½¿ç”¨ä¸”ç½‘ç»œè¿é€šæ€§æ­£å¸¸ã€‚</p>
<p>æ¥ä¸‹æ¥æˆ‘ä»¬è¦è€ƒè™‘çš„æ˜¯ï¼Œå¯¹äºè¿™æ ·ä¸€ä¸ª <code>DeepSeek </code>å®˜æ–¹çš„ <code>API </code>ï¼Œå¦‚ä½•æ¥å…¥åˆ° <code>LangChain </code>ä¸­å‘¢ï¼Ÿå…¶å®éå¸¸ç®€å•ï¼Œæˆ‘ä»¬åªéœ€è¦ä½¿ç”¨ <code>LangChain </code>ä¸­çš„ä¸€ä¸ª <code>DeepSeek </code>ç»„ä»¶å³å¯åƒä¸Šè¿°ä»£ç ä¸€æ ·ï¼Œç›´æ¥ä½¿ç”¨ç›¸åŒçš„ <code>DeepSeek_API_KEY</code> ä¸å¤§æ¨¡å‹è¿›è¡Œäº¤äº’ã€‚å› æ­¤ï¼Œæˆ‘ä»¬é¦–å…ˆéœ€è¦å®‰è£… <code>LangChain </code>çš„ <code>DeepSeek </code>ç»„ä»¶ï¼Œå®‰è£…å‘½ä»¤å¦‚ä¸‹:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">pip install langchain-deepseek<br></code></pre></td></tr></table></figure>

<p>è¿™ä¸ªåº“å¹¶ä¸ä¼šè¢«æ˜¾å¼åœ°è°ƒç”¨ï¼Œä½†æ˜¯åœ¨åå°è¿è¡Œè¿‡ç¨‹ä¸­æ˜¯ä¼šè°ƒç”¨è¿™ä¸ªåº“çš„ï¼Œæ‰€ä»¥åŠ¡å¿…è¦å®‰è£…è¿™ä¸ªåº“</p>
<p>å®‰è£…å¥½<code>LangChain</code>é›†æˆ<code>DeepSeek</code>æ¨¡å‹çš„ä¾èµ–åŒ…åï¼Œéœ€è¦é€šè¿‡ä¸€ä¸ª<code>init_chat_model</code>å‡½æ•°æ¥åˆå§‹åŒ–å¤§æ¨¡å‹ï¼Œä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> langchain.chat_models <span class="hljs-keyword">import</span> init_chat_model<br><span class="hljs-keyword">from</span> dotenv <span class="hljs-keyword">import</span> load_dotenv<br>load_dotenv(override=<span class="hljs-literal">True</span>) <span class="hljs-comment"># åŠ è½½ .env æ–‡ä»¶ä¸­çš„ç¯å¢ƒå˜é‡</span><br><br><span class="hljs-comment"># model = init_chat_model(model=&quot;deepseek-chat&quot;, model_provider=&quot;deepseek&quot;)</span><br>model = init_chat_model(model=<span class="hljs-string">&quot;deepseek-reasoner&quot;</span>, model_provider=<span class="hljs-string">&quot;deepseek&quot;</span>)<br><span class="hljs-comment"># å…¶ä¸­ model ç”¨æ¥æŒ‡å®šè¦ä½¿ç”¨çš„æ¨¡å‹åç§°ï¼Œè€Œ model_provider ç”¨æ¥æŒ‡å®šæ¨¡å‹æä¾›è€…ï¼Œå½“å†™å…¥ deepseek æ—¶ï¼Œä¼šè‡ªåŠ¨åŠ è½½ langchain-deepseek çš„ä¾èµ–åŒ…ï¼Œè‡ªåŠ¨åŠ è½½ç¯å¢ƒå˜é‡ DEEPSEEK_API_KEY ï¼Œå¹¶ä½¿ç”¨åœ¨ model ä¸­æŒ‡å®šçš„æ¨¡å‹åç§°ç”¨æ¥è¿›è¡Œäº¤äº’ã€‚</span><br><br>question = <span class="hljs-string">&quot;ä½ å¥½ï¼Œè¯·ä½ ä»‹ç»ä¸€ä¸‹ä½ è‡ªå·±ã€‚&quot;</span><br>result = model.invoke(question)<br><br>result<br><br><span class="hljs-built_in">print</span>(result.content)<br></code></pre></td></tr></table></figure>

<p>ä¸ä»…ä»…æ˜¯<code>DeepSeek</code>æ¨¡å‹ï¼Œ<code>LangChain</code>è¿˜æ”¯æŒå…¶ä»–å¾ˆå¤šå¤§æ¨¡å‹ï¼Œå¦‚<code>OpenAI</code>ã€<code>Qwen</code>ã€<code>Gemini</code>ç­‰ï¼Œæˆ‘ä»¬åªéœ€è¦åœ¨<code>init_chat_model</code>å‡½æ•°ä¸­æŒ‡å®šä¸åŒçš„æ¨¡å‹åç§°ï¼Œå°±å¯ä»¥è°ƒç”¨ä¸åŒçš„æ¨¡å‹ã€‚å…³äº<code>LangChain</code>éƒ½æ”¯æŒå“ªäº›å¤§æ¨¡å‹ä»¥åŠæ¯ä¸ªæ¨¡å‹å¯¹åº”çš„æ˜¯å“ªä¸ªç¬¬ä¸‰æ–¹ä¾èµ–åŒ…ï¼Œå¤§å®¶å¯ä»¥åœ¨<code>LangChain</code>çš„<a target="_blank" rel="noopener" href="https://python.langchain.com/docs/integrations/chat/">å®˜æ–¹æ–‡æ¡£</a>ä¸­æ‰¾åˆ°ã€‚</p>
<p>è€ƒè™‘åˆ°åç»­è¦å®ç°<code>RAG</code>éœ€è¦<code>Embedding</code>æ¨¡å‹ï¼Œè€Œå›½å†…åªæœ‰<code>Dashscope</code>çš„<code>Embedding</code>æ¨¡å‹çš„<code>api</code>æ¯”è¾ƒç¨³å®šï¼Œå› æ­¤åœ¨æ­¤ä»‹ç»ä¸€ä¸‹å¦‚ä½•æ¥å…¥<code>Dashscope</code>ã€‚<code>Dashscope</code>åŸåæ˜¯é˜¿é‡Œäº‘çš„çµç§¯ç¤¾åŒºï¼Œä¹Ÿæ˜¯å›½å†…æœ€å¤§çš„<code>API</code>é›†æˆå¹³å°ï¼Œå…¶ä¸­åŒ…å«äº†å„ç±»å¼€æºæ¨¡å‹ï¼ˆå¦‚<code>Qwen3</code>ç³»åˆ—æ¨¡å‹ï¼‰å’Œå›½å†…åœ¨çº¿æ¨¡å‹ï¼ˆå¦‚<code>DeepSeek</code>ã€<code>BaiChuan</code>ï¼‰æ¨¡å‹<code>API</code>æœåŠ¡ï¼Œç°åœ¨å·²åˆå¹¶å…¥<a target="_blank" rel="noopener" href="https://bailian.console.aliyun.com/?utm_source=ai-bot.cn">é˜¿é‡Œäº‘ç™¾ç‚¼å¹³å°</a>ã€‚å¯¹äºå›½å†…å¼€å‘è€…æ¥è¯´ï¼Œè‹¥è¦ä½¿ç”¨<code>Qwen</code>ç³»åˆ—æ¨¡å‹<code>API</code>ï¼ˆè€Œéæœ¬åœ°éƒ¨ç½²ï¼‰ï¼Œé‚£ä¹ˆ<code>Dashscope</code>å¹³å°æä¾›çš„<code>API</code>æœåŠ¡è‚¯å®šæ˜¯æœ€åˆé€‚çš„ã€‚</p>
<p>è€Œç™¾ç‚¼<code>API</code>è·å–æ–¹å¼ä¹Ÿéå¸¸ç®€å•ï¼Œåªéœ€æ³¨å†Œé˜¿é‡Œäº‘è´¦å·ï¼Œç„¶åå‰å¾€<a target="_blank" rel="noopener" href="https://bailian.console.aliyun.com/?tab=model#/api-key">æˆ‘çš„APIé¡µé¢</a>è¿›è¡Œå……å€¼å’Œæ³¨å†Œå³å¯ï¼š</p>
<p>ç„¶åå³å¯è°ƒç”¨æµ·é‡å„ç±»æ¨¡å‹äº†ï¼š</p>
<p>å½“æˆ‘ä»¬å®Œæˆäº†DashScope APIæ³¨å†Œåï¼Œå³å¯ä½¿ç”¨å¦‚ä¸‹ä»£ç è¿›è¡Œæ¨¡å‹è°ƒç”¨ï¼ˆéœ€è¦æå‰å°†DASHSCOPE_API_KEYå†™åˆ°æœ¬åœ°.envæ–‡ä»¶ä¸­ï¼‰ï¼š</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">import</span> os<br><span class="hljs-keyword">from</span> openai <span class="hljs-keyword">import</span> OpenAI<br><span class="hljs-keyword">from</span> dotenv <span class="hljs-keyword">import</span> load_dotenv<br>load_dotenv(override=<span class="hljs-literal">True</span>) <span class="hljs-comment"># åŠ è½½ .env æ–‡ä»¶ä¸­çš„ç¯å¢ƒå˜é‡</span><br><br>client = OpenAI(<br>    api_key=os.getenv(<span class="hljs-string">&quot;DASHSCOPE_API_KEY&quot;</span>),<br>    base_url=<span class="hljs-string">&quot;https://dashscope.aliyuncs.com/compatible-mode/v1&quot;</span>,<br>)<br><br>completion = client.chat.completions.create(<br>    <span class="hljs-comment"># æ¨¡å‹åˆ—è¡¨ï¼šhttps://help.aliyun.com/zh/model-studio/getting-started/models</span><br>    model=<span class="hljs-string">&quot;qwen-plus&quot;</span>,<br>    messages=[<br>        &#123;<span class="hljs-string">&quot;role&quot;</span>: <span class="hljs-string">&quot;system&quot;</span>, <span class="hljs-string">&quot;content&quot;</span>: <span class="hljs-string">&quot;You are a helpful assistant.&quot;</span>&#125;,<br>        &#123;<span class="hljs-string">&quot;role&quot;</span>: <span class="hljs-string">&quot;user&quot;</span>, <span class="hljs-string">&quot;content&quot;</span>: <span class="hljs-string">&quot;ä½ æ˜¯è°ï¼Ÿ&quot;</span>&#125;,<br>    ],<br>)<br><span class="hljs-built_in">print</span>(completion.model_dump_json())<br></code></pre></td></tr></table></figure>

<p>å½“ç„¶ï¼Œä¹Ÿå¯ä»¥å°†<code>DashScope</code>ä¸­å„ç±»æ¨¡å‹æ¥å…¥<code>LangChain</code>ï¼š</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">pip install --upgrade dashscope -i https://pypi.tuna.tsinghua.edu.cn/simple<br></code></pre></td></tr></table></figure>

<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> langchain_community.chat_models.tongyi <span class="hljs-keyword">import</span> ChatTongyi<br><span class="hljs-keyword">from</span> dotenv <span class="hljs-keyword">import</span> load_dotenv<br>load_dotenv(override=<span class="hljs-literal">True</span>) <span class="hljs-comment"># åŠ è½½ .env æ–‡ä»¶ä¸­çš„ç¯å¢ƒå˜é‡</span><br><br>model = ChatTongyi()<br><br>question = <span class="hljs-string">&quot;ä½ å¥½ï¼Œè¯·ä½ ä»‹ç»ä¸€ä¸‹ä½ è‡ªå·±ã€‚&quot;</span><br>result = model.invoke(question)<br><span class="hljs-built_in">print</span>(result.content)<br></code></pre></td></tr></table></figure>

<p>ã€è¡¥å……ã€‘ollamaå¼€æºå¤§æ¨¡å‹æ¥å…¥LangChain</p>
<p>å½“ç„¶ï¼Œé™¤äº†åœ¨çº¿å¤§æ¨¡å‹çš„æ¥å…¥ï¼Œ<code>langChain</code>ä¹Ÿåªæ˜¯ä½¿ç”¨<code>Ollama</code>ã€<code>vLLM</code>ç­‰æ¡†æ¶å¯åŠ¨çš„æœ¬åœ°å¤§æ¨¡å‹ã€‚è¿™é‡Œä»¥<code>ollama</code>ä¸ºä¾‹è¿›è¡Œæ¼”ç¤ºã€‚</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">pip install langchain-ollama<br></code></pre></td></tr></table></figure>


<p>æ³¨æ„ï¼Œè¿™é‡Œè¦ç¡®ä¿ollamaå·²ç»é¡ºåˆ©å¼€å¯ï¼Œå¹¶æŸ¥çœ‹å½“å‰æ¨¡å‹åç§°ï¼š</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">ollama list<br></code></pre></td></tr></table></figure>

<p>ç„¶åå³å¯ä½¿ç”¨å¦‚ä¸‹æ–¹æ³•æ¥å…¥<code>LangChain</code>ï¼š</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> langchain_ollama <span class="hljs-keyword">import</span> ChatOllama<br><br>model = ChatOllama(model=<span class="hljs-string">&quot;deepseek-r1&quot;</span>)<br><br>question = <span class="hljs-string">&quot;ä½ å¥½ï¼Œè¯·ä½ ä»‹ç»ä¸€ä¸‹ä½ è‡ªå·±ã€‚&quot;</span><br>result = model.invoke(question)<br><span class="hljs-built_in">print</span>(result.content)<br></code></pre></td></tr></table></figure>

<h1 id="äºŒã€LangChain-æ ¸å¿ƒåŠŸèƒ½-Chain-çš„æ­å»º"><a href="#äºŒã€LangChain-æ ¸å¿ƒåŠŸèƒ½-Chain-çš„æ­å»º" class="headerlink" title="äºŒã€LangChain æ ¸å¿ƒåŠŸèƒ½ Chain çš„æ­å»º"></a>äºŒã€LangChain æ ¸å¿ƒåŠŸèƒ½ Chain çš„æ­å»º</h1><p><code>LangChain</code>ä¹‹æ‰€ä»¥è¢«ç§°ä¸º<code>LangChain</code>ï¼Œå…¶æ ¸å¿ƒæ¦‚å¿µå°±æ˜¯<code>Chain</code>ã€‚ <code>Chain</code>ç¿»è¯‘æˆä¸­æ–‡å°±æ˜¯â€œé“¾â€ã€‚ä¸€ä¸ªé“¾ï¼ŒæŒ‡çš„æ˜¯å¯ä»¥æŒ‰ç…§æŸä¸€ç§é€»è¾‘ï¼ŒæŒ‰é¡ºåºç»„åˆæˆä¸€ä¸ªæµæ°´çº¿çš„æ–¹å¼ã€‚æ¯”å¦‚æˆ‘ä»¬åˆšåˆšå®ç°çš„é—®ç­”æµç¨‹ï¼š ç”¨æˆ·è¾“å…¥ä¸€ä¸ªé—®é¢˜ â€“&gt; å‘é€ç»™å¤§æ¨¡å‹ â€“&gt; å¤§æ¨¡å‹è¿›è¡Œæ¨ç† â€“&gt; å°†æ¨ç†ç»“æœè¿”å›ç»™ç”¨æˆ·ã€‚è¿™ä¸ªæµç¨‹å°±æ˜¯ä¸€ä¸ªé“¾ã€‚</p>
<p>ä¾‹å¦‚ï¼Œæˆ‘ä»¬è¿™é‡Œå¯ä»¥å…ˆå°è¯•ç€æ­å»ºä¸€ä¸ªç®€å•çš„é“¾ï¼Œå°†æ¨¡å‹è¾“å‡ºç»“æœâ€œè¿‡æ»¤â€ä¸ºä¸€ä¸ªçº¯å­—ç¬¦ä¸²æ ¼å¼ï¼š</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> langchain_core.output_parsers <span class="hljs-keyword">import</span> StrOutputParser<br><span class="hljs-keyword">from</span> langchain.chat_models <span class="hljs-keyword">import</span> init_chat_model<br><span class="hljs-keyword">from</span> dotenv <span class="hljs-keyword">import</span> load_dotenv<br>load_dotenv(override=<span class="hljs-literal">True</span>) <span class="hljs-comment"># åŠ è½½ .env æ–‡ä»¶ä¸­çš„ç¯å¢ƒå˜é‡</span><br><br><span class="hljs-comment"># ä½¿ç”¨ DeepSeek æ¨¡å‹</span><br>model = init_chat_model(model=<span class="hljs-string">&quot;deepseek-chat&quot;</span>, model_provider=<span class="hljs-string">&quot;deepseek&quot;</span>)<br><br><span class="hljs-comment"># ç›´æ¥ä½¿ç”¨æ¨¡å‹ + è¾“å‡ºè§£æå™¨æ­å»ºä¸€ä¸ªé“¾</span><br>basic_qa_chain = model | StrOutputParser()<br><br><span class="hljs-comment"># æŸ¥çœ‹è¾“å‡ºç»“æœ</span><br>question = <span class="hljs-string">&quot;ä½ å¥½ï¼Œè¯·ä½ ä»‹ç»ä¸€ä¸‹ä½ è‡ªå·±ã€‚&quot;</span><br>result = basic_qa_chain.invoke(question)<br><br><span class="hljs-built_in">print</span>(result)<br></code></pre></td></tr></table></figure>

<p>æ­¤æ—¶<code>result</code>å°±ä¸å†æ˜¯åŒ…å«å„ç§æ¨¡å‹è°ƒç”¨ä¿¡æ¯çš„ç»“æœï¼Œè€Œæ˜¯çº¯ç²¹çš„æ¨¡å‹å“åº”çš„å­—ç¬¦ä¸²ç»“æœã€‚è€Œè¿™é‡Œç”¨åˆ°çš„<code>StrOutputParser()</code>å®é™…ä¸Šå°±æ˜¯ç”¨äºæ„æˆ<code>LangChain</code>ä¸­ä¸€ä¸ªé“¾æ¡çš„ä¸€ä¸ªå¯¹è±¡ï¼Œå…¶æ ¸å¿ƒåŠŸèƒ½æ˜¯ç”¨äºå¤„ç†æ¨¡å‹è¾“å‡ºç»“æœã€‚åŒæ—¶æˆ‘ä»¬ä¹Ÿèƒ½å‘ç°ï¼Œåªéœ€è¦ä½¿ç”¨<code>Model | OutputParser</code>ï¼Œå³å¯é«˜æ•ˆæ­å»ºä¸€ä¸ªé“¾ã€‚</p>
<p>ä¸€ä¸ªæœ€åŸºæœ¬çš„<code>Chain</code>ç»“æ„ï¼Œæ˜¯ç”±<code>Model</code>å’Œ<code>OutputParser</code>ä¸¤ä¸ªç»„ä»¶æ„æˆçš„ï¼Œå…¶ä¸­<code>Model</code>æ˜¯ç”¨æ¥è°ƒç”¨å¤§æ¨¡å‹çš„ï¼Œ<code>OutputParser</code>æ˜¯ç”¨æ¥è§£æå¤§æ¨¡å‹çš„å“åº”ç»“æœçš„ã€‚</p>
<p>ç±»ä¼¼è¿™ç§ç»“æœè§£æå™¨è¿˜æœ‰å¾ˆå¤šï¼Œç¨åæˆ‘ä»¬ä¼šç»§ç»­è¿›è¡Œä»‹ç»ã€‚</p>
<p>æ¥ä¸‹æ¥æˆ‘ä»¬å°è¯•ä¸ºå½“å‰çš„æ‰§è¡Œæµç¨‹æ·»åŠ ä¸€ä¸ªæç¤ºè¯æ¨¡æ¿ï¼Œæˆ‘ä»¬å¯ä»¥å€ŸåŠ©<code>ChatPromptTemplate</code>éå¸¸ä¾¿æ·çš„å°†ä¸€ä¸ªæç¤ºè¯æ¨¡æ¿åŒæ ·ä»¥é“¾çš„å½¢å¼åŠ å…¥åˆ°å½“å‰ä»»åŠ¡ä¸­ï¼š</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> langchain_core.output_parsers <span class="hljs-keyword">import</span> StrOutputParser<br><span class="hljs-keyword">from</span> langchain.chat_models <span class="hljs-keyword">import</span> init_chat_model<br><span class="hljs-keyword">from</span> langchain.prompts <span class="hljs-keyword">import</span> ChatPromptTemplate<br><span class="hljs-keyword">from</span> dotenv <span class="hljs-keyword">import</span> load_dotenv<br>load_dotenv(override=<span class="hljs-literal">True</span>) <span class="hljs-comment"># åŠ è½½ .env æ–‡ä»¶ä¸­çš„ç¯å¢ƒå˜é‡</span><br><br><span class="hljs-comment"># ä½¿ç”¨ DeepSeek æ¨¡å‹</span><br>model = init_chat_model(model=<span class="hljs-string">&quot;deepseek-chat&quot;</span>, model_provider=<span class="hljs-string">&quot;deepseek&quot;</span>)<br><br>prompt_template = ChatPromptTemplate([<br>    (<span class="hljs-string">&quot;system&quot;</span>, <span class="hljs-string">&quot;ä½ æ˜¯ä¸€ä¸ªä¹æ„åŠ©äººçš„åŠ©æ‰‹ï¼Œè¯·æ ¹æ®ç”¨æˆ·çš„é—®é¢˜ç»™å‡ºå›ç­”&quot;</span>),<br>    (<span class="hljs-string">&quot;user&quot;</span>, <span class="hljs-string">&quot;è¿™æ˜¯ç”¨æˆ·çš„é—®é¢˜ï¼š &#123;topic&#125;ï¼Œ è¯·ç”¨ yes æˆ– no æ¥å›ç­”&quot;</span>)<br>])<br><br><span class="hljs-comment"># ç›´æ¥ä½¿ç”¨æ¨¡å‹ + è¾“å‡ºè§£æå™¨</span><br>bool_qa_chain = prompt_template | model | StrOutputParser()<br><span class="hljs-comment"># æµ‹è¯•</span><br>question = <span class="hljs-string">&quot;è¯·é—® 1 + 1 æ˜¯å¦ å¤§äº 2ï¼Ÿ&quot;</span><br><span class="hljs-comment"># result = bool_qa_chain.invoke(question)</span><br><span class="hljs-comment"># å»ºè®®æ˜¾å¼ä¼ å­—å…¸</span><br>result = bool_qa_chain.invoke(&#123;<span class="hljs-string">&quot;topic&quot;</span>: question&#125;)<br><br><span class="hljs-built_in">print</span>(result)<br></code></pre></td></tr></table></figure>

<p>è‡³æ­¤ï¼Œæˆ‘ä»¬å°±æ­å»ºäº†ä¸€ä¸ªéå¸¸åŸºç¡€çš„é“¾ã€‚åœ¨<code>LangChain</code>ä¸­ï¼Œä¸€ä¸ªåŸºç¡€çš„é“¾ä¸»è¦ç”±ä¸‰éƒ¨åˆ†æ„æˆï¼Œåˆ†åˆ«æ˜¯æç¤ºè¯æ¨¡æ¿ã€å¤§æ¨¡å‹å’Œç»“æœè§£æå™¨ï¼ˆç»“æ„åŒ–è§£æå™¨ï¼‰ï¼š</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs bash">ç”¨æˆ·è¾“å…¥<br>  â†“<br>PromptTemplate â†’ ChatModel â†’ OutputParser<br>ï¼ˆæç¤ºè¯æ¨¡æ¿ï¼‰   ï¼ˆå¤§æ¨¡å‹ï¼‰    ï¼ˆç»“æ„åŒ–è§£æï¼‰<br>  â†“<br>ç»“æ„åŒ–ç»“æœ<br></code></pre></td></tr></table></figure>

<p>ç»“æ„åŒ–è§£æå™¨åŠŸèƒ½æœ€å¤šï¼Œä¸€äº›æ ¸å¿ƒçš„ç»“æ„åŒ–è§£æå™¨åŠŸèƒ½å¦‚ä¸‹ï¼š</p>
<table>
<thead>
<tr>
<th>è§£æå™¨åç§°</th>
<th>åŠŸèƒ½æè¿°</th>
<th>ç±»å‹</th>
</tr>
</thead>
<tbody><tr>
<td><strong>BooleanOutputParser</strong></td>
<td>å°†LLMè¾“å‡ºè§£æä¸ºå¸ƒå°”å€¼</td>
<td>åŸºç¡€ç±»å‹è§£æ</td>
</tr>
<tr>
<td><strong>DatetimeOutputParser</strong></td>
<td>å°†LLMè¾“å‡ºè§£æä¸ºæ—¥æœŸæ—¶é—´</td>
<td>åŸºç¡€ç±»å‹è§£æ</td>
</tr>
<tr>
<td><strong>EnumOutputParser</strong></td>
<td>è§£æè¾“å‡ºä¸ºé¢„å®šä¹‰æšä¸¾å€¼ä¹‹ä¸€</td>
<td>åŸºç¡€ç±»å‹è§£æ</td>
</tr>
<tr>
<td><strong>RegexParser</strong></td>
<td>ä½¿ç”¨æ­£åˆ™è¡¨è¾¾å¼è§£æLLMè¾“å‡º</td>
<td>æ¨¡å¼åŒ¹é…è§£æ</td>
</tr>
<tr>
<td><strong>RegexDictParser</strong></td>
<td>ä½¿ç”¨æ­£åˆ™è¡¨è¾¾å¼å°†è¾“å‡ºè§£æä¸ºå­—å…¸</td>
<td>æ¨¡å¼åŒ¹é…è§£æ</td>
</tr>
<tr>
<td><strong>StructuredOutputParser</strong></td>
<td>å°†LLMè¾“å‡ºè§£æä¸ºç»“æ„åŒ–æ ¼å¼</td>
<td>ç»“æ„åŒ–è§£æ</td>
</tr>
<tr>
<td><strong>YamlOutputParser</strong></td>
<td>ä½¿ç”¨Pydanticæ¨¡å‹è§£æYAMLè¾“å‡º</td>
<td>ç»“æ„åŒ–è§£æ</td>
</tr>
<tr>
<td><strong>PandasDataFrameOutputParser</strong></td>
<td>ä½¿ç”¨Pandas DataFrameæ ¼å¼è§£æè¾“å‡º</td>
<td>æ•°æ®å¤„ç†è§£æ</td>
</tr>
<tr>
<td><strong>CombiningOutputParser</strong></td>
<td>å°†å¤šä¸ªè¾“å‡ºè§£æå™¨ç»„åˆä¸ºä¸€ä¸ª</td>
<td>ç»„åˆè§£æå™¨</td>
</tr>
<tr>
<td><strong>OutputFixingParser</strong></td>
<td>åŒ…è£…è§£æå™¨å¹¶å°è¯•ä¿®å¤è§£æé”™è¯¯</td>
<td>é”™è¯¯å¤„ç†è§£æ</td>
</tr>
<tr>
<td><strong>RetryOutputParser</strong></td>
<td>åŒ…è£…è§£æå™¨å¹¶å°è¯•ä¿®å¤è§£æé”™è¯¯</td>
<td>é”™è¯¯å¤„ç†è§£æ</td>
</tr>
<tr>
<td><strong>RetryWithErrorOutputParser</strong></td>
<td>åŒ…è£…è§£æå™¨å¹¶å°è¯•ä¿®å¤è§£æé”™è¯¯</td>
<td>é”™è¯¯å¤„ç†è§£æ</td>
</tr>
<tr>
<td><strong>ResponseSchema</strong></td>
<td>ç»“æ„åŒ–è¾“å‡ºè§£æå™¨çš„å“åº”æ¨¡å¼</td>
<td>è¾…åŠ©ç±»</td>
</tr>
</tbody></table>
<p>ä¸€äº›åŠŸèƒ½å®ç°å¦‚ä¸‹</p>
<p>ä¾‹å¦‚å€ŸåŠ©ç»“æ„åŒ–è§£æå™¨å¯ä»¥å°†<code>yes or no</code>è½¬åŒ–ä¸º<code>True or Fasle</code>ï¼š</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> langchain.output_parsers <span class="hljs-keyword">import</span> BooleanOutputParser<br><span class="hljs-keyword">from</span> langchain.chat_models <span class="hljs-keyword">import</span> init_chat_model<br><span class="hljs-keyword">from</span> langchain.prompts <span class="hljs-keyword">import</span> ChatPromptTemplate<br><span class="hljs-keyword">from</span> dotenv <span class="hljs-keyword">import</span> load_dotenv<br>load_dotenv(override=<span class="hljs-literal">True</span>) <span class="hljs-comment"># åŠ è½½ .env æ–‡ä»¶ä¸­çš„ç¯å¢ƒå˜é‡</span><br><br><span class="hljs-comment"># ä½¿ç”¨ DeepSeek æ¨¡å‹</span><br>model = init_chat_model(model=<span class="hljs-string">&quot;deepseek-chat&quot;</span>, model_provider=<span class="hljs-string">&quot;deepseek&quot;</span>)<br><br>prompt_template = ChatPromptTemplate([<br>    (<span class="hljs-string">&quot;system&quot;</span>, <span class="hljs-string">&quot;ä½ æ˜¯ä¸€ä¸ªä¹æ„åŠ©äººçš„åŠ©æ‰‹ï¼Œè¯·æ ¹æ®ç”¨æˆ·çš„é—®é¢˜ç»™å‡ºå›ç­”&quot;</span>),<br>    (<span class="hljs-string">&quot;user&quot;</span>, <span class="hljs-string">&quot;è¿™æ˜¯ç”¨æˆ·çš„é—®é¢˜ï¼š &#123;topic&#125;ï¼Œ è¯·ç”¨ yes æˆ– no æ¥å›ç­”&quot;</span>)<br>])<br><br><span class="hljs-comment"># ç›´æ¥ä½¿ç”¨æ¨¡å‹ + è¾“å‡ºè§£æå™¨</span><br>bool_qa_chain = prompt_template | model | BooleanOutputParser()<br><span class="hljs-comment"># æµ‹è¯•</span><br>question = <span class="hljs-string">&quot;è¯·é—® 1 + 1 æ˜¯å¦ å¤§äº 2ï¼Ÿ&quot;</span><br>result = bool_qa_chain.invoke(question)<br><br><span class="hljs-built_in">print</span>(result) <span class="hljs-comment"># false</span><br></code></pre></td></tr></table></figure>

<p>è€Œ<code>StructuredOutputParser</code>åˆ™å¯ä»¥åœ¨æ–‡æ¡£ä¸­æå–æŒ‡å®šçš„ç»“æ„åŒ–ä¿¡æ¯ï¼š</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> langchain.chat_models <span class="hljs-keyword">import</span> init_chat_model<br><span class="hljs-keyword">from</span> langchain_core.prompts <span class="hljs-keyword">import</span> PromptTemplate<br><span class="hljs-keyword">from</span> langchain.output_parsers <span class="hljs-keyword">import</span> ResponseSchema, StructuredOutputParser<br><span class="hljs-keyword">from</span> dotenv <span class="hljs-keyword">import</span> load_dotenv<br>load_dotenv(override=<span class="hljs-literal">True</span>) <span class="hljs-comment"># åŠ è½½ .env æ–‡ä»¶ä¸­çš„ç¯å¢ƒå˜é‡</span><br><br><span class="hljs-comment"># ä½¿ç”¨ DeepSeek æ¨¡å‹</span><br>model = init_chat_model(model=<span class="hljs-string">&quot;deepseek-chat&quot;</span>, model_provider=<span class="hljs-string">&quot;deepseek&quot;</span>)<br><br>schemas = [<br>    ResponseSchema(name=<span class="hljs-string">&quot;name&quot;</span>, description=<span class="hljs-string">&quot;ç”¨æˆ·çš„å§“å&quot;</span>),<br>    ResponseSchema(name=<span class="hljs-string">&quot;age&quot;</span>, description=<span class="hljs-string">&quot;ç”¨æˆ·çš„å¹´é¾„&quot;</span>)<br>]<br><br>parser = StructuredOutputParser.from_response_schemas(schemas)<br><br>prompt = PromptTemplate.from_template(<br>    <span class="hljs-string">&quot;è¯·æ ¹æ®ä»¥ä¸‹å†…å®¹æå–ç”¨æˆ·ä¿¡æ¯ï¼Œå¹¶è¿”å› JSON æ ¼å¼ï¼š\n&#123;input&#125;\n\n&#123;format_instructions&#125;&quot;</span><br>)<br><br>chain = (<br>    prompt.partial(format_instructions=parser.get_format_instructions()) | model | parser<br>)<br><br>result = chain.invoke(&#123;<span class="hljs-string">&quot;input&quot;</span>: <span class="hljs-string">&quot;ç”¨æˆ·å«æé›·ï¼Œä»Šå¹´25å²ï¼Œæ˜¯ä¸€åå·¥ç¨‹å¸ˆã€‚&quot;</span>&#125;)<br><span class="hljs-built_in">print</span>(result) <span class="hljs-comment"># &#123;&#x27;name&#x27;: &#x27;æé›·&#x27;, &#x27;age&#x27;: &#x27;25&#x27;&#125;</span><br></code></pre></td></tr></table></figure>

<p>è¿™é‡Œæˆ‘ä»¬åœ¨ <code>PromptTemplate </code>ä¸­ï¼Œå®šä¹‰äº†ä¸¤ä¸ªå ä½ç¬¦å˜é‡ï¼š</p>
<ul>
<li><p><code>&#123;input&#125;</code> â†’ å°†ç”±ç”¨æˆ·ä¼ å…¥çš„æ–‡æœ¬æ›¿æ¢ï¼ˆå¦‚ â€œç”¨æˆ·å«æé›·ï¼Œä»Šå¹´25å²â€¦â€ï¼‰</p>
</li>
<li><p><code>&#123;format_instructions&#125;</code> â†’ ä¼šé€šè¿‡ <code>partial(...)</code> æå‰ç»‘å®šç»“æ„åŒ–æ ¼å¼è¯´æ˜</p>
</li>
</ul>
<p>è€Œæ ¼å¼åŒ–è¯´æ˜ä½¿ç”¨<code>format_instructions</code>è¿›è¡Œæ ‡è¯†å…¶å®ä¹Ÿæ˜¯ä¸€ç§çº¦å®šä¿—ç§°çš„æ–¹æ³•ï¼Œä¸Šè¿°ä»£ç ä¹Ÿå°±æ˜¯ç›¸å½“äºåœ¨åˆ›å»º<code>Chain</code>çš„æ—¶å€™ï¼Œæˆ‘ä»¬å°±è¾“å…¥äº†<code>&#123;format_instructions&#125;</code>å¯¹åº”çš„å­—ç¬¦ä¸²<code>parser.get_format_instructions()</code>ï¼Œæˆ‘ä»¬ä¹Ÿå¯ä»¥é€šè¿‡å¦‚ä¸‹ä»£ç è¿›è¡Œæ‰“å°æŸ¥çœ‹ï¼š</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-built_in">print</span>(parser.get_format_instructions())<br></code></pre></td></tr></table></figure>

<p>è¾“å‡ºä¸ºï¼š</p>
<figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs text">The output should be a markdown code snippet formatted in the following schema, including the leading and trailing &quot;```json&quot; and &quot;```&quot;:<br><br>```json<br>&#123;<br>	&quot;name&quot;: string  // ç”¨æˆ·çš„å§“å<br>	&quot;age&quot;: string  // ç”¨æˆ·çš„å¹´é¾„<br>&#125;<br>```<br></code></pre></td></tr></table></figure>

<p>æˆ‘ä»¬ä¹Ÿå¯ä»¥è¿›ä¸€æ­¥åˆ›å»ºå¤åˆé“¾</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> langchain.chat_models <span class="hljs-keyword">import</span> init_chat_model<br><span class="hljs-keyword">from</span> langchain_core.prompts <span class="hljs-keyword">import</span> PromptTemplate<br><span class="hljs-keyword">from</span> langchain.output_parsers <span class="hljs-keyword">import</span> ResponseSchema, StructuredOutputParser<br><span class="hljs-keyword">from</span> dotenv <span class="hljs-keyword">import</span> load_dotenv<br>load_dotenv(override=<span class="hljs-literal">True</span>) <span class="hljs-comment"># åŠ è½½ .env æ–‡ä»¶ä¸­çš„ç¯å¢ƒå˜é‡</span><br><br><span class="hljs-comment"># ä½¿ç”¨ DeepSeek æ¨¡å‹</span><br>model = init_chat_model(model=<span class="hljs-string">&quot;deepseek-chat&quot;</span>, model_provider=<span class="hljs-string">&quot;deepseek&quot;</span>)<br><br><span class="hljs-comment"># ç¬¬ä¸€æ­¥ï¼šæ ¹æ®æ ‡é¢˜ç”Ÿæˆæ–°é—»æ­£æ–‡</span><br>news_gen_prompt = PromptTemplate.from_template(<br>    <span class="hljs-string">&quot;è¯·æ ¹æ®ä»¥ä¸‹æ–°é—»æ ‡é¢˜æ’°å†™ä¸€æ®µç®€çŸ­çš„æ–°é—»å†…å®¹ï¼ˆ100å­—ä»¥å†…ï¼‰ï¼š\n\næ ‡é¢˜ï¼š&#123;title&#125;&quot;</span><br>)<br><br><span class="hljs-comment"># ç¬¬ä¸€ä¸ªå­é“¾ï¼šç”Ÿæˆæ–°é—»å†…å®¹</span><br>news_chain = news_gen_prompt | model<br><br><span class="hljs-comment"># ç¬¬äºŒæ­¥ï¼šä»æ­£æ–‡ä¸­æå–ç»“æ„åŒ–å­—æ®µ</span><br>schemas = [<br>    ResponseSchema(name=<span class="hljs-string">&quot;time&quot;</span>, description=<span class="hljs-string">&quot;äº‹ä»¶å‘ç”Ÿçš„æ—¶é—´&quot;</span>),<br>    ResponseSchema(name=<span class="hljs-string">&quot;location&quot;</span>, description=<span class="hljs-string">&quot;äº‹ä»¶å‘ç”Ÿçš„åœ°ç‚¹&quot;</span>),<br>    ResponseSchema(name=<span class="hljs-string">&quot;event&quot;</span>, description=<span class="hljs-string">&quot;å‘ç”Ÿçš„å…·ä½“äº‹ä»¶&quot;</span>),<br>]<br>parser = StructuredOutputParser.from_response_schemas(schemas)<br><br>summary_prompt = PromptTemplate.from_template(<br>    <span class="hljs-string">&quot;è¯·ä»ä¸‹é¢è¿™æ®µæ–°é—»å†…å®¹ä¸­æå–å…³é”®ä¿¡æ¯ï¼Œå¹¶è¿”å›ç»“æ„åŒ–JSONæ ¼å¼ï¼š\n\n&#123;news&#125;\n\n&#123;format_instructions&#125;&quot;</span><br>)<br><br><span class="hljs-comment"># ç¬¬äºŒä¸ªå­é“¾ï¼šç”Ÿæˆæ–°é—»æ‘˜è¦</span><br>summary_chain = (<br>    summary_prompt.partial(format_instructions=parser.get_format_instructions())<br>    | model<br>    | parser<br>)<br><br><span class="hljs-comment"># ç»„åˆæˆä¸€ä¸ªå¤åˆ Chain</span><br>full_chain = news_chain | summary_chain<br><br><span class="hljs-comment"># è°ƒç”¨å¤åˆé“¾</span><br>result = full_chain.invoke(&#123;<span class="hljs-string">&quot;title&quot;</span>: <span class="hljs-string">&quot;è‹¹æœå…¬å¸åœ¨åŠ å·å‘å¸ƒæ–°æ¬¾AIèŠ¯ç‰‡&quot;</span>&#125;)<br><span class="hljs-built_in">print</span>(result)<br></code></pre></td></tr></table></figure>

<p><strong>ç®¡é“æ“ä½œç¬¦ <code>|</code> ä¼šè‡ªåŠ¨å°†å‰ä¸€ä¸ªé“¾çš„è¾“å‡ºä½œä¸ºåä¸€ä¸ªé“¾çš„è¾“å…¥</strong>ï¼Œæ•´ä½“æµç¨‹å¦‚ä¸‹æ‰€ç¤ºï¼š</p>
<figure class="highlight tex"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><code class="hljs tex">ç”¨æˆ·è¾“å…¥ï¼ˆtitleï¼‰  <br>        â”‚  <br>        â–¼  <br>â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  <br>â”‚  Chain 1: ç”Ÿæˆæ–°é—»æ­£æ–‡       â”‚  <br>â”‚  Prompt: news<span class="hljs-built_in">_</span>gen<span class="hljs-built_in">_</span>prompt   â”‚  <br>â”‚  Model: DeepSeek           â”‚  <br>â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  <br>        â”‚  <br>        â–¼  <br>ç”Ÿæˆçš„æ–°é—»å†…å®¹ï¼ˆnewsï¼‰  <br>        â”‚  <br>        â–¼  <br>â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  <br>â”‚  Chain 2: æå–ç»“æ„åŒ–å­—æ®µ(æ‘˜è¦)           â”‚  <br>â”‚  Prompt: summary<span class="hljs-built_in">_</span>pro                  â”‚  <br>â”‚  Model: DeepSeek                      â”‚  <br>â”‚  OutputParser: StructuredOutputParser â”‚  <br>â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  <br>        â”‚  <br>        â–¼  <br>ç»“åŒ–è¾“å‡ºï¼ˆå¦‚ JSONï¼šæ—¶é—´ã€åœ°ç‚¹ã€äº‹ä»¶ï¼‰<br></code></pre></td></tr></table></figure>

<p>ä¹Ÿå¯ä»¥å€ŸåŠ©<code>LangChain</code>é€‚é…å™¨è®¾ç½®è‡ªå®šä¹‰å¯è¿è¡Œçš„èŠ‚ç‚¹</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> langchain.chat_models <span class="hljs-keyword">import</span> init_chat_model<br><span class="hljs-keyword">from</span> langchain_core.prompts <span class="hljs-keyword">import</span> PromptTemplate<br><span class="hljs-keyword">from</span> langchain.output_parsers <span class="hljs-keyword">import</span> ResponseSchema, StructuredOutputParser<br><span class="hljs-keyword">from</span> langchain_core.runnables <span class="hljs-keyword">import</span> RunnableLambda<br><span class="hljs-keyword">from</span> dotenv <span class="hljs-keyword">import</span> load_dotenv<br>load_dotenv(override=<span class="hljs-literal">True</span>) <span class="hljs-comment"># åŠ è½½ .env æ–‡ä»¶ä¸­çš„ç¯å¢ƒå˜é‡</span><br><br><span class="hljs-comment"># ä½¿ç”¨ DeepSeek æ¨¡å‹</span><br>model = init_chat_model(model=<span class="hljs-string">&quot;deepseek-chat&quot;</span>, model_provider=<span class="hljs-string">&quot;deepseek&quot;</span>)<br><br><span class="hljs-comment"># ç¬¬ä¸€æ­¥ï¼šæ ¹æ®æ ‡é¢˜ç”Ÿæˆæ–°é—»æ­£æ–‡</span><br>news_gen_prompt = PromptTemplate.from_template(<br>    <span class="hljs-string">&quot;è¯·æ ¹æ®ä»¥ä¸‹æ–°é—»æ ‡é¢˜æ’°å†™ä¸€æ®µç®€çŸ­çš„æ–°é—»å†…å®¹ï¼ˆ100å­—ä»¥å†…ï¼‰ï¼š\n\næ ‡é¢˜ï¼š&#123;title&#125;&quot;</span><br>)<br><br><span class="hljs-comment"># ç¬¬ä¸€ä¸ªå­é“¾ï¼šç”Ÿæˆæ–°é—»å†…å®¹</span><br>news_chain = news_gen_prompt | model<br><br><span class="hljs-comment"># ç¬¬äºŒæ­¥ï¼šä»æ­£æ–‡ä¸­æå–ç»“æ„åŒ–å­—æ®µ</span><br>schemas = [<br>    ResponseSchema(name=<span class="hljs-string">&quot;time&quot;</span>, description=<span class="hljs-string">&quot;äº‹ä»¶å‘ç”Ÿçš„æ—¶é—´&quot;</span>),<br>    ResponseSchema(name=<span class="hljs-string">&quot;location&quot;</span>, description=<span class="hljs-string">&quot;äº‹ä»¶å‘ç”Ÿçš„åœ°ç‚¹&quot;</span>),<br>    ResponseSchema(name=<span class="hljs-string">&quot;event&quot;</span>, description=<span class="hljs-string">&quot;å‘ç”Ÿçš„å…·ä½“äº‹ä»¶&quot;</span>),<br>]<br>parser = StructuredOutputParser.from_response_schemas(schemas)<br><br>summary_prompt = PromptTemplate.from_template(<br>    <span class="hljs-string">&quot;è¯·ä»ä¸‹é¢è¿™æ®µæ–°é—»å†…å®¹ä¸­æå–å…³é”®ä¿¡æ¯ï¼Œå¹¶è¿”å›ç»“æ„åŒ–JSONæ ¼å¼ï¼š\n\n&#123;news&#125;\n\n&#123;format_instructions&#125;&quot;</span><br>)<br><br><span class="hljs-comment"># ç¬¬äºŒä¸ªå­é“¾ï¼šç”Ÿæˆæ–°é—»æ‘˜è¦</span><br>summary_chain = (<br>    summary_prompt.partial(format_instructions=parser.get_format_instructions())<br>    | model<br>    | parser<br>)<br><br><span class="hljs-comment"># ä¸€ä¸ªç®€å•çš„æ‰“å°å‡½æ•°ï¼Œè°ƒè¯•ç”¨</span><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">debug_print</span>(<span class="hljs-params">x</span>):<br>    <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;ä¸­é—´ç»“æœï¼ˆæ–°é—»æ­£æ–‡ï¼‰:&quot;</span>, x)<br>    <span class="hljs-keyword">return</span> x<br><br>debug_node = RunnableLambda(debug_print)<br><br><span class="hljs-comment"># æ’å…¥ debug èŠ‚ç‚¹</span><br>full_chain = news_chain | debug_node | summary_chain<br><br><span class="hljs-comment"># è°ƒç”¨å¤åˆé“¾</span><br>result = full_chain.invoke(&#123;<span class="hljs-string">&quot;title&quot;</span>: <span class="hljs-string">&quot;è‹¹æœå…¬å¸åœ¨åŠ å·å‘å¸ƒæ–°æ¬¾AIèŠ¯ç‰‡&quot;</span>&#125;)<br><span class="hljs-built_in">print</span>(result)<br></code></pre></td></tr></table></figure>

<p>é€šè¿‡ä¸Šè¿°ä¸åŒçš„å°è¯•ï¼Œæˆ‘ä»¬å°±å·²ç»ç†è§£äº†åœ¨<code>langChain</code>ä¸­ï¼Œå¦‚ä½•ä½¿ç”¨<code>ChatPromptTemplate</code>ã€<code>Model</code>ã€<code>OutputParser</code>æ¥æ„å»ºä¸€ä¸ªç®€å•çš„<code>Chain</code>ã€‚å…¶ä¸­ï¼š</p>
<ol>
<li><code>ChatPromptTemplate</code> æ˜¯ç”¨æ¥æ„å»ºæç¤ºæ¨¡æ¿çš„ï¼Œå°†è¾“å…¥çš„é—®é¢˜è½¬åŒ–ä¸ºæ¶ˆæ¯åˆ—è¡¨ï¼Œå¯ä»¥è®¾ç½®ç³»ç»ŸæŒ‡ä»¤ï¼Œä¹Ÿå¯ä»¥æ·»åŠ ä¸€äº›å˜é‡ï¼›</li>
<li><code>Model</code> æ˜¯ç”¨æ¥è°ƒç”¨å¤§æ¨¡å‹çš„ï¼Œå¯ä»¥æŒ‡å®šä½¿ç”¨ä¸åŒçš„æ¨¡å‹ï¼›</li>
<li><code>OutputParser</code> æ˜¯ç”¨æ¥è§£æå¤§æ¨¡å‹çš„å“åº”ç»“æœçš„ï¼Œå¯ä»¥æŒ‡å®šä½¿ç”¨ä¸åŒçš„è§£æå™¨ã€‚</li>
</ol>
<blockquote>
<p>[è¡¥å……] LCELå…³é”®æ¦‚å¿µä»‹ç»</p>
<p>ä»€ä¹ˆæ˜¯ LCELï¼Ÿâ€”â€”LangChain Expression Language è¯¦è§£</p>
<p>åœ¨ç°ä»£å¤§è¯­è¨€æ¨¡å‹ï¼ˆ<code>LLM</code>ï¼‰åº”ç”¨çš„æ„å»ºä¸­ï¼Œ<code>LangChain </code>æä¾›äº†ä¸€ç§å…¨æ–°çš„è¡¨è¾¾èŒƒå¼ï¼Œè¢«ç§°ä¸º <strong><code>LCEL</code>ï¼ˆ<code>LangChain Expression Language</code>ï¼‰</strong>ã€‚å®ƒä¸ä»…ç®€åŒ–äº†æ¨¡å‹äº¤äº’çš„ç¼–æ’è¿‡ç¨‹ï¼Œè¿˜å¢å¼ºäº†ç»„åˆçš„çµæ´»æ€§å’Œå¯ç»´æŠ¤æ€§ã€‚æœ¬æ–‡å°†ä»æ¦‚å¿µã€è®¾è®¡ç›®çš„ã€æ ¸å¿ƒç‰¹æ€§å’Œå®é™…ä»·å€¼å‡ ä¸ªæ–¹é¢ï¼Œç³»ç»Ÿæ€§åœ°ä»‹ç» LCEL çš„æœ¬è´¨ã€‚</p>
<hr>
<p>ä¸€ã€LCEL çš„å®šä¹‰</p>
<p><code>LCEL</code>ï¼Œå…¨ç§°ä¸º **<code>LangChain Expression Language</code>**ï¼Œæ˜¯ä¸€ç§ä¸“ä¸º <code>LangChain </code>æ¡†æ¶è®¾è®¡çš„è¡¨è¾¾è¯­è¨€ã€‚å®ƒé€šè¿‡ä¸€ç§é“¾å¼ç»„åˆçš„æ–¹å¼ï¼Œå…è®¸å¼€å‘è€…ä½¿ç”¨æ¸…æ™°ã€å£°æ˜å¼çš„è¯­æ³•æ¥æ„å»ºè¯­è¨€æ¨¡å‹é©±åŠ¨çš„åº”ç”¨æµç¨‹ã€‚</p>
<p>ç®€å•æ¥è¯´ï¼Œ<code>LCEL</code> æ˜¯ä¸€ç§â€œå‡½æ•°å¼ç®¡é“é£æ ¼â€çš„ç»„ä»¶ç»„åˆæœºåˆ¶ï¼Œç”¨äºè¿æ¥å„ç§å¯æ‰§è¡Œå•å…ƒï¼ˆ<code>Runnable</code>ï¼‰ã€‚è¿™äº›å•å…ƒåŒ…æ‹¬æç¤ºæ¨¡æ¿ã€è¯­è¨€æ¨¡å‹ã€è¾“å‡ºè§£æå™¨ã€å·¥å…·å‡½æ•°ç­‰ã€‚</p>
<hr>
<p>äºŒã€è®¾è®¡ç›®çš„</p>
<p><code>LCEL </code>çš„è®¾è®¡åˆè¡·åœ¨äºï¼š</p>
<ol>
<li><strong>æ¨¡å—åŒ–æ„å»º</strong>ï¼šå°†æ¨¡å‹è°ƒç”¨æµç¨‹æ‹†è§£ä¸ºç‹¬ç«‹ã€å¯é‡ç”¨çš„ç»„ä»¶ã€‚</li>
<li><strong>é€»è¾‘å¯è§†åŒ–</strong>ï¼šé€šè¿‡è¯­æ³•ç¬¦å·ï¼ˆå¦‚ç®¡é“ç¬¦ <code>|</code>ï¼‰å‘ˆç°å‡ºæ˜ç¡®çš„æ•°æ®æµè·¯å¾„ã€‚</li>
<li><strong>ç»Ÿä¸€è¿è¡Œæ¥å£</strong>ï¼šæ‰€æœ‰ <code>LCEL </code>ç»„ä»¶éƒ½å®ç°äº† <code>.invoke()</code>ã€<code>.stream()</code>ã€<code>.batch()</code> ç­‰æ ‡å‡†æ–¹æ³•ï¼Œä¾¿äºåœ¨åŒæ­¥ã€å¼‚æ­¥æˆ–æ‰¹å¤„ç†ç¯å¢ƒä¸‹è°ƒç”¨ã€‚</li>
<li><strong>è„±ç¦»æ¡†æ¶é™åˆ¶</strong>ï¼šç›¸æ¯”ä¼ ç»Ÿçš„ <code>Chain</code> ç±»å’Œ <code>Agent</code> æ¶æ„ï¼Œ<code>LCEL </code>æ›´è½»é‡ã€æ›´å…·è¡¨è¾¾åŠ›ï¼Œå‡å°‘ä¾èµ–çš„â€œé»‘ç›’â€é€»è¾‘ã€‚</li>
</ol>
<hr>
<p>ä¸‰ã€æ ¸å¿ƒç»„æˆ</p>
<ol>
<li><code>Runnable </code>æ¥å£</li>
</ol>
<p><code>LCEL </code>çš„ä¸€åˆ‡åŸºç¡€å•å…ƒéƒ½æ˜¯ <code>Runnable</code> å¯¹è±¡ï¼Œå®ƒæ˜¯ä¸€ç§ç»Ÿä¸€çš„å¯è°ƒç”¨æ¥å£ï¼Œæ”¯æŒå¦‚ä¸‹å½¢å¼ï¼š</p>
<ul>
<li><code>.invoke(input)</code>ï¼šåŒæ­¥è°ƒç”¨</li>
<li><code>.stream(input)</code>ï¼šæµå¼ç”Ÿæˆ</li>
<li><code>.batch(inputs)</code>ï¼šæ‰¹é‡æ‰§è¡Œ</li>
</ul>
<ol start="2">
<li>ç®¡é“è¿ç®—ç¬¦ <code>|</code></li>
</ol>
<p>è¿™æ˜¯ <code>LCEL </code>æœ€å…·ç‰¹è‰²çš„è¯­æ³•ç¬¦å·ã€‚å¤šä¸ª <code>Runnable</code> å¯¹è±¡å¯ä»¥é€šè¿‡ <code>|</code> ä¸²è”èµ·æ¥ï¼Œå½¢æˆæ¸…æ™°çš„æ•°æ®å¤„ç†é“¾ã€‚ä¾‹å¦‚ï¼š</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs python">prompt | model | parser<br></code></pre></td></tr></table></figure>

<p>è¡¨ç¤ºæ•°æ®å°†ä¾æ¬¡ä¼ å…¥æç¤ºæ¨¡æ¿ã€æ¨¡å‹å’Œè¾“å‡ºè§£æå™¨ï¼Œæœ€ç»ˆè¾“å‡ºç»“æ„åŒ–ç»“æœã€‚</p>
<ol start="3">
<li><code>PromptTemplate </code>ä¸ <code>OutputParser</code></li>
</ol>
<p><code>LCEL </code>å¼ºè°ƒç»„ä»¶ä¹‹é—´çš„èŒè´£æ˜ç¡®ï¼Œ<code>Prompt </code>åªè´Ÿè´£æ¨¡æ¿åŒ–è¾“å…¥ï¼Œ<code>Parser </code>åªè´Ÿè´£æ ¼å¼åŒ–è¾“å‡ºï¼Œ<code>Model </code>åªè´Ÿè´£æ¨ç†ã€‚</p>
<hr>
<p>å››ã€å…¸å‹ä¼˜åŠ¿</p>
<table>
<thead>
<tr>
<th>ç‰¹æ€§</th>
<th>æè¿°</th>
<th></th>
</tr>
</thead>
<tbody><tr>
<td>ç®€æ´è¯­æ³•</td>
<td>ä½¿ç”¨ `</td>
<td>` è¿ç®—ç¬¦æå‡å¯è¯»æ€§</td>
</tr>
<tr>
<td>çµæ´»ç»„åˆ</td>
<td>å¯ä»»æ„ç»„åˆ <code>Prompt</code>ã€æ¨¡å‹ã€å·¥å…·ã€å‡½æ•°ç­‰ç»„ä»¶</td>
<td></td>
</tr>
<tr>
<td>æ˜ç¡®è¾¹ç•Œ</td>
<td>æ¯ä¸ªæ­¥éª¤èŒè´£åˆ†æ˜ï¼Œæ–¹ä¾¿è°ƒè¯•ä¸é‡ç”¨</td>
<td></td>
</tr>
<tr>
<td>å¯åµŒå¥—æ‰©å±•</td>
<td>æ”¯æŒå‡½æ•°åŒ…è£…ã€è‡ªå®šä¹‰ä¸­é—´ç»„ä»¶å’Œæµå¼æ‹“å±•</td>
<td></td>
</tr>
<tr>
<td>ä¸ <code>Gradio/FastAPI</code> é›†æˆè‰¯å¥½</td>
<td>å¯ç”¨äºæ„å»º <code>API</code>ã€<code>UI </code>èŠå¤©ç­‰å¤šç§åœºæ™¯</td>
<td></td>
</tr>
</tbody></table>
<hr>
<p>äº”ã€æ€»ç»“</p>
<p>LCEL æ˜¯ LangChain åœ¨ 2024 å¹´æœ«å¼•å…¥çš„ä¸€é¡¹é‡è¦ç‰¹æ€§ï¼Œæ ‡å¿—ç€ä»ä¼ ç»Ÿ Agent æ¶æ„å‘â€œå£°æ˜å¼ã€ç»„åˆå¼â€å¼€å‘èŒƒå¼çš„è½¬å˜ã€‚å®ƒä¸ä»…è®©å¼€å‘è€…èƒ½ä»¥æ›´æ¸…æ™°çš„æ–¹å¼ç»„ç»‡ LLM å·¥ä½œæµï¼Œä¹Ÿå¤§å¤§æé«˜äº†ç³»ç»Ÿçš„å¯ç»´æŠ¤æ€§ä¸å¯æµ‹è¯•æ€§ã€‚</p>
</blockquote>
<h1 id="ä¸‰ã€LangChain-è®°å¿†å­˜å‚¨ä¸æ­å»ºå¤šè½®å¯¹è¯æœºå™¨äºº"><a href="#ä¸‰ã€LangChain-è®°å¿†å­˜å‚¨ä¸æ­å»ºå¤šè½®å¯¹è¯æœºå™¨äºº" class="headerlink" title="ä¸‰ã€LangChain è®°å¿†å­˜å‚¨ä¸æ­å»ºå¤šè½®å¯¹è¯æœºå™¨äºº"></a>ä¸‰ã€<strong>LangChain è®°å¿†å­˜å‚¨ä¸æ­å»ºå¤šè½®å¯¹è¯æœºå™¨äºº</strong></h1><p>åœ¨<code>langChain</code>ä¸­æ„å»ºä¸€ä¸ªåŸºæœ¬çš„é—®ç­”æœºå™¨äººä»…éœ€è¦ä½¿ç”¨ä¸€ä¸ª<code>Chain</code>ä¾¿å¯ä»¥å¿«é€Ÿå®ç°ï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> langchain_core.output_parsers <span class="hljs-keyword">import</span> StrOutputParser<br><span class="hljs-keyword">from</span> langchain.prompts <span class="hljs-keyword">import</span> ChatPromptTemplate<br><span class="hljs-keyword">from</span> langchain.chat_models <span class="hljs-keyword">import</span> init_chat_model<br><span class="hljs-keyword">from</span> dotenv <span class="hljs-keyword">import</span> load_dotenv<br>load_dotenv(override=<span class="hljs-literal">True</span>) <span class="hljs-comment"># åŠ è½½ .env æ–‡ä»¶ä¸­çš„ç¯å¢ƒå˜é‡</span><br><br>chatbot_prompt = ChatPromptTemplate.from_messages([<br>    (<span class="hljs-string">&quot;system&quot;</span>, <span class="hljs-string">&quot;ä½ å«å°æ©˜ï¼Œæ˜¯ä¸€åä¹äºåŠ©äººçš„åŠ©æ‰‹ã€‚&quot;</span>),<br>    (<span class="hljs-string">&quot;user&quot;</span>, <span class="hljs-string">&quot;&#123;input&#125;&quot;</span>)<br>])<br><br><span class="hljs-comment"># ä½¿ç”¨ DeepSeek æ¨¡å‹</span><br>model = init_chat_model(model=<span class="hljs-string">&quot;deepseek-chat&quot;</span>, model_provider=<span class="hljs-string">&quot;deepseek&quot;</span>)<br><br><span class="hljs-comment"># ç›´æ¥ä½¿ç”¨æ¨¡å‹ + è¾“å‡ºè§£æå™¨</span><br>basic_qa_chain = chatbot_prompt | model | StrOutputParser()<br><br><span class="hljs-comment"># æµ‹è¯•</span><br>question = <span class="hljs-string">&quot;ä½ å¥½ï¼Œè¯·ä½ ä»‹ç»ä¸€ä¸‹ä½ è‡ªå·±ã€‚&quot;</span><br>result = basic_qa_chain.invoke(question)<br><span class="hljs-built_in">print</span>(result)<br></code></pre></td></tr></table></figure>

<p>åœ¨<code>LangChain</code>ä¸­ï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡äººå·¥æ‹¼æ¥æ¶ˆæ¯é˜Ÿåˆ—ï¼Œæ¥ä¸ºæ¯æ¬¡æ¨¡å‹è°ƒç”¨è®¾ç½®å¤šè½®å¯¹è¯è®°å¿†ã€‚</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> langchain_core.messages <span class="hljs-keyword">import</span> AIMessage, HumanMessage, SystemMessage<br><span class="hljs-keyword">from</span> langchain_core.prompts <span class="hljs-keyword">import</span> ChatPromptTemplate, MessagesPlaceholder<br><span class="hljs-keyword">from</span> langchain.chat_models <span class="hljs-keyword">import</span> init_chat_model<br><span class="hljs-keyword">from</span> langchain_core.output_parsers <span class="hljs-keyword">import</span> StrOutputParser<br><span class="hljs-keyword">from</span> dotenv <span class="hljs-keyword">import</span> load_dotenv<br>load_dotenv(override=<span class="hljs-literal">True</span>) <span class="hljs-comment"># åŠ è½½ .env æ–‡ä»¶ä¸­çš„ç¯å¢ƒå˜é‡</span><br><br>model  = init_chat_model(model=<span class="hljs-string">&quot;deepseek-chat&quot;</span>, model_provider=<span class="hljs-string">&quot;deepseek&quot;</span>)<br>parser = StrOutputParser()<br><br>prompt = ChatPromptTemplate.from_messages([<br>    SystemMessage(content=<span class="hljs-string">&quot;ä½ å«å°æ©˜ï¼Œæ˜¯ä¸€åä¹äºåŠ©äººçš„åŠ©æ‰‹ã€‚&quot;</span>),<br>    MessagesPlaceholder(variable_name=<span class="hljs-string">&quot;messages&quot;</span>),<br>])<br><br>chain = prompt | model | parser<br><br>messages_list = []  <span class="hljs-comment"># åˆå§‹åŒ–å†å²</span><br><span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;ğŸ”¹ è¾“å…¥ exit ç»“æŸå¯¹è¯&quot;</span>)<br><span class="hljs-keyword">while</span> <span class="hljs-literal">True</span>:<br>    user_query = <span class="hljs-built_in">input</span>(<span class="hljs-string">&quot;ä½ ï¼š&quot;</span>)<br>    <span class="hljs-keyword">if</span> user_query.lower() <span class="hljs-keyword">in</span> &#123;<span class="hljs-string">&quot;exit&quot;</span>, <span class="hljs-string">&quot;quit&quot;</span>&#125;:<br>        <span class="hljs-keyword">break</span><br><br>    <span class="hljs-comment"># 1) è¿½åŠ ç”¨æˆ·æ¶ˆæ¯</span><br>    messages_list.append(HumanMessage(content=user_query))<br><br>    <span class="hljs-comment"># 2) è°ƒç”¨æ¨¡å‹</span><br>    assistant_reply = chain.invoke(&#123;<span class="hljs-string">&quot;messages&quot;</span>: messages_list&#125;)<br>    <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;å°æ©˜ï¼š&quot;</span>, assistant_reply)<br><br>    <span class="hljs-comment"># 3) è¿½åŠ  AI å›å¤</span><br>    messages_list.append(AIMessage(content=assistant_reply))<br><br>    <span class="hljs-comment"># 4) ä»…ä¿ç•™æœ€è¿‘ 50 æ¡</span><br>    messages_list = messages_list[-<span class="hljs-number">50</span>:]<br></code></pre></td></tr></table></figure>

<p>æ­¤å¤–è¿˜æœ‰ä¸€ä¸ªé—®é¢˜æ˜¯ï¼Œå¤§å®¶ç»å¸¸çœ‹åˆ°çš„é—®ç­”æœºå™¨äººå…¶å®éƒ½æ˜¯é‡‡ç”¨æµå¼ä¼ è¾“æ¨¡å¼ã€‚ç”¨æˆ·è¾“å…¥é—®é¢˜ï¼Œç­‰å¾…æ¨¡å‹ç›´æ¥è¿”å›å›ç­”ï¼Œç„¶åç”¨æˆ·å†è¾“å…¥é—®é¢˜ï¼Œæ¨¡å‹å†è¿”å›å›ç­”ï¼Œè¿™æ ·å¾ªç¯ä¸‹å»ï¼Œç”¨æˆ·è¾“å…¥é—®é¢˜å’Œæ¨¡å‹è¿”å›å›ç­”ä¹‹é—´çš„æ—¶é—´é—´éš”å¤ªé•¿ï¼Œå¯¼è‡´ç”¨æˆ·æ„Ÿè§‰æœºå™¨äººååº”å¾ˆæ…¢ã€‚æ‰€ä»¥<code>LangChain</code>æä¾›äº†ä¸€ä¸ª<code>astream</code>æ–¹æ³•ï¼Œå¯ä»¥å®ç°æµå¼è¾“å‡ºï¼Œå³ä¸€æ—¦æ¨¡å‹æœ‰è¾“å‡ºï¼Œå°±ç«‹å³è¿”å›ï¼Œè¿™æ ·ç”¨æˆ·å°±å¯ä»¥çœ‹åˆ°æ¨¡å‹æ­£åœ¨æ€è€ƒï¼Œè€Œä¸æ˜¯ç­‰å¾…æ¨¡å‹æ€è€ƒå®Œå†è¿”å›ã€‚</p>
<p>å®ç°çš„æ–¹æ³•ä¹Ÿéå¸¸ç®€å•ï¼Œåªéœ€è¦åœ¨è°ƒç”¨æ¨¡å‹æ—¶å°†<code>invoke</code>æ–¹æ³•æ›¿æ¢ä¸º<code>astream</code>æ–¹æ³•ï¼Œç„¶åä½¿ç”¨<code>async for</code>å¾ªç¯æ¥æŒç»­è·å–æ¨¡å‹çš„è¾“å‡ºå³å¯ã€‚ä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> langchain_core.output_parsers <span class="hljs-keyword">import</span> StrOutputParser<br><span class="hljs-keyword">from</span> langchain.chat_models <span class="hljs-keyword">import</span> init_chat_model<br><span class="hljs-keyword">from</span> langchain.prompts <span class="hljs-keyword">import</span> ChatPromptTemplate<br><span class="hljs-keyword">from</span> dotenv <span class="hljs-keyword">import</span> load_dotenv<br><span class="hljs-keyword">import</span> asyncio<br><br>load_dotenv(override=<span class="hljs-literal">True</span>)  <span class="hljs-comment"># åŠ è½½ .env æ–‡ä»¶ä¸­çš„ç¯å¢ƒå˜é‡</span><br><br>chatbot_prompt = ChatPromptTemplate.from_messages([<br>    (<span class="hljs-string">&quot;system&quot;</span>, <span class="hljs-string">&quot;ä½ å«å°æ™ºï¼Œæ˜¯ä¸€åä¹äºåŠ©äººçš„åŠ©æ‰‹ã€‚&quot;</span>),<br>    (<span class="hljs-string">&quot;user&quot;</span>, <span class="hljs-string">&quot;&#123;input&#125;&quot;</span>)<br>])<br><br><span class="hljs-comment"># ä½¿ç”¨ DeepSeek æ¨¡å‹</span><br>model = init_chat_model(model=<span class="hljs-string">&quot;deepseek-chat&quot;</span>, model_provider=<span class="hljs-string">&quot;deepseek&quot;</span>)<br><br><span class="hljs-comment"># ç›´æ¥ä½¿ç”¨æç¤ºæ¨¡ç‰ˆ + æ¨¡å‹ + è¾“å‡ºè§£æå™¨</span><br>qa_chain_with_system = chatbot_prompt | model | StrOutputParser()<br><br><span class="hljs-keyword">async</span> <span class="hljs-keyword">def</span> <span class="hljs-title function_">main</span>():<br>    <span class="hljs-keyword">async</span> <span class="hljs-keyword">for</span> chunk <span class="hljs-keyword">in</span> qa_chain_with_system.astream(&#123;<span class="hljs-string">&quot;input&quot;</span>: <span class="hljs-string">&quot;ä½ å¥½ï¼Œè¯·ä½ ä»‹ç»ä¸€ä¸‹ä½ è‡ªå·±&quot;</span>&#125;):<br>        <span class="hljs-built_in">print</span>(chunk, end=<span class="hljs-string">&quot;&quot;</span>, flush=<span class="hljs-literal">True</span>)<br><br><span class="hljs-comment"># è¿è¡Œå¼‚æ­¥ä¸»å‡½æ•°</span><br>asyncio.run(main())<br></code></pre></td></tr></table></figure>

<p>åŒæ ·çš„ï¼Œå¯ä»¥è¿›ä¸€æ­¥ä¸ºæ¯æ¬¡æ¨¡å‹è°ƒç”¨è®¾ç½®å¤šè½®å¯¹è¯è®°å¿†ã€‚</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">import</span> asyncio<br><span class="hljs-keyword">from</span> langchain_core.messages <span class="hljs-keyword">import</span> AIMessage, HumanMessage, SystemMessage<br><span class="hljs-keyword">from</span> langchain_core.prompts <span class="hljs-keyword">import</span> ChatPromptTemplate, MessagesPlaceholder<br><span class="hljs-keyword">from</span> langchain.chat_models <span class="hljs-keyword">import</span> init_chat_model<br><span class="hljs-keyword">from</span> langchain_core.output_parsers <span class="hljs-keyword">import</span> StrOutputParser<br><span class="hljs-keyword">from</span> dotenv <span class="hljs-keyword">import</span> load_dotenv<br><br>load_dotenv(override=<span class="hljs-literal">True</span>)  <span class="hljs-comment"># åŠ è½½ .env æ–‡ä»¶ä¸­çš„ç¯å¢ƒå˜é‡</span><br><br>model = init_chat_model(model=<span class="hljs-string">&quot;deepseek-chat&quot;</span>, model_provider=<span class="hljs-string">&quot;deepseek&quot;</span>)<br>parser = StrOutputParser()<br><br>prompt = ChatPromptTemplate.from_messages([<br>    SystemMessage(content=<span class="hljs-string">&quot;ä½ å«å°æ©˜ï¼Œæ˜¯ä¸€åä¹äºåŠ©äººçš„åŠ©æ‰‹ã€‚&quot;</span>),<br>    MessagesPlaceholder(variable_name=<span class="hljs-string">&quot;messages&quot;</span>),<br>])<br><br>chain = prompt | model | parser<br><span class="hljs-keyword">async</span> <span class="hljs-keyword">def</span> <span class="hljs-title function_">main</span>():<br>    messages_list = []  <span class="hljs-comment"># åˆå§‹åŒ–å†å²</span><br>    <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;ğŸ”¹ è¾“å…¥ exit ç»“æŸå¯¹è¯&quot;</span>)<br><br>    <span class="hljs-keyword">while</span> <span class="hljs-literal">True</span>:<br>        user_query = <span class="hljs-built_in">input</span>(<span class="hljs-string">&quot;ä½ ï¼š&quot;</span>)<br>        <span class="hljs-keyword">if</span> user_query.lower() <span class="hljs-keyword">in</span> &#123;<span class="hljs-string">&quot;exit&quot;</span>, <span class="hljs-string">&quot;quit&quot;</span>&#125;:<br>            <span class="hljs-keyword">break</span><br><br>        <span class="hljs-comment"># 1) è¿½åŠ ç”¨æˆ·æ¶ˆæ¯</span><br>        messages_list.append(HumanMessage(content=user_query))<br><br>        <span class="hljs-comment"># 2) è°ƒç”¨æ¨¡å‹ï¼ˆå¼‚æ­¥æµå¼è¾“å‡ºï¼‰</span><br>        <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;å°æ©˜ï¼š&quot;</span>, end=<span class="hljs-string">&quot;&quot;</span>, flush=<span class="hljs-literal">True</span>)<br>        assistant_reply = <span class="hljs-string">&quot;&quot;</span><br>        <span class="hljs-keyword">async</span> <span class="hljs-keyword">for</span> chunk <span class="hljs-keyword">in</span> chain.astream(&#123;<span class="hljs-string">&quot;messages&quot;</span>: messages_list&#125;):<br>            <span class="hljs-built_in">print</span>(chunk, end=<span class="hljs-string">&quot;&quot;</span>, flush=<span class="hljs-literal">True</span>)<br>            assistant_reply += chunk  <span class="hljs-comment"># æ”¶é›†å›å¤å†…å®¹</span><br>        <span class="hljs-built_in">print</span>() <span class="hljs-comment"># æ¢è¡Œ</span><br><br>        <span class="hljs-comment"># 3) è¿½åŠ  AI å›å¤</span><br>        messages_list.append(AIMessage(content=assistant_reply))<br><br>        <span class="hljs-comment"># 4) ä»…ä¿ç•™æœ€è¿‘ 50 æ¡</span><br>        messages_list = messages_list[-<span class="hljs-number">50</span>:]<br><br><span class="hljs-comment"># è¿è¡Œå¼‚æ­¥ä¸»å‡½æ•°</span><br>asyncio.run(main())<br></code></pre></td></tr></table></figure>

<p>å¦‚ä¸Šæ‰€ç¤ºå±•ç¤ºçš„é—®ç­”æ•ˆæœå°±æ˜¯æˆ‘ä»¬åœ¨æ„å»ºå¤§æ¨¡å‹åº”ç”¨æ—¶éœ€è¦å®ç°çš„æµå¼è¾“å‡ºæ•ˆæœã€‚æ¥ä¸‹æ¥æˆ‘ä»¬å°±è¿›ä¸€æ­¥åœ°ï¼Œä½¿ç”¨<code>gradio</code>æ¥å¼€å‘ä¸€ä¸ªæ”¯æŒåœ¨ç½‘é¡µä¸Šè¿›è¡Œäº¤äº’çš„é—®ç­”æœºå™¨äººã€‚<code>Gradio </code>æ˜¯ä¸€ä¸ªç”¨äºå¿«é€Ÿæ„å»ºæœºå™¨å­¦ä¹ æ¨¡å‹<strong>äº¤äº’å¼æ¼”ç¤ºç•Œé¢</strong>çš„ <code>Python </code>åº“ã€‚å®ƒå…è®¸å¼€å‘è€…ç”¨å‡ è¡Œä»£ç åˆ›å»º <code>Web </code>åº”ç”¨ï¼Œæ— éœ€å‰ç«¯çŸ¥è¯†å³å¯è®©ç”¨æˆ·é€šè¿‡æµè§ˆå™¨è¾“å…¥æ•°æ®å¹¶æŸ¥çœ‹æ¨¡å‹é¢„æµ‹ç»“æœã€‚</p>
<p>é¦–å…ˆéœ€è¦å®‰è£…ä¸€ä¸‹<code>gradio</code>çš„ç¬¬ä¸‰æ–¹ä¾èµ–åŒ…</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">pip install gradio<br></code></pre></td></tr></table></figure>

<p>å®Œæ•´å®ç°çš„ä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-comment"># å¯¼å…¥å¿…è¦çš„åº“</span><br><span class="hljs-keyword">import</span> gradio <span class="hljs-keyword">as</span> gr  <span class="hljs-comment"># ç”¨äºæ„å»ºWebç•Œé¢çš„åº“</span><br><span class="hljs-keyword">from</span> langchain.chat_models <span class="hljs-keyword">import</span> init_chat_model  <span class="hljs-comment"># åˆå§‹åŒ–èŠå¤©æ¨¡å‹çš„å‡½æ•°</span><br><span class="hljs-keyword">from</span> langchain_core.output_parsers <span class="hljs-keyword">import</span> StrOutputParser  <span class="hljs-comment"># å­—ç¬¦ä¸²è¾“å‡ºè§£æå™¨</span><br><span class="hljs-keyword">from</span> langchain_core.prompts <span class="hljs-keyword">import</span> ChatPromptTemplate, MessagesPlaceholder  <span class="hljs-comment"># èŠå¤©æç¤ºæ¨¡æ¿å’Œæ¶ˆæ¯å ä½ç¬¦</span><br><span class="hljs-keyword">from</span> langchain_core.messages <span class="hljs-keyword">import</span> SystemMessage, HumanMessage, AIMessage  <span class="hljs-comment"># ç³»ç»Ÿæ¶ˆæ¯ã€äººç±»æ¶ˆæ¯å’ŒAIæ¶ˆæ¯</span><br><span class="hljs-keyword">from</span> dotenv <span class="hljs-keyword">import</span> load_dotenv  <span class="hljs-comment"># ç”¨äºåŠ è½½ç¯å¢ƒå˜é‡</span><br>load_dotenv(override=<span class="hljs-literal">True</span>)  <span class="hljs-comment"># åŠ è½½ .env æ–‡ä»¶ä¸­çš„ç¯å¢ƒå˜é‡ï¼ˆç”¨äºå­˜å‚¨APIå¯†é’¥ç­‰æ•æ„Ÿä¿¡æ¯ï¼‰</span><br><br><span class="hljs-comment"># ==================== ç¬¬ä¸€éƒ¨åˆ†ï¼šè®¾ç½®è¯­è¨€æ¨¡å‹å’Œå¯¹è¯é“¾ ====================</span><br><br><span class="hljs-comment"># 1. åˆå§‹åŒ–èŠå¤©æ¨¡å‹</span><br><span class="hljs-comment"># ä½¿ç”¨&quot;deepseek-chat&quot;æ¨¡å‹ï¼Œæ¨¡å‹æä¾›è€…ä¸º&quot;deepseek&quot;</span><br>model = init_chat_model(<span class="hljs-string">&quot;deepseek-chat&quot;</span>, model_provider=<span class="hljs-string">&quot;deepseek&quot;</span>)<br><br><span class="hljs-comment"># 2. åˆ›å»ºè¾“å‡ºè§£æå™¨ï¼ˆå°†æ¨¡å‹è¾“å‡ºè½¬æ¢ä¸ºå­—ç¬¦ä¸²ï¼‰</span><br>parser = StrOutputParser()<br><br><span class="hljs-comment"># 3. åˆ›å»ºèŠå¤©æç¤ºæ¨¡æ¿</span><br><span class="hljs-comment"># è¿™é‡Œå®šä¹‰äº†ä¸€ä¸ªç³»ç»Ÿæ¶ˆæ¯ï¼ˆè®¾ç½®AIåŠ©æ‰‹çš„è§’è‰²ï¼‰å’Œä¸€ä¸ªæ¶ˆæ¯å ä½ç¬¦ï¼ˆç”¨äºä¼ å…¥å¯¹è¯å†å²ï¼‰</span><br>chatbot_prompt = ChatPromptTemplate.from_messages(<br>    [<br>        SystemMessage(content=<span class="hljs-string">&quot;ä½ å«å°æ©˜ï¼Œæ˜¯ä¸€åä¹äºåŠ©äººçš„åŠ©æ‰‹ã€‚&quot;</span>),  <span class="hljs-comment"># ç³»ç»Ÿè§’è‰²è®¾å®š</span><br>        MessagesPlaceholder(variable_name=<span class="hljs-string">&quot;messages&quot;</span>),  <span class="hljs-comment"># æ‰‹åŠ¨ä¼ å…¥å†å²å¯¹è¯æ¶ˆæ¯</span><br>    ]<br>)<br><br><span class="hljs-comment"># 4. åˆ›å»ºå¯¹è¯é“¾</span><br><span class="hljs-comment"># ä½¿ç”¨LangChainçš„LCELï¼ˆLangChain Expression Languageï¼‰å°†æç¤ºæ¨¡æ¿ã€æ¨¡å‹å’Œè§£æå™¨ç»„åˆèµ·æ¥</span><br><span class="hljs-comment"># æµç¨‹ï¼šæç¤ºæ¨¡æ¿ -&gt; æ¨¡å‹ -&gt; è¾“å‡ºè§£æå™¨</span><br>qa_chain = chatbot_prompt | model | parser<br><br><span class="hljs-comment"># ==================== ç¬¬äºŒéƒ¨åˆ†ï¼šåˆ›å»ºGradioç•Œé¢ ====================</span><br><br><span class="hljs-comment"># å®šä¹‰CSSæ ·å¼ï¼ˆç”¨äºç¾åŒ–ç•Œé¢ï¼‰</span><br>CSS = <span class="hljs-string">&quot;&quot;&quot;</span><br><span class="hljs-string">.main-container &#123;max-width: 1200px; margin: 0 auto; padding: 20px;&#125;  # ä¸»å®¹å™¨æ ·å¼</span><br><span class="hljs-string">.header-text &#123;text-align: center; margin-bottom: 20px;&#125;  # æ ‡é¢˜æ ·å¼</span><br><span class="hljs-string">&quot;&quot;&quot;</span><br><br><span class="hljs-comment"># åˆ›å»ºèŠå¤©æœºå™¨äººç•Œé¢çš„å‡½æ•°</span><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">create_chatbot</span>() -&gt; gr.Blocks:<br>    <span class="hljs-comment"># åˆ›å»ºä¸€ä¸ªGradio Blocksç•Œé¢ï¼ˆæ¯”Interfaceæ›´çµæ´»ï¼‰</span><br>    <span class="hljs-keyword">with</span> gr.Blocks(title=<span class="hljs-string">&quot;DeepSeek Chat&quot;</span>, css=CSS) <span class="hljs-keyword">as</span> demo:  <span class="hljs-comment"># è®¾ç½®æ ‡é¢˜å’ŒCSS</span><br>        <span class="hljs-comment"># ä¸»å®¹å™¨ï¼ˆä½¿ç”¨ä¸Šé¢å®šä¹‰çš„CSSç±»ï¼‰</span><br>        <span class="hljs-keyword">with</span> gr.Column(elem_classes=[<span class="hljs-string">&quot;main-container&quot;</span>]):<br>            <span class="hljs-comment"># æ ‡é¢˜</span><br>            gr.Markdown(<span class="hljs-string">&quot;# æµå¼å¯¹è¯æœºå™¨äºº&quot;</span>, elem_classes=[<span class="hljs-string">&quot;header-text&quot;</span>])<br>            <br>            <span class="hljs-comment"># èŠå¤©æœºå™¨äººç»„ä»¶</span><br>            chatbot = gr.Chatbot(<br>                height=<span class="hljs-number">500</span>,  <span class="hljs-comment"># é«˜åº¦500åƒç´ </span><br>                show_copy_button=<span class="hljs-literal">True</span>,  <span class="hljs-comment"># æ˜¾ç¤ºå¤åˆ¶æŒ‰é’®</span><br>                avatar_images=(  <span class="hljs-comment"># è®¾ç½®å¤´åƒ</span><br>                    <span class="hljs-string">&quot;https://smallgoodgood.top/images/23.jpg&quot;</span>,  <span class="hljs-comment"># ç”¨æˆ·å¤´åƒ</span><br>                    <span class="hljs-string">&quot;https://smallgoodgood.top/images/23.jpg&quot;</span>,  <span class="hljs-comment"># AIå¤´åƒ</span><br>                )<br>            )<br>            <br>            <span class="hljs-comment"># è¾“å…¥æ¡†å’ŒæŒ‰é’®</span><br>            msg = gr.Textbox(placeholder=<span class="hljs-string">&quot;è¯·è¾“å…¥æ‚¨çš„é—®é¢˜...&quot;</span>, container=<span class="hljs-literal">False</span>, scale=<span class="hljs-number">7</span>)  <span class="hljs-comment"># æ–‡æœ¬è¾“å…¥æ¡†</span><br>            submit = gr.Button(<span class="hljs-string">&quot;å‘é€&quot;</span>, scale=<span class="hljs-number">1</span>, variant=<span class="hljs-string">&quot;primary&quot;</span>)  <span class="hljs-comment"># å‘é€æŒ‰é’®ï¼ˆä¸»è¦æ ·å¼ï¼‰</span><br>            clear = gr.Button(<span class="hljs-string">&quot;æ¸…ç©º&quot;</span>, scale=<span class="hljs-number">1</span>)  <span class="hljs-comment"># æ¸…ç©ºæŒ‰é’®</span><br><br>        <span class="hljs-comment"># ---------------  çŠ¶æ€ç®¡ç†ï¼šä¿å­˜ messages_list  ---------------</span><br>        <span class="hljs-comment"># Gradioçš„Stateç»„ä»¶ç”¨äºä¿å­˜å¯¹è¯å†å²ï¼ˆçœŸæ­£çš„Messageå¯¹è±¡åˆ—è¡¨ï¼‰</span><br>        state = gr.State([])<br><br>        <span class="hljs-comment"># ---------------  ä¸»å“åº”å‡½æ•°ï¼ˆæµå¼å¤„ç†ï¼‰ ----------------------</span><br>        <span class="hljs-keyword">async</span> <span class="hljs-keyword">def</span> <span class="hljs-title function_">respond</span>(<span class="hljs-params">user_msg: <span class="hljs-built_in">str</span>, chat_hist: <span class="hljs-built_in">list</span>, messages_list: <span class="hljs-built_in">list</span></span>):<br>            <span class="hljs-string">&quot;&quot;&quot;</span><br><span class="hljs-string">            å¤„ç†ç”¨æˆ·è¾“å…¥å¹¶ç”ŸæˆAIå›å¤ï¼ˆæµå¼ï¼‰</span><br><span class="hljs-string">            å‚æ•°:</span><br><span class="hljs-string">                user_msg: ç”¨æˆ·è¾“å…¥çš„æ¶ˆæ¯</span><br><span class="hljs-string">                chat_hist: èŠå¤©å†å²ï¼ˆç”¨äºæ˜¾ç¤ºåœ¨ç•Œé¢ä¸Šï¼‰</span><br><span class="hljs-string">                messages_list: ä¿å­˜çš„Messageå¯¹è±¡åˆ—è¡¨ï¼ˆç”¨äºæ¨¡å‹å¤„ç†ï¼‰</span><br><span class="hljs-string">            è¿”å›:</span><br><span class="hljs-string">                æ›´æ–°åçš„msg, chat_histå’Œmessages_list</span><br><span class="hljs-string">            &quot;&quot;&quot;</span><br>            <br>            <span class="hljs-comment"># 1) æ£€æŸ¥ç”¨æˆ·è¾“å…¥æ˜¯å¦ä¸ºç©º</span><br>            <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> user_msg.strip():<br>                <span class="hljs-keyword">yield</span> <span class="hljs-string">&quot;&quot;</span>, chat_hist, messages_list  <span class="hljs-comment"># å¦‚æœä¸ºç©ºï¼Œç›´æ¥è¿”å›</span><br>                <span class="hljs-keyword">return</span><br><br>            <span class="hljs-comment"># 2) å°†ç”¨æˆ·æ¶ˆæ¯æ·»åŠ åˆ°å†å²ä¸­</span><br>            <span class="hljs-comment"># åˆ›å»ºHumanMessageå¯¹è±¡ï¼ˆè¡¨ç¤ºç”¨æˆ·æ¶ˆæ¯ï¼‰</span><br>            messages_list.append(HumanMessage(content=user_msg))<br>            <span class="hljs-comment"># æ›´æ–°èŠå¤©å†å²ï¼ˆç”¨äºç•Œé¢æ˜¾ç¤ºï¼‰</span><br>            chat_hist = chat_hist + [(user_msg, <span class="hljs-literal">None</span>)]<br>            <span class="hljs-keyword">yield</span> <span class="hljs-string">&quot;&quot;</span>, chat_hist, messages_list  <span class="hljs-comment"># å…ˆæ˜¾ç¤ºç”¨æˆ·æ¶ˆæ¯</span><br><br>            <span class="hljs-comment"># 3) æµå¼è°ƒç”¨æ¨¡å‹ç”Ÿæˆå›å¤</span><br>            partial = <span class="hljs-string">&quot;&quot;</span>  <span class="hljs-comment"># ç”¨äºç´¯ç§¯æ¨¡å‹çš„æµå¼è¾“å‡º</span><br>            <span class="hljs-comment"># å¼‚æ­¥æµå¼è°ƒç”¨å¯¹è¯é“¾</span><br>            <span class="hljs-keyword">async</span> <span class="hljs-keyword">for</span> chunk <span class="hljs-keyword">in</span> qa_chain.astream(&#123;<span class="hljs-string">&quot;messages&quot;</span>: messages_list&#125;):<br>                partial += chunk  <span class="hljs-comment"># ç´¯ç§¯æ¨¡å‹è¾“å‡º</span><br>                <span class="hljs-comment"># æ›´æ–°æœ€åä¸€æ¡AIå›å¤ï¼ˆå®ç°æµå¼æ•ˆæœï¼‰</span><br>                chat_hist[-<span class="hljs-number">1</span>] = (user_msg, partial)<br>                <span class="hljs-keyword">yield</span> <span class="hljs-string">&quot;&quot;</span>, chat_hist, messages_list  <span class="hljs-comment"># å®æ—¶æ›´æ–°ç•Œé¢</span><br><br>            <span class="hljs-comment"># 4) å°†å®Œæ•´å›å¤åŠ å…¥å†å²ï¼Œå¹¶è£å‰ªåˆ°æœ€è¿‘50æ¡ï¼ˆé˜²æ­¢å†…å­˜å ç”¨è¿‡å¤§ï¼‰</span><br>            messages_list.append(AIMessage(content=partial))  <span class="hljs-comment"># åˆ›å»ºAIMessageå¯¹è±¡</span><br>            messages_list = messages_list[-<span class="hljs-number">50</span>:]  <span class="hljs-comment"># åªä¿ç•™æœ€è¿‘50æ¡æ¶ˆæ¯</span><br><br>            <span class="hljs-comment"># 5) æœ€ç»ˆè¿”å›ï¼ˆGradioéœ€è¦æŠŠæ–°çš„stateä¼ å›ï¼‰</span><br>            <span class="hljs-keyword">yield</span> <span class="hljs-string">&quot;&quot;</span>, chat_hist, messages_list<br><br>        <span class="hljs-comment"># ---------------  æ¸…ç©ºå†å²å‡½æ•° -------------------------------</span><br>        <span class="hljs-keyword">def</span> <span class="hljs-title function_">clear_history</span>():<br>            <span class="hljs-string">&quot;&quot;&quot;æ¸…ç©ºèŠå¤©å†å²&quot;&quot;&quot;</span><br>            <span class="hljs-keyword">return</span> [], <span class="hljs-string">&quot;&quot;</span>, []  <span class="hljs-comment"># è¿”å›ç©ºåˆ—è¡¨ï¼Œåˆ†åˆ«å¯¹åº”: chatbot, msgè¾“å…¥æ¡†, messages_list</span><br><br>        <span class="hljs-comment"># ---------------  äº‹ä»¶ç»‘å®š ------------------------------</span><br>        <span class="hljs-comment"># ç»‘å®šè¾“å…¥æ¡†çš„å›è½¦äº‹ä»¶å’Œå‘é€æŒ‰é’®çš„ç‚¹å‡»äº‹ä»¶</span><br>        msg.submit(respond, [msg, chatbot, state], [msg, chatbot, state])<br>        submit.click(respond, [msg, chatbot, state], [msg, chatbot, state])<br>        <span class="hljs-comment"># ç»‘å®šæ¸…ç©ºæŒ‰é’®çš„ç‚¹å‡»äº‹ä»¶</span><br>        clear.click(clear_history, outputs=[chatbot, msg, state])<br><br>    <span class="hljs-keyword">return</span> demo  <span class="hljs-comment"># è¿”å›åˆ›å»ºçš„Gradioç•Œé¢</span><br><br><span class="hljs-comment"># ==================== ç¬¬ä¸‰éƒ¨åˆ†ï¼šå¯åŠ¨åº”ç”¨ ====================</span><br><br><span class="hljs-comment"># åˆ›å»ºèŠå¤©æœºå™¨äººç•Œé¢</span><br>demo = create_chatbot()<br><br><span class="hljs-comment"># å¯åŠ¨åº”ç”¨</span><br><span class="hljs-comment"># å‚æ•°è¯´æ˜:</span><br><span class="hljs-comment"># server_name=&quot;127.0.0.1&quot; - æœ¬åœ°è¿è¡Œ</span><br><span class="hljs-comment"># server_port=7860 - ä½¿ç”¨7860ç«¯å£</span><br><span class="hljs-comment"># share=False - ä¸ç”Ÿæˆå…¬å¼€é“¾æ¥</span><br><span class="hljs-comment"># debug=True - è°ƒè¯•æ¨¡å¼</span><br>demo.launch(server_name=<span class="hljs-string">&quot;127.0.0.1&quot;</span>, server_port=<span class="hljs-number">7860</span>, share=<span class="hljs-literal">False</span>, debug=<span class="hljs-literal">True</span>)<br></code></pre></td></tr></table></figure>

<p>è¿è¡Œåï¼Œåœ¨æµè§ˆå™¨è®¿é—®<code>http://127.0.0.1:7860</code>å³å¯è¿›è¡Œé—®ç­”äº¤äº’ã€‚</p>
<p>å½“ç„¶è¿™åªæ˜¯æœ€ç®€å•çš„é—®ç­”æœºå™¨äººå®ç°å½¢å¼ï¼Œå®é™…ä¸Šä¼ä¸šåº”ç”¨çš„é—®ç­”æœºå™¨äººå¾€å¾€éœ€è¦æ›´åŠ å¤æ‚çš„é€»è¾‘ï¼Œæ¯”å¦‚ç”¨æˆ·æƒé™ç®¡ç†ã€ä¸Šä¸‹æ–‡è®°å¿†ç­‰</p>
<h1 id="å››ã€LangChain-æ¥å…¥å·¥å…·æµç¨‹"><a href="#å››ã€LangChain-æ¥å…¥å·¥å…·æµç¨‹" class="headerlink" title="å››ã€LangChain æ¥å…¥å·¥å…·æµç¨‹"></a>å››ã€<strong>LangChain æ¥å…¥å·¥å…·æµç¨‹</strong></h1><p>åœ¨<code>LangChain</code>ç”Ÿæ€ä¸­ï¼Œæ—¢æœ‰æµ·é‡ä¸°å¯Œçš„<strong>å†…ç½®å·¥å…·</strong>ï¼ŒåŒæ—¶ä¹Ÿèƒ½æ¥å…¥è‡ªå®šä¹‰å·¥å…·ï¼Œä¸ä»…èƒ½é€šè¿‡æ­å»ºä¸€ä¸ªä¸ªé“¾ï¼ˆ<code>Chain</code>ï¼‰å°†å·¥å…·å°è£…åœ¨å¯¹åº”çš„å·¥ä½œæµä¸­ï¼Œä¹Ÿèƒ½å€ŸåŠ©<code>LangChain Agent</code>åŠŸèƒ½ï¼Œå®æ—¶çµæ´»åˆ›å»ºä¸åŒçš„<code>Chain</code>æ¥å®Œæˆå¤æ‚å·¥å…·è°ƒç”¨ï¼Œç”šè‡³è¿˜å¯ä»¥ä½¿ç”¨æ›´é«˜çº§çš„<code>LangGraph</code>è¿›è¡Œå·¥ä½œæµç¼–æ’ã€‚</p>
<p>æœ¬å°èŠ‚æˆ‘ä»¬å°†é¦–å…ˆä»‹ç»å¦‚ä½•åœ¨<code>LangChain</code>ä¸­æ¥å…¥å¤–éƒ¨å·¥å…·ï¼Œç„¶åä»ä¸‹ä¸€å°èŠ‚å¼€å§‹ï¼Œæˆ‘ä»¬ä¼šè¿›ä¸€æ­¥ä»‹ç»å¦‚ä½•ä½¿ç”¨<code>LangChain Agent</code>åº“æ¥æ­å»ºæ›´åŠ å¤æ‚çš„å·¥ä½œæµã€‚</p>
<p>è¿™é‡Œæˆ‘ä»¬é¦–å…ˆä»‹ç»æœ€åŸºæœ¬çš„<code>LangChain</code>æ¥å…¥å·¥å…·æµç¨‹ã€‚åœ¨MCPçˆ†ç«ä¹‹å‰ï¼Œ<code>LangChian</code>ç”Ÿæ€ä¸­å°±å·²ç»å†…ç½®é›†æˆäº†éå¸¸å¤šçš„å®ç”¨å·¥å…·ï¼Œå¼€å‘è€…å¯ä»¥å¿«é€Ÿè°ƒç”¨è¿™äº›å·¥å…·å®Œæˆæ›´åŠ å¤æ‚å·¥ä½œæµçš„å¼€å‘ã€‚</p>
<p><a target="_blank" rel="noopener" href="https://python.langchain.com/docs/integrations/tools/"><code>LangChain</code>å†…ç½®å·¥å…·åˆ—è¡¨</a></p>
<p>æˆ‘ä»¬å°±ä»¥å…¶ä¸­ä»£ç è§£é‡Šå™¨ä¸ºä¾‹ï¼Œæ¥ä»‹ç»å¦‚ä½•å°†<strong>å†…ç½®å·¥å…·</strong>æ¥å…¥<code>LangChain</code>çš„å·¥ä½œæµä¸­ã€‚</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">pip install -qU langchain-community langchain-experimental pandas<br></code></pre></td></tr></table></figure>

<p><code>Telco</code>æ•°æ®é›†æ˜¯<code>Kaggle</code>åˆ†äº«çš„ä¸€ä¸ªé«˜åˆ†æ•°æ®é›†ï¼Œæ˜¯<code>Kaggle</code>å¹³å°ä¸Šéå¸¸ç»å…¸çš„å›´ç»•åæ€æ•°æ®é›†å»ºæ¨¡çš„æ•°æ®é›†ã€‚è¯¥æ•°æ®æºè‡ª<code>IBM</code>å•†ä¸šç¤¾åŒºï¼ˆ<a target="_blank" rel="noopener" href="https://community.ibm.com/community/user/businessanalytics/blogs/steven-macko/2019/07/11/telco-customer-churn-1113">IBM Business Analytics Community</a>ï¼‰ä¸Šåˆ†äº«çš„æ•°æ®é›†ï¼Œç”¨äºç¤¾åŒºæˆå‘˜å†…éƒ¨å­¦ä¹ ä½¿ç”¨ã€‚</p>
<p>æ ¹æ®<code>IBM</code>å•†ä¸šç¤¾åŒºåˆ†äº«å›¢é˜Ÿæè¿°ï¼Œè¯¥æ•°æ®é›†ä¸ºæŸç”µä¿¡å…¬å¸åœ¨åŠ åˆ©ç¦å°¼äºšä¸º7000ä½™ä½ç”¨æˆ·ï¼ˆä¸ªäºº&#x2F;å®¶åº­ï¼‰æä¾›ç”µè¯å’Œäº’è”ç½‘æœåŠ¡çš„ç›¸å…³è®°å½•ã€‚ç”±äºè¯¥æ•°æ®é›†å¹¶ä¸æ˜¯ç«èµ›æ•°æ®é›†ï¼Œå› æ­¤æ•°æ®é›†çš„ä¸‹è½½æ–¹å¼ç›¸å¯¹å®¹æ˜“ï¼Œå®˜ç½‘ä¹Ÿæä¾›äº†ç½‘é¡µä¸‹è½½é€‰é¡¹ã€‚æˆ‘ä»¬å¯ä»¥åœ¨<a target="_blank" rel="noopener" href="https://www.kaggle.com/blastchar/telco-customer-churn">è¯¥æ•°æ®é›†çš„Kaggleä¸»é¡µ</a>çœ‹åˆ°æ•°æ®é›†çš„ç›¸å…³ä¿¡æ¯ä»¥åŠä¸‹è½½åœ°å€ã€‚å½“ç„¶ï¼Œç†Ÿç»ƒä½¿ç”¨<code>Kaggle</code>ä¸»é¡µè·å–æ•°æ®å’ŒæŒ–æ˜ä¿¡æ¯ï¼ˆè€Œä¸æ˜¯å€ŸåŠ©ç¬¬ä¸‰æ–¹æ¸ é“ï¼‰ï¼Œä¹Ÿæ˜¯ç®—æ³•å·¥ç¨‹å¸ˆå¿…å¤‡æŠ€èƒ½ä¹‹ä¸€ã€‚</p>
<p>æˆ‘ä»¬å¯ä»¥å…ˆç”¨ä»¥ä¸‹ä»£ç æŸ¥çœ‹æ•°æ®é›†çš„ä¸€äº›åŸºæœ¬ä¿¡æ¯ï¼š</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">import</span> pandas <span class="hljs-keyword">as</span> pd<br>dataset = pd.read_csv(<span class="hljs-string">&#x27;WA_Fn-UseC_-Telco-Customer-Churn.csv&#x27;</span>)<br>pd.set_option(<span class="hljs-string">&#x27;max_colwidth&#x27;</span>,<span class="hljs-number">200</span>)<br><span class="hljs-built_in">print</span>(dataset.head(<span class="hljs-number">5</span>))<br>dataset.info()<br></code></pre></td></tr></table></figure>

<p>å…¶ä¸­æ•°æ®é›†å„å­—æ®µè§£é‡Šå¦‚ä¸‹ï¼š</p>
<table>
<thead>
<tr>
<th align="center">å­—æ®µ</th>
<th align="center">è§£é‡Š</th>
</tr>
</thead>
<tbody><tr>
<td align="center">customerID</td>
<td align="center">ç”¨æˆ·ID</td>
</tr>
<tr>
<td align="center">gender</td>
<td align="center">æ€§åˆ«</td>
</tr>
<tr>
<td align="center">SeniorCitizen</td>
<td align="center">æ˜¯å¦æ˜¯è€å¹´äººï¼ˆ1ä»£è¡¨æ˜¯ï¼‰</td>
</tr>
<tr>
<td align="center">Partner</td>
<td align="center">æ˜¯å¦æœ‰é…å¶ï¼ˆYes or Noï¼‰</td>
</tr>
<tr>
<td align="center">Dependents</td>
<td align="center">æ˜¯å¦ç»æµç‹¬ç«‹ï¼ˆYes or Noï¼‰</td>
</tr>
<tr>
<td align="center">tenure</td>
<td align="center">ç”¨æˆ·å…¥ç½‘æ—¶é—´</td>
</tr>
<tr>
<td align="center">PhoneService</td>
<td align="center">æ˜¯å¦å¼€é€šç”µè¯ä¸šåŠ¡ï¼ˆYes or Noï¼‰</td>
</tr>
<tr>
<td align="center">MultipleLines</td>
<td align="center">æ˜¯å¦å¼€é€šå¤šæ¡ç”µè¯ä¸šåŠ¡ï¼ˆYes ã€ No or No phoneserviceï¼‰</td>
</tr>
<tr>
<td align="center">InternetService</td>
<td align="center">æ˜¯å¦å¼€é€šäº’è”ç½‘æœåŠ¡ï¼ˆNoã€DSLæ•°å­—ç½‘ç»œæˆ–filber poticå…‰çº¿ç½‘ç»œï¼‰</td>
</tr>
<tr>
<td align="center">OnlineSecurity</td>
<td align="center">æ˜¯å¦å¼€é€šç½‘ç»œå®‰å…¨æœåŠ¡ï¼ˆYesã€No or No internetserviceï¼‰</td>
</tr>
<tr>
<td align="center">OnlineBackup</td>
<td align="center">æ˜¯å¦å¼€é€šåœ¨çº¿å¤‡ä»½æœåŠ¡ï¼ˆYesã€No or No internetserviceï¼‰</td>
</tr>
<tr>
<td align="center">DeviceProtection</td>
<td align="center">æ˜¯å¦å¼€é€šè®¾å¤‡ä¿æŠ¤æœåŠ¡ï¼ˆYesã€No or No internetserviceï¼‰</td>
</tr>
<tr>
<td align="center">TechSupport</td>
<td align="center">æ˜¯å¦å¼€é€šæŠ€æœ¯æ”¯æŒä¸šåŠ¡ï¼ˆYesã€No or No internetserviceï¼‰</td>
</tr>
<tr>
<td align="center">StreamingTV</td>
<td align="center">æ˜¯å¦å¼€é€šç½‘ç»œç”µè§†ï¼ˆYesã€No or No internetserviceï¼‰</td>
</tr>
<tr>
<td align="center">StreamingMovies</td>
<td align="center">æ˜¯å¦å¼€é€šç½‘ç»œç”µå½±ï¼ˆYesã€No or No internetserviceï¼‰</td>
</tr>
<tr>
<td align="center">Contract</td>
<td align="center">åˆåŒç­¾è®¢æ–¹å¼ï¼ˆæŒ‰æœˆã€æŒ‰å¹´æˆ–è€…ä¸¤å¹´ï¼‰</td>
</tr>
<tr>
<td align="center">PaperlessBilling</td>
<td align="center">æ˜¯å¦å¼€é€šç”µå­è´¦å•ï¼ˆYes or Noï¼‰</td>
</tr>
<tr>
<td align="center">PaymentMethod</td>
<td align="center">ä»˜æ¬¾æ–¹å¼ï¼ˆbank transferã€credit cardã€electronic checkã€mailed checkï¼‰</td>
</tr>
<tr>
<td align="center">MonthlyCharges</td>
<td align="center">æœˆåº¦è´¹ç”¨</td>
</tr>
<tr>
<td align="center">TotalCharges</td>
<td align="center">æ€»è´¹ç”¨</td>
</tr>
<tr>
<td align="center">Churn</td>
<td align="center">æ˜¯å¦æµå¤±ï¼ˆYes or Noï¼‰</td>
</tr>
</tbody></table>
<p>æ¥ä¸‹æ¥æµ‹è¯•<code>LangChain</code>å†…ç½®ä»£ç è§£é‡Šå™¨å·¥å…·åŠŸèƒ½ï¼š</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-comment"># å¯¼å…¥å¿…è¦çš„åº“</span><br><span class="hljs-keyword">import</span> pandas <span class="hljs-keyword">as</span> pd  <span class="hljs-comment"># ç”¨äºæ•°æ®å¤„ç†å’Œåˆ†æçš„æ ¸å¿ƒåº“</span><br><span class="hljs-keyword">from</span> langchain_experimental.tools <span class="hljs-keyword">import</span> PythonAstREPLTool  <span class="hljs-comment"># LangChainçš„å®éªŒæ€§å·¥å…·ï¼Œå…è®¸å®‰å…¨æ‰§è¡ŒPythonä»£ç </span><br><br><span class="hljs-comment"># è¯»å–CSVæ–‡ä»¶åˆ°Pandas DataFrame</span><br><span class="hljs-comment"># è¿™æ˜¯ä¸€ä¸ªç”µä¿¡å®¢æˆ·æµå¤±æ•°æ®é›†(æ¥è‡ªKaggle)</span><br>df = pd.read_csv(<span class="hljs-string">&#x27;WA_Fn-UseC_-Telco-Customer-Churn.csv&#x27;</span>)<br><br><span class="hljs-comment"># åˆ›å»ºPythonAstREPLToolå·¥å…·å®ä¾‹</span><br><span class="hljs-comment"># localså‚æ•°å°†å½“å‰ä½œç”¨åŸŸçš„å˜é‡(è¿™é‡Œåªæœ‰df)ä¼ é€’åˆ°å·¥å…·çš„æ‰§è¡Œç¯å¢ƒä¸­</span><br><span class="hljs-comment"># è¿™æ ·å·¥å…·å†…éƒ¨å°±å¯ä»¥è®¿é—®è¿™ä¸ªDataFrame</span><br>tool = PythonAstREPLTool(<span class="hljs-built_in">locals</span>=&#123;<span class="hljs-string">&quot;df&quot;</span>: df&#125;)<br><br><span class="hljs-comment"># ä½¿ç”¨LangChainå†…ç½®ä»£ç è§£é‡Šå™¨å·¥å…·æ‰§è¡ŒPythonä»£ç å­—ç¬¦ä¸²</span><br><span class="hljs-comment"># è¿™é‡Œè®¡ç®—&#x27;SeniorCitizen&#x27;åˆ—çš„å¹³å‡å€¼</span><br><span class="hljs-comment"># invokeæ–¹æ³•ä¼šå®‰å…¨åœ°æ‰§è¡Œä¼ å…¥çš„ä»£ç å¹¶è¿”å›ç»“æœ</span><br><span class="hljs-built_in">print</span>(tool.invoke(<span class="hljs-string">&quot;df[&#x27;SeniorCitizen&#x27;].mean()&quot;</span>))  <span class="hljs-comment"># è¾“å‡ºè€å¹´å®¢æˆ·æ¯”ä¾‹çš„å¹³å‡å€¼</span><br><br><span class="hljs-comment"># ç›´æ¥ä½¿ç”¨Pandasè®¡ç®—&#x27;MonthlyCharges&#x27;åˆ—çš„å¹³å‡å€¼</span><br><span class="hljs-comment"># è¿™æ˜¯å¸¸è§„çš„Pandasæ“ä½œæ–¹å¼ï¼Œä¸ä½¿ç”¨LangChainå·¥å…·</span><br><span class="hljs-built_in">print</span>(df[<span class="hljs-string">&#x27;MonthlyCharges&#x27;</span>].mean())  <span class="hljs-comment"># è¾“å‡ºæœˆè´¹ç”¨çš„å¹³å‡å€¼</span><br></code></pre></td></tr></table></figure>

<p><code>PythonAstREPLTool</code>æ˜¯ä¸€ä¸ªä»£ç æ‰§è¡Œå·¥å…·ï¼Œç‰¹ç‚¹ï¼š</p>
<ul>
<li>å®‰å…¨åœ°åœ¨æ²™ç®±ä¸­æ‰§è¡Œ<code>Python</code>ä»£ç </li>
<li>å¯ä»¥é™åˆ¶å¯è®¿é—®çš„å˜é‡å’Œå‡½æ•°</li>
<li>å¸¸ç”¨äº<code>AI</code>ä»£ç†(<code>Agent</code>)ä¸­è®©AIåŠ¨æ€æ‰§è¡Œä»£ç </li>
</ul>
<p>é€šè¿‡<code>locals</code>å‚æ•°ï¼Œæˆ‘ä»¬åªæš´éœ²<code>df</code>å˜é‡ç»™å·¥å…·</p>
<p>ç„¶å<code>invoke()</code>æ–¹æ³•æ‰§è¡Œä»£ç å­—ç¬¦ä¸²å¹¶è¿”å›ç»“æœ</p>
<p>æ¥ä¸‹æ¥åˆ›å»º<code>LangChain</code>å·¥ä½œæµå¹¶ç»‘å®šå†…ç½®å·¥å…·</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">import</span> pandas <span class="hljs-keyword">as</span> pd  <span class="hljs-comment"># ç”¨äºæ•°æ®å¤„ç†å’Œåˆ†æçš„æ ¸å¿ƒåº“</span><br><span class="hljs-keyword">from</span> langchain_experimental.tools <span class="hljs-keyword">import</span> PythonAstREPLTool  <span class="hljs-comment"># LangChainçš„å®éªŒæ€§å·¥å…·ï¼Œå…è®¸å®‰å…¨æ‰§è¡ŒPythonä»£ç </span><br><span class="hljs-keyword">from</span> langchain.chat_models <span class="hljs-keyword">import</span> init_chat_model<br><span class="hljs-keyword">from</span> dotenv <span class="hljs-keyword">import</span> load_dotenv<br>load_dotenv(override=<span class="hljs-literal">True</span>)<br><br>model  = init_chat_model(model=<span class="hljs-string">&quot;deepseek-chat&quot;</span>, model_provider=<span class="hljs-string">&quot;deepseek&quot;</span>)<br><br>df = pd.read_csv(<span class="hljs-string">&#x27;WA_Fn-UseC_-Telco-Customer-Churn.csv&#x27;</span>)<br><br>tool = PythonAstREPLTool(<span class="hljs-built_in">locals</span>=&#123;<span class="hljs-string">&quot;df&quot;</span>: df&#125;)<br><br>llm_with_tools = model.bind_tools([tool])<br><br>response = llm_with_tools.invoke(<br>    <span class="hljs-string">&quot;æˆ‘æœ‰ä¸€å¼ è¡¨ï¼Œåä¸º&#x27;df&#x27;ï¼Œè¯·å¸®æˆ‘è®¡ç®—MonthlyChargeså­—æ®µçš„å‡å€¼ã€‚&quot;</span><br>)<br><span class="hljs-built_in">print</span>(response)<br></code></pre></td></tr></table></figure>

<p>é€šè¿‡è§‚å¯Ÿè¾“å‡ºï¼Œæ­¤æ—¶æˆ‘ä»¬å‘ç°ï¼Œ<code>LangChain</code>å›å¤çš„ç»“æœå°±ä¸å†æ˜¯ç®€å•çš„æ–‡å­—å†…å®¹ï¼Œè€Œæ˜¯ä¸€æ¡è°ƒç”¨å¤–éƒ¨å·¥å…·çš„æ¶ˆæ¯ã€‚æˆ‘ä»¬å¯ä»¥ä½¿ç”¨å¦‚ä¸‹æ–¹æ³•å°†è¿™æ¡æ¶ˆæ¯é‡Œé¢æ¶‰åŠåˆ°ä»£ç è¿è¡Œçš„æ ¸å¿ƒå‚æ•°æå–å‡ºæ¥ï¼š</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">import</span> pandas <span class="hljs-keyword">as</span> pd  <span class="hljs-comment"># ç”¨äºæ•°æ®å¤„ç†å’Œåˆ†æçš„æ ¸å¿ƒåº“</span><br><span class="hljs-keyword">from</span> langchain_experimental.tools <span class="hljs-keyword">import</span> PythonAstREPLTool  <span class="hljs-comment"># LangChainçš„å®éªŒæ€§å·¥å…·ï¼Œå…è®¸å®‰å…¨æ‰§è¡ŒPythonä»£ç </span><br><span class="hljs-keyword">from</span> langchain_core.output_parsers.openai_tools <span class="hljs-keyword">import</span> JsonOutputKeyToolsParser<br><span class="hljs-keyword">from</span> langchain.chat_models <span class="hljs-keyword">import</span> init_chat_model<br><span class="hljs-keyword">from</span> dotenv <span class="hljs-keyword">import</span> load_dotenv<br>load_dotenv(override=<span class="hljs-literal">True</span>)<br><br>model  = init_chat_model(model=<span class="hljs-string">&quot;deepseek-chat&quot;</span>, model_provider=<span class="hljs-string">&quot;deepseek&quot;</span>)<br><br>df = pd.read_csv(<span class="hljs-string">&#x27;WA_Fn-UseC_-Telco-Customer-Churn.csv&#x27;</span>)<br><br>tool = PythonAstREPLTool(<span class="hljs-built_in">locals</span>=&#123;<span class="hljs-string">&quot;df&quot;</span>: df&#125;)<br><br>parser = JsonOutputKeyToolsParser(key_name=tool.name, first_tool_only=<span class="hljs-literal">True</span>)<br><br>llm_with_tools = model.bind_tools([tool]) | parser<br><br>response = llm_with_tools.invoke(<br>    <span class="hljs-string">&quot;æˆ‘æœ‰ä¸€å¼ è¡¨ï¼Œåä¸º&#x27;df&#x27;ï¼Œè¯·å¸®æˆ‘è®¡ç®—MonthlyChargeså­—æ®µçš„å‡å€¼ã€‚&quot;</span><br>)<br><span class="hljs-built_in">print</span>(response)<br></code></pre></td></tr></table></figure>

<p>æ­¤æ—¶è¾“å‡ºï¼š</p>
<figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs text">&#123;&#x27;query&#x27;: &quot;df[&#x27;MonthlyCharges&#x27;].mean()&quot;&#125;<br></code></pre></td></tr></table></figure>

<p>æ¥ç€é€šè¿‡è®¾ç½®æç¤ºè¯æ¨¡æ¿ï¼Œå†åœ¨å½“å‰é“¾ä¸­åŠ å…¥ä¸€ä¸ª<code>tool</code>å¤–éƒ¨å‡½æ•°çš„ç¯èŠ‚ï¼Œå³å¯è®©å¤§æ¨¡å‹è¾“å‡ºçš„å‚æ•°ç›´æ¥å¸¦å…¥åˆ°<code>tool</code>ä¸­è¿›è¡Œè¿è¡Œ</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">import</span> pandas <span class="hljs-keyword">as</span> pd  <span class="hljs-comment"># ç”¨äºæ•°æ®å¤„ç†å’Œåˆ†æçš„æ ¸å¿ƒåº“</span><br><span class="hljs-keyword">from</span> langchain_core.prompts <span class="hljs-keyword">import</span> ChatPromptTemplate<br><span class="hljs-keyword">from</span> langchain_experimental.tools <span class="hljs-keyword">import</span> PythonAstREPLTool  <span class="hljs-comment"># LangChainçš„å®éªŒæ€§å·¥å…·ï¼Œå…è®¸å®‰å…¨æ‰§è¡ŒPythonä»£ç </span><br><span class="hljs-keyword">from</span> langchain_core.output_parsers.openai_tools <span class="hljs-keyword">import</span> JsonOutputKeyToolsParser<br><span class="hljs-keyword">from</span> langchain.chat_models <span class="hljs-keyword">import</span> init_chat_model<br><span class="hljs-keyword">from</span> dotenv <span class="hljs-keyword">import</span> load_dotenv<br>load_dotenv(override=<span class="hljs-literal">True</span>)<br><br>system = <span class="hljs-string">f&quot;&quot;&quot;</span><br><span class="hljs-string">ä½ å¯ä»¥è®¿é—®ä¸€ä¸ªåä¸º `df` çš„ pandas æ•°æ®æ¡†ï¼Œä½ å¯ä»¥ä½¿ç”¨df.head().to_markdown() æŸ¥çœ‹æ•°æ®é›†çš„åŸºæœ¬ä¿¡æ¯ï¼Œ \</span><br><span class="hljs-string">è¯·æ ¹æ®ç”¨æˆ·æå‡ºçš„é—®é¢˜ï¼Œç¼–å†™ Python ä»£ç æ¥å›ç­”ã€‚åªè¿”å›ä»£ç ï¼Œä¸è¿”å›å…¶ä»–å†…å®¹ã€‚åªå…è®¸ä½¿ç”¨ pandas å’Œå†…ç½®åº“ã€‚</span><br><span class="hljs-string">&quot;&quot;&quot;</span><br><br>prompt = ChatPromptTemplate([<br>    (<span class="hljs-string">&quot;system&quot;</span>, system),<br>    (<span class="hljs-string">&quot;user&quot;</span>, <span class="hljs-string">&quot;&#123;question&#125;&quot;</span>)<br>])<br><br>model  = init_chat_model(model=<span class="hljs-string">&quot;deepseek-chat&quot;</span>, model_provider=<span class="hljs-string">&quot;deepseek&quot;</span>)<br><br>df = pd.read_csv(<span class="hljs-string">&#x27;WA_Fn-UseC_-Telco-Customer-Churn.csv&#x27;</span>)<br><br>tool = PythonAstREPLTool(<span class="hljs-built_in">locals</span>=&#123;<span class="hljs-string">&quot;df&quot;</span>: df&#125;)<br><br>llm_with_tools = model.bind_tools([tool])<br><br>parser = JsonOutputKeyToolsParser(key_name=tool.name, first_tool_only=<span class="hljs-literal">True</span>)<br><br>chain = prompt | llm_with_tools | parser | tool<br><br><span class="hljs-built_in">print</span>(chain.invoke(&#123;<span class="hljs-string">&quot;question&quot;</span>: <span class="hljs-string">&quot;è¯·å¸®æˆ‘è®¡ç®—MonthlyChargeså­—æ®µçš„å‡å€¼ã€‚&quot;</span>&#125;))<br></code></pre></td></tr></table></figure>

<p>åŒæ—¶ï¼ŒæŒ‰ç…§æ­¤å‰ä»‹ç»çš„ï¼Œæˆ‘ä»¬è¿˜å¯ä»¥åœ¨é“¾æ¡ä¸­åŠ å…¥ä¸€ä¸ªæ‰“å°çš„ç¯èŠ‚ï¼Œè®©æ¨¡å‹å°†ç¼–å†™çš„<code>Python</code>ä»£ç è¿›è¡Œæ‰“å°ï¼š</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">import</span> pandas <span class="hljs-keyword">as</span> pd  <span class="hljs-comment"># ç”¨äºæ•°æ®å¤„ç†å’Œåˆ†æçš„æ ¸å¿ƒåº“</span><br><span class="hljs-keyword">from</span> langchain_core.prompts <span class="hljs-keyword">import</span> ChatPromptTemplate<br><span class="hljs-keyword">from</span> langchain_core.runnables <span class="hljs-keyword">import</span> RunnableLambda<br><span class="hljs-keyword">from</span> langchain_experimental.tools <span class="hljs-keyword">import</span> PythonAstREPLTool  <span class="hljs-comment"># LangChainçš„å®éªŒæ€§å·¥å…·ï¼Œå…è®¸å®‰å…¨æ‰§è¡ŒPythonä»£ç </span><br><span class="hljs-keyword">from</span> langchain_core.output_parsers.openai_tools <span class="hljs-keyword">import</span> JsonOutputKeyToolsParser<br><span class="hljs-keyword">from</span> langchain.chat_models <span class="hljs-keyword">import</span> init_chat_model<br><span class="hljs-keyword">from</span> dotenv <span class="hljs-keyword">import</span> load_dotenv<br>load_dotenv(override=<span class="hljs-literal">True</span>)<br><br>system = <span class="hljs-string">f&quot;&quot;&quot;</span><br><span class="hljs-string">ä½ å¯ä»¥è®¿é—®ä¸€ä¸ªåä¸º `df` çš„ pandas æ•°æ®æ¡†ï¼Œä½ å¯ä»¥ä½¿ç”¨df.head().to_markdown() æŸ¥çœ‹æ•°æ®é›†çš„åŸºæœ¬ä¿¡æ¯ï¼Œ \</span><br><span class="hljs-string">è¯·æ ¹æ®ç”¨æˆ·æå‡ºçš„é—®é¢˜ï¼Œç¼–å†™ Python ä»£ç æ¥å›ç­”ã€‚åªè¿”å›ä»£ç ï¼Œä¸è¿”å›å…¶ä»–å†…å®¹ã€‚åªå…è®¸ä½¿ç”¨ pandas å’Œå†…ç½®åº“ã€‚</span><br><span class="hljs-string">&quot;&quot;&quot;</span><br><br>prompt = ChatPromptTemplate([<br>    (<span class="hljs-string">&quot;system&quot;</span>, system),<br>    (<span class="hljs-string">&quot;user&quot;</span>, <span class="hljs-string">&quot;&#123;question&#125;&quot;</span>)<br>])<br><br>model  = init_chat_model(model=<span class="hljs-string">&quot;deepseek-chat&quot;</span>, model_provider=<span class="hljs-string">&quot;deepseek&quot;</span>)<br><br>df = pd.read_csv(<span class="hljs-string">&#x27;WA_Fn-UseC_-Telco-Customer-Churn.csv&#x27;</span>)<br><br>tool = PythonAstREPLTool(<span class="hljs-built_in">locals</span>=&#123;<span class="hljs-string">&quot;df&quot;</span>: df&#125;)<br><br>llm_with_tools = model.bind_tools([tool])<br><br>parser = JsonOutputKeyToolsParser(key_name=tool.name, first_tool_only=<span class="hljs-literal">True</span>)<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">code_print</span>(<span class="hljs-params">res</span>):<br>    <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;å³å°†è¿è¡ŒPythonä»£ç :&quot;</span>, res[<span class="hljs-string">&#x27;query&#x27;</span>])<br>    <span class="hljs-keyword">return</span> res<br><br>print_node = RunnableLambda(code_print)<br><br>chain = prompt | llm_with_tools | parser | print_node | tool<br><br><span class="hljs-built_in">print</span>(chain.invoke(&#123;<span class="hljs-string">&quot;question&quot;</span>: <span class="hljs-string">&quot;è¯·å¸®æˆ‘åˆ†ægenderã€SeniorCitizenå’ŒChurnä¸‰ä¸ªå­—æ®µä¹‹é—´çš„ç›¸å…³å…³ç³»ã€‚&quot;</span>&#125;))<br></code></pre></td></tr></table></figure>

<p>è‡³æ­¤ï¼Œä¸€ä¸ªç®€å•çš„åŒ…å«å®˜æ–¹<strong>å†…ç½®å·¥å…·</strong>çš„ä»£ç è§£é‡Šå™¨å·¥ä½œæµå°±æ­å»ºå®Œæˆäº†ã€‚</p>
<p>æ¥ä¸‹æ¥æ˜¯<strong>LangChainæ¥å…¥è‡ªå®šä¹‰å¤–éƒ¨å·¥ä½œæµç¨‹</strong></p>
<p>è¿™é‡Œæˆ‘ä»¬ä»¥å®æ—¶è·å–å¤©æ°”æ•°æ®ä¸ºä¾‹ï¼Œå°è¯•åˆ›å»ºä¸€ä¸ªå¤–éƒ¨å‡½æ•°ï¼Œå¹¶å°†å…¶å°è£…ä¸º<code>LangChian</code>çš„ä¸€é¡¹åŸºç¡€å·¥ä½œã€‚åœ¨<code>langChain</code>ä¸­ï¼Œå¦‚æœæƒ³è¦æŠŠä¸€ä¸ªæ™®é€šçš„å‡½æ•°ï¼Œå˜æˆä¸€ä¸ªå¯ä»¥è¢«å¤§æ¨¡å‹è°ƒç”¨çš„å·¥å…·ï¼Œåªéœ€è¦å°†å‡½æ•°åŒ…è£…æˆä¸€ä¸ª<code>Tool</code>å¯¹è±¡å³å¯ã€‚</p>
<p>è¿™é‡Œæˆ‘ä»¬é¦–å…ˆéœ€è¦è·å–<code>OpenWeather API Key</code>ï¼Œå¹¶å†™å…¥<code>.env</code>æ–‡ä»¶ä¸­ï¼Œæ–¹ä¾¿åç»­è¿›è¡Œå¤©æ°”æŸ¥è¯¢</p>
<p>æµè§ˆå™¨è®¿é—®<a target="_blank" rel="noopener" href="https://openweathermap.org/"><code>openweathermap</code>å®˜æ–¹ç½‘ç«™</a></p>
<p>æ¥ç€æ³¨å†Œå¹¶ç»‘å®šé‚®ç®±</p>
<p>æœ€åè¿›å…¥<a target="_blank" rel="noopener" href="https://openweathermap.org/"><code>openweathermap</code>å®˜æ–¹ç½‘ç«™</a>ï¼Œç‚¹å‡»ä½ çš„ç”¨æˆ·åï¼Œé€‰æ‹©â€œMy API keysâ€ï¼Œå³å¯è·å–<code>OpenWeather API Key</code></p>
<p>ç„¶åå…ˆå°è¯•åˆ›å»ºè¿™ä¸ªå¤–éƒ¨å‡½æ•°è¿›è¡Œæµ‹è¯•ï¼š</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">import</span> os<br><span class="hljs-keyword">import</span> requests,json<br><span class="hljs-keyword">from</span> dotenv <span class="hljs-keyword">import</span> load_dotenv<br>load_dotenv(override=<span class="hljs-literal">True</span>)<br><br>OPENWEATHER_API_KEY = os.getenv(<span class="hljs-string">&quot;OPENWEATHER_API_KEY&quot;</span>)<br><br><span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;Loaded API Key:&quot;</span>, OPENWEATHER_API_KEY)  <span class="hljs-comment"># æ£€æŸ¥æ˜¯å¦éNone</span><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">get_weather</span>(<span class="hljs-params">loc</span>):<br>    <span class="hljs-string">&quot;&quot;&quot;</span><br><span class="hljs-string">    æŸ¥è¯¢å³æ—¶å¤©æ°”å‡½æ•°</span><br><span class="hljs-string">    :param loc: å¿…è¦å‚æ•°ï¼Œå­—ç¬¦ä¸²ç±»å‹ï¼Œç”¨äºè¡¨ç¤ºæŸ¥è¯¢å¤©æ°”çš„å…·ä½“åŸå¸‚åç§°ï¼Œ\</span><br><span class="hljs-string">    æ³¨æ„ï¼Œä¸­å›½çš„åŸå¸‚éœ€è¦ç”¨å¯¹åº”åŸå¸‚çš„è‹±æ–‡åç§°ä»£æ›¿ï¼Œä¾‹å¦‚å¦‚æœéœ€è¦æŸ¥è¯¢åŒ—äº¬å¸‚å¤©æ°”ï¼Œåˆ™locå‚æ•°éœ€è¦è¾“å…¥&#x27;Beijing&#x27;ï¼›</span><br><span class="hljs-string">    :returnï¼šOpenWeather APIæŸ¥è¯¢å³æ—¶å¤©æ°”çš„ç»“æœï¼Œå…·ä½“URLè¯·æ±‚åœ°å€ä¸ºï¼šhttps://api.openweathermap.org/data/2.5/weather\</span><br><span class="hljs-string">    è¿”å›ç»“æœå¯¹è±¡ç±»å‹ä¸ºè§£æä¹‹åçš„JSONæ ¼å¼å¯¹è±¡ï¼Œå¹¶ç”¨å­—ç¬¦ä¸²å½¢å¼è¿›è¡Œè¡¨ç¤ºï¼Œå…¶ä¸­åŒ…å«äº†å…¨éƒ¨é‡è¦çš„å¤©æ°”ä¿¡æ¯</span><br><span class="hljs-string">    &quot;&quot;&quot;</span><br>    <span class="hljs-comment"># Step 1.æ„å»ºè¯·æ±‚</span><br>    url = <span class="hljs-string">&quot;https://api.openweathermap.org/data/2.5/weather&quot;</span><br><br>    <span class="hljs-comment"># Step 2.è®¾ç½®æŸ¥è¯¢å‚æ•°</span><br>    params = &#123;<br>        <span class="hljs-string">&quot;q&quot;</span>: loc,<br>        <span class="hljs-string">&quot;appid&quot;</span>: os.getenv(<span class="hljs-string">&quot;OPENWEATHER_API_KEY&quot;</span>),  <span class="hljs-comment"># è¾“å…¥API key</span><br>        <span class="hljs-string">&quot;units&quot;</span>: <span class="hljs-string">&quot;metric&quot;</span>,  <span class="hljs-comment"># ä½¿ç”¨æ‘„æ°åº¦è€Œä¸æ˜¯åæ°åº¦</span><br>        <span class="hljs-string">&quot;lang&quot;</span>: <span class="hljs-string">&quot;zh_cn&quot;</span>  <span class="hljs-comment"># è¾“å‡ºè¯­è¨€ä¸ºç®€ä½“ä¸­æ–‡</span><br>    &#125;<br><br>    <span class="hljs-comment"># Step 3.å‘é€GETè¯·æ±‚</span><br>    response = requests.get(url, params=params)<br><br>    <span class="hljs-comment"># Step 4.è§£æå“åº”</span><br>    data = response.json()<br>    <span class="hljs-keyword">return</span> json.dumps(data)<br><br><span class="hljs-built_in">print</span>(get_weather(<span class="hljs-string">&quot;Beijing&quot;</span>))<br></code></pre></td></tr></table></figure>

<p>æ³¨æ„ï¼šå¦‚æœè¿”å›<code>401</code>ï¼Œè¯·ä¸è¦æƒŠæ…Œï¼Œå› ä¸º<code>API Key</code>ä¼šè¿‡ä¸€ä¼šå„¿ç”Ÿæ•ˆï¼Œæ—¶é—´ä¸€èˆ¬åœ¨ä¸€å°æ—¶å†…</p>
<p>ç´§æ¥ç€å°†å…¶å°è£…ä¸º<code>LangChain</code>èƒ½å¤Ÿè¯†åˆ«çš„å¤–éƒ¨å‡½æ•°ï¼Œå¹¶ä¸”å¦‚æœæƒ³è®©å¤§æ¨¡å‹è°ƒç”¨æŸä¸€ä¸ªå¤–éƒ¨å·¥å…·ï¼Œéœ€è¦ä½¿ç”¨<code>bind_tools</code>æ–¹æ³•ï¼Œå°†å·¥å…·ç»‘å®šåˆ°æ¨¡å‹ä¸Šã€‚æ¥ä¸‹æ¥ï¼Œä¾¿å¯ä»¥é€šè¿‡æ–°çš„<code>llm_with_tools</code>æ¨¡å‹é€šè¿‡<code>invoke</code>æ–¹æ³•æ¥è°ƒç”¨æ¨¡å‹ã€‚è¿™ä¼šäº§ç”Ÿä¸€ä¸ªåŒ…å«<code>tool_calls</code> çš„æ¨¡å‹å“åº”ã€‚ä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">import</span> os<br><span class="hljs-keyword">import</span> requests,json<br><span class="hljs-keyword">from</span> langchain.chat_models <span class="hljs-keyword">import</span> init_chat_model<br><span class="hljs-keyword">from</span> langchain_core.tools <span class="hljs-keyword">import</span> tool<br><span class="hljs-keyword">from</span> dotenv <span class="hljs-keyword">import</span> load_dotenv<br>load_dotenv(override=<span class="hljs-literal">True</span>)<br><br><span class="hljs-comment"># åˆå§‹åŒ–æ¨¡å‹</span><br>model = init_chat_model(<span class="hljs-string">&quot;deepseek-chat&quot;</span>, model_provider=<span class="hljs-string">&quot;deepseek&quot;</span>)<br><br>OPENWEATHER_API_KEY = os.getenv(<span class="hljs-string">&quot;OPENWEATHER_API_KEY&quot;</span>)<br><br><span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;Loaded API Key:&quot;</span>, OPENWEATHER_API_KEY)  <span class="hljs-comment"># æ£€æŸ¥æ˜¯å¦éNone</span><br><br><span class="hljs-meta">@tool</span><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">get_weather</span>(<span class="hljs-params">loc</span>):<br>    <span class="hljs-string">&quot;&quot;&quot;</span><br><span class="hljs-string">    æŸ¥è¯¢å³æ—¶å¤©æ°”å‡½æ•°</span><br><span class="hljs-string">    :param loc: å¿…è¦å‚æ•°ï¼Œå­—ç¬¦ä¸²ç±»å‹ï¼Œç”¨äºè¡¨ç¤ºæŸ¥è¯¢å¤©æ°”çš„å…·ä½“åŸå¸‚åç§°ï¼Œ\</span><br><span class="hljs-string">    æ³¨æ„ï¼Œä¸­å›½çš„åŸå¸‚éœ€è¦ç”¨å¯¹åº”åŸå¸‚çš„è‹±æ–‡åç§°ä»£æ›¿ï¼Œä¾‹å¦‚å¦‚æœéœ€è¦æŸ¥è¯¢åŒ—äº¬å¸‚å¤©æ°”ï¼Œåˆ™locå‚æ•°éœ€è¦è¾“å…¥&#x27;Beijing&#x27;ï¼›</span><br><span class="hljs-string">    :returnï¼šOpenWeather APIæŸ¥è¯¢å³æ—¶å¤©æ°”çš„ç»“æœï¼Œå…·ä½“URLè¯·æ±‚åœ°å€ä¸ºï¼šhttps://api.openweathermap.org/data/2.5/weather\</span><br><span class="hljs-string">    è¿”å›ç»“æœå¯¹è±¡ç±»å‹ä¸ºè§£æä¹‹åçš„JSONæ ¼å¼å¯¹è±¡ï¼Œå¹¶ç”¨å­—ç¬¦ä¸²å½¢å¼è¿›è¡Œè¡¨ç¤ºï¼Œå…¶ä¸­åŒ…å«äº†å…¨éƒ¨é‡è¦çš„å¤©æ°”ä¿¡æ¯</span><br><span class="hljs-string">    &quot;&quot;&quot;</span><br>    <span class="hljs-comment"># Step 1.æ„å»ºè¯·æ±‚</span><br>    url = <span class="hljs-string">&quot;https://api.openweathermap.org/data/2.5/weather&quot;</span><br><br>    <span class="hljs-comment"># Step 2.è®¾ç½®æŸ¥è¯¢å‚æ•°</span><br>    params = &#123;<br>        <span class="hljs-string">&quot;q&quot;</span>: loc,<br>        <span class="hljs-string">&quot;appid&quot;</span>: os.getenv(<span class="hljs-string">&quot;OPENWEATHER_API_KEY&quot;</span>),  <span class="hljs-comment"># è¾“å…¥API key</span><br>        <span class="hljs-string">&quot;units&quot;</span>: <span class="hljs-string">&quot;metric&quot;</span>,  <span class="hljs-comment"># ä½¿ç”¨æ‘„æ°åº¦è€Œä¸æ˜¯åæ°åº¦</span><br>        <span class="hljs-string">&quot;lang&quot;</span>: <span class="hljs-string">&quot;zh_cn&quot;</span>  <span class="hljs-comment"># è¾“å‡ºè¯­è¨€ä¸ºç®€ä½“ä¸­æ–‡</span><br>    &#125;<br><br>    <span class="hljs-comment"># Step 3.å‘é€GETè¯·æ±‚</span><br>    response = requests.get(url, params=params)<br><br>    <span class="hljs-comment"># Step 4.è§£æå“åº”</span><br>    data = response.json()<br>    <span class="hljs-keyword">return</span> json.dumps(data)<br><br><span class="hljs-built_in">print</span>(get_weather.name)<br><span class="hljs-built_in">print</span>(get_weather.description)<br><span class="hljs-built_in">print</span>(get_weather.args)<br><br><span class="hljs-comment"># å®šä¹‰ å¤©æ°”æŸ¥è¯¢ å·¥å…·å‡½æ•°</span><br>tools = [get_weather]<br><br><span class="hljs-comment"># å°†å·¥å…·ç»‘å®šåˆ°æ¨¡å‹</span><br>llm_with_tools = model.bind_tools(tools)<br><br>response = llm_with_tools.invoke(<span class="hljs-string">&quot;ä½ å¥½ï¼Œ è¯·é—®åŒ—äº¬çš„å¤©æ°”æ€ä¹ˆæ ·ï¼Ÿ&quot;</span>)<br><br><span class="hljs-built_in">print</span>(response)<br><br><span class="hljs-built_in">print</span>(response.additional_kwargs)<br></code></pre></td></tr></table></figure>

<p>æˆ‘ä»¬ç»§ç»­è°ƒç”¨<code>JsonOutputKeyToolsParser</code>è¾“å‡ºè§£æå™¨æ¥å¤„ç†æ¨¡å‹å“åº”ã€‚å¹¶åŠ å…¥ä¸€ä¸ª<code>tool</code>å¤–éƒ¨å‡½æ•°çš„ç¯èŠ‚ï¼Œå³å¯è®©å¤§æ¨¡å‹è¾“å‡ºçš„å‚æ•°ç›´æ¥å¸¦å…¥åˆ°<code>tool</code>ä¸­è¿›è¡Œè¿è¡Œï¼Œå°±èƒ½é¡ºåˆ©çš„å°†ç”¨æˆ·çš„éœ€æ±‚è½¬åŒ–ä¸ºå¤©æ°”æŸ¥è¯¢ï¼Œå¹¶å®Œæˆå¤–éƒ¨å·¥å…·å®Œæˆè‡ªåŠ¨è¿è¡Œ</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">import</span> os<br><span class="hljs-keyword">import</span> requests,json<br><span class="hljs-keyword">from</span> langchain.chat_models <span class="hljs-keyword">import</span> init_chat_model<br><span class="hljs-keyword">from</span> langchain_core.tools <span class="hljs-keyword">import</span> tool<br><span class="hljs-keyword">from</span> langchain_core.output_parsers.openai_tools <span class="hljs-keyword">import</span> JsonOutputKeyToolsParser<br><span class="hljs-keyword">from</span> dotenv <span class="hljs-keyword">import</span> load_dotenv<br>load_dotenv(override=<span class="hljs-literal">True</span>)<br><br><span class="hljs-comment"># åˆå§‹åŒ–æ¨¡å‹</span><br>model = init_chat_model(<span class="hljs-string">&quot;deepseek-chat&quot;</span>, model_provider=<span class="hljs-string">&quot;deepseek&quot;</span>)<br><br>OPENWEATHER_API_KEY = os.getenv(<span class="hljs-string">&quot;OPENWEATHER_API_KEY&quot;</span>)<br><br><span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;Loaded API Key:&quot;</span>, OPENWEATHER_API_KEY)  <span class="hljs-comment"># æ£€æŸ¥æ˜¯å¦éNone</span><br><br><span class="hljs-meta">@tool</span><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">get_weather</span>(<span class="hljs-params">loc</span>):<br>    <span class="hljs-string">&quot;&quot;&quot;</span><br><span class="hljs-string">    æŸ¥è¯¢å³æ—¶å¤©æ°”å‡½æ•°</span><br><span class="hljs-string">    :param loc: å¿…è¦å‚æ•°ï¼Œå­—ç¬¦ä¸²ç±»å‹ï¼Œç”¨äºè¡¨ç¤ºæŸ¥è¯¢å¤©æ°”çš„å…·ä½“åŸå¸‚åç§°ï¼Œ\</span><br><span class="hljs-string">    æ³¨æ„ï¼Œä¸­å›½çš„åŸå¸‚éœ€è¦ç”¨å¯¹åº”åŸå¸‚çš„è‹±æ–‡åç§°ä»£æ›¿ï¼Œä¾‹å¦‚å¦‚æœéœ€è¦æŸ¥è¯¢åŒ—äº¬å¸‚å¤©æ°”ï¼Œåˆ™locå‚æ•°éœ€è¦è¾“å…¥&#x27;Beijing&#x27;ï¼›</span><br><span class="hljs-string">    :returnï¼šOpenWeather APIæŸ¥è¯¢å³æ—¶å¤©æ°”çš„ç»“æœï¼Œå…·ä½“URLè¯·æ±‚åœ°å€ä¸ºï¼šhttps://api.openweathermap.org/data/2.5/weather\</span><br><span class="hljs-string">    è¿”å›ç»“æœå¯¹è±¡ç±»å‹ä¸ºè§£æä¹‹åçš„JSONæ ¼å¼å¯¹è±¡ï¼Œå¹¶ç”¨å­—ç¬¦ä¸²å½¢å¼è¿›è¡Œè¡¨ç¤ºï¼Œå…¶ä¸­åŒ…å«äº†å…¨éƒ¨é‡è¦çš„å¤©æ°”ä¿¡æ¯</span><br><span class="hljs-string">    &quot;&quot;&quot;</span><br>    <span class="hljs-comment"># Step 1.æ„å»ºè¯·æ±‚</span><br>    url = <span class="hljs-string">&quot;https://api.openweathermap.org/data/2.5/weather&quot;</span><br><br>    <span class="hljs-comment"># Step 2.è®¾ç½®æŸ¥è¯¢å‚æ•°</span><br>    params = &#123;<br>        <span class="hljs-string">&quot;q&quot;</span>: loc,<br>        <span class="hljs-string">&quot;appid&quot;</span>: os.getenv(<span class="hljs-string">&quot;OPENWEATHER_API_KEY&quot;</span>),  <span class="hljs-comment"># è¾“å…¥API key</span><br>        <span class="hljs-string">&quot;units&quot;</span>: <span class="hljs-string">&quot;metric&quot;</span>,  <span class="hljs-comment"># ä½¿ç”¨æ‘„æ°åº¦è€Œä¸æ˜¯åæ°åº¦</span><br>        <span class="hljs-string">&quot;lang&quot;</span>: <span class="hljs-string">&quot;zh_cn&quot;</span>  <span class="hljs-comment"># è¾“å‡ºè¯­è¨€ä¸ºç®€ä½“ä¸­æ–‡</span><br>    &#125;<br><br>    <span class="hljs-comment"># Step 3.å‘é€GETè¯·æ±‚</span><br>    response = requests.get(url, params=params)<br><br>    <span class="hljs-comment"># Step 4.è§£æå“åº”</span><br>    data = response.json()<br>    <span class="hljs-keyword">return</span> json.dumps(data)<br><br><span class="hljs-built_in">print</span>(get_weather.name)<br><span class="hljs-built_in">print</span>(get_weather.description)<br><span class="hljs-built_in">print</span>(get_weather.args)<br><br><span class="hljs-comment"># å®šä¹‰ å¤©æ°”æŸ¥è¯¢ å·¥å…·å‡½æ•°</span><br>tools = [get_weather]<br><br><span class="hljs-comment"># å°†å·¥å…·ç»‘å®šåˆ°æ¨¡å‹</span><br>llm_with_tools = model.bind_tools(tools)<br><br>parser = JsonOutputKeyToolsParser(key_name=get_weather.name, first_tool_only=<span class="hljs-literal">True</span>)<br><br>llm_chain = llm_with_tools | parser<br><br>get_weather_chain = llm_with_tools | parser | get_weather<br><br>response = get_weather_chain.invoke(<span class="hljs-string">&quot;ä½ å¥½ï¼Œ è¯·é—®åŒ—äº¬çš„å¤©æ°”æ€ä¹ˆæ ·ï¼Ÿ&quot;</span>)<br><br><span class="hljs-built_in">print</span>(response)<br></code></pre></td></tr></table></figure>

<p>èƒ½å¤Ÿçœ‹åˆ°ï¼Œæ­¤æ—¶<code>Chain</code>å°±èƒ½é¡ºåˆ©çš„å°†ç”¨æˆ·çš„éœ€æ±‚è½¬åŒ–ä¸ºå¤©æ°”æŸ¥è¯¢ï¼Œå¹¶å®Œæˆå¤–éƒ¨å·¥å…·çš„è‡ªåŠ¨è¿è¡Œã€‚ä½†åªæœ‰è¿™ä¸€æ­¥è¿˜ä¸å¤Ÿï¼Œæˆ‘ä»¬è¿˜éœ€è¦å°†è°ƒç”¨å·¥å…·è¿”å›çš„ç»“æœè½¬åŒ–ä¸ºä¸€ä¸ªæ¨¡å‹çš„é—®ç­”ï¼š</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">import</span> os<br><span class="hljs-keyword">import</span> requests,json<br><span class="hljs-keyword">from</span> langchain.chat_models <span class="hljs-keyword">import</span> init_chat_model<br><span class="hljs-keyword">from</span> langchain_core.tools <span class="hljs-keyword">import</span> tool<br><span class="hljs-keyword">from</span> langchain_core.output_parsers.openai_tools <span class="hljs-keyword">import</span> JsonOutputKeyToolsParser<br><span class="hljs-keyword">from</span> langchain.prompts <span class="hljs-keyword">import</span> PromptTemplate<br><span class="hljs-keyword">from</span> langchain_core.output_parsers <span class="hljs-keyword">import</span> StrOutputParser<br><span class="hljs-keyword">from</span> langchain.prompts <span class="hljs-keyword">import</span> PromptTemplate<br><span class="hljs-keyword">from</span> langchain_core.output_parsers <span class="hljs-keyword">import</span> StrOutputParser<br><span class="hljs-keyword">from</span> dotenv <span class="hljs-keyword">import</span> load_dotenv<br>load_dotenv(override=<span class="hljs-literal">True</span>)<br><br><span class="hljs-comment"># åˆå§‹åŒ–æ¨¡å‹</span><br>model = init_chat_model(<span class="hljs-string">&quot;deepseek-chat&quot;</span>, model_provider=<span class="hljs-string">&quot;deepseek&quot;</span>)<br><br>OPENWEATHER_API_KEY = os.getenv(<span class="hljs-string">&quot;OPENWEATHER_API_KEY&quot;</span>)<br><br><span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;Loaded API Key:&quot;</span>, OPENWEATHER_API_KEY)  <span class="hljs-comment"># æ£€æŸ¥æ˜¯å¦éNone</span><br><br><span class="hljs-meta">@tool</span><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">get_weather</span>(<span class="hljs-params">loc</span>):<br>    <span class="hljs-string">&quot;&quot;&quot;</span><br><span class="hljs-string">    æŸ¥è¯¢å³æ—¶å¤©æ°”å‡½æ•°</span><br><span class="hljs-string">    :param loc: å¿…è¦å‚æ•°ï¼Œå­—ç¬¦ä¸²ç±»å‹ï¼Œç”¨äºè¡¨ç¤ºæŸ¥è¯¢å¤©æ°”çš„å…·ä½“åŸå¸‚åç§°ï¼Œ\</span><br><span class="hljs-string">    æ³¨æ„ï¼Œä¸­å›½çš„åŸå¸‚éœ€è¦ç”¨å¯¹åº”åŸå¸‚çš„è‹±æ–‡åç§°ä»£æ›¿ï¼Œä¾‹å¦‚å¦‚æœéœ€è¦æŸ¥è¯¢åŒ—äº¬å¸‚å¤©æ°”ï¼Œåˆ™locå‚æ•°éœ€è¦è¾“å…¥&#x27;Beijing&#x27;ï¼›</span><br><span class="hljs-string">    :returnï¼šOpenWeather APIæŸ¥è¯¢å³æ—¶å¤©æ°”çš„ç»“æœï¼Œå…·ä½“URLè¯·æ±‚åœ°å€ä¸ºï¼šhttps://api.openweathermap.org/data/2.5/weather\</span><br><span class="hljs-string">    è¿”å›ç»“æœå¯¹è±¡ç±»å‹ä¸ºè§£æä¹‹åçš„JSONæ ¼å¼å¯¹è±¡ï¼Œå¹¶ç”¨å­—ç¬¦ä¸²å½¢å¼è¿›è¡Œè¡¨ç¤ºï¼Œå…¶ä¸­åŒ…å«äº†å…¨éƒ¨é‡è¦çš„å¤©æ°”ä¿¡æ¯</span><br><span class="hljs-string">    &quot;&quot;&quot;</span><br>    <span class="hljs-comment"># Step 1.æ„å»ºè¯·æ±‚</span><br>    url = <span class="hljs-string">&quot;https://api.openweathermap.org/data/2.5/weather&quot;</span><br><br>    <span class="hljs-comment"># Step 2.è®¾ç½®æŸ¥è¯¢å‚æ•°</span><br>    params = &#123;<br>        <span class="hljs-string">&quot;q&quot;</span>: loc,<br>        <span class="hljs-string">&quot;appid&quot;</span>: os.getenv(<span class="hljs-string">&quot;OPENWEATHER_API_KEY&quot;</span>),  <span class="hljs-comment"># è¾“å…¥API key</span><br>        <span class="hljs-string">&quot;units&quot;</span>: <span class="hljs-string">&quot;metric&quot;</span>,  <span class="hljs-comment"># ä½¿ç”¨æ‘„æ°åº¦è€Œä¸æ˜¯åæ°åº¦</span><br>        <span class="hljs-string">&quot;lang&quot;</span>: <span class="hljs-string">&quot;zh_cn&quot;</span>  <span class="hljs-comment"># è¾“å‡ºè¯­è¨€ä¸ºç®€ä½“ä¸­æ–‡</span><br>    &#125;<br><br>    <span class="hljs-comment"># Step 3.å‘é€GETè¯·æ±‚</span><br>    response = requests.get(url, params=params)<br><br>    <span class="hljs-comment"># Step 4.è§£æå“åº”</span><br>    data = response.json()<br>    <span class="hljs-keyword">return</span> json.dumps(data)<br><br><span class="hljs-built_in">print</span>(get_weather.name)<br><span class="hljs-built_in">print</span>(get_weather.description)<br><span class="hljs-built_in">print</span>(get_weather.args)<br><br><span class="hljs-comment"># å®šä¹‰ å¤©æ°”æŸ¥è¯¢ å·¥å…·å‡½æ•°</span><br>tools = [get_weather]<br><br><span class="hljs-comment"># å°†å·¥å…·ç»‘å®šåˆ°æ¨¡å‹</span><br>llm_with_tools = model.bind_tools(tools)<br><br>parser = JsonOutputKeyToolsParser(key_name=get_weather.name, first_tool_only=<span class="hljs-literal">True</span>)<br><br>get_weather_chain = llm_with_tools | parser | get_weather<br><br><span class="hljs-comment"># Prompt æ¨¡æ¿</span><br>output_prompt = PromptTemplate.from_template(<br>    <span class="hljs-string">&quot;&quot;&quot;ä½ å°†æ”¶åˆ°ä¸€æ®µ JSON æ ¼å¼çš„å¤©æ°”æ•°æ®ï¼Œè¯·ç”¨ç®€æ´è‡ªç„¶çš„æ–¹å¼å°†å…¶è½¬è¿°ç»™ç”¨æˆ·ã€‚</span><br><span class="hljs-string">ä»¥ä¸‹æ˜¯å¤©æ°” JSON æ•°æ®ï¼š</span><br><span class="hljs-string"></span><br><span class="hljs-string">```json</span><br><span class="hljs-string">&#123;weather_json&#125;</span><br><span class="hljs-string">```</span><br><span class="hljs-string"></span><br><span class="hljs-string">è¯·å°†å…¶è½¬æ¢ä¸ºä¸­æ–‡å¤©æ°”æè¿°ï¼Œä¾‹å¦‚ï¼š</span><br><span class="hljs-string">â€œåŒ—äº¬å½“å‰å¤©æ°”æ™´ï¼Œæ°”æ¸©ä¸º 23Â°Cï¼Œæ¹¿åº¦ 58%ï¼Œé£é€Ÿ 2.1 ç±³/ç§’ã€‚â€</span><br><span class="hljs-string">åªè¿”å›ä¸€å¥è¯æè¿°ï¼Œä¸è¦å…¶ä»–è¯´æ˜æˆ–è§£é‡Šã€‚&quot;&quot;&quot;</span><br>)<br><br>output_chain = output_prompt | model | StrOutputParser()<br><br>full_chain = get_weather_chain | output_chain<br><br>response = full_chain.invoke(<span class="hljs-string">&quot;è¯·é—®åŒ—äº¬ä»Šå¤©çš„å¤©æ°”å¦‚ä½•ï¼Ÿ&quot;</span>)<br><br><span class="hljs-built_in">print</span>(response)<br></code></pre></td></tr></table></figure>

<p>æœ€ç»ˆï¼Œæˆ‘ä»¬å°†è¿™ä¸¤ä¸ªChainè¿›è¡Œæ‹¼æ¥ï¼Œå³æ„æˆå®Œæ•´çš„å¤–éƒ¨å·¥å…·è°ƒç”¨æµç¨‹ã€‚</p>
<p>æ¥ç€ï¼Œæˆ‘ä»¬æ¥äº†è§£ä¸€ä¸‹<strong>LangChainæ¥å…¥è‡ªå®šä¹‰å¤–éƒ¨å·¥ä½œæµç¨‹</strong></p>
<p>é¦–å…ˆè¦äº†è§£ä¸€ä¸‹ <code>Function calling</code> åŸºæœ¬åŸç†</p>
<p>æˆ‘ä»¬éƒ½çŸ¥é“ï¼Œèƒ½è°ƒç”¨å¤–éƒ¨å·¥å…·ï¼Œæ˜¯å¤§æ¨¡å‹è¿›åŒ–ä¸ºæ™ºèƒ½ä½“<code>Agent</code>çš„å…³é”®ï¼Œå¦‚æœä¸èƒ½ä½¿ç”¨å¤–éƒ¨å·¥å…·ï¼Œå¤§æ¨¡å‹å°±åªèƒ½æ˜¯ä¸ªç®€å•çš„èŠå¤©æœºå™¨äººï¼Œç”šè‡³è¿æŸ¥è¯¢å¤©æ°”éƒ½åšä¸åˆ°ã€‚ç”±äºåº•å±‚æŠ€æœ¯é™åˆ¶å•Šï¼Œå¤§æ¨¡å‹æœ¬èº«æ˜¯æ— æ³•å’Œå¤–éƒ¨å·¥å…·ç›´æ¥é€šä¿¡çš„ï¼Œå› æ­¤<code>Function calling</code>çš„æ€è·¯ï¼Œå°±æ˜¯åˆ›å»ºä¸€ä¸ªå¤–éƒ¨å‡½æ•°ï¼ˆ<code>function</code>ï¼‰ä½œä¸ºä¸­ä»‹ï¼Œä¸€è¾¹ä¼ é€’å¤§æ¨¡å‹çš„è¯·æ±‚ï¼Œå¦ä¸€è¾¹è°ƒç”¨å¤–éƒ¨å·¥å…·ï¼Œæœ€ç»ˆè®©å¤§æ¨¡å‹èƒ½å¤Ÿé—´æ¥çš„è°ƒç”¨å¤–éƒ¨å·¥å…·ã€‚</p>
<p class='item-img' data-src='/images/25.png'><img src="/images/25.png"></p>
<p>ä¾‹å¦‚ï¼Œå½“æˆ‘ä»¬è¦æŸ¥è¯¢å½“å‰å¤©æ°”æ—¶ï¼Œè®©å¤§æ¨¡å‹è°ƒç”¨å¤–éƒ¨å·¥å…·çš„<code>function calling</code>çš„è¿‡ç¨‹å°±å¦‚å›¾æ‰€ç¤ºï¼š</p>
<p class='item-img' data-src='/images/26.png'><img src="/images/26.png"></p>
<p>è€Œå®Œæ•´çš„ä¸€æ¬¡<code>Function calling</code>æ‰§è¡Œæµç¨‹å¦‚ä¸‹ï¼š</p>
<p class='item-img' data-src='/images/27.png'><img src="/images/27.png"></p>
<p><code>DeepSeek function calling</code> çš„ä¸‰ç§å“åº”æ¨¡å¼ï¼š</p>
<p class='item-img' data-src='/images/28.png'><img src="/images/28.png"></p>
<p>åœ¨å®é™…ä½¿ç”¨ä¸­ï¼Œæˆ‘ä»¬å…¶å®å¯ä»¥ç›´æ¥ä½¿ç”¨<code>create_tool_calling_agent</code>æ¥å¿«é€Ÿæ„å»ºå·¥å…·è°ƒç”¨ä»£ç†ã€‚å¹¶ä½¿ç”¨<code>AgentExecutor</code>æ¥æ‰§è¡Œä»£ç†ï¼Œä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">import</span> json<br><span class="hljs-keyword">import</span> os<br><span class="hljs-keyword">import</span> requests<br><span class="hljs-keyword">from</span> langchain.agents <span class="hljs-keyword">import</span> create_tool_calling_agent, tool, AgentExecutor<br><span class="hljs-keyword">from</span> langchain_core.prompts <span class="hljs-keyword">import</span> ChatPromptTemplate<br><span class="hljs-keyword">from</span> langchain.chat_models <span class="hljs-keyword">import</span> init_chat_model<br><span class="hljs-keyword">from</span> dotenv <span class="hljs-keyword">import</span> load_dotenv<br>load_dotenv(override=<span class="hljs-literal">True</span>)<br><br>OPENWEATHER_API_KEY = os.getenv(<span class="hljs-string">&quot;OPENWEATHER_API_KEY&quot;</span>)<br><br><span class="hljs-comment"># åˆå§‹åŒ–æ¨¡å‹</span><br>model = init_chat_model(<span class="hljs-string">&quot;deepseek-chat&quot;</span>, model_provider=<span class="hljs-string">&quot;deepseek&quot;</span>)<br><br><span class="hljs-meta">@tool</span><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">get_weather</span>(<span class="hljs-params">loc</span>):<br>    <span class="hljs-string">&quot;&quot;&quot;</span><br><span class="hljs-string">    æŸ¥è¯¢å³æ—¶å¤©æ°”å‡½æ•°</span><br><span class="hljs-string">    :param loc: å¿…è¦å‚æ•°ï¼Œå­—ç¬¦ä¸²ç±»å‹ï¼Œç”¨äºè¡¨ç¤ºæŸ¥è¯¢å¤©æ°”çš„å…·ä½“åŸå¸‚åç§°ï¼Œ\</span><br><span class="hljs-string">    æ³¨æ„ï¼Œä¸­å›½çš„åŸå¸‚éœ€è¦ç”¨å¯¹åº”åŸå¸‚çš„è‹±æ–‡åç§°ä»£æ›¿ï¼Œä¾‹å¦‚å¦‚æœéœ€è¦æŸ¥è¯¢åŒ—äº¬å¸‚å¤©æ°”ï¼Œåˆ™locå‚æ•°éœ€è¦è¾“å…¥&#x27;Beijing&#x27;ï¼›</span><br><span class="hljs-string">    :returnï¼šOpenWeather APIæŸ¥è¯¢å³æ—¶å¤©æ°”çš„ç»“æœï¼Œå…·ä½“URLè¯·æ±‚åœ°å€ä¸ºï¼šhttps://api.openweathermap.org/data/2.5/weather\</span><br><span class="hljs-string">    è¿”å›ç»“æœå¯¹è±¡ç±»å‹ä¸ºè§£æä¹‹åçš„JSONæ ¼å¼å¯¹è±¡ï¼Œå¹¶ç”¨å­—ç¬¦ä¸²å½¢å¼è¿›è¡Œè¡¨ç¤ºï¼Œå…¶ä¸­åŒ…å«äº†å…¨éƒ¨é‡è¦çš„å¤©æ°”ä¿¡æ¯</span><br><span class="hljs-string">    &quot;&quot;&quot;</span><br>    <span class="hljs-comment"># Step 1.æ„å»ºè¯·æ±‚</span><br>    url = <span class="hljs-string">&quot;https://api.openweathermap.org/data/2.5/weather&quot;</span><br><br>    <span class="hljs-comment"># Step 2.è®¾ç½®æŸ¥è¯¢å‚æ•°</span><br>    params = &#123;<br>        <span class="hljs-string">&quot;q&quot;</span>: loc,<br>        <span class="hljs-string">&quot;appid&quot;</span>: os.getenv(<span class="hljs-string">&quot;OPENWEATHER_API_KEY&quot;</span>),  <span class="hljs-comment"># è¾“å…¥API key</span><br>        <span class="hljs-string">&quot;units&quot;</span>: <span class="hljs-string">&quot;metric&quot;</span>,  <span class="hljs-comment"># ä½¿ç”¨æ‘„æ°åº¦è€Œä¸æ˜¯åæ°åº¦</span><br>        <span class="hljs-string">&quot;lang&quot;</span>: <span class="hljs-string">&quot;zh_cn&quot;</span>  <span class="hljs-comment"># è¾“å‡ºè¯­è¨€ä¸ºç®€ä½“ä¸­æ–‡</span><br>    &#125;<br><br>    <span class="hljs-comment"># Step 3.å‘é€GETè¯·æ±‚</span><br>    response = requests.get(url, params=params)<br><br>    <span class="hljs-comment"># Step 4.è§£æå“åº”</span><br>    data = response.json()<br>    <span class="hljs-keyword">return</span> json.dumps(data)<br><br><span class="hljs-comment">#å®šä¹‰å·¥å…·</span><br>tools = [get_weather]<br><br><span class="hljs-comment"># æ„å»ºæç¤ºæ¨¡ç‰ˆ</span><br>prompt = ChatPromptTemplate.from_messages(<br>    [<br>        (<span class="hljs-string">&quot;system&quot;</span>, <span class="hljs-string">&quot;ä½ æ˜¯å¤©æ°”åŠ©æ‰‹ï¼Œè¯·æ ¹æ®ç”¨æˆ·çš„é—®é¢˜ï¼Œç»™å‡ºç›¸åº”çš„å¤©æ°”ä¿¡æ¯&quot;</span>),<br>        (<span class="hljs-string">&quot;human&quot;</span>, <span class="hljs-string">&quot;&#123;input&#125;&quot;</span>),<br>        (<span class="hljs-string">&quot;placeholder&quot;</span>, <span class="hljs-string">&quot;&#123;agent_scratchpad&#125;&quot;</span>),<br>    ]<br>)<br><br><span class="hljs-comment"># ç›´æ¥ä½¿ç”¨`create_tool_calling_agent`åˆ›å»ºä»£ç†</span><br>agent = create_tool_calling_agent(model, tools, prompt)<br><br><span class="hljs-comment"># ä½¿ç”¨`AgentExecutor`æ¥æ‰§è¡Œä»£ç†</span><br>agent_executor = AgentExecutor(agent=agent, tools=tools, verbose=<span class="hljs-literal">True</span>)<br><br>response = agent_executor.invoke(&#123;<span class="hljs-string">&quot;input&quot;</span>: <span class="hljs-string">&quot;è¯·é—®ä»Šå¤©åŒ—äº¬çš„å¤©æ°”æ€ä¹ˆæ ·ï¼Ÿ&quot;</span>&#125;)<br><br><span class="hljs-built_in">print</span>(response)<br><br><span class="hljs-built_in">print</span>(response[<span class="hljs-string">&quot;output&quot;</span>])<br></code></pre></td></tr></table></figure>

<p><code>LangChain</code> ä¸­<code>Agents</code>æ¨¡å—çš„æ•´ä½“æ¶æ„è®¾è®¡ã€‚å¦‚ä¸‹æ‰€ç¤ºï¼š</p>
<p class='item-img' data-src='/images/29.png'><img src="/images/29.png"></p>
<p>åœ¨<code>Agents</code>çš„å†…éƒ¨ç»“æ„ã€‚æ¯ä¸ª<code>Agent</code>ç»„ä»¶ä¸€èˆ¬ä¼šç”±è¯­è¨€æ¨¡å‹ + æç¤º + è¾“å‡ºè§£æå™¨æ„æˆï¼Œå®ƒä¼šä½œä¸º<code>Agents</code>çš„å¤§è„‘å»å¤„ç†ç”¨æˆ·çš„è¾“å…¥ã€‚<code>Agent</code>èƒ½å¤Ÿå¤„ç†çš„è¾“å…¥ä¸»è¦æ¥æºäºä¸‰ä¸ªæ–¹é¢ï¼š<code>input</code>ä»£è¡¨ç”¨æˆ·çš„åŸå§‹è¾“å…¥ï¼Œ<code>Model Response</code>æŒ‡çš„æ˜¯æ¨¡å‹å¯¹æŸä¸€ä¸ªå­ä»»åŠ¡çš„å“åº”è¾“å‡ºï¼Œè€Œ<code>History</code>åˆ™èƒ½æºå¸¦ä¸Šä¸‹æ–‡çš„ä¿¡æ¯ã€‚å…¶è¾“å‡ºéƒ¨åˆ†ï¼Œåˆ™é“¾æ¥åˆ°å®é™…çš„å·¥å…·åº“ï¼Œéœ€è¦è°ƒç”¨å“ªäº›å·¥å…·ï¼Œå°†ç”±ç»è¿‡<code>Agent</code>æ¨¡å—åæ‹†åˆ†çš„å­ä»»åŠ¡æ¥å†³å®šã€‚</p>
<p>è€Œæˆ‘ä»¬çŸ¥é“ï¼Œå¤§æ¨¡å‹è°ƒç”¨å¤–éƒ¨å‡½æ•°ä¼šåˆ†ä¸ºä¸¤ä¸ªè¿‡ç¨‹ï¼šè¯†åˆ«å·¥å…·å’Œå®é™…æ‰§è¡Œã€‚åœ¨ <code>Message -&gt; Agent -&gt; Toolkits</code> è¿™ä¸ªæµç¨‹ä¸­ï¼Œè´Ÿè´£çš„æ˜¯å°†å­ä»»åŠ¡æ‹†è§£ï¼Œç„¶åæ ¹æ®è¿™äº›å­ä»»åŠ¡åœ¨å·¥å…·åº“ä¸­æ‰¾åˆ°ç›¸åº”çš„å·¥å…·ï¼Œæå–å·¥å…·åç§°åŠæ‰€éœ€å‚æ•°ï¼Œè¿™ä¸ªè¿‡ç¨‹å¯ä»¥è§†ä½œä¸€ç§â€œé™æ€â€çš„æ‰§è¡Œæµç¨‹ã€‚è€Œå°†è¿™äº›å†³ç­–è½¬åŒ–ä¸ºå®é™…è¡ŒåŠ¨çš„å·¥ä½œï¼Œåˆ™ä¼šäº¤ç»™<code>AgentExecutor</code>ã€‚</p>
<p>æ‰€ä»¥ç»¼ä¸Šéœ€è¦ç†è§£çš„æ˜¯ï¼šåœ¨<code>LangChain</code>çš„<code>Agents</code>å®é™…æ¶æ„ä¸­ï¼Œ<code>Agent</code>çš„è§’è‰²æ˜¯æ¥æ”¶è¾“å…¥å¹¶å†³å®šé‡‡å–çš„æ“ä½œï¼Œä½†å®ƒæœ¬èº«å¹¶ä¸ç›´æ¥æ‰§è¡Œè¿™äº›æ“ä½œã€‚è¿™ä¸€ä»»åŠ¡æ˜¯ç”±<code>AgentExecutor</code>æ¥å®Œæˆçš„ã€‚å°†<code>Agent</code>ï¼ˆå†³ç­–å¤§è„‘ï¼‰ä¸<code>AgentExecutor</code>ï¼ˆæ‰§è¡Œæ“ä½œçš„<code>Runtime</code>ï¼‰ç»“åˆä½¿ç”¨ï¼Œæ‰æ„æˆäº†å®Œæ•´çš„<code>Agents</code>ï¼ˆæ™ºèƒ½ä½“ï¼‰ï¼Œå…¶ä¸­<code>AgentExecutor</code>è´Ÿè´£è°ƒç”¨ä»£ç†å¹¶æ‰§è¡ŒæŒ‡å®šçš„å·¥å…·ï¼Œä»¥æ­¤æ¥å®ç°æ•´ä¸ªæ™ºèƒ½ä½“çš„åŠŸèƒ½ã€‚</p>
<p>è¿™ä¹Ÿå°±æ˜¯ä¸ºä»€ä¹ˆ<code>create_tool_calling_agent</code>éœ€è¦é€šè¿‡<code>AgentExecutor</code>æ‰èƒ½å¤Ÿå®é™…è¿è¡Œçš„åŸå› ã€‚å½“ç„¶ï¼Œåœ¨è¿™ç§æ¨¡å¼ä¸‹ï¼Œ**<code>AgentExecutor</code>çš„å†…éƒ¨å·²ç»è‡ªåŠ¨å¤„ç†å¥½äº†å…³äºæˆ‘ä»¬å·¥å…·è°ƒç”¨çš„æ‰€æœ‰é€»è¾‘ï¼Œå…¶ä¸­åŒ…å«ä¸²è¡Œå’Œå¹¶è¡Œå·¥å…·è°ƒç”¨çš„ä¸¤ç§å¸¸ç”¨æ¨¡å¼ã€‚**</p>
<p>åœ¨å¤§æ¨¡å‹ä¸­ï¼Œå¹¶è¡Œå·¥å…·è°ƒç”¨æŒ‡çš„æ˜¯åœ¨å¤§æ¨¡å‹è°ƒç”¨å¤–éƒ¨å·¥å…·æ—¶ï¼Œå¯ä»¥åœ¨å•æ¬¡äº¤äº’è¿‡ç¨‹ä¸­å¯ä»¥åŒæ—¶è°ƒç”¨å¤šä¸ªå·¥å…·ï¼Œå¹¶è¡Œæ‰§è¡Œä»¥è§£å†³ç”¨æˆ·çš„é—®é¢˜ã€‚å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š</p>
<p class='item-img' data-src='/images/30.png'><img src="/images/30.png"></p>
<p>è€Œåœ¨<code>create_tool_calling_agent</code>ä¸­ï¼Œå·²ç»è‡ªåŠ¨å¤„ç†äº†å¹¶è¡Œå·¥å…·è°ƒç”¨çš„å¤„ç†é€»è¾‘ï¼Œå¹¶ä¸éœ€è¦æˆ‘ä»¬åœ¨æ‰‹åŠ¨å¤„ç†ï¼Œæ¯”å¦‚æ¥ä¸‹æ¥æµ‹è¯•ä¸€äº›å¤æ‚çš„é—®é¢˜ï¼š</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">import</span> json<br><span class="hljs-keyword">import</span> os<br><span class="hljs-keyword">import</span> requests<br><span class="hljs-keyword">from</span> langchain.agents <span class="hljs-keyword">import</span> create_tool_calling_agent, tool, AgentExecutor<br><span class="hljs-keyword">from</span> langchain_core.prompts <span class="hljs-keyword">import</span> ChatPromptTemplate<br><span class="hljs-keyword">from</span> langchain.chat_models <span class="hljs-keyword">import</span> init_chat_model<br><span class="hljs-keyword">from</span> dotenv <span class="hljs-keyword">import</span> load_dotenv<br>load_dotenv(override=<span class="hljs-literal">True</span>)<br><br>OPENWEATHER_API_KEY = os.getenv(<span class="hljs-string">&quot;OPENWEATHER_API_KEY&quot;</span>)<br><br><span class="hljs-comment"># åˆå§‹åŒ–æ¨¡å‹</span><br>model = init_chat_model(<span class="hljs-string">&quot;deepseek-chat&quot;</span>, model_provider=<span class="hljs-string">&quot;deepseek&quot;</span>)<br><br><span class="hljs-meta">@tool</span><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">get_weather</span>(<span class="hljs-params">loc</span>):<br>    <span class="hljs-string">&quot;&quot;&quot;</span><br><span class="hljs-string">    æŸ¥è¯¢å³æ—¶å¤©æ°”å‡½æ•°</span><br><span class="hljs-string">    :param loc: å¿…è¦å‚æ•°ï¼Œå­—ç¬¦ä¸²ç±»å‹ï¼Œç”¨äºè¡¨ç¤ºæŸ¥è¯¢å¤©æ°”çš„å…·ä½“åŸå¸‚åç§°ï¼Œ\</span><br><span class="hljs-string">    æ³¨æ„ï¼Œä¸­å›½çš„åŸå¸‚éœ€è¦ç”¨å¯¹åº”åŸå¸‚çš„è‹±æ–‡åç§°ä»£æ›¿ï¼Œä¾‹å¦‚å¦‚æœéœ€è¦æŸ¥è¯¢åŒ—äº¬å¸‚å¤©æ°”ï¼Œåˆ™locå‚æ•°éœ€è¦è¾“å…¥&#x27;Beijing&#x27;ï¼›</span><br><span class="hljs-string">    :returnï¼šOpenWeather APIæŸ¥è¯¢å³æ—¶å¤©æ°”çš„ç»“æœï¼Œå…·ä½“URLè¯·æ±‚åœ°å€ä¸ºï¼šhttps://api.openweathermap.org/data/2.5/weather\</span><br><span class="hljs-string">    è¿”å›ç»“æœå¯¹è±¡ç±»å‹ä¸ºè§£æä¹‹åçš„JSONæ ¼å¼å¯¹è±¡ï¼Œå¹¶ç”¨å­—ç¬¦ä¸²å½¢å¼è¿›è¡Œè¡¨ç¤ºï¼Œå…¶ä¸­åŒ…å«äº†å…¨éƒ¨é‡è¦çš„å¤©æ°”ä¿¡æ¯</span><br><span class="hljs-string">    &quot;&quot;&quot;</span><br>    <span class="hljs-comment"># Step 1.æ„å»ºè¯·æ±‚</span><br>    url = <span class="hljs-string">&quot;https://api.openweathermap.org/data/2.5/weather&quot;</span><br><br>    <span class="hljs-comment"># Step 2.è®¾ç½®æŸ¥è¯¢å‚æ•°</span><br>    params = &#123;<br>        <span class="hljs-string">&quot;q&quot;</span>: loc,<br>        <span class="hljs-string">&quot;appid&quot;</span>: os.getenv(<span class="hljs-string">&quot;OPENWEATHER_API_KEY&quot;</span>),  <span class="hljs-comment"># è¾“å…¥API key</span><br>        <span class="hljs-string">&quot;units&quot;</span>: <span class="hljs-string">&quot;metric&quot;</span>,  <span class="hljs-comment"># ä½¿ç”¨æ‘„æ°åº¦è€Œä¸æ˜¯åæ°åº¦</span><br>        <span class="hljs-string">&quot;lang&quot;</span>: <span class="hljs-string">&quot;zh_cn&quot;</span>  <span class="hljs-comment"># è¾“å‡ºè¯­è¨€ä¸ºç®€ä½“ä¸­æ–‡</span><br>    &#125;<br><br>    <span class="hljs-comment"># Step 3.å‘é€GETè¯·æ±‚</span><br>    response = requests.get(url, params=params)<br><br>    <span class="hljs-comment"># Step 4.è§£æå“åº”</span><br>    data = response.json()<br>    <span class="hljs-keyword">return</span> json.dumps(data)<br><br><span class="hljs-comment">#å®šä¹‰å·¥å…·</span><br>tools = [get_weather]<br><br><span class="hljs-comment"># æ„å»ºæç¤ºæ¨¡ç‰ˆ</span><br>prompt = ChatPromptTemplate.from_messages(<br>    [<br>        (<span class="hljs-string">&quot;system&quot;</span>, <span class="hljs-string">&quot;ä½ æ˜¯å¤©æ°”åŠ©æ‰‹ï¼Œè¯·æ ¹æ®ç”¨æˆ·çš„é—®é¢˜ï¼Œç»™å‡ºç›¸åº”çš„å¤©æ°”ä¿¡æ¯&quot;</span>),<br>        (<span class="hljs-string">&quot;human&quot;</span>, <span class="hljs-string">&quot;&#123;input&#125;&quot;</span>),<br>        (<span class="hljs-string">&quot;placeholder&quot;</span>, <span class="hljs-string">&quot;&#123;agent_scratchpad&#125;&quot;</span>),<br>    ]<br>)<br><br><span class="hljs-comment"># ç›´æ¥ä½¿ç”¨`create_tool_calling_agent`åˆ›å»ºä»£ç†</span><br>agent = create_tool_calling_agent(model, tools, prompt)<br><br><span class="hljs-comment"># ä½¿ç”¨`AgentExecutor`æ¥æ‰§è¡Œä»£ç†</span><br>agent_executor = AgentExecutor(agent=agent, tools=tools, verbose=<span class="hljs-literal">True</span>)<br><br>response = agent_executor.invoke(&#123;<span class="hljs-string">&quot;input&quot;</span>: <span class="hljs-string">&quot;è¯·é—®ä»Šå¤©åŒ—äº¬å’Œæ­å·çš„å¤©æ°”æ€ä¹ˆæ ·ï¼Œå“ªä¸ªåŸå¸‚æ›´çƒ­ï¼Ÿ&quot;</span>&#125;)<br><br><span class="hljs-built_in">print</span>(response[<span class="hljs-string">&quot;output&quot;</span>])<br></code></pre></td></tr></table></figure>

<p>ä»è¿™ä¸ªè¿‡ç¨‹ä¸­å¯ä»¥æ˜æ˜¾çš„çœ‹å‡ºï¼Œä¸€æ¬¡æ€§å‘èµ·äº†åŒä¸€ä¸ªå¤–éƒ¨å‡½æ•°çš„ä¸¤æ¬¡è°ƒç”¨è¯·æ±‚ï¼Œå¹¶ä¾æ¬¡è·å¾—äº†åŒ—äº¬å’Œæ­å·ä¸¤ä¸ªåŸå¸‚çš„å¤©æ°”ã€‚è¿™å°±æ˜¯ä¸€æ¬¡æ ‡å‡†çš„<code>parallel_function_call</code>ã€‚</p>
<p class='item-img' data-src='/images/31.png'><img src="/images/31.png"></p>
<p>æ¥ä¸‹æ¥ç»§ç»­å°è¯•è¿›è¡Œå¤šå·¥å…·ä¸²è”è°ƒç”¨æµ‹è¯•ï¼š</p>
<p class='item-img' data-src='/images/32.png'><img src="/images/32.png"></p>
<p>æ­¤æ—¶æˆ‘ä»¬å†å®šä¹‰ä¸€ä¸ª<code>write_file</code>å‡½æ•°ï¼Œç”¨äºå°†â€œæ–‡æœ¬å†™å…¥æœ¬åœ°â€ï¼Œç„¶ååœ¨<code>tools</code>åˆ—è¡¨ä¸­ç›´æ¥æ·»åŠ <code>write_file</code>å·¥å…·ï¼Œå¹¶ä¿®æ”¹æç¤ºæ¨¡ç‰ˆï¼Œæ·»åŠ <code>write_file</code>å·¥å…·çš„ä½¿ç”¨åœºæ™¯ã€‚ä»£ç å¦‚ä¸‹æ‰€ç¤ºï¼š </p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">import</span> json<br><span class="hljs-keyword">import</span> os<br><span class="hljs-keyword">import</span> requests<br><span class="hljs-keyword">from</span> langchain.agents <span class="hljs-keyword">import</span> create_tool_calling_agent, tool, AgentExecutor<br><span class="hljs-keyword">from</span> langchain_core.prompts <span class="hljs-keyword">import</span> ChatPromptTemplate<br><span class="hljs-keyword">from</span> langchain.chat_models <span class="hljs-keyword">import</span> init_chat_model<br><span class="hljs-keyword">from</span> dotenv <span class="hljs-keyword">import</span> load_dotenv<br>load_dotenv(override=<span class="hljs-literal">True</span>)<br><br>OPENWEATHER_API_KEY = os.getenv(<span class="hljs-string">&quot;OPENWEATHER_API_KEY&quot;</span>)<br><br><span class="hljs-comment"># åˆå§‹åŒ–æ¨¡å‹</span><br>model = init_chat_model(<span class="hljs-string">&quot;deepseek-chat&quot;</span>, model_provider=<span class="hljs-string">&quot;deepseek&quot;</span>)<br><br><span class="hljs-meta">@tool</span><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">get_weather</span>(<span class="hljs-params">loc</span>):<br>    <span class="hljs-string">&quot;&quot;&quot;</span><br><span class="hljs-string">    æŸ¥è¯¢å³æ—¶å¤©æ°”å‡½æ•°</span><br><span class="hljs-string">    :param loc: å¿…è¦å‚æ•°ï¼Œå­—ç¬¦ä¸²ç±»å‹ï¼Œç”¨äºè¡¨ç¤ºæŸ¥è¯¢å¤©æ°”çš„å…·ä½“åŸå¸‚åç§°ï¼Œ\</span><br><span class="hljs-string">    æ³¨æ„ï¼Œä¸­å›½çš„åŸå¸‚éœ€è¦ç”¨å¯¹åº”åŸå¸‚çš„è‹±æ–‡åç§°ä»£æ›¿ï¼Œä¾‹å¦‚å¦‚æœéœ€è¦æŸ¥è¯¢åŒ—äº¬å¸‚å¤©æ°”ï¼Œåˆ™locå‚æ•°éœ€è¦è¾“å…¥&#x27;Beijing&#x27;ï¼›</span><br><span class="hljs-string">    :returnï¼šOpenWeather APIæŸ¥è¯¢å³æ—¶å¤©æ°”çš„ç»“æœï¼Œå…·ä½“URLè¯·æ±‚åœ°å€ä¸ºï¼šhttps://api.openweathermap.org/data/2.5/weather\</span><br><span class="hljs-string">    è¿”å›ç»“æœå¯¹è±¡ç±»å‹ä¸ºè§£æä¹‹åçš„JSONæ ¼å¼å¯¹è±¡ï¼Œå¹¶ç”¨å­—ç¬¦ä¸²å½¢å¼è¿›è¡Œè¡¨ç¤ºï¼Œå…¶ä¸­åŒ…å«äº†å…¨éƒ¨é‡è¦çš„å¤©æ°”ä¿¡æ¯</span><br><span class="hljs-string">    &quot;&quot;&quot;</span><br>    <span class="hljs-comment"># Step 1.æ„å»ºè¯·æ±‚</span><br>    url = <span class="hljs-string">&quot;https://api.openweathermap.org/data/2.5/weather&quot;</span><br><br>    <span class="hljs-comment"># Step 2.è®¾ç½®æŸ¥è¯¢å‚æ•°</span><br>    params = &#123;<br>        <span class="hljs-string">&quot;q&quot;</span>: loc,<br>        <span class="hljs-string">&quot;appid&quot;</span>: os.getenv(<span class="hljs-string">&quot;OPENWEATHER_API_KEY&quot;</span>),  <span class="hljs-comment"># è¾“å…¥API key</span><br>        <span class="hljs-string">&quot;units&quot;</span>: <span class="hljs-string">&quot;metric&quot;</span>,  <span class="hljs-comment"># ä½¿ç”¨æ‘„æ°åº¦è€Œä¸æ˜¯åæ°åº¦</span><br>        <span class="hljs-string">&quot;lang&quot;</span>: <span class="hljs-string">&quot;zh_cn&quot;</span>  <span class="hljs-comment"># è¾“å‡ºè¯­è¨€ä¸ºç®€ä½“ä¸­æ–‡</span><br>    &#125;<br><br>    <span class="hljs-comment"># Step 3.å‘é€GETè¯·æ±‚</span><br>    response = requests.get(url, params=params)<br><br>    <span class="hljs-comment"># Step 4.è§£æå“åº”</span><br>    data = response.json()<br>    <span class="hljs-keyword">return</span> json.dumps(data)<br><br><span class="hljs-meta">@tool</span><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">write_file</span>(<span class="hljs-params">content</span>):<br>    <span class="hljs-string">&quot;&quot;&quot;</span><br><span class="hljs-string">    å°†æŒ‡å®šå†…å®¹å†™å…¥æœ¬åœ°æ–‡ä»¶ã€‚</span><br><span class="hljs-string">    :param content: å¿…è¦å‚æ•°ï¼Œå­—ç¬¦ä¸²ç±»å‹ï¼Œç”¨äºè¡¨ç¤ºéœ€è¦å†™å…¥æ–‡æ¡£çš„å…·ä½“å†…å®¹ã€‚</span><br><span class="hljs-string">    :returnï¼šæ˜¯å¦æˆåŠŸå†™å…¥</span><br><span class="hljs-string">    &quot;&quot;&quot;</span><br>    <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;å·²æˆåŠŸå†™å…¥æœ¬åœ°æ–‡ä»¶ã€‚&quot;</span><br><br><span class="hljs-comment">#å®šä¹‰å·¥å…·</span><br>tools = [get_weather, write_file]<br><br><span class="hljs-comment"># æ„å»ºæç¤ºæ¨¡ç‰ˆ</span><br>prompt = ChatPromptTemplate.from_messages(<br>    [<br>        (<span class="hljs-string">&quot;system&quot;</span>, <span class="hljs-string">&quot;ä½ æ˜¯å¤©æ°”åŠ©æ‰‹ï¼Œè¯·æ ¹æ®ç”¨æˆ·çš„é—®é¢˜ï¼Œç»™å‡ºç›¸åº”çš„å¤©æ°”ä¿¡æ¯ï¼Œå¦‚æœç”¨æˆ·éœ€è¦å°†æŸ¥è¯¢ç»“æœå†™å…¥æ–‡ä»¶ï¼Œè¯·ä½¿ç”¨write_fileå·¥å…·&quot;</span>),<br>        (<span class="hljs-string">&quot;human&quot;</span>, <span class="hljs-string">&quot;&#123;input&#125;&quot;</span>),<br>        (<span class="hljs-string">&quot;placeholder&quot;</span>, <span class="hljs-string">&quot;&#123;agent_scratchpad&#125;&quot;</span>),<br>    ]<br>)<br><br><span class="hljs-comment"># ç›´æ¥ä½¿ç”¨`create_tool_calling_agent`åˆ›å»ºä»£ç†</span><br>agent = create_tool_calling_agent(model, tools, prompt)<br><br><span class="hljs-comment"># ä½¿ç”¨`AgentExecutor`æ¥æ‰§è¡Œä»£ç†</span><br>agent_executor = AgentExecutor(agent=agent, tools=tools, verbose=<span class="hljs-literal">True</span>)<br><br>response = agent_executor.invoke(&#123;<span class="hljs-string">&quot;input&quot;</span>: <span class="hljs-string">&quot;æŸ¥ä¸€ä¸‹åŒ—äº¬å’Œæ­å·ç°åœ¨çš„æ¸©åº¦ï¼Œå¹¶å°†ç»“æœå†™å…¥æœ¬åœ°çš„æ–‡ä»¶ä¸­ã€‚&quot;</span>&#125;)<br><br><span class="hljs-built_in">print</span>(response[<span class="hljs-string">&quot;output&quot;</span>])<br></code></pre></td></tr></table></figure>

<p>é€šè¿‡ä¸­é—´è¿‡ç¨‹ä¿¡æ¯çš„æ‰“å°ï¼Œæˆ‘ä»¬èƒ½å¤Ÿçœ‹åˆ°åœ¨ä¸€æ¬¡äº¤äº’è¿‡ç¨‹ä¸­ä¾æ¬¡è°ƒç”¨çš„<code>get_weather</code>æŸ¥è¯¢åˆ°åŒ—äº¬å’Œæ­å·çš„å¤©æ°”ï¼Œç„¶ååˆå°†ç»“æœå†™å…¥åˆ°æœ¬åœ°çš„æ–‡ä»¶ä¸­ã€‚è¿™å°±æ˜¯ä¸€ä¸ªéå¸¸å…¸å‹çš„ä¸²è¡Œå·¥å…·è°ƒç”¨çš„æµç¨‹ï¼Œå¦‚ä¸‹å›¾æ‰€ç¤ºï¼š</p>
<p class='item-img' data-src='/images/33.png'><img src="/images/33.png"></p>
<h1 id="äº”ã€LangChain-Agentè¿›é˜¶åŠŸèƒ½ä»‹ç»"><a href="#äº”ã€LangChain-Agentè¿›é˜¶åŠŸèƒ½ä»‹ç»" class="headerlink" title="äº”ã€LangChain Agentè¿›é˜¶åŠŸèƒ½ä»‹ç»"></a>äº”ã€<strong>LangChain Agentè¿›é˜¶åŠŸèƒ½ä»‹ç»</strong></h1><p><strong>å€ŸåŠ©<code>LangChain Agent</code>+å†…ç½®å·¥å…·å¿«é€Ÿæ­å»ºæ™ºèƒ½ä½“</strong></p>
<p>æ—¢ç„¶<code>LangChain Agent</code>èƒ½æ›´åŠ çµæ´»è°ƒç”¨å¤–éƒ¨å·¥å…·ï¼Œ<code>LangChain Agent+LangChain</code>å†…ç½®å·¥å…·ä¹Ÿèƒ½æ›´åŠ å¿«é€Ÿçš„å®Œæˆå¤æ‚<code>Agent</code>å¼€å‘ã€‚</p>
<p><a target="_blank" rel="noopener" href="https://python.langchain.com/docs/integrations/tools/"><strong><code>LangChain</code> ç¬¬ä¸‰æ–¹å·¥å…·é›†æˆ</strong></a></p>
<p>ä¸‹é¢é€‰æ‹©ä»¥<a target="_blank" rel="noopener" href="https://python.langchain.com/docs/integrations/tools/tavily_search/"><strong><code>LangChain</code> çš„ <code>Tavily Search</code> å·¥å…·</strong></a>ä¸ºä¾‹è¿›è¡Œè®²è§£</p>
<p>å¯ä»¥é€šè¿‡è®¿é—®<a target="_blank" rel="noopener" href="https://app.tavily.com/sign-in">æ­¤ç«™ç‚¹</a>åˆ›å»ºä¸€ä¸ªå¸æˆ·æ¥è·å–<code>LangChain</code> çš„ <code>Tavily Search</code> å·¥å…·çš„ <code>API </code>å¯†é’¥ï¼Œå¹¶å°†å…¶åŠ åˆ°<code>.env</code>æ–‡ä»¶ä¸­</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs python">TAVILY_API_KEY=tvly-xxx<br></code></pre></td></tr></table></figure>

<p><code>langchain-tavily</code>é›†æˆå­˜åœ¨äºåŒ…ä¸­</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs python">pip install -U langchain-tavily<br></code></pre></td></tr></table></figure>

<p>å…ˆç¼–å†™ä¸€ä¸ªç®€å•çš„ç¨‹åºéªŒè¯è¯¥å·¥å…·èƒ½æ­£å¸¸è¿è¡Œ</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">import</span> os<br><span class="hljs-keyword">from</span> langchain_tavily <span class="hljs-keyword">import</span> TavilySearch<br><span class="hljs-keyword">from</span> dotenv <span class="hljs-keyword">import</span> load_dotenv<br>load_dotenv(override=<span class="hljs-literal">True</span>)<br><br><span class="hljs-comment"># åˆå§‹åŒ– Tavily æœç´¢å·¥å…·</span><br>search = TavilySearch(max_results=<span class="hljs-number">2</span>)<br><br><span class="hljs-comment"># æ‰§è¡Œæœç´¢</span><br>result = search.invoke(<span class="hljs-string">&quot;è‹¹æœ2025WWDCå‘å¸ƒä¼š&quot;</span>)<br><span class="hljs-built_in">print</span>(result)<br></code></pre></td></tr></table></figure>

<p>å†ä½¿ç”¨<code>LangChain Agent</code>é…åˆ<code>LangChain</code>å†…ç½®çš„<code>Tavily Search</code>å·¥å…·å¿«é€Ÿåœ°å®Œæˆå¤æ‚<code>Agent</code>å¼€å‘</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">import</span> os<br><span class="hljs-keyword">from</span> langchain_tavily <span class="hljs-keyword">import</span> TavilySearch<br><span class="hljs-keyword">from</span> langchain.agents <span class="hljs-keyword">import</span> AgentExecutor, create_tool_calling_agent, tool<br><span class="hljs-keyword">from</span> langchain_core.prompts <span class="hljs-keyword">import</span> ChatPromptTemplate<br><span class="hljs-keyword">from</span> langchain.chat_models <span class="hljs-keyword">import</span> init_chat_model<br><span class="hljs-keyword">from</span> dotenv <span class="hljs-keyword">import</span> load_dotenv<br>load_dotenv(override=<span class="hljs-literal">True</span>)<br><br><span class="hljs-comment"># åˆå§‹åŒ– Tavily æœç´¢å·¥å…·</span><br>search = TavilySearch(max_results=<span class="hljs-number">2</span>)<br><br>tools = [search]<br><br>prompt = ChatPromptTemplate.from_messages(<br>    [<br>        (<span class="hljs-string">&quot;system&quot;</span>, <span class="hljs-string">&quot;ä½ æ˜¯ä¸€ååŠ©äººä¸ºä¹çš„åŠ©æ‰‹ï¼Œå¹¶ä¸”å¯ä»¥è°ƒç”¨å·¥å…·è¿›è¡Œç½‘ç»œæœç´¢ï¼Œè·å–å®æ—¶ä¿¡æ¯ã€‚&quot;</span>),<br>        (<span class="hljs-string">&quot;human&quot;</span>, <span class="hljs-string">&quot;&#123;input&#125;&quot;</span>),<br>        (<span class="hljs-string">&quot;placeholder&quot;</span>, <span class="hljs-string">&quot;&#123;agent_scratchpad&#125;&quot;</span>),<br>    ]<br>)<br><br><span class="hljs-comment"># åˆå§‹åŒ–æ¨¡å‹</span><br>model = init_chat_model(<span class="hljs-string">&quot;deepseek-chat&quot;</span>, model_provider=<span class="hljs-string">&quot;deepseek&quot;</span>)<br><br>agent = create_tool_calling_agent(model, tools, prompt)<br><br>agent_executor = AgentExecutor(agent=agent, tools=tools, verbose=<span class="hljs-literal">True</span>)<br><br>result = agent_executor.invoke(&#123;<span class="hljs-string">&quot;input&quot;</span>: <span class="hljs-string">&quot;è¯·é—®è‹¹æœ2025WWDCå‘å¸ƒä¼šå¬å¼€çš„æ—¶é—´æ˜¯ï¼Ÿ&quot;</span>&#125;)<br><br><span class="hljs-built_in">print</span>(result[<span class="hljs-string">&#x27;output&#x27;</span>])<br></code></pre></td></tr></table></figure>

<p>æ¥ç€æˆ‘ä»¬æ¥å®Œæˆ<strong>å¤šæ™ºèƒ½ä½“åä½œå®ç°æµè§ˆå™¨è‡ªåŠ¨åŒ–</strong></p>
<p>æ­£å¦‚ä¸Šè¿°æˆ‘ä»¬ä½¿ç”¨çš„<code>create_tool_calling_agent</code>æ–¹æ³•ï¼Œå®ƒå…¶å®åœ¨<code>langChain</code>ä¸­æ˜¯ä¸€ä¸ªé€šç”¨çš„ç”¨æ¥æ„å»ºå·¥å…·ä»£ç†çš„æ–¹æ³•ï¼Œé™¤æ­¤ä»¥å¤–ï¼Œ<code>langChain</code>è¿˜å°è£…äº†éå¸¸å¤šç§ä¸åŒçš„<code>Agent</code>å®ç°å½¢å¼</p>
<p>ä¸‹é¢æ˜¯æ¨èçš„<code>Agent</code>åˆ›å»ºå‡½æ•°ï¼š</p>
<table>
<thead>
<tr>
<th align="center">å‡½æ•°å</th>
<th align="center">åŠŸèƒ½æè¿°</th>
<th align="center">é€‚ç”¨åœºæ™¯</th>
</tr>
</thead>
<tbody><tr>
<td align="center"><strong>create_tool_calling_agent</strong></td>
<td align="center">åˆ›å»ºä½¿ç”¨å·¥å…·çš„Agent</td>
<td align="center">é€šç”¨å·¥å…·è°ƒç”¨</td>
</tr>
<tr>
<td align="center"><strong>create_openai_tools_agent</strong></td>
<td align="center">åˆ›å»ºOpenAIå·¥å…·Agent</td>
<td align="center">OpenAIæ¨¡å‹ä¸“ç”¨</td>
</tr>
<tr>
<td align="center"><strong>create_openai_functions_agent</strong></td>
<td align="center">åˆ›å»ºOpenAIå‡½æ•°Agent</td>
<td align="center">OpenAIå‡½æ•°è°ƒç”¨</td>
</tr>
<tr>
<td align="center"><strong>create_react_agent</strong></td>
<td align="center">åˆ›å»ºReActæ¨ç†Agent</td>
<td align="center">æ¨ç†+è¡ŒåŠ¨æ¨¡å¼</td>
</tr>
<tr>
<td align="center"><strong>create_structured_chat_agent</strong></td>
<td align="center">åˆ›å»ºç»“æ„åŒ–èŠå¤©Agent</td>
<td align="center">å¤šè¾“å…¥å·¥å…·æ”¯æŒ</td>
</tr>
<tr>
<td align="center"><strong>create_conversational_retrieval_agent</strong></td>
<td align="center">åˆ›å»ºå¯¹è¯æ£€ç´¢Agent</td>
<td align="center">æ£€ç´¢å¢å¼ºå¯¹è¯</td>
</tr>
<tr>
<td align="center"><strong>create_json_chat_agent</strong></td>
<td align="center">åˆ›å»ºJSONèŠå¤©Agent</td>
<td align="center">JSONæ ¼å¼äº¤äº’</td>
</tr>
<tr>
<td align="center"><strong>create_xml_agent</strong></td>
<td align="center">åˆ›å»ºXMLæ ¼å¼Agent</td>
<td align="center">XMLé€»è¾‘æ ¼å¼</td>
</tr>
<tr>
<td align="center"><strong>create_self_ask_with_search_agent</strong></td>
<td align="center">åˆ›å»ºè‡ªé—®è‡ªç­”æœç´¢Agent</td>
<td align="center">è‡ªä¸»æœç´¢æ¨ç†</td>
</tr>
</tbody></table>
<p>å…¶ä¸­æ¯”è¾ƒé€šç”¨åœºæ™¯çš„å°±æ˜¯æˆ‘ä»¬åˆšåˆšä½¿ç”¨çš„<code>create_tool_calling_agent</code>ï¼Œè€Œå¯¹äºä¸€äº›ç¬¦åˆ<code>OpenAI API RESTFUL API</code>çš„æ¨¡å‹ï¼Œåˆ™åŒæ ·å¯ä»¥ä½¿ç”¨<code>create_openai_tools_agent</code>ï¼Œå¦å¤–åƒ<code>create_react_agent</code>å¯ä»¥ç”¨äºä¸€äº›æ¨ç†ä»»åŠ¡ï¼Œ<code>create_conversational_retrieval_agent</code>åˆ™å¯ä»¥ç”¨äºä¸€äº›å¯¹è¯ç³»ç»Ÿï¼Œå…·ä½“è¿˜æ˜¯éœ€è¦æ ¹æ®å®é™…éœ€æ±‚æ¥é€‰æ‹©ã€‚</p>
<p>ç›®å‰æ¥è¯´ï¼Œåœ¨å¤§æ¨¡å‹åº”ç”¨å¼€å‘é¢†åŸŸæœ‰éå¸¸å¤šçš„éœ€æ±‚åœºæ™¯ï¼Œå…¶ä¸­ä¸€ä¸ªæ¯”è¾ƒçƒ­é—¨çš„å°±æ˜¯æµè§ˆå™¨è‡ªåŠ¨åŒ–ï¼Œé€šè¿‡è‡ªåŠ¨åŒ–æå–ç½‘é¡µå†…å®¹ï¼Œç„¶åè¿›è¡Œåˆ†æï¼Œæœ€åç”ŸæˆæŠ¥å‘Šã€‚è¿™æ ·çš„æµç¨‹æå‡æ•ˆç‡å’Œæ”¶é›†ä¿¡æ¯çš„æœ‰æ•ˆé€”å¾„ã€‚å› æ­¤æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬å°±å°è¯•ä½¿ç”¨å°è¯•ä½¿ç”¨<code>create_openai_tools_agent</code>æ¥å®é™…å¼€å‘ä¸€ä¸ªæµè§ˆå™¨è‡ªåŠ¨åŒ–ä»£ç†ã€‚</p>
<p>é¦–å…ˆï¼Œæ‰§è¡Œæµè§ˆå™¨è‡ªåŠ¨åŒ–ä»£ç†éœ€è¦å®‰è£…ä¸€ç³»åˆ—çš„ç¬¬ä¸‰æ–¹ä¾èµ–åŒ…ï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">pip install playwright lxml langchain_community beautifulsoup4 reportlab<br></code></pre></td></tr></table></figure>

<p>æ­¤å¤–ï¼Œè¿˜éœ€è¦å®‰è£… <code>Playwright</code> æµè§ˆå™¨ï¼Œéœ€è¦åœ¨å½“å‰è™šæ‹Ÿç¯å¢ƒä¸­æ‰§è¡Œå¦‚ä¸‹å‘½ä»¤ï¼š</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">playwright install<br></code></pre></td></tr></table></figure>

<p>è¿™ä¸ªå®‰è£…è¿‡ç¨‹å®ƒä¼šä¸‹è½½å¹¶å®‰è£… <code>Playwright</code> æ”¯æŒçš„æµè§ˆå™¨å†…æ ¸ï¼ˆæ³¨æ„ï¼šè¿™é‡Œä¸æ˜¯ç”¨æˆ‘ä»¬æœ¬æœºå·²æœ‰çš„æµè§ˆå™¨ï¼‰ï¼ŒåŒ…æ‹¬<code>Chromium</code>ï¼ˆç±»ä¼¼ Chromeï¼‰ã€<code>Firefox</code>ã€<code>WebKit</code>ï¼ˆç±»ä¼¼ <code>Safari</code>ï¼‰ï¼Œå¹¶å°†è¿™äº›æµè§ˆå™¨ä¸‹è½½åˆ°æœ¬åœ°çš„ <code>.cache/ms-playwright</code> ç›®å½•æˆ–é¡¹ç›®çš„ <code>~/.playwright</code> ç›®å½•ä¸­ï¼Œä»¥ä¾¿ <code>Playwright</code> ä½¿ç”¨ç¨³å®šä¸€è‡´çš„è¿è¡Œç¯å¢ƒã€‚</p>
<p>è¿™ä¸ªæ¡ˆä¾‹çš„æ ¸å¿ƒä»£ç é¦–å…ˆæ˜¯éœ€è¦ç”¨ä»£ç†å·¥å…·åˆå§‹åŒ–åŒæ­¥ <code>Playwright</code> æµè§ˆå™¨ï¼š</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs python">sync_browser = create_sync_playwright_browser()<br><br>toolkit = PlayWrightBrowserToolkit.from_browser(sync_browser=sync_browser)<br><br>tools = toolkit.get_tools()<br></code></pre></td></tr></table></figure>

<p>ç„¶åå†é€šè¿‡<code>create_openai_tools_agent</code>æ¥æ”¶åˆå§‹åŒ–çš„å¤§æ¨¡å‹å’Œ<code>Playwright</code>å·¥å…·æ„å»ºå…±åŒæ„å»º<code>OpenAI Tools</code> ä»£ç†ï¼Œæœ€åé€šè¿‡<code>AgentExecutor</code>æ‰§è¡Œä»£ç†ã€‚</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-comment"># é€šè¿‡ LangChain åˆ›å»º OpenAI å·¥å…·ä»£ç†</span><br>agent = create_openai_tools_agent(model, tools, prompt)<br><br><span class="hljs-comment"># é€šè¿‡ AgentExecutor æ‰§è¡Œä»£ç†</span><br>agent_executor = AgentExecutor(agent=agent, tools=tools, verbose=<span class="hljs-literal">True</span>)<br></code></pre></td></tr></table></figure>

<p>å®Œæ•´çš„ä»£ç å› ä¸º<code>langChian</code>çš„æ¨¡å—åŒ–å°è£…éå¸¸ç®€æ´ï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> langchain_community.agent_toolkits <span class="hljs-keyword">import</span> PlayWrightBrowserToolkit<br><span class="hljs-keyword">from</span> langchain_community.tools.playwright.utils <span class="hljs-keyword">import</span> create_sync_playwright_browser<br><span class="hljs-keyword">from</span> langchain <span class="hljs-keyword">import</span> hub<br><span class="hljs-keyword">from</span> langchain.agents <span class="hljs-keyword">import</span> AgentExecutor, create_openai_tools_agent<br><span class="hljs-keyword">from</span> langchain.chat_models <span class="hljs-keyword">import</span> init_chat_model<br><span class="hljs-keyword">import</span> os<br><span class="hljs-keyword">from</span> dotenv <span class="hljs-keyword">import</span> load_dotenv<br>load_dotenv(override=<span class="hljs-literal">True</span>)<br><br>DeepSeek_API_KEY = os.getenv(<span class="hljs-string">&quot;DEEPSEEK_API_KEY&quot;</span>)<br><span class="hljs-comment"># print(DeepSeek_API_KEY)  # å¯ä»¥é€šè¿‡æ‰“å°æŸ¥çœ‹</span><br><br><span class="hljs-comment"># åˆå§‹åŒ– Playwright æµè§ˆå™¨ï¼š</span><br>sync_browser = create_sync_playwright_browser()<br>toolkit = PlayWrightBrowserToolkit.from_browser(sync_browser=sync_browser)<br>tools = toolkit.get_tools()<br><br><span class="hljs-comment"># é€šè¿‡ LangChain Hub æ‹‰å–æç¤ºè¯æ¨¡ç‰ˆ</span><br><span class="hljs-comment"># https://smith.langchain.com/hub</span><br><span class="hljs-comment"># è¿™æ˜¯ LangChain ä¸­ä» LangChain Hub åŠ è½½é¢„å®šä¹‰æç¤ºè¯æ¨¡æ¿ï¼ˆprompt templateï¼‰çš„æ“ä½œ</span><br><span class="hljs-comment"># &quot;hwchase17/openai-tools-agent&quot; æ˜¯ LangChain å®˜æ–¹ç»´æŠ¤çš„ä¸€ä¸ªæ ‡å‡†æç¤ºè¯æ¨¡æ¿ï¼Œä¸“ä¸º OpenAI å·¥å…·è°ƒç”¨å‹ Agent è®¾è®¡</span><br>prompt = hub.pull(<span class="hljs-string">&quot;hwchase17/openai-tools-agent&quot;</span>)<br><br><span class="hljs-comment"># åˆå§‹åŒ–æ¨¡å‹</span><br>model = init_chat_model(<span class="hljs-string">&quot;deepseek-chat&quot;</span>, model_provider=<span class="hljs-string">&quot;deepseek&quot;</span>)<br><br><span class="hljs-comment"># é€šè¿‡ LangChain åˆ›å»º OpenAI å·¥å…·ä»£ç†</span><br>agent = create_openai_tools_agent(model, tools, prompt)<br><br><span class="hljs-comment"># é€šè¿‡ AgentExecutor æ‰§è¡Œä»£ç†</span><br>agent_executor = AgentExecutor(agent=agent, tools=tools, verbose=<span class="hljs-literal">True</span>)<br><br><br><span class="hljs-keyword">if</span> __name__ == <span class="hljs-string">&quot;__main__&quot;</span>:<br>    <span class="hljs-comment"># å®šä¹‰ä»»åŠ¡</span><br>    command = &#123;<br>        <span class="hljs-string">&quot;input&quot;</span>: <span class="hljs-string">&quot;è®¿é—®è¿™ä¸ªç½‘ç«™ https://blogroll.naosi.org/ å¹¶ç”¨ä¸­æ–‡å¸®æˆ‘æ€»ç»“ä¸€ä¸‹è¿™ä¸ªç½‘ç«™çš„å†…å®¹&quot;</span><br>    &#125;<br><br>    <span class="hljs-comment"># æ‰§è¡Œä»»åŠ¡</span><br>    response = agent_executor.invoke(command)<br>    <span class="hljs-built_in">print</span>(response[<span class="hljs-string">&#x27;output&#x27;</span>])<br></code></pre></td></tr></table></figure>

<p>æ›´è¿›ä¸€æ­¥åœ°ï¼Œæˆ‘ä»¬è¿˜å¯ä»¥å°†<code>Playwright Agent</code>å°è£…æˆå·¥å…·å‡½æ•°ï¼Œå¹¶ç»“åˆ<code>LangChain</code>çš„<code>LCEL</code>ä¸²è¡Œé“¾ï¼Œå®ç°ä¸€ä¸ªæ›´åŠ å¤æ‚çš„æµè§ˆå™¨è‡ªåŠ¨åŒ–ä»£ç†ã€‚è¿™é‡Œå®šä¹‰çš„å·¥å…·å¦‚ä¸‹æ‰€ç¤ºï¼š</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-comment"># 1. åˆ›å»ºç½‘ç«™æ€»ç»“å·¥å…·</span><br><span class="hljs-meta">@tool</span><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">summarize_website</span>(<span class="hljs-params">url: <span class="hljs-built_in">str</span></span>) -&gt; <span class="hljs-built_in">str</span>:<br>    <span class="hljs-string">&quot;&quot;&quot;è®¿é—®æŒ‡å®šç½‘ç«™å¹¶è¿”å›å†…å®¹æ€»ç»“&quot;&quot;&quot;</span><br>    <span class="hljs-keyword">try</span>:<br>        <span class="hljs-comment"># åˆ›å»ºæµè§ˆå™¨å®ä¾‹</span><br>        sync_browser = create_sync_playwright_browser()<br>        toolkit = PlayWrightBrowserToolkit.from_browser(sync_browser=sync_browser)<br>        tools = toolkit.get_tools()<br><br>        <span class="hljs-comment"># åˆå§‹åŒ–æ¨¡å‹å’ŒAgent</span><br>        model = init_chat_model(<span class="hljs-string">&quot;deepseek-chat&quot;</span>, model_provider=<span class="hljs-string">&quot;deepseek&quot;</span>)<br>        prompt = hub.pull(<span class="hljs-string">&quot;hwchase17/openai-tools-agent&quot;</span>)<br>        agent = create_openai_tools_agent(model, tools, prompt)<br>        agent_executor = AgentExecutor(agent=agent, tools=tools, verbose=<span class="hljs-literal">False</span>)<br><br>        <span class="hljs-comment"># æ‰§è¡Œæ€»ç»“ä»»åŠ¡</span><br>        command = &#123;<br>            <span class="hljs-string">&quot;input&quot;</span>: <span class="hljs-string">f&quot;è®¿é—®è¿™ä¸ªç½‘ç«™ <span class="hljs-subst">&#123;url&#125;</span> å¹¶å¸®æˆ‘è¯¦ç»†æ€»ç»“ä¸€ä¸‹è¿™ä¸ªç½‘ç«™çš„å†…å®¹ï¼ŒåŒ…æ‹¬ä¸»è¦åŠŸèƒ½ã€ç‰¹ç‚¹å’Œä½¿ç”¨æ–¹æ³•&quot;</span><br>        &#125;<br><br>        result = agent_executor.invoke(command)<br>        <span class="hljs-keyword">return</span> result.get(<span class="hljs-string">&quot;output&quot;</span>, <span class="hljs-string">&quot;æ— æ³•è·å–ç½‘ç«™å†…å®¹æ€»ç»“&quot;</span>)<br><br>    <span class="hljs-keyword">except</span> Exception <span class="hljs-keyword">as</span> e:<br>        <span class="hljs-keyword">return</span> <span class="hljs-string">f&quot;ç½‘ç«™è®¿é—®å¤±è´¥: <span class="hljs-subst">&#123;<span class="hljs-built_in">str</span>(e)&#125;</span>&quot;</span><br><br><br><span class="hljs-comment"># 2. åˆ›å»ºPDFç”Ÿæˆå·¥å…·</span><br><span class="hljs-meta">@tool</span><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">generate_pdf</span>(<span class="hljs-params">content: <span class="hljs-built_in">str</span></span>) -&gt; <span class="hljs-built_in">str</span>:<br>    <span class="hljs-string">&quot;&quot;&quot;å°†æ–‡æœ¬å†…å®¹ç”Ÿæˆä¸ºPDFæ–‡ä»¶&quot;&quot;&quot;</span><br>    <span class="hljs-keyword">try</span>:<br>        <span class="hljs-comment"># ç”Ÿæˆæ–‡ä»¶åï¼ˆå¸¦æ—¶é—´æˆ³ï¼‰</span><br>        timestamp = datetime.now().strftime(<span class="hljs-string">&quot;%Y%m%d_%H%M%S&quot;</span>)<br>        filename = <span class="hljs-string">f&quot;website_summary_<span class="hljs-subst">&#123;timestamp&#125;</span>.pdf&quot;</span><br><br>        <span class="hljs-comment"># åˆ›å»ºPDFæ–‡æ¡£</span><br>        doc = SimpleDocTemplate(filename, pagesize=A4)<br>        styles = getSampleStyleSheet()<br><br>        <span class="hljs-comment"># æ³¨å†Œä¸­æ–‡å­—ä½“ï¼ˆå¦‚æœç³»ç»Ÿæœ‰çš„è¯ï¼‰</span><br>        <span class="hljs-keyword">try</span>:<br>            <span class="hljs-comment"># Windows ç³»ç»Ÿå­—ä½“è·¯å¾„</span><br>            font_paths = [<br>                <span class="hljs-string">&quot;C:/Windows/Fonts/simhei.ttf&quot;</span>,  <span class="hljs-comment"># é»‘ä½“</span><br>                <span class="hljs-string">&quot;C:/Windows/Fonts/simsun.ttc&quot;</span>,  <span class="hljs-comment"># å®‹ä½“</span><br>                <span class="hljs-string">&quot;C:/Windows/Fonts/msyh.ttc&quot;</span>,  <span class="hljs-comment"># å¾®è½¯é›…é»‘</span><br>            ]<br><br>            chinese_font_registered = <span class="hljs-literal">False</span><br>            <span class="hljs-keyword">for</span> font_path <span class="hljs-keyword">in</span> font_paths:<br>                <span class="hljs-keyword">if</span> os.path.exists(font_path):<br>                    <span class="hljs-keyword">try</span>:<br>                        pdfmetrics.registerFont(TTFont(<span class="hljs-string">&#x27;ChineseFont&#x27;</span>, font_path))<br>                        chinese_font_registered = <span class="hljs-literal">True</span><br>                        <span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;âœ… æˆåŠŸæ³¨å†Œä¸­æ–‡å­—ä½“: <span class="hljs-subst">&#123;font_path&#125;</span>&quot;</span>)<br>                        <span class="hljs-keyword">break</span><br>                    <span class="hljs-keyword">except</span>:<br>                        <span class="hljs-keyword">continue</span><br><br>            <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> chinese_font_registered:<br>                <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;âš ï¸ æœªæ‰¾åˆ°ä¸­æ–‡å­—ä½“ï¼Œä½¿ç”¨é»˜è®¤å­—ä½“&quot;</span>)<br><br>        <span class="hljs-keyword">except</span> Exception <span class="hljs-keyword">as</span> e:<br>            <span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;âš ï¸ å­—ä½“æ³¨å†Œå¤±è´¥: <span class="hljs-subst">&#123;e&#125;</span>&quot;</span>)<br><br>        <span class="hljs-comment"># è‡ªå®šä¹‰æ ·å¼ - æ”¯æŒä¸­æ–‡</span><br>        title_style = ParagraphStyle(<br>            <span class="hljs-string">&#x27;CustomTitle&#x27;</span>,<br>            parent=styles[<span class="hljs-string">&#x27;Heading1&#x27;</span>],<br>            fontSize=<span class="hljs-number">18</span>,<br>            alignment=TA_CENTER,<br>            spaceAfter=<span class="hljs-number">30</span>,<br>            fontName=<span class="hljs-string">&#x27;ChineseFont&#x27;</span> <span class="hljs-keyword">if</span> <span class="hljs-string">&#x27;chinese_font_registered&#x27;</span> <span class="hljs-keyword">in</span> <span class="hljs-built_in">locals</span>() <span class="hljs-keyword">and</span> chinese_font_registered <span class="hljs-keyword">else</span> <span class="hljs-string">&#x27;Helvetica-Bold&#x27;</span><br>        )<br><br>        content_style = ParagraphStyle(<br>            <span class="hljs-string">&#x27;CustomContent&#x27;</span>,<br>            parent=styles[<span class="hljs-string">&#x27;Normal&#x27;</span>],<br>            fontSize=<span class="hljs-number">11</span>,<br>            alignment=TA_JUSTIFY,<br>            leftIndent=<span class="hljs-number">20</span>,<br>            rightIndent=<span class="hljs-number">20</span>,<br>            spaceAfter=<span class="hljs-number">12</span>,<br>            fontName=<span class="hljs-string">&#x27;ChineseFont&#x27;</span> <span class="hljs-keyword">if</span> <span class="hljs-string">&#x27;chinese_font_registered&#x27;</span> <span class="hljs-keyword">in</span> <span class="hljs-built_in">locals</span>() <span class="hljs-keyword">and</span> chinese_font_registered <span class="hljs-keyword">else</span> <span class="hljs-string">&#x27;Helvetica&#x27;</span><br>        )<br><br>        <span class="hljs-comment"># æ„å»ºPDFå†…å®¹</span><br>        story = []<br><br>        <span class="hljs-comment"># æ ‡é¢˜</span><br>        story.append(Paragraph(<span class="hljs-string">&quot;ç½‘ç«™å†…å®¹æ€»ç»“æŠ¥å‘Š&quot;</span>, title_style))<br>        story.append(Spacer(<span class="hljs-number">1</span>, <span class="hljs-number">20</span>))<br><br>        <span class="hljs-comment"># ç”Ÿæˆæ—¶é—´</span><br>        time_text = <span class="hljs-string">f&quot;ç”Ÿæˆæ—¶é—´: <span class="hljs-subst">&#123;datetime.now().strftime(<span class="hljs-string">&#x27;%Y-%m-%d %H:%M:%S&#x27;</span>)&#125;</span>&quot;</span><br>        story.append(Paragraph(time_text, styles[<span class="hljs-string">&#x27;Normal&#x27;</span>]))<br>        story.append(Spacer(<span class="hljs-number">1</span>, <span class="hljs-number">20</span>))<br><br>        <span class="hljs-comment"># åˆ†éš”çº¿</span><br>        story.append(Paragraph(<span class="hljs-string">&quot;=&quot;</span> * <span class="hljs-number">50</span>, styles[<span class="hljs-string">&#x27;Normal&#x27;</span>]))<br>        story.append(Spacer(<span class="hljs-number">1</span>, <span class="hljs-number">15</span>))<br><br>        <span class="hljs-comment"># ä¸»è¦å†…å®¹ - æ”¹è¿›ä¸­æ–‡å¤„ç†</span><br>        <span class="hljs-keyword">if</span> content:<br>            <span class="hljs-comment"># æ¸…ç†å’Œå¤„ç†å†…å®¹</span><br>            content = content.replace(<span class="hljs-string">&#x27;\r\n&#x27;</span>, <span class="hljs-string">&#x27;\n&#x27;</span>).replace(<span class="hljs-string">&#x27;\r&#x27;</span>, <span class="hljs-string">&#x27;\n&#x27;</span>)<br>            paragraphs = content.split(<span class="hljs-string">&#x27;\n&#x27;</span>)<br><br>            <span class="hljs-keyword">for</span> para <span class="hljs-keyword">in</span> paragraphs:<br>                <span class="hljs-keyword">if</span> para.strip():<br>                    <span class="hljs-comment"># å¤„ç†ç‰¹æ®Šå­—ç¬¦ï¼Œç¡®ä¿PDFå¯ä»¥æ­£ç¡®æ˜¾ç¤º</span><br>                    clean_para = para.strip()<br>                    <span class="hljs-comment"># è½¬æ¢HTMLå®ä½“</span><br>                    clean_para = clean_para.replace(<span class="hljs-string">&#x27;&amp;lt;&#x27;</span>, <span class="hljs-string">&#x27;&lt;&#x27;</span>).replace(<span class="hljs-string">&#x27;&amp;gt;&#x27;</span>, <span class="hljs-string">&#x27;&gt;&#x27;</span>).replace(<span class="hljs-string">&#x27;&amp;amp;&#x27;</span>, <span class="hljs-string">&#x27;&amp;&#x27;</span>)<br><br>                    <span class="hljs-keyword">try</span>:<br>                        story.append(Paragraph(clean_para, content_style))<br>                        story.append(Spacer(<span class="hljs-number">1</span>, <span class="hljs-number">8</span>))<br>                    <span class="hljs-keyword">except</span> Exception <span class="hljs-keyword">as</span> para_error:<br>                        <span class="hljs-comment"># å¦‚æœæ®µè½æœ‰é—®é¢˜ï¼Œå°è¯•ç”¨é»˜è®¤å­—ä½“</span><br>                        <span class="hljs-keyword">try</span>:<br>                            fallback_style = ParagraphStyle(<br>                                <span class="hljs-string">&#x27;Fallback&#x27;</span>,<br>                                parent=styles[<span class="hljs-string">&#x27;Normal&#x27;</span>],<br>                                fontSize=<span class="hljs-number">10</span>,<br>                                leftIndent=<span class="hljs-number">20</span>,<br>                                rightIndent=<span class="hljs-number">20</span>,<br>                                spaceAfter=<span class="hljs-number">10</span><br>                            )<br>                            story.append(Paragraph(clean_para, fallback_style))<br>                            story.append(Spacer(<span class="hljs-number">1</span>, <span class="hljs-number">8</span>))<br>                        <span class="hljs-keyword">except</span>:<br>                            <span class="hljs-comment"># å¦‚æœè¿˜æ˜¯æœ‰é—®é¢˜ï¼Œè®°å½•é”™è¯¯ä½†ç»§ç»­</span><br>                            <span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;âš ï¸ æ®µè½å¤„ç†å¤±è´¥: <span class="hljs-subst">&#123;clean_para[:<span class="hljs-number">50</span>]&#125;</span>...&quot;</span>)<br>                            <span class="hljs-keyword">continue</span><br>        <span class="hljs-keyword">else</span>:<br>            story.append(Paragraph(<span class="hljs-string">&quot;æš‚æ— å†…å®¹&quot;</span>, content_style))<br><br>        <span class="hljs-comment"># é¡µè„šä¿¡æ¯</span><br>        story.append(Spacer(<span class="hljs-number">1</span>, <span class="hljs-number">30</span>))<br>        story.append(Paragraph(<span class="hljs-string">&quot;=&quot;</span> * <span class="hljs-number">50</span>, styles[<span class="hljs-string">&#x27;Normal&#x27;</span>]))<br>        story.append(Paragraph(<span class="hljs-string">&quot;æœ¬æŠ¥å‘Šç”± Playwright PDF Agent è‡ªåŠ¨ç”Ÿæˆ&quot;</span>, styles[<span class="hljs-string">&#x27;Italic&#x27;</span>]))<br><br>        <span class="hljs-comment"># ç”ŸæˆPDF</span><br>        doc.build(story)<br><br>        <span class="hljs-comment"># è·å–ç»å¯¹è·¯å¾„</span><br>        abs_path = os.path.abspath(filename)<br>        <span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;ğŸ“„ PDFæ–‡ä»¶ç”Ÿæˆå®Œæˆ: <span class="hljs-subst">&#123;abs_path&#125;</span>&quot;</span>)<br>        <span class="hljs-keyword">return</span> <span class="hljs-string">f&quot;PDFæ–‡ä»¶å·²æˆåŠŸç”Ÿæˆ: <span class="hljs-subst">&#123;abs_path&#125;</span>&quot;</span><br><br>    <span class="hljs-keyword">except</span> Exception <span class="hljs-keyword">as</span> e:<br>        error_msg = <span class="hljs-string">f&quot;PDFç”Ÿæˆå¤±è´¥: <span class="hljs-subst">&#123;<span class="hljs-built_in">str</span>(e)&#125;</span>&quot;</span><br>        <span class="hljs-built_in">print</span>(error_msg)<br>        <span class="hljs-keyword">return</span> error_msg<br></code></pre></td></tr></table></figure>

<p>ç„¶åæˆ‘ä»¬å¯ä»¥è‡ªå®šä¹‰ä¸åŒçš„é“¾è·¯ï¼Œæ¯”å¦‚ç®€å•çš„ä¸²è¡Œé“¾ç”±<code>Playwright Agent</code>å’Œ <code>generate_pdf Agent</code>ç»„æˆï¼Œå³å…ˆçˆ¬å–ç½‘é¡µçš„å†…å®¹ï¼Œç„¶åå°†ç½‘é¡µä¸­çš„å†…å®¹å†™å…¥åˆ°æœ¬åœ°çš„<code>PDF</code>æ–‡ä»¶ä¸­ã€‚</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-comment"># æ–¹æ³•1ï¼šç®€å•ä¸²è¡Œé“¾</span><br>simple_chain = summarize_website | generate_pdf<br></code></pre></td></tr></table></figure>

<p>é™¤æ­¤ä»¥å¤–ï¼Œæˆ‘ä»¬è¿˜å¯ä»¥å†å®šä¸€ä¸ªæ‘˜è¦å·¥å…·ï¼Œåœ¨ä½¿ç”¨<code>Playwright</code>å·¥å…·è®¿é—®ç½‘é¡µåï¼Œæ ¹æ®çˆ¬å–åˆ°çš„ç½‘é¡µå†…å®¹å…ˆä½¿ç”¨å¤§æ¨¡å‹è¿›è¡Œæ‘˜è¦æ€»ç»“ï¼Œå†è°ƒç”¨<code>generate_pdf</code>å·¥å…·å°†æ€»ç»“å†…å®¹å†™å…¥åˆ°æœ¬åœ°çš„<code>PDF</code>æ–‡ä»¶ä¸­ã€‚ä»£ç å¦‚ä¸‹æ‰€ç¤ºï¼š</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><code class="hljs python">optimization_prompt = ChatPromptTemplate.from_template(<br>    <span class="hljs-string">&quot;&quot;&quot;è¯·ä¼˜åŒ–ä»¥ä¸‹ç½‘ç«™æ€»ç»“å†…å®¹ï¼Œä½¿å…¶æ›´é€‚åˆPDFæŠ¥å‘Šæ ¼å¼ï¼š</span><br><span class="hljs-string"></span><br><span class="hljs-string">    åŸå§‹æ€»ç»“ï¼š</span><br><span class="hljs-string">    &#123;summary&#125;</span><br><span class="hljs-string"></span><br><span class="hljs-string">    è¯·é‡æ–°ç»„ç»‡å†…å®¹ï¼ŒåŒ…æ‹¬ï¼š</span><br><span class="hljs-string">    1. æ¸…æ™°çš„æ ‡é¢˜å’Œç»“æ„</span><br><span class="hljs-string">    2. è¦ç‚¹æ€»ç»“</span><br><span class="hljs-string">    3. è¯¦ç»†è¯´æ˜</span><br><span class="hljs-string">    4. ä½¿ç”¨è¦æ±‚ç­‰</span><br><span class="hljs-string"></span><br><span class="hljs-string">    ä¼˜åŒ–åçš„å†…å®¹ï¼š&quot;&quot;&quot;</span><br>)<br><br>model = init_chat_model(<span class="hljs-string">&quot;deepseek-chat&quot;</span>, model_provider=<span class="hljs-string">&quot;deepseek&quot;</span>)<br><br><span class="hljs-comment"># å¸¦ä¼˜åŒ–çš„ä¸²è¡Œé“¾ï¼šç½‘ç«™æ€»ç»“ â†’ LLMä¼˜åŒ– â†’ PDFç”Ÿæˆ</span><br>optimized_chain = (<br>    summarize_website <br>    | (<span class="hljs-keyword">lambda</span> summary: &#123;<span class="hljs-string">&quot;summary&quot;</span>: summary&#125;)<br>    | optimization_prompt <br>    | model <br>    | StrOutputParser() <br>    | generate_pdf<br>)<br></code></pre></td></tr></table></figure>

<p>å®Œæ•´çš„ä»£ç å¦‚ä¸‹æ‰€ç¤ºï¼š</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> langchain_community.agent_toolkits <span class="hljs-keyword">import</span> PlayWrightBrowserToolkit<br><span class="hljs-keyword">from</span> langchain_community.tools.playwright.utils <span class="hljs-keyword">import</span> create_sync_playwright_browser<br><span class="hljs-keyword">from</span> langchain <span class="hljs-keyword">import</span> hub<br><span class="hljs-keyword">from</span> langchain.agents <span class="hljs-keyword">import</span> AgentExecutor, create_openai_tools_agent<br><span class="hljs-keyword">from</span> langchain.chat_models <span class="hljs-keyword">import</span> init_chat_model<br><span class="hljs-keyword">from</span> langchain_core.tools <span class="hljs-keyword">import</span> tool<br><span class="hljs-keyword">from</span> langchain_core.prompts <span class="hljs-keyword">import</span> ChatPromptTemplate<br><span class="hljs-keyword">from</span> langchain_core.output_parsers <span class="hljs-keyword">import</span> StrOutputParser<br><span class="hljs-keyword">from</span> reportlab.lib.pagesizes <span class="hljs-keyword">import</span> letter, A4<br><span class="hljs-keyword">from</span> reportlab.platypus <span class="hljs-keyword">import</span> SimpleDocTemplate, Paragraph, Spacer<br><span class="hljs-keyword">from</span> reportlab.lib.styles <span class="hljs-keyword">import</span> getSampleStyleSheet, ParagraphStyle<br><span class="hljs-keyword">from</span> reportlab.lib.enums <span class="hljs-keyword">import</span> TA_JUSTIFY, TA_CENTER<br><span class="hljs-keyword">from</span> reportlab.pdfbase <span class="hljs-keyword">import</span> pdfmetrics<br><span class="hljs-keyword">from</span> reportlab.pdfbase.ttfonts <span class="hljs-keyword">import</span> TTFont<br><span class="hljs-keyword">import</span> os<br><span class="hljs-keyword">from</span> datetime <span class="hljs-keyword">import</span> datetime<br><span class="hljs-keyword">import</span> os<br><span class="hljs-keyword">from</span> dotenv <span class="hljs-keyword">import</span> load_dotenv<br><br>load_dotenv(override=<span class="hljs-literal">True</span>)<br><br>DeepSeek_API_KEY = os.getenv(<span class="hljs-string">&quot;DEEPSEEK_API_KEY&quot;</span>)<br><br><span class="hljs-comment"># 1. åˆ›å»ºç½‘ç«™æ€»ç»“å·¥å…·</span><br><span class="hljs-meta">@tool</span><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">summarize_website</span>(<span class="hljs-params">url: <span class="hljs-built_in">str</span></span>) -&gt; <span class="hljs-built_in">str</span>:<br>    <span class="hljs-string">&quot;&quot;&quot;è®¿é—®æŒ‡å®šç½‘ç«™å¹¶è¿”å›å†…å®¹æ€»ç»“&quot;&quot;&quot;</span><br>    <span class="hljs-keyword">try</span>:<br>        <span class="hljs-comment"># åˆ›å»ºæµè§ˆå™¨å®ä¾‹</span><br>        sync_browser = create_sync_playwright_browser()<br>        toolkit = PlayWrightBrowserToolkit.from_browser(sync_browser=sync_browser)<br>        tools = toolkit.get_tools()<br><br>        <span class="hljs-comment"># åˆå§‹åŒ–æ¨¡å‹å’ŒAgent</span><br>        model = init_chat_model(<span class="hljs-string">&quot;deepseek-chat&quot;</span>, model_provider=<span class="hljs-string">&quot;deepseek&quot;</span>)<br>        prompt = hub.pull(<span class="hljs-string">&quot;hwchase17/openai-tools-agent&quot;</span>)<br>        agent = create_openai_tools_agent(model, tools, prompt)<br>        agent_executor = AgentExecutor(agent=agent, tools=tools, verbose=<span class="hljs-literal">False</span>)<br><br>        <span class="hljs-comment"># æ‰§è¡Œæ€»ç»“ä»»åŠ¡</span><br>        command = &#123;<br>            <span class="hljs-string">&quot;input&quot;</span>: <span class="hljs-string">f&quot;è®¿é—®è¿™ä¸ªç½‘ç«™ <span class="hljs-subst">&#123;url&#125;</span> å¹¶å¸®æˆ‘è¯¦ç»†æ€»ç»“ä¸€ä¸‹è¿™ä¸ªç½‘ç«™çš„å†…å®¹ï¼ŒåŒ…æ‹¬ä¸»è¦åŠŸèƒ½ã€ç‰¹ç‚¹å’Œä½¿ç”¨æ–¹æ³•&quot;</span><br>        &#125;<br><br>        result = agent_executor.invoke(command)<br>        <span class="hljs-keyword">return</span> result.get(<span class="hljs-string">&quot;output&quot;</span>, <span class="hljs-string">&quot;æ— æ³•è·å–ç½‘ç«™å†…å®¹æ€»ç»“&quot;</span>)<br><br>    <span class="hljs-keyword">except</span> Exception <span class="hljs-keyword">as</span> e:<br>        <span class="hljs-keyword">return</span> <span class="hljs-string">f&quot;ç½‘ç«™è®¿é—®å¤±è´¥: <span class="hljs-subst">&#123;<span class="hljs-built_in">str</span>(e)&#125;</span>&quot;</span><br><br><span class="hljs-comment"># 2. åˆ›å»ºPDFç”Ÿæˆå·¥å…·</span><br><span class="hljs-meta">@tool</span><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">generate_pdf</span>(<span class="hljs-params">content: <span class="hljs-built_in">str</span></span>) -&gt; <span class="hljs-built_in">str</span>:<br>    <span class="hljs-string">&quot;&quot;&quot;å°†æ–‡æœ¬å†…å®¹ç”Ÿæˆä¸ºPDFæ–‡ä»¶&quot;&quot;&quot;</span><br>    <span class="hljs-keyword">try</span>:<br>        <span class="hljs-comment"># ç”Ÿæˆæ–‡ä»¶åï¼ˆå¸¦æ—¶é—´æˆ³ï¼‰</span><br>        timestamp = datetime.now().strftime(<span class="hljs-string">&quot;%Y%m%d_%H%M%S&quot;</span>)<br>        filename = <span class="hljs-string">f&quot;website_summary_<span class="hljs-subst">&#123;timestamp&#125;</span>.pdf&quot;</span><br><br>        <span class="hljs-comment"># åˆ›å»ºPDFæ–‡æ¡£</span><br>        doc = SimpleDocTemplate(filename, pagesize=A4)<br>        styles = getSampleStyleSheet()<br><br>        <span class="hljs-comment"># æ³¨å†Œä¸­æ–‡å­—ä½“ï¼ˆå¦‚æœç³»ç»Ÿæœ‰çš„è¯ï¼‰</span><br>        <span class="hljs-keyword">try</span>:<br>            <span class="hljs-comment"># Windows ç³»ç»Ÿå­—ä½“è·¯å¾„</span><br>            font_paths = [<br>                <span class="hljs-string">&quot;C:/Windows/Fonts/simhei.ttf&quot;</span>,  <span class="hljs-comment"># é»‘ä½“</span><br>                <span class="hljs-string">&quot;C:/Windows/Fonts/simsun.ttc&quot;</span>,  <span class="hljs-comment"># å®‹ä½“</span><br>                <span class="hljs-string">&quot;C:/Windows/Fonts/msyh.ttc&quot;</span>,  <span class="hljs-comment"># å¾®è½¯é›…é»‘</span><br>            ]<br><br>            chinese_font_registered = <span class="hljs-literal">False</span><br>            <span class="hljs-keyword">for</span> font_path <span class="hljs-keyword">in</span> font_paths:<br>                <span class="hljs-keyword">if</span> os.path.exists(font_path):<br>                    <span class="hljs-keyword">try</span>:<br>                        pdfmetrics.registerFont(TTFont(<span class="hljs-string">&#x27;ChineseFont&#x27;</span>, font_path))<br>                        chinese_font_registered = <span class="hljs-literal">True</span><br>                        <span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;âœ… æˆåŠŸæ³¨å†Œä¸­æ–‡å­—ä½“: <span class="hljs-subst">&#123;font_path&#125;</span>&quot;</span>)<br>                        <span class="hljs-keyword">break</span><br>                    <span class="hljs-keyword">except</span>:<br>                        <span class="hljs-keyword">continue</span><br><br>            <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> chinese_font_registered:<br>                <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;âš ï¸ æœªæ‰¾åˆ°ä¸­æ–‡å­—ä½“ï¼Œä½¿ç”¨é»˜è®¤å­—ä½“&quot;</span>)<br><br>        <span class="hljs-keyword">except</span> Exception <span class="hljs-keyword">as</span> e:<br>            <span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;âš ï¸ å­—ä½“æ³¨å†Œå¤±è´¥: <span class="hljs-subst">&#123;e&#125;</span>&quot;</span>)<br><br>        <span class="hljs-comment"># è‡ªå®šä¹‰æ ·å¼ - æ”¯æŒä¸­æ–‡</span><br>        title_style = ParagraphStyle(<br>            <span class="hljs-string">&#x27;CustomTitle&#x27;</span>,<br>            parent=styles[<span class="hljs-string">&#x27;Heading1&#x27;</span>],<br>            fontSize=<span class="hljs-number">18</span>,<br>            alignment=TA_CENTER,<br>            spaceAfter=<span class="hljs-number">30</span>,<br>            fontName=<span class="hljs-string">&#x27;ChineseFont&#x27;</span> <span class="hljs-keyword">if</span> <span class="hljs-string">&#x27;chinese_font_registered&#x27;</span> <span class="hljs-keyword">in</span> <span class="hljs-built_in">locals</span>() <span class="hljs-keyword">and</span> chinese_font_registered <span class="hljs-keyword">else</span> <span class="hljs-string">&#x27;Helvetica-Bold&#x27;</span><br>        )<br><br>        content_style = ParagraphStyle(<br>            <span class="hljs-string">&#x27;CustomContent&#x27;</span>,<br>            parent=styles[<span class="hljs-string">&#x27;Normal&#x27;</span>],<br>            fontSize=<span class="hljs-number">11</span>,<br>            alignment=TA_JUSTIFY,<br>            leftIndent=<span class="hljs-number">20</span>,<br>            rightIndent=<span class="hljs-number">20</span>,<br>            spaceAfter=<span class="hljs-number">12</span>,<br>            fontName=<span class="hljs-string">&#x27;ChineseFont&#x27;</span> <span class="hljs-keyword">if</span> <span class="hljs-string">&#x27;chinese_font_registered&#x27;</span> <span class="hljs-keyword">in</span> <span class="hljs-built_in">locals</span>() <span class="hljs-keyword">and</span> chinese_font_registered <span class="hljs-keyword">else</span> <span class="hljs-string">&#x27;Helvetica&#x27;</span><br>        )<br><br>        <span class="hljs-comment"># æ„å»ºPDFå†…å®¹</span><br>        story = []<br><br>        <span class="hljs-comment"># æ ‡é¢˜</span><br>        story.append(Paragraph(<span class="hljs-string">&quot;ç½‘ç«™å†…å®¹æ€»ç»“æŠ¥å‘Š&quot;</span>, title_style))<br>        story.append(Spacer(<span class="hljs-number">1</span>, <span class="hljs-number">20</span>))<br><br>        <span class="hljs-comment"># ç”Ÿæˆæ—¶é—´</span><br>        time_text = <span class="hljs-string">f&quot;ç”Ÿæˆæ—¶é—´: <span class="hljs-subst">&#123;datetime.now().strftime(<span class="hljs-string">&#x27;%Y-%m-%d %H:%M:%S&#x27;</span>)&#125;</span>&quot;</span><br>        story.append(Paragraph(time_text, styles[<span class="hljs-string">&#x27;Normal&#x27;</span>]))<br>        story.append(Spacer(<span class="hljs-number">1</span>, <span class="hljs-number">20</span>))<br><br>        <span class="hljs-comment"># åˆ†éš”çº¿</span><br>        story.append(Paragraph(<span class="hljs-string">&quot;=&quot;</span> * <span class="hljs-number">50</span>, styles[<span class="hljs-string">&#x27;Normal&#x27;</span>]))<br>        story.append(Spacer(<span class="hljs-number">1</span>, <span class="hljs-number">15</span>))<br><br>        <span class="hljs-comment"># ä¸»è¦å†…å®¹ - æ”¹è¿›ä¸­æ–‡å¤„ç†</span><br>        <span class="hljs-keyword">if</span> content:<br>            <span class="hljs-comment"># æ¸…ç†å’Œå¤„ç†å†…å®¹</span><br>            content = content.replace(<span class="hljs-string">&#x27;\r\n&#x27;</span>, <span class="hljs-string">&#x27;\n&#x27;</span>).replace(<span class="hljs-string">&#x27;\r&#x27;</span>, <span class="hljs-string">&#x27;\n&#x27;</span>)<br>            paragraphs = content.split(<span class="hljs-string">&#x27;\n&#x27;</span>)<br><br>            <span class="hljs-keyword">for</span> para <span class="hljs-keyword">in</span> paragraphs:<br>                <span class="hljs-keyword">if</span> para.strip():<br>                    <span class="hljs-comment"># å¤„ç†ç‰¹æ®Šå­—ç¬¦ï¼Œç¡®ä¿PDFå¯ä»¥æ­£ç¡®æ˜¾ç¤º</span><br>                    clean_para = para.strip()<br>                    <span class="hljs-comment"># è½¬æ¢HTMLå®ä½“</span><br>                    clean_para = clean_para.replace(<span class="hljs-string">&#x27;&amp;lt;&#x27;</span>, <span class="hljs-string">&#x27;&lt;&#x27;</span>).replace(<span class="hljs-string">&#x27;&amp;gt;&#x27;</span>, <span class="hljs-string">&#x27;&gt;&#x27;</span>).replace(<span class="hljs-string">&#x27;&amp;amp;&#x27;</span>, <span class="hljs-string">&#x27;&amp;&#x27;</span>)<br><br>                    <span class="hljs-keyword">try</span>:<br>                        story.append(Paragraph(clean_para, content_style))<br>                        story.append(Spacer(<span class="hljs-number">1</span>, <span class="hljs-number">8</span>))<br>                    <span class="hljs-keyword">except</span> Exception <span class="hljs-keyword">as</span> para_error:<br>                        <span class="hljs-comment"># å¦‚æœæ®µè½æœ‰é—®é¢˜ï¼Œå°è¯•ç”¨é»˜è®¤å­—ä½“</span><br>                        <span class="hljs-keyword">try</span>:<br>                            fallback_style = ParagraphStyle(<br>                                <span class="hljs-string">&#x27;Fallback&#x27;</span>,<br>                                parent=styles[<span class="hljs-string">&#x27;Normal&#x27;</span>],<br>                                fontSize=<span class="hljs-number">10</span>,<br>                                leftIndent=<span class="hljs-number">20</span>,<br>                                rightIndent=<span class="hljs-number">20</span>,<br>                                spaceAfter=<span class="hljs-number">10</span><br>                            )<br>                            story.append(Paragraph(clean_para, fallback_style))<br>                            story.append(Spacer(<span class="hljs-number">1</span>, <span class="hljs-number">8</span>))<br>                        <span class="hljs-keyword">except</span>:<br>                            <span class="hljs-comment"># å¦‚æœè¿˜æ˜¯æœ‰é—®é¢˜ï¼Œè®°å½•é”™è¯¯ä½†ç»§ç»­</span><br>                            <span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;âš ï¸ æ®µè½å¤„ç†å¤±è´¥: <span class="hljs-subst">&#123;clean_para[:<span class="hljs-number">50</span>]&#125;</span>...&quot;</span>)<br>                            <span class="hljs-keyword">continue</span><br>        <span class="hljs-keyword">else</span>:<br>            story.append(Paragraph(<span class="hljs-string">&quot;æš‚æ— å†…å®¹&quot;</span>, content_style))<br><br>        <span class="hljs-comment"># é¡µè„šä¿¡æ¯</span><br>        story.append(Spacer(<span class="hljs-number">1</span>, <span class="hljs-number">30</span>))<br>        story.append(Paragraph(<span class="hljs-string">&quot;=&quot;</span> * <span class="hljs-number">50</span>, styles[<span class="hljs-string">&#x27;Normal&#x27;</span>]))<br>        story.append(Paragraph(<span class="hljs-string">&quot;æœ¬æŠ¥å‘Šç”± Playwright PDF Agent è‡ªåŠ¨ç”Ÿæˆ&quot;</span>, styles[<span class="hljs-string">&#x27;Italic&#x27;</span>]))<br><br>        <span class="hljs-comment"># ç”ŸæˆPDF</span><br>        doc.build(story)<br><br>        <span class="hljs-comment"># è·å–ç»å¯¹è·¯å¾„</span><br>        abs_path = os.path.abspath(filename)<br>        <span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;ğŸ“„ PDFæ–‡ä»¶ç”Ÿæˆå®Œæˆ: <span class="hljs-subst">&#123;abs_path&#125;</span>&quot;</span>)<br>        <span class="hljs-keyword">return</span> <span class="hljs-string">f&quot;PDFæ–‡ä»¶å·²æˆåŠŸç”Ÿæˆ: <span class="hljs-subst">&#123;abs_path&#125;</span>&quot;</span><br><br>    <span class="hljs-keyword">except</span> Exception <span class="hljs-keyword">as</span> e:<br>        error_msg = <span class="hljs-string">f&quot;PDFç”Ÿæˆå¤±è´¥: <span class="hljs-subst">&#123;<span class="hljs-built_in">str</span>(e)&#125;</span>&quot;</span><br>        <span class="hljs-built_in">print</span>(error_msg)<br>        <span class="hljs-keyword">return</span> error_msg<br><br><span class="hljs-comment"># 3. åˆ›å»ºä¸²è¡Œé“¾</span><br><span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;=== åˆ›å»ºä¸²è¡Œé“¾ï¼šç½‘ç«™æ€»ç»“ â†’ PDFç”Ÿæˆ ===&quot;</span>)<br><br><span class="hljs-comment"># æ–¹æ³•1ï¼šç®€å•ä¸²è¡Œé“¾</span><br>simple_chain = summarize_website | generate_pdf<br><br><span class="hljs-comment"># æ–¹æ³•2ï¼šå¸¦LLMä¼˜åŒ–çš„ä¸²è¡Œé“¾</span><br>optimization_prompt = ChatPromptTemplate.from_template(<br>    <span class="hljs-string">&quot;&quot;&quot;è¯·ä¼˜åŒ–ä»¥ä¸‹ç½‘ç«™æ€»ç»“å†…å®¹ï¼Œä½¿å…¶æ›´é€‚åˆPDFæŠ¥å‘Šæ ¼å¼ï¼š</span><br><span class="hljs-string"></span><br><span class="hljs-string">    åŸå§‹æ€»ç»“ï¼š</span><br><span class="hljs-string">    &#123;summary&#125;</span><br><span class="hljs-string">    </span><br><span class="hljs-string">    è¯·é‡æ–°ç»„ç»‡å†…å®¹ï¼ŒåŒ…æ‹¬ï¼š</span><br><span class="hljs-string">    1. æ¸…æ™°çš„æ ‡é¢˜å’Œç»“æ„</span><br><span class="hljs-string">    2. è¦ç‚¹æ€»ç»“</span><br><span class="hljs-string">    3. è¯¦ç»†è¯´æ˜</span><br><span class="hljs-string">    4. ä½¿ç”¨è¦æ±‚ç­‰</span><br><span class="hljs-string">    </span><br><span class="hljs-string">    ä¼˜åŒ–åçš„å†…å®¹ï¼š&quot;&quot;&quot;</span><br>)<br><br>model = init_chat_model(<span class="hljs-string">&quot;deepseek-chat&quot;</span>, model_provider=<span class="hljs-string">&quot;deepseek&quot;</span>)<br><br><span class="hljs-comment"># å¸¦ä¼˜åŒ–çš„ä¸²è¡Œé“¾ï¼šç½‘ç«™æ€»ç»“ â†’ LLMä¼˜åŒ– â†’ PDFç”Ÿæˆ</span><br>optimized_chain = (<br>        summarize_website<br>        | (<span class="hljs-keyword">lambda</span> summary: &#123;<span class="hljs-string">&quot;summary&quot;</span>: summary&#125;)<br>        | optimization_prompt<br>        | model<br>        | StrOutputParser()<br>        | generate_pdf<br>)<br><br><span class="hljs-comment"># 4. æµ‹è¯•å‡½æ•°</span><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">test_simple_chain</span>(<span class="hljs-params">url: <span class="hljs-built_in">str</span></span>):<br>    <span class="hljs-string">&quot;&quot;&quot;æµ‹è¯•ç®€å•ä¸²è¡Œé“¾&quot;&quot;&quot;</span><br>    <span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;\nğŸ”„ å¼€å§‹å¤„ç†URL: <span class="hljs-subst">&#123;url&#125;</span>&quot;</span>)<br>    <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;ğŸ“ æ­¥éª¤1: ç½‘ç«™æ€»ç»“...&quot;</span>)<br>    <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;ğŸ“„ æ­¥éª¤2: ç”ŸæˆPDF...&quot;</span>)<br><br>    result = simple_chain.invoke(url)<br>    <span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;âœ… å®Œæˆ: <span class="hljs-subst">&#123;result&#125;</span>&quot;</span>)<br>    <span class="hljs-keyword">return</span> result<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">test_optimized_chain</span>(<span class="hljs-params">url: <span class="hljs-built_in">str</span></span>):<br>    <span class="hljs-string">&quot;&quot;&quot;æµ‹è¯•ä¼˜åŒ–ä¸²è¡Œé“¾&quot;&quot;&quot;</span><br>    <span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;\nğŸ”„ å¼€å§‹å¤„ç†URL (ä¼˜åŒ–ç‰ˆ): <span class="hljs-subst">&#123;url&#125;</span>&quot;</span>)<br>    <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;ğŸ“ æ­¥éª¤1: ç½‘ç«™æ€»ç»“...&quot;</span>)<br>    <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;ğŸ¨ æ­¥éª¤2: å†…å®¹ä¼˜åŒ–...&quot;</span>)<br>    <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;ğŸ“„ æ­¥éª¤3: ç”ŸæˆPDF...&quot;</span>)<br><br>    result = optimized_chain.invoke(url)<br>    <span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;âœ… å®Œæˆ: <span class="hljs-subst">&#123;result&#125;</span>&quot;</span>)<br>    <span class="hljs-keyword">return</span> result<br><br><span class="hljs-comment"># 5. åˆ›å»ºäº¤äº’å¼å‡½æ•°</span><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">create_website_pdf_report</span>(<span class="hljs-params">url: <span class="hljs-built_in">str</span>, use_optimization: <span class="hljs-built_in">bool</span> = <span class="hljs-literal">True</span></span>):<br>    <span class="hljs-string">&quot;&quot;&quot;åˆ›å»ºç½‘ç«™PDFæŠ¥å‘Šçš„ä¸»å‡½æ•°&quot;&quot;&quot;</span><br>    <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;=&quot;</span> * <span class="hljs-number">60</span>)<br>    <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;ğŸ¤– ç½‘ç«™å†…å®¹PDFç”Ÿæˆå™¨&quot;</span>)<br>    <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;=&quot;</span> * <span class="hljs-number">60</span>)<br><br>    <span class="hljs-keyword">try</span>:<br>        <span class="hljs-keyword">if</span> use_optimization:<br>            result = test_optimized_chain(url)<br>        <span class="hljs-keyword">else</span>:<br>            result = test_simple_chain(url)<br><br>        <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;\n&quot;</span> + <span class="hljs-string">&quot;=&quot;</span> * <span class="hljs-number">60</span>)<br>        <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;ğŸ‰ ä»»åŠ¡å®Œæˆï¼&quot;</span>)<br>        <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;=&quot;</span> * <span class="hljs-number">60</span>)<br>        <span class="hljs-keyword">return</span> result<br><br>    <span class="hljs-keyword">except</span> Exception <span class="hljs-keyword">as</span> e:<br>        error_msg = <span class="hljs-string">f&quot;âŒ å¤„ç†å¤±è´¥: <span class="hljs-subst">&#123;<span class="hljs-built_in">str</span>(e)&#125;</span>&quot;</span><br>        <span class="hljs-built_in">print</span>(error_msg)<br>        <span class="hljs-keyword">return</span> error_msg<br><br><span class="hljs-comment"># 6. ä¸»ç¨‹åºå…¥å£</span><br><span class="hljs-keyword">if</span> __name__ == <span class="hljs-string">&quot;__main__&quot;</span>:<br>    <span class="hljs-comment"># æµ‹è¯•URL</span><br>    test_url = <span class="hljs-string">&quot;https://blogroll.naosi.org/&quot;</span><br><br>    <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;é€‰æ‹©å¤„ç†æ–¹å¼:&quot;</span>)<br>    <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;1. ç®€å•ä¸²è¡Œé“¾ï¼ˆç›´æ¥æ€»ç»“ â†’ PDFï¼‰&quot;</span>)<br>    <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;2. ä¼˜åŒ–ä¸²è¡Œé“¾ï¼ˆæ€»ç»“ â†’ ä¼˜åŒ– â†’ PDFï¼‰&quot;</span>)<br><br>    choice = <span class="hljs-built_in">input</span>(<span class="hljs-string">&quot;è¯·é€‰æ‹© (1/2): &quot;</span>).strip()<br><br>    <span class="hljs-keyword">if</span> choice == <span class="hljs-string">&quot;1&quot;</span>:<br>        create_website_pdf_report(test_url, use_optimization=<span class="hljs-literal">False</span>)<br>    <span class="hljs-keyword">elif</span> choice == <span class="hljs-string">&quot;2&quot;</span>:<br>        create_website_pdf_report(test_url, use_optimization=<span class="hljs-literal">True</span>)<br>    <span class="hljs-keyword">else</span>:<br>        <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;ä½¿ç”¨é»˜è®¤ä¼˜åŒ–æ¨¡å¼...&quot;</span>)<br>        create_website_pdf_report(test_url, use_optimization=<span class="hljs-literal">True</span>)<br></code></pre></td></tr></table></figure>

<p>è¿™é‡Œä»…åšæ¼”ç¤ºå‚è€ƒï¼Œå®é™…ç”Ÿæˆæ•ˆæœä¸ä½³ï¼Œå¦‚éœ€ä½¿ç”¨åç»­è¿˜éœ€è¦æ›´ç²¾ç»†çš„è°ƒæ•´</p>
<h1 id="å…­ã€LangChain-æ¥å…¥-MCP-æŠ€æœ¯å®ç°æµç¨‹"><a href="#å…­ã€LangChain-æ¥å…¥-MCP-æŠ€æœ¯å®ç°æµç¨‹" class="headerlink" title="å…­ã€LangChain æ¥å…¥ MCP æŠ€æœ¯å®ç°æµç¨‹"></a>å…­ã€<strong>LangChain æ¥å…¥ MCP æŠ€æœ¯å®ç°æµç¨‹</strong></h1><p><code>MCP</code>ï¼Œå…¨ç§°æ˜¯<code>Model Context Protocol</code>ï¼Œæ¨¡å‹ä¸Šä¸‹æ–‡åè®®ï¼Œç”±<code>Claude</code>æ¯å…¬å¸<code>Anthropic</code>äºå»å¹´11æœˆæ­£å¼æå‡ºã€‚</p>
<p><a target="_blank" rel="noopener" href="https://www.anthropic.com/news/model-context-protocol"><code>Anthropic MCP</code>å‘å¸ƒé€šå‘Š</a></p>
<p><a target="_blank" rel="noopener" href="https://github.com/modelcontextprotocol"><code>MCP GitHub</code>ä¸»é¡µ</a></p>
<p><code>MCP</code>çš„æ ¸å¿ƒä½œç”¨ï¼Œæ˜¯ç»Ÿä¸€äº†<code>Agent</code>å¼€å‘è¿‡ç¨‹ä¸­ï¼Œå¤§æ¨¡å‹è°ƒç”¨å¤–éƒ¨å·¥å…·çš„æŠ€æœ¯å®ç°æµç¨‹ï¼Œä»è€Œå¤§å¹…æé«˜<code>Agent</code>å¼€å‘æ•ˆç‡ã€‚åœ¨<code>MCP</code>è¯ç”Ÿä¹‹å‰ï¼Œä¸åŒçš„å¤–éƒ¨å·¥å…·å„æœ‰ä¸åŒçš„è°ƒç”¨æ–¹æ³•ï¼Œè¦è¿æ¥è¿™äº›å¤–éƒ¨å·¥å…·å¼€å‘<code>Agent</code>ï¼Œå°±å¿…é¡»â€œæ¯ä¸€æŠŠé”å•ç‹¬é…ä¸€æŠŠé’¥åŒ™â€ï¼Œå¼€å‘å·¥ä½œéå¸¸ç¹çã€‚</p>
<p class='item-img' data-src='/images/34.png'><img src="/images/34.png"></p>
<p>è€Œ<code>MCP</code>çš„è¯ç”Ÿï¼Œåˆ™ç»Ÿä¸€äº†è¿™äº›å¤–éƒ¨å·¥å…·çš„è°ƒç”¨æµç¨‹ï¼Œä½¿å¾—æ— è®ºä»€ä¹ˆæ ·çš„å·¥å…·ï¼Œéƒ½å¯ä»¥å€ŸåŠ©<code>MCP</code>æŠ€æœ¯æŒ‰ç…§ç»Ÿä¸€çš„ä¸€ä¸ªæµç¨‹å¿«é€Ÿæ¥å…¥åˆ°å¤§æ¨¡å‹ä¸­ï¼Œä»è€Œå¤§å¹…åŠ å¿«<code>Agent</code>å¼€å‘æ•ˆç‡ã€‚è¿™å°±å¥½æ¯”ç°åœ¨å¾ˆå¤šè®¾å¤‡éƒ½å¯ä»¥ä½¿ç”¨<code>type-c</code>å’Œç”µè„‘è¿æ¥ç±»ä¼¼ã€‚</p>
<p class='item-img' data-src='/images/35.png'><img src="/images/35.png"></p>
<p>ä»æŠ€æœ¯å®ç°è§’åº¦æ¥çœ‹ï¼Œæˆ‘ä»¬å¯ä»¥å°†<code>MCP</code>çœ‹æˆæ˜¯<code>Function calling</code>çš„ä¸€ç§å°è£…ï¼Œé€šè¿‡<code>server-client</code>æ¶æ„å’Œä¸€æ•´å¥—å¼€å‘å·¥å…·ï¼Œæ¥è§„èŒƒåŒ–<code>Function calling</code>å¼€å‘æµç¨‹ã€‚</p>
<p class='item-img' data-src='/images/36.png'><img src="/images/36.png"></p>
<p>é¦–å…ˆæ¥ä»‹ç»ä¸€ä¸‹<strong>MCPåŸºç¡€å®ç°æµç¨‹</strong></p>
<p><code>langchain-mcp-adapters</code> é¡¹ç›®ä¸»è¦ä¸º<code>LangChain</code>å’Œ<code>LangGraph</code>æä¾›<code>MCP</code>çš„æ¥å…¥å’Œå…¼å®¹æ¥å£ï¼Œå…¶å·¥ä½œæµç¨‹ä¸»è¦å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š</p>
<p class='item-img' data-src='/images/37.png'><img src="/images/37.png"></p>
<p>å®é™…ä¸Š<code>load_mcp_tools()</code> è¿”å›çš„æ˜¯æ ‡å‡†çš„ <code>LangChain</code> å·¥å…·ï¼Œæ‰€ä»¥æ˜¯å®Œå…¨å¯ä»¥ç›´æ¥åœ¨<code>LangChain</code>ç¯å¢ƒä¸­è¿›è¡Œä½¿ç”¨çš„ã€‚åŒæ—¶ï¼Œå®Œå…¨æ”¯æŒ<code>stdio</code>ã€<code>Http SSE</code>å’Œ<code>Streamable HTTP</code>ä¸‰ç§ä¸åŒçš„é€šè®¯åè®®ã€‚</p>
<p>ä¸€ä¸ªæç®€çš„å¤©æ°”æŸ¥è¯¢<code>MCP</code>è°ƒç”¨æµç¨‹å¦‚ä¸‹ï¼š</p>
<p class='item-img' data-src='/images/38.png'><img src="/images/38.png"></p>
<p>æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬å…ˆå°è¯•æ‰‹åŠ¨å®ç°ä¸€é<code>MCP</code>å®è·µæµç¨‹ï¼Œç„¶åå†è€ƒè™‘å°†å·²ç»éƒ¨ç½²å¥½çš„<code>server</code>ä»£å…¥å…¶ä¸­ï¼Œä½œä¸º<code>tools</code>è¿›è¡Œè°ƒç”¨ã€‚</p>
<p><strong>é¦–å…ˆå€ŸåŠ©<code>uv</code>åˆ›å»º<code>MCP</code>è¿è¡Œç¯å¢ƒ</strong></p>
<p>æ–¹æ³• 1ï¼šä½¿ç”¨ <code>pip</code> å®‰è£…ï¼ˆé€‚ç”¨äºå·²å®‰è£… <code>pip</code> çš„ç³»ç»Ÿï¼‰</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">pip install uv<br></code></pre></td></tr></table></figure>

<p>æ–¹æ³• 2ï¼šä½¿ç”¨ <code>curl</code> ç›´æ¥å®‰è£…</p>
<p>å¦‚æœä½ çš„ç³»ç»Ÿæ²¡æœ‰ <code>pip</code>ï¼Œå¯ä»¥ç›´æ¥è¿è¡Œï¼š</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">curl -LsSf https://astral.sh/uv/install.sh | sh<br></code></pre></td></tr></table></figure>

<p>è¿™ä¼šè‡ªåŠ¨ä¸‹è½½ <code>uv</code> å¹¶å®‰è£…åˆ° <code>/usr/local/bin</code>ã€‚</p>
<p><strong>æ¥ç€åˆ›å»º <code>MCP</code> å®¢æˆ·ç«¯é¡¹ç›®</strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment"># åˆ›å»ºé¡¹ç›®ç›®å½•</span><br>uv init mcp-client<br><br><span class="hljs-comment"># è¿›å…¥é¡¹ç›®ç›®å½•</span><br><span class="hljs-built_in">cd</span> mcp-client<br></code></pre></td></tr></table></figure>

<p><strong>æ¥ç€åˆ›å»º<code>MCP</code>å®¢æˆ·ç«¯è™šæ‹Ÿç¯å¢ƒ</strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment"># åˆ›å»ºè™šæ‹Ÿç¯å¢ƒ</span><br>uv venv<br><br><span class="hljs-comment"># æ¿€æ´»è™šæ‹Ÿç¯å¢ƒ</span><br><span class="hljs-comment"># Linux/macOSç¯å¢ƒ</span><br><span class="hljs-built_in">source</span> .venv/bin/activate<br><span class="hljs-comment"># Windowsç¯å¢ƒ</span><br>.\.venv\Scripts\Activate.ps1<br><span class="hljs-comment"># .\.venv\Scripts\activate.bat</span><br></code></pre></td></tr></table></figure>

<p>ç„¶åå³å¯é€šè¿‡<code>add</code>æ–¹æ³•åœ¨è™šæ‹Ÿç¯å¢ƒä¸­å®‰è£…ç›¸å…³çš„åº“ã€‚</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment"># å®‰è£… MCP SDK</span><br>uv add mcp openai python-dotenv httpx<br></code></pre></td></tr></table></figure>

<p><strong>æ¥ç€ç¼–å†™ç”¨äºå¤©æ°”æŸ¥è¯¢çš„serveræœåŠ¡å™¨ä»£ç ï¼š</strong></p>
<p>è¿™é‡Œæˆ‘ä»¬éœ€è¦åœ¨æœåŠ¡å™¨ä¸Šåˆ›å»ºä¸€ä¸ª<code>weather_server.py</code>ï¼Œå¹¶å†™å…¥å¦‚ä¸‹ä»£ç ï¼š</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">import</span> json<br><span class="hljs-keyword">import</span> httpx<br><span class="hljs-keyword">from</span> typing <span class="hljs-keyword">import</span> <span class="hljs-type">Any</span><br><span class="hljs-keyword">from</span> mcp.server.fastmcp <span class="hljs-keyword">import</span> FastMCP<br><br><span class="hljs-comment"># åˆå§‹åŒ– MCP æœåŠ¡å™¨</span><br>mcp = FastMCP(<span class="hljs-string">&quot;WeatherServer&quot;</span>)<br><br><span class="hljs-comment"># OpenWeather API é…ç½®</span><br>OPENWEATHER_API_BASE = <span class="hljs-string">&quot;https://api.openweathermap.org/data/2.5/weather&quot;</span><br>API_KEY = <span class="hljs-string">&quot;YOUR_API_KEY&quot;</span>  <span class="hljs-comment"># è¯·æ›¿æ¢ä¸ºä½ è‡ªå·±çš„ OpenWeather API Key</span><br>USER_AGENT = <span class="hljs-string">&quot;weather-app/1.0&quot;</span><br><br><span class="hljs-keyword">async</span> <span class="hljs-keyword">def</span> <span class="hljs-title function_">fetch_weather</span>(<span class="hljs-params">city: <span class="hljs-built_in">str</span></span>) -&gt; <span class="hljs-built_in">dict</span>[<span class="hljs-built_in">str</span>, <span class="hljs-type">Any</span>] | <span class="hljs-literal">None</span>:<br>    <span class="hljs-string">&quot;&quot;&quot;</span><br><span class="hljs-string">    ä» OpenWeather API è·å–å¤©æ°”ä¿¡æ¯ã€‚</span><br><span class="hljs-string">    :param city: åŸå¸‚åç§°ï¼ˆéœ€ä½¿ç”¨è‹±æ–‡ï¼Œå¦‚ Beijingï¼‰</span><br><span class="hljs-string">    :return: å¤©æ°”æ•°æ®å­—å…¸ï¼›è‹¥å‡ºé”™è¿”å›åŒ…å« error ä¿¡æ¯çš„å­—å…¸</span><br><span class="hljs-string">    &quot;&quot;&quot;</span><br>    params = &#123;<br>        <span class="hljs-string">&quot;q&quot;</span>: city,<br>        <span class="hljs-string">&quot;appid&quot;</span>: API_KEY,<br>        <span class="hljs-string">&quot;units&quot;</span>: <span class="hljs-string">&quot;metric&quot;</span>,<br>        <span class="hljs-string">&quot;lang&quot;</span>: <span class="hljs-string">&quot;zh_cn&quot;</span><br>    &#125;<br>    headers = &#123;<span class="hljs-string">&quot;User-Agent&quot;</span>: USER_AGENT&#125;<br><br>    <span class="hljs-keyword">async</span> <span class="hljs-keyword">with</span> httpx.AsyncClient() <span class="hljs-keyword">as</span> client:<br>        <span class="hljs-keyword">try</span>:<br>            response = <span class="hljs-keyword">await</span> client.get(OPENWEATHER_API_BASE, params=params, headers=headers, timeout=<span class="hljs-number">30.0</span>)<br>            response.raise_for_status()<br>            <span class="hljs-keyword">return</span> response.json()  <span class="hljs-comment"># è¿”å›å­—å…¸ç±»å‹</span><br>        <span class="hljs-keyword">except</span> httpx.HTTPStatusError <span class="hljs-keyword">as</span> e:<br>            <span class="hljs-keyword">return</span> &#123;<span class="hljs-string">&quot;error&quot;</span>: <span class="hljs-string">f&quot;HTTP é”™è¯¯: <span class="hljs-subst">&#123;e.response.status_code&#125;</span>&quot;</span>&#125;<br>        <span class="hljs-keyword">except</span> Exception <span class="hljs-keyword">as</span> e:<br>            <span class="hljs-keyword">return</span> &#123;<span class="hljs-string">&quot;error&quot;</span>: <span class="hljs-string">f&quot;è¯·æ±‚å¤±è´¥: <span class="hljs-subst">&#123;<span class="hljs-built_in">str</span>(e)&#125;</span>&quot;</span>&#125;<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">format_weather</span>(<span class="hljs-params">data: <span class="hljs-built_in">dict</span>[<span class="hljs-built_in">str</span>, <span class="hljs-type">Any</span>] | <span class="hljs-built_in">str</span></span>) -&gt; <span class="hljs-built_in">str</span>:<br>    <span class="hljs-string">&quot;&quot;&quot;</span><br><span class="hljs-string">    å°†å¤©æ°”æ•°æ®æ ¼å¼åŒ–ä¸ºæ˜“è¯»æ–‡æœ¬ã€‚</span><br><span class="hljs-string">    :param data: å¤©æ°”æ•°æ®ï¼ˆå¯ä»¥æ˜¯å­—å…¸æˆ– JSON å­—ç¬¦ä¸²ï¼‰</span><br><span class="hljs-string">    :return: æ ¼å¼åŒ–åçš„å¤©æ°”ä¿¡æ¯å­—ç¬¦ä¸²</span><br><span class="hljs-string">    &quot;&quot;&quot;</span><br>    <span class="hljs-comment"># å¦‚æœä¼ å…¥çš„æ˜¯å­—ç¬¦ä¸²ï¼Œåˆ™å…ˆè½¬æ¢ä¸ºå­—å…¸</span><br>    <span class="hljs-keyword">if</span> <span class="hljs-built_in">isinstance</span>(data, <span class="hljs-built_in">str</span>):<br>        <span class="hljs-keyword">try</span>:<br>            data = json.loads(data)<br>        <span class="hljs-keyword">except</span> Exception <span class="hljs-keyword">as</span> e:<br>            <span class="hljs-keyword">return</span> <span class="hljs-string">f&quot;æ— æ³•è§£æå¤©æ°”æ•°æ®: <span class="hljs-subst">&#123;e&#125;</span>&quot;</span><br><br>    <span class="hljs-comment"># å¦‚æœæ•°æ®ä¸­åŒ…å«é”™è¯¯ä¿¡æ¯ï¼Œç›´æ¥è¿”å›é”™è¯¯æç¤º</span><br>    <span class="hljs-keyword">if</span> <span class="hljs-string">&quot;error&quot;</span> <span class="hljs-keyword">in</span> data:<br>        <span class="hljs-keyword">return</span> <span class="hljs-string">f&quot;âš ï¸ <span class="hljs-subst">&#123;data[<span class="hljs-string">&#x27;error&#x27;</span>]&#125;</span>&quot;</span><br><br>    <span class="hljs-comment"># æå–æ•°æ®æ—¶åšå®¹é”™å¤„ç†</span><br>    city = data.get(<span class="hljs-string">&quot;name&quot;</span>, <span class="hljs-string">&quot;æœªçŸ¥&quot;</span>)<br>    country = data.get(<span class="hljs-string">&quot;sys&quot;</span>, &#123;&#125;).get(<span class="hljs-string">&quot;country&quot;</span>, <span class="hljs-string">&quot;æœªçŸ¥&quot;</span>)<br>    temp = data.get(<span class="hljs-string">&quot;main&quot;</span>, &#123;&#125;).get(<span class="hljs-string">&quot;temp&quot;</span>, <span class="hljs-string">&quot;N/A&quot;</span>)<br>    humidity = data.get(<span class="hljs-string">&quot;main&quot;</span>, &#123;&#125;).get(<span class="hljs-string">&quot;humidity&quot;</span>, <span class="hljs-string">&quot;N/A&quot;</span>)<br>    wind_speed = data.get(<span class="hljs-string">&quot;wind&quot;</span>, &#123;&#125;).get(<span class="hljs-string">&quot;speed&quot;</span>, <span class="hljs-string">&quot;N/A&quot;</span>)<br>    <span class="hljs-comment"># weather å¯èƒ½ä¸ºç©ºåˆ—è¡¨ï¼Œå› æ­¤ç”¨ [0] å‰å…ˆæä¾›é»˜è®¤å­—å…¸</span><br>    weather_list = data.get(<span class="hljs-string">&quot;weather&quot;</span>, [&#123;&#125;])<br>    description = weather_list[<span class="hljs-number">0</span>].get(<span class="hljs-string">&quot;description&quot;</span>, <span class="hljs-string">&quot;æœªçŸ¥&quot;</span>)<br><br>    <span class="hljs-keyword">return</span> (<br>        <span class="hljs-string">f&quot;ğŸŒ <span class="hljs-subst">&#123;city&#125;</span>, <span class="hljs-subst">&#123;country&#125;</span>\n&quot;</span><br>        <span class="hljs-string">f&quot;ğŸŒ¡ æ¸©åº¦: <span class="hljs-subst">&#123;temp&#125;</span>Â°C\n&quot;</span><br>        <span class="hljs-string">f&quot;ğŸ’§ æ¹¿åº¦: <span class="hljs-subst">&#123;humidity&#125;</span>%\n&quot;</span><br>        <span class="hljs-string">f&quot;ğŸŒ¬ é£é€Ÿ: <span class="hljs-subst">&#123;wind_speed&#125;</span> m/s\n&quot;</span><br>        <span class="hljs-string">f&quot;ğŸŒ¤ å¤©æ°”: <span class="hljs-subst">&#123;description&#125;</span>\n&quot;</span><br>    )<br><br><span class="hljs-meta">@mcp.tool()</span><br><span class="hljs-keyword">async</span> <span class="hljs-keyword">def</span> <span class="hljs-title function_">query_weather</span>(<span class="hljs-params">city: <span class="hljs-built_in">str</span></span>) -&gt; <span class="hljs-built_in">str</span>:<br>    <span class="hljs-string">&quot;&quot;&quot;</span><br><span class="hljs-string">    è¾“å…¥æŒ‡å®šåŸå¸‚çš„è‹±æ–‡åç§°ï¼Œè¿”å›ä»Šæ—¥å¤©æ°”æŸ¥è¯¢ç»“æœã€‚</span><br><span class="hljs-string">    :param city: åŸå¸‚åç§°ï¼ˆéœ€ä½¿ç”¨è‹±æ–‡ï¼‰</span><br><span class="hljs-string">    :return: æ ¼å¼åŒ–åçš„å¤©æ°”ä¿¡æ¯</span><br><span class="hljs-string">    &quot;&quot;&quot;</span><br>    data = <span class="hljs-keyword">await</span> fetch_weather(city)<br>    <span class="hljs-keyword">return</span> format_weather(data)<br><br><span class="hljs-keyword">if</span> __name__ == <span class="hljs-string">&quot;__main__&quot;</span>:<br>    <span class="hljs-comment"># ä»¥æ ‡å‡† I/O æ–¹å¼è¿è¡Œ MCP æœåŠ¡å™¨</span><br>    mcp.run(transport=<span class="hljs-string">&#x27;stdio&#x27;</span>)<br></code></pre></td></tr></table></figure>

<p>ä¸ºäº†æ›´å¥½çš„æµ‹è¯•å¤š<code>MCP</code>å·¥å…·è°ƒç”¨æµç¨‹ï¼Œè¿™é‡Œæˆ‘ä»¬ç»§ç»­åˆ›å»ºä¸€ä¸ª<code>write_server.py</code>æœåŠ¡å™¨ï¼š</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">import</span> json<br><span class="hljs-keyword">import</span> httpx<br><span class="hljs-keyword">from</span> typing <span class="hljs-keyword">import</span> <span class="hljs-type">Any</span><br><span class="hljs-keyword">from</span> mcp.server.fastmcp <span class="hljs-keyword">import</span> FastMCP<br><br><span class="hljs-comment"># åˆå§‹åŒ– MCP æœåŠ¡å™¨</span><br>mcp = FastMCP(<span class="hljs-string">&quot;WriteServer&quot;</span>)<br>USER_AGENT = <span class="hljs-string">&quot;write-app/1.0&quot;</span><br><br><span class="hljs-meta">@mcp.tool()</span><br><span class="hljs-keyword">async</span> <span class="hljs-keyword">def</span> <span class="hljs-title function_">write_file</span>(<span class="hljs-params">content: <span class="hljs-built_in">str</span></span>) -&gt; <span class="hljs-built_in">str</span>:<br>    <span class="hljs-string">&quot;&quot;&quot;</span><br><span class="hljs-string">    å°†æŒ‡å®šå†…å®¹å†™å…¥æœ¬åœ°æ–‡ä»¶ã€‚</span><br><span class="hljs-string">    :param content: å¿…è¦å‚æ•°ï¼Œå­—ç¬¦ä¸²ç±»å‹ï¼Œç”¨äºè¡¨ç¤ºéœ€è¦å†™å…¥æ–‡æ¡£çš„å…·ä½“å†…å®¹ã€‚</span><br><span class="hljs-string">    :returnï¼šæ˜¯å¦æˆåŠŸå†™å…¥</span><br><span class="hljs-string">    &quot;&quot;&quot;</span><br>    <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;å·²æˆåŠŸå†™å…¥æœ¬åœ°æ–‡ä»¶ã€‚&quot;</span><br><br><span class="hljs-keyword">if</span> __name__ == <span class="hljs-string">&quot;__main__&quot;</span>:<br>    <span class="hljs-comment"># ä»¥æ ‡å‡† I/O æ–¹å¼è¿è¡Œ MCP æœåŠ¡å™¨</span><br>    mcp.run(transport=<span class="hljs-string">&#x27;stdio&#x27;</span>)<br></code></pre></td></tr></table></figure>

<p><strong>ç„¶ååˆ›å»ºä¸€ä¸ªå¯ä»¥å’Œserverè¿›è¡Œé€šä¿¡çš„å®¢æˆ·ç«¯</strong></p>
<p>éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œè¯¥å®¢æˆ·ç«¯éœ€è¦åŒ…å«å¤§æ¨¡å‹è°ƒç”¨çš„åŸºç¡€ä¿¡æ¯ã€‚æˆ‘ä»¬éœ€è¦ç¼–å†™ä¸€ä¸ª<code>client.py</code>è„šæœ¬ï¼Œè¿™ä¸ªè„šæœ¬å†…å®¹éå¸¸å¤æ‚ï¼Œè¿™é‡Œæä¾›çš„æ˜¯é€šç”¨çš„<code>mcp</code>å®¢æˆ·ç«¯è„šæœ¬ï¼Œè¿˜æœªæ¥å…¥<code>Langchain</code>ï¼Œä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br><span class="line">360</span><br><span class="line">361</span><br><span class="line">362</span><br><span class="line">363</span><br><span class="line">364</span><br><span class="line">365</span><br><span class="line">366</span><br><span class="line">367</span><br><span class="line">368</span><br><span class="line">369</span><br><span class="line">370</span><br><span class="line">371</span><br><span class="line">372</span><br><span class="line">373</span><br><span class="line">374</span><br><span class="line">375</span><br><span class="line">376</span><br><span class="line">377</span><br><span class="line">378</span><br><span class="line">379</span><br><span class="line">380</span><br><span class="line">381</span><br><span class="line">382</span><br><span class="line">383</span><br><span class="line">384</span><br><span class="line">385</span><br><span class="line">386</span><br><span class="line">387</span><br><span class="line">388</span><br><span class="line">389</span><br><span class="line">390</span><br><span class="line">391</span><br><span class="line">392</span><br><span class="line">393</span><br><span class="line">394</span><br><span class="line">395</span><br><span class="line">396</span><br><span class="line">397</span><br><span class="line">398</span><br><span class="line">399</span><br><span class="line">400</span><br><span class="line">401</span><br><span class="line">402</span><br><span class="line">403</span><br><span class="line">404</span><br><span class="line">405</span><br><span class="line">406</span><br><span class="line">407</span><br><span class="line">408</span><br><span class="line">409</span><br><span class="line">410</span><br><span class="line">411</span><br><span class="line">412</span><br><span class="line">413</span><br><span class="line">414</span><br><span class="line">415</span><br><span class="line">416</span><br><span class="line">417</span><br><span class="line">418</span><br><span class="line">419</span><br><span class="line">420</span><br><span class="line">421</span><br><span class="line">422</span><br><span class="line">423</span><br><span class="line">424</span><br><span class="line">425</span><br><span class="line">426</span><br><span class="line">427</span><br><span class="line">428</span><br><span class="line">429</span><br><span class="line">430</span><br><span class="line">431</span><br><span class="line">432</span><br><span class="line">433</span><br><span class="line">434</span><br><span class="line">435</span><br><span class="line">436</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">import</span> asyncio<br><span class="hljs-keyword">import</span> json<br><span class="hljs-keyword">import</span> logging<br><span class="hljs-keyword">import</span> os<br><span class="hljs-keyword">import</span> shutil<br><span class="hljs-keyword">from</span> contextlib <span class="hljs-keyword">import</span> AsyncExitStack<br><span class="hljs-keyword">from</span> typing <span class="hljs-keyword">import</span> <span class="hljs-type">Any</span>, <span class="hljs-type">Dict</span>, <span class="hljs-type">List</span>, <span class="hljs-type">Optional</span><br><br><span class="hljs-keyword">import</span> httpx<br><span class="hljs-keyword">from</span> dotenv <span class="hljs-keyword">import</span> load_dotenv<br><span class="hljs-keyword">from</span> openai <span class="hljs-keyword">import</span> OpenAI  <span class="hljs-comment"># OpenAI Python SDK</span><br><span class="hljs-keyword">from</span> mcp <span class="hljs-keyword">import</span> ClientSession, StdioServerParameters<br><span class="hljs-keyword">from</span> mcp.client.stdio <span class="hljs-keyword">import</span> stdio_client<br><br><span class="hljs-comment"># Configure logging</span><br>logging.basicConfig(<br>    level=logging.INFO, <span class="hljs-built_in">format</span>=<span class="hljs-string">&quot;%(asctime)s - %(levelname)s - %(message)s&quot;</span><br>)<br><br><br><span class="hljs-comment"># =============================</span><br><span class="hljs-comment"># é…ç½®åŠ è½½ç±»ï¼ˆæ”¯æŒç¯å¢ƒå˜é‡åŠé…ç½®æ–‡ä»¶ï¼‰</span><br><span class="hljs-comment"># =============================</span><br><span class="hljs-keyword">class</span> <span class="hljs-title class_">Configuration</span>:<br>    <span class="hljs-string">&quot;&quot;&quot;ç®¡ç† MCP å®¢æˆ·ç«¯çš„ç¯å¢ƒå˜é‡å’Œé…ç½®æ–‡ä»¶&quot;&quot;&quot;</span><br><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__init__</span>(<span class="hljs-params">self</span>) -&gt; <span class="hljs-literal">None</span>:<br>        load_dotenv()<br>        <span class="hljs-comment"># ä»ç¯å¢ƒå˜é‡ä¸­åŠ è½½ API key, base_url å’Œ model</span><br>        <span class="hljs-variable language_">self</span>.api_key = os.getenv(<span class="hljs-string">&quot;LLM_API_KEY&quot;</span>)<br>        <span class="hljs-variable language_">self</span>.base_url = os.getenv(<span class="hljs-string">&quot;BASE_URL&quot;</span>)<br>        <span class="hljs-variable language_">self</span>.model = os.getenv(<span class="hljs-string">&quot;MODEL&quot;</span>)<br>        <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> <span class="hljs-variable language_">self</span>.api_key:<br>            <span class="hljs-keyword">raise</span> ValueError(<span class="hljs-string">&quot;âŒ æœªæ‰¾åˆ° LLM_API_KEYï¼Œè¯·åœ¨ .env æ–‡ä»¶ä¸­é…ç½®&quot;</span>)<br><br><span class="hljs-meta">    @staticmethod</span><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">load_config</span>(<span class="hljs-params">file_path: <span class="hljs-built_in">str</span></span>) -&gt; <span class="hljs-type">Dict</span>[<span class="hljs-built_in">str</span>, <span class="hljs-type">Any</span>]:<br>        <span class="hljs-string">&quot;&quot;&quot;</span><br><span class="hljs-string">        ä» JSON æ–‡ä»¶åŠ è½½æœåŠ¡å™¨é…ç½®</span><br><span class="hljs-string">        </span><br><span class="hljs-string">        Args:</span><br><span class="hljs-string">            file_path: JSON é…ç½®æ–‡ä»¶è·¯å¾„</span><br><span class="hljs-string">        </span><br><span class="hljs-string">        Returns:</span><br><span class="hljs-string">            åŒ…å«æœåŠ¡å™¨é…ç½®çš„å­—å…¸</span><br><span class="hljs-string">        &quot;&quot;&quot;</span><br>        <span class="hljs-keyword">with</span> <span class="hljs-built_in">open</span>(file_path, <span class="hljs-string">&quot;r&quot;</span>) <span class="hljs-keyword">as</span> f:<br>            <span class="hljs-keyword">return</span> json.load(f)<br><br><br><span class="hljs-comment"># =============================</span><br><span class="hljs-comment"># MCP æœåŠ¡å™¨å®¢æˆ·ç«¯ç±»</span><br><span class="hljs-comment"># =============================</span><br><span class="hljs-keyword">class</span> <span class="hljs-title class_">Server</span>:<br>    <span class="hljs-string">&quot;&quot;&quot;ç®¡ç†å•ä¸ª MCP æœåŠ¡å™¨è¿æ¥å’Œå·¥å…·è°ƒç”¨&quot;&quot;&quot;</span><br><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__init__</span>(<span class="hljs-params">self, name: <span class="hljs-built_in">str</span>, config: <span class="hljs-type">Dict</span>[<span class="hljs-built_in">str</span>, <span class="hljs-type">Any</span>]</span>) -&gt; <span class="hljs-literal">None</span>:<br>        <span class="hljs-variable language_">self</span>.name: <span class="hljs-built_in">str</span> = name<br>        <span class="hljs-variable language_">self</span>.config: <span class="hljs-type">Dict</span>[<span class="hljs-built_in">str</span>, <span class="hljs-type">Any</span>] = config<br>        <span class="hljs-variable language_">self</span>.session: <span class="hljs-type">Optional</span>[ClientSession] = <span class="hljs-literal">None</span><br>        <span class="hljs-variable language_">self</span>.exit_stack: AsyncExitStack = AsyncExitStack()<br>        <span class="hljs-variable language_">self</span>._cleanup_lock = asyncio.Lock()<br><br>    <span class="hljs-keyword">async</span> <span class="hljs-keyword">def</span> <span class="hljs-title function_">initialize</span>(<span class="hljs-params">self</span>) -&gt; <span class="hljs-literal">None</span>:<br>        <span class="hljs-string">&quot;&quot;&quot;åˆå§‹åŒ–ä¸ MCP æœåŠ¡å™¨çš„è¿æ¥&quot;&quot;&quot;</span><br>        <span class="hljs-comment"># command å­—æ®µç›´æ¥ä»é…ç½®è·å–</span><br>        command = <span class="hljs-variable language_">self</span>.config[<span class="hljs-string">&quot;command&quot;</span>]<br>        <span class="hljs-keyword">if</span> command <span class="hljs-keyword">is</span> <span class="hljs-literal">None</span>:<br>            <span class="hljs-keyword">raise</span> ValueError(<span class="hljs-string">&quot;command ä¸èƒ½ä¸ºç©º&quot;</span>)<br><br>        server_params = StdioServerParameters(<br>            command=command,<br>            args=<span class="hljs-variable language_">self</span>.config[<span class="hljs-string">&quot;args&quot;</span>],<br>            env=&#123;**os.environ, **<span class="hljs-variable language_">self</span>.config[<span class="hljs-string">&quot;env&quot;</span>]&#125; <span class="hljs-keyword">if</span> <span class="hljs-variable language_">self</span>.config.get(<span class="hljs-string">&quot;env&quot;</span>) <span class="hljs-keyword">else</span> <span class="hljs-literal">None</span>,<br>        )<br>        <span class="hljs-keyword">try</span>:<br>            stdio_transport = <span class="hljs-keyword">await</span> <span class="hljs-variable language_">self</span>.exit_stack.enter_async_context(<br>                stdio_client(server_params)<br>            )<br>            read_stream, write_stream = stdio_transport<br>            session = <span class="hljs-keyword">await</span> <span class="hljs-variable language_">self</span>.exit_stack.enter_async_context(<br>                ClientSession(read_stream, write_stream)<br>            )<br>            <span class="hljs-keyword">await</span> session.initialize()<br>            <span class="hljs-variable language_">self</span>.session = session<br>        <span class="hljs-keyword">except</span> Exception <span class="hljs-keyword">as</span> e:<br>            logging.error(<span class="hljs-string">f&quot;Error initializing server <span class="hljs-subst">&#123;self.name&#125;</span>: <span class="hljs-subst">&#123;e&#125;</span>&quot;</span>)<br>            <span class="hljs-keyword">await</span> <span class="hljs-variable language_">self</span>.cleanup()<br>            <span class="hljs-keyword">raise</span><br><br>    <span class="hljs-keyword">async</span> <span class="hljs-keyword">def</span> <span class="hljs-title function_">list_tools</span>(<span class="hljs-params">self</span>) -&gt; <span class="hljs-type">List</span>[<span class="hljs-type">Any</span>]:<br>        <span class="hljs-string">&quot;&quot;&quot;è·å–æœåŠ¡å™¨å¯ç”¨çš„å·¥å…·åˆ—è¡¨</span><br><span class="hljs-string"></span><br><span class="hljs-string">        Returns:</span><br><span class="hljs-string">            å·¥å…·åˆ—è¡¨</span><br><span class="hljs-string">        &quot;&quot;&quot;</span><br>        <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> <span class="hljs-variable language_">self</span>.session:<br>            <span class="hljs-keyword">raise</span> RuntimeError(<span class="hljs-string">f&quot;Server <span class="hljs-subst">&#123;self.name&#125;</span> not initialized&quot;</span>)<br>        tools_response = <span class="hljs-keyword">await</span> <span class="hljs-variable language_">self</span>.session.list_tools()<br>        tools = []<br>        <span class="hljs-keyword">for</span> item <span class="hljs-keyword">in</span> tools_response:<br>            <span class="hljs-keyword">if</span> <span class="hljs-built_in">isinstance</span>(item, <span class="hljs-built_in">tuple</span>) <span class="hljs-keyword">and</span> item[<span class="hljs-number">0</span>] == <span class="hljs-string">&quot;tools&quot;</span>:<br>                <span class="hljs-keyword">for</span> tool <span class="hljs-keyword">in</span> item[<span class="hljs-number">1</span>]:<br>                    tools.append(Tool(tool.name, tool.description, tool.inputSchema))<br>        <span class="hljs-keyword">return</span> tools<br><br>    <span class="hljs-keyword">async</span> <span class="hljs-keyword">def</span> <span class="hljs-title function_">execute_tool</span>(<span class="hljs-params"></span><br><span class="hljs-params">        self, tool_name: <span class="hljs-built_in">str</span>, arguments: <span class="hljs-type">Dict</span>[<span class="hljs-built_in">str</span>, <span class="hljs-type">Any</span>], retries: <span class="hljs-built_in">int</span> = <span class="hljs-number">2</span>, delay: <span class="hljs-built_in">float</span> = <span class="hljs-number">1.0</span></span><br><span class="hljs-params">    </span>) -&gt; <span class="hljs-type">Any</span>:<br>        <span class="hljs-string">&quot;&quot;&quot;æ‰§è¡ŒæŒ‡å®šå·¥å…·ï¼Œå¹¶æ”¯æŒé‡è¯•æœºåˆ¶</span><br><span class="hljs-string"></span><br><span class="hljs-string">        Args:</span><br><span class="hljs-string">            tool_name: å·¥å…·åç§°</span><br><span class="hljs-string">            arguments: å·¥å…·å‚æ•°</span><br><span class="hljs-string">            retries: é‡è¯•æ¬¡æ•°</span><br><span class="hljs-string">            delay: é‡è¯•é—´éš”ç§’æ•°</span><br><span class="hljs-string"></span><br><span class="hljs-string">        Returns:</span><br><span class="hljs-string">            å·¥å…·è°ƒç”¨ç»“æœ</span><br><span class="hljs-string">        &quot;&quot;&quot;</span><br>        <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> <span class="hljs-variable language_">self</span>.session:<br>            <span class="hljs-keyword">raise</span> RuntimeError(<span class="hljs-string">f&quot;Server <span class="hljs-subst">&#123;self.name&#125;</span> not initialized&quot;</span>)<br>        attempt = <span class="hljs-number">0</span><br>        <span class="hljs-keyword">while</span> attempt &lt; retries:<br>            <span class="hljs-keyword">try</span>:<br>                logging.info(<span class="hljs-string">f&quot;Executing <span class="hljs-subst">&#123;tool_name&#125;</span> on server <span class="hljs-subst">&#123;self.name&#125;</span>...&quot;</span>)<br>                result = <span class="hljs-keyword">await</span> <span class="hljs-variable language_">self</span>.session.call_tool(tool_name, arguments)<br>                <span class="hljs-keyword">return</span> result<br>            <span class="hljs-keyword">except</span> Exception <span class="hljs-keyword">as</span> e:<br>                attempt += <span class="hljs-number">1</span><br>                logging.warning(<br>                    <span class="hljs-string">f&quot;Error executing tool: <span class="hljs-subst">&#123;e&#125;</span>. Attempt <span class="hljs-subst">&#123;attempt&#125;</span> of <span class="hljs-subst">&#123;retries&#125;</span>.&quot;</span><br>                )<br>                <span class="hljs-keyword">if</span> attempt &lt; retries:<br>                    logging.info(<span class="hljs-string">f&quot;Retrying in <span class="hljs-subst">&#123;delay&#125;</span> seconds...&quot;</span>)<br>                    <span class="hljs-keyword">await</span> asyncio.sleep(delay)<br>                <span class="hljs-keyword">else</span>:<br>                    logging.error(<span class="hljs-string">&quot;Max retries reached. Failing.&quot;</span>)<br>                    <span class="hljs-keyword">raise</span><br><br>    <span class="hljs-keyword">async</span> <span class="hljs-keyword">def</span> <span class="hljs-title function_">cleanup</span>(<span class="hljs-params">self</span>) -&gt; <span class="hljs-literal">None</span>:<br>        <span class="hljs-string">&quot;&quot;&quot;æ¸…ç†æœåŠ¡å™¨èµ„æº&quot;&quot;&quot;</span><br>        <span class="hljs-keyword">async</span> <span class="hljs-keyword">with</span> <span class="hljs-variable language_">self</span>._cleanup_lock:<br>            <span class="hljs-keyword">try</span>:<br>                <span class="hljs-keyword">await</span> <span class="hljs-variable language_">self</span>.exit_stack.aclose()<br>                <span class="hljs-variable language_">self</span>.session = <span class="hljs-literal">None</span><br>            <span class="hljs-keyword">except</span> Exception <span class="hljs-keyword">as</span> e:<br>                logging.error(<span class="hljs-string">f&quot;Error during cleanup of server <span class="hljs-subst">&#123;self.name&#125;</span>: <span class="hljs-subst">&#123;e&#125;</span>&quot;</span>)<br><br><br><span class="hljs-comment"># =============================</span><br><span class="hljs-comment"># å·¥å…·å°è£…ç±»</span><br><span class="hljs-comment"># =============================</span><br><span class="hljs-keyword">class</span> <span class="hljs-title class_">Tool</span>:<br>    <span class="hljs-string">&quot;&quot;&quot;å°è£… MCP è¿”å›çš„å·¥å…·ä¿¡æ¯&quot;&quot;&quot;</span><br><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__init__</span>(<span class="hljs-params">self, name: <span class="hljs-built_in">str</span>, description: <span class="hljs-built_in">str</span>, input_schema: <span class="hljs-type">Dict</span>[<span class="hljs-built_in">str</span>, <span class="hljs-type">Any</span>]</span>) -&gt; <span class="hljs-literal">None</span>:<br>        <span class="hljs-variable language_">self</span>.name: <span class="hljs-built_in">str</span> = name<br>        <span class="hljs-variable language_">self</span>.description: <span class="hljs-built_in">str</span> = description<br>        <span class="hljs-variable language_">self</span>.input_schema: <span class="hljs-type">Dict</span>[<span class="hljs-built_in">str</span>, <span class="hljs-type">Any</span>] = input_schema<br><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">format_for_llm</span>(<span class="hljs-params">self</span>) -&gt; <span class="hljs-built_in">str</span>:<br>        <span class="hljs-string">&quot;&quot;&quot;ç”Ÿæˆç”¨äº LLM æç¤ºçš„å·¥å…·æè¿°&quot;&quot;&quot;</span><br>        args_desc = []<br>        <span class="hljs-keyword">if</span> <span class="hljs-string">&quot;properties&quot;</span> <span class="hljs-keyword">in</span> <span class="hljs-variable language_">self</span>.input_schema:<br>            <span class="hljs-keyword">for</span> param_name, param_info <span class="hljs-keyword">in</span> <span class="hljs-variable language_">self</span>.input_schema[<span class="hljs-string">&quot;properties&quot;</span>].items():<br>                arg_desc = <span class="hljs-string">f&quot;- <span class="hljs-subst">&#123;param_name&#125;</span>: <span class="hljs-subst">&#123;param_info.get(<span class="hljs-string">&#x27;description&#x27;</span>, <span class="hljs-string">&#x27;No description&#x27;</span>)&#125;</span>&quot;</span><br>                <span class="hljs-keyword">if</span> param_name <span class="hljs-keyword">in</span> <span class="hljs-variable language_">self</span>.input_schema.get(<span class="hljs-string">&quot;required&quot;</span>, []):<br>                    arg_desc += <span class="hljs-string">&quot; (required)&quot;</span><br>                args_desc.append(arg_desc)<br>        <span class="hljs-keyword">return</span> <span class="hljs-string">f&quot;&quot;&quot;</span><br><span class="hljs-string">Tool: <span class="hljs-subst">&#123;self.name&#125;</span></span><br><span class="hljs-string">Description: <span class="hljs-subst">&#123;self.description&#125;</span></span><br><span class="hljs-string">Arguments:</span><br><span class="hljs-string"><span class="hljs-subst">&#123;<span class="hljs-built_in">chr</span>(<span class="hljs-number">10</span>).join(args_desc)&#125;</span></span><br><span class="hljs-string">&quot;&quot;&quot;</span><br><br><br><span class="hljs-comment"># =============================</span><br><span class="hljs-comment"># LLM å®¢æˆ·ç«¯å°è£…ç±»ï¼ˆä½¿ç”¨ OpenAI SDKï¼‰</span><br><span class="hljs-comment"># =============================</span><br><span class="hljs-keyword">class</span> <span class="hljs-title class_">LLMClient</span>:<br>    <span class="hljs-string">&quot;&quot;&quot;ä½¿ç”¨ OpenAI SDK ä¸å¤§æ¨¡å‹äº¤äº’&quot;&quot;&quot;</span><br><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__init__</span>(<span class="hljs-params">self, api_key: <span class="hljs-built_in">str</span>, base_url: <span class="hljs-type">Optional</span>[<span class="hljs-built_in">str</span>], model: <span class="hljs-built_in">str</span></span>) -&gt; <span class="hljs-literal">None</span>:<br>        <span class="hljs-variable language_">self</span>.client = OpenAI(api_key=api_key, base_url=base_url)<br>        <span class="hljs-variable language_">self</span>.model = model<br><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">get_response</span>(<span class="hljs-params">self, messages: <span class="hljs-type">List</span>[<span class="hljs-type">Dict</span>[<span class="hljs-built_in">str</span>, <span class="hljs-type">Any</span>]], tools: <span class="hljs-type">Optional</span>[<span class="hljs-type">List</span>[<span class="hljs-type">Dict</span>[<span class="hljs-built_in">str</span>, <span class="hljs-type">Any</span>]]] = <span class="hljs-literal">None</span></span>) -&gt; <span class="hljs-type">Any</span>:<br>        <span class="hljs-string">&quot;&quot;&quot;</span><br><span class="hljs-string">        å‘é€æ¶ˆæ¯ç»™å¤§æ¨¡å‹ APIï¼Œæ”¯æŒä¼ å…¥å·¥å…·å‚æ•°ï¼ˆfunction calling æ ¼å¼ï¼‰</span><br><span class="hljs-string">        &quot;&quot;&quot;</span><br>        payload = &#123;<br>            <span class="hljs-string">&quot;model&quot;</span>: <span class="hljs-variable language_">self</span>.model,<br>            <span class="hljs-string">&quot;messages&quot;</span>: messages,<br>            <span class="hljs-string">&quot;tools&quot;</span>: tools,<br>        &#125;<br>        <span class="hljs-keyword">try</span>:<br>            response = <span class="hljs-variable language_">self</span>.client.chat.completions.create(**payload)<br>            <span class="hljs-keyword">return</span> response<br>        <span class="hljs-keyword">except</span> Exception <span class="hljs-keyword">as</span> e:<br>            logging.error(<span class="hljs-string">f&quot;Error during LLM call: <span class="hljs-subst">&#123;e&#125;</span>&quot;</span>)<br>            <span class="hljs-keyword">raise</span><br><br><br><span class="hljs-comment"># =============================</span><br><span class="hljs-comment"># å¤šæœåŠ¡å™¨ MCP å®¢æˆ·ç«¯ç±»ï¼ˆé›†æˆé…ç½®æ–‡ä»¶ã€å·¥å…·æ ¼å¼è½¬æ¢ä¸ OpenAI SDK è°ƒç”¨ï¼‰</span><br><span class="hljs-comment"># =============================</span><br><span class="hljs-keyword">class</span> <span class="hljs-title class_">MultiServerMCPClient</span>:<br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__init__</span>(<span class="hljs-params">self</span>) -&gt; <span class="hljs-literal">None</span>:<br>        <span class="hljs-string">&quot;&quot;&quot;</span><br><span class="hljs-string">        ç®¡ç†å¤šä¸ª MCP æœåŠ¡å™¨ï¼Œå¹¶ä½¿ç”¨ OpenAI Function Calling é£æ ¼çš„æ¥å£è°ƒç”¨å¤§æ¨¡å‹</span><br><span class="hljs-string">        &quot;&quot;&quot;</span><br>        <span class="hljs-variable language_">self</span>.exit_stack = AsyncExitStack()<br>        config = Configuration()<br>        <span class="hljs-variable language_">self</span>.openai_api_key = config.api_key<br>        <span class="hljs-variable language_">self</span>.base_url = config.base_url<br>        <span class="hljs-variable language_">self</span>.model = config.model<br>        <span class="hljs-variable language_">self</span>.client = LLMClient(<span class="hljs-variable language_">self</span>.openai_api_key, <span class="hljs-variable language_">self</span>.base_url, <span class="hljs-variable language_">self</span>.model)<br>        <span class="hljs-comment"># (server_name -&gt; Server å¯¹è±¡)</span><br>        <span class="hljs-variable language_">self</span>.servers: <span class="hljs-type">Dict</span>[<span class="hljs-built_in">str</span>, Server] = &#123;&#125;<br>        <span class="hljs-comment"># å„ä¸ª server çš„å·¥å…·åˆ—è¡¨</span><br>        <span class="hljs-variable language_">self</span>.tools_by_server: <span class="hljs-type">Dict</span>[<span class="hljs-built_in">str</span>, <span class="hljs-type">List</span>[<span class="hljs-type">Any</span>]] = &#123;&#125;<br>        <span class="hljs-variable language_">self</span>.all_tools: <span class="hljs-type">List</span>[<span class="hljs-type">Dict</span>[<span class="hljs-built_in">str</span>, <span class="hljs-type">Any</span>]] = []<br><br>    <span class="hljs-keyword">async</span> <span class="hljs-keyword">def</span> <span class="hljs-title function_">connect_to_servers</span>(<span class="hljs-params">self, servers_config: <span class="hljs-type">Dict</span>[<span class="hljs-built_in">str</span>, <span class="hljs-type">Any</span>]</span>) -&gt; <span class="hljs-literal">None</span>:<br>        <span class="hljs-string">&quot;&quot;&quot;</span><br><span class="hljs-string">        æ ¹æ®é…ç½®æ–‡ä»¶åŒæ—¶å¯åŠ¨å¤šä¸ªæœåŠ¡å™¨å¹¶è·å–å·¥å…·</span><br><span class="hljs-string">        servers_config çš„æ ¼å¼ä¸ºï¼š</span><br><span class="hljs-string">        &#123;</span><br><span class="hljs-string">          &quot;mcpServers&quot;: &#123;</span><br><span class="hljs-string">              &quot;sqlite&quot;: &#123; &quot;command&quot;: &quot;uvx&quot;, &quot;args&quot;: [ ... ] &#125;,</span><br><span class="hljs-string">              &quot;puppeteer&quot;: &#123; &quot;command&quot;: &quot;npx&quot;, &quot;args&quot;: [ ... ] &#125;,</span><br><span class="hljs-string">              ...</span><br><span class="hljs-string">          &#125;</span><br><span class="hljs-string">        &#125;</span><br><span class="hljs-string">        &quot;&quot;&quot;</span><br>        mcp_servers = servers_config.get(<span class="hljs-string">&quot;mcpServers&quot;</span>, &#123;&#125;)<br>        <span class="hljs-keyword">for</span> server_name, srv_config <span class="hljs-keyword">in</span> mcp_servers.items():<br>            server = Server(server_name, srv_config)<br>            <span class="hljs-keyword">await</span> server.initialize()<br>            <span class="hljs-variable language_">self</span>.servers[server_name] = server<br>            tools = <span class="hljs-keyword">await</span> server.list_tools()<br>            <span class="hljs-variable language_">self</span>.tools_by_server[server_name] = tools<br><br>            <span class="hljs-keyword">for</span> tool <span class="hljs-keyword">in</span> tools:<br>                <span class="hljs-comment"># ç»Ÿä¸€é‡å‘½åï¼šserverName_toolName</span><br>                function_name = <span class="hljs-string">f&quot;<span class="hljs-subst">&#123;server_name&#125;</span>_<span class="hljs-subst">&#123;tool.name&#125;</span>&quot;</span><br>                <span class="hljs-variable language_">self</span>.all_tools.append(&#123;<br>                    <span class="hljs-string">&quot;type&quot;</span>: <span class="hljs-string">&quot;function&quot;</span>,<br>                    <span class="hljs-string">&quot;function&quot;</span>: &#123;<br>                        <span class="hljs-string">&quot;name&quot;</span>: function_name,<br>                        <span class="hljs-string">&quot;description&quot;</span>: tool.description,<br>                        <span class="hljs-string">&quot;input_schema&quot;</span>: tool.input_schema<br>                    &#125;<br>                &#125;)<br><br>        <span class="hljs-comment"># è½¬æ¢ä¸º OpenAI Function Calling æ‰€éœ€æ ¼å¼</span><br>        <span class="hljs-variable language_">self</span>.all_tools = <span class="hljs-keyword">await</span> <span class="hljs-variable language_">self</span>.transform_json(<span class="hljs-variable language_">self</span>.all_tools)<br><br>        logging.info(<span class="hljs-string">&quot;\nâœ… å·²è¿æ¥åˆ°ä¸‹åˆ—æœåŠ¡å™¨:&quot;</span>)<br>        <span class="hljs-keyword">for</span> name <span class="hljs-keyword">in</span> <span class="hljs-variable language_">self</span>.servers:<br>            srv_cfg = mcp_servers[name]<br>            logging.info(<span class="hljs-string">f&quot;  - <span class="hljs-subst">&#123;name&#125;</span>: command=<span class="hljs-subst">&#123;srv_cfg[<span class="hljs-string">&#x27;command&#x27;</span>]&#125;</span>, args=<span class="hljs-subst">&#123;srv_cfg[<span class="hljs-string">&#x27;args&#x27;</span>]&#125;</span>&quot;</span>)<br>        logging.info(<span class="hljs-string">&quot;\næ±‡æ€»çš„å·¥å…·:&quot;</span>)<br>        <span class="hljs-keyword">for</span> t <span class="hljs-keyword">in</span> <span class="hljs-variable language_">self</span>.all_tools:<br>            logging.info(<span class="hljs-string">f&quot;  - <span class="hljs-subst">&#123;t[<span class="hljs-string">&#x27;function&#x27;</span>][<span class="hljs-string">&#x27;name&#x27;</span>]&#125;</span>&quot;</span>)<br><br>    <span class="hljs-keyword">async</span> <span class="hljs-keyword">def</span> <span class="hljs-title function_">transform_json</span>(<span class="hljs-params">self, json_data: <span class="hljs-type">List</span>[<span class="hljs-type">Dict</span>[<span class="hljs-built_in">str</span>, <span class="hljs-type">Any</span>]]</span>) -&gt; <span class="hljs-type">List</span>[<span class="hljs-type">Dict</span>[<span class="hljs-built_in">str</span>, <span class="hljs-type">Any</span>]]:<br>        <span class="hljs-string">&quot;&quot;&quot;</span><br><span class="hljs-string">        å°†å·¥å…·çš„ input_schema è½¬æ¢ä¸º OpenAI æ‰€éœ€çš„ parameters æ ¼å¼ï¼Œå¹¶åˆ é™¤å¤šä½™å­—æ®µ</span><br><span class="hljs-string">        &quot;&quot;&quot;</span><br>        result = []<br>        <span class="hljs-keyword">for</span> item <span class="hljs-keyword">in</span> json_data:<br>            <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> <span class="hljs-built_in">isinstance</span>(item, <span class="hljs-built_in">dict</span>) <span class="hljs-keyword">or</span> <span class="hljs-string">&quot;type&quot;</span> <span class="hljs-keyword">not</span> <span class="hljs-keyword">in</span> item <span class="hljs-keyword">or</span> <span class="hljs-string">&quot;function&quot;</span> <span class="hljs-keyword">not</span> <span class="hljs-keyword">in</span> item:<br>                <span class="hljs-keyword">continue</span><br>            old_func = item[<span class="hljs-string">&quot;function&quot;</span>]<br>            <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> <span class="hljs-built_in">isinstance</span>(old_func, <span class="hljs-built_in">dict</span>) <span class="hljs-keyword">or</span> <span class="hljs-string">&quot;name&quot;</span> <span class="hljs-keyword">not</span> <span class="hljs-keyword">in</span> old_func <span class="hljs-keyword">or</span> <span class="hljs-string">&quot;description&quot;</span> <span class="hljs-keyword">not</span> <span class="hljs-keyword">in</span> old_func:<br>                <span class="hljs-keyword">continue</span><br>            new_func = &#123;<br>                <span class="hljs-string">&quot;name&quot;</span>: old_func[<span class="hljs-string">&quot;name&quot;</span>],<br>                <span class="hljs-string">&quot;description&quot;</span>: old_func[<span class="hljs-string">&quot;description&quot;</span>],<br>                <span class="hljs-string">&quot;parameters&quot;</span>: &#123;&#125;<br>            &#125;<br>            <span class="hljs-keyword">if</span> <span class="hljs-string">&quot;input_schema&quot;</span> <span class="hljs-keyword">in</span> old_func <span class="hljs-keyword">and</span> <span class="hljs-built_in">isinstance</span>(old_func[<span class="hljs-string">&quot;input_schema&quot;</span>], <span class="hljs-built_in">dict</span>):<br>                old_schema = old_func[<span class="hljs-string">&quot;input_schema&quot;</span>]<br>                new_func[<span class="hljs-string">&quot;parameters&quot;</span>][<span class="hljs-string">&quot;type&quot;</span>] = old_schema.get(<span class="hljs-string">&quot;type&quot;</span>, <span class="hljs-string">&quot;object&quot;</span>)<br>                new_func[<span class="hljs-string">&quot;parameters&quot;</span>][<span class="hljs-string">&quot;properties&quot;</span>] = old_schema.get(<span class="hljs-string">&quot;properties&quot;</span>, &#123;&#125;)<br>                new_func[<span class="hljs-string">&quot;parameters&quot;</span>][<span class="hljs-string">&quot;required&quot;</span>] = old_schema.get(<span class="hljs-string">&quot;required&quot;</span>, [])<br>            new_item = &#123;<br>                <span class="hljs-string">&quot;type&quot;</span>: item[<span class="hljs-string">&quot;type&quot;</span>],<br>                <span class="hljs-string">&quot;function&quot;</span>: new_func<br>            &#125;<br>            result.append(new_item)<br>        <span class="hljs-keyword">return</span> result<br><br>    <span class="hljs-keyword">async</span> <span class="hljs-keyword">def</span> <span class="hljs-title function_">chat_base</span>(<span class="hljs-params">self, messages: <span class="hljs-type">List</span>[<span class="hljs-type">Dict</span>[<span class="hljs-built_in">str</span>, <span class="hljs-type">Any</span>]]</span>) -&gt; <span class="hljs-type">Any</span>:<br>        <span class="hljs-string">&quot;&quot;&quot;</span><br><span class="hljs-string">        ä½¿ç”¨ OpenAI æ¥å£è¿›è¡Œå¯¹è¯ï¼Œå¹¶æ”¯æŒå¤šæ¬¡å·¥å…·è°ƒç”¨ï¼ˆFunction Callingï¼‰ã€‚</span><br><span class="hljs-string">        å¦‚æœè¿”å› finish_reason ä¸º &quot;tool_calls&quot;ï¼Œåˆ™è¿›è¡Œå·¥å…·è°ƒç”¨åå†å‘èµ·è¯·æ±‚ã€‚</span><br><span class="hljs-string">        &quot;&quot;&quot;</span><br>        response = <span class="hljs-variable language_">self</span>.client.get_response(messages, tools=<span class="hljs-variable language_">self</span>.all_tools)<br>        <span class="hljs-comment"># å¦‚æœæ¨¡å‹è¿”å›å·¥å…·è°ƒç”¨</span><br>        <span class="hljs-keyword">if</span> response.choices[<span class="hljs-number">0</span>].finish_reason == <span class="hljs-string">&quot;tool_calls&quot;</span>:<br>            <span class="hljs-keyword">while</span> <span class="hljs-literal">True</span>:<br>                messages = <span class="hljs-keyword">await</span> <span class="hljs-variable language_">self</span>.create_function_response_messages(messages, response)<br>                response = <span class="hljs-variable language_">self</span>.client.get_response(messages, tools=<span class="hljs-variable language_">self</span>.all_tools)<br>                <span class="hljs-keyword">if</span> response.choices[<span class="hljs-number">0</span>].finish_reason != <span class="hljs-string">&quot;tool_calls&quot;</span>:<br>                    <span class="hljs-keyword">break</span><br>        <span class="hljs-keyword">return</span> response<br><br>    <span class="hljs-keyword">async</span> <span class="hljs-keyword">def</span> <span class="hljs-title function_">create_function_response_messages</span>(<span class="hljs-params">self, messages: <span class="hljs-type">List</span>[<span class="hljs-type">Dict</span>[<span class="hljs-built_in">str</span>, <span class="hljs-type">Any</span>]], response: <span class="hljs-type">Any</span></span>) -&gt; <span class="hljs-type">List</span>[<span class="hljs-type">Dict</span>[<span class="hljs-built_in">str</span>, <span class="hljs-type">Any</span>]]:<br>        <span class="hljs-string">&quot;&quot;&quot;</span><br><span class="hljs-string">        å°†æ¨¡å‹è¿”å›çš„å·¥å…·è°ƒç”¨è§£ææ‰§è¡Œï¼Œå¹¶å°†ç»“æœè¿½åŠ åˆ°æ¶ˆæ¯é˜Ÿåˆ—ä¸­</span><br><span class="hljs-string">        &quot;&quot;&quot;</span><br>        function_call_messages = response.choices[<span class="hljs-number">0</span>].message.tool_calls<br>        messages.append(response.choices[<span class="hljs-number">0</span>].message.model_dump())<br>        <span class="hljs-keyword">for</span> function_call_message <span class="hljs-keyword">in</span> function_call_messages:<br>            tool_name = function_call_message.function.name<br>            tool_args = json.loads(function_call_message.function.arguments)<br>            <span class="hljs-comment"># è°ƒç”¨ MCP å·¥å…·</span><br>            function_response = <span class="hljs-keyword">await</span> <span class="hljs-variable language_">self</span>._call_mcp_tool(tool_name, tool_args)<br>            <span class="hljs-comment"># ğŸ” æ‰“å°è¿”å›å€¼åŠå…¶ç±»å‹</span><br>            <span class="hljs-comment"># print(f&quot;[DEBUG] tool_name: &#123;tool_name&#125;&quot;)</span><br>            <span class="hljs-comment"># print(f&quot;[DEBUG] tool_args: &#123;tool_args&#125;&quot;)</span><br>            <span class="hljs-comment"># print(f&quot;[DEBUG] function_response: &#123;function_response&#125;&quot;)</span><br>            <span class="hljs-comment"># print(f&quot;[DEBUG] type(function_response): &#123;type(function_response)&#125;&quot;)</span><br>            messages.append(&#123;<br>                <span class="hljs-string">&quot;role&quot;</span>: <span class="hljs-string">&quot;tool&quot;</span>,<br>                <span class="hljs-string">&quot;content&quot;</span>: function_response,<br>                <span class="hljs-string">&quot;tool_call_id&quot;</span>: function_call_message.<span class="hljs-built_in">id</span>,<br>            &#125;)<br>        <span class="hljs-keyword">return</span> messages<br><br>    <span class="hljs-keyword">async</span> <span class="hljs-keyword">def</span> <span class="hljs-title function_">process_query</span>(<span class="hljs-params">self, user_query: <span class="hljs-built_in">str</span></span>) -&gt; <span class="hljs-built_in">str</span>:<br>        <span class="hljs-string">&quot;&quot;&quot;</span><br><span class="hljs-string">        OpenAI Function Calling æµç¨‹ï¼š</span><br><span class="hljs-string">         1. å‘é€ç”¨æˆ·æ¶ˆæ¯ + å·¥å…·ä¿¡æ¯</span><br><span class="hljs-string">         2. è‹¥æ¨¡å‹è¿”å› finish_reason ä¸º &quot;tool_calls&quot;ï¼Œåˆ™è§£æå¹¶è°ƒç”¨ MCP å·¥å…·</span><br><span class="hljs-string">         3. å°†å·¥å…·è°ƒç”¨ç»“æœè¿”å›ç»™æ¨¡å‹ï¼Œè·å¾—æœ€ç»ˆå›ç­”</span><br><span class="hljs-string">        &quot;&quot;&quot;</span><br>        messages = [&#123;<span class="hljs-string">&quot;role&quot;</span>: <span class="hljs-string">&quot;user&quot;</span>, <span class="hljs-string">&quot;content&quot;</span>: user_query&#125;]<br>        response = <span class="hljs-variable language_">self</span>.client.get_response(messages, tools=<span class="hljs-variable language_">self</span>.all_tools)<br>        content = response.choices[<span class="hljs-number">0</span>]<br>        logging.info(content)<br>        <span class="hljs-keyword">if</span> content.finish_reason == <span class="hljs-string">&quot;tool_calls&quot;</span>:<br>            tool_call = content.message.tool_calls[<span class="hljs-number">0</span>]<br>            tool_name = tool_call.function.name<br>            tool_args = json.loads(tool_call.function.arguments)<br>            logging.info(<span class="hljs-string">f&quot;\n[ è°ƒç”¨å·¥å…·: <span class="hljs-subst">&#123;tool_name&#125;</span>, å‚æ•°: <span class="hljs-subst">&#123;tool_args&#125;</span> ]\n&quot;</span>)<br>            result = <span class="hljs-keyword">await</span> <span class="hljs-variable language_">self</span>._call_mcp_tool(tool_name, tool_args)<br>            messages.append(content.message.model_dump())<br>            messages.append(&#123;<br>                <span class="hljs-string">&quot;role&quot;</span>: <span class="hljs-string">&quot;tool&quot;</span>,<br>                <span class="hljs-string">&quot;content&quot;</span>: result,<br>                <span class="hljs-string">&quot;tool_call_id&quot;</span>: tool_call.<span class="hljs-built_in">id</span>,<br>            &#125;)<br>            response = <span class="hljs-variable language_">self</span>.client.get_response(messages, tools=<span class="hljs-variable language_">self</span>.all_tools)<br>            <span class="hljs-keyword">return</span> response.choices[<span class="hljs-number">0</span>].message.content<br>        <span class="hljs-keyword">return</span> content.message.content<br><br>    <span class="hljs-keyword">async</span> <span class="hljs-keyword">def</span> <span class="hljs-title function_">_call_mcp_tool</span>(<span class="hljs-params">self, tool_full_name: <span class="hljs-built_in">str</span>, tool_args: <span class="hljs-type">Dict</span>[<span class="hljs-built_in">str</span>, <span class="hljs-type">Any</span>]</span>) -&gt; <span class="hljs-built_in">str</span>:<br>        <span class="hljs-string">&quot;&quot;&quot;</span><br><span class="hljs-string">        æ ¹æ® &quot;serverName_toolName&quot; æ ¼å¼è°ƒç”¨ç›¸åº” MCP å·¥å…·</span><br><span class="hljs-string">        &quot;&quot;&quot;</span><br>        parts = tool_full_name.split(<span class="hljs-string">&quot;_&quot;</span>, <span class="hljs-number">1</span>)<br>        <span class="hljs-keyword">if</span> <span class="hljs-built_in">len</span>(parts) != <span class="hljs-number">2</span>:<br>            <span class="hljs-keyword">return</span> <span class="hljs-string">f&quot;æ— æ•ˆçš„å·¥å…·åç§°: <span class="hljs-subst">&#123;tool_full_name&#125;</span>&quot;</span><br>        server_name, tool_name = parts<br>        server = <span class="hljs-variable language_">self</span>.servers.get(server_name)<br>        <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> server:<br>            <span class="hljs-keyword">return</span> <span class="hljs-string">f&quot;æ‰¾ä¸åˆ°æœåŠ¡å™¨: <span class="hljs-subst">&#123;server_name&#125;</span>&quot;</span><br>        resp = <span class="hljs-keyword">await</span> server.execute_tool(tool_name, tool_args)<br>        <br>        <span class="hljs-comment"># ğŸ› ï¸ ä¿®å¤ç‚¹ï¼šæå– TextContent ä¸­çš„æ–‡æœ¬ï¼ˆæˆ–è½¬æˆå­—ç¬¦ä¸²ï¼‰</span><br>        content = resp.content<br>        <span class="hljs-keyword">if</span> <span class="hljs-built_in">isinstance</span>(content, <span class="hljs-built_in">list</span>):<br>            <span class="hljs-comment"># æå–æ‰€æœ‰ TextContent å¯¹è±¡ä¸­çš„ text å­—æ®µ</span><br>            texts = [c.text <span class="hljs-keyword">for</span> c <span class="hljs-keyword">in</span> content <span class="hljs-keyword">if</span> <span class="hljs-built_in">hasattr</span>(c, <span class="hljs-string">&quot;text&quot;</span>)]<br>            <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;\n&quot;</span>.join(texts)<br>        <span class="hljs-keyword">elif</span> <span class="hljs-built_in">isinstance</span>(content, <span class="hljs-built_in">dict</span>) <span class="hljs-keyword">or</span> <span class="hljs-built_in">isinstance</span>(content, <span class="hljs-built_in">list</span>):<br>            <span class="hljs-comment"># å¦‚æœæ˜¯ dict æˆ– listï¼Œä½†ä¸æ˜¯ TextContent ç±»å‹</span><br>            <span class="hljs-keyword">return</span> json.dumps(content, ensure_ascii=<span class="hljs-literal">False</span>)<br>        <span class="hljs-keyword">elif</span> content <span class="hljs-keyword">is</span> <span class="hljs-literal">None</span>:<br>            <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;å·¥å…·æ‰§è¡Œæ— è¾“å‡º&quot;</span><br>        <span class="hljs-keyword">else</span>:<br>            <span class="hljs-keyword">return</span> <span class="hljs-built_in">str</span>(content)<br><br>    <span class="hljs-keyword">async</span> <span class="hljs-keyword">def</span> <span class="hljs-title function_">chat_loop</span>(<span class="hljs-params">self</span>) -&gt; <span class="hljs-literal">None</span>:<br>        <span class="hljs-string">&quot;&quot;&quot;å¤šæœåŠ¡å™¨ MCP + OpenAI Function Calling å®¢æˆ·ç«¯ä¸»å¾ªç¯&quot;&quot;&quot;</span><br>        logging.info(<span class="hljs-string">&quot;\nğŸ¤– å¤šæœåŠ¡å™¨ MCP + Function Calling å®¢æˆ·ç«¯å·²å¯åŠ¨ï¼è¾“å…¥ &#x27;quit&#x27; é€€å‡ºã€‚&quot;</span>)<br>        messages: <span class="hljs-type">List</span>[<span class="hljs-type">Dict</span>[<span class="hljs-built_in">str</span>, <span class="hljs-type">Any</span>]] = []<br>        <span class="hljs-keyword">while</span> <span class="hljs-literal">True</span>:<br>            query = <span class="hljs-built_in">input</span>(<span class="hljs-string">&quot;\nä½ : &quot;</span>).strip()<br>            <span class="hljs-keyword">if</span> query.lower() == <span class="hljs-string">&quot;quit&quot;</span>:<br>                <span class="hljs-keyword">break</span><br>            <span class="hljs-keyword">try</span>:<br>                messages.append(&#123;<span class="hljs-string">&quot;role&quot;</span>: <span class="hljs-string">&quot;user&quot;</span>, <span class="hljs-string">&quot;content&quot;</span>: query&#125;)<br>                messages = messages[-<span class="hljs-number">20</span>:]  <span class="hljs-comment"># ä¿æŒæœ€æ–° 20 æ¡ä¸Šä¸‹æ–‡</span><br>                response = <span class="hljs-keyword">await</span> <span class="hljs-variable language_">self</span>.chat_base(messages)<br>                messages.append(response.choices[<span class="hljs-number">0</span>].message.model_dump())<br>                result = response.choices[<span class="hljs-number">0</span>].message.content<br>                <span class="hljs-comment"># logging.info(f&quot;\nAI: &#123;result&#125;&quot;)</span><br>                <span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;\nAI: <span class="hljs-subst">&#123;result&#125;</span>&quot;</span>)<br>            <span class="hljs-keyword">except</span> Exception <span class="hljs-keyword">as</span> e:<br>                <span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;\nâš ï¸  è°ƒç”¨è¿‡ç¨‹å‡ºé”™: <span class="hljs-subst">&#123;e&#125;</span>&quot;</span>)<br><br>    <span class="hljs-keyword">async</span> <span class="hljs-keyword">def</span> <span class="hljs-title function_">cleanup</span>(<span class="hljs-params">self</span>) -&gt; <span class="hljs-literal">None</span>:<br>        <span class="hljs-string">&quot;&quot;&quot;å…³é—­æ‰€æœ‰èµ„æº&quot;&quot;&quot;</span><br>        <span class="hljs-keyword">await</span> <span class="hljs-variable language_">self</span>.exit_stack.aclose()<br><br><br><span class="hljs-comment"># =============================</span><br><span class="hljs-comment"># ä¸»å‡½æ•°</span><br><span class="hljs-comment"># =============================</span><br><span class="hljs-keyword">async</span> <span class="hljs-keyword">def</span> <span class="hljs-title function_">main</span>() -&gt; <span class="hljs-literal">None</span>:<br>    <span class="hljs-comment"># ä»é…ç½®æ–‡ä»¶åŠ è½½æœåŠ¡å™¨é…ç½®</span><br>    config = Configuration()<br>    servers_config = config.load_config(<span class="hljs-string">&quot;servers_config.json&quot;</span>)<br>    client = MultiServerMCPClient()<br>    <span class="hljs-keyword">try</span>:<br>        <span class="hljs-keyword">await</span> client.connect_to_servers(servers_config)<br>        <span class="hljs-keyword">await</span> client.chat_loop()<br>    <span class="hljs-keyword">finally</span>:<br>        <span class="hljs-keyword">try</span>:<br>            <span class="hljs-keyword">await</span> asyncio.sleep(<span class="hljs-number">0.1</span>)<br>            <span class="hljs-keyword">await</span> client.cleanup()<br>        <span class="hljs-keyword">except</span> RuntimeError <span class="hljs-keyword">as</span> e:<br>            <span class="hljs-comment"># å¦‚æœæ˜¯å› ä¸ºé€€å‡º cancel scope å¯¼è‡´çš„å¼‚å¸¸ï¼Œå¯ä»¥é€‰æ‹©å¿½ç•¥</span><br>            <span class="hljs-keyword">if</span> <span class="hljs-string">&quot;Attempted to exit cancel scope&quot;</span> <span class="hljs-keyword">in</span> <span class="hljs-built_in">str</span>(e):<br>                logging.info(<span class="hljs-string">&quot;é€€å‡ºæ—¶æ£€æµ‹åˆ° cancel scope å¼‚å¸¸ï¼Œå·²å¿½ç•¥ã€‚&quot;</span>)<br>            <span class="hljs-keyword">else</span>:<br>                <span class="hljs-keyword">raise</span><br><br><span class="hljs-keyword">if</span> __name__ == <span class="hljs-string">&quot;__main__&quot;</span>:<br>    asyncio.run(main())<br></code></pre></td></tr></table></figure>

<p>æ¥ä¸‹æ¥ç»§ç»­åˆ›å»ºä¸€ä¸ª<code>.env</code>æ–‡ä»¶ï¼Œæ¥ä¿å­˜å¤§æ¨¡å‹è°ƒç”¨çš„<code>API-KEY</code></p>
<p>å¹¶å†™å…¥å¦‚ä¸‹å†…å®¹ï¼š</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs bash">BASE_URL=https://api.deepseek.com<br>MODEL=deepseek-chat<br>OPENAI_API_KEY=YOUR_DEEPSEEK_API_KEY<br></code></pre></td></tr></table></figure>

<p>æ¥ä¸‹æ¥ç»§ç»­åˆ›å»º<code>servers_config.json</code>æ–‡ä»¶ï¼Œç”¨äºä¿å­˜<code>MCP</code>å·¥å…·åŸºæœ¬ä¿¡æ¯ï¼š</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs json"><span class="hljs-punctuation">&#123;</span><br>  <span class="hljs-attr">&quot;mcpServers&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">&#123;</span><br>    <span class="hljs-attr">&quot;weather&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">&#123;</span><br>      <span class="hljs-attr">&quot;command&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;python&quot;</span><span class="hljs-punctuation">,</span><br>      <span class="hljs-attr">&quot;args&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span><span class="hljs-string">&quot;weather_server.py&quot;</span><span class="hljs-punctuation">]</span><span class="hljs-punctuation">,</span><br>      <span class="hljs-attr">&quot;transport&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;stdio&quot;</span><br>    <span class="hljs-punctuation">&#125;</span><span class="hljs-punctuation">,</span><br>    <span class="hljs-attr">&quot;write&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">&#123;</span><br>      <span class="hljs-attr">&quot;command&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;python&quot;</span><span class="hljs-punctuation">,</span><br>      <span class="hljs-attr">&quot;args&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span><span class="hljs-string">&quot;write_server.py&quot;</span><span class="hljs-punctuation">]</span><span class="hljs-punctuation">,</span><br>      <span class="hljs-attr">&quot;transport&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;stdio&quot;</span><br>    <span class="hljs-punctuation">&#125;</span><br>  <span class="hljs-punctuation">&#125;</span><br><span class="hljs-punctuation">&#125;</span><br></code></pre></td></tr></table></figure>

<p>æœ€ååœ¨å‘½ä»¤è¡Œä¸­æ‰§è¡Œå¦‚ä¸‹å‘½ä»¤ï¼Œæ³¨æ„åœ¨æ­¤ä¹‹å‰è¦å…ˆå¯åŠ¨ä¸¤ä¸ª<code>mcp</code>æœåŠ¡å™¨è„šæœ¬ï¼Œå³å¯å¼€å¯å¯¹è¯ï¼š</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">uv run client.py<br></code></pre></td></tr></table></figure>

<p>è‡³æ­¤ï¼Œå³å®Œæˆäº†ä¸€æ¬¡ç®€å•çš„<code>MCP</code>æ‰§è¡Œæµç¨‹ã€‚</p>
<p>ä¸Šé¢æ˜¯ä½¿ç”¨<code>Function calling</code>ç›´æ¥è°ƒç”¨<code>MCP</code>çš„å·¥å…·</p>
<p>æ¥ä¸‹æ¥æ¥ä»‹ç»**<code>MCP+LangChain</code>çš„åŸºç¡€è°ƒç”¨æµç¨‹**ï¼Œä»£ç é‡ä¹Ÿä¼šå¤§å¹…å‡å°‘</p>
<p><code>LangChain</code>è°ƒç”¨<code>MCP</code>æ˜¯å¯ä»¥å°†<code>MCP</code>çš„å·¥å…·ç›´æ¥è½¬æ¢ä¸º<code>LangChain</code>çš„å·¥å…·ï¼Œç„¶åé€šè¿‡é¢„å®šä¹‰çš„<code>MCP_Client</code>å®ç°ä¸å¤–éƒ¨<code>MCP</code>çš„è¯»å†™æ“ä½œï¼Œæ¢è€Œè¨€ä¹‹å°±æ˜¯æˆ‘ä»¬éœ€è¦æ”¹å†™åŸå…ˆçš„<code>client</code>ï¼Œå°†åŸå…ˆçš„<code>Function calling</code>è°ƒç”¨é€»è¾‘ä¿®æ”¹ä¸º<code>LangChain</code>è°ƒç”¨é€»è¾‘ï¼š</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-string">&quot;&quot;&quot;</span><br><span class="hljs-string">å¤šæœåŠ¡å™¨ MCP + LangChain Agent ç¤ºä¾‹</span><br><span class="hljs-string">---------------------------------</span><br><span class="hljs-string">1. è¯»å– .env ä¸­çš„ LLM_API_KEY / BASE_URL / MODEL</span><br><span class="hljs-string">2. è¯»å– servers_config.json ä¸­çš„ MCP æœåŠ¡å™¨ä¿¡æ¯</span><br><span class="hljs-string">3. å¯åŠ¨ MCP æœåŠ¡å™¨ï¼ˆæ”¯æŒå¤šä¸ªï¼‰</span><br><span class="hljs-string">4. å°†æ‰€æœ‰å·¥å…·æ³¨å…¥ LangChain Agentï¼Œç”±å¤§æ¨¡å‹è‡ªåŠ¨é€‰æ‹©å¹¶è°ƒç”¨</span><br><span class="hljs-string">&quot;&quot;&quot;</span><br><br><span class="hljs-keyword">import</span> asyncio<br><span class="hljs-keyword">import</span> json<br><span class="hljs-keyword">import</span> logging<br><span class="hljs-keyword">import</span> os<br><span class="hljs-keyword">from</span> typing <span class="hljs-keyword">import</span> <span class="hljs-type">Any</span>, <span class="hljs-type">Dict</span>, <span class="hljs-type">List</span><br><br><span class="hljs-keyword">from</span> dotenv <span class="hljs-keyword">import</span> load_dotenv<br><span class="hljs-keyword">from</span> langchain <span class="hljs-keyword">import</span> hub<br><span class="hljs-keyword">from</span> langchain.agents <span class="hljs-keyword">import</span> AgentExecutor, create_openai_tools_agent<br><span class="hljs-keyword">from</span> langchain.chat_models <span class="hljs-keyword">import</span> init_chat_model<br><span class="hljs-keyword">from</span> langchain_mcp_adapters.client <span class="hljs-keyword">import</span> MultiServerMCPClient<br><span class="hljs-keyword">from</span> langchain_mcp_adapters.tools <span class="hljs-keyword">import</span> load_mcp_tools<br><br><span class="hljs-comment"># â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€</span><br><span class="hljs-comment"># ç¯å¢ƒé…ç½®</span><br><span class="hljs-comment"># â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€</span><br><br><span class="hljs-keyword">class</span> <span class="hljs-title class_">Configuration</span>:<br>    <span class="hljs-string">&quot;&quot;&quot;è¯»å– .env ä¸ servers_config.json&quot;&quot;&quot;</span><br><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__init__</span>(<span class="hljs-params">self</span>) -&gt; <span class="hljs-literal">None</span>:<br>        load_dotenv()<br>        <span class="hljs-variable language_">self</span>.api_key: <span class="hljs-built_in">str</span> = os.getenv(<span class="hljs-string">&quot;LLM_API_KEY&quot;</span>) <span class="hljs-keyword">or</span> <span class="hljs-string">&quot;&quot;</span><br>        <span class="hljs-variable language_">self</span>.base_url: <span class="hljs-built_in">str</span> | <span class="hljs-literal">None</span> = os.getenv(<span class="hljs-string">&quot;BASE_URL&quot;</span>)  <span class="hljs-comment"># DeepSeek ç”¨ https://api.deepseek.com</span><br>        <span class="hljs-variable language_">self</span>.model: <span class="hljs-built_in">str</span> = os.getenv(<span class="hljs-string">&quot;MODEL&quot;</span>) <span class="hljs-keyword">or</span> <span class="hljs-string">&quot;deepseek-chat&quot;</span><br>        <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> <span class="hljs-variable language_">self</span>.api_key:<br>            <span class="hljs-keyword">raise</span> ValueError(<span class="hljs-string">&quot;âŒ æœªæ‰¾åˆ° LLM_API_KEYï¼Œè¯·åœ¨ .env ä¸­é…ç½®&quot;</span>)<br><br><span class="hljs-meta">    @staticmethod</span><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">load_servers</span>(<span class="hljs-params">file_path: <span class="hljs-built_in">str</span> = <span class="hljs-string">&quot;servers_config.json&quot;</span></span>) -&gt; <span class="hljs-type">Dict</span>[<span class="hljs-built_in">str</span>, <span class="hljs-type">Any</span>]:<br>        <span class="hljs-keyword">with</span> <span class="hljs-built_in">open</span>(file_path, <span class="hljs-string">&quot;r&quot;</span>, encoding=<span class="hljs-string">&quot;utf-8&quot;</span>) <span class="hljs-keyword">as</span> f:<br>            <span class="hljs-keyword">return</span> json.load(f).get(<span class="hljs-string">&quot;mcpServers&quot;</span>, &#123;&#125;)<br><br><span class="hljs-comment"># â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€</span><br><span class="hljs-comment"># ä¸»é€»è¾‘</span><br><span class="hljs-comment"># â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€</span><br><span class="hljs-keyword">async</span> <span class="hljs-keyword">def</span> <span class="hljs-title function_">run_chat_loop</span>() -&gt; <span class="hljs-literal">None</span>:<br>    <span class="hljs-string">&quot;&quot;&quot;å¯åŠ¨ MCP-Agent èŠå¤©å¾ªç¯&quot;&quot;&quot;</span><br>    cfg = Configuration()<br>    os.environ[<span class="hljs-string">&quot;DEEPSEEK_API_KEY&quot;</span>] = os.getenv(<span class="hljs-string">&quot;LLM_API_KEY&quot;</span>, <span class="hljs-string">&quot;&quot;</span>)<br>    <span class="hljs-keyword">if</span> cfg.base_url:<br>        os.environ[<span class="hljs-string">&quot;DEEPSEEK_API_BASE&quot;</span>] = cfg.base_url<br>    servers_cfg = Configuration.load_servers()<br><br>    <span class="hljs-comment"># æŠŠ key æ³¨å…¥ç¯å¢ƒï¼ŒLangChain-OpenAI / DeepSeek ä¼šè‡ªåŠ¨è¯»å–</span><br>    os.environ[<span class="hljs-string">&quot;OPENAI_API_KEY&quot;</span>] = cfg.api_key<br>    <span class="hljs-keyword">if</span> cfg.base_url:  <span class="hljs-comment"># å¯¹ DeepSeek ä¹‹ç±»çš„è‡ªå®šä¹‰åŸŸåå¾ˆæœ‰ç”¨</span><br>        os.environ[<span class="hljs-string">&quot;OPENAI_BASE_URL&quot;</span>] = cfg.base_url<br><br>    <span class="hljs-comment"># 1ï¸âƒ£ è¿æ¥å¤šå° MCP æœåŠ¡å™¨</span><br>    mcp_client = MultiServerMCPClient(servers_cfg)<br><br>    tools = <span class="hljs-keyword">await</span> mcp_client.get_tools()         <span class="hljs-comment"># LangChain Tool å¯¹è±¡åˆ—è¡¨</span><br><br>    logging.info(<span class="hljs-string">f&quot;âœ… å·²åŠ è½½ <span class="hljs-subst">&#123;<span class="hljs-built_in">len</span>(tools)&#125;</span> ä¸ª MCP å·¥å…·ï¼š <span class="hljs-subst">&#123;[t.name <span class="hljs-keyword">for</span> t <span class="hljs-keyword">in</span> tools]&#125;</span>&quot;</span>)<br><br>    <span class="hljs-comment"># 2ï¸âƒ£ åˆå§‹åŒ–å¤§æ¨¡å‹ï¼ˆDeepSeek / OpenAI / ä»»æ„å…¼å®¹ OpenAI åè®®çš„æ¨¡å‹ï¼‰</span><br>    llm = init_chat_model(<br>        model=cfg.model,<br>        model_provider=<span class="hljs-string">&quot;deepseek&quot;</span> <span class="hljs-keyword">if</span> <span class="hljs-string">&quot;deepseek&quot;</span> <span class="hljs-keyword">in</span> cfg.model <span class="hljs-keyword">else</span> <span class="hljs-string">&quot;openai&quot;</span>,<br>    )<br><br>    <span class="hljs-comment"># 3ï¸âƒ£ æ„é€  LangChain Agentï¼ˆç”¨é€šç”¨ promptï¼‰</span><br>    prompt = hub.pull(<span class="hljs-string">&quot;hwchase17/openai-tools-agent&quot;</span>)<br>    agent = create_openai_tools_agent(llm, tools, prompt)<br>    agent_executor = AgentExecutor(agent=agent, tools=tools, verbose=<span class="hljs-literal">True</span>)<br><br>    <span class="hljs-comment"># 4ï¸âƒ£ CLI èŠå¤©</span><br>    <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;\nğŸ¤– MCP Agent å·²å¯åŠ¨ï¼Œè¾“å…¥ &#x27;quit&#x27; é€€å‡º&quot;</span>)<br>    <span class="hljs-keyword">while</span> <span class="hljs-literal">True</span>:<br>        user_input = <span class="hljs-built_in">input</span>(<span class="hljs-string">&quot;\nä½ : &quot;</span>).strip()<br>        <span class="hljs-keyword">if</span> user_input.lower() == <span class="hljs-string">&quot;quit&quot;</span>:<br>            <span class="hljs-keyword">break</span><br>        <span class="hljs-keyword">try</span>:<br>            result = <span class="hljs-keyword">await</span> agent_executor.ainvoke(&#123;<span class="hljs-string">&quot;input&quot;</span>: user_input&#125;)<br>            <span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;\nAI: <span class="hljs-subst">&#123;result[<span class="hljs-string">&#x27;output&#x27;</span>]&#125;</span>&quot;</span>)<br>        <span class="hljs-keyword">except</span> Exception <span class="hljs-keyword">as</span> exc:<br>            <span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;\nâš ï¸  å‡ºé”™: <span class="hljs-subst">&#123;exc&#125;</span>&quot;</span>)<br><br>    <span class="hljs-comment"># 5ï¸âƒ£ æ¸…ç†</span><br>    <span class="hljs-keyword">await</span> mcp_client.cleanup()<br>    <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;ğŸ§¹ èµ„æºå·²æ¸…ç†ï¼ŒBye!&quot;</span>)<br><br><span class="hljs-comment"># â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€</span><br><span class="hljs-comment"># å…¥å£</span><br><span class="hljs-comment"># â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€</span><br><span class="hljs-keyword">if</span> __name__ == <span class="hljs-string">&quot;__main__&quot;</span>:<br>    logging.basicConfig(level=logging.INFO, <span class="hljs-built_in">format</span>=<span class="hljs-string">&quot;%(asctime)s - %(levelname)s - %(message)s&quot;</span>)<br>    asyncio.run(run_chat_loop())<br></code></pre></td></tr></table></figure>

<p><code>LangChain</code>æ¥å…¥<code>MCP</code>çš„æ ¸å¿ƒåŸç†ä¸ºï¼š <code>weather_server.py</code> â†’ å¯åŠ¨ä¸ºå­è¿›ç¨‹ â†’ <code>stdio</code> é€šä¿¡ â†’ <code>MCP</code> åè®® â†’ è½¬æ¢ä¸º <code>LangChain</code> å·¥å…· â†’ <code>LangChain Agent</code> æ‰§è¡Œè¯»å†™ï¼Œæ ¸å¿ƒè½¬æ¢è¿‡ç¨‹ä¸ºï¼š</p>
<ol>
<li><p><code>@mcp.tool()</code> â†’ æ ‡å‡† <code>LangChain Tool</code></p>
</li>
<li><p><code>stdio_client()</code> â†’ è‡ªåŠ¨å¤„ç† <code>read/write</code> æµï¼Œå…¶ä¸­<code>read</code> è¡¨ç¤ºä» <code>MCP</code> æœåŠ¡å™¨è¯»å–å“åº”çš„æµï¼Œ<code>write</code> è¡¨ç¤ºå‘ <code>MCP</code> æœåŠ¡å™¨å‘é€è¯·æ±‚çš„æµï¼Œå¯¹äº <code>stdio weather_server.py</code>ï¼Œå®ƒä»¬å°±æ˜¯å­è¿›ç¨‹çš„ <code>stdout</code> å’Œ <code>stdin</code></p>
</li>
<li><p><code>load_mcp_tools()</code> â†’ ä¸€é”®è½¬æ¢æ‰€æœ‰å·¥å…·</p>
</li>
</ol>
<h1 id="ä¸ƒã€LangChain-RAGçŸ¥è¯†åº“æ£€ç´¢ç³»ç»Ÿå¼€å‘"><a href="#ä¸ƒã€LangChain-RAGçŸ¥è¯†åº“æ£€ç´¢ç³»ç»Ÿå¼€å‘" class="headerlink" title="ä¸ƒã€LangChain RAGçŸ¥è¯†åº“æ£€ç´¢ç³»ç»Ÿå¼€å‘"></a>ä¸ƒã€<strong>LangChain RAGçŸ¥è¯†åº“æ£€ç´¢ç³»ç»Ÿå¼€å‘</strong></h1><p>é¦–å…ˆä»‹ç»<strong>LangChain å®ç°æœ¬åœ°çŸ¥è¯†åº“é—®ç­”</strong></p>
<p>ä¾›<code>Agents</code>åœ¨å¤„ç†å¤æ‚ä»»åŠ¡çš„æŸä¸ªé˜¶æ®µä½¿ç”¨ï¼Œè¿™å…¶å®æ˜¯ä¸€ç§æ›´ä¸ºå¤æ‚çš„åº”ç”¨æ¶æ„â€”â€”<code>Agent + RAG</code>ã€‚</p>
<p>å‡è®¾ç°åœ¨æˆ‘ä»¬æœ‰ä¸€ä¸ªåŒå¤§çš„çŸ¥è¯†åº“ï¼Œå½“æƒ³ä»è¯¥çŸ¥è¯†åº“ä¸­å»æ£€ç´¢æœ€ç›¸å…³çš„å†…å®¹æ—¶ï¼Œæœ€ç®€å•çš„æ–¹æ³•æ˜¯ï¼šæ¥æ”¶åˆ°ä¸€ä¸ªæŸ¥è¯¢ï¼ˆ<code>Query</code>ï¼‰ï¼Œå°±ç›´æ¥åœ¨çŸ¥è¯†åº“ä¸­è¿›è¡Œæœç´¢ã€‚è¿™ç§åšæ³•å…¶å®æ˜¯å¯è¡Œçš„ï¼Œä½†å­˜åœ¨ä¸¤ä¸ªå…³é”®çš„é—®é¢˜ï¼š</p>
<ol>
<li><p>å‡è®¾æé—®çš„<code>Query</code>çš„ç­”æ¡ˆå‡ºç°åœ¨ä¸€ç¯‡æ–‡ç« ä¸­ï¼Œå»çŸ¥è¯†åº“ä¸­æ‰¾åˆ°ä¸€ç¯‡ä¸ç”¨æˆ·è¾“å…¥ç›¸å…³çš„æ–‡ç« æ˜¯å¾ˆå®¹æ˜“çš„ï¼Œä½†æ˜¯æˆ‘ä»¬å°†æ£€ç´¢åˆ°çš„è¿™æ•´ç¯‡æ–‡ç« ç›´æ¥æ”¾å…¥<code>Prompt</code>ä¸­å¹¶ä¸æ˜¯æœ€ä¼˜çš„é€‰æ‹©ï¼Œå› ä¸ºå…¶ä¸­ä¸€å®šä¼šåŒ…å«éå¸¸å¤šæ— å…³çš„ä¿¡æ¯ï¼Œè€Œæ— æ•ˆä¿¡æ¯è¶Šå¤šï¼Œå¯¹å¤§æ¨¡å‹åç»­çš„æ¨ç†å½±å“è¶Šå¤§ã€‚</p>
</li>
<li><p>ä»»ä½•ä¸€ä¸ªå¤§æ¨¡å‹éƒ½å­˜åœ¨æœ€å¤§è¾“å…¥çš„<code>Token</code>é™åˆ¶ï¼Œä¸€ä¸ªæµç¨‹ä¸­å¯èƒ½æ¶‰åŠå¤šæ¬¡æ£€ç´¢ï¼Œæ¯æ¬¡æ£€ç´¢éƒ½ä¼šäº§ç”Ÿç›¸åº”çš„ä¸Šä¸‹æ–‡ï¼Œæ— æ³•å®¹çº³å¦‚æ­¤å¤šçš„ä¿¡æ¯ã€‚</p>
</li>
</ol>
<p class='item-img' data-src='/images/39.png'><img src="/images/39.png"></p>
<p>è§£å†³ä¸Šè¿°ä¸¤ä¸ªé—®é¢˜çš„æ–¹å¼æ˜¯ï¼šæŠŠå­˜æ”¾ç€åŸå§‹æ•°æ®çš„çŸ¥è¯†åº“ï¼ˆ<code>Knowledge</code>ï¼‰ä¸­çš„æ¯ä¸€ä¸ª<code>raw data</code>ï¼Œåˆ‡åˆ†æˆä¸€ä¸ªä¸€ä¸ªçš„å°å—ï¼Œè¿™äº›å°å—å¯ä»¥æ˜¯ä¸€ä¸ªæ®µè½ï¼Œä¹Ÿå¯ä»¥æ˜¯æ•°æ®åº“ä¸­æŸä¸ªç´¢å¼•å¯¹åº”çš„å€¼ã€‚è¿™ä¸ªåˆ‡åˆ†è¿‡ç¨‹è¢«ç§°ä¸ºâ€œåˆ†å—â€ï¼ˆ<code>chunking</code>ï¼‰ï¼Œå¦‚ä¸‹è¿°æµç¨‹æ‰€ç¤ºï¼š</p>
<p class='item-img' data-src='/images/40.png'><img src="/images/40.png"></p>
<p>ä»¥ç¬¬ä¸€ä¸ªåŸå§‹æ•°æ®ä¸ºä¾‹ï¼ˆ<code>raw data 1</code>ï¼‰ï¼Œé€šè¿‡ä¸€äº›ç‰¹å®šçš„æ–¹æ³•è¿›è¡Œåˆ‡åˆ†ï¼Œä¸€ä¸ªå®Œæ•´çš„å†…å®¹ä¼šè¢«åˆ†å‰²æˆ<code> chunk1</code> ~ <code>chunk4</code>ã€‚é‡‡å–ç›¸åŒçš„æ–¹æ³•ï¼Œç»§ç»­å¯¹<code>raw data 2</code>ã€<code>raw data 3</code>ç›´è‡³<code>raw data n</code>è¿›è¡Œåˆ‡åˆ†ã€‚å®Œæˆè¿™ä¸€è¿‡ç¨‹åï¼Œæˆ‘ä»¬æœ€ç»ˆå¾—åˆ°çš„æ˜¯ä¸€ä¸ªå……æ»¡åˆ†å—æ•°æ®ï¼ˆ<code>chunks</code>ï¼‰çš„æ–°çš„çŸ¥è¯†åº“ï¼ˆ<code>repository</code>ï¼‰ï¼Œå…¶ä¸­æ¯ä¸€é¡¹éƒ½æ˜¯ä¸€ä¸ªå•ç‹¬çš„<code>chunk</code>ã€‚ä¾‹å¦‚ï¼Œå¦‚æœåŸå§‹æ–‡æ¡£å…±æœ‰<code>10</code>ä¸ªï¼Œé‚£ä¹ˆç»è¿‡åˆ‡åˆ†ï¼Œå¯èƒ½ä¼šäº§ç”Ÿå‡º<code>100</code>ä¸ª<code>chunks</code>ã€‚</p>
<p>å®Œæˆè¿™ä¸€è½¬åŒ–åï¼Œå½“å†æ¬¡æ¥æ”¶åˆ°ä¸€ä¸ªæŸ¥è¯¢ï¼ˆ<code>Query</code>ï¼‰æ—¶ï¼Œå°±ä¼šåœ¨æ›´æ–°åçš„çŸ¥è¯†åº“ï¼ˆ<code>repository</code>ï¼‰ä¸­è¿›è¡Œæœç´¢ï¼Œè¿™æ—¶æ£€ç´¢çš„èŒƒå›´å°±ä¸å†æ˜¯æŸä¸ªå®Œæ•´çš„æ–‡æ¡£ï¼Œè€Œæ˜¯å…¶ä¸­çš„æŸä¸€ä¸ªéƒ¨åˆ†ï¼Œè¿”å›çš„æ˜¯ä¸€ä¸ªæˆ–å¤šä¸ªç‰¹å®šçš„<code>chunk</code>ï¼Œè¿™æ ·è¿”å›çš„ä¿¡æ¯é‡å°±ä¼šæ›´å°ä¸”æ›´ç²¾ç¡®ã€‚éšåï¼Œè¿™äº›è¢«æ£€ç´¢åˆ°çš„<code>chunk</code>ä¼šè¢«åŠ å…¥åˆ°<code>Prompt</code>ä¸­ï¼Œä½œä¸ºä¸Šä¸‹æ–‡ä¿¡æ¯ä¸ç”¨æˆ·åŸå§‹çš„<code>Query</code>å…±åŒè¾“å…¥åˆ°å¤§æ¨¡å‹è¿›è¡Œå¤„ç†ï¼Œä»¥ç”Ÿæˆæœ€ç»ˆçš„å›ç­”ã€‚</p>
<p>åœ¨ä¸Šè¿°å°†åŸå§‹æ•°æ®ï¼ˆ<code>raw data</code>ï¼‰è½¬åŒ–ä¸º<code>chunk</code>çš„è¿‡ç¨‹ä¸­ï¼Œå°±ä¼šåŒ…å«æ„å»º<code>RAG</code>çš„ç¬¬ä¸€éƒ¨åˆ†å¼€å‘å·¥ä½œï¼šè¿™åŒ…æ‹¬å¦‚æœåšæ•°æ®æ¸…æ´—ï¼Œå¦‚å»é™¤åœç”¨è¯ã€æ ‡ç‚¹ç¬¦å·ç­‰ã€‚æ­¤å¤–ï¼Œè¿˜æ¶‰åŠå¦‚ä½•é€‰æ‹©åˆé€‚çš„<code>split</code>æ–¹æ³•æ¥è¿›è¡Œæ•°æ®åˆ‡åˆ†çš„ä¸€ç³»åˆ—æŠ€æœ¯ã€‚</p>
<p>æ¥ä¸‹æ¥é¢ä¸´çš„é—®é¢˜æ˜¯ï¼Œå°½ç®¡æ‰€æœ‰æ•°æ®å·²ç»è¢«åˆ‡å‰²æˆä¸€ä¸ªä¸ª<code>chunk</code>ï¼Œå…¶å­˜å‚¨å½¢å¼è¿˜æ˜¯ä»¥å­—ç¬¦ä¸²å½¢å¼å­˜åœ¨ï¼Œå¦‚æœæƒ³ä»<code>repository</code>ä¸­åŒ¹é…åˆ°ä¸è¾“å…¥çš„<code>query</code>ç›¸å…³çš„<code>chunks</code>ï¼Œæ¯”è¾ƒä¸¤å¥è¯æ˜¯å¦ç›¸ä¼¼ï¼Œçœ‹ä¸€å¥è¯ä¸­ç›¸åŒå­—æœ‰å‡ ä¸ªï¼Œè¿™æ˜¾ç„¶æ˜¯è¡Œä¸é€šçš„ã€‚æˆ‘ä»¬éœ€è¦è·å–çš„æ˜¯å¥å­æ‰€è•´å«çš„æ·±å±‚å«ä¹‰ï¼Œè€Œéä»…ä»…æ˜¯è¡¨é¢çš„å­—é¢ç›¸ä¼¼åº¦ã€‚å› æ­¤ï¼Œå¤§å®¶ä¹Ÿèƒ½æƒ³åˆ°ï¼Œåœ¨<code>NLP</code>ä¸­å»è®¡ç®—æ–‡æœ¬ç›¸ä¼¼åº¦çš„æœ‰æ•ˆçš„æ–¹æ³•å°±æ˜¯<code>Embedding</code>ï¼Œå³å°†è¿™äº›<code>chunks</code>è½¬æ¢æˆå‘é‡ï¼ˆ<code>vector</code>ï¼‰å½¢å¼ã€‚æ‰€ä»¥æµç¨‹ä¼šä¸°å¯Œå¦‚ä¸‹ï¼š</p>
<p class='item-img' data-src='/images/41.png'><img src="/images/41.png"></p>
<p>å¦‚ä¸Šæ‰€ç¤ºï¼Œè§£å†³æœç´¢æ•ˆç‡å’Œè®¡ç®—ç›¸ä¼¼åº¦ä¼˜åŒ–ç®—æ³•çš„ç­”æ¡ˆå°±æ˜¯ï¼šå‘é‡æ•°æ®åº“ã€‚åŒæ—¶ä¹Ÿäº§ç”Ÿäº†æ„å»º<code>RAG</code>çš„ç¬¬ä¸‰éƒ¨åˆ†å·¥ä½œï¼šæˆ‘ä»¬è¦å»äº†è§£å’Œå­¦ä¹ å¦‚ä½•é€‰æ‹©ã€ä½¿ç”¨å‘é‡æ•°æ®åº“ã€‚</p>
<p>æœ€ç»ˆæ•´ä½“æµç¨‹å°±å¦‚ä¸Šå›¾æ‰€ç¤ºï¼Œä¸€ä¸ªåŸºç¡€çš„<code>RAG</code>æ¶æ„ä¼šåªè¦åŒ…å«ä»¥ä¸‹å‡ æ–¹é¢çš„å¼€å‘å·¥ä½œï¼š</p>
<ol>
<li>å¦‚ä½•å°†åŸå§‹æ•°æ®è½¬åŒ–æˆ<code>chunks</code>ï¼›</li>
<li>å¦‚ä½•å°†<code>chunks</code>è½¬åŒ–æˆ<code>Vector</code>ï¼›</li>
<li>å¦‚ä½•ç®—å‘é‡ç›¸ä¼¼åº¦çš„ç®—æ³•ï¼›</li>
<li>å¦‚ä½•åˆ©ç”¨å‘é‡æ•°æ®åº“æå‡æœç´¢æ•ˆç‡ï¼›</li>
<li>å¦‚ä½•æŠŠæ‰¾åˆ°çš„<code>chunks</code>ä¸åŸå§‹<code>query</code>æ‹¼æ¥åœ¨ä¸€èµ·ï¼Œäº§ç”Ÿæœ€ç»ˆçš„<code>Prompt</code>ï¼›</li>
</ol>
<p>è€Œä¸Šè¿°æµç¨‹ï¼Œå…¶å®æ›´åƒæ˜¯ä¸€ä¸ªè‡ªç”±æ‹¼æ¥çš„ç»“æœï¼Œæ¯”å¦‚ä¸åŒçš„æ–‡æ¡£ç±»å‹å¯ä»¥é€‰æ‹©ä¸åŒçš„æ–‡æ¡£è§£æå™¨ï¼Œä¹Ÿå¯ä»¥é€‰æ‹©ä¸åŒçš„<code>Vector</code>æ•°æ®åº“ï¼Œç”šè‡³å¯ä»¥è‡ªç”±é€‰æ‹©<code>Embedding</code>æ¨¡å‹å’Œ<code>Vector</code>æ•°æ®åº“çš„ç»„åˆã€‚å…¶è‡ªç”±ç¨‹åº¦éå¸¸é«˜ï¼Œå¦‚ä¸‹å›¾æ‰€ç¤ºï¼š</p>
<p class='item-img' data-src='/images/42.png'><img src="/images/42.png"></p>
<h2 id="ç”±äºè¿™ä¸€éƒ¨åˆ†æ¯”è¾ƒå¤æ‚ï¼Œå› æ­¤åœ¨è¿™ä»…ç»™å‡ºç¤ºä¾‹ä»£ç ï¼Œåç»­å†åšè¡¥å……ï¼ˆåé¢çš„å†…å®¹æœ‰éœ€è¦å¯ä»¥çœ‹ï¼Œä¹Ÿå¯ä»¥ç­‰åç»­ç»™å‡ºæ›´è¯¦ç»†çš„æ•™ç¨‹ï¼‰"><a href="#ç”±äºè¿™ä¸€éƒ¨åˆ†æ¯”è¾ƒå¤æ‚ï¼Œå› æ­¤åœ¨è¿™ä»…ç»™å‡ºç¤ºä¾‹ä»£ç ï¼Œåç»­å†åšè¡¥å……ï¼ˆåé¢çš„å†…å®¹æœ‰éœ€è¦å¯ä»¥çœ‹ï¼Œä¹Ÿå¯ä»¥ç­‰åç»­ç»™å‡ºæ›´è¯¦ç»†çš„æ•™ç¨‹ï¼‰" class="headerlink" title="ç”±äºè¿™ä¸€éƒ¨åˆ†æ¯”è¾ƒå¤æ‚ï¼Œå› æ­¤åœ¨è¿™ä»…ç»™å‡ºç¤ºä¾‹ä»£ç ï¼Œåç»­å†åšè¡¥å……ï¼ˆåé¢çš„å†…å®¹æœ‰éœ€è¦å¯ä»¥çœ‹ï¼Œä¹Ÿå¯ä»¥ç­‰åç»­ç»™å‡ºæ›´è¯¦ç»†çš„æ•™ç¨‹ï¼‰"></a>ç”±äºè¿™ä¸€éƒ¨åˆ†æ¯”è¾ƒå¤æ‚ï¼Œå› æ­¤åœ¨è¿™ä»…ç»™å‡ºç¤ºä¾‹ä»£ç ï¼Œåç»­å†åšè¡¥å……ï¼ˆåé¢çš„å†…å®¹æœ‰éœ€è¦å¯ä»¥çœ‹ï¼Œä¹Ÿå¯ä»¥ç­‰åç»­ç»™å‡ºæ›´è¯¦ç»†çš„æ•™ç¨‹ï¼‰</h2><p>ä¸‹é¢æ˜¯é€šè¿‡ <code>Streamlit</code> å‰ç«¯ç•Œé¢ï¼Œç»“åˆ <code>LangChain</code> æ¡†æ¶ ä¸ <code>DashScope</code> å‘é‡åµŒå…¥æœåŠ¡ï¼Œå®ç°äº†ä¸€ä¸ªè½»é‡åŒ–çš„ <code>RAGï¼ˆRetrieval-Augmented Generationï¼‰</code> æ™ºèƒ½é—®ç­”ç³»ç»Ÿï¼Œæ”¯æŒä¸Šä¼ å¤šä¸ª <code>PDF</code> æ–‡æ¡£ï¼Œç³»ç»Ÿå°†è‡ªåŠ¨å®Œæˆæ–‡æœ¬æå–ã€åˆ†å—ã€å‘é‡åŒ–ï¼Œå¹¶æ„å»ºåŸºäº <code>FAISS</code> çš„æ£€ç´¢æ•°æ®åº“ã€‚ç”¨æˆ·éšåå¯ä»¥åœ¨é¡µé¢ä¸­è¾“å…¥ä»»æ„é—®é¢˜ï¼Œç³»ç»Ÿä¼šè°ƒç”¨å¤§è¯­è¨€æ¨¡å‹ï¼ˆå¦‚ <code>DeepSeek-Chat</code>ï¼‰å¯¹ <code>PDF</code> å†…å®¹è¿›è¡Œè¯­ä¹‰ç†è§£å’Œå›ç­”ç”Ÿæˆã€‚</p>
<p>å…¶å®Œæ•´ä»£ç å¦‚ä¸‹æ‰€ç¤ºï¼š</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">! pip install streamlit PyPDF2 dashscope faiss-cpu<br></code></pre></td></tr></table></figure>

<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">import</span> streamlit <span class="hljs-keyword">as</span> st<br><span class="hljs-keyword">from</span> PyPDF2 <span class="hljs-keyword">import</span> PdfReader<br><span class="hljs-keyword">from</span> langchain.text_splitter <span class="hljs-keyword">import</span> RecursiveCharacterTextSplitter<br><span class="hljs-keyword">from</span> langchain_core.prompts <span class="hljs-keyword">import</span> ChatPromptTemplate<br><span class="hljs-keyword">from</span> langchain_community.vectorstores <span class="hljs-keyword">import</span> FAISS<br><span class="hljs-keyword">from</span> langchain.tools.retriever <span class="hljs-keyword">import</span> create_retriever_tool<br><span class="hljs-keyword">from</span> langchain.agents <span class="hljs-keyword">import</span> AgentExecutor, create_tool_calling_agent<br><span class="hljs-keyword">from</span> langchain_community.embeddings <span class="hljs-keyword">import</span> DashScopeEmbeddings<br><span class="hljs-keyword">from</span> langchain.chat_models <span class="hljs-keyword">import</span> init_chat_model<br><span class="hljs-keyword">import</span> os<br><span class="hljs-keyword">from</span> dotenv <span class="hljs-keyword">import</span> load_dotenv<br><br>load_dotenv(override=<span class="hljs-literal">True</span>)<br><br>DeepSeek_API_KEY = os.getenv(<span class="hljs-string">&quot;DEEPSEEK_API_KEY&quot;</span>)<br>dashscope_api_key = os.getenv(<span class="hljs-string">&quot;dashscope_api_key&quot;</span>)<br><br>os.environ[<span class="hljs-string">&quot;KMP_DUPLICATE_LIB_OK&quot;</span>] = <span class="hljs-string">&quot;TRUE&quot;</span><br><br>embeddings = DashScopeEmbeddings(<br>    model=<span class="hljs-string">&quot;text-embedding-v1&quot;</span>, dashscope_api_key=dashscope_api_key<br>)<br><br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">pdf_read</span>(<span class="hljs-params">pdf_doc</span>):<br>    text = <span class="hljs-string">&quot;&quot;</span><br>    <span class="hljs-keyword">for</span> pdf <span class="hljs-keyword">in</span> pdf_doc:<br>        pdf_reader = PdfReader(pdf)<br>        <span class="hljs-keyword">for</span> page <span class="hljs-keyword">in</span> pdf_reader.pages:<br>            text += page.extract_text()<br>    <span class="hljs-keyword">return</span> text<br><br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">get_chunks</span>(<span class="hljs-params">text</span>):<br>    text_splitter = RecursiveCharacterTextSplitter(chunk_size=<span class="hljs-number">1000</span>, chunk_overlap=<span class="hljs-number">200</span>)<br>    chunks = text_splitter.split_text(text)<br>    <span class="hljs-keyword">return</span> chunks<br><br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">vector_store</span>(<span class="hljs-params">text_chunks</span>):<br>    vector_store = FAISS.from_texts(text_chunks, embedding=embeddings)<br>    vector_store.save_local(<span class="hljs-string">&quot;faiss_db&quot;</span>)<br><br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">get_conversational_chain</span>(<span class="hljs-params">tools, ques</span>):<br>    llm = init_chat_model(<span class="hljs-string">&quot;deepseek-chat&quot;</span>, model_provider=<span class="hljs-string">&quot;deepseek&quot;</span>)<br>    prompt = ChatPromptTemplate.from_messages([<br>        (<br>            <span class="hljs-string">&quot;system&quot;</span>,<br>            <span class="hljs-string">&quot;&quot;&quot;ä½ æ˜¯AIåŠ©æ‰‹ï¼Œè¯·æ ¹æ®æä¾›çš„ä¸Šä¸‹æ–‡å›ç­”é—®é¢˜ï¼Œç¡®ä¿æä¾›æ‰€æœ‰ç»†èŠ‚ï¼Œå¦‚æœç­”æ¡ˆä¸åœ¨ä¸Šä¸‹æ–‡ä¸­ï¼Œè¯·è¯´&quot;ç­”æ¡ˆä¸åœ¨ä¸Šä¸‹æ–‡ä¸­&quot;ï¼Œä¸è¦æä¾›é”™è¯¯çš„ç­”æ¡ˆ&quot;&quot;&quot;</span>,<br>        ),<br>        (<span class="hljs-string">&quot;placeholder&quot;</span>, <span class="hljs-string">&quot;&#123;chat_history&#125;&quot;</span>),<br>        (<span class="hljs-string">&quot;human&quot;</span>, <span class="hljs-string">&quot;&#123;input&#125;&quot;</span>),<br>        (<span class="hljs-string">&quot;placeholder&quot;</span>, <span class="hljs-string">&quot;&#123;agent_scratchpad&#125;&quot;</span>),<br>    ])<br><br>    tool = [tools]<br>    agent = create_tool_calling_agent(llm, tool, prompt)<br>    agent_executor = AgentExecutor(agent=agent, tools=tool, verbose=<span class="hljs-literal">True</span>)<br><br>    response = agent_executor.invoke(&#123;<span class="hljs-string">&quot;input&quot;</span>: ques&#125;)<br>    <span class="hljs-built_in">print</span>(response)<br>    st.write(<span class="hljs-string">&quot;ğŸ¤– å›ç­”: &quot;</span>, response[<span class="hljs-string">&#x27;output&#x27;</span>])<br><br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">check_database_exists</span>():<br>    <span class="hljs-string">&quot;&quot;&quot;æ£€æŸ¥FAISSæ•°æ®åº“æ˜¯å¦å­˜åœ¨&quot;&quot;&quot;</span><br>    <span class="hljs-keyword">return</span> os.path.exists(<span class="hljs-string">&quot;faiss_db&quot;</span>) <span class="hljs-keyword">and</span> os.path.exists(<span class="hljs-string">&quot;faiss_db/index.faiss&quot;</span>)<br><br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">user_input</span>(<span class="hljs-params">user_question</span>):<br>    <span class="hljs-comment"># æ£€æŸ¥æ•°æ®åº“æ˜¯å¦å­˜åœ¨</span><br>    <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> check_database_exists():<br>        st.error(<span class="hljs-string">&quot;âŒ è¯·å…ˆä¸Šä¼ PDFæ–‡ä»¶å¹¶ç‚¹å‡»&#x27;Submit &amp; Process&#x27;æŒ‰é’®æ¥å¤„ç†æ–‡æ¡£ï¼&quot;</span>)<br>        st.info(<span class="hljs-string">&quot;ğŸ’¡ æ­¥éª¤ï¼š1ï¸âƒ£ ä¸Šä¼ PDF â†’ 2ï¸âƒ£ ç‚¹å‡»å¤„ç† â†’ 3ï¸âƒ£ å¼€å§‹æé—®&quot;</span>)<br>        <span class="hljs-keyword">return</span><br><br>    <span class="hljs-keyword">try</span>:<br>        <span class="hljs-comment"># åŠ è½½FAISSæ•°æ®åº“</span><br>        new_db = FAISS.load_local(<span class="hljs-string">&quot;faiss_db&quot;</span>, embeddings, allow_dangerous_deserialization=<span class="hljs-literal">True</span>)<br><br>        retriever = new_db.as_retriever()<br>        retrieval_chain = create_retriever_tool(retriever, <span class="hljs-string">&quot;pdf_extractor&quot;</span>,<br>                                                <span class="hljs-string">&quot;This tool is to give answer to queries from the pdf&quot;</span>)<br>        get_conversational_chain(retrieval_chain, user_question)<br><br>    <span class="hljs-keyword">except</span> Exception <span class="hljs-keyword">as</span> e:<br>        st.error(<span class="hljs-string">f&quot;âŒ åŠ è½½æ•°æ®åº“æ—¶å‡ºé”™: <span class="hljs-subst">&#123;<span class="hljs-built_in">str</span>(e)&#125;</span>&quot;</span>)<br>        st.info(<span class="hljs-string">&quot;è¯·é‡æ–°å¤„ç†PDFæ–‡ä»¶&quot;</span>)<br><br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">main</span>():<br>    st.set_page_config(<span class="hljs-string">&quot;ğŸ¤– LangChain Bç«™å…¬å¼€è¯¾ Byä¹å¤©Hector&quot;</span>)<br>    st.header(<span class="hljs-string">&quot;ğŸ¤– LangChain Bç«™å…¬å¼€è¯¾ Byä¹å¤©Hector&quot;</span>)<br><br>    <span class="hljs-comment"># æ˜¾ç¤ºæ•°æ®åº“çŠ¶æ€</span><br>    col1, col2 = st.columns([<span class="hljs-number">3</span>, <span class="hljs-number">1</span>])<br><br>    <span class="hljs-keyword">with</span> col1:<br>        <span class="hljs-keyword">if</span> check_database_exists():<br>            <span class="hljs-keyword">pass</span><br>        <span class="hljs-keyword">else</span>:<br>            st.warning(<span class="hljs-string">&quot;âš ï¸ è¯·å…ˆä¸Šä¼ å¹¶å¤„ç†PDFæ–‡ä»¶&quot;</span>)<br><br><br><span class="hljs-keyword">with</span> col2:<br>    <span class="hljs-keyword">if</span> st.button(<span class="hljs-string">&quot;ğŸ—‘ï¸ æ¸…é™¤æ•°æ®åº“&quot;</span>):<br>        <span class="hljs-keyword">try</span>:<br>            <span class="hljs-keyword">import</span> shutil<br><br>            <span class="hljs-keyword">if</span> os.path.exists(<span class="hljs-string">&quot;faiss_db&quot;</span>):<br>                shutil.rmtree(<span class="hljs-string">&quot;faiss_db&quot;</span>)<br>            st.success(<span class="hljs-string">&quot;æ•°æ®åº“å·²æ¸…é™¤&quot;</span>)<br>            st.rerun()<br>        <span class="hljs-keyword">except</span> Exception <span class="hljs-keyword">as</span> e:<br>            st.error(<span class="hljs-string">f&quot;æ¸…é™¤å¤±è´¥: <span class="hljs-subst">&#123;e&#125;</span>&quot;</span>)<br><br><span class="hljs-comment"># ç”¨æˆ·é—®é¢˜è¾“å…¥</span><br>user_question = st.text_input(<span class="hljs-string">&quot;ğŸ’¬ è¯·è¾“å…¥é—®é¢˜&quot;</span>,<br>                              placeholder=<span class="hljs-string">&quot;ä¾‹å¦‚ï¼šè¿™ä¸ªæ–‡æ¡£çš„ä¸»è¦å†…å®¹æ˜¯ä»€ä¹ˆï¼Ÿ&quot;</span>,<br>                              disabled=<span class="hljs-keyword">not</span> check_database_exists())<br><br><span class="hljs-keyword">if</span> user_question:<br>    <span class="hljs-keyword">if</span> check_database_exists():<br>        <span class="hljs-keyword">with</span> st.spinner(<span class="hljs-string">&quot;ğŸ¤” AIæ­£åœ¨åˆ†ææ–‡æ¡£...&quot;</span>):<br>            user_input(user_question)<br>    <span class="hljs-keyword">else</span>:<br>        st.error(<span class="hljs-string">&quot;âŒ è¯·å…ˆä¸Šä¼ å¹¶å¤„ç†PDFæ–‡ä»¶ï¼&quot;</span>)<br><br><span class="hljs-comment"># ä¾§è¾¹æ </span><br><span class="hljs-keyword">with</span> st.sidebar:<br>    st.title(<span class="hljs-string">&quot;ğŸ“ æ–‡æ¡£ç®¡ç†&quot;</span>)<br><br>    <span class="hljs-comment"># æ˜¾ç¤ºå½“å‰çŠ¶æ€</span><br>    <span class="hljs-keyword">if</span> check_database_exists():<br>        st.success(<span class="hljs-string">&quot;âœ… æ•°æ®åº“çŠ¶æ€ï¼šå·²å°±ç»ª&quot;</span>)<br>    <span class="hljs-keyword">else</span>:<br>        st.info(<span class="hljs-string">&quot;ğŸ“ çŠ¶æ€ï¼šç­‰å¾…ä¸Šä¼ PDF&quot;</span>)<br><br>    st.markdown(<span class="hljs-string">&quot;---&quot;</span>)<br><br>    <span class="hljs-comment"># æ–‡ä»¶ä¸Šä¼ </span><br>    pdf_doc = st.file_uploader(<br>        <span class="hljs-string">&quot;ğŸ“ ä¸Šä¼ PDFæ–‡ä»¶&quot;</span>,<br>        accept_multiple_files=<span class="hljs-literal">True</span>,<br>        <span class="hljs-built_in">type</span>=[<span class="hljs-string">&#x27;pdf&#x27;</span>],<br>        <span class="hljs-built_in">help</span>=<span class="hljs-string">&quot;æ”¯æŒä¸Šä¼ å¤šä¸ªPDFæ–‡ä»¶&quot;</span><br>    )<br><br>    <span class="hljs-keyword">if</span> pdf_doc:<br>        st.info(<span class="hljs-string">f&quot;ğŸ“„ å·²é€‰æ‹© <span class="hljs-subst">&#123;<span class="hljs-built_in">len</span>(pdf_doc)&#125;</span> ä¸ªæ–‡ä»¶&quot;</span>)<br>        <span class="hljs-keyword">for</span> i, pdf <span class="hljs-keyword">in</span> <span class="hljs-built_in">enumerate</span>(pdf_doc, <span class="hljs-number">1</span>):<br>            st.write(<span class="hljs-string">f&quot;<span class="hljs-subst">&#123;i&#125;</span>. <span class="hljs-subst">&#123;pdf.name&#125;</span>&quot;</span>)<br><br>    <span class="hljs-comment"># å¤„ç†æŒ‰é’®</span><br>    process_button = st.button(<br>        <span class="hljs-string">&quot;ğŸš€ æäº¤å¹¶å¤„ç†&quot;</span>,<br>        disabled=<span class="hljs-keyword">not</span> pdf_doc,<br>        use_container_width=<span class="hljs-literal">True</span><br>    )<br><br>    <span class="hljs-keyword">if</span> process_button:<br>        <span class="hljs-keyword">if</span> pdf_doc:<br>            <span class="hljs-keyword">with</span> st.spinner(<span class="hljs-string">&quot;ğŸ“Š æ­£åœ¨å¤„ç†PDFæ–‡ä»¶...&quot;</span>):<br>                <span class="hljs-keyword">try</span>:<br>                    <span class="hljs-comment"># è¯»å–PDFå†…å®¹</span><br>                    raw_text = pdf_read(pdf_doc)<br><br>                    <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> raw_text.strip():<br>                        st.error(<span class="hljs-string">&quot;âŒ æ— æ³•ä»PDFä¸­æå–æ–‡æœ¬ï¼Œè¯·æ£€æŸ¥æ–‡ä»¶æ˜¯å¦æœ‰æ•ˆ&quot;</span>)<br>                        <span class="hljs-keyword">return</span><br><br>                    <span class="hljs-comment"># åˆ†å‰²æ–‡æœ¬</span><br>                    text_chunks = get_chunks(raw_text)<br>                    st.info(<span class="hljs-string">f&quot;ğŸ“ æ–‡æœ¬å·²åˆ†å‰²ä¸º <span class="hljs-subst">&#123;<span class="hljs-built_in">len</span>(text_chunks)&#125;</span> ä¸ªç‰‡æ®µ&quot;</span>)<br><br>                    <span class="hljs-comment"># åˆ›å»ºå‘é‡æ•°æ®åº“</span><br>                    vector_store(text_chunks)<br><br>                    st.success(<span class="hljs-string">&quot;âœ… PDFå¤„ç†å®Œæˆï¼ç°åœ¨å¯ä»¥å¼€å§‹æé—®äº†&quot;</span>)<br>                    st.balloons()<br>                    st.rerun()<br><br>                <span class="hljs-keyword">except</span> Exception <span class="hljs-keyword">as</span> e:<br>                    st.error(<span class="hljs-string">f&quot;âŒ å¤„ç†PDFæ—¶å‡ºé”™: <span class="hljs-subst">&#123;<span class="hljs-built_in">str</span>(e)&#125;</span>&quot;</span>)<br>        <span class="hljs-keyword">else</span>:<br>            st.warning(<span class="hljs-string">&quot;âš ï¸ è¯·å…ˆé€‰æ‹©PDFæ–‡ä»¶&quot;</span>)<br><br>    <span class="hljs-comment"># ä½¿ç”¨è¯´æ˜</span><br>    <span class="hljs-keyword">with</span> st.expander(<span class="hljs-string">&quot;ğŸ’¡ ä½¿ç”¨è¯´æ˜&quot;</span>):<br>        st.markdown(<span class="hljs-string">&quot;&quot;&quot;</span><br><span class="hljs-string">                **æ­¥éª¤ï¼š**</span><br><span class="hljs-string">                1. ğŸ“ ä¸Šä¼ ä¸€ä¸ªæˆ–å¤šä¸ªPDFæ–‡ä»¶</span><br><span class="hljs-string">                2. ğŸš€ ç‚¹å‡»&quot;Submit &amp; Process&quot;å¤„ç†æ–‡æ¡£</span><br><span class="hljs-string">                3. ğŸ’¬ åœ¨ä¸»é¡µé¢è¾“å…¥æ‚¨çš„é—®é¢˜</span><br><span class="hljs-string">                4. ğŸ¤– AIå°†åŸºäºPDFå†…å®¹å›ç­”é—®é¢˜</span><br><span class="hljs-string"></span><br><span class="hljs-string">                **æç¤ºï¼š**</span><br><span class="hljs-string">                - æ”¯æŒå¤šä¸ªPDFæ–‡ä»¶åŒæ—¶ä¸Šä¼ </span><br><span class="hljs-string">                - å¤„ç†å¤§æ–‡ä»¶å¯èƒ½éœ€è¦ä¸€äº›æ—¶é—´</span><br><span class="hljs-string">                - å¯ä»¥éšæ—¶æ¸…é™¤æ•°æ®åº“é‡æ–°å¼€å§‹</span><br><span class="hljs-string">                &quot;&quot;&quot;</span>)<br><br><span class="hljs-keyword">if</span> __name__ == <span class="hljs-string">&quot;__main__&quot;</span>:<br>    main()<br></code></pre></td></tr></table></figure>

<p>åŸºäºæ­¤ï¼Œæˆ‘ä»¬èƒ½å¤Ÿå®ç°ï¼š</p>
<ul>
<li><strong>LangChain çš„å¤šæ¨¡å—èƒ½åŠ›</strong>ï¼ˆå‘é‡æœç´¢ + Agentå·¥å…·ï¼‰</li>
<li><strong>Streamlit å‰ç«¯äº¤äº’</strong></li>
<li><strong>FAISS å‘é‡æ•°æ®åº“</strong></li>
<li><strong>DashScope Embedding + DeepSeek æ¨¡å‹æ¥å…¥</strong></li>
<li>å¹¶å®Œæˆäº†å®Œæ•´çš„ RAGï¼ˆæ£€ç´¢å¢å¼ºç”Ÿæˆï¼‰æµç¨‹</li>
</ul>
<p>ä»¥ä¸‹æ˜¯å„éƒ¨åˆ†åŠŸèƒ½å®ç°ä»£ç è®²è§£ï¼š</p>
<p>ğŸ”§ 1. å¯¼å…¥åº“ &amp; ç¯å¢ƒåˆå§‹åŒ–</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">import</span> streamlit <span class="hljs-keyword">as</span> st<br><span class="hljs-keyword">from</span> PyPDF2 <span class="hljs-keyword">import</span> PdfReader<br><span class="hljs-keyword">from</span> langchain.text_splitter <span class="hljs-keyword">import</span> RecursiveCharacterTextSplitter<br>...<br>load_dotenv(override=<span class="hljs-literal">True</span>)<br></code></pre></td></tr></table></figure>

<ul>
<li><p><code>Streamlit</code> ç”¨äºæ„å»ºç½‘é¡µç•Œé¢ã€‚</p>
</li>
<li><p><code>PyPDF2</code> ç”¨æ¥è¯»å– PDF æ–‡æœ¬ã€‚</p>
</li>
<li><p><code>load_dotenv()</code> åŠ è½½ <code>.env</code> ä¸­çš„ API Keyï¼Œä¾‹å¦‚ï¼š</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs dotenv">DEEPSEEK_API_KEY=sk-xxx<br>DASHSCOPE_API_KEY=xxx<br></code></pre></td></tr></table></figure></li>
</ul>
<hr>
<p>ğŸ” 2. åŠ è½½ API å¯†é’¥ä¸è®¾ç½®ç¯å¢ƒå˜é‡</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs python">DeepSeek_API_KEY = os.getenv(<span class="hljs-string">&quot;DEEPSEEK_API_KEY&quot;</span>)<br>dashscope_api_key = os.getenv(<span class="hljs-string">&quot;dashscope_api_key&quot;</span>)<br>os.environ[<span class="hljs-string">&quot;KMP_DUPLICATE_LIB_OK&quot;</span>]=<span class="hljs-string">&quot;TRUE&quot;</span><br></code></pre></td></tr></table></figure>

<ul>
<li>ä»ç¯å¢ƒå˜é‡ä¸­è¯»å– DashScope å’Œ DeepSeek APIã€‚</li>
<li>è®¾ç½® <code>KMP_DUPLICATE_LIB_OK</code> é¿å…æŸäº› MKL å¤šçº¿ç¨‹æŠ¥é”™ã€‚</li>
</ul>
<hr>
<p>ğŸ§  3. åˆå§‹åŒ–å‘é‡ Embedding æ¨¡å‹</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs python">embeddings = DashScopeEmbeddings(<br>    model=<span class="hljs-string">&quot;text-embedding-v1&quot;</span>, dashscope_api_key=dashscope_api_key<br>)<br></code></pre></td></tr></table></figure>

<ul>
<li>ç”¨é˜¿é‡Œäº‘ DashScope æä¾›çš„ <code>text-embedding-v1</code> å°†æ–‡æœ¬è½¬ä¸ºå‘é‡è¡¨ç¤ºï¼Œç”¨äºç›¸ä¼¼åº¦æœç´¢ã€‚</li>
</ul>
<hr>
<p>ğŸ“„ 4. å¤„ç† PDF æ–‡æœ¬ä¸å‘é‡åŒ–é€»è¾‘</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">def</span> <span class="hljs-title function_">pdf_read</span>(<span class="hljs-params">pdf_doc</span>):<br>    ...<br><span class="hljs-keyword">def</span> <span class="hljs-title function_">get_chunks</span>(<span class="hljs-params">text</span>):<br>    ...<br><span class="hljs-keyword">def</span> <span class="hljs-title function_">vector_store</span>(<span class="hljs-params">text_chunks</span>):<br>    ...<br></code></pre></td></tr></table></figure>

<ul>
<li><code>pdf_read</code>ï¼šé€é¡µè¯»å– PDF å†…å®¹å¹¶æ‹¼æ¥ã€‚</li>
<li><code>get_chunks</code>ï¼šå°†é•¿æ–‡æœ¬åˆ‡ç‰‡ä¸ºå¤šä¸ªæ®µè½ï¼ˆchunkï¼‰ï¼Œæ¯æ®µ 1000 å­—ï¼Œé‡å  200 å­—ã€‚</li>
<li><code>vector_store</code>ï¼šç”¨ FAISS å»ºç«‹å‘é‡ç´¢å¼•ï¼Œå¹¶ä¿å­˜åˆ°æœ¬åœ° <code>faiss_db/</code>ã€‚</li>
</ul>
<hr>
<p>ğŸ” 5. Agentå¯¹è¯é“¾ + å·¥å…·è°ƒç”¨ï¼ˆæ ¸å¿ƒ RAGï¼‰</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">def</span> <span class="hljs-title function_">get_conversational_chain</span>(<span class="hljs-params">tools, ques</span>):<br>    llm = init_chat_model(<span class="hljs-string">&quot;deepseek-chat&quot;</span>, model_provider=<span class="hljs-string">&quot;deepseek&quot;</span>)<br>    ...<br>    agent_executor = AgentExecutor(...)<br>    response = agent_executor.invoke(&#123;<span class="hljs-string">&quot;input&quot;</span>: ques&#125;)<br>    ...<br></code></pre></td></tr></table></figure>

<ul>
<li><p>åˆå§‹åŒ– DeepSeek æ¨¡å‹ä¸º Agentã€‚</p>
</li>
<li><p>ä½¿ç”¨ LangChain çš„ <code>create_tool_calling_agent</code> æ„é€  Agentï¼Œè¾“å…¥ï¼š</p>
<ul>
<li>promptï¼ˆä½ è®¾å®šçš„ç³»ç»Ÿè§’è‰²ï¼‰</li>
<li>å·¥å…·ï¼ˆretriever å·¥å…·ï¼‰</li>
</ul>
</li>
<li><p><code>AgentExecutor.invoke</code>ï¼šLangChain è‡ªåŠ¨åˆ¤æ–­æ˜¯å¦è°ƒç”¨å·¥å…·ï¼Œå®Œæˆâ€œè¯»å–ä¸Šä¸‹æ–‡ â†’ æŸ¥è¯¢ â†’ å›ç­”â€æµç¨‹ã€‚</p>
</li>
</ul>
<hr>
<p>ğŸ” 6. ç”¨æˆ·æé—®é€»è¾‘ï¼ˆè°ƒç”¨ FAISSï¼‰</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">def</span> <span class="hljs-title function_">user_input</span>(<span class="hljs-params">user_question</span>):<br>    ...<br>    new_db = FAISS.load_local(<span class="hljs-string">&quot;faiss_db&quot;</span>, embeddings, ...)<br>    retriever = new_db.as_retriever()<br>    retrieval_chain = create_retriever_tool(retriever, <span class="hljs-string">&quot;pdf_extractor&quot;</span>, ...)<br>    get_conversational_chain(retrieval_chain, user_question)<br></code></pre></td></tr></table></figure>

<ul>
<li>åŠ è½½æœ¬åœ° FAISS å‘é‡åº“ï¼›</li>
<li>å°†å…¶è½¬ä¸º LangChain çš„æ£€ç´¢å·¥å…·ï¼›</li>
<li>äº¤ç”± Agent è°ƒç”¨å®Œæˆå›ç­”ã€‚</li>
</ul>
<hr>
<p>ğŸ§  7. æ£€æŸ¥æ•°æ®åº“æ˜¯å¦å­˜åœ¨</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">def</span> <span class="hljs-title function_">check_database_exists</span>():<br>    <span class="hljs-keyword">return</span> os.path.exists(<span class="hljs-string">&quot;faiss_db&quot;</span>) <span class="hljs-keyword">and</span> os.path.exists(<span class="hljs-string">&quot;faiss_db/index.faiss&quot;</span>)<br></code></pre></td></tr></table></figure>

<p>ç®€å•æ£€æŸ¥æœ¬åœ°æ˜¯å¦å·²æœ‰å‘é‡åŒ–æ•°æ®ã€‚</p>
<hr>
<p>ğŸŒ 8. ä¸»ç•Œé¢é€»è¾‘ï¼ˆStreamlitï¼‰</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">def</span> <span class="hljs-title function_">main</span>():<br>    st.set_page_config(...)<br>    ...<br></code></pre></td></tr></table></figure>

<ul>
<li><p>é¡µé¢æ ‡é¢˜ä¸ç•Œé¢é…ç½®ã€‚</p>
</li>
<li><p><code>st.columns</code> åˆ†æ ï¼šå·¦è¾¹æ˜¾ç¤ºæç¤ºï¼Œå³è¾¹æ”¾ç½®â€œæ¸…ç©ºæ•°æ®åº“â€æŒ‰é’®ã€‚</p>
</li>
<li><p>ä¸»è¾“å…¥æ¡†ï¼š<code>st.text_input(&quot;è¯·è¾“å…¥é—®é¢˜&quot;)</code></p>
<ul>
<li>åªæœ‰å½“æ•°æ®åº“å­˜åœ¨æ—¶æ‰èƒ½æé—®ã€‚</li>
</ul>
</li>
<li><p>ä¾§è¾¹æ ï¼š</p>
<ul>
<li>PDF ä¸Šä¼ å™¨ï¼›</li>
<li>æäº¤æŒ‰é’®ï¼ˆå¤„ç†ä¸Šä¼ çš„ PDF â†’ åˆ†ç‰‡ â†’ å‘é‡åŒ– â†’ å­˜å‚¨ï¼‰ã€‚</li>
</ul>
</li>
</ul>
<hr>
<p>ğŸ¯ 9. æäº¤ PDF åæ‰§è¡Œçš„é€»è¾‘</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">if</span> process_button:<br>    raw_text = pdf_read(pdf_doc)<br>    ...<br>    text_chunks = get_chunks(raw_text)<br>    vector_store(text_chunks)<br></code></pre></td></tr></table></figure>

<ul>
<li><p>å½“ç‚¹å‡»â€œæäº¤å¹¶å¤„ç†â€åï¼š</p>
<ol>
<li>è¯»å–ä¸Šä¼ çš„ PDFï¼›</li>
<li>åˆ‡ç‰‡æ–‡æœ¬ï¼›</li>
<li>å‘é‡åŒ–å…¥åº“ï¼›</li>
<li>å¼¹å‡ºæ°”çƒæç¤ºï¼Œå¹¶ <code>st.rerun()</code> åˆ·æ–°é¡µé¢çŠ¶æ€ã€‚</li>
</ol>
</li>
</ul>
<hr>
<p>ğŸ“ é¡¹ç›®ç»“æ„æ€»ç»“</p>
<table>
<thead>
<tr>
<th>æ¨¡å—</th>
<th>è¯´æ˜</th>
</tr>
</thead>
<tbody><tr>
<td>ğŸ§¾ PDFè§£æ</td>
<td>è¯»å–ç”¨æˆ·ä¸Šä¼ çš„ PDF</td>
</tr>
<tr>
<td>âœ‚ï¸ æ–‡æœ¬åˆ‡ç‰‡</td>
<td>æŒ‰æ®µè½åˆ†å‰²å†…å®¹</td>
</tr>
<tr>
<td>ğŸ“Š å‘é‡åŒ–</td>
<td>DashScope Embedding + FAISS å»ºåº“</td>
</tr>
<tr>
<td>ğŸ” æŸ¥è¯¢æ¥å£</td>
<td>ç”¨æˆ·è¾“å…¥ â†’ å¬å›ç›¸å…³ chunk</td>
</tr>
<tr>
<td>ğŸ¤– DeepSeek Agent</td>
<td>è°ƒç”¨æ£€ç´¢å·¥å…·å¹¶ç»™å‡ºå›ç­”</td>
</tr>
<tr>
<td>ğŸ’» UIå±‚</td>
<td>Streamlit å®ç°å…¨éƒ¨äº¤äº’</td>
</tr>
</tbody></table>
<p>å…¶ä¸­<code>LangChain RAG</code>æ ¸å¿ƒåŠŸèƒ½ç›¸å…³ä»£ç å¦‚ä¸‹ï¼š</p>
<p>Step 1ï¼šPDF æ–‡ä»¶ä¸Šä¼ ä¸æ–‡æœ¬æå–</p>
<p>ä½¿ç”¨ <code>st.file_uploader()</code> ç»„ä»¶æ”¯æŒå¤šæ–‡ä»¶ä¸Šä¼ ï¼Œå¹¶é€šè¿‡ <code>PyPDF2.PdfReader</code> å¯¹æ¯é¡µå†…å®¹è¿›è¡Œæå–ï¼Œç»„åˆä¸ºæ•´ä½“æ–‡æœ¬ã€‚</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">def</span> <span class="hljs-title function_">pdf_read</span>(<span class="hljs-params">pdf_doc</span>):<br>    text = <span class="hljs-string">&quot;&quot;</span><br>    <span class="hljs-keyword">for</span> pdf <span class="hljs-keyword">in</span> pdf_doc:<br>        pdf_reader = PdfReader(pdf)<br>        <span class="hljs-keyword">for</span> page <span class="hljs-keyword">in</span> pdf_reader.pages:<br>            text += page.extract_text()<br>    <span class="hljs-keyword">return</span> text<br></code></pre></td></tr></table></figure>

<p>Step 2ï¼šæ–‡æœ¬åˆ†å—ä¸å‘é‡æ•°æ®åº“æ„å»º</p>
<p>ä½¿ç”¨ <code>RecursiveCharacterTextSplitter</code> å°†é•¿æ–‡æ¡£åˆ‡å‰²ä¸ºå›ºå®šé•¿åº¦ï¼ˆ1000å­—ï¼‰+ é‡å ï¼ˆ200å­—ï¼‰çš„å°å—ï¼Œå°†æ–‡æœ¬å—é€šè¿‡ <code>DashScopeEmbeddings</code> åµŒå…¥ä¸ºå‘é‡ï¼Œä½¿ç”¨ <code>FAISS</code> æœ¬åœ°å­˜å‚¨å‘é‡æ•°æ®åº“ã€‚</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs python">chunks = text_splitter.split_text(text)<br>vector_store = FAISS.from_texts(chunks, embedding=embeddings)<br>vector_store.save_local(<span class="hljs-string">&quot;faiss_db&quot;</span>)<br></code></pre></td></tr></table></figure>

<p>Step 3ï¼šç”¨æˆ·æé—®ä¸è¯­ä¹‰æ£€ç´¢</p>
<p>é€šè¿‡ <code>Streamlit</code> è·å–ç”¨æˆ·è¾“å…¥é—®é¢˜ï¼Œå¦‚æœå‘é‡æ•°æ®åº“å­˜åœ¨ï¼Œåˆ™åŠ è½½ <code>FAISS</code> æ£€ç´¢å™¨ï¼Œä½¿ç”¨ <code>create_retriever_tool()</code> æ„å»º <code>LangChain</code> å·¥å…·ï¼Œäº¤ç”± <code>AgentExecutor</code> æ‰§è¡Œï¼Œè‡ªåŠ¨è°ƒç”¨æ£€ç´¢å™¨å¹¶ç”Ÿæˆç­”æ¡ˆã€‚</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs python">retrieval_chain = create_retriever_tool(retriever, ...)<br>agent = create_tool_calling_agent(llm, [retrieval_chain], prompt)<br>response = agent_executor.invoke(&#123;<span class="hljs-string">&quot;input&quot;</span>: ques&#125;)<br></code></pre></td></tr></table></figure>

<p>ä¸‹é¢å†<strong>åŸºäºLangChainæ­å»ºAIæ•°æ®åˆ†ææ™ºèƒ½ä½“Data Agent</strong></p>
<p>æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬è¿›ä¸€æ­¥ä¸°å¯Œæ™ºèƒ½é—®ç­”ç³»ç»Ÿçš„åŠŸèƒ½ï¼Œæ¥ä¸‹æ¥çš„æ¡ˆä¾‹ä¸­ï¼Œæˆ‘ä»¬æ„å»ºä¸€ä¸ªåŸºäº <code>Streamlit + LangChain + DashScope + DeepSeek</code> çš„æ™ºèƒ½åŒ–æ•°æ®åˆ†æåŠ©æ‰‹ï¼Œèåˆä¸¤ä¸ªå…¸å‹çš„ä¼ä¸šçº§å¤§æ¨¡å‹åº”ç”¨åœºæ™¯ï¼š</p>
<ul>
<li><p>PDF æ™ºèƒ½é—®ç­”ï¼šæ”¯æŒä¸Šä¼ å¤šä¸ª PDF æ–‡æ¡£ï¼Œè‡ªåŠ¨å®Œæˆå†…å®¹æå–ã€æ–‡æœ¬åˆ‡å—ã€è¯­ä¹‰å‘é‡åŒ–ï¼Œå¹¶æ„å»º FAISS æœ¬åœ°æ£€ç´¢åº“ï¼Œç»“åˆå¤§æ¨¡å‹è¿›è¡Œé—®ç­”ï¼›</p>
</li>
<li><p>CSV æ•°æ®æ™ºèƒ½åˆ†æï¼šé€šè¿‡è‡ªç„¶è¯­è¨€æŒ‡ä»¤åˆ†æç»“æ„åŒ–æ•°æ®ï¼ŒåŒ…æ‹¬ç»Ÿè®¡æŸ¥è¯¢ã€ä»£ç ç”Ÿæˆä¸å›¾è¡¨ç»˜åˆ¶ï¼›</p>
</li>
</ul>
<p>å®Œæ•´ä»£ç å¦‚ä¸‹æ‰€ç¤ºï¼š</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">pip install langchain_experimental matplotlib tabulate<br></code></pre></td></tr></table></figure>

<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">import</span> streamlit <span class="hljs-keyword">as</span> st<br><span class="hljs-keyword">import</span> pandas <span class="hljs-keyword">as</span> pd<br><span class="hljs-keyword">import</span> os<br><span class="hljs-keyword">from</span> PyPDF2 <span class="hljs-keyword">import</span> PdfReader<br><span class="hljs-keyword">from</span> langchain.text_splitter <span class="hljs-keyword">import</span> RecursiveCharacterTextSplitter<br><span class="hljs-keyword">from</span> langchain_core.prompts <span class="hljs-keyword">import</span> ChatPromptTemplate<br><span class="hljs-keyword">from</span> langchain_community.vectorstores <span class="hljs-keyword">import</span> FAISS<br><span class="hljs-keyword">from</span> langchain.tools.retriever <span class="hljs-keyword">import</span> create_retriever_tool<br><span class="hljs-keyword">from</span> langchain.agents <span class="hljs-keyword">import</span> AgentExecutor, create_tool_calling_agent<br><span class="hljs-keyword">from</span> langchain_community.embeddings <span class="hljs-keyword">import</span> DashScopeEmbeddings<br><span class="hljs-keyword">from</span> langchain.chat_models <span class="hljs-keyword">import</span> init_chat_model<br><span class="hljs-keyword">from</span> langchain_experimental.tools <span class="hljs-keyword">import</span> PythonAstREPLTool<br><span class="hljs-keyword">import</span> matplotlib<br><br>matplotlib.use(<span class="hljs-string">&#x27;Agg&#x27;</span>)<br><span class="hljs-keyword">import</span> os<br><span class="hljs-keyword">from</span> dotenv <span class="hljs-keyword">import</span> load_dotenv<br><br>load_dotenv(override=<span class="hljs-literal">True</span>)<br><br>DeepSeek_API_KEY = os.getenv(<span class="hljs-string">&quot;DEEPSEEK_API_KEY&quot;</span>)<br>dashscope_api_key = os.getenv(<span class="hljs-string">&quot;dashscope_api_key&quot;</span>)<br><br><span class="hljs-comment"># è®¾ç½®ç¯å¢ƒå˜é‡</span><br>os.environ[<span class="hljs-string">&quot;KMP_DUPLICATE_LIB_OK&quot;</span>] = <span class="hljs-string">&quot;TRUE&quot;</span><br><br><span class="hljs-comment"># é¡µé¢é…ç½®</span><br>st.set_page_config(<br>    page_title=<span class="hljs-string">&quot;Byä¹å¤©Hector&quot;</span>,<br>    page_icon=<span class="hljs-string">&quot;ğŸ¤–&quot;</span>,<br>    layout=<span class="hljs-string">&quot;wide&quot;</span>,<br>    initial_sidebar_state=<span class="hljs-string">&quot;expanded&quot;</span><br>)<br><br><span class="hljs-comment"># è‡ªå®šä¹‰CSSæ ·å¼</span><br>st.markdown(<span class="hljs-string">&quot;&quot;&quot;</span><br><span class="hljs-string">    &lt;style&gt;</span><br><span class="hljs-string">        /* ä¸»é¢˜è‰²å½© */</span><br><span class="hljs-string">        :root &#123;</span><br><span class="hljs-string">            --primary-color: #1f77b4;</span><br><span class="hljs-string">            --secondary-color: #ff7f0e;</span><br><span class="hljs-string">            --success-color: #2ca02c;</span><br><span class="hljs-string">            --warning-color: #ff9800;</span><br><span class="hljs-string">            --error-color: #d62728;</span><br><span class="hljs-string">            --background-color: #f8f9fa;</span><br><span class="hljs-string">        &#125;</span><br><span class="hljs-string"></span><br><span class="hljs-string">        /* éšè—é»˜è®¤çš„Streamlitæ ·å¼ */</span><br><span class="hljs-string">        #MainMenu &#123;visibility: hidden;&#125;</span><br><span class="hljs-string">        footer &#123;visibility: hidden;&#125;</span><br><span class="hljs-string">        header &#123;visibility: hidden;&#125;</span><br><span class="hljs-string"></span><br><span class="hljs-string">        /* æ ‡é¢˜æ ·å¼ */</span><br><span class="hljs-string">        .main-header &#123;</span><br><span class="hljs-string">            background: linear-gradient(90deg, #1f77b4, #ff7f0e);</span><br><span class="hljs-string">            -webkit-background-clip: text;</span><br><span class="hljs-string">            -webkit-text-fill-color: transparent;</span><br><span class="hljs-string">            font-size: 3rem;</span><br><span class="hljs-string">            font-weight: bold;</span><br><span class="hljs-string">            text-align: center;</span><br><span class="hljs-string">            margin-bottom: 2rem;</span><br><span class="hljs-string">        &#125;</span><br><span class="hljs-string"></span><br><span class="hljs-string">        /* å¡ç‰‡æ ·å¼ */</span><br><span class="hljs-string">        .info-card &#123;</span><br><span class="hljs-string">            background: white;</span><br><span class="hljs-string">            padding: 1.5rem;</span><br><span class="hljs-string">            border-radius: 10px;</span><br><span class="hljs-string">            box-shadow: 0 2px 10px rgba(0,0,0,0.1);</span><br><span class="hljs-string">            margin: 1rem 0;</span><br><span class="hljs-string">            border-left: 4px solid var(--primary-color);</span><br><span class="hljs-string">        &#125;</span><br><span class="hljs-string"></span><br><span class="hljs-string">        .success-card &#123;</span><br><span class="hljs-string">            background: linear-gradient(135deg, #e8f5e8, #f0f8f0);</span><br><span class="hljs-string">            border-left: 4px solid var(--success-color);</span><br><span class="hljs-string">        &#125;</span><br><span class="hljs-string"></span><br><span class="hljs-string">        .warning-card &#123;</span><br><span class="hljs-string">            background: linear-gradient(135deg, #fff8e1, #fffbf0);</span><br><span class="hljs-string">            border-left: 4px solid var(--warning-color);</span><br><span class="hljs-string">        &#125;</span><br><span class="hljs-string"></span><br><span class="hljs-string">        /* æŒ‰é’®æ ·å¼ */</span><br><span class="hljs-string">        .stButton &gt; button &#123;</span><br><span class="hljs-string">            background: linear-gradient(45deg, #1f77b4, #2196F3);</span><br><span class="hljs-string">            color: white;</span><br><span class="hljs-string">            border: none;</span><br><span class="hljs-string">            border-radius: 8px;</span><br><span class="hljs-string">            padding: 0.5rem 1rem;</span><br><span class="hljs-string">            font-weight: 600;</span><br><span class="hljs-string">            transition: all 0.3s ease;</span><br><span class="hljs-string">            box-shadow: 0 2px 8px rgba(31, 119, 180, 0.3);</span><br><span class="hljs-string">        &#125;</span><br><span class="hljs-string"></span><br><span class="hljs-string">        .stButton &gt; button:hover &#123;</span><br><span class="hljs-string">            transform: translateY(-2px);</span><br><span class="hljs-string">            box-shadow: 0 4px 12px rgba(31, 119, 180, 0.4);</span><br><span class="hljs-string">        &#125;</span><br><span class="hljs-string"></span><br><span class="hljs-string">        /* Tabæ ·å¼ */</span><br><span class="hljs-string">        .stTabs [data-baseweb=&quot;tab-list&quot;] &#123;</span><br><span class="hljs-string">            gap: 8px;</span><br><span class="hljs-string">            background-color: #f8f9fa;</span><br><span class="hljs-string">            border-radius: 10px;</span><br><span class="hljs-string">            padding: 0.5rem;</span><br><span class="hljs-string">        &#125;</span><br><span class="hljs-string"></span><br><span class="hljs-string">        .stTabs [data-baseweb=&quot;tab&quot;] &#123;</span><br><span class="hljs-string">            height: 60px;</span><br><span class="hljs-string">            background-color: white;</span><br><span class="hljs-string">            border-radius: 8px;</span><br><span class="hljs-string">            padding: 0 24px;</span><br><span class="hljs-string">            font-weight: 600;</span><br><span class="hljs-string">            border: 2px solid transparent;</span><br><span class="hljs-string">            transition: all 0.3s ease;</span><br><span class="hljs-string">        &#125;</span><br><span class="hljs-string"></span><br><span class="hljs-string">        .stTabs [aria-selected=&quot;true&quot;] &#123;</span><br><span class="hljs-string">            background: linear-gradient(45deg, #1f77b4, #2196F3);</span><br><span class="hljs-string">            color: white !important;</span><br><span class="hljs-string">            border: 2px solid #1f77b4;</span><br><span class="hljs-string">        &#125;</span><br><span class="hljs-string"></span><br><span class="hljs-string">        /* ä¾§è¾¹æ æ ·å¼ */</span><br><span class="hljs-string">        .css-1d391kg &#123;</span><br><span class="hljs-string">            background: linear-gradient(180deg, #f8f9fa, #ffffff);</span><br><span class="hljs-string">        &#125;</span><br><span class="hljs-string"></span><br><span class="hljs-string">        /* æ–‡ä»¶ä¸Šä¼ åŒºåŸŸ */</span><br><span class="hljs-string">        .uploadedFile &#123;</span><br><span class="hljs-string">            background: #f8f9fa;</span><br><span class="hljs-string">            border: 2px dashed #1f77b4;</span><br><span class="hljs-string">            border-radius: 10px;</span><br><span class="hljs-string">            padding: 1rem;</span><br><span class="hljs-string">            text-align: center;</span><br><span class="hljs-string">            margin: 1rem 0;</span><br><span class="hljs-string">        &#125;</span><br><span class="hljs-string"></span><br><span class="hljs-string">        /* çŠ¶æ€æŒ‡ç¤ºå™¨ */</span><br><span class="hljs-string">        .status-indicator &#123;</span><br><span class="hljs-string">            display: inline-flex;</span><br><span class="hljs-string">            align-items: center;</span><br><span class="hljs-string">            gap: 0.5rem;</span><br><span class="hljs-string">            padding: 0.5rem 1rem;</span><br><span class="hljs-string">            border-radius: 20px;</span><br><span class="hljs-string">            font-weight: 600;</span><br><span class="hljs-string">            font-size: 0.9rem;</span><br><span class="hljs-string">        &#125;</span><br><span class="hljs-string"></span><br><span class="hljs-string">        .status-ready &#123;</span><br><span class="hljs-string">            background: #e8f5e8;</span><br><span class="hljs-string">            color: #2ca02c;</span><br><span class="hljs-string">            border: 1px solid #2ca02c;</span><br><span class="hljs-string">        &#125;</span><br><span class="hljs-string"></span><br><span class="hljs-string">        .status-waiting &#123;</span><br><span class="hljs-string">            background: #fff8e1;</span><br><span class="hljs-string">            color: #ff9800;</span><br><span class="hljs-string">            border: 1px solid #ff9800;</span><br><span class="hljs-string">        &#125;</span><br><span class="hljs-string">    &lt;/style&gt;</span><br><span class="hljs-string">    &quot;&quot;&quot;</span>, unsafe_allow_html=<span class="hljs-literal">True</span>)<br><br><br><span class="hljs-comment"># åˆå§‹åŒ–embeddings</span><br><span class="hljs-meta">@st.cache_resource</span><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">init_embeddings</span>():<br>    <span class="hljs-keyword">return</span> DashScopeEmbeddings(<br>        model=<span class="hljs-string">&quot;text-embedding-v1&quot;</span>,<br>        dashscope_api_key=dashscope_api_key<br>    )<br><br><br><span class="hljs-comment"># åˆå§‹åŒ–LLM</span><br><span class="hljs-meta">@st.cache_resource</span><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">init_llm</span>():<br>    <span class="hljs-keyword">return</span> init_chat_model(<span class="hljs-string">&quot;deepseek-chat&quot;</span>, model_provider=<span class="hljs-string">&quot;deepseek&quot;</span>)<br><br><br><span class="hljs-comment"># åˆå§‹åŒ–ä¼šè¯çŠ¶æ€</span><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">init_session_state</span>():<br>    <span class="hljs-keyword">if</span> <span class="hljs-string">&#x27;pdf_messages&#x27;</span> <span class="hljs-keyword">not</span> <span class="hljs-keyword">in</span> st.session_state:<br>        st.session_state.pdf_messages = []<br>    <span class="hljs-keyword">if</span> <span class="hljs-string">&#x27;csv_messages&#x27;</span> <span class="hljs-keyword">not</span> <span class="hljs-keyword">in</span> st.session_state:<br>        st.session_state.csv_messages = []<br>    <span class="hljs-keyword">if</span> <span class="hljs-string">&#x27;df&#x27;</span> <span class="hljs-keyword">not</span> <span class="hljs-keyword">in</span> st.session_state:<br>        st.session_state.df = <span class="hljs-literal">None</span><br><br><br><span class="hljs-comment"># PDFå¤„ç†å‡½æ•°</span><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">pdf_read</span>(<span class="hljs-params">pdf_doc</span>):<br>    text = <span class="hljs-string">&quot;&quot;</span><br>    <span class="hljs-keyword">for</span> pdf <span class="hljs-keyword">in</span> pdf_doc:<br>        pdf_reader = PdfReader(pdf)<br>        <span class="hljs-keyword">for</span> page <span class="hljs-keyword">in</span> pdf_reader.pages:<br>            text += page.extract_text()<br>    <span class="hljs-keyword">return</span> text<br><br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">get_chunks</span>(<span class="hljs-params">text</span>):<br>    text_splitter = RecursiveCharacterTextSplitter(chunk_size=<span class="hljs-number">1000</span>, chunk_overlap=<span class="hljs-number">200</span>)<br>    chunks = text_splitter.split_text(text)<br>    <span class="hljs-keyword">return</span> chunks<br><br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">vector_store</span>(<span class="hljs-params">text_chunks</span>):<br>    embeddings = init_embeddings()<br>    vector_store = FAISS.from_texts(text_chunks, embedding=embeddings)<br>    vector_store.save_local(<span class="hljs-string">&quot;faiss_db&quot;</span>)<br><br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">check_database_exists</span>():<br>    <span class="hljs-keyword">return</span> os.path.exists(<span class="hljs-string">&quot;faiss_db&quot;</span>) <span class="hljs-keyword">and</span> os.path.exists(<span class="hljs-string">&quot;faiss_db/index.faiss&quot;</span>)<br><br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">get_pdf_response</span>(<span class="hljs-params">user_question</span>):<br>    <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> check_database_exists():<br>        <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;âŒ è¯·å…ˆä¸Šä¼ PDFæ–‡ä»¶å¹¶ç‚¹å‡»&#x27;Submit &amp; Process&#x27;æŒ‰é’®æ¥å¤„ç†æ–‡æ¡£ï¼&quot;</span><br><br>    <span class="hljs-keyword">try</span>:<br>        embeddings = init_embeddings()<br>        llm = init_llm()<br><br>        new_db = FAISS.load_local(<span class="hljs-string">&quot;faiss_db&quot;</span>, embeddings, allow_dangerous_deserialization=<span class="hljs-literal">True</span>)<br>        retriever = new_db.as_retriever()<br><br>        prompt = ChatPromptTemplate.from_messages([<br>            (<span class="hljs-string">&quot;system&quot;</span>,<br>             <span class="hljs-string">&quot;&quot;&quot;ä½ æ˜¯AIåŠ©æ‰‹ï¼Œè¯·æ ¹æ®æä¾›çš„ä¸Šä¸‹æ–‡å›ç­”é—®é¢˜ï¼Œç¡®ä¿æä¾›æ‰€æœ‰ç»†èŠ‚ï¼Œå¦‚æœç­”æ¡ˆä¸åœ¨ä¸Šä¸‹æ–‡ä¸­ï¼Œè¯·è¯´&quot;ç­”æ¡ˆä¸åœ¨ä¸Šä¸‹æ–‡ä¸­&quot;ï¼Œä¸è¦æä¾›é”™è¯¯çš„ç­”æ¡ˆ&quot;&quot;&quot;</span>),<br>            (<span class="hljs-string">&quot;placeholder&quot;</span>, <span class="hljs-string">&quot;&#123;chat_history&#125;&quot;</span>),<br>            (<span class="hljs-string">&quot;human&quot;</span>, <span class="hljs-string">&quot;&#123;input&#125;&quot;</span>),<br>            (<span class="hljs-string">&quot;placeholder&quot;</span>, <span class="hljs-string">&quot;&#123;agent_scratchpad&#125;&quot;</span>),<br>        ])<br><br>        retrieval_chain = create_retriever_tool(retriever, <span class="hljs-string">&quot;pdf_extractor&quot;</span>,<br>                                                <span class="hljs-string">&quot;This tool is to give answer to queries from the pdf&quot;</span>)<br>        agent = create_tool_calling_agent(llm, [retrieval_chain], prompt)<br>        agent_executor = AgentExecutor(agent=agent, tools=[retrieval_chain], verbose=<span class="hljs-literal">True</span>)<br><br>        response = agent_executor.invoke(&#123;<span class="hljs-string">&quot;input&quot;</span>: user_question&#125;)<br>        <span class="hljs-keyword">return</span> response[<span class="hljs-string">&#x27;output&#x27;</span>]<br><br>    <span class="hljs-keyword">except</span> Exception <span class="hljs-keyword">as</span> e:<br>        <span class="hljs-keyword">return</span> <span class="hljs-string">f&quot;âŒ å¤„ç†é—®é¢˜æ—¶å‡ºé”™: <span class="hljs-subst">&#123;<span class="hljs-built_in">str</span>(e)&#125;</span>&quot;</span><br><br><br><span class="hljs-comment"># CSVå¤„ç†å‡½æ•°</span><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">get_csv_response</span>(<span class="hljs-params">query: <span class="hljs-built_in">str</span></span>) -&gt; <span class="hljs-built_in">str</span>:<br>    <span class="hljs-keyword">if</span> st.session_state.df <span class="hljs-keyword">is</span> <span class="hljs-literal">None</span>:<br>        <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;è¯·å…ˆä¸Šä¼ CSVæ–‡ä»¶&quot;</span><br><br>    llm = init_llm()<br>    locals_dict = &#123;<span class="hljs-string">&#x27;df&#x27;</span>: st.session_state.df&#125;<br>    tools = [PythonAstREPLTool(<span class="hljs-built_in">locals</span>=locals_dict)]<br><br>    system = <span class="hljs-string">f&quot;&quot;&quot;Given a pandas dataframe `df` answer user&#x27;s query.</span><br><span class="hljs-string">        Here&#x27;s the output of `df.head().to_markdown()` for your reference, you have access to full dataframe as `df`:</span><br></code></pre></td></tr></table></figure>
<pre><code>    &#123;st.session_state.df.head().to_markdown()&#125;
    <figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs plaintext">Give final answer as soon as you have enough data, otherwise generate code using `df` and call required tool.<br>If user asks you to make a graph, save it as `plot.png`, and output GRAPH:&lt;graph title&gt;.<br>Example:<br></code></pre></td></tr></table></figure>
    plt.hist(df[&#39;Age&#39;])
    plt.xlabel(&#39;Age&#39;)
    plt.ylabel(&#39;Count&#39;)
    plt.title(&#39;Age Histogram&#39;)
    plt.savefig(&#39;plot.png&#39;)
    <figure class="highlight plaintext"><figcaption><span>GRAPH:Age histogram</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br></pre></td><td class="code"><pre><code class="hljs output:">        Query:&quot;&quot;&quot;<br><br>    prompt = ChatPromptTemplate.from_messages([<br>        (&quot;system&quot;, system),<br>        (&quot;placeholder&quot;, &quot;&#123;chat_history&#125;&quot;),<br>        (&quot;human&quot;, &quot;&#123;input&#125;&quot;),<br>        (&quot;placeholder&quot;, &quot;&#123;agent_scratchpad&#125;&quot;),<br>    ])<br><br>    agent = create_tool_calling_agent(llm=llm, tools=tools, prompt=prompt)<br>    agent_executor = AgentExecutor(agent=agent, tools=tools, verbose=True)<br><br>    return agent_executor.invoke(&#123;&quot;input&quot;: query&#125;)[&#x27;output&#x27;]<br><br><br>def main():<br>    init_session_state()<br><br>    # ä¸»æ ‡é¢˜<br>    st.markdown(&#x27;&lt;h1 class=&quot;main-header&quot;&gt;ğŸ¤– LangChain Bç«™å…¬å¼€è¯¾ Byä¹å¤©Hector&lt;/h1&gt;&#x27;, unsafe_allow_html=True)<br>    st.markdown(<br>        &#x27;&lt;div style=&quot;text-align: center; margin-bottom: 2rem; color: #666;&quot;&gt;é›†PDFé—®ç­”ä¸æ•°æ®åˆ†æäºä¸€ä½“çš„æ™ºèƒ½åŠ©æ‰‹&lt;/div&gt;&#x27;,<br>        unsafe_allow_html=True)<br><br>    # åˆ›å»ºä¸¤ä¸ªä¸»è¦åŠŸèƒ½çš„æ ‡ç­¾é¡µ<br>    tab1, tab2 = st.tabs([&quot;ğŸ“„ PDFæ™ºèƒ½é—®ç­”&quot;, &quot;ğŸ“Š CSVæ•°æ®åˆ†æ&quot;])<br><br>    # PDFé—®ç­”æ¨¡å—<br>    with tab1:<br>        col1, col2 = st.columns([2, 1])<br><br>        with col1:<br>            st.markdown(&quot;### ğŸ’¬ ä¸PDFæ–‡æ¡£å¯¹è¯&quot;)<br><br>            # æ˜¾ç¤ºæ•°æ®åº“çŠ¶æ€<br>            if check_database_exists():<br>                st.markdown(<br>                    &#x27;&lt;div class=&quot;info-card success-card&quot;&gt;&lt;span class=&quot;status-indicator status-ready&quot;&gt;âœ… PDFæ•°æ®åº“å·²å‡†å¤‡å°±ç»ª&lt;/span&gt;&lt;/div&gt;&#x27;,<br>                    unsafe_allow_html=True)<br>            else:<br>                st.markdown(<br>                    &#x27;&lt;div class=&quot;info-card warning-card&quot;&gt;&lt;span class=&quot;status-indicator status-waiting&quot;&gt;âš ï¸ è¯·å…ˆä¸Šä¼ å¹¶å¤„ç†PDFæ–‡ä»¶&lt;/span&gt;&lt;/div&gt;&#x27;,<br>                    unsafe_allow_html=True)<br><br>            # èŠå¤©ç•Œé¢<br>            for message in st.session_state.pdf_messages:<br>                with st.chat_message(message[&quot;role&quot;]):<br>                    st.markdown(message[&quot;content&quot;])<br><br>            # ç”¨æˆ·è¾“å…¥<br>            if pdf_query := st.chat_input(&quot;ğŸ’­ å‘PDFæé—®...&quot;, disabled=not check_database_exists()):<br>                st.session_state.pdf_messages.append(&#123;&quot;role&quot;: &quot;user&quot;, &quot;content&quot;: pdf_query&#125;)<br>                with st.chat_message(&quot;user&quot;):<br>                    st.markdown(pdf_query)<br><br>                with st.chat_message(&quot;assistant&quot;):<br>                    with st.spinner(&quot;ğŸ¤” AIæ­£åœ¨åˆ†ææ–‡æ¡£...&quot;):<br>                        response = get_pdf_response(pdf_query)<br>                    st.markdown(response)<br>                    st.session_state.pdf_messages.append(&#123;&quot;role&quot;: &quot;assistant&quot;, &quot;content&quot;: response&#125;)<br><br>        with col2:<br>            st.markdown(&quot;### ğŸ“ æ–‡æ¡£ç®¡ç†&quot;)<br><br>            # æ–‡ä»¶ä¸Šä¼ <br>            pdf_docs = st.file_uploader(<br>                &quot;ğŸ“ ä¸Šä¼ PDFæ–‡ä»¶&quot;,<br>                accept_multiple_files=True,<br>                type=[&#x27;pdf&#x27;],<br>                help=&quot;æ”¯æŒä¸Šä¼ å¤šä¸ªPDFæ–‡ä»¶&quot;<br>            )<br><br>            if pdf_docs:<br>                st.success(f&quot;ğŸ“„ å·²é€‰æ‹© &#123;len(pdf_docs)&#125; ä¸ªæ–‡ä»¶&quot;)<br>                for i, pdf in enumerate(pdf_docs, 1):<br>                    st.write(f&quot;â€¢ &#123;pdf.name&#125;&quot;)<br><br>            # å¤„ç†æŒ‰é’®<br>            if st.button(&quot;ğŸš€ ä¸Šä¼ å¹¶å¤„ç†PDFæ–‡æ¡£&quot;, disabled=not pdf_docs, use_container_width=True):<br>                with st.spinner(&quot;ğŸ“Š æ­£åœ¨å¤„ç†PDFæ–‡ä»¶...&quot;):<br>                    try:<br>                        raw_text = pdf_read(pdf_docs)<br>                        if not raw_text.strip():<br>                            st.error(&quot;âŒ æ— æ³•ä»PDFä¸­æå–æ–‡æœ¬&quot;)<br>                            return<br><br>                        text_chunks = get_chunks(raw_text)<br>                        st.info(f&quot;ğŸ“ æ–‡æœ¬å·²åˆ†å‰²ä¸º &#123;len(text_chunks)&#125; ä¸ªç‰‡æ®µ&quot;)<br><br>                        vector_store(text_chunks)<br>                        st.success(&quot;âœ… PDFå¤„ç†å®Œæˆï¼&quot;)<br>                        st.balloons()<br>                        st.rerun()<br><br>                    except Exception as e:<br>                        st.error(f&quot;âŒ å¤„ç†PDFæ—¶å‡ºé”™: &#123;str(e)&#125;&quot;)<br><br>            # æ¸…é™¤æ•°æ®åº“<br>            if st.button(&quot;ğŸ—‘ï¸ æ¸…é™¤PDFæ•°æ®åº“&quot;, use_container_width=True):<br>                try:<br>                    import shutil<br>                    if os.path.exists(&quot;faiss_db&quot;):<br>                        shutil.rmtree(&quot;faiss_db&quot;)<br>                    st.session_state.pdf_messages = []<br>                    st.success(&quot;æ•°æ®åº“å·²æ¸…é™¤&quot;)<br>                    st.rerun()<br>                except Exception as e:<br>                    st.error(f&quot;æ¸…é™¤å¤±è´¥: &#123;e&#125;&quot;)<br><br>    # CSVæ•°æ®åˆ†ææ¨¡å—<br>    with tab2:<br>        col1, col2 = st.columns([2, 1])<br><br>        with col1:<br>            st.markdown(&quot;### ğŸ“ˆ æ•°æ®åˆ†æå¯¹è¯&quot;)<br><br>            # æ˜¾ç¤ºæ•°æ®çŠ¶æ€<br>            if st.session_state.df is not None:<br>                st.markdown(<br>                    &#x27;&lt;div class=&quot;info-card success-card&quot;&gt;&lt;span class=&quot;status-indicator status-ready&quot;&gt;âœ… æ•°æ®å·²åŠ è½½å®Œæˆ&lt;/span&gt;&lt;/div&gt;&#x27;,<br>                    unsafe_allow_html=True)<br>            else:<br>                st.markdown(<br>                    &#x27;&lt;div class=&quot;info-card warning-card&quot;&gt;&lt;span class=&quot;status-indicator status-waiting&quot;&gt;âš ï¸ è¯·å…ˆä¸Šä¼ CSVæ–‡ä»¶&lt;/span&gt;&lt;/div&gt;&#x27;,<br>                    unsafe_allow_html=True)<br><br>            # èŠå¤©ç•Œé¢<br>            for message in st.session_state.csv_messages:<br>                with st.chat_message(message[&quot;role&quot;]):<br>                    if message[&quot;type&quot;] == &quot;dataframe&quot;:<br>                        st.dataframe(message[&quot;content&quot;])<br>                    elif message[&quot;type&quot;] == &quot;image&quot;:<br>                        st.write(message[&quot;content&quot;])<br>                        if os.path.exists(&#x27;plot.png&#x27;):<br>                            st.image(&#x27;plot.png&#x27;)<br>                    else:<br>                        st.markdown(message[&quot;content&quot;])<br><br>            # ç”¨æˆ·è¾“å…¥<br>            if csv_query := st.chat_input(&quot;ğŸ“Š åˆ†ææ•°æ®...&quot;, disabled=st.session_state.df is None):<br>                st.session_state.csv_messages.append(&#123;&quot;role&quot;: &quot;user&quot;, &quot;content&quot;: csv_query, &quot;type&quot;: &quot;text&quot;&#125;)<br>                with st.chat_message(&quot;user&quot;):<br>                    st.markdown(csv_query)<br><br>                with st.chat_message(&quot;assistant&quot;):<br>                    with st.spinner(&quot;ğŸ”„ æ­£åœ¨åˆ†ææ•°æ®...&quot;):<br>                        response = get_csv_response(csv_query)<br><br>                    if isinstance(response, pd.DataFrame):<br>                        st.dataframe(response)<br>                        st.session_state.csv_messages.append(<br>                            &#123;&quot;role&quot;: &quot;assistant&quot;, &quot;content&quot;: response, &quot;type&quot;: &quot;dataframe&quot;&#125;)<br>                    elif &quot;GRAPH&quot; in str(response):<br>                        text = str(response)[str(response).find(&quot;GRAPH&quot;) + 6:]<br>                        st.write(text)<br>                        if os.path.exists(&#x27;plot.png&#x27;):<br>                            st.image(&#x27;plot.png&#x27;)<br>                        st.session_state.csv_messages.append(&#123;&quot;role&quot;: &quot;assistant&quot;, &quot;content&quot;: text, &quot;type&quot;: &quot;image&quot;&#125;)<br>                    else:<br>                        st.markdown(response)<br>                        st.session_state.csv_messages.append(&#123;&quot;role&quot;: &quot;assistant&quot;, &quot;content&quot;: response, &quot;type&quot;: &quot;text&quot;&#125;)<br><br>        with col2:<br>            st.markdown(&quot;### ğŸ“Š æ•°æ®ç®¡ç†&quot;)<br><br>            # CSVæ–‡ä»¶ä¸Šä¼ <br>            csv_file = st.file_uploader(&quot;ğŸ“ˆ ä¸Šä¼ CSVæ–‡ä»¶&quot;, type=&#x27;csv&#x27;)<br>            if csv_file:<br>                st.session_state.df = pd.read_csv(csv_file)<br>                st.success(f&quot;âœ… æ•°æ®åŠ è½½æˆåŠŸ!&quot;)<br><br>                # æ˜¾ç¤ºæ•°æ®é¢„è§ˆ<br>                with st.expander(&quot;ğŸ‘€ æ•°æ®é¢„è§ˆ&quot;, expanded=True):<br>                    st.dataframe(st.session_state.df.head())<br>                    st.write(f&quot;ğŸ“ æ•°æ®ç»´åº¦: &#123;st.session_state.df.shape[0]&#125; è¡Œ Ã— &#123;st.session_state.df.shape[1]&#125; åˆ—&quot;)<br><br>            # æ•°æ®ä¿¡æ¯<br>            if st.session_state.df is not None:<br>                if st.button(&quot;ğŸ“‹ æ˜¾ç¤ºæ•°æ®ä¿¡æ¯&quot;, use_container_width=True):<br>                    with st.expander(&quot;ğŸ“Š æ•°æ®ç»Ÿè®¡ä¿¡æ¯&quot;, expanded=True):<br>                        st.write(&quot;**åŸºæœ¬ä¿¡æ¯:**&quot;)<br>                        st.text(f&quot;è¡Œæ•°: &#123;st.session_state.df.shape[0]&#125;&quot;)<br>                        st.text(f&quot;åˆ—æ•°: &#123;st.session_state.df.shape[1]&#125;&quot;)<br>                        st.write(&quot;**åˆ—å:**&quot;)<br>                        st.write(list(st.session_state.df.columns))<br>                        st.write(&quot;**æ•°æ®ç±»å‹:**&quot;)<br>                        # ä¿®å¤ï¼šå°†dtypesè½¬æ¢ä¸ºå­—ç¬¦ä¸²æ ¼å¼æ˜¾ç¤º<br>                        dtype_info = pd.DataFrame(&#123;<br>                            &#x27;åˆ—å&#x27;: st.session_state.df.columns,<br>                            &#x27;æ•°æ®ç±»å‹&#x27;: [str(dtype) for dtype in st.session_state.df.dtypes]<br>                        &#125;)<br>                        st.dataframe(dtype_info, use_container_width=True)<br><br>            # æ¸…é™¤æ•°æ®<br>            if st.button(&quot;ğŸ—‘ï¸ æ¸…é™¤CSVæ•°æ®&quot;, use_container_width=True):<br>                st.session_state.df = None<br>                st.session_state.csv_messages = []<br>                if os.path.exists(&#x27;plot.png&#x27;):<br>                    os.remove(&#x27;plot.png&#x27;)<br>                st.success(&quot;æ•°æ®å·²æ¸…é™¤&quot;)<br>                st.rerun()<br><br>    # åº•éƒ¨ä¿¡æ¯<br>    st.markdown(&quot;---&quot;)<br>    col1, col2, col3 = st.columns(3)<br>    with col1:<br>        st.markdown(&quot;**ğŸ”§ æŠ€æœ¯æ ˆ:**&quot;)<br>        st.markdown(&quot;â€¢ LangChain â€¢ Streamlit â€¢ FAISS â€¢ DeepSeek&quot;)<br>    with col2:<br>        st.markdown(&quot;**âœ¨ åŠŸèƒ½ç‰¹è‰²:**&quot;)<br>        st.markdown(&quot;â€¢ PDFæ™ºèƒ½é—®ç­” â€¢ æ•°æ®å¯è§†åŒ–åˆ†æ&quot;)<br>    with col3:<br>        st.markdown(&quot;**ğŸ’¡ ä½¿ç”¨æç¤º:**&quot;)<br>        st.markdown(&quot;â€¢ æ”¯æŒå¤šæ–‡ä»¶ä¸Šä¼  â€¢ å®æ—¶å¯¹è¯äº¤äº’&quot;)<br><br><br>if __name__ == &quot;__main__&quot;:<br>    main() <br></code></pre></td></tr></table></figure>
</code></pre>
<p>âœ… æ€»ç»“ï¼ˆæ ¸å¿ƒåŠŸèƒ½æ¶æ„ï¼‰</p>
<table>
<thead>
<tr>
<th>æ¨¡å—</th>
<th>æŠ€æœ¯ç»„ä»¶</th>
<th>è¯´æ˜</th>
</tr>
</thead>
<tbody><tr>
<td>PDF é—®ç­”</td>
<td>FAISS + Retriever Tool</td>
<td>æ„æˆ RAG æ£€ç´¢å¢å¼ºæµç¨‹</td>
</tr>
<tr>
<td>CSV åˆ†æ</td>
<td>PythonAstREPLTool + Pandas</td>
<td>å®ç°ä»£ç ç”Ÿæˆ + å¯è§†åŒ–</td>
</tr>
<tr>
<td>LLM</td>
<td>DeepSeek Chat</td>
<td>ç»Ÿä¸€ Agent è°ƒç”¨</td>
</tr>
<tr>
<td>å‘é‡åº“</td>
<td>DashScope Embedding + FAISS</td>
<td>æ”¯æŒä¸­æ–‡è¯­ä¹‰åŒ¹é…</td>
</tr>
<tr>
<td>UI</td>
<td>Streamlit + è‡ªå®šä¹‰ CSS</td>
<td>æä¾›å¤š Tab é¡µé¢ä¸äº¤äº’å¼èŠå¤©</td>
</tr>
<tr>
<td>çŠ¶æ€ç®¡ç†</td>
<td><code>st.session_state</code></td>
<td>ç®¡ç†å†å²ã€æ•°æ®ã€å›¾ç‰‡ç­‰ä¸Šä¸‹æ–‡</td>
</tr>
</tbody></table>
<p>è¿™é‡Œä¸å†é‡å¤èµ˜è¿°<code>PDF</code>æ™ºèƒ½é—®ç­”çš„æµç¨‹ï¼Œé‡ç‚¹è¯´æ˜<code>CSV</code>æ•°æ®æ™ºèƒ½åˆ†æçš„æµç¨‹ã€‚</p>
<p>Step 1. CSV æ–‡ä»¶ä¸Šä¼ ä¸ DataFrame æ˜¾ç¤º</p>
<p>ç”¨æˆ·ä¸Šä¼  .csv æ–‡ä»¶åç”± pandas.read_csv() åŠ è½½ä¸º DataFrameï¼Œå®æ—¶é¢„è§ˆæ•°æ®è¡Œåˆ—ã€åˆ—åã€ç±»å‹ç­‰ä¿¡æ¯ã€‚</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs python">st.session_state.df = pd.read_csv(csv_file)<br>st.dataframe(st.session_state.df.head())<br></code></pre></td></tr></table></figure>

<p>Step 2. æ„å»ºä»£ç æ‰§è¡Œå·¥å…· Agent</p>
<p>æ„å»ºç³»ç»Ÿæç¤ºï¼Œæ³¨å…¥ DataFrame çš„ .head() è¾“å‡ºå¢å¼ºè¯­å¢ƒç†è§£ï¼Œä½¿ç”¨ PythonAstREPLTool å·¥å…·å…è®¸æ¨¡å‹æ‰§è¡ŒåŸºäº df çš„ä»£ç åˆ†æï¼Œé€šè¿‡ create_tool_calling_agent æ„å»ºåˆ†æ Agentï¼Œå¯æ‰§è¡Œç­›é€‰ã€åˆ†ç»„ã€èšåˆç­‰ pandas æ“ä½œï¼Œå›¾è¡¨ç»˜åˆ¶ï¼ˆä¿å­˜ä¸º plot.pngï¼Œå…³é”®è¯è¯†åˆ«åæ¸²æŸ“ï¼‰ã€‚</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs python">tools = [PythonAstREPLTool(<span class="hljs-built_in">locals</span>=&#123;<span class="hljs-string">&quot;df&quot;</span>: st.session_state.df&#125;)]<br></code></pre></td></tr></table></figure>

<p>Step 3. å›¾è¡¨è¯†åˆ«ä¸è‡ªåŠ¨å±•ç¤º</p>
<p>è‹¥æ¨¡å‹è¿”å›å†…å®¹ä¸­åŒ…å« â€œGRAPH:â€ï¼Œåˆ™è‡ªåŠ¨è¯»å– plot.png å¹¶å±•ç¤ºï¼›æ”¯æŒ plt.hist()ã€plt.bar() ç­‰å¯è§†åŒ–å‘½ä»¤ï¼›ä¼šè¯è®°å½•ä¸­åˆ†ç±»ä¿å­˜æ–‡æœ¬ã€å›¾åƒä¸è¡¨æ ¼ç±»å‹å†…å®¹ã€‚</p>
<div id="paginator"></div></div><div id="post-footer"><div id="pages"><div class="footer-link" style="width: 50%;text-align:right;border-right:1px #fe2 solid"><a href="/2025/08/13/%E9%98%BF%E9%87%8C%E4%BA%91%E6%9C%8D%E5%8A%A1%E5%99%A8-%E5%AE%9D%E5%A1%94%E9%9D%A2%E6%9D%BF/">â† Next åŸºäºé˜¿é‡Œäº‘æœåŠ¡å™¨é…ç½®å®å¡”é¢æ¿</a></div><div class="footer-link" style="width: 50%;right:1px;border-left:1px #fe2 solid"><a href="/2025/08/07/AutoDL/">AutoDLæ•™ç¨‹ Prev â†’</a></div></div></div></div><div class="bottom-btn"><div><a class="i-top" id="to-top" onClick="scrolls.scrolltop();" title="To Top" style="opacity: 0; display: none;">âˆ§ </a><a class="i-index" id="to-index" href="#toc-div" title="To Catalog">â‰¡</a><a class="i-color" id="color-mode" onClick="colorMode.change()" title="Change Theme"></a></div></div></article><aside><div id="about"><a href="/" id="logo"><img src="https://ak.hypergryph.com/assets/index/images/ak/pc/faction/1.png" alt="Logo"></a><h1 id="Dr"><a href="/">Zenith</a></h1><div id="description"><p>æœªç»å®¡è§†çš„äººç”Ÿæ˜¯ä¸å€¼å¾—è¿‡çš„äººç”Ÿ</p></div></div><div id="aside-block"><div id="toc-div"><h1>Catalog</h1><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#%E4%B8%80%E3%80%81%E5%90%84%E7%B1%BB%E5%A4%A7%E8%AF%AD%E8%A8%80%E6%A8%A1%E5%9E%8B%E6%8E%A5%E5%85%A5-LangChain"><span class="toc-number">1.</span> <span class="toc-text">ä¸€ã€å„ç±»å¤§è¯­è¨€æ¨¡å‹æ¥å…¥ LangChain</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E4%BA%8C%E3%80%81LangChain-%E6%A0%B8%E5%BF%83%E5%8A%9F%E8%83%BD-Chain-%E7%9A%84%E6%90%AD%E5%BB%BA"><span class="toc-number">2.</span> <span class="toc-text">äºŒã€LangChain æ ¸å¿ƒåŠŸèƒ½ Chain çš„æ­å»º</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E4%B8%89%E3%80%81LangChain-%E8%AE%B0%E5%BF%86%E5%AD%98%E5%82%A8%E4%B8%8E%E6%90%AD%E5%BB%BA%E5%A4%9A%E8%BD%AE%E5%AF%B9%E8%AF%9D%E6%9C%BA%E5%99%A8%E4%BA%BA"><span class="toc-number">3.</span> <span class="toc-text">ä¸‰ã€LangChain è®°å¿†å­˜å‚¨ä¸æ­å»ºå¤šè½®å¯¹è¯æœºå™¨äºº</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%9B%9B%E3%80%81LangChain-%E6%8E%A5%E5%85%A5%E5%B7%A5%E5%85%B7%E6%B5%81%E7%A8%8B"><span class="toc-number">4.</span> <span class="toc-text">å››ã€LangChain æ¥å…¥å·¥å…·æµç¨‹</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E4%BA%94%E3%80%81LangChain-Agent%E8%BF%9B%E9%98%B6%E5%8A%9F%E8%83%BD%E4%BB%8B%E7%BB%8D"><span class="toc-number">5.</span> <span class="toc-text">äº”ã€LangChain Agentè¿›é˜¶åŠŸèƒ½ä»‹ç»</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%85%AD%E3%80%81LangChain-%E6%8E%A5%E5%85%A5-MCP-%E6%8A%80%E6%9C%AF%E5%AE%9E%E7%8E%B0%E6%B5%81%E7%A8%8B"><span class="toc-number">6.</span> <span class="toc-text">å…­ã€LangChain æ¥å…¥ MCP æŠ€æœ¯å®ç°æµç¨‹</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E4%B8%83%E3%80%81LangChain-RAG%E7%9F%A5%E8%AF%86%E5%BA%93%E6%A3%80%E7%B4%A2%E7%B3%BB%E7%BB%9F%E5%BC%80%E5%8F%91"><span class="toc-number">7.</span> <span class="toc-text">ä¸ƒã€LangChain RAGçŸ¥è¯†åº“æ£€ç´¢ç³»ç»Ÿå¼€å‘</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%94%B1%E4%BA%8E%E8%BF%99%E4%B8%80%E9%83%A8%E5%88%86%E6%AF%94%E8%BE%83%E5%A4%8D%E6%9D%82%EF%BC%8C%E5%9B%A0%E6%AD%A4%E5%9C%A8%E8%BF%99%E4%BB%85%E7%BB%99%E5%87%BA%E7%A4%BA%E4%BE%8B%E4%BB%A3%E7%A0%81%EF%BC%8C%E5%90%8E%E7%BB%AD%E5%86%8D%E5%81%9A%E8%A1%A5%E5%85%85%EF%BC%88%E5%90%8E%E9%9D%A2%E7%9A%84%E5%86%85%E5%AE%B9%E6%9C%89%E9%9C%80%E8%A6%81%E5%8F%AF%E4%BB%A5%E7%9C%8B%EF%BC%8C%E4%B9%9F%E5%8F%AF%E4%BB%A5%E7%AD%89%E5%90%8E%E7%BB%AD%E7%BB%99%E5%87%BA%E6%9B%B4%E8%AF%A6%E7%BB%86%E7%9A%84%E6%95%99%E7%A8%8B%EF%BC%89"><span class="toc-number">7.1.</span> <span class="toc-text">ç”±äºè¿™ä¸€éƒ¨åˆ†æ¯”è¾ƒå¤æ‚ï¼Œå› æ­¤åœ¨è¿™ä»…ç»™å‡ºç¤ºä¾‹ä»£ç ï¼Œåç»­å†åšè¡¥å……ï¼ˆåé¢çš„å†…å®¹æœ‰éœ€è¦å¯ä»¥çœ‹ï¼Œä¹Ÿå¯ä»¥ç­‰åç»­ç»™å‡ºæ›´è¯¦ç»†çš„æ•™ç¨‹ï¼‰</span></a></li></ol></li></ol></div></div><footer><nobr><span class="icp-title">â™–</span><a class="icp-content" href="https://smallgoodgood.top/about/">å…³äºæœ¬ç«™</a></nobr><br><nobr>Pubulished by <a href="http://smallgoodgood.top">Zenith <br></a></nobr><wbr><!-- æ·»åŠ ç½‘ç«™è¿è¡Œæ—¶é—´ --><span id="timeDate">è½½å…¥å¤©æ•°...</span><span id="times">è½½å…¥æ—¶åˆ†ç§’...</span><script>var now = new Date();

function createtime() {
  var grt = new Date("02/09/2024 00:00:00"); //æ­¤å¤„ä¿®æ”¹ä½ çš„å»ºç«™æ—¶é—´æˆ–è€…ç½‘ç«™ä¸Šçº¿æ—¶é—´ 
  now.setTime(now.getTime() + 250);
  days = (now - grt) / 1000 / 60 / 60 / 24;
  dnum = Math.floor(days);
  hours = (now - grt) / 1000 / 60 / 60 - (24 * dnum);
  hnum = Math.floor(hours);
  if (String(hnum).length == 1) {
      hnum = "0" + hnum;
  }
  minutes = (now - grt) / 1000 / 60 - (24 * 60 * dnum) - (60 * hnum);
  mnum = Math.floor(minutes);
  if (String(mnum).length == 1) {
      mnum = "0" + mnum;
  }
  seconds = (now - grt) / 1000 - (24 * 60 * 60 * dnum) - (60 * 60 * hnum) - (60 * mnum);
  snum = Math.round(seconds);
  if (String(snum).length == 1) {
      snum = "0" + snum;
  }
  document.getElementById("timeDate").innerHTML = " | æœ¬ç«™å·²å®‰å…¨è¿è¡Œ " + dnum + " å¤© ";
  document.getElementById("times").innerHTML = hnum + " å°æ—¶ " + mnum + " åˆ† " + snum + " ç§’";
}
setInterval("createtime()", 250);
<!-- æ·»åŠ ç½‘ç«™è¿è¡Œæ—¶é—´ -->

</script></footer></aside></main><canvas id="canvas-dust"></canvas><script src="/live2dw/lib/L2Dwidget.min.js?094cbace49a39548bed64abff5988b05"></script><script>L2Dwidget.init({"model":{"jsonPath":"/live2dw/assets/hijiki.model.json"},"display":{"position":"left","width":150,"height":300},"mobile":{"show":true},"log":false,"pluginJsPath":"lib/","pluginModelPath":"assets/","pluginRootPath":"live2dw/","tagMode":false});</script></body></html>