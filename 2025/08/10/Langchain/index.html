<!DOCTYPE html><html lang="zh-CN" theme-mode="dark"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1.0"><title>LangChain入门 | Zenith</title><link rel="icon" type="image/x-icon" href="/favicon.ico"><link rel="preload" as="font" crossorigin="anonymous" href="/font/Bender.ttf"><link rel="preload" as="font" crossorigin="anonymous" href="/font/BenderLight.ttf"><link rel="preload" as="font" crossorigin="anonymous" href="/font/JetBrainsMono-Regular.woff2"><link rel="stylesheet" href="/css/arknights.css"><style>@font-face {
  font-family: Bender;
  src: local('Bender'), url("/font/Bender.ttf"), url("/font/Bender.otf");
}
@font-face {
  font-family: BenderLight;
  src: local('BenderLight'), url("/font/BenderLight.ttf");
}
@font-face {
  font-family: 'JetBrains Mono';
  src: local('JetBrains Mono'), url('/font/JetBrainsMono-Regular.woff2') format('woff2');
}
</style><script>var config = {"root":"/","search":{"preload":false,"activeHolder":"Enter here","blurHolder":"Search","noResult":"Data \"$0\" not found"},"code":{"codeInfo":"$0 - $1 lines","copy":"copy"}}</script><link type="text/css" rel="stylesheet" href="/lib/encrypt/hbe.style.css"><script src="//unpkg.com/mermaid@10.5.0/dist/mermaid.min.js"></script><link type="text/css" rel="stylesheet" href="//unpkg.com/lightgallery@2.7.1/css/lightgallery.css"><link type="text/css" rel="stylesheet" href="//unpkg.com/lightgallery@2.7.1/css/lg-zoom.css"><link type="text/css" rel="stylesheet" href="//unpkg.com/lightgallery@2.7.1/css/lg-thumbnail.css"><link type="text/css" rel="stylesheet" href="/lib/fontawesome/css/all.min.css"><script>if (window.localStorage.getItem('theme-mode') === 'light')
 document.documentElement.setAttribute('theme-mode', 'light')
if (window.localStorage.getItem('theme-mode') === 'dark')
 document.documentElement.setAttribute('theme-mode', 'dark')</script><style>@font-face {
 font-family: BenderLight;
 src: local('Bender'), url("/font/BenderLight.woff2") format('woff2');
}
@font-face {
 font-family: 'JetBrains Mono';
 src: local('JetBrains Mono'), url('/font/JetBrainsMono-Regular.woff2') format('woff2');
}</style><style>:root {
 --dark-background: url('/img/yellow.jpg');
 --light-background: url('/img/green.jpg');
 --theme-encrypt-confirm: 'confirm'
}</style><script defer src="/js/arknights.js"></script><script defer src="/js/search.js"></script><script defer type="module">import mermaid from '//unpkg.com/mermaid@10.5.0/dist/mermaid.esm.mjs';
window.mermaid = mermaid;
code.paintMermaid();
</script><script async src="//unpkg.com/lightgallery@2.7.1/lightgallery.min.js"></script><script async src="//unpkg.com/lightgallery@2.7.1/plugins/zoom/lg-zoom.min.js"></script><script async src="//unpkg.com/lightgallery@2.7.1/plugins/thumbnail/lg-thumbnail.min.js"></script><script async src="/lib/encrypt/hbe.js"></script><script async src="/js/pjax.js"></script><script class="pjax-js">reset= () => {document.querySelector('.lg-container')?.remove()
lightGallery(document.getElementById('post-bg'), {
  plugins: [lgZoom,lgThumbnail],
  selector: '.item-img'})}</script><script>window.addEventListener("load",() => {pjax = new Pjax({
 cacheBust: false,
 selectors: ['title','article','#aside-block','.pjax-js','data-pjax','.busuanzi'],
 switches: {'article': Pjax.switches.sideBySide},
 switchesOptions: {
   'article': {
     classNames: {
       remove: "pjax-out",
       add: "pjax-in"
     }
   }
 }
});
document.addEventListener("pjax:complete", reset);reset()})</script><script class="pjax-js">reset= () => {document.querySelector('.lg-container')?.remove()
lightGallery(document.getElementById('post-bg'), {
  plugins: [lgZoom,lgThumbnail],
  selector: '.item-img'})}</script><script>window.addEventListener("load",() => {pjax = new Pjax({
 cacheBust: false,
 selectors: ['title','article','#aside-block','.pjax-js'],
 switches: {'article': Pjax.switches.sideBySide},
 switchesOptions: {
   'article': {
     classNames: {
       remove: "pjax-out",
       add: "pjax-in"
     }
   }
 }
});
document.addEventListener("pjax:complete", reset);reset()})</script><!-- 爆炸红心效果 -->
<canvas class="fireworks" style="position: fixed;left: 0;top: 0;z-index: 1; pointer-events: none;" ></canvas> 
<script type="text/javascript" src="//cdn.bootcss.com/animejs/2.2.0/anime.min.js"></script> 
<script type="text/javascript" src="/js/firework.js"></script><meta name="generator" content="Hexo 7.3.0"><link rel="alternate" href="/rss.xml" title="Zenith" type="application/rss+xml">
</head><body><script>(function () {  
    var a_idx = 0;  
    window.onclick = function (event) {  
        var a = new Array("这一路上走走停停","顺着少年漂流的痕迹","迈出车站的前一刻","竟有些犹豫","不禁笑这近乡情怯","仍无法避免","而长野的天","依旧那么暖","风吹起了从前",
        "从前初识这世间","万般流连","看着天边似在眼前","也甘愿赴汤蹈火去走它一遍","如今走过这世间","万般流连","翻过岁月不同侧脸","措不及防闯入你的笑颜","我曾难自拔于世界之大","也沉溺于其中梦话","不得真假 不做挣扎 不惧笑话","我曾将青春翻涌成她","也曾指尖弹出盛夏","心之所动 且就随缘去吧","逆着光行走 任风吹雨打","短短的路走走停停","也有了几分的距离","不知抚摸的是故事","还是段心情","也许期待的不过是","与时间为敌","再次见到你","微凉晨光里","笑得很甜蜜","从前初识这世间","万般流连","看着天边似在眼前","也甘愿赴汤蹈火去走它一遍","如今走过这世间","万般流连","翻过岁月不同侧脸","措不及防闯入你的笑颜","我曾难自拔于世界之大","也沉溺于其中梦话","不做真假 不做挣扎 不惧笑话","我曾将青春翻涌成她","也曾指尖弹出盛夏","心之所动 且就随缘去吧","晚风吹起你鬓间的白发","抚平回忆留下的疤","你的眼中 明暗交杂 一笑生花","暮色遮住你蹒跚的步伐","走进床头藏起的画","画中的你 低着头说话","我仍感叹于世界之大","也沉醉于儿时情话","不剩真假 不做挣扎 无谓笑话","我终将青春还给了她","连同指尖弹出的盛夏","心之所动 就随风去了","以爱之名 你还愿意吗",
        "这一路上走走停停","顺着少年漂流的痕迹","迈出车站的前一刻","竟有些犹豫","不禁笑这近乡情怯","仍无法避免","而长野的天","依旧那么暖","风吹起了从前",
        "从前初识这世间","万般流连","看着天边似在眼前","也甘愿赴汤蹈火去走它一遍","如今走过这世间","万般流连","翻过岁月不同侧脸","措不及防闯入你的笑颜","我曾难自拔于世界之大","也沉溺于其中梦话","不得真假 不做挣扎 不惧笑话","我曾将青春翻涌成她","也曾指尖弹出盛夏","心之所动 且就随缘去吧","逆着光行走 任风吹雨打","短短的路走走停停","也有了几分的距离","不知抚摸的是故事","还是段心情","也许期待的不过是","与时间为敌","再次见到你","微凉晨光里","笑得很甜蜜","从前初识这世间","万般流连","看着天边似在眼前","也甘愿赴汤蹈火去走它一遍","如今走过这世间","万般流连","翻过岁月不同侧脸","措不及防闯入你的笑颜","我曾难自拔于世界之大","也沉溺于其中梦话","不做真假 不做挣扎 不惧笑话","我曾将青春翻涌成她","也曾指尖弹出盛夏","心之所动 且就随缘去吧","晚风吹起你鬓间的白发","抚平回忆留下的疤","你的眼中 明暗交杂 一笑生花","暮色遮住你蹒跚的步伐","走进床头藏起的画","画中的你 低着头说话","我仍感叹于世界之大","也沉醉于儿时情话","不剩真假 不做挣扎 无谓笑话","我终将青春还给了她","连同指尖弹出的盛夏","心之所动 就随风去了","以爱之名 你还愿意吗",
        "这一路上走走停停","顺着少年漂流的痕迹","迈出车站的前一刻","竟有些犹豫","不禁笑这近乡情怯","仍无法避免","而长野的天","依旧那么暖","风吹起了从前",
        "从前初识这世间","万般流连","看着天边似在眼前","也甘愿赴汤蹈火去走它一遍","如今走过这世间","万般流连","翻过岁月不同侧脸","措不及防闯入你的笑颜","我曾难自拔于世界之大","也沉溺于其中梦话","不得真假 不做挣扎 不惧笑话","我曾将青春翻涌成她","也曾指尖弹出盛夏","心之所动 且就随缘去吧","逆着光行走 任风吹雨打","短短的路走走停停","也有了几分的距离","不知抚摸的是故事","还是段心情","也许期待的不过是","与时间为敌","再次见到你","微凉晨光里","笑得很甜蜜","从前初识这世间","万般流连","看着天边似在眼前","也甘愿赴汤蹈火去走它一遍","如今走过这世间","万般流连","翻过岁月不同侧脸","措不及防闯入你的笑颜","我曾难自拔于世界之大","也沉溺于其中梦话","不做真假 不做挣扎 不惧笑话","我曾将青春翻涌成她","也曾指尖弹出盛夏","心之所动 且就随缘去吧","晚风吹起你鬓间的白发","抚平回忆留下的疤","你的眼中 明暗交杂 一笑生花","暮色遮住你蹒跚的步伐","走进床头藏起的画","画中的你 低着头说话","我仍感叹于世界之大","也沉醉于儿时情话","不剩真假 不做挣扎 无谓笑话","我终将青春还给了她","连同指尖弹出的盛夏","心之所动 就随风去了","以爱之名 你还愿意吗",
        "曾经有人让我听这首歌","可是那时的我还不谙情事","也没有真正认真的听完整首歌","直到后来","分开后再听时才发现","原来我错过了","曾经的阿芒","你还好吗");  

        var heart = document.createElement("p"); // 创建p元素，这里从b改为p  
        heart.onselectstart = function() { return false; }; // 简化防止拖动的代码  

        document.body.appendChild(heart).textContent = a[a_idx]; // 使用textContent代替innerHTML，因为这里只是文本  
        a_idx = (a_idx + 1) % a.length;  
        heart.style.cssText = "position: fixed;left:-100%;"; // 初始位置  

        var f = 16, // 字体大小  
            x = event.clientX - f / 2, // 横坐标  
            y = event.clientY - f, // 纵坐标  
            c = randomColor(), // 随机颜色  
            a = 1, // 透明度  
            s = 1.2; // 放大缩小比例  

        var timer = setInterval(function () { // 添加定时器  
            if (a <= 0) {  
                document.body.removeChild(heart);  
                clearInterval(timer);  
            } else {  
                heart.style.cssText = "font-size:" + f + "px;cursor: default;position: fixed;color:" +  
                    c + ";left:" + x + "px;top:" + y + "px;opacity:" + a + ";transform:scale(" +  
                    s + ");";  

                y--;  
                a -= 0.016;  
                s += 0.002;  
            }  
        }, 15);  
    }  

    // 随机颜色函数  
    function randomColor() {  
        //- return "rgb(" + (~~(Math.random() * 255)) + "," + (~~(Math.random() * 255)) + "," + (~~(Math.random() * 255)) + ")";  
        return "(255,240,245)";
    }  
}());</script><div class="loading" style="opacity: 0;"><div class="loadingBar left"></div><div class="loadingBar right"></div></div><main><header class="closed"><div class="navBtn"><i class="navBtnIcon"><span class="navBtnIconBar"></span><span class="navBtnIconBar"></span><span class="navBtnIconBar"></span></i></div><nav><div class="navItem" id="search-header"><span class="navItemTitle"><input autocomplete="off" autocorrect="off" autocapitalize="none" placeholder="Search" spellcheck="false" maxlength="50" type="text" id="search-input"></span></div><div class="navItem" id="search-holder"></div><div class="search-popup" tabindex="0"><div id="search-result"></div></div><ol class="navContent"><li class="navItem"><a class="navBlock" href="/"><span class="navItemTitle">首页</span></a></li><li class="navItem"><a class="navBlock" href="/about"><span class="navItemTitle">关于</span></a></li><li class="navItem" matchdata="categories,tags"><a class="navBlock" href="/archives/"><span class="navItemTitle">归档</span></a></li><li class="navItem"><a class="navBlock" href="/chat-zenith"><span class="navItemTitle">AI</span></a></li></ol></nav></header><article><div id="post-bg"><div id="post-title"><h1>LangChain入门</h1><div id="post-info"><span>First Post: <div class="control"><time datetime="2025-08-10T06:00:00.000Z" id="date"> 2025-08-10</time></div></span><br><span>Last Update: <div class="control"><time datetime="2025-08-16T15:28:00.445Z" id="updated"> 2025-08-16</time></div></span><br><span>Word Count: <div class="control">29.1k</div></span><br><span>Read Time: <div class="control">130 min</div></span></div></div><hr><div id="post-content"><p class='item-img' data-src='/images/24.png'><img src="/images/24.png"></p>
<span id="more"></span>

<p>首先通过一张图来理解<code>Langchain</code>在模型开发中的地位。我们现在使用的各大模型，像<code>DeepSeek</code>、<code>ChatGLM</code>等，都属于<code>LLM</code>（<code>Large Language Model</code>，大语言模型）。而<code>Langchain</code>则是基于<code>LLM</code>的框架，对大语言模型的功能进行了拓展，增加了像<code>RAG</code>（<code>Retrieval-Augmented Generation</code>，检索增强生成）、<code>MCP</code>（<code>Multi-Chain Processing</code>，多链处理）等功能。这些功能通过结合外部知识库、分块处理文本、向量相似性检索等技术，显著降低了模型的幻觉（<code>Hallucination</code>），同时提高了生成内容的准确性与专业性。</p>
<p>从图中可以看到，<code>Langchain</code>的工作流程包括文档加载、文本分块、嵌入（<code>Embedding</code>）、向量存储、相似性检索等步骤，最终通过<code>Prompt Template</code>生成高质量的答案。这一流程使得模型能够更高效地利用结构化或非结构化数据，从而更好地满足实际应用的需求。</p>
<p>下面，我们来简单地基于<code>deepseek</code>结合<code>Langchain</code>进行快速的开发测试</p>
<h1 id="一、各类大语言模型接入-LangChain"><a href="#一、各类大语言模型接入-LangChain" class="headerlink" title="一、各类大语言模型接入 LangChain"></a>一、各类大语言模型接入 LangChain</h1><p>首先</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs bash">pip install langchain<br>pip show langchain<br></code></pre></td></tr></table></figure>

<p>在进行 <code>LangChain </code>开发之前，首先需要准备一个可以进行调用的大模型，这里我们选择使用 <code>DeepSeek </code>的大模型，并使用 <code>DeepSeek </code>官方的 <code>API_KEY </code>进行调用。如果初次使用，需要先在 <code>DeepSeek </code>的官网 <a target="_blank" rel="noopener" href="https://platform.deepseek.com/usage">DeepSeek 开放平台</a> 上进行注册并创建一个新的 <code>API_KEY</code>。</p>
<p>注册好 <code>DeepSeek </code>的 <code>API_KEY </code>后，首先在项目同级目录下创建一个 <code>.env</code> 文件，用于存储 <code>DeepSeek </code>的 <code>API_KEY </code>。（务必要创建 <code>.env</code> 文件，用于存储 <code>DeepSeek </code>的 <code>API_KEY </code>，因为后续  <code>Langchain</code> 会使用到）</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">DEEPSEEK_API_KEY=sk-xxx<br></code></pre></td></tr></table></figure>

<p>接下来通过 <code>python-dotenv</code> 库读取 <code>.env </code>文件中的 <code>API_KEY</code>，使其加载到当前的运行环境中，代码如下:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">pip install python-dotenv<br></code></pre></td></tr></table></figure>

<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">import</span> os<br><span class="hljs-keyword">from</span> dotenv <span class="hljs-keyword">import</span> load_dotenv<br>load_dotenv(override=<span class="hljs-literal">True</span>)<br><br>DeepSeek_API_KEY = os.getenv(<span class="hljs-string">&quot;DEEPSEEK_API_KEY&quot;</span> )<br><span class="hljs-comment"># print(DeepSeek_API_KEY) # 可以通过打印查看</span><br></code></pre></td></tr></table></figure>

<p>我们在当前的运行环境下不使用 LangChain，直接使用 DeepSeek 的 API 进行网络连通性测试，测试代码如下:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">pip install openai<br></code></pre></td></tr></table></figure>

<p>先调用模型进行简单的测试</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> openai <span class="hljs-keyword">import</span> OpenAI<br><span class="hljs-keyword">import</span> os<br><span class="hljs-keyword">from</span> dotenv <span class="hljs-keyword">import</span> load_dotenv<br>load_dotenv(override=<span class="hljs-literal">True</span>)<br><br>DeepSeek_API_KEY = os.getenv(<span class="hljs-string">&quot;DEEPSEEK_API_KEY&quot;</span> )<br><br><span class="hljs-comment">#初始化DeepSeek的API客户端</span><br>client = OpenAI(api_key=DeepSeek_API_KEY, base_url=<span class="hljs-string">&quot;https://api.deepseek.com&quot;</span>)<br><br><span class="hljs-comment">#调用DeepSeek的API，生成回答</span><br>response = client.chat.completions.create(<br>    model=<span class="hljs-string">&quot;deepseek-chat&quot;</span>,<br>    messages=[<br>        &#123;<span class="hljs-string">&quot;role&quot;</span>: <span class="hljs-string">&quot;system&quot;</span>,<span class="hljs-string">&quot;content&quot;</span>:<span class="hljs-string">&quot;你是乐于助人的助手，请根据用户的问题给出回答&quot;</span>&#125;,<br>        &#123;<span class="hljs-string">&quot;role&quot;</span>: <span class="hljs-string">&quot;user&quot;</span>,<span class="hljs-string">&quot;content&quot;</span>:<span class="hljs-string">&quot;你好，请你介绍一下你自己。&quot;</span>&#125;<br>    ]<br>)<br><br><span class="hljs-comment">#打印模型最终的响应结果</span><br><span class="hljs-built_in">print</span>(response.choices[<span class="hljs-number">0</span>].message.content)<br></code></pre></td></tr></table></figure>

<p>可以接收到类似下面的回复：</p>
<figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs text">你好！我是一个乐于助人的AI助手，随时准备为你提供各种帮助。无论是解答问题、提供建议、协助学习、处理日常事务，还是陪你聊天，我都会尽力满足你的需求。  <br><br>我的知识涵盖多个领域，包括但不限于科技、历史、文化、健康、编程、生活技巧等。如果你有任何疑问或需要帮助，尽管告诉我！  <br><br>你可以问我：  <br>- **学习相关**：如何高效学习、解题思路、语言学习建议等  <br>- **生活实用**：菜谱推荐、旅行攻略、时间管理等  <br>- **技术问题**：编程、软件使用、AI相关等  <br>- **创意灵感**：写作、策划、头脑风暴等  <br>- **其他**：闲聊、趣味冷知识、心理疏导等  <br><br>没有固定的话题限制，我会根据你的需求调整回答方式。希望我能成为你的得力助手！ 😊 你今天想了解些什么呢？<br></code></pre></td></tr></table></figure>

<p>如果可以正常收到 <code>DeepSeek </code>模型的响应，则说明 <code>DeepSeek </code>的 API 已经可以正常使用且网络连通性正常。</p>
<p>接下来我们要考虑的是，对于这样一个 <code>DeepSeek </code>官方的 <code>API </code>，如何接入到 <code>LangChain </code>中呢？其实非常简单，我们只需要使用 <code>LangChain </code>中的一个 <code>DeepSeek </code>组件即可像上述代码一样，直接使用相同的 <code>DeepSeek_API_KEY</code> 与大模型进行交互。因此，我们首先需要安装 <code>LangChain </code>的 <code>DeepSeek </code>组件，安装命令如下:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">pip install langchain-deepseek<br></code></pre></td></tr></table></figure>

<p>这个库并不会被显式地调用，但是在后台运行过程中是会调用这个库的，所以务必要安装这个库</p>
<p>安装好<code>LangChain</code>集成<code>DeepSeek</code>模型的依赖包后，需要通过一个<code>init_chat_model</code>函数来初始化大模型，代码如下：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> langchain.chat_models <span class="hljs-keyword">import</span> init_chat_model<br><span class="hljs-keyword">from</span> dotenv <span class="hljs-keyword">import</span> load_dotenv<br>load_dotenv(override=<span class="hljs-literal">True</span>) <span class="hljs-comment"># 加载 .env 文件中的环境变量</span><br><br><span class="hljs-comment"># model = init_chat_model(model=&quot;deepseek-chat&quot;, model_provider=&quot;deepseek&quot;)</span><br>model = init_chat_model(model=<span class="hljs-string">&quot;deepseek-reasoner&quot;</span>, model_provider=<span class="hljs-string">&quot;deepseek&quot;</span>)<br><span class="hljs-comment"># 其中 model 用来指定要使用的模型名称，而 model_provider 用来指定模型提供者，当写入 deepseek 时，会自动加载 langchain-deepseek 的依赖包，自动加载环境变量 DEEPSEEK_API_KEY ，并使用在 model 中指定的模型名称用来进行交互。</span><br><br>question = <span class="hljs-string">&quot;你好，请你介绍一下你自己。&quot;</span><br>result = model.invoke(question)<br><br>result<br><br><span class="hljs-built_in">print</span>(result.content)<br></code></pre></td></tr></table></figure>

<p>不仅仅是<code>DeepSeek</code>模型，<code>LangChain</code>还支持其他很多大模型，如<code>OpenAI</code>、<code>Qwen</code>、<code>Gemini</code>等，我们只需要在<code>init_chat_model</code>函数中指定不同的模型名称，就可以调用不同的模型。关于<code>LangChain</code>都支持哪些大模型以及每个模型对应的是哪个第三方依赖包，大家可以在<code>LangChain</code>的<a target="_blank" rel="noopener" href="https://python.langchain.com/docs/integrations/chat/">官方文档</a>中找到。</p>
<p>考虑到后续要实现<code>RAG</code>需要<code>Embedding</code>模型，而国内只有<code>Dashscope</code>的<code>Embedding</code>模型的<code>api</code>比较稳定，因此在此介绍一下如何接入<code>Dashscope</code>。<code>Dashscope</code>原名是阿里云的灵积社区，也是国内最大的<code>API</code>集成平台，其中包含了各类开源模型（如<code>Qwen3</code>系列模型）和国内在线模型（如<code>DeepSeek</code>、<code>BaiChuan</code>）模型<code>API</code>服务，现在已合并入<a target="_blank" rel="noopener" href="https://bailian.console.aliyun.com/?utm_source=ai-bot.cn">阿里云百炼平台</a>。对于国内开发者来说，若要使用<code>Qwen</code>系列模型<code>API</code>（而非本地部署），那么<code>Dashscope</code>平台提供的<code>API</code>服务肯定是最合适的。</p>
<p>而百炼<code>API</code>获取方式也非常简单，只需注册阿里云账号，然后前往<a target="_blank" rel="noopener" href="https://bailian.console.aliyun.com/?tab=model#/api-key">我的API页面</a>进行充值和注册即可：</p>
<p>然后即可调用海量各类模型了：</p>
<p>当我们完成了DashScope API注册后，即可使用如下代码进行模型调用（需要提前将DASHSCOPE_API_KEY写到本地.env文件中）：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">import</span> os<br><span class="hljs-keyword">from</span> openai <span class="hljs-keyword">import</span> OpenAI<br><span class="hljs-keyword">from</span> dotenv <span class="hljs-keyword">import</span> load_dotenv<br>load_dotenv(override=<span class="hljs-literal">True</span>) <span class="hljs-comment"># 加载 .env 文件中的环境变量</span><br><br>client = OpenAI(<br>    api_key=os.getenv(<span class="hljs-string">&quot;DASHSCOPE_API_KEY&quot;</span>),<br>    base_url=<span class="hljs-string">&quot;https://dashscope.aliyuncs.com/compatible-mode/v1&quot;</span>,<br>)<br><br>completion = client.chat.completions.create(<br>    <span class="hljs-comment"># 模型列表：https://help.aliyun.com/zh/model-studio/getting-started/models</span><br>    model=<span class="hljs-string">&quot;qwen-plus&quot;</span>,<br>    messages=[<br>        &#123;<span class="hljs-string">&quot;role&quot;</span>: <span class="hljs-string">&quot;system&quot;</span>, <span class="hljs-string">&quot;content&quot;</span>: <span class="hljs-string">&quot;You are a helpful assistant.&quot;</span>&#125;,<br>        &#123;<span class="hljs-string">&quot;role&quot;</span>: <span class="hljs-string">&quot;user&quot;</span>, <span class="hljs-string">&quot;content&quot;</span>: <span class="hljs-string">&quot;你是谁？&quot;</span>&#125;,<br>    ],<br>)<br><span class="hljs-built_in">print</span>(completion.model_dump_json())<br></code></pre></td></tr></table></figure>

<p>当然，也可以将<code>DashScope</code>中各类模型接入<code>LangChain</code>：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">pip install --upgrade dashscope -i https://pypi.tuna.tsinghua.edu.cn/simple<br></code></pre></td></tr></table></figure>

<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> langchain_community.chat_models.tongyi <span class="hljs-keyword">import</span> ChatTongyi<br><span class="hljs-keyword">from</span> dotenv <span class="hljs-keyword">import</span> load_dotenv<br>load_dotenv(override=<span class="hljs-literal">True</span>) <span class="hljs-comment"># 加载 .env 文件中的环境变量</span><br><br>model = ChatTongyi()<br><br>question = <span class="hljs-string">&quot;你好，请你介绍一下你自己。&quot;</span><br>result = model.invoke(question)<br><span class="hljs-built_in">print</span>(result.content)<br></code></pre></td></tr></table></figure>

<p>【补充】ollama开源大模型接入LangChain</p>
<p>当然，除了在线大模型的接入，<code>langChain</code>也只是使用<code>Ollama</code>、<code>vLLM</code>等框架启动的本地大模型。这里以<code>ollama</code>为例进行演示。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">pip install langchain-ollama<br></code></pre></td></tr></table></figure>


<p>注意，这里要确保ollama已经顺利开启，并查看当前模型名称：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">ollama list<br></code></pre></td></tr></table></figure>

<p>然后即可使用如下方法接入<code>LangChain</code>：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> langchain_ollama <span class="hljs-keyword">import</span> ChatOllama<br><br>model = ChatOllama(model=<span class="hljs-string">&quot;deepseek-r1&quot;</span>)<br><br>question = <span class="hljs-string">&quot;你好，请你介绍一下你自己。&quot;</span><br>result = model.invoke(question)<br><span class="hljs-built_in">print</span>(result.content)<br></code></pre></td></tr></table></figure>

<h1 id="二、LangChain-核心功能-Chain-的搭建"><a href="#二、LangChain-核心功能-Chain-的搭建" class="headerlink" title="二、LangChain 核心功能 Chain 的搭建"></a>二、LangChain 核心功能 Chain 的搭建</h1><p><code>LangChain</code>之所以被称为<code>LangChain</code>，其核心概念就是<code>Chain</code>。 <code>Chain</code>翻译成中文就是“链”。一个链，指的是可以按照某一种逻辑，按顺序组合成一个流水线的方式。比如我们刚刚实现的问答流程： 用户输入一个问题 –&gt; 发送给大模型 –&gt; 大模型进行推理 –&gt; 将推理结果返回给用户。这个流程就是一个链。</p>
<p>例如，我们这里可以先尝试着搭建一个简单的链，将模型输出结果“过滤”为一个纯字符串格式：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> langchain_core.output_parsers <span class="hljs-keyword">import</span> StrOutputParser<br><span class="hljs-keyword">from</span> langchain.chat_models <span class="hljs-keyword">import</span> init_chat_model<br><span class="hljs-keyword">from</span> dotenv <span class="hljs-keyword">import</span> load_dotenv<br>load_dotenv(override=<span class="hljs-literal">True</span>) <span class="hljs-comment"># 加载 .env 文件中的环境变量</span><br><br><span class="hljs-comment"># 使用 DeepSeek 模型</span><br>model = init_chat_model(model=<span class="hljs-string">&quot;deepseek-chat&quot;</span>, model_provider=<span class="hljs-string">&quot;deepseek&quot;</span>)<br><br><span class="hljs-comment"># 直接使用模型 + 输出解析器搭建一个链</span><br>basic_qa_chain = model | StrOutputParser()<br><br><span class="hljs-comment"># 查看输出结果</span><br>question = <span class="hljs-string">&quot;你好，请你介绍一下你自己。&quot;</span><br>result = basic_qa_chain.invoke(question)<br><br><span class="hljs-built_in">print</span>(result)<br></code></pre></td></tr></table></figure>

<p>此时<code>result</code>就不再是包含各种模型调用信息的结果，而是纯粹的模型响应的字符串结果。而这里用到的<code>StrOutputParser()</code>实际上就是用于构成<code>LangChain</code>中一个链条的一个对象，其核心功能是用于处理模型输出结果。同时我们也能发现，只需要使用<code>Model | OutputParser</code>，即可高效搭建一个链。</p>
<p>一个最基本的<code>Chain</code>结构，是由<code>Model</code>和<code>OutputParser</code>两个组件构成的，其中<code>Model</code>是用来调用大模型的，<code>OutputParser</code>是用来解析大模型的响应结果的。</p>
<p>类似这种结果解析器还有很多，稍后我们会继续进行介绍。</p>
<p>接下来我们尝试为当前的执行流程添加一个提示词模板，我们可以借助<code>ChatPromptTemplate</code>非常便捷的将一个提示词模板同样以链的形式加入到当前任务中：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> langchain_core.output_parsers <span class="hljs-keyword">import</span> StrOutputParser<br><span class="hljs-keyword">from</span> langchain.chat_models <span class="hljs-keyword">import</span> init_chat_model<br><span class="hljs-keyword">from</span> langchain.prompts <span class="hljs-keyword">import</span> ChatPromptTemplate<br><span class="hljs-keyword">from</span> dotenv <span class="hljs-keyword">import</span> load_dotenv<br>load_dotenv(override=<span class="hljs-literal">True</span>) <span class="hljs-comment"># 加载 .env 文件中的环境变量</span><br><br><span class="hljs-comment"># 使用 DeepSeek 模型</span><br>model = init_chat_model(model=<span class="hljs-string">&quot;deepseek-chat&quot;</span>, model_provider=<span class="hljs-string">&quot;deepseek&quot;</span>)<br><br>prompt_template = ChatPromptTemplate([<br>    (<span class="hljs-string">&quot;system&quot;</span>, <span class="hljs-string">&quot;你是一个乐意助人的助手，请根据用户的问题给出回答&quot;</span>),<br>    (<span class="hljs-string">&quot;user&quot;</span>, <span class="hljs-string">&quot;这是用户的问题： &#123;topic&#125;， 请用 yes 或 no 来回答&quot;</span>)<br>])<br><br><span class="hljs-comment"># 直接使用模型 + 输出解析器</span><br>bool_qa_chain = prompt_template | model | StrOutputParser()<br><span class="hljs-comment"># 测试</span><br>question = <span class="hljs-string">&quot;请问 1 + 1 是否 大于 2？&quot;</span><br><span class="hljs-comment"># result = bool_qa_chain.invoke(question)</span><br><span class="hljs-comment"># 建议显式传字典</span><br>result = bool_qa_chain.invoke(&#123;<span class="hljs-string">&quot;topic&quot;</span>: question&#125;)<br><br><span class="hljs-built_in">print</span>(result)<br></code></pre></td></tr></table></figure>

<p>至此，我们就搭建了一个非常基础的链。在<code>LangChain</code>中，一个基础的链主要由三部分构成，分别是提示词模板、大模型和结果解析器（结构化解析器）：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs bash">用户输入<br>  ↓<br>PromptTemplate → ChatModel → OutputParser<br>（提示词模板）   （大模型）    （结构化解析）<br>  ↓<br>结构化结果<br></code></pre></td></tr></table></figure>

<p>结构化解析器功能最多，一些核心的结构化解析器功能如下：</p>
<table>
<thead>
<tr>
<th>解析器名称</th>
<th>功能描述</th>
<th>类型</th>
</tr>
</thead>
<tbody><tr>
<td><strong>BooleanOutputParser</strong></td>
<td>将LLM输出解析为布尔值</td>
<td>基础类型解析</td>
</tr>
<tr>
<td><strong>DatetimeOutputParser</strong></td>
<td>将LLM输出解析为日期时间</td>
<td>基础类型解析</td>
</tr>
<tr>
<td><strong>EnumOutputParser</strong></td>
<td>解析输出为预定义枚举值之一</td>
<td>基础类型解析</td>
</tr>
<tr>
<td><strong>RegexParser</strong></td>
<td>使用正则表达式解析LLM输出</td>
<td>模式匹配解析</td>
</tr>
<tr>
<td><strong>RegexDictParser</strong></td>
<td>使用正则表达式将输出解析为字典</td>
<td>模式匹配解析</td>
</tr>
<tr>
<td><strong>StructuredOutputParser</strong></td>
<td>将LLM输出解析为结构化格式</td>
<td>结构化解析</td>
</tr>
<tr>
<td><strong>YamlOutputParser</strong></td>
<td>使用Pydantic模型解析YAML输出</td>
<td>结构化解析</td>
</tr>
<tr>
<td><strong>PandasDataFrameOutputParser</strong></td>
<td>使用Pandas DataFrame格式解析输出</td>
<td>数据处理解析</td>
</tr>
<tr>
<td><strong>CombiningOutputParser</strong></td>
<td>将多个输出解析器组合为一个</td>
<td>组合解析器</td>
</tr>
<tr>
<td><strong>OutputFixingParser</strong></td>
<td>包装解析器并尝试修复解析错误</td>
<td>错误处理解析</td>
</tr>
<tr>
<td><strong>RetryOutputParser</strong></td>
<td>包装解析器并尝试修复解析错误</td>
<td>错误处理解析</td>
</tr>
<tr>
<td><strong>RetryWithErrorOutputParser</strong></td>
<td>包装解析器并尝试修复解析错误</td>
<td>错误处理解析</td>
</tr>
<tr>
<td><strong>ResponseSchema</strong></td>
<td>结构化输出解析器的响应模式</td>
<td>辅助类</td>
</tr>
</tbody></table>
<p>一些功能实现如下</p>
<p>例如借助结构化解析器可以将<code>yes or no</code>转化为<code>True or Fasle</code>：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> langchain.output_parsers <span class="hljs-keyword">import</span> BooleanOutputParser<br><span class="hljs-keyword">from</span> langchain.chat_models <span class="hljs-keyword">import</span> init_chat_model<br><span class="hljs-keyword">from</span> langchain.prompts <span class="hljs-keyword">import</span> ChatPromptTemplate<br><span class="hljs-keyword">from</span> dotenv <span class="hljs-keyword">import</span> load_dotenv<br>load_dotenv(override=<span class="hljs-literal">True</span>) <span class="hljs-comment"># 加载 .env 文件中的环境变量</span><br><br><span class="hljs-comment"># 使用 DeepSeek 模型</span><br>model = init_chat_model(model=<span class="hljs-string">&quot;deepseek-chat&quot;</span>, model_provider=<span class="hljs-string">&quot;deepseek&quot;</span>)<br><br>prompt_template = ChatPromptTemplate([<br>    (<span class="hljs-string">&quot;system&quot;</span>, <span class="hljs-string">&quot;你是一个乐意助人的助手，请根据用户的问题给出回答&quot;</span>),<br>    (<span class="hljs-string">&quot;user&quot;</span>, <span class="hljs-string">&quot;这是用户的问题： &#123;topic&#125;， 请用 yes 或 no 来回答&quot;</span>)<br>])<br><br><span class="hljs-comment"># 直接使用模型 + 输出解析器</span><br>bool_qa_chain = prompt_template | model | BooleanOutputParser()<br><span class="hljs-comment"># 测试</span><br>question = <span class="hljs-string">&quot;请问 1 + 1 是否 大于 2？&quot;</span><br>result = bool_qa_chain.invoke(question)<br><br><span class="hljs-built_in">print</span>(result) <span class="hljs-comment"># false</span><br></code></pre></td></tr></table></figure>

<p>而<code>StructuredOutputParser</code>则可以在文档中提取指定的结构化信息：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> langchain.chat_models <span class="hljs-keyword">import</span> init_chat_model<br><span class="hljs-keyword">from</span> langchain_core.prompts <span class="hljs-keyword">import</span> PromptTemplate<br><span class="hljs-keyword">from</span> langchain.output_parsers <span class="hljs-keyword">import</span> ResponseSchema, StructuredOutputParser<br><span class="hljs-keyword">from</span> dotenv <span class="hljs-keyword">import</span> load_dotenv<br>load_dotenv(override=<span class="hljs-literal">True</span>) <span class="hljs-comment"># 加载 .env 文件中的环境变量</span><br><br><span class="hljs-comment"># 使用 DeepSeek 模型</span><br>model = init_chat_model(model=<span class="hljs-string">&quot;deepseek-chat&quot;</span>, model_provider=<span class="hljs-string">&quot;deepseek&quot;</span>)<br><br>schemas = [<br>    ResponseSchema(name=<span class="hljs-string">&quot;name&quot;</span>, description=<span class="hljs-string">&quot;用户的姓名&quot;</span>),<br>    ResponseSchema(name=<span class="hljs-string">&quot;age&quot;</span>, description=<span class="hljs-string">&quot;用户的年龄&quot;</span>)<br>]<br><br>parser = StructuredOutputParser.from_response_schemas(schemas)<br><br>prompt = PromptTemplate.from_template(<br>    <span class="hljs-string">&quot;请根据以下内容提取用户信息，并返回 JSON 格式：\n&#123;input&#125;\n\n&#123;format_instructions&#125;&quot;</span><br>)<br><br>chain = (<br>    prompt.partial(format_instructions=parser.get_format_instructions()) | model | parser<br>)<br><br>result = chain.invoke(&#123;<span class="hljs-string">&quot;input&quot;</span>: <span class="hljs-string">&quot;用户叫李雷，今年25岁，是一名工程师。&quot;</span>&#125;)<br><span class="hljs-built_in">print</span>(result) <span class="hljs-comment"># &#123;&#x27;name&#x27;: &#x27;李雷&#x27;, &#x27;age&#x27;: &#x27;25&#x27;&#125;</span><br></code></pre></td></tr></table></figure>

<p>这里我们在 <code>PromptTemplate </code>中，定义了两个占位符变量：</p>
<ul>
<li><p><code>&#123;input&#125;</code> → 将由用户传入的文本替换（如 “用户叫李雷，今年25岁…”）</p>
</li>
<li><p><code>&#123;format_instructions&#125;</code> → 会通过 <code>partial(...)</code> 提前绑定结构化格式说明</p>
</li>
</ul>
<p>而格式化说明使用<code>format_instructions</code>进行标识其实也是一种约定俗称的方法，上述代码也就是相当于在创建<code>Chain</code>的时候，我们就输入了<code>&#123;format_instructions&#125;</code>对应的字符串<code>parser.get_format_instructions()</code>，我们也可以通过如下代码进行打印查看：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-built_in">print</span>(parser.get_format_instructions())<br></code></pre></td></tr></table></figure>

<p>输出为：</p>
<figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs text">The output should be a markdown code snippet formatted in the following schema, including the leading and trailing &quot;```json&quot; and &quot;```&quot;:<br><br>```json<br>&#123;<br>	&quot;name&quot;: string  // 用户的姓名<br>	&quot;age&quot;: string  // 用户的年龄<br>&#125;<br>```<br></code></pre></td></tr></table></figure>

<p>我们也可以进一步创建复合链</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> langchain.chat_models <span class="hljs-keyword">import</span> init_chat_model<br><span class="hljs-keyword">from</span> langchain_core.prompts <span class="hljs-keyword">import</span> PromptTemplate<br><span class="hljs-keyword">from</span> langchain.output_parsers <span class="hljs-keyword">import</span> ResponseSchema, StructuredOutputParser<br><span class="hljs-keyword">from</span> dotenv <span class="hljs-keyword">import</span> load_dotenv<br>load_dotenv(override=<span class="hljs-literal">True</span>) <span class="hljs-comment"># 加载 .env 文件中的环境变量</span><br><br><span class="hljs-comment"># 使用 DeepSeek 模型</span><br>model = init_chat_model(model=<span class="hljs-string">&quot;deepseek-chat&quot;</span>, model_provider=<span class="hljs-string">&quot;deepseek&quot;</span>)<br><br><span class="hljs-comment"># 第一步：根据标题生成新闻正文</span><br>news_gen_prompt = PromptTemplate.from_template(<br>    <span class="hljs-string">&quot;请根据以下新闻标题撰写一段简短的新闻内容（100字以内）：\n\n标题：&#123;title&#125;&quot;</span><br>)<br><br><span class="hljs-comment"># 第一个子链：生成新闻内容</span><br>news_chain = news_gen_prompt | model<br><br><span class="hljs-comment"># 第二步：从正文中提取结构化字段</span><br>schemas = [<br>    ResponseSchema(name=<span class="hljs-string">&quot;time&quot;</span>, description=<span class="hljs-string">&quot;事件发生的时间&quot;</span>),<br>    ResponseSchema(name=<span class="hljs-string">&quot;location&quot;</span>, description=<span class="hljs-string">&quot;事件发生的地点&quot;</span>),<br>    ResponseSchema(name=<span class="hljs-string">&quot;event&quot;</span>, description=<span class="hljs-string">&quot;发生的具体事件&quot;</span>),<br>]<br>parser = StructuredOutputParser.from_response_schemas(schemas)<br><br>summary_prompt = PromptTemplate.from_template(<br>    <span class="hljs-string">&quot;请从下面这段新闻内容中提取关键信息，并返回结构化JSON格式：\n\n&#123;news&#125;\n\n&#123;format_instructions&#125;&quot;</span><br>)<br><br><span class="hljs-comment"># 第二个子链：生成新闻摘要</span><br>summary_chain = (<br>    summary_prompt.partial(format_instructions=parser.get_format_instructions())<br>    | model<br>    | parser<br>)<br><br><span class="hljs-comment"># 组合成一个复合 Chain</span><br>full_chain = news_chain | summary_chain<br><br><span class="hljs-comment"># 调用复合链</span><br>result = full_chain.invoke(&#123;<span class="hljs-string">&quot;title&quot;</span>: <span class="hljs-string">&quot;苹果公司在加州发布新款AI芯片&quot;</span>&#125;)<br><span class="hljs-built_in">print</span>(result)<br></code></pre></td></tr></table></figure>

<p><strong>管道操作符 <code>|</code> 会自动将前一个链的输出作为后一个链的输入</strong>，整体流程如下所示：</p>
<figure class="highlight tex"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><code class="hljs tex">用户输入（title）  <br>        │  <br>        ▼  <br>┌────────────────────────────┐  <br>│  Chain 1: 生成新闻正文       │  <br>│  Prompt: news<span class="hljs-built_in">_</span>gen<span class="hljs-built_in">_</span>prompt   │  <br>│  Model: DeepSeek           │  <br>└────────────────────────────┘  <br>        │  <br>        ▼  <br>生成的新闻内容（news）  <br>        │  <br>        ▼  <br>┌───────────────────────────────────────┐  <br>│  Chain 2: 提取结构化字段(摘要)           │  <br>│  Prompt: summary<span class="hljs-built_in">_</span>pro                  │  <br>│  Model: DeepSeek                      │  <br>│  OutputParser: StructuredOutputParser │  <br>└───────────────────────────────────────┘  <br>        │  <br>        ▼  <br>结化输出（如 JSON：时间、地点、事件）<br></code></pre></td></tr></table></figure>

<p>也可以借助<code>LangChain</code>适配器设置自定义可运行的节点</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> langchain.chat_models <span class="hljs-keyword">import</span> init_chat_model<br><span class="hljs-keyword">from</span> langchain_core.prompts <span class="hljs-keyword">import</span> PromptTemplate<br><span class="hljs-keyword">from</span> langchain.output_parsers <span class="hljs-keyword">import</span> ResponseSchema, StructuredOutputParser<br><span class="hljs-keyword">from</span> langchain_core.runnables <span class="hljs-keyword">import</span> RunnableLambda<br><span class="hljs-keyword">from</span> dotenv <span class="hljs-keyword">import</span> load_dotenv<br>load_dotenv(override=<span class="hljs-literal">True</span>) <span class="hljs-comment"># 加载 .env 文件中的环境变量</span><br><br><span class="hljs-comment"># 使用 DeepSeek 模型</span><br>model = init_chat_model(model=<span class="hljs-string">&quot;deepseek-chat&quot;</span>, model_provider=<span class="hljs-string">&quot;deepseek&quot;</span>)<br><br><span class="hljs-comment"># 第一步：根据标题生成新闻正文</span><br>news_gen_prompt = PromptTemplate.from_template(<br>    <span class="hljs-string">&quot;请根据以下新闻标题撰写一段简短的新闻内容（100字以内）：\n\n标题：&#123;title&#125;&quot;</span><br>)<br><br><span class="hljs-comment"># 第一个子链：生成新闻内容</span><br>news_chain = news_gen_prompt | model<br><br><span class="hljs-comment"># 第二步：从正文中提取结构化字段</span><br>schemas = [<br>    ResponseSchema(name=<span class="hljs-string">&quot;time&quot;</span>, description=<span class="hljs-string">&quot;事件发生的时间&quot;</span>),<br>    ResponseSchema(name=<span class="hljs-string">&quot;location&quot;</span>, description=<span class="hljs-string">&quot;事件发生的地点&quot;</span>),<br>    ResponseSchema(name=<span class="hljs-string">&quot;event&quot;</span>, description=<span class="hljs-string">&quot;发生的具体事件&quot;</span>),<br>]<br>parser = StructuredOutputParser.from_response_schemas(schemas)<br><br>summary_prompt = PromptTemplate.from_template(<br>    <span class="hljs-string">&quot;请从下面这段新闻内容中提取关键信息，并返回结构化JSON格式：\n\n&#123;news&#125;\n\n&#123;format_instructions&#125;&quot;</span><br>)<br><br><span class="hljs-comment"># 第二个子链：生成新闻摘要</span><br>summary_chain = (<br>    summary_prompt.partial(format_instructions=parser.get_format_instructions())<br>    | model<br>    | parser<br>)<br><br><span class="hljs-comment"># 一个简单的打印函数，调试用</span><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">debug_print</span>(<span class="hljs-params">x</span>):<br>    <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;中间结果（新闻正文）:&quot;</span>, x)<br>    <span class="hljs-keyword">return</span> x<br><br>debug_node = RunnableLambda(debug_print)<br><br><span class="hljs-comment"># 插入 debug 节点</span><br>full_chain = news_chain | debug_node | summary_chain<br><br><span class="hljs-comment"># 调用复合链</span><br>result = full_chain.invoke(&#123;<span class="hljs-string">&quot;title&quot;</span>: <span class="hljs-string">&quot;苹果公司在加州发布新款AI芯片&quot;</span>&#125;)<br><span class="hljs-built_in">print</span>(result)<br></code></pre></td></tr></table></figure>

<p>通过上述不同的尝试，我们就已经理解了在<code>langChain</code>中，如何使用<code>ChatPromptTemplate</code>、<code>Model</code>、<code>OutputParser</code>来构建一个简单的<code>Chain</code>。其中：</p>
<ol>
<li><code>ChatPromptTemplate</code> 是用来构建提示模板的，将输入的问题转化为消息列表，可以设置系统指令，也可以添加一些变量；</li>
<li><code>Model</code> 是用来调用大模型的，可以指定使用不同的模型；</li>
<li><code>OutputParser</code> 是用来解析大模型的响应结果的，可以指定使用不同的解析器。</li>
</ol>
<blockquote>
<p>[补充] LCEL关键概念介绍</p>
<p>什么是 LCEL？——LangChain Expression Language 详解</p>
<p>在现代大语言模型（<code>LLM</code>）应用的构建中，<code>LangChain </code>提供了一种全新的表达范式，被称为 <strong><code>LCEL</code>（<code>LangChain Expression Language</code>）</strong>。它不仅简化了模型交互的编排过程，还增强了组合的灵活性和可维护性。本文将从概念、设计目的、核心特性和实际价值几个方面，系统性地介绍 LCEL 的本质。</p>
<hr>
<p>一、LCEL 的定义</p>
<p><code>LCEL</code>，全称为 **<code>LangChain Expression Language</code>**，是一种专为 <code>LangChain </code>框架设计的表达语言。它通过一种链式组合的方式，允许开发者使用清晰、声明式的语法来构建语言模型驱动的应用流程。</p>
<p>简单来说，<code>LCEL</code> 是一种“函数式管道风格”的组件组合机制，用于连接各种可执行单元（<code>Runnable</code>）。这些单元包括提示模板、语言模型、输出解析器、工具函数等。</p>
<hr>
<p>二、设计目的</p>
<p><code>LCEL </code>的设计初衷在于：</p>
<ol>
<li><strong>模块化构建</strong>：将模型调用流程拆解为独立、可重用的组件。</li>
<li><strong>逻辑可视化</strong>：通过语法符号（如管道符 <code>|</code>）呈现出明确的数据流路径。</li>
<li><strong>统一运行接口</strong>：所有 <code>LCEL </code>组件都实现了 <code>.invoke()</code>、<code>.stream()</code>、<code>.batch()</code> 等标准方法，便于在同步、异步或批处理环境下调用。</li>
<li><strong>脱离框架限制</strong>：相比传统的 <code>Chain</code> 类和 <code>Agent</code> 架构，<code>LCEL </code>更轻量、更具表达力，减少依赖的“黑盒”逻辑。</li>
</ol>
<hr>
<p>三、核心组成</p>
<ol>
<li><code>Runnable </code>接口</li>
</ol>
<p><code>LCEL </code>的一切基础单元都是 <code>Runnable</code> 对象，它是一种统一的可调用接口，支持如下形式：</p>
<ul>
<li><code>.invoke(input)</code>：同步调用</li>
<li><code>.stream(input)</code>：流式生成</li>
<li><code>.batch(inputs)</code>：批量执行</li>
</ul>
<ol start="2">
<li>管道运算符 <code>|</code></li>
</ol>
<p>这是 <code>LCEL </code>最具特色的语法符号。多个 <code>Runnable</code> 对象可以通过 <code>|</code> 串联起来，形成清晰的数据处理链。例如：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs python">prompt | model | parser<br></code></pre></td></tr></table></figure>

<p>表示数据将依次传入提示模板、模型和输出解析器，最终输出结构化结果。</p>
<ol start="3">
<li><code>PromptTemplate </code>与 <code>OutputParser</code></li>
</ol>
<p><code>LCEL </code>强调组件之间的职责明确，<code>Prompt </code>只负责模板化输入，<code>Parser </code>只负责格式化输出，<code>Model </code>只负责推理。</p>
<hr>
<p>四、典型优势</p>
<table>
<thead>
<tr>
<th>特性</th>
<th>描述</th>
<th></th>
</tr>
</thead>
<tbody><tr>
<td>简洁语法</td>
<td>使用 `</td>
<td>` 运算符提升可读性</td>
</tr>
<tr>
<td>灵活组合</td>
<td>可任意组合 <code>Prompt</code>、模型、工具、函数等组件</td>
<td></td>
</tr>
<tr>
<td>明确边界</td>
<td>每个步骤职责分明，方便调试与重用</td>
<td></td>
</tr>
<tr>
<td>可嵌套扩展</td>
<td>支持函数包装、自定义中间组件和流式拓展</td>
<td></td>
</tr>
<tr>
<td>与 <code>Gradio/FastAPI</code> 集成良好</td>
<td>可用于构建 <code>API</code>、<code>UI </code>聊天等多种场景</td>
<td></td>
</tr>
</tbody></table>
<hr>
<p>五、总结</p>
<p>LCEL 是 LangChain 在 2024 年末引入的一项重要特性，标志着从传统 Agent 架构向“声明式、组合式”开发范式的转变。它不仅让开发者能以更清晰的方式组织 LLM 工作流，也大大提高了系统的可维护性与可测试性。</p>
</blockquote>
<h1 id="三、LangChain-记忆存储与搭建多轮对话机器人"><a href="#三、LangChain-记忆存储与搭建多轮对话机器人" class="headerlink" title="三、LangChain 记忆存储与搭建多轮对话机器人"></a>三、<strong>LangChain 记忆存储与搭建多轮对话机器人</strong></h1><p>在<code>langChain</code>中构建一个基本的问答机器人仅需要使用一个<code>Chain</code>便可以快速实现，如下所示：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> langchain_core.output_parsers <span class="hljs-keyword">import</span> StrOutputParser<br><span class="hljs-keyword">from</span> langchain.prompts <span class="hljs-keyword">import</span> ChatPromptTemplate<br><span class="hljs-keyword">from</span> langchain.chat_models <span class="hljs-keyword">import</span> init_chat_model<br><span class="hljs-keyword">from</span> dotenv <span class="hljs-keyword">import</span> load_dotenv<br>load_dotenv(override=<span class="hljs-literal">True</span>) <span class="hljs-comment"># 加载 .env 文件中的环境变量</span><br><br>chatbot_prompt = ChatPromptTemplate.from_messages([<br>    (<span class="hljs-string">&quot;system&quot;</span>, <span class="hljs-string">&quot;你叫小橘，是一名乐于助人的助手。&quot;</span>),<br>    (<span class="hljs-string">&quot;user&quot;</span>, <span class="hljs-string">&quot;&#123;input&#125;&quot;</span>)<br>])<br><br><span class="hljs-comment"># 使用 DeepSeek 模型</span><br>model = init_chat_model(model=<span class="hljs-string">&quot;deepseek-chat&quot;</span>, model_provider=<span class="hljs-string">&quot;deepseek&quot;</span>)<br><br><span class="hljs-comment"># 直接使用模型 + 输出解析器</span><br>basic_qa_chain = chatbot_prompt | model | StrOutputParser()<br><br><span class="hljs-comment"># 测试</span><br>question = <span class="hljs-string">&quot;你好，请你介绍一下你自己。&quot;</span><br>result = basic_qa_chain.invoke(question)<br><span class="hljs-built_in">print</span>(result)<br></code></pre></td></tr></table></figure>

<p>在<code>LangChain</code>中，我们可以通过人工拼接消息队列，来为每次模型调用设置多轮对话记忆。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> langchain_core.messages <span class="hljs-keyword">import</span> AIMessage, HumanMessage, SystemMessage<br><span class="hljs-keyword">from</span> langchain_core.prompts <span class="hljs-keyword">import</span> ChatPromptTemplate, MessagesPlaceholder<br><span class="hljs-keyword">from</span> langchain.chat_models <span class="hljs-keyword">import</span> init_chat_model<br><span class="hljs-keyword">from</span> langchain_core.output_parsers <span class="hljs-keyword">import</span> StrOutputParser<br><span class="hljs-keyword">from</span> dotenv <span class="hljs-keyword">import</span> load_dotenv<br>load_dotenv(override=<span class="hljs-literal">True</span>) <span class="hljs-comment"># 加载 .env 文件中的环境变量</span><br><br>model  = init_chat_model(model=<span class="hljs-string">&quot;deepseek-chat&quot;</span>, model_provider=<span class="hljs-string">&quot;deepseek&quot;</span>)<br>parser = StrOutputParser()<br><br>prompt = ChatPromptTemplate.from_messages([<br>    SystemMessage(content=<span class="hljs-string">&quot;你叫小橘，是一名乐于助人的助手。&quot;</span>),<br>    MessagesPlaceholder(variable_name=<span class="hljs-string">&quot;messages&quot;</span>),<br>])<br><br>chain = prompt | model | parser<br><br>messages_list = []  <span class="hljs-comment"># 初始化历史</span><br><span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;🔹 输入 exit 结束对话&quot;</span>)<br><span class="hljs-keyword">while</span> <span class="hljs-literal">True</span>:<br>    user_query = <span class="hljs-built_in">input</span>(<span class="hljs-string">&quot;你：&quot;</span>)<br>    <span class="hljs-keyword">if</span> user_query.lower() <span class="hljs-keyword">in</span> &#123;<span class="hljs-string">&quot;exit&quot;</span>, <span class="hljs-string">&quot;quit&quot;</span>&#125;:<br>        <span class="hljs-keyword">break</span><br><br>    <span class="hljs-comment"># 1) 追加用户消息</span><br>    messages_list.append(HumanMessage(content=user_query))<br><br>    <span class="hljs-comment"># 2) 调用模型</span><br>    assistant_reply = chain.invoke(&#123;<span class="hljs-string">&quot;messages&quot;</span>: messages_list&#125;)<br>    <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;小橘：&quot;</span>, assistant_reply)<br><br>    <span class="hljs-comment"># 3) 追加 AI 回复</span><br>    messages_list.append(AIMessage(content=assistant_reply))<br><br>    <span class="hljs-comment"># 4) 仅保留最近 50 条</span><br>    messages_list = messages_list[-<span class="hljs-number">50</span>:]<br></code></pre></td></tr></table></figure>

<p>此外还有一个问题是，大家经常看到的问答机器人其实都是采用流式传输模式。用户输入问题，等待模型直接返回回答，然后用户再输入问题，模型再返回回答，这样循环下去，用户输入问题和模型返回回答之间的时间间隔太长，导致用户感觉机器人反应很慢。所以<code>LangChain</code>提供了一个<code>astream</code>方法，可以实现流式输出，即一旦模型有输出，就立即返回，这样用户就可以看到模型正在思考，而不是等待模型思考完再返回。</p>
<p>实现的方法也非常简单，只需要在调用模型时将<code>invoke</code>方法替换为<code>astream</code>方法，然后使用<code>async for</code>循环来持续获取模型的输出即可。代码如下：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> langchain_core.output_parsers <span class="hljs-keyword">import</span> StrOutputParser<br><span class="hljs-keyword">from</span> langchain.chat_models <span class="hljs-keyword">import</span> init_chat_model<br><span class="hljs-keyword">from</span> langchain.prompts <span class="hljs-keyword">import</span> ChatPromptTemplate<br><span class="hljs-keyword">from</span> dotenv <span class="hljs-keyword">import</span> load_dotenv<br><span class="hljs-keyword">import</span> asyncio<br><br>load_dotenv(override=<span class="hljs-literal">True</span>)  <span class="hljs-comment"># 加载 .env 文件中的环境变量</span><br><br>chatbot_prompt = ChatPromptTemplate.from_messages([<br>    (<span class="hljs-string">&quot;system&quot;</span>, <span class="hljs-string">&quot;你叫小智，是一名乐于助人的助手。&quot;</span>),<br>    (<span class="hljs-string">&quot;user&quot;</span>, <span class="hljs-string">&quot;&#123;input&#125;&quot;</span>)<br>])<br><br><span class="hljs-comment"># 使用 DeepSeek 模型</span><br>model = init_chat_model(model=<span class="hljs-string">&quot;deepseek-chat&quot;</span>, model_provider=<span class="hljs-string">&quot;deepseek&quot;</span>)<br><br><span class="hljs-comment"># 直接使用提示模版 + 模型 + 输出解析器</span><br>qa_chain_with_system = chatbot_prompt | model | StrOutputParser()<br><br><span class="hljs-keyword">async</span> <span class="hljs-keyword">def</span> <span class="hljs-title function_">main</span>():<br>    <span class="hljs-keyword">async</span> <span class="hljs-keyword">for</span> chunk <span class="hljs-keyword">in</span> qa_chain_with_system.astream(&#123;<span class="hljs-string">&quot;input&quot;</span>: <span class="hljs-string">&quot;你好，请你介绍一下你自己&quot;</span>&#125;):<br>        <span class="hljs-built_in">print</span>(chunk, end=<span class="hljs-string">&quot;&quot;</span>, flush=<span class="hljs-literal">True</span>)<br><br><span class="hljs-comment"># 运行异步主函数</span><br>asyncio.run(main())<br></code></pre></td></tr></table></figure>

<p>同样的，可以进一步为每次模型调用设置多轮对话记忆。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">import</span> asyncio<br><span class="hljs-keyword">from</span> langchain_core.messages <span class="hljs-keyword">import</span> AIMessage, HumanMessage, SystemMessage<br><span class="hljs-keyword">from</span> langchain_core.prompts <span class="hljs-keyword">import</span> ChatPromptTemplate, MessagesPlaceholder<br><span class="hljs-keyword">from</span> langchain.chat_models <span class="hljs-keyword">import</span> init_chat_model<br><span class="hljs-keyword">from</span> langchain_core.output_parsers <span class="hljs-keyword">import</span> StrOutputParser<br><span class="hljs-keyword">from</span> dotenv <span class="hljs-keyword">import</span> load_dotenv<br><br>load_dotenv(override=<span class="hljs-literal">True</span>)  <span class="hljs-comment"># 加载 .env 文件中的环境变量</span><br><br>model = init_chat_model(model=<span class="hljs-string">&quot;deepseek-chat&quot;</span>, model_provider=<span class="hljs-string">&quot;deepseek&quot;</span>)<br>parser = StrOutputParser()<br><br>prompt = ChatPromptTemplate.from_messages([<br>    SystemMessage(content=<span class="hljs-string">&quot;你叫小橘，是一名乐于助人的助手。&quot;</span>),<br>    MessagesPlaceholder(variable_name=<span class="hljs-string">&quot;messages&quot;</span>),<br>])<br><br>chain = prompt | model | parser<br><span class="hljs-keyword">async</span> <span class="hljs-keyword">def</span> <span class="hljs-title function_">main</span>():<br>    messages_list = []  <span class="hljs-comment"># 初始化历史</span><br>    <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;🔹 输入 exit 结束对话&quot;</span>)<br><br>    <span class="hljs-keyword">while</span> <span class="hljs-literal">True</span>:<br>        user_query = <span class="hljs-built_in">input</span>(<span class="hljs-string">&quot;你：&quot;</span>)<br>        <span class="hljs-keyword">if</span> user_query.lower() <span class="hljs-keyword">in</span> &#123;<span class="hljs-string">&quot;exit&quot;</span>, <span class="hljs-string">&quot;quit&quot;</span>&#125;:<br>            <span class="hljs-keyword">break</span><br><br>        <span class="hljs-comment"># 1) 追加用户消息</span><br>        messages_list.append(HumanMessage(content=user_query))<br><br>        <span class="hljs-comment"># 2) 调用模型（异步流式输出）</span><br>        <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;小橘：&quot;</span>, end=<span class="hljs-string">&quot;&quot;</span>, flush=<span class="hljs-literal">True</span>)<br>        assistant_reply = <span class="hljs-string">&quot;&quot;</span><br>        <span class="hljs-keyword">async</span> <span class="hljs-keyword">for</span> chunk <span class="hljs-keyword">in</span> chain.astream(&#123;<span class="hljs-string">&quot;messages&quot;</span>: messages_list&#125;):<br>            <span class="hljs-built_in">print</span>(chunk, end=<span class="hljs-string">&quot;&quot;</span>, flush=<span class="hljs-literal">True</span>)<br>            assistant_reply += chunk  <span class="hljs-comment"># 收集回复内容</span><br>        <span class="hljs-built_in">print</span>() <span class="hljs-comment"># 换行</span><br><br>        <span class="hljs-comment"># 3) 追加 AI 回复</span><br>        messages_list.append(AIMessage(content=assistant_reply))<br><br>        <span class="hljs-comment"># 4) 仅保留最近 50 条</span><br>        messages_list = messages_list[-<span class="hljs-number">50</span>:]<br><br><span class="hljs-comment"># 运行异步主函数</span><br>asyncio.run(main())<br></code></pre></td></tr></table></figure>

<p>如上所示展示的问答效果就是我们在构建大模型应用时需要实现的流式输出效果。接下来我们就进一步地，使用<code>gradio</code>来开发一个支持在网页上进行交互的问答机器人。<code>Gradio </code>是一个用于快速构建机器学习模型<strong>交互式演示界面</strong>的 <code>Python </code>库。它允许开发者用几行代码创建 <code>Web </code>应用，无需前端知识即可让用户通过浏览器输入数据并查看模型预测结果。</p>
<p>首先需要安装一下<code>gradio</code>的第三方依赖包</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">pip install gradio<br></code></pre></td></tr></table></figure>

<p>完整实现的代码如下：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-comment"># 导入必要的库</span><br><span class="hljs-keyword">import</span> gradio <span class="hljs-keyword">as</span> gr  <span class="hljs-comment"># 用于构建Web界面的库</span><br><span class="hljs-keyword">from</span> langchain.chat_models <span class="hljs-keyword">import</span> init_chat_model  <span class="hljs-comment"># 初始化聊天模型的函数</span><br><span class="hljs-keyword">from</span> langchain_core.output_parsers <span class="hljs-keyword">import</span> StrOutputParser  <span class="hljs-comment"># 字符串输出解析器</span><br><span class="hljs-keyword">from</span> langchain_core.prompts <span class="hljs-keyword">import</span> ChatPromptTemplate, MessagesPlaceholder  <span class="hljs-comment"># 聊天提示模板和消息占位符</span><br><span class="hljs-keyword">from</span> langchain_core.messages <span class="hljs-keyword">import</span> SystemMessage, HumanMessage, AIMessage  <span class="hljs-comment"># 系统消息、人类消息和AI消息</span><br><span class="hljs-keyword">from</span> dotenv <span class="hljs-keyword">import</span> load_dotenv  <span class="hljs-comment"># 用于加载环境变量</span><br>load_dotenv(override=<span class="hljs-literal">True</span>)  <span class="hljs-comment"># 加载 .env 文件中的环境变量（用于存储API密钥等敏感信息）</span><br><br><span class="hljs-comment"># ==================== 第一部分：设置语言模型和对话链 ====================</span><br><br><span class="hljs-comment"># 1. 初始化聊天模型</span><br><span class="hljs-comment"># 使用&quot;deepseek-chat&quot;模型，模型提供者为&quot;deepseek&quot;</span><br>model = init_chat_model(<span class="hljs-string">&quot;deepseek-chat&quot;</span>, model_provider=<span class="hljs-string">&quot;deepseek&quot;</span>)<br><br><span class="hljs-comment"># 2. 创建输出解析器（将模型输出转换为字符串）</span><br>parser = StrOutputParser()<br><br><span class="hljs-comment"># 3. 创建聊天提示模板</span><br><span class="hljs-comment"># 这里定义了一个系统消息（设置AI助手的角色）和一个消息占位符（用于传入对话历史）</span><br>chatbot_prompt = ChatPromptTemplate.from_messages(<br>    [<br>        SystemMessage(content=<span class="hljs-string">&quot;你叫小橘，是一名乐于助人的助手。&quot;</span>),  <span class="hljs-comment"># 系统角色设定</span><br>        MessagesPlaceholder(variable_name=<span class="hljs-string">&quot;messages&quot;</span>),  <span class="hljs-comment"># 手动传入历史对话消息</span><br>    ]<br>)<br><br><span class="hljs-comment"># 4. 创建对话链</span><br><span class="hljs-comment"># 使用LangChain的LCEL（LangChain Expression Language）将提示模板、模型和解析器组合起来</span><br><span class="hljs-comment"># 流程：提示模板 -&gt; 模型 -&gt; 输出解析器</span><br>qa_chain = chatbot_prompt | model | parser<br><br><span class="hljs-comment"># ==================== 第二部分：创建Gradio界面 ====================</span><br><br><span class="hljs-comment"># 定义CSS样式（用于美化界面）</span><br>CSS = <span class="hljs-string">&quot;&quot;&quot;</span><br><span class="hljs-string">.main-container &#123;max-width: 1200px; margin: 0 auto; padding: 20px;&#125;  # 主容器样式</span><br><span class="hljs-string">.header-text &#123;text-align: center; margin-bottom: 20px;&#125;  # 标题样式</span><br><span class="hljs-string">&quot;&quot;&quot;</span><br><br><span class="hljs-comment"># 创建聊天机器人界面的函数</span><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">create_chatbot</span>() -&gt; gr.Blocks:<br>    <span class="hljs-comment"># 创建一个Gradio Blocks界面（比Interface更灵活）</span><br>    <span class="hljs-keyword">with</span> gr.Blocks(title=<span class="hljs-string">&quot;DeepSeek Chat&quot;</span>, css=CSS) <span class="hljs-keyword">as</span> demo:  <span class="hljs-comment"># 设置标题和CSS</span><br>        <span class="hljs-comment"># 主容器（使用上面定义的CSS类）</span><br>        <span class="hljs-keyword">with</span> gr.Column(elem_classes=[<span class="hljs-string">&quot;main-container&quot;</span>]):<br>            <span class="hljs-comment"># 标题</span><br>            gr.Markdown(<span class="hljs-string">&quot;# 流式对话机器人&quot;</span>, elem_classes=[<span class="hljs-string">&quot;header-text&quot;</span>])<br>            <br>            <span class="hljs-comment"># 聊天机器人组件</span><br>            chatbot = gr.Chatbot(<br>                height=<span class="hljs-number">500</span>,  <span class="hljs-comment"># 高度500像素</span><br>                show_copy_button=<span class="hljs-literal">True</span>,  <span class="hljs-comment"># 显示复制按钮</span><br>                avatar_images=(  <span class="hljs-comment"># 设置头像</span><br>                    <span class="hljs-string">&quot;https://smallgoodgood.top/images/23.jpg&quot;</span>,  <span class="hljs-comment"># 用户头像</span><br>                    <span class="hljs-string">&quot;https://smallgoodgood.top/images/23.jpg&quot;</span>,  <span class="hljs-comment"># AI头像</span><br>                )<br>            )<br>            <br>            <span class="hljs-comment"># 输入框和按钮</span><br>            msg = gr.Textbox(placeholder=<span class="hljs-string">&quot;请输入您的问题...&quot;</span>, container=<span class="hljs-literal">False</span>, scale=<span class="hljs-number">7</span>)  <span class="hljs-comment"># 文本输入框</span><br>            submit = gr.Button(<span class="hljs-string">&quot;发送&quot;</span>, scale=<span class="hljs-number">1</span>, variant=<span class="hljs-string">&quot;primary&quot;</span>)  <span class="hljs-comment"># 发送按钮（主要样式）</span><br>            clear = gr.Button(<span class="hljs-string">&quot;清空&quot;</span>, scale=<span class="hljs-number">1</span>)  <span class="hljs-comment"># 清空按钮</span><br><br>        <span class="hljs-comment"># ---------------  状态管理：保存 messages_list  ---------------</span><br>        <span class="hljs-comment"># Gradio的State组件用于保存对话历史（真正的Message对象列表）</span><br>        state = gr.State([])<br><br>        <span class="hljs-comment"># ---------------  主响应函数（流式处理） ----------------------</span><br>        <span class="hljs-keyword">async</span> <span class="hljs-keyword">def</span> <span class="hljs-title function_">respond</span>(<span class="hljs-params">user_msg: <span class="hljs-built_in">str</span>, chat_hist: <span class="hljs-built_in">list</span>, messages_list: <span class="hljs-built_in">list</span></span>):<br>            <span class="hljs-string">&quot;&quot;&quot;</span><br><span class="hljs-string">            处理用户输入并生成AI回复（流式）</span><br><span class="hljs-string">            参数:</span><br><span class="hljs-string">                user_msg: 用户输入的消息</span><br><span class="hljs-string">                chat_hist: 聊天历史（用于显示在界面上）</span><br><span class="hljs-string">                messages_list: 保存的Message对象列表（用于模型处理）</span><br><span class="hljs-string">            返回:</span><br><span class="hljs-string">                更新后的msg, chat_hist和messages_list</span><br><span class="hljs-string">            &quot;&quot;&quot;</span><br>            <br>            <span class="hljs-comment"># 1) 检查用户输入是否为空</span><br>            <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> user_msg.strip():<br>                <span class="hljs-keyword">yield</span> <span class="hljs-string">&quot;&quot;</span>, chat_hist, messages_list  <span class="hljs-comment"># 如果为空，直接返回</span><br>                <span class="hljs-keyword">return</span><br><br>            <span class="hljs-comment"># 2) 将用户消息添加到历史中</span><br>            <span class="hljs-comment"># 创建HumanMessage对象（表示用户消息）</span><br>            messages_list.append(HumanMessage(content=user_msg))<br>            <span class="hljs-comment"># 更新聊天历史（用于界面显示）</span><br>            chat_hist = chat_hist + [(user_msg, <span class="hljs-literal">None</span>)]<br>            <span class="hljs-keyword">yield</span> <span class="hljs-string">&quot;&quot;</span>, chat_hist, messages_list  <span class="hljs-comment"># 先显示用户消息</span><br><br>            <span class="hljs-comment"># 3) 流式调用模型生成回复</span><br>            partial = <span class="hljs-string">&quot;&quot;</span>  <span class="hljs-comment"># 用于累积模型的流式输出</span><br>            <span class="hljs-comment"># 异步流式调用对话链</span><br>            <span class="hljs-keyword">async</span> <span class="hljs-keyword">for</span> chunk <span class="hljs-keyword">in</span> qa_chain.astream(&#123;<span class="hljs-string">&quot;messages&quot;</span>: messages_list&#125;):<br>                partial += chunk  <span class="hljs-comment"># 累积模型输出</span><br>                <span class="hljs-comment"># 更新最后一条AI回复（实现流式效果）</span><br>                chat_hist[-<span class="hljs-number">1</span>] = (user_msg, partial)<br>                <span class="hljs-keyword">yield</span> <span class="hljs-string">&quot;&quot;</span>, chat_hist, messages_list  <span class="hljs-comment"># 实时更新界面</span><br><br>            <span class="hljs-comment"># 4) 将完整回复加入历史，并裁剪到最近50条（防止内存占用过大）</span><br>            messages_list.append(AIMessage(content=partial))  <span class="hljs-comment"># 创建AIMessage对象</span><br>            messages_list = messages_list[-<span class="hljs-number">50</span>:]  <span class="hljs-comment"># 只保留最近50条消息</span><br><br>            <span class="hljs-comment"># 5) 最终返回（Gradio需要把新的state传回）</span><br>            <span class="hljs-keyword">yield</span> <span class="hljs-string">&quot;&quot;</span>, chat_hist, messages_list<br><br>        <span class="hljs-comment"># ---------------  清空历史函数 -------------------------------</span><br>        <span class="hljs-keyword">def</span> <span class="hljs-title function_">clear_history</span>():<br>            <span class="hljs-string">&quot;&quot;&quot;清空聊天历史&quot;&quot;&quot;</span><br>            <span class="hljs-keyword">return</span> [], <span class="hljs-string">&quot;&quot;</span>, []  <span class="hljs-comment"># 返回空列表，分别对应: chatbot, msg输入框, messages_list</span><br><br>        <span class="hljs-comment"># ---------------  事件绑定 ------------------------------</span><br>        <span class="hljs-comment"># 绑定输入框的回车事件和发送按钮的点击事件</span><br>        msg.submit(respond, [msg, chatbot, state], [msg, chatbot, state])<br>        submit.click(respond, [msg, chatbot, state], [msg, chatbot, state])<br>        <span class="hljs-comment"># 绑定清空按钮的点击事件</span><br>        clear.click(clear_history, outputs=[chatbot, msg, state])<br><br>    <span class="hljs-keyword">return</span> demo  <span class="hljs-comment"># 返回创建的Gradio界面</span><br><br><span class="hljs-comment"># ==================== 第三部分：启动应用 ====================</span><br><br><span class="hljs-comment"># 创建聊天机器人界面</span><br>demo = create_chatbot()<br><br><span class="hljs-comment"># 启动应用</span><br><span class="hljs-comment"># 参数说明:</span><br><span class="hljs-comment"># server_name=&quot;127.0.0.1&quot; - 本地运行</span><br><span class="hljs-comment"># server_port=7860 - 使用7860端口</span><br><span class="hljs-comment"># share=False - 不生成公开链接</span><br><span class="hljs-comment"># debug=True - 调试模式</span><br>demo.launch(server_name=<span class="hljs-string">&quot;127.0.0.1&quot;</span>, server_port=<span class="hljs-number">7860</span>, share=<span class="hljs-literal">False</span>, debug=<span class="hljs-literal">True</span>)<br></code></pre></td></tr></table></figure>

<p>运行后，在浏览器访问<code>http://127.0.0.1:7860</code>即可进行问答交互。</p>
<p>当然这只是最简单的问答机器人实现形式，实际上企业应用的问答机器人往往需要更加复杂的逻辑，比如用户权限管理、上下文记忆等</p>
<h1 id="四、LangChain-接入工具流程"><a href="#四、LangChain-接入工具流程" class="headerlink" title="四、LangChain 接入工具流程"></a>四、<strong>LangChain 接入工具流程</strong></h1><p>在<code>LangChain</code>生态中，既有海量丰富的<strong>内置工具</strong>，同时也能接入自定义工具，不仅能通过搭建一个个链（<code>Chain</code>）将工具封装在对应的工作流中，也能借助<code>LangChain Agent</code>功能，实时灵活创建不同的<code>Chain</code>来完成复杂工具调用，甚至还可以使用更高级的<code>LangGraph</code>进行工作流编排。</p>
<p>本小节我们将首先介绍如何在<code>LangChain</code>中接入外部工具，然后从下一小节开始，我们会进一步介绍如何使用<code>LangChain Agent</code>库来搭建更加复杂的工作流。</p>
<p>这里我们首先介绍最基本的<code>LangChain</code>接入工具流程。在MCP爆火之前，<code>LangChian</code>生态中就已经内置集成了非常多的实用工具，开发者可以快速调用这些工具完成更加复杂工作流的开发。</p>
<p><a target="_blank" rel="noopener" href="https://python.langchain.com/docs/integrations/tools/"><code>LangChain</code>内置工具列表</a></p>
<p>我们就以其中代码解释器为例，来介绍如何将<strong>内置工具</strong>接入<code>LangChain</code>的工作流中。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">pip install -qU langchain-community langchain-experimental pandas<br></code></pre></td></tr></table></figure>

<p><code>Telco</code>数据集是<code>Kaggle</code>分享的一个高分数据集，是<code>Kaggle</code>平台上非常经典的围绕偏态数据集建模的数据集。该数据源自<code>IBM</code>商业社区（<a target="_blank" rel="noopener" href="https://community.ibm.com/community/user/businessanalytics/blogs/steven-macko/2019/07/11/telco-customer-churn-1113">IBM Business Analytics Community</a>）上分享的数据集，用于社区成员内部学习使用。</p>
<p>根据<code>IBM</code>商业社区分享团队描述，该数据集为某电信公司在加利福尼亚为7000余位用户（个人&#x2F;家庭）提供电话和互联网服务的相关记录。由于该数据集并不是竞赛数据集，因此数据集的下载方式相对容易，官网也提供了网页下载选项。我们可以在<a target="_blank" rel="noopener" href="https://www.kaggle.com/blastchar/telco-customer-churn">该数据集的Kaggle主页</a>看到数据集的相关信息以及下载地址。当然，熟练使用<code>Kaggle</code>主页获取数据和挖掘信息（而不是借助第三方渠道），也是算法工程师必备技能之一。</p>
<p>我们可以先用以下代码查看数据集的一些基本信息：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">import</span> pandas <span class="hljs-keyword">as</span> pd<br>dataset = pd.read_csv(<span class="hljs-string">&#x27;WA_Fn-UseC_-Telco-Customer-Churn.csv&#x27;</span>)<br>pd.set_option(<span class="hljs-string">&#x27;max_colwidth&#x27;</span>,<span class="hljs-number">200</span>)<br><span class="hljs-built_in">print</span>(dataset.head(<span class="hljs-number">5</span>))<br>dataset.info()<br></code></pre></td></tr></table></figure>

<p>其中数据集各字段解释如下：</p>
<table>
<thead>
<tr>
<th align="center">字段</th>
<th align="center">解释</th>
</tr>
</thead>
<tbody><tr>
<td align="center">customerID</td>
<td align="center">用户ID</td>
</tr>
<tr>
<td align="center">gender</td>
<td align="center">性别</td>
</tr>
<tr>
<td align="center">SeniorCitizen</td>
<td align="center">是否是老年人（1代表是）</td>
</tr>
<tr>
<td align="center">Partner</td>
<td align="center">是否有配偶（Yes or No）</td>
</tr>
<tr>
<td align="center">Dependents</td>
<td align="center">是否经济独立（Yes or No）</td>
</tr>
<tr>
<td align="center">tenure</td>
<td align="center">用户入网时间</td>
</tr>
<tr>
<td align="center">PhoneService</td>
<td align="center">是否开通电话业务（Yes or No）</td>
</tr>
<tr>
<td align="center">MultipleLines</td>
<td align="center">是否开通多条电话业务（Yes 、 No or No phoneservice）</td>
</tr>
<tr>
<td align="center">InternetService</td>
<td align="center">是否开通互联网服务（No、DSL数字网络或filber potic光线网络）</td>
</tr>
<tr>
<td align="center">OnlineSecurity</td>
<td align="center">是否开通网络安全服务（Yes、No or No internetservice）</td>
</tr>
<tr>
<td align="center">OnlineBackup</td>
<td align="center">是否开通在线备份服务（Yes、No or No internetservice）</td>
</tr>
<tr>
<td align="center">DeviceProtection</td>
<td align="center">是否开通设备保护服务（Yes、No or No internetservice）</td>
</tr>
<tr>
<td align="center">TechSupport</td>
<td align="center">是否开通技术支持业务（Yes、No or No internetservice）</td>
</tr>
<tr>
<td align="center">StreamingTV</td>
<td align="center">是否开通网络电视（Yes、No or No internetservice）</td>
</tr>
<tr>
<td align="center">StreamingMovies</td>
<td align="center">是否开通网络电影（Yes、No or No internetservice）</td>
</tr>
<tr>
<td align="center">Contract</td>
<td align="center">合同签订方式（按月、按年或者两年）</td>
</tr>
<tr>
<td align="center">PaperlessBilling</td>
<td align="center">是否开通电子账单（Yes or No）</td>
</tr>
<tr>
<td align="center">PaymentMethod</td>
<td align="center">付款方式（bank transfer、credit card、electronic check、mailed check）</td>
</tr>
<tr>
<td align="center">MonthlyCharges</td>
<td align="center">月度费用</td>
</tr>
<tr>
<td align="center">TotalCharges</td>
<td align="center">总费用</td>
</tr>
<tr>
<td align="center">Churn</td>
<td align="center">是否流失（Yes or No）</td>
</tr>
</tbody></table>
<p>接下来测试<code>LangChain</code>内置代码解释器工具功能：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-comment"># 导入必要的库</span><br><span class="hljs-keyword">import</span> pandas <span class="hljs-keyword">as</span> pd  <span class="hljs-comment"># 用于数据处理和分析的核心库</span><br><span class="hljs-keyword">from</span> langchain_experimental.tools <span class="hljs-keyword">import</span> PythonAstREPLTool  <span class="hljs-comment"># LangChain的实验性工具，允许安全执行Python代码</span><br><br><span class="hljs-comment"># 读取CSV文件到Pandas DataFrame</span><br><span class="hljs-comment"># 这是一个电信客户流失数据集(来自Kaggle)</span><br>df = pd.read_csv(<span class="hljs-string">&#x27;WA_Fn-UseC_-Telco-Customer-Churn.csv&#x27;</span>)<br><br><span class="hljs-comment"># 创建PythonAstREPLTool工具实例</span><br><span class="hljs-comment"># locals参数将当前作用域的变量(这里只有df)传递到工具的执行环境中</span><br><span class="hljs-comment"># 这样工具内部就可以访问这个DataFrame</span><br>tool = PythonAstREPLTool(<span class="hljs-built_in">locals</span>=&#123;<span class="hljs-string">&quot;df&quot;</span>: df&#125;)<br><br><span class="hljs-comment"># 使用LangChain内置代码解释器工具执行Python代码字符串</span><br><span class="hljs-comment"># 这里计算&#x27;SeniorCitizen&#x27;列的平均值</span><br><span class="hljs-comment"># invoke方法会安全地执行传入的代码并返回结果</span><br><span class="hljs-built_in">print</span>(tool.invoke(<span class="hljs-string">&quot;df[&#x27;SeniorCitizen&#x27;].mean()&quot;</span>))  <span class="hljs-comment"># 输出老年客户比例的平均值</span><br><br><span class="hljs-comment"># 直接使用Pandas计算&#x27;MonthlyCharges&#x27;列的平均值</span><br><span class="hljs-comment"># 这是常规的Pandas操作方式，不使用LangChain工具</span><br><span class="hljs-built_in">print</span>(df[<span class="hljs-string">&#x27;MonthlyCharges&#x27;</span>].mean())  <span class="hljs-comment"># 输出月费用的平均值</span><br></code></pre></td></tr></table></figure>

<p><code>PythonAstREPLTool</code>是一个代码执行工具，特点：</p>
<ul>
<li>安全地在沙箱中执行<code>Python</code>代码</li>
<li>可以限制可访问的变量和函数</li>
<li>常用于<code>AI</code>代理(<code>Agent</code>)中让AI动态执行代码</li>
</ul>
<p>通过<code>locals</code>参数，我们只暴露<code>df</code>变量给工具</p>
<p>然后<code>invoke()</code>方法执行代码字符串并返回结果</p>
<p>接下来创建<code>LangChain</code>工作流并绑定内置工具</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">import</span> pandas <span class="hljs-keyword">as</span> pd  <span class="hljs-comment"># 用于数据处理和分析的核心库</span><br><span class="hljs-keyword">from</span> langchain_experimental.tools <span class="hljs-keyword">import</span> PythonAstREPLTool  <span class="hljs-comment"># LangChain的实验性工具，允许安全执行Python代码</span><br><span class="hljs-keyword">from</span> langchain.chat_models <span class="hljs-keyword">import</span> init_chat_model<br><span class="hljs-keyword">from</span> dotenv <span class="hljs-keyword">import</span> load_dotenv<br>load_dotenv(override=<span class="hljs-literal">True</span>)<br><br>model  = init_chat_model(model=<span class="hljs-string">&quot;deepseek-chat&quot;</span>, model_provider=<span class="hljs-string">&quot;deepseek&quot;</span>)<br><br>df = pd.read_csv(<span class="hljs-string">&#x27;WA_Fn-UseC_-Telco-Customer-Churn.csv&#x27;</span>)<br><br>tool = PythonAstREPLTool(<span class="hljs-built_in">locals</span>=&#123;<span class="hljs-string">&quot;df&quot;</span>: df&#125;)<br><br>llm_with_tools = model.bind_tools([tool])<br><br>response = llm_with_tools.invoke(<br>    <span class="hljs-string">&quot;我有一张表，名为&#x27;df&#x27;，请帮我计算MonthlyCharges字段的均值。&quot;</span><br>)<br><span class="hljs-built_in">print</span>(response)<br></code></pre></td></tr></table></figure>

<p>通过观察输出，此时我们发现，<code>LangChain</code>回复的结果就不再是简单的文字内容，而是一条调用外部工具的消息。我们可以使用如下方法将这条消息里面涉及到代码运行的核心参数提取出来：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">import</span> pandas <span class="hljs-keyword">as</span> pd  <span class="hljs-comment"># 用于数据处理和分析的核心库</span><br><span class="hljs-keyword">from</span> langchain_experimental.tools <span class="hljs-keyword">import</span> PythonAstREPLTool  <span class="hljs-comment"># LangChain的实验性工具，允许安全执行Python代码</span><br><span class="hljs-keyword">from</span> langchain_core.output_parsers.openai_tools <span class="hljs-keyword">import</span> JsonOutputKeyToolsParser<br><span class="hljs-keyword">from</span> langchain.chat_models <span class="hljs-keyword">import</span> init_chat_model<br><span class="hljs-keyword">from</span> dotenv <span class="hljs-keyword">import</span> load_dotenv<br>load_dotenv(override=<span class="hljs-literal">True</span>)<br><br>model  = init_chat_model(model=<span class="hljs-string">&quot;deepseek-chat&quot;</span>, model_provider=<span class="hljs-string">&quot;deepseek&quot;</span>)<br><br>df = pd.read_csv(<span class="hljs-string">&#x27;WA_Fn-UseC_-Telco-Customer-Churn.csv&#x27;</span>)<br><br>tool = PythonAstREPLTool(<span class="hljs-built_in">locals</span>=&#123;<span class="hljs-string">&quot;df&quot;</span>: df&#125;)<br><br>parser = JsonOutputKeyToolsParser(key_name=tool.name, first_tool_only=<span class="hljs-literal">True</span>)<br><br>llm_with_tools = model.bind_tools([tool]) | parser<br><br>response = llm_with_tools.invoke(<br>    <span class="hljs-string">&quot;我有一张表，名为&#x27;df&#x27;，请帮我计算MonthlyCharges字段的均值。&quot;</span><br>)<br><span class="hljs-built_in">print</span>(response)<br></code></pre></td></tr></table></figure>

<p>此时输出：</p>
<figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs text">&#123;&#x27;query&#x27;: &quot;df[&#x27;MonthlyCharges&#x27;].mean()&quot;&#125;<br></code></pre></td></tr></table></figure>

<p>接着通过设置提示词模板，再在当前链中加入一个<code>tool</code>外部函数的环节，即可让大模型输出的参数直接带入到<code>tool</code>中进行运行</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">import</span> pandas <span class="hljs-keyword">as</span> pd  <span class="hljs-comment"># 用于数据处理和分析的核心库</span><br><span class="hljs-keyword">from</span> langchain_core.prompts <span class="hljs-keyword">import</span> ChatPromptTemplate<br><span class="hljs-keyword">from</span> langchain_experimental.tools <span class="hljs-keyword">import</span> PythonAstREPLTool  <span class="hljs-comment"># LangChain的实验性工具，允许安全执行Python代码</span><br><span class="hljs-keyword">from</span> langchain_core.output_parsers.openai_tools <span class="hljs-keyword">import</span> JsonOutputKeyToolsParser<br><span class="hljs-keyword">from</span> langchain.chat_models <span class="hljs-keyword">import</span> init_chat_model<br><span class="hljs-keyword">from</span> dotenv <span class="hljs-keyword">import</span> load_dotenv<br>load_dotenv(override=<span class="hljs-literal">True</span>)<br><br>system = <span class="hljs-string">f&quot;&quot;&quot;</span><br><span class="hljs-string">你可以访问一个名为 `df` 的 pandas 数据框，你可以使用df.head().to_markdown() 查看数据集的基本信息， \</span><br><span class="hljs-string">请根据用户提出的问题，编写 Python 代码来回答。只返回代码，不返回其他内容。只允许使用 pandas 和内置库。</span><br><span class="hljs-string">&quot;&quot;&quot;</span><br><br>prompt = ChatPromptTemplate([<br>    (<span class="hljs-string">&quot;system&quot;</span>, system),<br>    (<span class="hljs-string">&quot;user&quot;</span>, <span class="hljs-string">&quot;&#123;question&#125;&quot;</span>)<br>])<br><br>model  = init_chat_model(model=<span class="hljs-string">&quot;deepseek-chat&quot;</span>, model_provider=<span class="hljs-string">&quot;deepseek&quot;</span>)<br><br>df = pd.read_csv(<span class="hljs-string">&#x27;WA_Fn-UseC_-Telco-Customer-Churn.csv&#x27;</span>)<br><br>tool = PythonAstREPLTool(<span class="hljs-built_in">locals</span>=&#123;<span class="hljs-string">&quot;df&quot;</span>: df&#125;)<br><br>llm_with_tools = model.bind_tools([tool])<br><br>parser = JsonOutputKeyToolsParser(key_name=tool.name, first_tool_only=<span class="hljs-literal">True</span>)<br><br>chain = prompt | llm_with_tools | parser | tool<br><br><span class="hljs-built_in">print</span>(chain.invoke(&#123;<span class="hljs-string">&quot;question&quot;</span>: <span class="hljs-string">&quot;请帮我计算MonthlyCharges字段的均值。&quot;</span>&#125;))<br></code></pre></td></tr></table></figure>

<p>同时，按照此前介绍的，我们还可以在链条中加入一个打印的环节，让模型将编写的<code>Python</code>代码进行打印：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">import</span> pandas <span class="hljs-keyword">as</span> pd  <span class="hljs-comment"># 用于数据处理和分析的核心库</span><br><span class="hljs-keyword">from</span> langchain_core.prompts <span class="hljs-keyword">import</span> ChatPromptTemplate<br><span class="hljs-keyword">from</span> langchain_core.runnables <span class="hljs-keyword">import</span> RunnableLambda<br><span class="hljs-keyword">from</span> langchain_experimental.tools <span class="hljs-keyword">import</span> PythonAstREPLTool  <span class="hljs-comment"># LangChain的实验性工具，允许安全执行Python代码</span><br><span class="hljs-keyword">from</span> langchain_core.output_parsers.openai_tools <span class="hljs-keyword">import</span> JsonOutputKeyToolsParser<br><span class="hljs-keyword">from</span> langchain.chat_models <span class="hljs-keyword">import</span> init_chat_model<br><span class="hljs-keyword">from</span> dotenv <span class="hljs-keyword">import</span> load_dotenv<br>load_dotenv(override=<span class="hljs-literal">True</span>)<br><br>system = <span class="hljs-string">f&quot;&quot;&quot;</span><br><span class="hljs-string">你可以访问一个名为 `df` 的 pandas 数据框，你可以使用df.head().to_markdown() 查看数据集的基本信息， \</span><br><span class="hljs-string">请根据用户提出的问题，编写 Python 代码来回答。只返回代码，不返回其他内容。只允许使用 pandas 和内置库。</span><br><span class="hljs-string">&quot;&quot;&quot;</span><br><br>prompt = ChatPromptTemplate([<br>    (<span class="hljs-string">&quot;system&quot;</span>, system),<br>    (<span class="hljs-string">&quot;user&quot;</span>, <span class="hljs-string">&quot;&#123;question&#125;&quot;</span>)<br>])<br><br>model  = init_chat_model(model=<span class="hljs-string">&quot;deepseek-chat&quot;</span>, model_provider=<span class="hljs-string">&quot;deepseek&quot;</span>)<br><br>df = pd.read_csv(<span class="hljs-string">&#x27;WA_Fn-UseC_-Telco-Customer-Churn.csv&#x27;</span>)<br><br>tool = PythonAstREPLTool(<span class="hljs-built_in">locals</span>=&#123;<span class="hljs-string">&quot;df&quot;</span>: df&#125;)<br><br>llm_with_tools = model.bind_tools([tool])<br><br>parser = JsonOutputKeyToolsParser(key_name=tool.name, first_tool_only=<span class="hljs-literal">True</span>)<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">code_print</span>(<span class="hljs-params">res</span>):<br>    <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;即将运行Python代码:&quot;</span>, res[<span class="hljs-string">&#x27;query&#x27;</span>])<br>    <span class="hljs-keyword">return</span> res<br><br>print_node = RunnableLambda(code_print)<br><br>chain = prompt | llm_with_tools | parser | print_node | tool<br><br><span class="hljs-built_in">print</span>(chain.invoke(&#123;<span class="hljs-string">&quot;question&quot;</span>: <span class="hljs-string">&quot;请帮我分析gender、SeniorCitizen和Churn三个字段之间的相关关系。&quot;</span>&#125;))<br></code></pre></td></tr></table></figure>

<p>至此，一个简单的包含官方<strong>内置工具</strong>的代码解释器工作流就搭建完成了。</p>
<p>接下来是<strong>LangChain接入自定义外部工作流程</strong></p>
<p>这里我们以实时获取天气数据为例，尝试创建一个外部函数，并将其封装为<code>LangChian</code>的一项基础工作。在<code>langChain</code>中，如果想要把一个普通的函数，变成一个可以被大模型调用的工具，只需要将函数包装成一个<code>Tool</code>对象即可。</p>
<p>这里我们首先需要获取<code>OpenWeather API Key</code>，并写入<code>.env</code>文件中，方便后续进行天气查询</p>
<p>浏览器访问<a target="_blank" rel="noopener" href="https://openweathermap.org/"><code>openweathermap</code>官方网站</a></p>
<p>接着注册并绑定邮箱</p>
<p>最后进入<a target="_blank" rel="noopener" href="https://openweathermap.org/"><code>openweathermap</code>官方网站</a>，点击你的用户名，选择“My API keys”，即可获取<code>OpenWeather API Key</code></p>
<p>然后先尝试创建这个外部函数进行测试：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">import</span> os<br><span class="hljs-keyword">import</span> requests,json<br><span class="hljs-keyword">from</span> dotenv <span class="hljs-keyword">import</span> load_dotenv<br>load_dotenv(override=<span class="hljs-literal">True</span>)<br><br>OPENWEATHER_API_KEY = os.getenv(<span class="hljs-string">&quot;OPENWEATHER_API_KEY&quot;</span>)<br><br><span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;Loaded API Key:&quot;</span>, OPENWEATHER_API_KEY)  <span class="hljs-comment"># 检查是否非None</span><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">get_weather</span>(<span class="hljs-params">loc</span>):<br>    <span class="hljs-string">&quot;&quot;&quot;</span><br><span class="hljs-string">    查询即时天气函数</span><br><span class="hljs-string">    :param loc: 必要参数，字符串类型，用于表示查询天气的具体城市名称，\</span><br><span class="hljs-string">    注意，中国的城市需要用对应城市的英文名称代替，例如如果需要查询北京市天气，则loc参数需要输入&#x27;Beijing&#x27;；</span><br><span class="hljs-string">    :return：OpenWeather API查询即时天气的结果，具体URL请求地址为：https://api.openweathermap.org/data/2.5/weather\</span><br><span class="hljs-string">    返回结果对象类型为解析之后的JSON格式对象，并用字符串形式进行表示，其中包含了全部重要的天气信息</span><br><span class="hljs-string">    &quot;&quot;&quot;</span><br>    <span class="hljs-comment"># Step 1.构建请求</span><br>    url = <span class="hljs-string">&quot;https://api.openweathermap.org/data/2.5/weather&quot;</span><br><br>    <span class="hljs-comment"># Step 2.设置查询参数</span><br>    params = &#123;<br>        <span class="hljs-string">&quot;q&quot;</span>: loc,<br>        <span class="hljs-string">&quot;appid&quot;</span>: os.getenv(<span class="hljs-string">&quot;OPENWEATHER_API_KEY&quot;</span>),  <span class="hljs-comment"># 输入API key</span><br>        <span class="hljs-string">&quot;units&quot;</span>: <span class="hljs-string">&quot;metric&quot;</span>,  <span class="hljs-comment"># 使用摄氏度而不是华氏度</span><br>        <span class="hljs-string">&quot;lang&quot;</span>: <span class="hljs-string">&quot;zh_cn&quot;</span>  <span class="hljs-comment"># 输出语言为简体中文</span><br>    &#125;<br><br>    <span class="hljs-comment"># Step 3.发送GET请求</span><br>    response = requests.get(url, params=params)<br><br>    <span class="hljs-comment"># Step 4.解析响应</span><br>    data = response.json()<br>    <span class="hljs-keyword">return</span> json.dumps(data)<br><br><span class="hljs-built_in">print</span>(get_weather(<span class="hljs-string">&quot;Beijing&quot;</span>))<br></code></pre></td></tr></table></figure>

<p>注意：如果返回<code>401</code>，请不要惊慌，因为<code>API Key</code>会过一会儿生效，时间一般在一小时内</p>
<p>紧接着将其封装为<code>LangChain</code>能够识别的外部函数，并且如果想让大模型调用某一个外部工具，需要使用<code>bind_tools</code>方法，将工具绑定到模型上。接下来，便可以通过新的<code>llm_with_tools</code>模型通过<code>invoke</code>方法来调用模型。这会产生一个包含<code>tool_calls</code> 的模型响应。代码如下：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">import</span> os<br><span class="hljs-keyword">import</span> requests,json<br><span class="hljs-keyword">from</span> langchain.chat_models <span class="hljs-keyword">import</span> init_chat_model<br><span class="hljs-keyword">from</span> langchain_core.tools <span class="hljs-keyword">import</span> tool<br><span class="hljs-keyword">from</span> dotenv <span class="hljs-keyword">import</span> load_dotenv<br>load_dotenv(override=<span class="hljs-literal">True</span>)<br><br><span class="hljs-comment"># 初始化模型</span><br>model = init_chat_model(<span class="hljs-string">&quot;deepseek-chat&quot;</span>, model_provider=<span class="hljs-string">&quot;deepseek&quot;</span>)<br><br>OPENWEATHER_API_KEY = os.getenv(<span class="hljs-string">&quot;OPENWEATHER_API_KEY&quot;</span>)<br><br><span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;Loaded API Key:&quot;</span>, OPENWEATHER_API_KEY)  <span class="hljs-comment"># 检查是否非None</span><br><br><span class="hljs-meta">@tool</span><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">get_weather</span>(<span class="hljs-params">loc</span>):<br>    <span class="hljs-string">&quot;&quot;&quot;</span><br><span class="hljs-string">    查询即时天气函数</span><br><span class="hljs-string">    :param loc: 必要参数，字符串类型，用于表示查询天气的具体城市名称，\</span><br><span class="hljs-string">    注意，中国的城市需要用对应城市的英文名称代替，例如如果需要查询北京市天气，则loc参数需要输入&#x27;Beijing&#x27;；</span><br><span class="hljs-string">    :return：OpenWeather API查询即时天气的结果，具体URL请求地址为：https://api.openweathermap.org/data/2.5/weather\</span><br><span class="hljs-string">    返回结果对象类型为解析之后的JSON格式对象，并用字符串形式进行表示，其中包含了全部重要的天气信息</span><br><span class="hljs-string">    &quot;&quot;&quot;</span><br>    <span class="hljs-comment"># Step 1.构建请求</span><br>    url = <span class="hljs-string">&quot;https://api.openweathermap.org/data/2.5/weather&quot;</span><br><br>    <span class="hljs-comment"># Step 2.设置查询参数</span><br>    params = &#123;<br>        <span class="hljs-string">&quot;q&quot;</span>: loc,<br>        <span class="hljs-string">&quot;appid&quot;</span>: os.getenv(<span class="hljs-string">&quot;OPENWEATHER_API_KEY&quot;</span>),  <span class="hljs-comment"># 输入API key</span><br>        <span class="hljs-string">&quot;units&quot;</span>: <span class="hljs-string">&quot;metric&quot;</span>,  <span class="hljs-comment"># 使用摄氏度而不是华氏度</span><br>        <span class="hljs-string">&quot;lang&quot;</span>: <span class="hljs-string">&quot;zh_cn&quot;</span>  <span class="hljs-comment"># 输出语言为简体中文</span><br>    &#125;<br><br>    <span class="hljs-comment"># Step 3.发送GET请求</span><br>    response = requests.get(url, params=params)<br><br>    <span class="hljs-comment"># Step 4.解析响应</span><br>    data = response.json()<br>    <span class="hljs-keyword">return</span> json.dumps(data)<br><br><span class="hljs-built_in">print</span>(get_weather.name)<br><span class="hljs-built_in">print</span>(get_weather.description)<br><span class="hljs-built_in">print</span>(get_weather.args)<br><br><span class="hljs-comment"># 定义 天气查询 工具函数</span><br>tools = [get_weather]<br><br><span class="hljs-comment"># 将工具绑定到模型</span><br>llm_with_tools = model.bind_tools(tools)<br><br>response = llm_with_tools.invoke(<span class="hljs-string">&quot;你好， 请问北京的天气怎么样？&quot;</span>)<br><br><span class="hljs-built_in">print</span>(response)<br><br><span class="hljs-built_in">print</span>(response.additional_kwargs)<br></code></pre></td></tr></table></figure>

<p>我们继续调用<code>JsonOutputKeyToolsParser</code>输出解析器来处理模型响应。并加入一个<code>tool</code>外部函数的环节，即可让大模型输出的参数直接带入到<code>tool</code>中进行运行，就能顺利的将用户的需求转化为天气查询，并完成外部工具完成自动运行</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">import</span> os<br><span class="hljs-keyword">import</span> requests,json<br><span class="hljs-keyword">from</span> langchain.chat_models <span class="hljs-keyword">import</span> init_chat_model<br><span class="hljs-keyword">from</span> langchain_core.tools <span class="hljs-keyword">import</span> tool<br><span class="hljs-keyword">from</span> langchain_core.output_parsers.openai_tools <span class="hljs-keyword">import</span> JsonOutputKeyToolsParser<br><span class="hljs-keyword">from</span> dotenv <span class="hljs-keyword">import</span> load_dotenv<br>load_dotenv(override=<span class="hljs-literal">True</span>)<br><br><span class="hljs-comment"># 初始化模型</span><br>model = init_chat_model(<span class="hljs-string">&quot;deepseek-chat&quot;</span>, model_provider=<span class="hljs-string">&quot;deepseek&quot;</span>)<br><br>OPENWEATHER_API_KEY = os.getenv(<span class="hljs-string">&quot;OPENWEATHER_API_KEY&quot;</span>)<br><br><span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;Loaded API Key:&quot;</span>, OPENWEATHER_API_KEY)  <span class="hljs-comment"># 检查是否非None</span><br><br><span class="hljs-meta">@tool</span><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">get_weather</span>(<span class="hljs-params">loc</span>):<br>    <span class="hljs-string">&quot;&quot;&quot;</span><br><span class="hljs-string">    查询即时天气函数</span><br><span class="hljs-string">    :param loc: 必要参数，字符串类型，用于表示查询天气的具体城市名称，\</span><br><span class="hljs-string">    注意，中国的城市需要用对应城市的英文名称代替，例如如果需要查询北京市天气，则loc参数需要输入&#x27;Beijing&#x27;；</span><br><span class="hljs-string">    :return：OpenWeather API查询即时天气的结果，具体URL请求地址为：https://api.openweathermap.org/data/2.5/weather\</span><br><span class="hljs-string">    返回结果对象类型为解析之后的JSON格式对象，并用字符串形式进行表示，其中包含了全部重要的天气信息</span><br><span class="hljs-string">    &quot;&quot;&quot;</span><br>    <span class="hljs-comment"># Step 1.构建请求</span><br>    url = <span class="hljs-string">&quot;https://api.openweathermap.org/data/2.5/weather&quot;</span><br><br>    <span class="hljs-comment"># Step 2.设置查询参数</span><br>    params = &#123;<br>        <span class="hljs-string">&quot;q&quot;</span>: loc,<br>        <span class="hljs-string">&quot;appid&quot;</span>: os.getenv(<span class="hljs-string">&quot;OPENWEATHER_API_KEY&quot;</span>),  <span class="hljs-comment"># 输入API key</span><br>        <span class="hljs-string">&quot;units&quot;</span>: <span class="hljs-string">&quot;metric&quot;</span>,  <span class="hljs-comment"># 使用摄氏度而不是华氏度</span><br>        <span class="hljs-string">&quot;lang&quot;</span>: <span class="hljs-string">&quot;zh_cn&quot;</span>  <span class="hljs-comment"># 输出语言为简体中文</span><br>    &#125;<br><br>    <span class="hljs-comment"># Step 3.发送GET请求</span><br>    response = requests.get(url, params=params)<br><br>    <span class="hljs-comment"># Step 4.解析响应</span><br>    data = response.json()<br>    <span class="hljs-keyword">return</span> json.dumps(data)<br><br><span class="hljs-built_in">print</span>(get_weather.name)<br><span class="hljs-built_in">print</span>(get_weather.description)<br><span class="hljs-built_in">print</span>(get_weather.args)<br><br><span class="hljs-comment"># 定义 天气查询 工具函数</span><br>tools = [get_weather]<br><br><span class="hljs-comment"># 将工具绑定到模型</span><br>llm_with_tools = model.bind_tools(tools)<br><br>parser = JsonOutputKeyToolsParser(key_name=get_weather.name, first_tool_only=<span class="hljs-literal">True</span>)<br><br>llm_chain = llm_with_tools | parser<br><br>get_weather_chain = llm_with_tools | parser | get_weather<br><br>response = get_weather_chain.invoke(<span class="hljs-string">&quot;你好， 请问北京的天气怎么样？&quot;</span>)<br><br><span class="hljs-built_in">print</span>(response)<br></code></pre></td></tr></table></figure>

<p>能够看到，此时<code>Chain</code>就能顺利的将用户的需求转化为天气查询，并完成外部工具的自动运行。但只有这一步还不够，我们还需要将调用工具返回的结果转化为一个模型的问答：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">import</span> os<br><span class="hljs-keyword">import</span> requests,json<br><span class="hljs-keyword">from</span> langchain.chat_models <span class="hljs-keyword">import</span> init_chat_model<br><span class="hljs-keyword">from</span> langchain_core.tools <span class="hljs-keyword">import</span> tool<br><span class="hljs-keyword">from</span> langchain_core.output_parsers.openai_tools <span class="hljs-keyword">import</span> JsonOutputKeyToolsParser<br><span class="hljs-keyword">from</span> langchain.prompts <span class="hljs-keyword">import</span> PromptTemplate<br><span class="hljs-keyword">from</span> langchain_core.output_parsers <span class="hljs-keyword">import</span> StrOutputParser<br><span class="hljs-keyword">from</span> langchain.prompts <span class="hljs-keyword">import</span> PromptTemplate<br><span class="hljs-keyword">from</span> langchain_core.output_parsers <span class="hljs-keyword">import</span> StrOutputParser<br><span class="hljs-keyword">from</span> dotenv <span class="hljs-keyword">import</span> load_dotenv<br>load_dotenv(override=<span class="hljs-literal">True</span>)<br><br><span class="hljs-comment"># 初始化模型</span><br>model = init_chat_model(<span class="hljs-string">&quot;deepseek-chat&quot;</span>, model_provider=<span class="hljs-string">&quot;deepseek&quot;</span>)<br><br>OPENWEATHER_API_KEY = os.getenv(<span class="hljs-string">&quot;OPENWEATHER_API_KEY&quot;</span>)<br><br><span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;Loaded API Key:&quot;</span>, OPENWEATHER_API_KEY)  <span class="hljs-comment"># 检查是否非None</span><br><br><span class="hljs-meta">@tool</span><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">get_weather</span>(<span class="hljs-params">loc</span>):<br>    <span class="hljs-string">&quot;&quot;&quot;</span><br><span class="hljs-string">    查询即时天气函数</span><br><span class="hljs-string">    :param loc: 必要参数，字符串类型，用于表示查询天气的具体城市名称，\</span><br><span class="hljs-string">    注意，中国的城市需要用对应城市的英文名称代替，例如如果需要查询北京市天气，则loc参数需要输入&#x27;Beijing&#x27;；</span><br><span class="hljs-string">    :return：OpenWeather API查询即时天气的结果，具体URL请求地址为：https://api.openweathermap.org/data/2.5/weather\</span><br><span class="hljs-string">    返回结果对象类型为解析之后的JSON格式对象，并用字符串形式进行表示，其中包含了全部重要的天气信息</span><br><span class="hljs-string">    &quot;&quot;&quot;</span><br>    <span class="hljs-comment"># Step 1.构建请求</span><br>    url = <span class="hljs-string">&quot;https://api.openweathermap.org/data/2.5/weather&quot;</span><br><br>    <span class="hljs-comment"># Step 2.设置查询参数</span><br>    params = &#123;<br>        <span class="hljs-string">&quot;q&quot;</span>: loc,<br>        <span class="hljs-string">&quot;appid&quot;</span>: os.getenv(<span class="hljs-string">&quot;OPENWEATHER_API_KEY&quot;</span>),  <span class="hljs-comment"># 输入API key</span><br>        <span class="hljs-string">&quot;units&quot;</span>: <span class="hljs-string">&quot;metric&quot;</span>,  <span class="hljs-comment"># 使用摄氏度而不是华氏度</span><br>        <span class="hljs-string">&quot;lang&quot;</span>: <span class="hljs-string">&quot;zh_cn&quot;</span>  <span class="hljs-comment"># 输出语言为简体中文</span><br>    &#125;<br><br>    <span class="hljs-comment"># Step 3.发送GET请求</span><br>    response = requests.get(url, params=params)<br><br>    <span class="hljs-comment"># Step 4.解析响应</span><br>    data = response.json()<br>    <span class="hljs-keyword">return</span> json.dumps(data)<br><br><span class="hljs-built_in">print</span>(get_weather.name)<br><span class="hljs-built_in">print</span>(get_weather.description)<br><span class="hljs-built_in">print</span>(get_weather.args)<br><br><span class="hljs-comment"># 定义 天气查询 工具函数</span><br>tools = [get_weather]<br><br><span class="hljs-comment"># 将工具绑定到模型</span><br>llm_with_tools = model.bind_tools(tools)<br><br>parser = JsonOutputKeyToolsParser(key_name=get_weather.name, first_tool_only=<span class="hljs-literal">True</span>)<br><br>get_weather_chain = llm_with_tools | parser | get_weather<br><br><span class="hljs-comment"># Prompt 模板</span><br>output_prompt = PromptTemplate.from_template(<br>    <span class="hljs-string">&quot;&quot;&quot;你将收到一段 JSON 格式的天气数据，请用简洁自然的方式将其转述给用户。</span><br><span class="hljs-string">以下是天气 JSON 数据：</span><br><span class="hljs-string"></span><br><span class="hljs-string">```json</span><br><span class="hljs-string">&#123;weather_json&#125;</span><br><span class="hljs-string">```</span><br><span class="hljs-string"></span><br><span class="hljs-string">请将其转换为中文天气描述，例如：</span><br><span class="hljs-string">“北京当前天气晴，气温为 23°C，湿度 58%，风速 2.1 米/秒。”</span><br><span class="hljs-string">只返回一句话描述，不要其他说明或解释。&quot;&quot;&quot;</span><br>)<br><br>output_chain = output_prompt | model | StrOutputParser()<br><br>full_chain = get_weather_chain | output_chain<br><br>response = full_chain.invoke(<span class="hljs-string">&quot;请问北京今天的天气如何？&quot;</span>)<br><br><span class="hljs-built_in">print</span>(response)<br></code></pre></td></tr></table></figure>

<p>最终，我们将这两个Chain进行拼接，即构成完整的外部工具调用流程。</p>
<p>接着，我们来了解一下<strong>LangChain接入自定义外部工作流程</strong></p>
<p>首先要了解一下 <code>Function calling</code> 基本原理</p>
<p>我们都知道，能调用外部工具，是大模型进化为智能体<code>Agent</code>的关键，如果不能使用外部工具，大模型就只能是个简单的聊天机器人，甚至连查询天气都做不到。由于底层技术限制啊，大模型本身是无法和外部工具直接通信的，因此<code>Function calling</code>的思路，就是创建一个外部函数（<code>function</code>）作为中介，一边传递大模型的请求，另一边调用外部工具，最终让大模型能够间接的调用外部工具。</p>
<p class='item-img' data-src='/images/25.png'><img src="/images/25.png"></p>
<p>例如，当我们要查询当前天气时，让大模型调用外部工具的<code>function calling</code>的过程就如图所示：</p>
<p class='item-img' data-src='/images/26.png'><img src="/images/26.png"></p>
<p>而完整的一次<code>Function calling</code>执行流程如下：</p>
<p class='item-img' data-src='/images/27.png'><img src="/images/27.png"></p>
<p><code>DeepSeek function calling</code> 的三种响应模式：</p>
<p class='item-img' data-src='/images/28.png'><img src="/images/28.png"></p>
<p>在实际使用中，我们其实可以直接使用<code>create_tool_calling_agent</code>来快速构建工具调用代理。并使用<code>AgentExecutor</code>来执行代理，代码如下：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">import</span> json<br><span class="hljs-keyword">import</span> os<br><span class="hljs-keyword">import</span> requests<br><span class="hljs-keyword">from</span> langchain.agents <span class="hljs-keyword">import</span> create_tool_calling_agent, tool, AgentExecutor<br><span class="hljs-keyword">from</span> langchain_core.prompts <span class="hljs-keyword">import</span> ChatPromptTemplate<br><span class="hljs-keyword">from</span> langchain.chat_models <span class="hljs-keyword">import</span> init_chat_model<br><span class="hljs-keyword">from</span> dotenv <span class="hljs-keyword">import</span> load_dotenv<br>load_dotenv(override=<span class="hljs-literal">True</span>)<br><br>OPENWEATHER_API_KEY = os.getenv(<span class="hljs-string">&quot;OPENWEATHER_API_KEY&quot;</span>)<br><br><span class="hljs-comment"># 初始化模型</span><br>model = init_chat_model(<span class="hljs-string">&quot;deepseek-chat&quot;</span>, model_provider=<span class="hljs-string">&quot;deepseek&quot;</span>)<br><br><span class="hljs-meta">@tool</span><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">get_weather</span>(<span class="hljs-params">loc</span>):<br>    <span class="hljs-string">&quot;&quot;&quot;</span><br><span class="hljs-string">    查询即时天气函数</span><br><span class="hljs-string">    :param loc: 必要参数，字符串类型，用于表示查询天气的具体城市名称，\</span><br><span class="hljs-string">    注意，中国的城市需要用对应城市的英文名称代替，例如如果需要查询北京市天气，则loc参数需要输入&#x27;Beijing&#x27;；</span><br><span class="hljs-string">    :return：OpenWeather API查询即时天气的结果，具体URL请求地址为：https://api.openweathermap.org/data/2.5/weather\</span><br><span class="hljs-string">    返回结果对象类型为解析之后的JSON格式对象，并用字符串形式进行表示，其中包含了全部重要的天气信息</span><br><span class="hljs-string">    &quot;&quot;&quot;</span><br>    <span class="hljs-comment"># Step 1.构建请求</span><br>    url = <span class="hljs-string">&quot;https://api.openweathermap.org/data/2.5/weather&quot;</span><br><br>    <span class="hljs-comment"># Step 2.设置查询参数</span><br>    params = &#123;<br>        <span class="hljs-string">&quot;q&quot;</span>: loc,<br>        <span class="hljs-string">&quot;appid&quot;</span>: os.getenv(<span class="hljs-string">&quot;OPENWEATHER_API_KEY&quot;</span>),  <span class="hljs-comment"># 输入API key</span><br>        <span class="hljs-string">&quot;units&quot;</span>: <span class="hljs-string">&quot;metric&quot;</span>,  <span class="hljs-comment"># 使用摄氏度而不是华氏度</span><br>        <span class="hljs-string">&quot;lang&quot;</span>: <span class="hljs-string">&quot;zh_cn&quot;</span>  <span class="hljs-comment"># 输出语言为简体中文</span><br>    &#125;<br><br>    <span class="hljs-comment"># Step 3.发送GET请求</span><br>    response = requests.get(url, params=params)<br><br>    <span class="hljs-comment"># Step 4.解析响应</span><br>    data = response.json()<br>    <span class="hljs-keyword">return</span> json.dumps(data)<br><br><span class="hljs-comment">#定义工具</span><br>tools = [get_weather]<br><br><span class="hljs-comment"># 构建提示模版</span><br>prompt = ChatPromptTemplate.from_messages(<br>    [<br>        (<span class="hljs-string">&quot;system&quot;</span>, <span class="hljs-string">&quot;你是天气助手，请根据用户的问题，给出相应的天气信息&quot;</span>),<br>        (<span class="hljs-string">&quot;human&quot;</span>, <span class="hljs-string">&quot;&#123;input&#125;&quot;</span>),<br>        (<span class="hljs-string">&quot;placeholder&quot;</span>, <span class="hljs-string">&quot;&#123;agent_scratchpad&#125;&quot;</span>),<br>    ]<br>)<br><br><span class="hljs-comment"># 直接使用`create_tool_calling_agent`创建代理</span><br>agent = create_tool_calling_agent(model, tools, prompt)<br><br><span class="hljs-comment"># 使用`AgentExecutor`来执行代理</span><br>agent_executor = AgentExecutor(agent=agent, tools=tools, verbose=<span class="hljs-literal">True</span>)<br><br>response = agent_executor.invoke(&#123;<span class="hljs-string">&quot;input&quot;</span>: <span class="hljs-string">&quot;请问今天北京的天气怎么样？&quot;</span>&#125;)<br><br><span class="hljs-built_in">print</span>(response)<br><br><span class="hljs-built_in">print</span>(response[<span class="hljs-string">&quot;output&quot;</span>])<br></code></pre></td></tr></table></figure>

<p><code>LangChain</code> 中<code>Agents</code>模块的整体架构设计。如下所示：</p>
<p class='item-img' data-src='/images/29.png'><img src="/images/29.png"></p>
<p>在<code>Agents</code>的内部结构。每个<code>Agent</code>组件一般会由语言模型 + 提示 + 输出解析器构成，它会作为<code>Agents</code>的大脑去处理用户的输入。<code>Agent</code>能够处理的输入主要来源于三个方面：<code>input</code>代表用户的原始输入，<code>Model Response</code>指的是模型对某一个子任务的响应输出，而<code>History</code>则能携带上下文的信息。其输出部分，则链接到实际的工具库，需要调用哪些工具，将由经过<code>Agent</code>模块后拆分的子任务来决定。</p>
<p>而我们知道，大模型调用外部函数会分为两个过程：识别工具和实际执行。在 <code>Message -&gt; Agent -&gt; Toolkits</code> 这个流程中，负责的是将子任务拆解，然后根据这些子任务在工具库中找到相应的工具，提取工具名称及所需参数，这个过程可以视作一种“静态”的执行流程。而将这些决策转化为实际行动的工作，则会交给<code>AgentExecutor</code>。</p>
<p>所以综上需要理解的是：在<code>LangChain</code>的<code>Agents</code>实际架构中，<code>Agent</code>的角色是接收输入并决定采取的操作，但它本身并不直接执行这些操作。这一任务是由<code>AgentExecutor</code>来完成的。将<code>Agent</code>（决策大脑）与<code>AgentExecutor</code>（执行操作的<code>Runtime</code>）结合使用，才构成了完整的<code>Agents</code>（智能体），其中<code>AgentExecutor</code>负责调用代理并执行指定的工具，以此来实现整个智能体的功能。</p>
<p>这也就是为什么<code>create_tool_calling_agent</code>需要通过<code>AgentExecutor</code>才能够实际运行的原因。当然，在这种模式下，**<code>AgentExecutor</code>的内部已经自动处理好了关于我们工具调用的所有逻辑，其中包含串行和并行工具调用的两种常用模式。**</p>
<p>在大模型中，并行工具调用指的是在大模型调用外部工具时，可以在单次交互过程中可以同时调用多个工具，并行执行以解决用户的问题。如下图所示：</p>
<p class='item-img' data-src='/images/30.png'><img src="/images/30.png"></p>
<p>而在<code>create_tool_calling_agent</code>中，已经自动处理了并行工具调用的处理逻辑，并不需要我们在手动处理，比如接下来测试一些复杂的问题：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">import</span> json<br><span class="hljs-keyword">import</span> os<br><span class="hljs-keyword">import</span> requests<br><span class="hljs-keyword">from</span> langchain.agents <span class="hljs-keyword">import</span> create_tool_calling_agent, tool, AgentExecutor<br><span class="hljs-keyword">from</span> langchain_core.prompts <span class="hljs-keyword">import</span> ChatPromptTemplate<br><span class="hljs-keyword">from</span> langchain.chat_models <span class="hljs-keyword">import</span> init_chat_model<br><span class="hljs-keyword">from</span> dotenv <span class="hljs-keyword">import</span> load_dotenv<br>load_dotenv(override=<span class="hljs-literal">True</span>)<br><br>OPENWEATHER_API_KEY = os.getenv(<span class="hljs-string">&quot;OPENWEATHER_API_KEY&quot;</span>)<br><br><span class="hljs-comment"># 初始化模型</span><br>model = init_chat_model(<span class="hljs-string">&quot;deepseek-chat&quot;</span>, model_provider=<span class="hljs-string">&quot;deepseek&quot;</span>)<br><br><span class="hljs-meta">@tool</span><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">get_weather</span>(<span class="hljs-params">loc</span>):<br>    <span class="hljs-string">&quot;&quot;&quot;</span><br><span class="hljs-string">    查询即时天气函数</span><br><span class="hljs-string">    :param loc: 必要参数，字符串类型，用于表示查询天气的具体城市名称，\</span><br><span class="hljs-string">    注意，中国的城市需要用对应城市的英文名称代替，例如如果需要查询北京市天气，则loc参数需要输入&#x27;Beijing&#x27;；</span><br><span class="hljs-string">    :return：OpenWeather API查询即时天气的结果，具体URL请求地址为：https://api.openweathermap.org/data/2.5/weather\</span><br><span class="hljs-string">    返回结果对象类型为解析之后的JSON格式对象，并用字符串形式进行表示，其中包含了全部重要的天气信息</span><br><span class="hljs-string">    &quot;&quot;&quot;</span><br>    <span class="hljs-comment"># Step 1.构建请求</span><br>    url = <span class="hljs-string">&quot;https://api.openweathermap.org/data/2.5/weather&quot;</span><br><br>    <span class="hljs-comment"># Step 2.设置查询参数</span><br>    params = &#123;<br>        <span class="hljs-string">&quot;q&quot;</span>: loc,<br>        <span class="hljs-string">&quot;appid&quot;</span>: os.getenv(<span class="hljs-string">&quot;OPENWEATHER_API_KEY&quot;</span>),  <span class="hljs-comment"># 输入API key</span><br>        <span class="hljs-string">&quot;units&quot;</span>: <span class="hljs-string">&quot;metric&quot;</span>,  <span class="hljs-comment"># 使用摄氏度而不是华氏度</span><br>        <span class="hljs-string">&quot;lang&quot;</span>: <span class="hljs-string">&quot;zh_cn&quot;</span>  <span class="hljs-comment"># 输出语言为简体中文</span><br>    &#125;<br><br>    <span class="hljs-comment"># Step 3.发送GET请求</span><br>    response = requests.get(url, params=params)<br><br>    <span class="hljs-comment"># Step 4.解析响应</span><br>    data = response.json()<br>    <span class="hljs-keyword">return</span> json.dumps(data)<br><br><span class="hljs-comment">#定义工具</span><br>tools = [get_weather]<br><br><span class="hljs-comment"># 构建提示模版</span><br>prompt = ChatPromptTemplate.from_messages(<br>    [<br>        (<span class="hljs-string">&quot;system&quot;</span>, <span class="hljs-string">&quot;你是天气助手，请根据用户的问题，给出相应的天气信息&quot;</span>),<br>        (<span class="hljs-string">&quot;human&quot;</span>, <span class="hljs-string">&quot;&#123;input&#125;&quot;</span>),<br>        (<span class="hljs-string">&quot;placeholder&quot;</span>, <span class="hljs-string">&quot;&#123;agent_scratchpad&#125;&quot;</span>),<br>    ]<br>)<br><br><span class="hljs-comment"># 直接使用`create_tool_calling_agent`创建代理</span><br>agent = create_tool_calling_agent(model, tools, prompt)<br><br><span class="hljs-comment"># 使用`AgentExecutor`来执行代理</span><br>agent_executor = AgentExecutor(agent=agent, tools=tools, verbose=<span class="hljs-literal">True</span>)<br><br>response = agent_executor.invoke(&#123;<span class="hljs-string">&quot;input&quot;</span>: <span class="hljs-string">&quot;请问今天北京和杭州的天气怎么样，哪个城市更热？&quot;</span>&#125;)<br><br><span class="hljs-built_in">print</span>(response[<span class="hljs-string">&quot;output&quot;</span>])<br></code></pre></td></tr></table></figure>

<p>从这个过程中可以明显的看出，一次性发起了同一个外部函数的两次调用请求，并依次获得了北京和杭州两个城市的天气。这就是一次标准的<code>parallel_function_call</code>。</p>
<p class='item-img' data-src='/images/31.png'><img src="/images/31.png"></p>
<p>接下来继续尝试进行多工具串联调用测试：</p>
<p class='item-img' data-src='/images/32.png'><img src="/images/32.png"></p>
<p>此时我们再定义一个<code>write_file</code>函数，用于将“文本写入本地”，然后在<code>tools</code>列表中直接添加<code>write_file</code>工具，并修改提示模版，添加<code>write_file</code>工具的使用场景。代码如下所示： </p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">import</span> json<br><span class="hljs-keyword">import</span> os<br><span class="hljs-keyword">import</span> requests<br><span class="hljs-keyword">from</span> langchain.agents <span class="hljs-keyword">import</span> create_tool_calling_agent, tool, AgentExecutor<br><span class="hljs-keyword">from</span> langchain_core.prompts <span class="hljs-keyword">import</span> ChatPromptTemplate<br><span class="hljs-keyword">from</span> langchain.chat_models <span class="hljs-keyword">import</span> init_chat_model<br><span class="hljs-keyword">from</span> dotenv <span class="hljs-keyword">import</span> load_dotenv<br>load_dotenv(override=<span class="hljs-literal">True</span>)<br><br>OPENWEATHER_API_KEY = os.getenv(<span class="hljs-string">&quot;OPENWEATHER_API_KEY&quot;</span>)<br><br><span class="hljs-comment"># 初始化模型</span><br>model = init_chat_model(<span class="hljs-string">&quot;deepseek-chat&quot;</span>, model_provider=<span class="hljs-string">&quot;deepseek&quot;</span>)<br><br><span class="hljs-meta">@tool</span><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">get_weather</span>(<span class="hljs-params">loc</span>):<br>    <span class="hljs-string">&quot;&quot;&quot;</span><br><span class="hljs-string">    查询即时天气函数</span><br><span class="hljs-string">    :param loc: 必要参数，字符串类型，用于表示查询天气的具体城市名称，\</span><br><span class="hljs-string">    注意，中国的城市需要用对应城市的英文名称代替，例如如果需要查询北京市天气，则loc参数需要输入&#x27;Beijing&#x27;；</span><br><span class="hljs-string">    :return：OpenWeather API查询即时天气的结果，具体URL请求地址为：https://api.openweathermap.org/data/2.5/weather\</span><br><span class="hljs-string">    返回结果对象类型为解析之后的JSON格式对象，并用字符串形式进行表示，其中包含了全部重要的天气信息</span><br><span class="hljs-string">    &quot;&quot;&quot;</span><br>    <span class="hljs-comment"># Step 1.构建请求</span><br>    url = <span class="hljs-string">&quot;https://api.openweathermap.org/data/2.5/weather&quot;</span><br><br>    <span class="hljs-comment"># Step 2.设置查询参数</span><br>    params = &#123;<br>        <span class="hljs-string">&quot;q&quot;</span>: loc,<br>        <span class="hljs-string">&quot;appid&quot;</span>: os.getenv(<span class="hljs-string">&quot;OPENWEATHER_API_KEY&quot;</span>),  <span class="hljs-comment"># 输入API key</span><br>        <span class="hljs-string">&quot;units&quot;</span>: <span class="hljs-string">&quot;metric&quot;</span>,  <span class="hljs-comment"># 使用摄氏度而不是华氏度</span><br>        <span class="hljs-string">&quot;lang&quot;</span>: <span class="hljs-string">&quot;zh_cn&quot;</span>  <span class="hljs-comment"># 输出语言为简体中文</span><br>    &#125;<br><br>    <span class="hljs-comment"># Step 3.发送GET请求</span><br>    response = requests.get(url, params=params)<br><br>    <span class="hljs-comment"># Step 4.解析响应</span><br>    data = response.json()<br>    <span class="hljs-keyword">return</span> json.dumps(data)<br><br><span class="hljs-meta">@tool</span><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">write_file</span>(<span class="hljs-params">content</span>):<br>    <span class="hljs-string">&quot;&quot;&quot;</span><br><span class="hljs-string">    将指定内容写入本地文件。</span><br><span class="hljs-string">    :param content: 必要参数，字符串类型，用于表示需要写入文档的具体内容。</span><br><span class="hljs-string">    :return：是否成功写入</span><br><span class="hljs-string">    &quot;&quot;&quot;</span><br>    <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;已成功写入本地文件。&quot;</span><br><br><span class="hljs-comment">#定义工具</span><br>tools = [get_weather, write_file]<br><br><span class="hljs-comment"># 构建提示模版</span><br>prompt = ChatPromptTemplate.from_messages(<br>    [<br>        (<span class="hljs-string">&quot;system&quot;</span>, <span class="hljs-string">&quot;你是天气助手，请根据用户的问题，给出相应的天气信息，如果用户需要将查询结果写入文件，请使用write_file工具&quot;</span>),<br>        (<span class="hljs-string">&quot;human&quot;</span>, <span class="hljs-string">&quot;&#123;input&#125;&quot;</span>),<br>        (<span class="hljs-string">&quot;placeholder&quot;</span>, <span class="hljs-string">&quot;&#123;agent_scratchpad&#125;&quot;</span>),<br>    ]<br>)<br><br><span class="hljs-comment"># 直接使用`create_tool_calling_agent`创建代理</span><br>agent = create_tool_calling_agent(model, tools, prompt)<br><br><span class="hljs-comment"># 使用`AgentExecutor`来执行代理</span><br>agent_executor = AgentExecutor(agent=agent, tools=tools, verbose=<span class="hljs-literal">True</span>)<br><br>response = agent_executor.invoke(&#123;<span class="hljs-string">&quot;input&quot;</span>: <span class="hljs-string">&quot;查一下北京和杭州现在的温度，并将结果写入本地的文件中。&quot;</span>&#125;)<br><br><span class="hljs-built_in">print</span>(response[<span class="hljs-string">&quot;output&quot;</span>])<br></code></pre></td></tr></table></figure>

<p>通过中间过程信息的打印，我们能够看到在一次交互过程中依次调用的<code>get_weather</code>查询到北京和杭州的天气，然后又将结果写入到本地的文件中。这就是一个非常典型的串行工具调用的流程，如下图所示：</p>
<p class='item-img' data-src='/images/33.png'><img src="/images/33.png"></p>
<h1 id="五、LangChain-Agent进阶功能介绍"><a href="#五、LangChain-Agent进阶功能介绍" class="headerlink" title="五、LangChain Agent进阶功能介绍"></a>五、<strong>LangChain Agent进阶功能介绍</strong></h1><p><strong>借助<code>LangChain Agent</code>+内置工具快速搭建智能体</strong></p>
<p>既然<code>LangChain Agent</code>能更加灵活调用外部工具，<code>LangChain Agent+LangChain</code>内置工具也能更加快速的完成复杂<code>Agent</code>开发。</p>
<p><a target="_blank" rel="noopener" href="https://python.langchain.com/docs/integrations/tools/"><strong><code>LangChain</code> 第三方工具集成</strong></a></p>
<p>下面选择以<a target="_blank" rel="noopener" href="https://python.langchain.com/docs/integrations/tools/tavily_search/"><strong><code>LangChain</code> 的 <code>Tavily Search</code> 工具</strong></a>为例进行讲解</p>
<p>可以通过访问<a target="_blank" rel="noopener" href="https://app.tavily.com/sign-in">此站点</a>创建一个帐户来获取<code>LangChain</code> 的 <code>Tavily Search</code> 工具的 <code>API </code>密钥，并将其加到<code>.env</code>文件中</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs python">TAVILY_API_KEY=tvly-xxx<br></code></pre></td></tr></table></figure>

<p><code>langchain-tavily</code>集成存在于包中</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs python">pip install -U langchain-tavily<br></code></pre></td></tr></table></figure>

<p>先编写一个简单的程序验证该工具能正常运行</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">import</span> os<br><span class="hljs-keyword">from</span> langchain_tavily <span class="hljs-keyword">import</span> TavilySearch<br><span class="hljs-keyword">from</span> dotenv <span class="hljs-keyword">import</span> load_dotenv<br>load_dotenv(override=<span class="hljs-literal">True</span>)<br><br><span class="hljs-comment"># 初始化 Tavily 搜索工具</span><br>search = TavilySearch(max_results=<span class="hljs-number">2</span>)<br><br><span class="hljs-comment"># 执行搜索</span><br>result = search.invoke(<span class="hljs-string">&quot;苹果2025WWDC发布会&quot;</span>)<br><span class="hljs-built_in">print</span>(result)<br></code></pre></td></tr></table></figure>

<p>再使用<code>LangChain Agent</code>配合<code>LangChain</code>内置的<code>Tavily Search</code>工具快速地完成复杂<code>Agent</code>开发</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">import</span> os<br><span class="hljs-keyword">from</span> langchain_tavily <span class="hljs-keyword">import</span> TavilySearch<br><span class="hljs-keyword">from</span> langchain.agents <span class="hljs-keyword">import</span> AgentExecutor, create_tool_calling_agent, tool<br><span class="hljs-keyword">from</span> langchain_core.prompts <span class="hljs-keyword">import</span> ChatPromptTemplate<br><span class="hljs-keyword">from</span> langchain.chat_models <span class="hljs-keyword">import</span> init_chat_model<br><span class="hljs-keyword">from</span> dotenv <span class="hljs-keyword">import</span> load_dotenv<br>load_dotenv(override=<span class="hljs-literal">True</span>)<br><br><span class="hljs-comment"># 初始化 Tavily 搜索工具</span><br>search = TavilySearch(max_results=<span class="hljs-number">2</span>)<br><br>tools = [search]<br><br>prompt = ChatPromptTemplate.from_messages(<br>    [<br>        (<span class="hljs-string">&quot;system&quot;</span>, <span class="hljs-string">&quot;你是一名助人为乐的助手，并且可以调用工具进行网络搜索，获取实时信息。&quot;</span>),<br>        (<span class="hljs-string">&quot;human&quot;</span>, <span class="hljs-string">&quot;&#123;input&#125;&quot;</span>),<br>        (<span class="hljs-string">&quot;placeholder&quot;</span>, <span class="hljs-string">&quot;&#123;agent_scratchpad&#125;&quot;</span>),<br>    ]<br>)<br><br><span class="hljs-comment"># 初始化模型</span><br>model = init_chat_model(<span class="hljs-string">&quot;deepseek-chat&quot;</span>, model_provider=<span class="hljs-string">&quot;deepseek&quot;</span>)<br><br>agent = create_tool_calling_agent(model, tools, prompt)<br><br>agent_executor = AgentExecutor(agent=agent, tools=tools, verbose=<span class="hljs-literal">True</span>)<br><br>result = agent_executor.invoke(&#123;<span class="hljs-string">&quot;input&quot;</span>: <span class="hljs-string">&quot;请问苹果2025WWDC发布会召开的时间是？&quot;</span>&#125;)<br><br><span class="hljs-built_in">print</span>(result[<span class="hljs-string">&#x27;output&#x27;</span>])<br></code></pre></td></tr></table></figure>

<p>接着我们来完成<strong>多智能体协作实现浏览器自动化</strong></p>
<p>正如上述我们使用的<code>create_tool_calling_agent</code>方法，它其实在<code>langChain</code>中是一个通用的用来构建工具代理的方法，除此以外，<code>langChain</code>还封装了非常多种不同的<code>Agent</code>实现形式</p>
<p>下面是推荐的<code>Agent</code>创建函数：</p>
<table>
<thead>
<tr>
<th align="center">函数名</th>
<th align="center">功能描述</th>
<th align="center">适用场景</th>
</tr>
</thead>
<tbody><tr>
<td align="center"><strong>create_tool_calling_agent</strong></td>
<td align="center">创建使用工具的Agent</td>
<td align="center">通用工具调用</td>
</tr>
<tr>
<td align="center"><strong>create_openai_tools_agent</strong></td>
<td align="center">创建OpenAI工具Agent</td>
<td align="center">OpenAI模型专用</td>
</tr>
<tr>
<td align="center"><strong>create_openai_functions_agent</strong></td>
<td align="center">创建OpenAI函数Agent</td>
<td align="center">OpenAI函数调用</td>
</tr>
<tr>
<td align="center"><strong>create_react_agent</strong></td>
<td align="center">创建ReAct推理Agent</td>
<td align="center">推理+行动模式</td>
</tr>
<tr>
<td align="center"><strong>create_structured_chat_agent</strong></td>
<td align="center">创建结构化聊天Agent</td>
<td align="center">多输入工具支持</td>
</tr>
<tr>
<td align="center"><strong>create_conversational_retrieval_agent</strong></td>
<td align="center">创建对话检索Agent</td>
<td align="center">检索增强对话</td>
</tr>
<tr>
<td align="center"><strong>create_json_chat_agent</strong></td>
<td align="center">创建JSON聊天Agent</td>
<td align="center">JSON格式交互</td>
</tr>
<tr>
<td align="center"><strong>create_xml_agent</strong></td>
<td align="center">创建XML格式Agent</td>
<td align="center">XML逻辑格式</td>
</tr>
<tr>
<td align="center"><strong>create_self_ask_with_search_agent</strong></td>
<td align="center">创建自问自答搜索Agent</td>
<td align="center">自主搜索推理</td>
</tr>
</tbody></table>
<p>其中比较通用场景的就是我们刚刚使用的<code>create_tool_calling_agent</code>，而对于一些符合<code>OpenAI API RESTFUL API</code>的模型，则同样可以使用<code>create_openai_tools_agent</code>，另外像<code>create_react_agent</code>可以用于一些推理任务，<code>create_conversational_retrieval_agent</code>则可以用于一些对话系统，具体还是需要根据实际需求来选择。</p>
<p>目前来说，在大模型应用开发领域有非常多的需求场景，其中一个比较热门的就是浏览器自动化，通过自动化提取网页内容，然后进行分析，最后生成报告。这样的流程提升效率和收集信息的有效途径。因此接下来，我们就尝试使用尝试使用<code>create_openai_tools_agent</code>来实际开发一个浏览器自动化代理。</p>
<p>首先，执行浏览器自动化代理需要安装一系列的第三方依赖包，如下所示：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">pip install playwright lxml langchain_community beautifulsoup4 reportlab<br></code></pre></td></tr></table></figure>

<p>此外，还需要安装 <code>Playwright</code> 浏览器，需要在当前虚拟环境中执行如下命令：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">playwright install<br></code></pre></td></tr></table></figure>

<p>这个安装过程它会下载并安装 <code>Playwright</code> 支持的浏览器内核（注意：这里不是用我们本机已有的浏览器），包括<code>Chromium</code>（类似 Chrome）、<code>Firefox</code>、<code>WebKit</code>（类似 <code>Safari</code>），并将这些浏览器下载到本地的 <code>.cache/ms-playwright</code> 目录或项目的 <code>~/.playwright</code> 目录中，以便 <code>Playwright</code> 使用稳定一致的运行环境。</p>
<p>这个案例的核心代码首先是需要用代理工具初始化同步 <code>Playwright</code> 浏览器：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs python">sync_browser = create_sync_playwright_browser()<br><br>toolkit = PlayWrightBrowserToolkit.from_browser(sync_browser=sync_browser)<br><br>tools = toolkit.get_tools()<br></code></pre></td></tr></table></figure>

<p>然后再通过<code>create_openai_tools_agent</code>接收初始化的大模型和<code>Playwright</code>工具构建共同构建<code>OpenAI Tools</code> 代理，最后通过<code>AgentExecutor</code>执行代理。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-comment"># 通过 LangChain 创建 OpenAI 工具代理</span><br>agent = create_openai_tools_agent(model, tools, prompt)<br><br><span class="hljs-comment"># 通过 AgentExecutor 执行代理</span><br>agent_executor = AgentExecutor(agent=agent, tools=tools, verbose=<span class="hljs-literal">True</span>)<br></code></pre></td></tr></table></figure>

<p>完整的代码因为<code>langChian</code>的模块化封装非常简洁，如下所示：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> langchain_community.agent_toolkits <span class="hljs-keyword">import</span> PlayWrightBrowserToolkit<br><span class="hljs-keyword">from</span> langchain_community.tools.playwright.utils <span class="hljs-keyword">import</span> create_sync_playwright_browser<br><span class="hljs-keyword">from</span> langchain <span class="hljs-keyword">import</span> hub<br><span class="hljs-keyword">from</span> langchain.agents <span class="hljs-keyword">import</span> AgentExecutor, create_openai_tools_agent<br><span class="hljs-keyword">from</span> langchain.chat_models <span class="hljs-keyword">import</span> init_chat_model<br><span class="hljs-keyword">import</span> os<br><span class="hljs-keyword">from</span> dotenv <span class="hljs-keyword">import</span> load_dotenv<br>load_dotenv(override=<span class="hljs-literal">True</span>)<br><br>DeepSeek_API_KEY = os.getenv(<span class="hljs-string">&quot;DEEPSEEK_API_KEY&quot;</span>)<br><span class="hljs-comment"># print(DeepSeek_API_KEY)  # 可以通过打印查看</span><br><br><span class="hljs-comment"># 初始化 Playwright 浏览器：</span><br>sync_browser = create_sync_playwright_browser()<br>toolkit = PlayWrightBrowserToolkit.from_browser(sync_browser=sync_browser)<br>tools = toolkit.get_tools()<br><br><span class="hljs-comment"># 通过 LangChain Hub 拉取提示词模版</span><br><span class="hljs-comment"># https://smith.langchain.com/hub</span><br><span class="hljs-comment"># 这是 LangChain 中从 LangChain Hub 加载预定义提示词模板（prompt template）的操作</span><br><span class="hljs-comment"># &quot;hwchase17/openai-tools-agent&quot; 是 LangChain 官方维护的一个标准提示词模板，专为 OpenAI 工具调用型 Agent 设计</span><br>prompt = hub.pull(<span class="hljs-string">&quot;hwchase17/openai-tools-agent&quot;</span>)<br><br><span class="hljs-comment"># 初始化模型</span><br>model = init_chat_model(<span class="hljs-string">&quot;deepseek-chat&quot;</span>, model_provider=<span class="hljs-string">&quot;deepseek&quot;</span>)<br><br><span class="hljs-comment"># 通过 LangChain 创建 OpenAI 工具代理</span><br>agent = create_openai_tools_agent(model, tools, prompt)<br><br><span class="hljs-comment"># 通过 AgentExecutor 执行代理</span><br>agent_executor = AgentExecutor(agent=agent, tools=tools, verbose=<span class="hljs-literal">True</span>)<br><br><br><span class="hljs-keyword">if</span> __name__ == <span class="hljs-string">&quot;__main__&quot;</span>:<br>    <span class="hljs-comment"># 定义任务</span><br>    command = &#123;<br>        <span class="hljs-string">&quot;input&quot;</span>: <span class="hljs-string">&quot;访问这个网站 https://blogroll.naosi.org/ 并用中文帮我总结一下这个网站的内容&quot;</span><br>    &#125;<br><br>    <span class="hljs-comment"># 执行任务</span><br>    response = agent_executor.invoke(command)<br>    <span class="hljs-built_in">print</span>(response[<span class="hljs-string">&#x27;output&#x27;</span>])<br></code></pre></td></tr></table></figure>

<p>更进一步地，我们还可以将<code>Playwright Agent</code>封装成工具函数，并结合<code>LangChain</code>的<code>LCEL</code>串行链，实现一个更加复杂的浏览器自动化代理。这里定义的工具如下所示：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-comment"># 1. 创建网站总结工具</span><br><span class="hljs-meta">@tool</span><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">summarize_website</span>(<span class="hljs-params">url: <span class="hljs-built_in">str</span></span>) -&gt; <span class="hljs-built_in">str</span>:<br>    <span class="hljs-string">&quot;&quot;&quot;访问指定网站并返回内容总结&quot;&quot;&quot;</span><br>    <span class="hljs-keyword">try</span>:<br>        <span class="hljs-comment"># 创建浏览器实例</span><br>        sync_browser = create_sync_playwright_browser()<br>        toolkit = PlayWrightBrowserToolkit.from_browser(sync_browser=sync_browser)<br>        tools = toolkit.get_tools()<br><br>        <span class="hljs-comment"># 初始化模型和Agent</span><br>        model = init_chat_model(<span class="hljs-string">&quot;deepseek-chat&quot;</span>, model_provider=<span class="hljs-string">&quot;deepseek&quot;</span>)<br>        prompt = hub.pull(<span class="hljs-string">&quot;hwchase17/openai-tools-agent&quot;</span>)<br>        agent = create_openai_tools_agent(model, tools, prompt)<br>        agent_executor = AgentExecutor(agent=agent, tools=tools, verbose=<span class="hljs-literal">False</span>)<br><br>        <span class="hljs-comment"># 执行总结任务</span><br>        command = &#123;<br>            <span class="hljs-string">&quot;input&quot;</span>: <span class="hljs-string">f&quot;访问这个网站 <span class="hljs-subst">&#123;url&#125;</span> 并帮我详细总结一下这个网站的内容，包括主要功能、特点和使用方法&quot;</span><br>        &#125;<br><br>        result = agent_executor.invoke(command)<br>        <span class="hljs-keyword">return</span> result.get(<span class="hljs-string">&quot;output&quot;</span>, <span class="hljs-string">&quot;无法获取网站内容总结&quot;</span>)<br><br>    <span class="hljs-keyword">except</span> Exception <span class="hljs-keyword">as</span> e:<br>        <span class="hljs-keyword">return</span> <span class="hljs-string">f&quot;网站访问失败: <span class="hljs-subst">&#123;<span class="hljs-built_in">str</span>(e)&#125;</span>&quot;</span><br><br><br><span class="hljs-comment"># 2. 创建PDF生成工具</span><br><span class="hljs-meta">@tool</span><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">generate_pdf</span>(<span class="hljs-params">content: <span class="hljs-built_in">str</span></span>) -&gt; <span class="hljs-built_in">str</span>:<br>    <span class="hljs-string">&quot;&quot;&quot;将文本内容生成为PDF文件&quot;&quot;&quot;</span><br>    <span class="hljs-keyword">try</span>:<br>        <span class="hljs-comment"># 生成文件名（带时间戳）</span><br>        timestamp = datetime.now().strftime(<span class="hljs-string">&quot;%Y%m%d_%H%M%S&quot;</span>)<br>        filename = <span class="hljs-string">f&quot;website_summary_<span class="hljs-subst">&#123;timestamp&#125;</span>.pdf&quot;</span><br><br>        <span class="hljs-comment"># 创建PDF文档</span><br>        doc = SimpleDocTemplate(filename, pagesize=A4)<br>        styles = getSampleStyleSheet()<br><br>        <span class="hljs-comment"># 注册中文字体（如果系统有的话）</span><br>        <span class="hljs-keyword">try</span>:<br>            <span class="hljs-comment"># Windows 系统字体路径</span><br>            font_paths = [<br>                <span class="hljs-string">&quot;C:/Windows/Fonts/simhei.ttf&quot;</span>,  <span class="hljs-comment"># 黑体</span><br>                <span class="hljs-string">&quot;C:/Windows/Fonts/simsun.ttc&quot;</span>,  <span class="hljs-comment"># 宋体</span><br>                <span class="hljs-string">&quot;C:/Windows/Fonts/msyh.ttc&quot;</span>,  <span class="hljs-comment"># 微软雅黑</span><br>            ]<br><br>            chinese_font_registered = <span class="hljs-literal">False</span><br>            <span class="hljs-keyword">for</span> font_path <span class="hljs-keyword">in</span> font_paths:<br>                <span class="hljs-keyword">if</span> os.path.exists(font_path):<br>                    <span class="hljs-keyword">try</span>:<br>                        pdfmetrics.registerFont(TTFont(<span class="hljs-string">&#x27;ChineseFont&#x27;</span>, font_path))<br>                        chinese_font_registered = <span class="hljs-literal">True</span><br>                        <span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;✅ 成功注册中文字体: <span class="hljs-subst">&#123;font_path&#125;</span>&quot;</span>)<br>                        <span class="hljs-keyword">break</span><br>                    <span class="hljs-keyword">except</span>:<br>                        <span class="hljs-keyword">continue</span><br><br>            <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> chinese_font_registered:<br>                <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;⚠️ 未找到中文字体，使用默认字体&quot;</span>)<br><br>        <span class="hljs-keyword">except</span> Exception <span class="hljs-keyword">as</span> e:<br>            <span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;⚠️ 字体注册失败: <span class="hljs-subst">&#123;e&#125;</span>&quot;</span>)<br><br>        <span class="hljs-comment"># 自定义样式 - 支持中文</span><br>        title_style = ParagraphStyle(<br>            <span class="hljs-string">&#x27;CustomTitle&#x27;</span>,<br>            parent=styles[<span class="hljs-string">&#x27;Heading1&#x27;</span>],<br>            fontSize=<span class="hljs-number">18</span>,<br>            alignment=TA_CENTER,<br>            spaceAfter=<span class="hljs-number">30</span>,<br>            fontName=<span class="hljs-string">&#x27;ChineseFont&#x27;</span> <span class="hljs-keyword">if</span> <span class="hljs-string">&#x27;chinese_font_registered&#x27;</span> <span class="hljs-keyword">in</span> <span class="hljs-built_in">locals</span>() <span class="hljs-keyword">and</span> chinese_font_registered <span class="hljs-keyword">else</span> <span class="hljs-string">&#x27;Helvetica-Bold&#x27;</span><br>        )<br><br>        content_style = ParagraphStyle(<br>            <span class="hljs-string">&#x27;CustomContent&#x27;</span>,<br>            parent=styles[<span class="hljs-string">&#x27;Normal&#x27;</span>],<br>            fontSize=<span class="hljs-number">11</span>,<br>            alignment=TA_JUSTIFY,<br>            leftIndent=<span class="hljs-number">20</span>,<br>            rightIndent=<span class="hljs-number">20</span>,<br>            spaceAfter=<span class="hljs-number">12</span>,<br>            fontName=<span class="hljs-string">&#x27;ChineseFont&#x27;</span> <span class="hljs-keyword">if</span> <span class="hljs-string">&#x27;chinese_font_registered&#x27;</span> <span class="hljs-keyword">in</span> <span class="hljs-built_in">locals</span>() <span class="hljs-keyword">and</span> chinese_font_registered <span class="hljs-keyword">else</span> <span class="hljs-string">&#x27;Helvetica&#x27;</span><br>        )<br><br>        <span class="hljs-comment"># 构建PDF内容</span><br>        story = []<br><br>        <span class="hljs-comment"># 标题</span><br>        story.append(Paragraph(<span class="hljs-string">&quot;网站内容总结报告&quot;</span>, title_style))<br>        story.append(Spacer(<span class="hljs-number">1</span>, <span class="hljs-number">20</span>))<br><br>        <span class="hljs-comment"># 生成时间</span><br>        time_text = <span class="hljs-string">f&quot;生成时间: <span class="hljs-subst">&#123;datetime.now().strftime(<span class="hljs-string">&#x27;%Y-%m-%d %H:%M:%S&#x27;</span>)&#125;</span>&quot;</span><br>        story.append(Paragraph(time_text, styles[<span class="hljs-string">&#x27;Normal&#x27;</span>]))<br>        story.append(Spacer(<span class="hljs-number">1</span>, <span class="hljs-number">20</span>))<br><br>        <span class="hljs-comment"># 分隔线</span><br>        story.append(Paragraph(<span class="hljs-string">&quot;=&quot;</span> * <span class="hljs-number">50</span>, styles[<span class="hljs-string">&#x27;Normal&#x27;</span>]))<br>        story.append(Spacer(<span class="hljs-number">1</span>, <span class="hljs-number">15</span>))<br><br>        <span class="hljs-comment"># 主要内容 - 改进中文处理</span><br>        <span class="hljs-keyword">if</span> content:<br>            <span class="hljs-comment"># 清理和处理内容</span><br>            content = content.replace(<span class="hljs-string">&#x27;\r\n&#x27;</span>, <span class="hljs-string">&#x27;\n&#x27;</span>).replace(<span class="hljs-string">&#x27;\r&#x27;</span>, <span class="hljs-string">&#x27;\n&#x27;</span>)<br>            paragraphs = content.split(<span class="hljs-string">&#x27;\n&#x27;</span>)<br><br>            <span class="hljs-keyword">for</span> para <span class="hljs-keyword">in</span> paragraphs:<br>                <span class="hljs-keyword">if</span> para.strip():<br>                    <span class="hljs-comment"># 处理特殊字符，确保PDF可以正确显示</span><br>                    clean_para = para.strip()<br>                    <span class="hljs-comment"># 转换HTML实体</span><br>                    clean_para = clean_para.replace(<span class="hljs-string">&#x27;&amp;lt;&#x27;</span>, <span class="hljs-string">&#x27;&lt;&#x27;</span>).replace(<span class="hljs-string">&#x27;&amp;gt;&#x27;</span>, <span class="hljs-string">&#x27;&gt;&#x27;</span>).replace(<span class="hljs-string">&#x27;&amp;amp;&#x27;</span>, <span class="hljs-string">&#x27;&amp;&#x27;</span>)<br><br>                    <span class="hljs-keyword">try</span>:<br>                        story.append(Paragraph(clean_para, content_style))<br>                        story.append(Spacer(<span class="hljs-number">1</span>, <span class="hljs-number">8</span>))<br>                    <span class="hljs-keyword">except</span> Exception <span class="hljs-keyword">as</span> para_error:<br>                        <span class="hljs-comment"># 如果段落有问题，尝试用默认字体</span><br>                        <span class="hljs-keyword">try</span>:<br>                            fallback_style = ParagraphStyle(<br>                                <span class="hljs-string">&#x27;Fallback&#x27;</span>,<br>                                parent=styles[<span class="hljs-string">&#x27;Normal&#x27;</span>],<br>                                fontSize=<span class="hljs-number">10</span>,<br>                                leftIndent=<span class="hljs-number">20</span>,<br>                                rightIndent=<span class="hljs-number">20</span>,<br>                                spaceAfter=<span class="hljs-number">10</span><br>                            )<br>                            story.append(Paragraph(clean_para, fallback_style))<br>                            story.append(Spacer(<span class="hljs-number">1</span>, <span class="hljs-number">8</span>))<br>                        <span class="hljs-keyword">except</span>:<br>                            <span class="hljs-comment"># 如果还是有问题，记录错误但继续</span><br>                            <span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;⚠️ 段落处理失败: <span class="hljs-subst">&#123;clean_para[:<span class="hljs-number">50</span>]&#125;</span>...&quot;</span>)<br>                            <span class="hljs-keyword">continue</span><br>        <span class="hljs-keyword">else</span>:<br>            story.append(Paragraph(<span class="hljs-string">&quot;暂无内容&quot;</span>, content_style))<br><br>        <span class="hljs-comment"># 页脚信息</span><br>        story.append(Spacer(<span class="hljs-number">1</span>, <span class="hljs-number">30</span>))<br>        story.append(Paragraph(<span class="hljs-string">&quot;=&quot;</span> * <span class="hljs-number">50</span>, styles[<span class="hljs-string">&#x27;Normal&#x27;</span>]))<br>        story.append(Paragraph(<span class="hljs-string">&quot;本报告由 Playwright PDF Agent 自动生成&quot;</span>, styles[<span class="hljs-string">&#x27;Italic&#x27;</span>]))<br><br>        <span class="hljs-comment"># 生成PDF</span><br>        doc.build(story)<br><br>        <span class="hljs-comment"># 获取绝对路径</span><br>        abs_path = os.path.abspath(filename)<br>        <span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;📄 PDF文件生成完成: <span class="hljs-subst">&#123;abs_path&#125;</span>&quot;</span>)<br>        <span class="hljs-keyword">return</span> <span class="hljs-string">f&quot;PDF文件已成功生成: <span class="hljs-subst">&#123;abs_path&#125;</span>&quot;</span><br><br>    <span class="hljs-keyword">except</span> Exception <span class="hljs-keyword">as</span> e:<br>        error_msg = <span class="hljs-string">f&quot;PDF生成失败: <span class="hljs-subst">&#123;<span class="hljs-built_in">str</span>(e)&#125;</span>&quot;</span><br>        <span class="hljs-built_in">print</span>(error_msg)<br>        <span class="hljs-keyword">return</span> error_msg<br></code></pre></td></tr></table></figure>

<p>然后我们可以自定义不同的链路，比如简单的串行链由<code>Playwright Agent</code>和 <code>generate_pdf Agent</code>组成，即先爬取网页的内容，然后将网页中的内容写入到本地的<code>PDF</code>文件中。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-comment"># 方法1：简单串行链</span><br>simple_chain = summarize_website | generate_pdf<br></code></pre></td></tr></table></figure>

<p>除此以外，我们还可以再定一个摘要工具，在使用<code>Playwright</code>工具访问网页后，根据爬取到的网页内容先使用大模型进行摘要总结，再调用<code>generate_pdf</code>工具将总结内容写入到本地的<code>PDF</code>文件中。代码如下所示：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><code class="hljs python">optimization_prompt = ChatPromptTemplate.from_template(<br>    <span class="hljs-string">&quot;&quot;&quot;请优化以下网站总结内容，使其更适合PDF报告格式：</span><br><span class="hljs-string"></span><br><span class="hljs-string">    原始总结：</span><br><span class="hljs-string">    &#123;summary&#125;</span><br><span class="hljs-string"></span><br><span class="hljs-string">    请重新组织内容，包括：</span><br><span class="hljs-string">    1. 清晰的标题和结构</span><br><span class="hljs-string">    2. 要点总结</span><br><span class="hljs-string">    3. 详细说明</span><br><span class="hljs-string">    4. 使用要求等</span><br><span class="hljs-string"></span><br><span class="hljs-string">    优化后的内容：&quot;&quot;&quot;</span><br>)<br><br>model = init_chat_model(<span class="hljs-string">&quot;deepseek-chat&quot;</span>, model_provider=<span class="hljs-string">&quot;deepseek&quot;</span>)<br><br><span class="hljs-comment"># 带优化的串行链：网站总结 → LLM优化 → PDF生成</span><br>optimized_chain = (<br>    summarize_website <br>    | (<span class="hljs-keyword">lambda</span> summary: &#123;<span class="hljs-string">&quot;summary&quot;</span>: summary&#125;)<br>    | optimization_prompt <br>    | model <br>    | StrOutputParser() <br>    | generate_pdf<br>)<br></code></pre></td></tr></table></figure>

<p>完整的代码如下所示：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> langchain_community.agent_toolkits <span class="hljs-keyword">import</span> PlayWrightBrowserToolkit<br><span class="hljs-keyword">from</span> langchain_community.tools.playwright.utils <span class="hljs-keyword">import</span> create_sync_playwright_browser<br><span class="hljs-keyword">from</span> langchain <span class="hljs-keyword">import</span> hub<br><span class="hljs-keyword">from</span> langchain.agents <span class="hljs-keyword">import</span> AgentExecutor, create_openai_tools_agent<br><span class="hljs-keyword">from</span> langchain.chat_models <span class="hljs-keyword">import</span> init_chat_model<br><span class="hljs-keyword">from</span> langchain_core.tools <span class="hljs-keyword">import</span> tool<br><span class="hljs-keyword">from</span> langchain_core.prompts <span class="hljs-keyword">import</span> ChatPromptTemplate<br><span class="hljs-keyword">from</span> langchain_core.output_parsers <span class="hljs-keyword">import</span> StrOutputParser<br><span class="hljs-keyword">from</span> reportlab.lib.pagesizes <span class="hljs-keyword">import</span> letter, A4<br><span class="hljs-keyword">from</span> reportlab.platypus <span class="hljs-keyword">import</span> SimpleDocTemplate, Paragraph, Spacer<br><span class="hljs-keyword">from</span> reportlab.lib.styles <span class="hljs-keyword">import</span> getSampleStyleSheet, ParagraphStyle<br><span class="hljs-keyword">from</span> reportlab.lib.enums <span class="hljs-keyword">import</span> TA_JUSTIFY, TA_CENTER<br><span class="hljs-keyword">from</span> reportlab.pdfbase <span class="hljs-keyword">import</span> pdfmetrics<br><span class="hljs-keyword">from</span> reportlab.pdfbase.ttfonts <span class="hljs-keyword">import</span> TTFont<br><span class="hljs-keyword">import</span> os<br><span class="hljs-keyword">from</span> datetime <span class="hljs-keyword">import</span> datetime<br><span class="hljs-keyword">import</span> os<br><span class="hljs-keyword">from</span> dotenv <span class="hljs-keyword">import</span> load_dotenv<br><br>load_dotenv(override=<span class="hljs-literal">True</span>)<br><br>DeepSeek_API_KEY = os.getenv(<span class="hljs-string">&quot;DEEPSEEK_API_KEY&quot;</span>)<br><br><span class="hljs-comment"># 1. 创建网站总结工具</span><br><span class="hljs-meta">@tool</span><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">summarize_website</span>(<span class="hljs-params">url: <span class="hljs-built_in">str</span></span>) -&gt; <span class="hljs-built_in">str</span>:<br>    <span class="hljs-string">&quot;&quot;&quot;访问指定网站并返回内容总结&quot;&quot;&quot;</span><br>    <span class="hljs-keyword">try</span>:<br>        <span class="hljs-comment"># 创建浏览器实例</span><br>        sync_browser = create_sync_playwright_browser()<br>        toolkit = PlayWrightBrowserToolkit.from_browser(sync_browser=sync_browser)<br>        tools = toolkit.get_tools()<br><br>        <span class="hljs-comment"># 初始化模型和Agent</span><br>        model = init_chat_model(<span class="hljs-string">&quot;deepseek-chat&quot;</span>, model_provider=<span class="hljs-string">&quot;deepseek&quot;</span>)<br>        prompt = hub.pull(<span class="hljs-string">&quot;hwchase17/openai-tools-agent&quot;</span>)<br>        agent = create_openai_tools_agent(model, tools, prompt)<br>        agent_executor = AgentExecutor(agent=agent, tools=tools, verbose=<span class="hljs-literal">False</span>)<br><br>        <span class="hljs-comment"># 执行总结任务</span><br>        command = &#123;<br>            <span class="hljs-string">&quot;input&quot;</span>: <span class="hljs-string">f&quot;访问这个网站 <span class="hljs-subst">&#123;url&#125;</span> 并帮我详细总结一下这个网站的内容，包括主要功能、特点和使用方法&quot;</span><br>        &#125;<br><br>        result = agent_executor.invoke(command)<br>        <span class="hljs-keyword">return</span> result.get(<span class="hljs-string">&quot;output&quot;</span>, <span class="hljs-string">&quot;无法获取网站内容总结&quot;</span>)<br><br>    <span class="hljs-keyword">except</span> Exception <span class="hljs-keyword">as</span> e:<br>        <span class="hljs-keyword">return</span> <span class="hljs-string">f&quot;网站访问失败: <span class="hljs-subst">&#123;<span class="hljs-built_in">str</span>(e)&#125;</span>&quot;</span><br><br><span class="hljs-comment"># 2. 创建PDF生成工具</span><br><span class="hljs-meta">@tool</span><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">generate_pdf</span>(<span class="hljs-params">content: <span class="hljs-built_in">str</span></span>) -&gt; <span class="hljs-built_in">str</span>:<br>    <span class="hljs-string">&quot;&quot;&quot;将文本内容生成为PDF文件&quot;&quot;&quot;</span><br>    <span class="hljs-keyword">try</span>:<br>        <span class="hljs-comment"># 生成文件名（带时间戳）</span><br>        timestamp = datetime.now().strftime(<span class="hljs-string">&quot;%Y%m%d_%H%M%S&quot;</span>)<br>        filename = <span class="hljs-string">f&quot;website_summary_<span class="hljs-subst">&#123;timestamp&#125;</span>.pdf&quot;</span><br><br>        <span class="hljs-comment"># 创建PDF文档</span><br>        doc = SimpleDocTemplate(filename, pagesize=A4)<br>        styles = getSampleStyleSheet()<br><br>        <span class="hljs-comment"># 注册中文字体（如果系统有的话）</span><br>        <span class="hljs-keyword">try</span>:<br>            <span class="hljs-comment"># Windows 系统字体路径</span><br>            font_paths = [<br>                <span class="hljs-string">&quot;C:/Windows/Fonts/simhei.ttf&quot;</span>,  <span class="hljs-comment"># 黑体</span><br>                <span class="hljs-string">&quot;C:/Windows/Fonts/simsun.ttc&quot;</span>,  <span class="hljs-comment"># 宋体</span><br>                <span class="hljs-string">&quot;C:/Windows/Fonts/msyh.ttc&quot;</span>,  <span class="hljs-comment"># 微软雅黑</span><br>            ]<br><br>            chinese_font_registered = <span class="hljs-literal">False</span><br>            <span class="hljs-keyword">for</span> font_path <span class="hljs-keyword">in</span> font_paths:<br>                <span class="hljs-keyword">if</span> os.path.exists(font_path):<br>                    <span class="hljs-keyword">try</span>:<br>                        pdfmetrics.registerFont(TTFont(<span class="hljs-string">&#x27;ChineseFont&#x27;</span>, font_path))<br>                        chinese_font_registered = <span class="hljs-literal">True</span><br>                        <span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;✅ 成功注册中文字体: <span class="hljs-subst">&#123;font_path&#125;</span>&quot;</span>)<br>                        <span class="hljs-keyword">break</span><br>                    <span class="hljs-keyword">except</span>:<br>                        <span class="hljs-keyword">continue</span><br><br>            <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> chinese_font_registered:<br>                <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;⚠️ 未找到中文字体，使用默认字体&quot;</span>)<br><br>        <span class="hljs-keyword">except</span> Exception <span class="hljs-keyword">as</span> e:<br>            <span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;⚠️ 字体注册失败: <span class="hljs-subst">&#123;e&#125;</span>&quot;</span>)<br><br>        <span class="hljs-comment"># 自定义样式 - 支持中文</span><br>        title_style = ParagraphStyle(<br>            <span class="hljs-string">&#x27;CustomTitle&#x27;</span>,<br>            parent=styles[<span class="hljs-string">&#x27;Heading1&#x27;</span>],<br>            fontSize=<span class="hljs-number">18</span>,<br>            alignment=TA_CENTER,<br>            spaceAfter=<span class="hljs-number">30</span>,<br>            fontName=<span class="hljs-string">&#x27;ChineseFont&#x27;</span> <span class="hljs-keyword">if</span> <span class="hljs-string">&#x27;chinese_font_registered&#x27;</span> <span class="hljs-keyword">in</span> <span class="hljs-built_in">locals</span>() <span class="hljs-keyword">and</span> chinese_font_registered <span class="hljs-keyword">else</span> <span class="hljs-string">&#x27;Helvetica-Bold&#x27;</span><br>        )<br><br>        content_style = ParagraphStyle(<br>            <span class="hljs-string">&#x27;CustomContent&#x27;</span>,<br>            parent=styles[<span class="hljs-string">&#x27;Normal&#x27;</span>],<br>            fontSize=<span class="hljs-number">11</span>,<br>            alignment=TA_JUSTIFY,<br>            leftIndent=<span class="hljs-number">20</span>,<br>            rightIndent=<span class="hljs-number">20</span>,<br>            spaceAfter=<span class="hljs-number">12</span>,<br>            fontName=<span class="hljs-string">&#x27;ChineseFont&#x27;</span> <span class="hljs-keyword">if</span> <span class="hljs-string">&#x27;chinese_font_registered&#x27;</span> <span class="hljs-keyword">in</span> <span class="hljs-built_in">locals</span>() <span class="hljs-keyword">and</span> chinese_font_registered <span class="hljs-keyword">else</span> <span class="hljs-string">&#x27;Helvetica&#x27;</span><br>        )<br><br>        <span class="hljs-comment"># 构建PDF内容</span><br>        story = []<br><br>        <span class="hljs-comment"># 标题</span><br>        story.append(Paragraph(<span class="hljs-string">&quot;网站内容总结报告&quot;</span>, title_style))<br>        story.append(Spacer(<span class="hljs-number">1</span>, <span class="hljs-number">20</span>))<br><br>        <span class="hljs-comment"># 生成时间</span><br>        time_text = <span class="hljs-string">f&quot;生成时间: <span class="hljs-subst">&#123;datetime.now().strftime(<span class="hljs-string">&#x27;%Y-%m-%d %H:%M:%S&#x27;</span>)&#125;</span>&quot;</span><br>        story.append(Paragraph(time_text, styles[<span class="hljs-string">&#x27;Normal&#x27;</span>]))<br>        story.append(Spacer(<span class="hljs-number">1</span>, <span class="hljs-number">20</span>))<br><br>        <span class="hljs-comment"># 分隔线</span><br>        story.append(Paragraph(<span class="hljs-string">&quot;=&quot;</span> * <span class="hljs-number">50</span>, styles[<span class="hljs-string">&#x27;Normal&#x27;</span>]))<br>        story.append(Spacer(<span class="hljs-number">1</span>, <span class="hljs-number">15</span>))<br><br>        <span class="hljs-comment"># 主要内容 - 改进中文处理</span><br>        <span class="hljs-keyword">if</span> content:<br>            <span class="hljs-comment"># 清理和处理内容</span><br>            content = content.replace(<span class="hljs-string">&#x27;\r\n&#x27;</span>, <span class="hljs-string">&#x27;\n&#x27;</span>).replace(<span class="hljs-string">&#x27;\r&#x27;</span>, <span class="hljs-string">&#x27;\n&#x27;</span>)<br>            paragraphs = content.split(<span class="hljs-string">&#x27;\n&#x27;</span>)<br><br>            <span class="hljs-keyword">for</span> para <span class="hljs-keyword">in</span> paragraphs:<br>                <span class="hljs-keyword">if</span> para.strip():<br>                    <span class="hljs-comment"># 处理特殊字符，确保PDF可以正确显示</span><br>                    clean_para = para.strip()<br>                    <span class="hljs-comment"># 转换HTML实体</span><br>                    clean_para = clean_para.replace(<span class="hljs-string">&#x27;&amp;lt;&#x27;</span>, <span class="hljs-string">&#x27;&lt;&#x27;</span>).replace(<span class="hljs-string">&#x27;&amp;gt;&#x27;</span>, <span class="hljs-string">&#x27;&gt;&#x27;</span>).replace(<span class="hljs-string">&#x27;&amp;amp;&#x27;</span>, <span class="hljs-string">&#x27;&amp;&#x27;</span>)<br><br>                    <span class="hljs-keyword">try</span>:<br>                        story.append(Paragraph(clean_para, content_style))<br>                        story.append(Spacer(<span class="hljs-number">1</span>, <span class="hljs-number">8</span>))<br>                    <span class="hljs-keyword">except</span> Exception <span class="hljs-keyword">as</span> para_error:<br>                        <span class="hljs-comment"># 如果段落有问题，尝试用默认字体</span><br>                        <span class="hljs-keyword">try</span>:<br>                            fallback_style = ParagraphStyle(<br>                                <span class="hljs-string">&#x27;Fallback&#x27;</span>,<br>                                parent=styles[<span class="hljs-string">&#x27;Normal&#x27;</span>],<br>                                fontSize=<span class="hljs-number">10</span>,<br>                                leftIndent=<span class="hljs-number">20</span>,<br>                                rightIndent=<span class="hljs-number">20</span>,<br>                                spaceAfter=<span class="hljs-number">10</span><br>                            )<br>                            story.append(Paragraph(clean_para, fallback_style))<br>                            story.append(Spacer(<span class="hljs-number">1</span>, <span class="hljs-number">8</span>))<br>                        <span class="hljs-keyword">except</span>:<br>                            <span class="hljs-comment"># 如果还是有问题，记录错误但继续</span><br>                            <span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;⚠️ 段落处理失败: <span class="hljs-subst">&#123;clean_para[:<span class="hljs-number">50</span>]&#125;</span>...&quot;</span>)<br>                            <span class="hljs-keyword">continue</span><br>        <span class="hljs-keyword">else</span>:<br>            story.append(Paragraph(<span class="hljs-string">&quot;暂无内容&quot;</span>, content_style))<br><br>        <span class="hljs-comment"># 页脚信息</span><br>        story.append(Spacer(<span class="hljs-number">1</span>, <span class="hljs-number">30</span>))<br>        story.append(Paragraph(<span class="hljs-string">&quot;=&quot;</span> * <span class="hljs-number">50</span>, styles[<span class="hljs-string">&#x27;Normal&#x27;</span>]))<br>        story.append(Paragraph(<span class="hljs-string">&quot;本报告由 Playwright PDF Agent 自动生成&quot;</span>, styles[<span class="hljs-string">&#x27;Italic&#x27;</span>]))<br><br>        <span class="hljs-comment"># 生成PDF</span><br>        doc.build(story)<br><br>        <span class="hljs-comment"># 获取绝对路径</span><br>        abs_path = os.path.abspath(filename)<br>        <span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;📄 PDF文件生成完成: <span class="hljs-subst">&#123;abs_path&#125;</span>&quot;</span>)<br>        <span class="hljs-keyword">return</span> <span class="hljs-string">f&quot;PDF文件已成功生成: <span class="hljs-subst">&#123;abs_path&#125;</span>&quot;</span><br><br>    <span class="hljs-keyword">except</span> Exception <span class="hljs-keyword">as</span> e:<br>        error_msg = <span class="hljs-string">f&quot;PDF生成失败: <span class="hljs-subst">&#123;<span class="hljs-built_in">str</span>(e)&#125;</span>&quot;</span><br>        <span class="hljs-built_in">print</span>(error_msg)<br>        <span class="hljs-keyword">return</span> error_msg<br><br><span class="hljs-comment"># 3. 创建串行链</span><br><span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;=== 创建串行链：网站总结 → PDF生成 ===&quot;</span>)<br><br><span class="hljs-comment"># 方法1：简单串行链</span><br>simple_chain = summarize_website | generate_pdf<br><br><span class="hljs-comment"># 方法2：带LLM优化的串行链</span><br>optimization_prompt = ChatPromptTemplate.from_template(<br>    <span class="hljs-string">&quot;&quot;&quot;请优化以下网站总结内容，使其更适合PDF报告格式：</span><br><span class="hljs-string"></span><br><span class="hljs-string">    原始总结：</span><br><span class="hljs-string">    &#123;summary&#125;</span><br><span class="hljs-string">    </span><br><span class="hljs-string">    请重新组织内容，包括：</span><br><span class="hljs-string">    1. 清晰的标题和结构</span><br><span class="hljs-string">    2. 要点总结</span><br><span class="hljs-string">    3. 详细说明</span><br><span class="hljs-string">    4. 使用要求等</span><br><span class="hljs-string">    </span><br><span class="hljs-string">    优化后的内容：&quot;&quot;&quot;</span><br>)<br><br>model = init_chat_model(<span class="hljs-string">&quot;deepseek-chat&quot;</span>, model_provider=<span class="hljs-string">&quot;deepseek&quot;</span>)<br><br><span class="hljs-comment"># 带优化的串行链：网站总结 → LLM优化 → PDF生成</span><br>optimized_chain = (<br>        summarize_website<br>        | (<span class="hljs-keyword">lambda</span> summary: &#123;<span class="hljs-string">&quot;summary&quot;</span>: summary&#125;)<br>        | optimization_prompt<br>        | model<br>        | StrOutputParser()<br>        | generate_pdf<br>)<br><br><span class="hljs-comment"># 4. 测试函数</span><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">test_simple_chain</span>(<span class="hljs-params">url: <span class="hljs-built_in">str</span></span>):<br>    <span class="hljs-string">&quot;&quot;&quot;测试简单串行链&quot;&quot;&quot;</span><br>    <span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;\n🔄 开始处理URL: <span class="hljs-subst">&#123;url&#125;</span>&quot;</span>)<br>    <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;📝 步骤1: 网站总结...&quot;</span>)<br>    <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;📄 步骤2: 生成PDF...&quot;</span>)<br><br>    result = simple_chain.invoke(url)<br>    <span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;✅ 完成: <span class="hljs-subst">&#123;result&#125;</span>&quot;</span>)<br>    <span class="hljs-keyword">return</span> result<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">test_optimized_chain</span>(<span class="hljs-params">url: <span class="hljs-built_in">str</span></span>):<br>    <span class="hljs-string">&quot;&quot;&quot;测试优化串行链&quot;&quot;&quot;</span><br>    <span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;\n🔄 开始处理URL (优化版): <span class="hljs-subst">&#123;url&#125;</span>&quot;</span>)<br>    <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;📝 步骤1: 网站总结...&quot;</span>)<br>    <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;🎨 步骤2: 内容优化...&quot;</span>)<br>    <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;📄 步骤3: 生成PDF...&quot;</span>)<br><br>    result = optimized_chain.invoke(url)<br>    <span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;✅ 完成: <span class="hljs-subst">&#123;result&#125;</span>&quot;</span>)<br>    <span class="hljs-keyword">return</span> result<br><br><span class="hljs-comment"># 5. 创建交互式函数</span><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">create_website_pdf_report</span>(<span class="hljs-params">url: <span class="hljs-built_in">str</span>, use_optimization: <span class="hljs-built_in">bool</span> = <span class="hljs-literal">True</span></span>):<br>    <span class="hljs-string">&quot;&quot;&quot;创建网站PDF报告的主函数&quot;&quot;&quot;</span><br>    <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;=&quot;</span> * <span class="hljs-number">60</span>)<br>    <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;🤖 网站内容PDF生成器&quot;</span>)<br>    <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;=&quot;</span> * <span class="hljs-number">60</span>)<br><br>    <span class="hljs-keyword">try</span>:<br>        <span class="hljs-keyword">if</span> use_optimization:<br>            result = test_optimized_chain(url)<br>        <span class="hljs-keyword">else</span>:<br>            result = test_simple_chain(url)<br><br>        <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;\n&quot;</span> + <span class="hljs-string">&quot;=&quot;</span> * <span class="hljs-number">60</span>)<br>        <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;🎉 任务完成！&quot;</span>)<br>        <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;=&quot;</span> * <span class="hljs-number">60</span>)<br>        <span class="hljs-keyword">return</span> result<br><br>    <span class="hljs-keyword">except</span> Exception <span class="hljs-keyword">as</span> e:<br>        error_msg = <span class="hljs-string">f&quot;❌ 处理失败: <span class="hljs-subst">&#123;<span class="hljs-built_in">str</span>(e)&#125;</span>&quot;</span><br>        <span class="hljs-built_in">print</span>(error_msg)<br>        <span class="hljs-keyword">return</span> error_msg<br><br><span class="hljs-comment"># 6. 主程序入口</span><br><span class="hljs-keyword">if</span> __name__ == <span class="hljs-string">&quot;__main__&quot;</span>:<br>    <span class="hljs-comment"># 测试URL</span><br>    test_url = <span class="hljs-string">&quot;https://blogroll.naosi.org/&quot;</span><br><br>    <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;选择处理方式:&quot;</span>)<br>    <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;1. 简单串行链（直接总结 → PDF）&quot;</span>)<br>    <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;2. 优化串行链（总结 → 优化 → PDF）&quot;</span>)<br><br>    choice = <span class="hljs-built_in">input</span>(<span class="hljs-string">&quot;请选择 (1/2): &quot;</span>).strip()<br><br>    <span class="hljs-keyword">if</span> choice == <span class="hljs-string">&quot;1&quot;</span>:<br>        create_website_pdf_report(test_url, use_optimization=<span class="hljs-literal">False</span>)<br>    <span class="hljs-keyword">elif</span> choice == <span class="hljs-string">&quot;2&quot;</span>:<br>        create_website_pdf_report(test_url, use_optimization=<span class="hljs-literal">True</span>)<br>    <span class="hljs-keyword">else</span>:<br>        <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;使用默认优化模式...&quot;</span>)<br>        create_website_pdf_report(test_url, use_optimization=<span class="hljs-literal">True</span>)<br></code></pre></td></tr></table></figure>

<p>这里仅做演示参考，实际生成效果不佳，如需使用后续还需要更精细的调整</p>
<h1 id="六、LangChain-接入-MCP-技术实现流程"><a href="#六、LangChain-接入-MCP-技术实现流程" class="headerlink" title="六、LangChain 接入 MCP 技术实现流程"></a>六、<strong>LangChain 接入 MCP 技术实现流程</strong></h1><p><code>MCP</code>，全称是<code>Model Context Protocol</code>，模型上下文协议，由<code>Claude</code>母公司<code>Anthropic</code>于去年11月正式提出。</p>
<p><a target="_blank" rel="noopener" href="https://www.anthropic.com/news/model-context-protocol"><code>Anthropic MCP</code>发布通告</a></p>
<p><a target="_blank" rel="noopener" href="https://github.com/modelcontextprotocol"><code>MCP GitHub</code>主页</a></p>
<p><code>MCP</code>的核心作用，是统一了<code>Agent</code>开发过程中，大模型调用外部工具的技术实现流程，从而大幅提高<code>Agent</code>开发效率。在<code>MCP</code>诞生之前，不同的外部工具各有不同的调用方法，要连接这些外部工具开发<code>Agent</code>，就必须“每一把锁单独配一把钥匙”，开发工作非常繁琐。</p>
<p class='item-img' data-src='/images/34.png'><img src="/images/34.png"></p>
<p>而<code>MCP</code>的诞生，则统一了这些外部工具的调用流程，使得无论什么样的工具，都可以借助<code>MCP</code>技术按照统一的一个流程快速接入到大模型中，从而大幅加快<code>Agent</code>开发效率。这就好比现在很多设备都可以使用<code>type-c</code>和电脑连接类似。</p>
<p class='item-img' data-src='/images/35.png'><img src="/images/35.png"></p>
<p>从技术实现角度来看，我们可以将<code>MCP</code>看成是<code>Function calling</code>的一种封装，通过<code>server-client</code>架构和一整套开发工具，来规范化<code>Function calling</code>开发流程。</p>
<p class='item-img' data-src='/images/36.png'><img src="/images/36.png"></p>
<p>首先来介绍一下<strong>MCP基础实现流程</strong></p>
<p><code>langchain-mcp-adapters</code> 项目主要为<code>LangChain</code>和<code>LangGraph</code>提供<code>MCP</code>的接入和兼容接口，其工作流程主要如下图所示：</p>
<p class='item-img' data-src='/images/37.png'><img src="/images/37.png"></p>
<p>实际上<code>load_mcp_tools()</code> 返回的是标准的 <code>LangChain</code> 工具，所以是完全可以直接在<code>LangChain</code>环境中进行使用的。同时，完全支持<code>stdio</code>、<code>Http SSE</code>和<code>Streamable HTTP</code>三种不同的通讯协议。</p>
<p>一个极简的天气查询<code>MCP</code>调用流程如下：</p>
<p class='item-img' data-src='/images/38.png'><img src="/images/38.png"></p>
<p>接下来，我们先尝试手动实现一遍<code>MCP</code>实践流程，然后再考虑将已经部署好的<code>server</code>代入其中，作为<code>tools</code>进行调用。</p>
<p><strong>首先借助<code>uv</code>创建<code>MCP</code>运行环境</strong></p>
<p>方法 1：使用 <code>pip</code> 安装（适用于已安装 <code>pip</code> 的系统）</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">pip install uv<br></code></pre></td></tr></table></figure>

<p>方法 2：使用 <code>curl</code> 直接安装</p>
<p>如果你的系统没有 <code>pip</code>，可以直接运行：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">curl -LsSf https://astral.sh/uv/install.sh | sh<br></code></pre></td></tr></table></figure>

<p>这会自动下载 <code>uv</code> 并安装到 <code>/usr/local/bin</code>。</p>
<p><strong>接着创建 <code>MCP</code> 客户端项目</strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment"># 创建项目目录</span><br>uv init mcp-client<br><br><span class="hljs-comment"># 进入项目目录</span><br><span class="hljs-built_in">cd</span> mcp-client<br></code></pre></td></tr></table></figure>

<p><strong>接着创建<code>MCP</code>客户端虚拟环境</strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment"># 创建虚拟环境</span><br>uv venv<br><br><span class="hljs-comment"># 激活虚拟环境</span><br><span class="hljs-comment"># Linux/macOS环境</span><br><span class="hljs-built_in">source</span> .venv/bin/activate<br><span class="hljs-comment"># Windows环境</span><br>.\.venv\Scripts\Activate.ps1<br><span class="hljs-comment"># .\.venv\Scripts\activate.bat</span><br></code></pre></td></tr></table></figure>

<p>然后即可通过<code>add</code>方法在虚拟环境中安装相关的库。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment"># 安装 MCP SDK</span><br>uv add mcp openai python-dotenv httpx<br></code></pre></td></tr></table></figure>

<p><strong>接着编写用于天气查询的server服务器代码：</strong></p>
<p>这里我们需要在服务器上创建一个<code>weather_server.py</code>，并写入如下代码：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">import</span> json<br><span class="hljs-keyword">import</span> httpx<br><span class="hljs-keyword">from</span> typing <span class="hljs-keyword">import</span> <span class="hljs-type">Any</span><br><span class="hljs-keyword">from</span> mcp.server.fastmcp <span class="hljs-keyword">import</span> FastMCP<br><br><span class="hljs-comment"># 初始化 MCP 服务器</span><br>mcp = FastMCP(<span class="hljs-string">&quot;WeatherServer&quot;</span>)<br><br><span class="hljs-comment"># OpenWeather API 配置</span><br>OPENWEATHER_API_BASE = <span class="hljs-string">&quot;https://api.openweathermap.org/data/2.5/weather&quot;</span><br>API_KEY = <span class="hljs-string">&quot;YOUR_API_KEY&quot;</span>  <span class="hljs-comment"># 请替换为你自己的 OpenWeather API Key</span><br>USER_AGENT = <span class="hljs-string">&quot;weather-app/1.0&quot;</span><br><br><span class="hljs-keyword">async</span> <span class="hljs-keyword">def</span> <span class="hljs-title function_">fetch_weather</span>(<span class="hljs-params">city: <span class="hljs-built_in">str</span></span>) -&gt; <span class="hljs-built_in">dict</span>[<span class="hljs-built_in">str</span>, <span class="hljs-type">Any</span>] | <span class="hljs-literal">None</span>:<br>    <span class="hljs-string">&quot;&quot;&quot;</span><br><span class="hljs-string">    从 OpenWeather API 获取天气信息。</span><br><span class="hljs-string">    :param city: 城市名称（需使用英文，如 Beijing）</span><br><span class="hljs-string">    :return: 天气数据字典；若出错返回包含 error 信息的字典</span><br><span class="hljs-string">    &quot;&quot;&quot;</span><br>    params = &#123;<br>        <span class="hljs-string">&quot;q&quot;</span>: city,<br>        <span class="hljs-string">&quot;appid&quot;</span>: API_KEY,<br>        <span class="hljs-string">&quot;units&quot;</span>: <span class="hljs-string">&quot;metric&quot;</span>,<br>        <span class="hljs-string">&quot;lang&quot;</span>: <span class="hljs-string">&quot;zh_cn&quot;</span><br>    &#125;<br>    headers = &#123;<span class="hljs-string">&quot;User-Agent&quot;</span>: USER_AGENT&#125;<br><br>    <span class="hljs-keyword">async</span> <span class="hljs-keyword">with</span> httpx.AsyncClient() <span class="hljs-keyword">as</span> client:<br>        <span class="hljs-keyword">try</span>:<br>            response = <span class="hljs-keyword">await</span> client.get(OPENWEATHER_API_BASE, params=params, headers=headers, timeout=<span class="hljs-number">30.0</span>)<br>            response.raise_for_status()<br>            <span class="hljs-keyword">return</span> response.json()  <span class="hljs-comment"># 返回字典类型</span><br>        <span class="hljs-keyword">except</span> httpx.HTTPStatusError <span class="hljs-keyword">as</span> e:<br>            <span class="hljs-keyword">return</span> &#123;<span class="hljs-string">&quot;error&quot;</span>: <span class="hljs-string">f&quot;HTTP 错误: <span class="hljs-subst">&#123;e.response.status_code&#125;</span>&quot;</span>&#125;<br>        <span class="hljs-keyword">except</span> Exception <span class="hljs-keyword">as</span> e:<br>            <span class="hljs-keyword">return</span> &#123;<span class="hljs-string">&quot;error&quot;</span>: <span class="hljs-string">f&quot;请求失败: <span class="hljs-subst">&#123;<span class="hljs-built_in">str</span>(e)&#125;</span>&quot;</span>&#125;<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">format_weather</span>(<span class="hljs-params">data: <span class="hljs-built_in">dict</span>[<span class="hljs-built_in">str</span>, <span class="hljs-type">Any</span>] | <span class="hljs-built_in">str</span></span>) -&gt; <span class="hljs-built_in">str</span>:<br>    <span class="hljs-string">&quot;&quot;&quot;</span><br><span class="hljs-string">    将天气数据格式化为易读文本。</span><br><span class="hljs-string">    :param data: 天气数据（可以是字典或 JSON 字符串）</span><br><span class="hljs-string">    :return: 格式化后的天气信息字符串</span><br><span class="hljs-string">    &quot;&quot;&quot;</span><br>    <span class="hljs-comment"># 如果传入的是字符串，则先转换为字典</span><br>    <span class="hljs-keyword">if</span> <span class="hljs-built_in">isinstance</span>(data, <span class="hljs-built_in">str</span>):<br>        <span class="hljs-keyword">try</span>:<br>            data = json.loads(data)<br>        <span class="hljs-keyword">except</span> Exception <span class="hljs-keyword">as</span> e:<br>            <span class="hljs-keyword">return</span> <span class="hljs-string">f&quot;无法解析天气数据: <span class="hljs-subst">&#123;e&#125;</span>&quot;</span><br><br>    <span class="hljs-comment"># 如果数据中包含错误信息，直接返回错误提示</span><br>    <span class="hljs-keyword">if</span> <span class="hljs-string">&quot;error&quot;</span> <span class="hljs-keyword">in</span> data:<br>        <span class="hljs-keyword">return</span> <span class="hljs-string">f&quot;⚠️ <span class="hljs-subst">&#123;data[<span class="hljs-string">&#x27;error&#x27;</span>]&#125;</span>&quot;</span><br><br>    <span class="hljs-comment"># 提取数据时做容错处理</span><br>    city = data.get(<span class="hljs-string">&quot;name&quot;</span>, <span class="hljs-string">&quot;未知&quot;</span>)<br>    country = data.get(<span class="hljs-string">&quot;sys&quot;</span>, &#123;&#125;).get(<span class="hljs-string">&quot;country&quot;</span>, <span class="hljs-string">&quot;未知&quot;</span>)<br>    temp = data.get(<span class="hljs-string">&quot;main&quot;</span>, &#123;&#125;).get(<span class="hljs-string">&quot;temp&quot;</span>, <span class="hljs-string">&quot;N/A&quot;</span>)<br>    humidity = data.get(<span class="hljs-string">&quot;main&quot;</span>, &#123;&#125;).get(<span class="hljs-string">&quot;humidity&quot;</span>, <span class="hljs-string">&quot;N/A&quot;</span>)<br>    wind_speed = data.get(<span class="hljs-string">&quot;wind&quot;</span>, &#123;&#125;).get(<span class="hljs-string">&quot;speed&quot;</span>, <span class="hljs-string">&quot;N/A&quot;</span>)<br>    <span class="hljs-comment"># weather 可能为空列表，因此用 [0] 前先提供默认字典</span><br>    weather_list = data.get(<span class="hljs-string">&quot;weather&quot;</span>, [&#123;&#125;])<br>    description = weather_list[<span class="hljs-number">0</span>].get(<span class="hljs-string">&quot;description&quot;</span>, <span class="hljs-string">&quot;未知&quot;</span>)<br><br>    <span class="hljs-keyword">return</span> (<br>        <span class="hljs-string">f&quot;🌍 <span class="hljs-subst">&#123;city&#125;</span>, <span class="hljs-subst">&#123;country&#125;</span>\n&quot;</span><br>        <span class="hljs-string">f&quot;🌡 温度: <span class="hljs-subst">&#123;temp&#125;</span>°C\n&quot;</span><br>        <span class="hljs-string">f&quot;💧 湿度: <span class="hljs-subst">&#123;humidity&#125;</span>%\n&quot;</span><br>        <span class="hljs-string">f&quot;🌬 风速: <span class="hljs-subst">&#123;wind_speed&#125;</span> m/s\n&quot;</span><br>        <span class="hljs-string">f&quot;🌤 天气: <span class="hljs-subst">&#123;description&#125;</span>\n&quot;</span><br>    )<br><br><span class="hljs-meta">@mcp.tool()</span><br><span class="hljs-keyword">async</span> <span class="hljs-keyword">def</span> <span class="hljs-title function_">query_weather</span>(<span class="hljs-params">city: <span class="hljs-built_in">str</span></span>) -&gt; <span class="hljs-built_in">str</span>:<br>    <span class="hljs-string">&quot;&quot;&quot;</span><br><span class="hljs-string">    输入指定城市的英文名称，返回今日天气查询结果。</span><br><span class="hljs-string">    :param city: 城市名称（需使用英文）</span><br><span class="hljs-string">    :return: 格式化后的天气信息</span><br><span class="hljs-string">    &quot;&quot;&quot;</span><br>    data = <span class="hljs-keyword">await</span> fetch_weather(city)<br>    <span class="hljs-keyword">return</span> format_weather(data)<br><br><span class="hljs-keyword">if</span> __name__ == <span class="hljs-string">&quot;__main__&quot;</span>:<br>    <span class="hljs-comment"># 以标准 I/O 方式运行 MCP 服务器</span><br>    mcp.run(transport=<span class="hljs-string">&#x27;stdio&#x27;</span>)<br></code></pre></td></tr></table></figure>

<p>为了更好的测试多<code>MCP</code>工具调用流程，这里我们继续创建一个<code>write_server.py</code>服务器：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">import</span> json<br><span class="hljs-keyword">import</span> httpx<br><span class="hljs-keyword">from</span> typing <span class="hljs-keyword">import</span> <span class="hljs-type">Any</span><br><span class="hljs-keyword">from</span> mcp.server.fastmcp <span class="hljs-keyword">import</span> FastMCP<br><br><span class="hljs-comment"># 初始化 MCP 服务器</span><br>mcp = FastMCP(<span class="hljs-string">&quot;WriteServer&quot;</span>)<br>USER_AGENT = <span class="hljs-string">&quot;write-app/1.0&quot;</span><br><br><span class="hljs-meta">@mcp.tool()</span><br><span class="hljs-keyword">async</span> <span class="hljs-keyword">def</span> <span class="hljs-title function_">write_file</span>(<span class="hljs-params">content: <span class="hljs-built_in">str</span></span>) -&gt; <span class="hljs-built_in">str</span>:<br>    <span class="hljs-string">&quot;&quot;&quot;</span><br><span class="hljs-string">    将指定内容写入本地文件。</span><br><span class="hljs-string">    :param content: 必要参数，字符串类型，用于表示需要写入文档的具体内容。</span><br><span class="hljs-string">    :return：是否成功写入</span><br><span class="hljs-string">    &quot;&quot;&quot;</span><br>    <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;已成功写入本地文件。&quot;</span><br><br><span class="hljs-keyword">if</span> __name__ == <span class="hljs-string">&quot;__main__&quot;</span>:<br>    <span class="hljs-comment"># 以标准 I/O 方式运行 MCP 服务器</span><br>    mcp.run(transport=<span class="hljs-string">&#x27;stdio&#x27;</span>)<br></code></pre></td></tr></table></figure>

<p><strong>然后创建一个可以和server进行通信的客户端</strong></p>
<p>需要注意的是，该客户端需要包含大模型调用的基础信息。我们需要编写一个<code>client.py</code>脚本，这个脚本内容非常复杂，这里提供的是通用的<code>mcp</code>客户端脚本，还未接入<code>Langchain</code>，代码如下：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br><span class="line">360</span><br><span class="line">361</span><br><span class="line">362</span><br><span class="line">363</span><br><span class="line">364</span><br><span class="line">365</span><br><span class="line">366</span><br><span class="line">367</span><br><span class="line">368</span><br><span class="line">369</span><br><span class="line">370</span><br><span class="line">371</span><br><span class="line">372</span><br><span class="line">373</span><br><span class="line">374</span><br><span class="line">375</span><br><span class="line">376</span><br><span class="line">377</span><br><span class="line">378</span><br><span class="line">379</span><br><span class="line">380</span><br><span class="line">381</span><br><span class="line">382</span><br><span class="line">383</span><br><span class="line">384</span><br><span class="line">385</span><br><span class="line">386</span><br><span class="line">387</span><br><span class="line">388</span><br><span class="line">389</span><br><span class="line">390</span><br><span class="line">391</span><br><span class="line">392</span><br><span class="line">393</span><br><span class="line">394</span><br><span class="line">395</span><br><span class="line">396</span><br><span class="line">397</span><br><span class="line">398</span><br><span class="line">399</span><br><span class="line">400</span><br><span class="line">401</span><br><span class="line">402</span><br><span class="line">403</span><br><span class="line">404</span><br><span class="line">405</span><br><span class="line">406</span><br><span class="line">407</span><br><span class="line">408</span><br><span class="line">409</span><br><span class="line">410</span><br><span class="line">411</span><br><span class="line">412</span><br><span class="line">413</span><br><span class="line">414</span><br><span class="line">415</span><br><span class="line">416</span><br><span class="line">417</span><br><span class="line">418</span><br><span class="line">419</span><br><span class="line">420</span><br><span class="line">421</span><br><span class="line">422</span><br><span class="line">423</span><br><span class="line">424</span><br><span class="line">425</span><br><span class="line">426</span><br><span class="line">427</span><br><span class="line">428</span><br><span class="line">429</span><br><span class="line">430</span><br><span class="line">431</span><br><span class="line">432</span><br><span class="line">433</span><br><span class="line">434</span><br><span class="line">435</span><br><span class="line">436</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">import</span> asyncio<br><span class="hljs-keyword">import</span> json<br><span class="hljs-keyword">import</span> logging<br><span class="hljs-keyword">import</span> os<br><span class="hljs-keyword">import</span> shutil<br><span class="hljs-keyword">from</span> contextlib <span class="hljs-keyword">import</span> AsyncExitStack<br><span class="hljs-keyword">from</span> typing <span class="hljs-keyword">import</span> <span class="hljs-type">Any</span>, <span class="hljs-type">Dict</span>, <span class="hljs-type">List</span>, <span class="hljs-type">Optional</span><br><br><span class="hljs-keyword">import</span> httpx<br><span class="hljs-keyword">from</span> dotenv <span class="hljs-keyword">import</span> load_dotenv<br><span class="hljs-keyword">from</span> openai <span class="hljs-keyword">import</span> OpenAI  <span class="hljs-comment"># OpenAI Python SDK</span><br><span class="hljs-keyword">from</span> mcp <span class="hljs-keyword">import</span> ClientSession, StdioServerParameters<br><span class="hljs-keyword">from</span> mcp.client.stdio <span class="hljs-keyword">import</span> stdio_client<br><br><span class="hljs-comment"># Configure logging</span><br>logging.basicConfig(<br>    level=logging.INFO, <span class="hljs-built_in">format</span>=<span class="hljs-string">&quot;%(asctime)s - %(levelname)s - %(message)s&quot;</span><br>)<br><br><br><span class="hljs-comment"># =============================</span><br><span class="hljs-comment"># 配置加载类（支持环境变量及配置文件）</span><br><span class="hljs-comment"># =============================</span><br><span class="hljs-keyword">class</span> <span class="hljs-title class_">Configuration</span>:<br>    <span class="hljs-string">&quot;&quot;&quot;管理 MCP 客户端的环境变量和配置文件&quot;&quot;&quot;</span><br><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__init__</span>(<span class="hljs-params">self</span>) -&gt; <span class="hljs-literal">None</span>:<br>        load_dotenv()<br>        <span class="hljs-comment"># 从环境变量中加载 API key, base_url 和 model</span><br>        <span class="hljs-variable language_">self</span>.api_key = os.getenv(<span class="hljs-string">&quot;LLM_API_KEY&quot;</span>)<br>        <span class="hljs-variable language_">self</span>.base_url = os.getenv(<span class="hljs-string">&quot;BASE_URL&quot;</span>)<br>        <span class="hljs-variable language_">self</span>.model = os.getenv(<span class="hljs-string">&quot;MODEL&quot;</span>)<br>        <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> <span class="hljs-variable language_">self</span>.api_key:<br>            <span class="hljs-keyword">raise</span> ValueError(<span class="hljs-string">&quot;❌ 未找到 LLM_API_KEY，请在 .env 文件中配置&quot;</span>)<br><br><span class="hljs-meta">    @staticmethod</span><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">load_config</span>(<span class="hljs-params">file_path: <span class="hljs-built_in">str</span></span>) -&gt; <span class="hljs-type">Dict</span>[<span class="hljs-built_in">str</span>, <span class="hljs-type">Any</span>]:<br>        <span class="hljs-string">&quot;&quot;&quot;</span><br><span class="hljs-string">        从 JSON 文件加载服务器配置</span><br><span class="hljs-string">        </span><br><span class="hljs-string">        Args:</span><br><span class="hljs-string">            file_path: JSON 配置文件路径</span><br><span class="hljs-string">        </span><br><span class="hljs-string">        Returns:</span><br><span class="hljs-string">            包含服务器配置的字典</span><br><span class="hljs-string">        &quot;&quot;&quot;</span><br>        <span class="hljs-keyword">with</span> <span class="hljs-built_in">open</span>(file_path, <span class="hljs-string">&quot;r&quot;</span>) <span class="hljs-keyword">as</span> f:<br>            <span class="hljs-keyword">return</span> json.load(f)<br><br><br><span class="hljs-comment"># =============================</span><br><span class="hljs-comment"># MCP 服务器客户端类</span><br><span class="hljs-comment"># =============================</span><br><span class="hljs-keyword">class</span> <span class="hljs-title class_">Server</span>:<br>    <span class="hljs-string">&quot;&quot;&quot;管理单个 MCP 服务器连接和工具调用&quot;&quot;&quot;</span><br><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__init__</span>(<span class="hljs-params">self, name: <span class="hljs-built_in">str</span>, config: <span class="hljs-type">Dict</span>[<span class="hljs-built_in">str</span>, <span class="hljs-type">Any</span>]</span>) -&gt; <span class="hljs-literal">None</span>:<br>        <span class="hljs-variable language_">self</span>.name: <span class="hljs-built_in">str</span> = name<br>        <span class="hljs-variable language_">self</span>.config: <span class="hljs-type">Dict</span>[<span class="hljs-built_in">str</span>, <span class="hljs-type">Any</span>] = config<br>        <span class="hljs-variable language_">self</span>.session: <span class="hljs-type">Optional</span>[ClientSession] = <span class="hljs-literal">None</span><br>        <span class="hljs-variable language_">self</span>.exit_stack: AsyncExitStack = AsyncExitStack()<br>        <span class="hljs-variable language_">self</span>._cleanup_lock = asyncio.Lock()<br><br>    <span class="hljs-keyword">async</span> <span class="hljs-keyword">def</span> <span class="hljs-title function_">initialize</span>(<span class="hljs-params">self</span>) -&gt; <span class="hljs-literal">None</span>:<br>        <span class="hljs-string">&quot;&quot;&quot;初始化与 MCP 服务器的连接&quot;&quot;&quot;</span><br>        <span class="hljs-comment"># command 字段直接从配置获取</span><br>        command = <span class="hljs-variable language_">self</span>.config[<span class="hljs-string">&quot;command&quot;</span>]<br>        <span class="hljs-keyword">if</span> command <span class="hljs-keyword">is</span> <span class="hljs-literal">None</span>:<br>            <span class="hljs-keyword">raise</span> ValueError(<span class="hljs-string">&quot;command 不能为空&quot;</span>)<br><br>        server_params = StdioServerParameters(<br>            command=command,<br>            args=<span class="hljs-variable language_">self</span>.config[<span class="hljs-string">&quot;args&quot;</span>],<br>            env=&#123;**os.environ, **<span class="hljs-variable language_">self</span>.config[<span class="hljs-string">&quot;env&quot;</span>]&#125; <span class="hljs-keyword">if</span> <span class="hljs-variable language_">self</span>.config.get(<span class="hljs-string">&quot;env&quot;</span>) <span class="hljs-keyword">else</span> <span class="hljs-literal">None</span>,<br>        )<br>        <span class="hljs-keyword">try</span>:<br>            stdio_transport = <span class="hljs-keyword">await</span> <span class="hljs-variable language_">self</span>.exit_stack.enter_async_context(<br>                stdio_client(server_params)<br>            )<br>            read_stream, write_stream = stdio_transport<br>            session = <span class="hljs-keyword">await</span> <span class="hljs-variable language_">self</span>.exit_stack.enter_async_context(<br>                ClientSession(read_stream, write_stream)<br>            )<br>            <span class="hljs-keyword">await</span> session.initialize()<br>            <span class="hljs-variable language_">self</span>.session = session<br>        <span class="hljs-keyword">except</span> Exception <span class="hljs-keyword">as</span> e:<br>            logging.error(<span class="hljs-string">f&quot;Error initializing server <span class="hljs-subst">&#123;self.name&#125;</span>: <span class="hljs-subst">&#123;e&#125;</span>&quot;</span>)<br>            <span class="hljs-keyword">await</span> <span class="hljs-variable language_">self</span>.cleanup()<br>            <span class="hljs-keyword">raise</span><br><br>    <span class="hljs-keyword">async</span> <span class="hljs-keyword">def</span> <span class="hljs-title function_">list_tools</span>(<span class="hljs-params">self</span>) -&gt; <span class="hljs-type">List</span>[<span class="hljs-type">Any</span>]:<br>        <span class="hljs-string">&quot;&quot;&quot;获取服务器可用的工具列表</span><br><span class="hljs-string"></span><br><span class="hljs-string">        Returns:</span><br><span class="hljs-string">            工具列表</span><br><span class="hljs-string">        &quot;&quot;&quot;</span><br>        <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> <span class="hljs-variable language_">self</span>.session:<br>            <span class="hljs-keyword">raise</span> RuntimeError(<span class="hljs-string">f&quot;Server <span class="hljs-subst">&#123;self.name&#125;</span> not initialized&quot;</span>)<br>        tools_response = <span class="hljs-keyword">await</span> <span class="hljs-variable language_">self</span>.session.list_tools()<br>        tools = []<br>        <span class="hljs-keyword">for</span> item <span class="hljs-keyword">in</span> tools_response:<br>            <span class="hljs-keyword">if</span> <span class="hljs-built_in">isinstance</span>(item, <span class="hljs-built_in">tuple</span>) <span class="hljs-keyword">and</span> item[<span class="hljs-number">0</span>] == <span class="hljs-string">&quot;tools&quot;</span>:<br>                <span class="hljs-keyword">for</span> tool <span class="hljs-keyword">in</span> item[<span class="hljs-number">1</span>]:<br>                    tools.append(Tool(tool.name, tool.description, tool.inputSchema))<br>        <span class="hljs-keyword">return</span> tools<br><br>    <span class="hljs-keyword">async</span> <span class="hljs-keyword">def</span> <span class="hljs-title function_">execute_tool</span>(<span class="hljs-params"></span><br><span class="hljs-params">        self, tool_name: <span class="hljs-built_in">str</span>, arguments: <span class="hljs-type">Dict</span>[<span class="hljs-built_in">str</span>, <span class="hljs-type">Any</span>], retries: <span class="hljs-built_in">int</span> = <span class="hljs-number">2</span>, delay: <span class="hljs-built_in">float</span> = <span class="hljs-number">1.0</span></span><br><span class="hljs-params">    </span>) -&gt; <span class="hljs-type">Any</span>:<br>        <span class="hljs-string">&quot;&quot;&quot;执行指定工具，并支持重试机制</span><br><span class="hljs-string"></span><br><span class="hljs-string">        Args:</span><br><span class="hljs-string">            tool_name: 工具名称</span><br><span class="hljs-string">            arguments: 工具参数</span><br><span class="hljs-string">            retries: 重试次数</span><br><span class="hljs-string">            delay: 重试间隔秒数</span><br><span class="hljs-string"></span><br><span class="hljs-string">        Returns:</span><br><span class="hljs-string">            工具调用结果</span><br><span class="hljs-string">        &quot;&quot;&quot;</span><br>        <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> <span class="hljs-variable language_">self</span>.session:<br>            <span class="hljs-keyword">raise</span> RuntimeError(<span class="hljs-string">f&quot;Server <span class="hljs-subst">&#123;self.name&#125;</span> not initialized&quot;</span>)<br>        attempt = <span class="hljs-number">0</span><br>        <span class="hljs-keyword">while</span> attempt &lt; retries:<br>            <span class="hljs-keyword">try</span>:<br>                logging.info(<span class="hljs-string">f&quot;Executing <span class="hljs-subst">&#123;tool_name&#125;</span> on server <span class="hljs-subst">&#123;self.name&#125;</span>...&quot;</span>)<br>                result = <span class="hljs-keyword">await</span> <span class="hljs-variable language_">self</span>.session.call_tool(tool_name, arguments)<br>                <span class="hljs-keyword">return</span> result<br>            <span class="hljs-keyword">except</span> Exception <span class="hljs-keyword">as</span> e:<br>                attempt += <span class="hljs-number">1</span><br>                logging.warning(<br>                    <span class="hljs-string">f&quot;Error executing tool: <span class="hljs-subst">&#123;e&#125;</span>. Attempt <span class="hljs-subst">&#123;attempt&#125;</span> of <span class="hljs-subst">&#123;retries&#125;</span>.&quot;</span><br>                )<br>                <span class="hljs-keyword">if</span> attempt &lt; retries:<br>                    logging.info(<span class="hljs-string">f&quot;Retrying in <span class="hljs-subst">&#123;delay&#125;</span> seconds...&quot;</span>)<br>                    <span class="hljs-keyword">await</span> asyncio.sleep(delay)<br>                <span class="hljs-keyword">else</span>:<br>                    logging.error(<span class="hljs-string">&quot;Max retries reached. Failing.&quot;</span>)<br>                    <span class="hljs-keyword">raise</span><br><br>    <span class="hljs-keyword">async</span> <span class="hljs-keyword">def</span> <span class="hljs-title function_">cleanup</span>(<span class="hljs-params">self</span>) -&gt; <span class="hljs-literal">None</span>:<br>        <span class="hljs-string">&quot;&quot;&quot;清理服务器资源&quot;&quot;&quot;</span><br>        <span class="hljs-keyword">async</span> <span class="hljs-keyword">with</span> <span class="hljs-variable language_">self</span>._cleanup_lock:<br>            <span class="hljs-keyword">try</span>:<br>                <span class="hljs-keyword">await</span> <span class="hljs-variable language_">self</span>.exit_stack.aclose()<br>                <span class="hljs-variable language_">self</span>.session = <span class="hljs-literal">None</span><br>            <span class="hljs-keyword">except</span> Exception <span class="hljs-keyword">as</span> e:<br>                logging.error(<span class="hljs-string">f&quot;Error during cleanup of server <span class="hljs-subst">&#123;self.name&#125;</span>: <span class="hljs-subst">&#123;e&#125;</span>&quot;</span>)<br><br><br><span class="hljs-comment"># =============================</span><br><span class="hljs-comment"># 工具封装类</span><br><span class="hljs-comment"># =============================</span><br><span class="hljs-keyword">class</span> <span class="hljs-title class_">Tool</span>:<br>    <span class="hljs-string">&quot;&quot;&quot;封装 MCP 返回的工具信息&quot;&quot;&quot;</span><br><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__init__</span>(<span class="hljs-params">self, name: <span class="hljs-built_in">str</span>, description: <span class="hljs-built_in">str</span>, input_schema: <span class="hljs-type">Dict</span>[<span class="hljs-built_in">str</span>, <span class="hljs-type">Any</span>]</span>) -&gt; <span class="hljs-literal">None</span>:<br>        <span class="hljs-variable language_">self</span>.name: <span class="hljs-built_in">str</span> = name<br>        <span class="hljs-variable language_">self</span>.description: <span class="hljs-built_in">str</span> = description<br>        <span class="hljs-variable language_">self</span>.input_schema: <span class="hljs-type">Dict</span>[<span class="hljs-built_in">str</span>, <span class="hljs-type">Any</span>] = input_schema<br><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">format_for_llm</span>(<span class="hljs-params">self</span>) -&gt; <span class="hljs-built_in">str</span>:<br>        <span class="hljs-string">&quot;&quot;&quot;生成用于 LLM 提示的工具描述&quot;&quot;&quot;</span><br>        args_desc = []<br>        <span class="hljs-keyword">if</span> <span class="hljs-string">&quot;properties&quot;</span> <span class="hljs-keyword">in</span> <span class="hljs-variable language_">self</span>.input_schema:<br>            <span class="hljs-keyword">for</span> param_name, param_info <span class="hljs-keyword">in</span> <span class="hljs-variable language_">self</span>.input_schema[<span class="hljs-string">&quot;properties&quot;</span>].items():<br>                arg_desc = <span class="hljs-string">f&quot;- <span class="hljs-subst">&#123;param_name&#125;</span>: <span class="hljs-subst">&#123;param_info.get(<span class="hljs-string">&#x27;description&#x27;</span>, <span class="hljs-string">&#x27;No description&#x27;</span>)&#125;</span>&quot;</span><br>                <span class="hljs-keyword">if</span> param_name <span class="hljs-keyword">in</span> <span class="hljs-variable language_">self</span>.input_schema.get(<span class="hljs-string">&quot;required&quot;</span>, []):<br>                    arg_desc += <span class="hljs-string">&quot; (required)&quot;</span><br>                args_desc.append(arg_desc)<br>        <span class="hljs-keyword">return</span> <span class="hljs-string">f&quot;&quot;&quot;</span><br><span class="hljs-string">Tool: <span class="hljs-subst">&#123;self.name&#125;</span></span><br><span class="hljs-string">Description: <span class="hljs-subst">&#123;self.description&#125;</span></span><br><span class="hljs-string">Arguments:</span><br><span class="hljs-string"><span class="hljs-subst">&#123;<span class="hljs-built_in">chr</span>(<span class="hljs-number">10</span>).join(args_desc)&#125;</span></span><br><span class="hljs-string">&quot;&quot;&quot;</span><br><br><br><span class="hljs-comment"># =============================</span><br><span class="hljs-comment"># LLM 客户端封装类（使用 OpenAI SDK）</span><br><span class="hljs-comment"># =============================</span><br><span class="hljs-keyword">class</span> <span class="hljs-title class_">LLMClient</span>:<br>    <span class="hljs-string">&quot;&quot;&quot;使用 OpenAI SDK 与大模型交互&quot;&quot;&quot;</span><br><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__init__</span>(<span class="hljs-params">self, api_key: <span class="hljs-built_in">str</span>, base_url: <span class="hljs-type">Optional</span>[<span class="hljs-built_in">str</span>], model: <span class="hljs-built_in">str</span></span>) -&gt; <span class="hljs-literal">None</span>:<br>        <span class="hljs-variable language_">self</span>.client = OpenAI(api_key=api_key, base_url=base_url)<br>        <span class="hljs-variable language_">self</span>.model = model<br><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">get_response</span>(<span class="hljs-params">self, messages: <span class="hljs-type">List</span>[<span class="hljs-type">Dict</span>[<span class="hljs-built_in">str</span>, <span class="hljs-type">Any</span>]], tools: <span class="hljs-type">Optional</span>[<span class="hljs-type">List</span>[<span class="hljs-type">Dict</span>[<span class="hljs-built_in">str</span>, <span class="hljs-type">Any</span>]]] = <span class="hljs-literal">None</span></span>) -&gt; <span class="hljs-type">Any</span>:<br>        <span class="hljs-string">&quot;&quot;&quot;</span><br><span class="hljs-string">        发送消息给大模型 API，支持传入工具参数（function calling 格式）</span><br><span class="hljs-string">        &quot;&quot;&quot;</span><br>        payload = &#123;<br>            <span class="hljs-string">&quot;model&quot;</span>: <span class="hljs-variable language_">self</span>.model,<br>            <span class="hljs-string">&quot;messages&quot;</span>: messages,<br>            <span class="hljs-string">&quot;tools&quot;</span>: tools,<br>        &#125;<br>        <span class="hljs-keyword">try</span>:<br>            response = <span class="hljs-variable language_">self</span>.client.chat.completions.create(**payload)<br>            <span class="hljs-keyword">return</span> response<br>        <span class="hljs-keyword">except</span> Exception <span class="hljs-keyword">as</span> e:<br>            logging.error(<span class="hljs-string">f&quot;Error during LLM call: <span class="hljs-subst">&#123;e&#125;</span>&quot;</span>)<br>            <span class="hljs-keyword">raise</span><br><br><br><span class="hljs-comment"># =============================</span><br><span class="hljs-comment"># 多服务器 MCP 客户端类（集成配置文件、工具格式转换与 OpenAI SDK 调用）</span><br><span class="hljs-comment"># =============================</span><br><span class="hljs-keyword">class</span> <span class="hljs-title class_">MultiServerMCPClient</span>:<br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__init__</span>(<span class="hljs-params">self</span>) -&gt; <span class="hljs-literal">None</span>:<br>        <span class="hljs-string">&quot;&quot;&quot;</span><br><span class="hljs-string">        管理多个 MCP 服务器，并使用 OpenAI Function Calling 风格的接口调用大模型</span><br><span class="hljs-string">        &quot;&quot;&quot;</span><br>        <span class="hljs-variable language_">self</span>.exit_stack = AsyncExitStack()<br>        config = Configuration()<br>        <span class="hljs-variable language_">self</span>.openai_api_key = config.api_key<br>        <span class="hljs-variable language_">self</span>.base_url = config.base_url<br>        <span class="hljs-variable language_">self</span>.model = config.model<br>        <span class="hljs-variable language_">self</span>.client = LLMClient(<span class="hljs-variable language_">self</span>.openai_api_key, <span class="hljs-variable language_">self</span>.base_url, <span class="hljs-variable language_">self</span>.model)<br>        <span class="hljs-comment"># (server_name -&gt; Server 对象)</span><br>        <span class="hljs-variable language_">self</span>.servers: <span class="hljs-type">Dict</span>[<span class="hljs-built_in">str</span>, Server] = &#123;&#125;<br>        <span class="hljs-comment"># 各个 server 的工具列表</span><br>        <span class="hljs-variable language_">self</span>.tools_by_server: <span class="hljs-type">Dict</span>[<span class="hljs-built_in">str</span>, <span class="hljs-type">List</span>[<span class="hljs-type">Any</span>]] = &#123;&#125;<br>        <span class="hljs-variable language_">self</span>.all_tools: <span class="hljs-type">List</span>[<span class="hljs-type">Dict</span>[<span class="hljs-built_in">str</span>, <span class="hljs-type">Any</span>]] = []<br><br>    <span class="hljs-keyword">async</span> <span class="hljs-keyword">def</span> <span class="hljs-title function_">connect_to_servers</span>(<span class="hljs-params">self, servers_config: <span class="hljs-type">Dict</span>[<span class="hljs-built_in">str</span>, <span class="hljs-type">Any</span>]</span>) -&gt; <span class="hljs-literal">None</span>:<br>        <span class="hljs-string">&quot;&quot;&quot;</span><br><span class="hljs-string">        根据配置文件同时启动多个服务器并获取工具</span><br><span class="hljs-string">        servers_config 的格式为：</span><br><span class="hljs-string">        &#123;</span><br><span class="hljs-string">          &quot;mcpServers&quot;: &#123;</span><br><span class="hljs-string">              &quot;sqlite&quot;: &#123; &quot;command&quot;: &quot;uvx&quot;, &quot;args&quot;: [ ... ] &#125;,</span><br><span class="hljs-string">              &quot;puppeteer&quot;: &#123; &quot;command&quot;: &quot;npx&quot;, &quot;args&quot;: [ ... ] &#125;,</span><br><span class="hljs-string">              ...</span><br><span class="hljs-string">          &#125;</span><br><span class="hljs-string">        &#125;</span><br><span class="hljs-string">        &quot;&quot;&quot;</span><br>        mcp_servers = servers_config.get(<span class="hljs-string">&quot;mcpServers&quot;</span>, &#123;&#125;)<br>        <span class="hljs-keyword">for</span> server_name, srv_config <span class="hljs-keyword">in</span> mcp_servers.items():<br>            server = Server(server_name, srv_config)<br>            <span class="hljs-keyword">await</span> server.initialize()<br>            <span class="hljs-variable language_">self</span>.servers[server_name] = server<br>            tools = <span class="hljs-keyword">await</span> server.list_tools()<br>            <span class="hljs-variable language_">self</span>.tools_by_server[server_name] = tools<br><br>            <span class="hljs-keyword">for</span> tool <span class="hljs-keyword">in</span> tools:<br>                <span class="hljs-comment"># 统一重命名：serverName_toolName</span><br>                function_name = <span class="hljs-string">f&quot;<span class="hljs-subst">&#123;server_name&#125;</span>_<span class="hljs-subst">&#123;tool.name&#125;</span>&quot;</span><br>                <span class="hljs-variable language_">self</span>.all_tools.append(&#123;<br>                    <span class="hljs-string">&quot;type&quot;</span>: <span class="hljs-string">&quot;function&quot;</span>,<br>                    <span class="hljs-string">&quot;function&quot;</span>: &#123;<br>                        <span class="hljs-string">&quot;name&quot;</span>: function_name,<br>                        <span class="hljs-string">&quot;description&quot;</span>: tool.description,<br>                        <span class="hljs-string">&quot;input_schema&quot;</span>: tool.input_schema<br>                    &#125;<br>                &#125;)<br><br>        <span class="hljs-comment"># 转换为 OpenAI Function Calling 所需格式</span><br>        <span class="hljs-variable language_">self</span>.all_tools = <span class="hljs-keyword">await</span> <span class="hljs-variable language_">self</span>.transform_json(<span class="hljs-variable language_">self</span>.all_tools)<br><br>        logging.info(<span class="hljs-string">&quot;\n✅ 已连接到下列服务器:&quot;</span>)<br>        <span class="hljs-keyword">for</span> name <span class="hljs-keyword">in</span> <span class="hljs-variable language_">self</span>.servers:<br>            srv_cfg = mcp_servers[name]<br>            logging.info(<span class="hljs-string">f&quot;  - <span class="hljs-subst">&#123;name&#125;</span>: command=<span class="hljs-subst">&#123;srv_cfg[<span class="hljs-string">&#x27;command&#x27;</span>]&#125;</span>, args=<span class="hljs-subst">&#123;srv_cfg[<span class="hljs-string">&#x27;args&#x27;</span>]&#125;</span>&quot;</span>)<br>        logging.info(<span class="hljs-string">&quot;\n汇总的工具:&quot;</span>)<br>        <span class="hljs-keyword">for</span> t <span class="hljs-keyword">in</span> <span class="hljs-variable language_">self</span>.all_tools:<br>            logging.info(<span class="hljs-string">f&quot;  - <span class="hljs-subst">&#123;t[<span class="hljs-string">&#x27;function&#x27;</span>][<span class="hljs-string">&#x27;name&#x27;</span>]&#125;</span>&quot;</span>)<br><br>    <span class="hljs-keyword">async</span> <span class="hljs-keyword">def</span> <span class="hljs-title function_">transform_json</span>(<span class="hljs-params">self, json_data: <span class="hljs-type">List</span>[<span class="hljs-type">Dict</span>[<span class="hljs-built_in">str</span>, <span class="hljs-type">Any</span>]]</span>) -&gt; <span class="hljs-type">List</span>[<span class="hljs-type">Dict</span>[<span class="hljs-built_in">str</span>, <span class="hljs-type">Any</span>]]:<br>        <span class="hljs-string">&quot;&quot;&quot;</span><br><span class="hljs-string">        将工具的 input_schema 转换为 OpenAI 所需的 parameters 格式，并删除多余字段</span><br><span class="hljs-string">        &quot;&quot;&quot;</span><br>        result = []<br>        <span class="hljs-keyword">for</span> item <span class="hljs-keyword">in</span> json_data:<br>            <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> <span class="hljs-built_in">isinstance</span>(item, <span class="hljs-built_in">dict</span>) <span class="hljs-keyword">or</span> <span class="hljs-string">&quot;type&quot;</span> <span class="hljs-keyword">not</span> <span class="hljs-keyword">in</span> item <span class="hljs-keyword">or</span> <span class="hljs-string">&quot;function&quot;</span> <span class="hljs-keyword">not</span> <span class="hljs-keyword">in</span> item:<br>                <span class="hljs-keyword">continue</span><br>            old_func = item[<span class="hljs-string">&quot;function&quot;</span>]<br>            <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> <span class="hljs-built_in">isinstance</span>(old_func, <span class="hljs-built_in">dict</span>) <span class="hljs-keyword">or</span> <span class="hljs-string">&quot;name&quot;</span> <span class="hljs-keyword">not</span> <span class="hljs-keyword">in</span> old_func <span class="hljs-keyword">or</span> <span class="hljs-string">&quot;description&quot;</span> <span class="hljs-keyword">not</span> <span class="hljs-keyword">in</span> old_func:<br>                <span class="hljs-keyword">continue</span><br>            new_func = &#123;<br>                <span class="hljs-string">&quot;name&quot;</span>: old_func[<span class="hljs-string">&quot;name&quot;</span>],<br>                <span class="hljs-string">&quot;description&quot;</span>: old_func[<span class="hljs-string">&quot;description&quot;</span>],<br>                <span class="hljs-string">&quot;parameters&quot;</span>: &#123;&#125;<br>            &#125;<br>            <span class="hljs-keyword">if</span> <span class="hljs-string">&quot;input_schema&quot;</span> <span class="hljs-keyword">in</span> old_func <span class="hljs-keyword">and</span> <span class="hljs-built_in">isinstance</span>(old_func[<span class="hljs-string">&quot;input_schema&quot;</span>], <span class="hljs-built_in">dict</span>):<br>                old_schema = old_func[<span class="hljs-string">&quot;input_schema&quot;</span>]<br>                new_func[<span class="hljs-string">&quot;parameters&quot;</span>][<span class="hljs-string">&quot;type&quot;</span>] = old_schema.get(<span class="hljs-string">&quot;type&quot;</span>, <span class="hljs-string">&quot;object&quot;</span>)<br>                new_func[<span class="hljs-string">&quot;parameters&quot;</span>][<span class="hljs-string">&quot;properties&quot;</span>] = old_schema.get(<span class="hljs-string">&quot;properties&quot;</span>, &#123;&#125;)<br>                new_func[<span class="hljs-string">&quot;parameters&quot;</span>][<span class="hljs-string">&quot;required&quot;</span>] = old_schema.get(<span class="hljs-string">&quot;required&quot;</span>, [])<br>            new_item = &#123;<br>                <span class="hljs-string">&quot;type&quot;</span>: item[<span class="hljs-string">&quot;type&quot;</span>],<br>                <span class="hljs-string">&quot;function&quot;</span>: new_func<br>            &#125;<br>            result.append(new_item)<br>        <span class="hljs-keyword">return</span> result<br><br>    <span class="hljs-keyword">async</span> <span class="hljs-keyword">def</span> <span class="hljs-title function_">chat_base</span>(<span class="hljs-params">self, messages: <span class="hljs-type">List</span>[<span class="hljs-type">Dict</span>[<span class="hljs-built_in">str</span>, <span class="hljs-type">Any</span>]]</span>) -&gt; <span class="hljs-type">Any</span>:<br>        <span class="hljs-string">&quot;&quot;&quot;</span><br><span class="hljs-string">        使用 OpenAI 接口进行对话，并支持多次工具调用（Function Calling）。</span><br><span class="hljs-string">        如果返回 finish_reason 为 &quot;tool_calls&quot;，则进行工具调用后再发起请求。</span><br><span class="hljs-string">        &quot;&quot;&quot;</span><br>        response = <span class="hljs-variable language_">self</span>.client.get_response(messages, tools=<span class="hljs-variable language_">self</span>.all_tools)<br>        <span class="hljs-comment"># 如果模型返回工具调用</span><br>        <span class="hljs-keyword">if</span> response.choices[<span class="hljs-number">0</span>].finish_reason == <span class="hljs-string">&quot;tool_calls&quot;</span>:<br>            <span class="hljs-keyword">while</span> <span class="hljs-literal">True</span>:<br>                messages = <span class="hljs-keyword">await</span> <span class="hljs-variable language_">self</span>.create_function_response_messages(messages, response)<br>                response = <span class="hljs-variable language_">self</span>.client.get_response(messages, tools=<span class="hljs-variable language_">self</span>.all_tools)<br>                <span class="hljs-keyword">if</span> response.choices[<span class="hljs-number">0</span>].finish_reason != <span class="hljs-string">&quot;tool_calls&quot;</span>:<br>                    <span class="hljs-keyword">break</span><br>        <span class="hljs-keyword">return</span> response<br><br>    <span class="hljs-keyword">async</span> <span class="hljs-keyword">def</span> <span class="hljs-title function_">create_function_response_messages</span>(<span class="hljs-params">self, messages: <span class="hljs-type">List</span>[<span class="hljs-type">Dict</span>[<span class="hljs-built_in">str</span>, <span class="hljs-type">Any</span>]], response: <span class="hljs-type">Any</span></span>) -&gt; <span class="hljs-type">List</span>[<span class="hljs-type">Dict</span>[<span class="hljs-built_in">str</span>, <span class="hljs-type">Any</span>]]:<br>        <span class="hljs-string">&quot;&quot;&quot;</span><br><span class="hljs-string">        将模型返回的工具调用解析执行，并将结果追加到消息队列中</span><br><span class="hljs-string">        &quot;&quot;&quot;</span><br>        function_call_messages = response.choices[<span class="hljs-number">0</span>].message.tool_calls<br>        messages.append(response.choices[<span class="hljs-number">0</span>].message.model_dump())<br>        <span class="hljs-keyword">for</span> function_call_message <span class="hljs-keyword">in</span> function_call_messages:<br>            tool_name = function_call_message.function.name<br>            tool_args = json.loads(function_call_message.function.arguments)<br>            <span class="hljs-comment"># 调用 MCP 工具</span><br>            function_response = <span class="hljs-keyword">await</span> <span class="hljs-variable language_">self</span>._call_mcp_tool(tool_name, tool_args)<br>            <span class="hljs-comment"># 🔍 打印返回值及其类型</span><br>            <span class="hljs-comment"># print(f&quot;[DEBUG] tool_name: &#123;tool_name&#125;&quot;)</span><br>            <span class="hljs-comment"># print(f&quot;[DEBUG] tool_args: &#123;tool_args&#125;&quot;)</span><br>            <span class="hljs-comment"># print(f&quot;[DEBUG] function_response: &#123;function_response&#125;&quot;)</span><br>            <span class="hljs-comment"># print(f&quot;[DEBUG] type(function_response): &#123;type(function_response)&#125;&quot;)</span><br>            messages.append(&#123;<br>                <span class="hljs-string">&quot;role&quot;</span>: <span class="hljs-string">&quot;tool&quot;</span>,<br>                <span class="hljs-string">&quot;content&quot;</span>: function_response,<br>                <span class="hljs-string">&quot;tool_call_id&quot;</span>: function_call_message.<span class="hljs-built_in">id</span>,<br>            &#125;)<br>        <span class="hljs-keyword">return</span> messages<br><br>    <span class="hljs-keyword">async</span> <span class="hljs-keyword">def</span> <span class="hljs-title function_">process_query</span>(<span class="hljs-params">self, user_query: <span class="hljs-built_in">str</span></span>) -&gt; <span class="hljs-built_in">str</span>:<br>        <span class="hljs-string">&quot;&quot;&quot;</span><br><span class="hljs-string">        OpenAI Function Calling 流程：</span><br><span class="hljs-string">         1. 发送用户消息 + 工具信息</span><br><span class="hljs-string">         2. 若模型返回 finish_reason 为 &quot;tool_calls&quot;，则解析并调用 MCP 工具</span><br><span class="hljs-string">         3. 将工具调用结果返回给模型，获得最终回答</span><br><span class="hljs-string">        &quot;&quot;&quot;</span><br>        messages = [&#123;<span class="hljs-string">&quot;role&quot;</span>: <span class="hljs-string">&quot;user&quot;</span>, <span class="hljs-string">&quot;content&quot;</span>: user_query&#125;]<br>        response = <span class="hljs-variable language_">self</span>.client.get_response(messages, tools=<span class="hljs-variable language_">self</span>.all_tools)<br>        content = response.choices[<span class="hljs-number">0</span>]<br>        logging.info(content)<br>        <span class="hljs-keyword">if</span> content.finish_reason == <span class="hljs-string">&quot;tool_calls&quot;</span>:<br>            tool_call = content.message.tool_calls[<span class="hljs-number">0</span>]<br>            tool_name = tool_call.function.name<br>            tool_args = json.loads(tool_call.function.arguments)<br>            logging.info(<span class="hljs-string">f&quot;\n[ 调用工具: <span class="hljs-subst">&#123;tool_name&#125;</span>, 参数: <span class="hljs-subst">&#123;tool_args&#125;</span> ]\n&quot;</span>)<br>            result = <span class="hljs-keyword">await</span> <span class="hljs-variable language_">self</span>._call_mcp_tool(tool_name, tool_args)<br>            messages.append(content.message.model_dump())<br>            messages.append(&#123;<br>                <span class="hljs-string">&quot;role&quot;</span>: <span class="hljs-string">&quot;tool&quot;</span>,<br>                <span class="hljs-string">&quot;content&quot;</span>: result,<br>                <span class="hljs-string">&quot;tool_call_id&quot;</span>: tool_call.<span class="hljs-built_in">id</span>,<br>            &#125;)<br>            response = <span class="hljs-variable language_">self</span>.client.get_response(messages, tools=<span class="hljs-variable language_">self</span>.all_tools)<br>            <span class="hljs-keyword">return</span> response.choices[<span class="hljs-number">0</span>].message.content<br>        <span class="hljs-keyword">return</span> content.message.content<br><br>    <span class="hljs-keyword">async</span> <span class="hljs-keyword">def</span> <span class="hljs-title function_">_call_mcp_tool</span>(<span class="hljs-params">self, tool_full_name: <span class="hljs-built_in">str</span>, tool_args: <span class="hljs-type">Dict</span>[<span class="hljs-built_in">str</span>, <span class="hljs-type">Any</span>]</span>) -&gt; <span class="hljs-built_in">str</span>:<br>        <span class="hljs-string">&quot;&quot;&quot;</span><br><span class="hljs-string">        根据 &quot;serverName_toolName&quot; 格式调用相应 MCP 工具</span><br><span class="hljs-string">        &quot;&quot;&quot;</span><br>        parts = tool_full_name.split(<span class="hljs-string">&quot;_&quot;</span>, <span class="hljs-number">1</span>)<br>        <span class="hljs-keyword">if</span> <span class="hljs-built_in">len</span>(parts) != <span class="hljs-number">2</span>:<br>            <span class="hljs-keyword">return</span> <span class="hljs-string">f&quot;无效的工具名称: <span class="hljs-subst">&#123;tool_full_name&#125;</span>&quot;</span><br>        server_name, tool_name = parts<br>        server = <span class="hljs-variable language_">self</span>.servers.get(server_name)<br>        <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> server:<br>            <span class="hljs-keyword">return</span> <span class="hljs-string">f&quot;找不到服务器: <span class="hljs-subst">&#123;server_name&#125;</span>&quot;</span><br>        resp = <span class="hljs-keyword">await</span> server.execute_tool(tool_name, tool_args)<br>        <br>        <span class="hljs-comment"># 🛠️ 修复点：提取 TextContent 中的文本（或转成字符串）</span><br>        content = resp.content<br>        <span class="hljs-keyword">if</span> <span class="hljs-built_in">isinstance</span>(content, <span class="hljs-built_in">list</span>):<br>            <span class="hljs-comment"># 提取所有 TextContent 对象中的 text 字段</span><br>            texts = [c.text <span class="hljs-keyword">for</span> c <span class="hljs-keyword">in</span> content <span class="hljs-keyword">if</span> <span class="hljs-built_in">hasattr</span>(c, <span class="hljs-string">&quot;text&quot;</span>)]<br>            <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;\n&quot;</span>.join(texts)<br>        <span class="hljs-keyword">elif</span> <span class="hljs-built_in">isinstance</span>(content, <span class="hljs-built_in">dict</span>) <span class="hljs-keyword">or</span> <span class="hljs-built_in">isinstance</span>(content, <span class="hljs-built_in">list</span>):<br>            <span class="hljs-comment"># 如果是 dict 或 list，但不是 TextContent 类型</span><br>            <span class="hljs-keyword">return</span> json.dumps(content, ensure_ascii=<span class="hljs-literal">False</span>)<br>        <span class="hljs-keyword">elif</span> content <span class="hljs-keyword">is</span> <span class="hljs-literal">None</span>:<br>            <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;工具执行无输出&quot;</span><br>        <span class="hljs-keyword">else</span>:<br>            <span class="hljs-keyword">return</span> <span class="hljs-built_in">str</span>(content)<br><br>    <span class="hljs-keyword">async</span> <span class="hljs-keyword">def</span> <span class="hljs-title function_">chat_loop</span>(<span class="hljs-params">self</span>) -&gt; <span class="hljs-literal">None</span>:<br>        <span class="hljs-string">&quot;&quot;&quot;多服务器 MCP + OpenAI Function Calling 客户端主循环&quot;&quot;&quot;</span><br>        logging.info(<span class="hljs-string">&quot;\n🤖 多服务器 MCP + Function Calling 客户端已启动！输入 &#x27;quit&#x27; 退出。&quot;</span>)<br>        messages: <span class="hljs-type">List</span>[<span class="hljs-type">Dict</span>[<span class="hljs-built_in">str</span>, <span class="hljs-type">Any</span>]] = []<br>        <span class="hljs-keyword">while</span> <span class="hljs-literal">True</span>:<br>            query = <span class="hljs-built_in">input</span>(<span class="hljs-string">&quot;\n你: &quot;</span>).strip()<br>            <span class="hljs-keyword">if</span> query.lower() == <span class="hljs-string">&quot;quit&quot;</span>:<br>                <span class="hljs-keyword">break</span><br>            <span class="hljs-keyword">try</span>:<br>                messages.append(&#123;<span class="hljs-string">&quot;role&quot;</span>: <span class="hljs-string">&quot;user&quot;</span>, <span class="hljs-string">&quot;content&quot;</span>: query&#125;)<br>                messages = messages[-<span class="hljs-number">20</span>:]  <span class="hljs-comment"># 保持最新 20 条上下文</span><br>                response = <span class="hljs-keyword">await</span> <span class="hljs-variable language_">self</span>.chat_base(messages)<br>                messages.append(response.choices[<span class="hljs-number">0</span>].message.model_dump())<br>                result = response.choices[<span class="hljs-number">0</span>].message.content<br>                <span class="hljs-comment"># logging.info(f&quot;\nAI: &#123;result&#125;&quot;)</span><br>                <span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;\nAI: <span class="hljs-subst">&#123;result&#125;</span>&quot;</span>)<br>            <span class="hljs-keyword">except</span> Exception <span class="hljs-keyword">as</span> e:<br>                <span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;\n⚠️  调用过程出错: <span class="hljs-subst">&#123;e&#125;</span>&quot;</span>)<br><br>    <span class="hljs-keyword">async</span> <span class="hljs-keyword">def</span> <span class="hljs-title function_">cleanup</span>(<span class="hljs-params">self</span>) -&gt; <span class="hljs-literal">None</span>:<br>        <span class="hljs-string">&quot;&quot;&quot;关闭所有资源&quot;&quot;&quot;</span><br>        <span class="hljs-keyword">await</span> <span class="hljs-variable language_">self</span>.exit_stack.aclose()<br><br><br><span class="hljs-comment"># =============================</span><br><span class="hljs-comment"># 主函数</span><br><span class="hljs-comment"># =============================</span><br><span class="hljs-keyword">async</span> <span class="hljs-keyword">def</span> <span class="hljs-title function_">main</span>() -&gt; <span class="hljs-literal">None</span>:<br>    <span class="hljs-comment"># 从配置文件加载服务器配置</span><br>    config = Configuration()<br>    servers_config = config.load_config(<span class="hljs-string">&quot;servers_config.json&quot;</span>)<br>    client = MultiServerMCPClient()<br>    <span class="hljs-keyword">try</span>:<br>        <span class="hljs-keyword">await</span> client.connect_to_servers(servers_config)<br>        <span class="hljs-keyword">await</span> client.chat_loop()<br>    <span class="hljs-keyword">finally</span>:<br>        <span class="hljs-keyword">try</span>:<br>            <span class="hljs-keyword">await</span> asyncio.sleep(<span class="hljs-number">0.1</span>)<br>            <span class="hljs-keyword">await</span> client.cleanup()<br>        <span class="hljs-keyword">except</span> RuntimeError <span class="hljs-keyword">as</span> e:<br>            <span class="hljs-comment"># 如果是因为退出 cancel scope 导致的异常，可以选择忽略</span><br>            <span class="hljs-keyword">if</span> <span class="hljs-string">&quot;Attempted to exit cancel scope&quot;</span> <span class="hljs-keyword">in</span> <span class="hljs-built_in">str</span>(e):<br>                logging.info(<span class="hljs-string">&quot;退出时检测到 cancel scope 异常，已忽略。&quot;</span>)<br>            <span class="hljs-keyword">else</span>:<br>                <span class="hljs-keyword">raise</span><br><br><span class="hljs-keyword">if</span> __name__ == <span class="hljs-string">&quot;__main__&quot;</span>:<br>    asyncio.run(main())<br></code></pre></td></tr></table></figure>

<p>接下来继续创建一个<code>.env</code>文件，来保存大模型调用的<code>API-KEY</code></p>
<p>并写入如下内容：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs bash">BASE_URL=https://api.deepseek.com<br>MODEL=deepseek-chat<br>OPENAI_API_KEY=YOUR_DEEPSEEK_API_KEY<br></code></pre></td></tr></table></figure>

<p>接下来继续创建<code>servers_config.json</code>文件，用于保存<code>MCP</code>工具基本信息：</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs json"><span class="hljs-punctuation">&#123;</span><br>  <span class="hljs-attr">&quot;mcpServers&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">&#123;</span><br>    <span class="hljs-attr">&quot;weather&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">&#123;</span><br>      <span class="hljs-attr">&quot;command&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;python&quot;</span><span class="hljs-punctuation">,</span><br>      <span class="hljs-attr">&quot;args&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span><span class="hljs-string">&quot;weather_server.py&quot;</span><span class="hljs-punctuation">]</span><span class="hljs-punctuation">,</span><br>      <span class="hljs-attr">&quot;transport&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;stdio&quot;</span><br>    <span class="hljs-punctuation">&#125;</span><span class="hljs-punctuation">,</span><br>    <span class="hljs-attr">&quot;write&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">&#123;</span><br>      <span class="hljs-attr">&quot;command&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;python&quot;</span><span class="hljs-punctuation">,</span><br>      <span class="hljs-attr">&quot;args&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span><span class="hljs-string">&quot;write_server.py&quot;</span><span class="hljs-punctuation">]</span><span class="hljs-punctuation">,</span><br>      <span class="hljs-attr">&quot;transport&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;stdio&quot;</span><br>    <span class="hljs-punctuation">&#125;</span><br>  <span class="hljs-punctuation">&#125;</span><br><span class="hljs-punctuation">&#125;</span><br></code></pre></td></tr></table></figure>

<p>最后在命令行中执行如下命令，注意在此之前要先启动两个<code>mcp</code>服务器脚本，即可开启对话：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">uv run client.py<br></code></pre></td></tr></table></figure>

<p>至此，即完成了一次简单的<code>MCP</code>执行流程。</p>
<p>上面是使用<code>Function calling</code>直接调用<code>MCP</code>的工具</p>
<p>接下来来介绍**<code>MCP+LangChain</code>的基础调用流程**，代码量也会大幅减少</p>
<p><code>LangChain</code>调用<code>MCP</code>是可以将<code>MCP</code>的工具直接转换为<code>LangChain</code>的工具，然后通过预定义的<code>MCP_Client</code>实现与外部<code>MCP</code>的读写操作，换而言之就是我们需要改写原先的<code>client</code>，将原先的<code>Function calling</code>调用逻辑修改为<code>LangChain</code>调用逻辑：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-string">&quot;&quot;&quot;</span><br><span class="hljs-string">多服务器 MCP + LangChain Agent 示例</span><br><span class="hljs-string">---------------------------------</span><br><span class="hljs-string">1. 读取 .env 中的 LLM_API_KEY / BASE_URL / MODEL</span><br><span class="hljs-string">2. 读取 servers_config.json 中的 MCP 服务器信息</span><br><span class="hljs-string">3. 启动 MCP 服务器（支持多个）</span><br><span class="hljs-string">4. 将所有工具注入 LangChain Agent，由大模型自动选择并调用</span><br><span class="hljs-string">&quot;&quot;&quot;</span><br><br><span class="hljs-keyword">import</span> asyncio<br><span class="hljs-keyword">import</span> json<br><span class="hljs-keyword">import</span> logging<br><span class="hljs-keyword">import</span> os<br><span class="hljs-keyword">from</span> typing <span class="hljs-keyword">import</span> <span class="hljs-type">Any</span>, <span class="hljs-type">Dict</span>, <span class="hljs-type">List</span><br><br><span class="hljs-keyword">from</span> dotenv <span class="hljs-keyword">import</span> load_dotenv<br><span class="hljs-keyword">from</span> langchain <span class="hljs-keyword">import</span> hub<br><span class="hljs-keyword">from</span> langchain.agents <span class="hljs-keyword">import</span> AgentExecutor, create_openai_tools_agent<br><span class="hljs-keyword">from</span> langchain.chat_models <span class="hljs-keyword">import</span> init_chat_model<br><span class="hljs-keyword">from</span> langchain_mcp_adapters.client <span class="hljs-keyword">import</span> MultiServerMCPClient<br><span class="hljs-keyword">from</span> langchain_mcp_adapters.tools <span class="hljs-keyword">import</span> load_mcp_tools<br><br><span class="hljs-comment"># ────────────────────────────</span><br><span class="hljs-comment"># 环境配置</span><br><span class="hljs-comment"># ────────────────────────────</span><br><br><span class="hljs-keyword">class</span> <span class="hljs-title class_">Configuration</span>:<br>    <span class="hljs-string">&quot;&quot;&quot;读取 .env 与 servers_config.json&quot;&quot;&quot;</span><br><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__init__</span>(<span class="hljs-params">self</span>) -&gt; <span class="hljs-literal">None</span>:<br>        load_dotenv()<br>        <span class="hljs-variable language_">self</span>.api_key: <span class="hljs-built_in">str</span> = os.getenv(<span class="hljs-string">&quot;LLM_API_KEY&quot;</span>) <span class="hljs-keyword">or</span> <span class="hljs-string">&quot;&quot;</span><br>        <span class="hljs-variable language_">self</span>.base_url: <span class="hljs-built_in">str</span> | <span class="hljs-literal">None</span> = os.getenv(<span class="hljs-string">&quot;BASE_URL&quot;</span>)  <span class="hljs-comment"># DeepSeek 用 https://api.deepseek.com</span><br>        <span class="hljs-variable language_">self</span>.model: <span class="hljs-built_in">str</span> = os.getenv(<span class="hljs-string">&quot;MODEL&quot;</span>) <span class="hljs-keyword">or</span> <span class="hljs-string">&quot;deepseek-chat&quot;</span><br>        <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> <span class="hljs-variable language_">self</span>.api_key:<br>            <span class="hljs-keyword">raise</span> ValueError(<span class="hljs-string">&quot;❌ 未找到 LLM_API_KEY，请在 .env 中配置&quot;</span>)<br><br><span class="hljs-meta">    @staticmethod</span><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">load_servers</span>(<span class="hljs-params">file_path: <span class="hljs-built_in">str</span> = <span class="hljs-string">&quot;servers_config.json&quot;</span></span>) -&gt; <span class="hljs-type">Dict</span>[<span class="hljs-built_in">str</span>, <span class="hljs-type">Any</span>]:<br>        <span class="hljs-keyword">with</span> <span class="hljs-built_in">open</span>(file_path, <span class="hljs-string">&quot;r&quot;</span>, encoding=<span class="hljs-string">&quot;utf-8&quot;</span>) <span class="hljs-keyword">as</span> f:<br>            <span class="hljs-keyword">return</span> json.load(f).get(<span class="hljs-string">&quot;mcpServers&quot;</span>, &#123;&#125;)<br><br><span class="hljs-comment"># ────────────────────────────</span><br><span class="hljs-comment"># 主逻辑</span><br><span class="hljs-comment"># ────────────────────────────</span><br><span class="hljs-keyword">async</span> <span class="hljs-keyword">def</span> <span class="hljs-title function_">run_chat_loop</span>() -&gt; <span class="hljs-literal">None</span>:<br>    <span class="hljs-string">&quot;&quot;&quot;启动 MCP-Agent 聊天循环&quot;&quot;&quot;</span><br>    cfg = Configuration()<br>    os.environ[<span class="hljs-string">&quot;DEEPSEEK_API_KEY&quot;</span>] = os.getenv(<span class="hljs-string">&quot;LLM_API_KEY&quot;</span>, <span class="hljs-string">&quot;&quot;</span>)<br>    <span class="hljs-keyword">if</span> cfg.base_url:<br>        os.environ[<span class="hljs-string">&quot;DEEPSEEK_API_BASE&quot;</span>] = cfg.base_url<br>    servers_cfg = Configuration.load_servers()<br><br>    <span class="hljs-comment"># 把 key 注入环境，LangChain-OpenAI / DeepSeek 会自动读取</span><br>    os.environ[<span class="hljs-string">&quot;OPENAI_API_KEY&quot;</span>] = cfg.api_key<br>    <span class="hljs-keyword">if</span> cfg.base_url:  <span class="hljs-comment"># 对 DeepSeek 之类的自定义域名很有用</span><br>        os.environ[<span class="hljs-string">&quot;OPENAI_BASE_URL&quot;</span>] = cfg.base_url<br><br>    <span class="hljs-comment"># 1️⃣ 连接多台 MCP 服务器</span><br>    mcp_client = MultiServerMCPClient(servers_cfg)<br><br>    tools = <span class="hljs-keyword">await</span> mcp_client.get_tools()         <span class="hljs-comment"># LangChain Tool 对象列表</span><br><br>    logging.info(<span class="hljs-string">f&quot;✅ 已加载 <span class="hljs-subst">&#123;<span class="hljs-built_in">len</span>(tools)&#125;</span> 个 MCP 工具： <span class="hljs-subst">&#123;[t.name <span class="hljs-keyword">for</span> t <span class="hljs-keyword">in</span> tools]&#125;</span>&quot;</span>)<br><br>    <span class="hljs-comment"># 2️⃣ 初始化大模型（DeepSeek / OpenAI / 任意兼容 OpenAI 协议的模型）</span><br>    llm = init_chat_model(<br>        model=cfg.model,<br>        model_provider=<span class="hljs-string">&quot;deepseek&quot;</span> <span class="hljs-keyword">if</span> <span class="hljs-string">&quot;deepseek&quot;</span> <span class="hljs-keyword">in</span> cfg.model <span class="hljs-keyword">else</span> <span class="hljs-string">&quot;openai&quot;</span>,<br>    )<br><br>    <span class="hljs-comment"># 3️⃣ 构造 LangChain Agent（用通用 prompt）</span><br>    prompt = hub.pull(<span class="hljs-string">&quot;hwchase17/openai-tools-agent&quot;</span>)<br>    agent = create_openai_tools_agent(llm, tools, prompt)<br>    agent_executor = AgentExecutor(agent=agent, tools=tools, verbose=<span class="hljs-literal">True</span>)<br><br>    <span class="hljs-comment"># 4️⃣ CLI 聊天</span><br>    <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;\n🤖 MCP Agent 已启动，输入 &#x27;quit&#x27; 退出&quot;</span>)<br>    <span class="hljs-keyword">while</span> <span class="hljs-literal">True</span>:<br>        user_input = <span class="hljs-built_in">input</span>(<span class="hljs-string">&quot;\n你: &quot;</span>).strip()<br>        <span class="hljs-keyword">if</span> user_input.lower() == <span class="hljs-string">&quot;quit&quot;</span>:<br>            <span class="hljs-keyword">break</span><br>        <span class="hljs-keyword">try</span>:<br>            result = <span class="hljs-keyword">await</span> agent_executor.ainvoke(&#123;<span class="hljs-string">&quot;input&quot;</span>: user_input&#125;)<br>            <span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;\nAI: <span class="hljs-subst">&#123;result[<span class="hljs-string">&#x27;output&#x27;</span>]&#125;</span>&quot;</span>)<br>        <span class="hljs-keyword">except</span> Exception <span class="hljs-keyword">as</span> exc:<br>            <span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;\n⚠️  出错: <span class="hljs-subst">&#123;exc&#125;</span>&quot;</span>)<br><br>    <span class="hljs-comment"># 5️⃣ 清理</span><br>    <span class="hljs-keyword">await</span> mcp_client.cleanup()<br>    <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;🧹 资源已清理，Bye!&quot;</span>)<br><br><span class="hljs-comment"># ────────────────────────────</span><br><span class="hljs-comment"># 入口</span><br><span class="hljs-comment"># ────────────────────────────</span><br><span class="hljs-keyword">if</span> __name__ == <span class="hljs-string">&quot;__main__&quot;</span>:<br>    logging.basicConfig(level=logging.INFO, <span class="hljs-built_in">format</span>=<span class="hljs-string">&quot;%(asctime)s - %(levelname)s - %(message)s&quot;</span>)<br>    asyncio.run(run_chat_loop())<br></code></pre></td></tr></table></figure>

<p><code>LangChain</code>接入<code>MCP</code>的核心原理为： <code>weather_server.py</code> → 启动为子进程 → <code>stdio</code> 通信 → <code>MCP</code> 协议 → 转换为 <code>LangChain</code> 工具 → <code>LangChain Agent</code> 执行读写，核心转换过程为：</p>
<ol>
<li><p><code>@mcp.tool()</code> → 标准 <code>LangChain Tool</code></p>
</li>
<li><p><code>stdio_client()</code> → 自动处理 <code>read/write</code> 流，其中<code>read</code> 表示从 <code>MCP</code> 服务器读取响应的流，<code>write</code> 表示向 <code>MCP</code> 服务器发送请求的流，对于 <code>stdio weather_server.py</code>，它们就是子进程的 <code>stdout</code> 和 <code>stdin</code></p>
</li>
<li><p><code>load_mcp_tools()</code> → 一键转换所有工具</p>
</li>
</ol>
<h1 id="七、LangChain-RAG知识库检索系统开发"><a href="#七、LangChain-RAG知识库检索系统开发" class="headerlink" title="七、LangChain RAG知识库检索系统开发"></a>七、<strong>LangChain RAG知识库检索系统开发</strong></h1><p>首先介绍<strong>LangChain 实现本地知识库问答</strong></p>
<p>供<code>Agents</code>在处理复杂任务的某个阶段使用，这其实是一种更为复杂的应用架构——<code>Agent + RAG</code>。</p>
<p>假设现在我们有一个偌大的知识库，当想从该知识库中去检索最相关的内容时，最简单的方法是：接收到一个查询（<code>Query</code>），就直接在知识库中进行搜索。这种做法其实是可行的，但存在两个关键的问题：</p>
<ol>
<li><p>假设提问的<code>Query</code>的答案出现在一篇文章中，去知识库中找到一篇与用户输入相关的文章是很容易的，但是我们将检索到的这整篇文章直接放入<code>Prompt</code>中并不是最优的选择，因为其中一定会包含非常多无关的信息，而无效信息越多，对大模型后续的推理影响越大。</p>
</li>
<li><p>任何一个大模型都存在最大输入的<code>Token</code>限制，一个流程中可能涉及多次检索，每次检索都会产生相应的上下文，无法容纳如此多的信息。</p>
</li>
</ol>
<p class='item-img' data-src='/images/39.png'><img src="/images/39.png"></p>
<p>解决上述两个问题的方式是：把存放着原始数据的知识库（<code>Knowledge</code>）中的每一个<code>raw data</code>，切分成一个一个的小块，这些小块可以是一个段落，也可以是数据库中某个索引对应的值。这个切分过程被称为“分块”（<code>chunking</code>），如下述流程所示：</p>
<p class='item-img' data-src='/images/40.png'><img src="/images/40.png"></p>
<p>以第一个原始数据为例（<code>raw data 1</code>），通过一些特定的方法进行切分，一个完整的内容会被分割成<code> chunk1</code> ~ <code>chunk4</code>。采取相同的方法，继续对<code>raw data 2</code>、<code>raw data 3</code>直至<code>raw data n</code>进行切分。完成这一过程后，我们最终得到的是一个充满分块数据（<code>chunks</code>）的新的知识库（<code>repository</code>），其中每一项都是一个单独的<code>chunk</code>。例如，如果原始文档共有<code>10</code>个，那么经过切分，可能会产生出<code>100</code>个<code>chunks</code>。</p>
<p>完成这一转化后，当再次接收到一个查询（<code>Query</code>）时，就会在更新后的知识库（<code>repository</code>）中进行搜索，这时检索的范围就不再是某个完整的文档，而是其中的某一个部分，返回的是一个或多个特定的<code>chunk</code>，这样返回的信息量就会更小且更精确。随后，这些被检索到的<code>chunk</code>会被加入到<code>Prompt</code>中，作为上下文信息与用户原始的<code>Query</code>共同输入到大模型进行处理，以生成最终的回答。</p>
<p>在上述将原始数据（<code>raw data</code>）转化为<code>chunk</code>的过程中，就会包含构建<code>RAG</code>的第一部分开发工作：这包括如果做数据清洗，如去除停用词、标点符号等。此外，还涉及如何选择合适的<code>split</code>方法来进行数据切分的一系列技术。</p>
<p>接下来面临的问题是，尽管所有数据已经被切割成一个个<code>chunk</code>，其存储形式还是以字符串形式存在，如果想从<code>repository</code>中匹配到与输入的<code>query</code>相关的<code>chunks</code>，比较两句话是否相似，看一句话中相同字有几个，这显然是行不通的。我们需要获取的是句子所蕴含的深层含义，而非仅仅是表面的字面相似度。因此，大家也能想到，在<code>NLP</code>中去计算文本相似度的有效的方法就是<code>Embedding</code>，即将这些<code>chunks</code>转换成向量（<code>vector</code>）形式。所以流程会丰富如下：</p>
<p class='item-img' data-src='/images/41.png'><img src="/images/41.png"></p>
<p>如上所示，解决搜索效率和计算相似度优化算法的答案就是：向量数据库。同时也产生了构建<code>RAG</code>的第三部分工作：我们要去了解和学习如何选择、使用向量数据库。</p>
<p>最终整体流程就如上图所示，一个基础的<code>RAG</code>架构会只要包含以下几方面的开发工作：</p>
<ol>
<li>如何将原始数据转化成<code>chunks</code>；</li>
<li>如何将<code>chunks</code>转化成<code>Vector</code>；</li>
<li>如何算向量相似度的算法；</li>
<li>如何利用向量数据库提升搜索效率；</li>
<li>如何把找到的<code>chunks</code>与原始<code>query</code>拼接在一起，产生最终的<code>Prompt</code>；</li>
</ol>
<p>而上述流程，其实更像是一个自由拼接的结果，比如不同的文档类型可以选择不同的文档解析器，也可以选择不同的<code>Vector</code>数据库，甚至可以自由选择<code>Embedding</code>模型和<code>Vector</code>数据库的组合。其自由程度非常高，如下图所示：</p>
<p class='item-img' data-src='/images/42.png'><img src="/images/42.png"></p>
<h2 id="由于这一部分比较复杂，因此在这仅给出示例代码，后续再做补充（后面的内容有需要可以看，也可以等后续给出更详细的教程）"><a href="#由于这一部分比较复杂，因此在这仅给出示例代码，后续再做补充（后面的内容有需要可以看，也可以等后续给出更详细的教程）" class="headerlink" title="由于这一部分比较复杂，因此在这仅给出示例代码，后续再做补充（后面的内容有需要可以看，也可以等后续给出更详细的教程）"></a>由于这一部分比较复杂，因此在这仅给出示例代码，后续再做补充（后面的内容有需要可以看，也可以等后续给出更详细的教程）</h2><p>下面是通过 <code>Streamlit</code> 前端界面，结合 <code>LangChain</code> 框架 与 <code>DashScope</code> 向量嵌入服务，实现了一个轻量化的 <code>RAG（Retrieval-Augmented Generation）</code> 智能问答系统，支持上传多个 <code>PDF</code> 文档，系统将自动完成文本提取、分块、向量化，并构建基于 <code>FAISS</code> 的检索数据库。用户随后可以在页面中输入任意问题，系统会调用大语言模型（如 <code>DeepSeek-Chat</code>）对 <code>PDF</code> 内容进行语义理解和回答生成。</p>
<p>其完整代码如下所示：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">! pip install streamlit PyPDF2 dashscope faiss-cpu<br></code></pre></td></tr></table></figure>

<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">import</span> streamlit <span class="hljs-keyword">as</span> st<br><span class="hljs-keyword">from</span> PyPDF2 <span class="hljs-keyword">import</span> PdfReader<br><span class="hljs-keyword">from</span> langchain.text_splitter <span class="hljs-keyword">import</span> RecursiveCharacterTextSplitter<br><span class="hljs-keyword">from</span> langchain_core.prompts <span class="hljs-keyword">import</span> ChatPromptTemplate<br><span class="hljs-keyword">from</span> langchain_community.vectorstores <span class="hljs-keyword">import</span> FAISS<br><span class="hljs-keyword">from</span> langchain.tools.retriever <span class="hljs-keyword">import</span> create_retriever_tool<br><span class="hljs-keyword">from</span> langchain.agents <span class="hljs-keyword">import</span> AgentExecutor, create_tool_calling_agent<br><span class="hljs-keyword">from</span> langchain_community.embeddings <span class="hljs-keyword">import</span> DashScopeEmbeddings<br><span class="hljs-keyword">from</span> langchain.chat_models <span class="hljs-keyword">import</span> init_chat_model<br><span class="hljs-keyword">import</span> os<br><span class="hljs-keyword">from</span> dotenv <span class="hljs-keyword">import</span> load_dotenv<br><br>load_dotenv(override=<span class="hljs-literal">True</span>)<br><br>DeepSeek_API_KEY = os.getenv(<span class="hljs-string">&quot;DEEPSEEK_API_KEY&quot;</span>)<br>dashscope_api_key = os.getenv(<span class="hljs-string">&quot;dashscope_api_key&quot;</span>)<br><br>os.environ[<span class="hljs-string">&quot;KMP_DUPLICATE_LIB_OK&quot;</span>] = <span class="hljs-string">&quot;TRUE&quot;</span><br><br>embeddings = DashScopeEmbeddings(<br>    model=<span class="hljs-string">&quot;text-embedding-v1&quot;</span>, dashscope_api_key=dashscope_api_key<br>)<br><br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">pdf_read</span>(<span class="hljs-params">pdf_doc</span>):<br>    text = <span class="hljs-string">&quot;&quot;</span><br>    <span class="hljs-keyword">for</span> pdf <span class="hljs-keyword">in</span> pdf_doc:<br>        pdf_reader = PdfReader(pdf)<br>        <span class="hljs-keyword">for</span> page <span class="hljs-keyword">in</span> pdf_reader.pages:<br>            text += page.extract_text()<br>    <span class="hljs-keyword">return</span> text<br><br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">get_chunks</span>(<span class="hljs-params">text</span>):<br>    text_splitter = RecursiveCharacterTextSplitter(chunk_size=<span class="hljs-number">1000</span>, chunk_overlap=<span class="hljs-number">200</span>)<br>    chunks = text_splitter.split_text(text)<br>    <span class="hljs-keyword">return</span> chunks<br><br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">vector_store</span>(<span class="hljs-params">text_chunks</span>):<br>    vector_store = FAISS.from_texts(text_chunks, embedding=embeddings)<br>    vector_store.save_local(<span class="hljs-string">&quot;faiss_db&quot;</span>)<br><br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">get_conversational_chain</span>(<span class="hljs-params">tools, ques</span>):<br>    llm = init_chat_model(<span class="hljs-string">&quot;deepseek-chat&quot;</span>, model_provider=<span class="hljs-string">&quot;deepseek&quot;</span>)<br>    prompt = ChatPromptTemplate.from_messages([<br>        (<br>            <span class="hljs-string">&quot;system&quot;</span>,<br>            <span class="hljs-string">&quot;&quot;&quot;你是AI助手，请根据提供的上下文回答问题，确保提供所有细节，如果答案不在上下文中，请说&quot;答案不在上下文中&quot;，不要提供错误的答案&quot;&quot;&quot;</span>,<br>        ),<br>        (<span class="hljs-string">&quot;placeholder&quot;</span>, <span class="hljs-string">&quot;&#123;chat_history&#125;&quot;</span>),<br>        (<span class="hljs-string">&quot;human&quot;</span>, <span class="hljs-string">&quot;&#123;input&#125;&quot;</span>),<br>        (<span class="hljs-string">&quot;placeholder&quot;</span>, <span class="hljs-string">&quot;&#123;agent_scratchpad&#125;&quot;</span>),<br>    ])<br><br>    tool = [tools]<br>    agent = create_tool_calling_agent(llm, tool, prompt)<br>    agent_executor = AgentExecutor(agent=agent, tools=tool, verbose=<span class="hljs-literal">True</span>)<br><br>    response = agent_executor.invoke(&#123;<span class="hljs-string">&quot;input&quot;</span>: ques&#125;)<br>    <span class="hljs-built_in">print</span>(response)<br>    st.write(<span class="hljs-string">&quot;🤖 回答: &quot;</span>, response[<span class="hljs-string">&#x27;output&#x27;</span>])<br><br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">check_database_exists</span>():<br>    <span class="hljs-string">&quot;&quot;&quot;检查FAISS数据库是否存在&quot;&quot;&quot;</span><br>    <span class="hljs-keyword">return</span> os.path.exists(<span class="hljs-string">&quot;faiss_db&quot;</span>) <span class="hljs-keyword">and</span> os.path.exists(<span class="hljs-string">&quot;faiss_db/index.faiss&quot;</span>)<br><br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">user_input</span>(<span class="hljs-params">user_question</span>):<br>    <span class="hljs-comment"># 检查数据库是否存在</span><br>    <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> check_database_exists():<br>        st.error(<span class="hljs-string">&quot;❌ 请先上传PDF文件并点击&#x27;Submit &amp; Process&#x27;按钮来处理文档！&quot;</span>)<br>        st.info(<span class="hljs-string">&quot;💡 步骤：1️⃣ 上传PDF → 2️⃣ 点击处理 → 3️⃣ 开始提问&quot;</span>)<br>        <span class="hljs-keyword">return</span><br><br>    <span class="hljs-keyword">try</span>:<br>        <span class="hljs-comment"># 加载FAISS数据库</span><br>        new_db = FAISS.load_local(<span class="hljs-string">&quot;faiss_db&quot;</span>, embeddings, allow_dangerous_deserialization=<span class="hljs-literal">True</span>)<br><br>        retriever = new_db.as_retriever()<br>        retrieval_chain = create_retriever_tool(retriever, <span class="hljs-string">&quot;pdf_extractor&quot;</span>,<br>                                                <span class="hljs-string">&quot;This tool is to give answer to queries from the pdf&quot;</span>)<br>        get_conversational_chain(retrieval_chain, user_question)<br><br>    <span class="hljs-keyword">except</span> Exception <span class="hljs-keyword">as</span> e:<br>        st.error(<span class="hljs-string">f&quot;❌ 加载数据库时出错: <span class="hljs-subst">&#123;<span class="hljs-built_in">str</span>(e)&#125;</span>&quot;</span>)<br>        st.info(<span class="hljs-string">&quot;请重新处理PDF文件&quot;</span>)<br><br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">main</span>():<br>    st.set_page_config(<span class="hljs-string">&quot;🤖 LangChain B站公开课 By九天Hector&quot;</span>)<br>    st.header(<span class="hljs-string">&quot;🤖 LangChain B站公开课 By九天Hector&quot;</span>)<br><br>    <span class="hljs-comment"># 显示数据库状态</span><br>    col1, col2 = st.columns([<span class="hljs-number">3</span>, <span class="hljs-number">1</span>])<br><br>    <span class="hljs-keyword">with</span> col1:<br>        <span class="hljs-keyword">if</span> check_database_exists():<br>            <span class="hljs-keyword">pass</span><br>        <span class="hljs-keyword">else</span>:<br>            st.warning(<span class="hljs-string">&quot;⚠️ 请先上传并处理PDF文件&quot;</span>)<br><br><br><span class="hljs-keyword">with</span> col2:<br>    <span class="hljs-keyword">if</span> st.button(<span class="hljs-string">&quot;🗑️ 清除数据库&quot;</span>):<br>        <span class="hljs-keyword">try</span>:<br>            <span class="hljs-keyword">import</span> shutil<br><br>            <span class="hljs-keyword">if</span> os.path.exists(<span class="hljs-string">&quot;faiss_db&quot;</span>):<br>                shutil.rmtree(<span class="hljs-string">&quot;faiss_db&quot;</span>)<br>            st.success(<span class="hljs-string">&quot;数据库已清除&quot;</span>)<br>            st.rerun()<br>        <span class="hljs-keyword">except</span> Exception <span class="hljs-keyword">as</span> e:<br>            st.error(<span class="hljs-string">f&quot;清除失败: <span class="hljs-subst">&#123;e&#125;</span>&quot;</span>)<br><br><span class="hljs-comment"># 用户问题输入</span><br>user_question = st.text_input(<span class="hljs-string">&quot;💬 请输入问题&quot;</span>,<br>                              placeholder=<span class="hljs-string">&quot;例如：这个文档的主要内容是什么？&quot;</span>,<br>                              disabled=<span class="hljs-keyword">not</span> check_database_exists())<br><br><span class="hljs-keyword">if</span> user_question:<br>    <span class="hljs-keyword">if</span> check_database_exists():<br>        <span class="hljs-keyword">with</span> st.spinner(<span class="hljs-string">&quot;🤔 AI正在分析文档...&quot;</span>):<br>            user_input(user_question)<br>    <span class="hljs-keyword">else</span>:<br>        st.error(<span class="hljs-string">&quot;❌ 请先上传并处理PDF文件！&quot;</span>)<br><br><span class="hljs-comment"># 侧边栏</span><br><span class="hljs-keyword">with</span> st.sidebar:<br>    st.title(<span class="hljs-string">&quot;📁 文档管理&quot;</span>)<br><br>    <span class="hljs-comment"># 显示当前状态</span><br>    <span class="hljs-keyword">if</span> check_database_exists():<br>        st.success(<span class="hljs-string">&quot;✅ 数据库状态：已就绪&quot;</span>)<br>    <span class="hljs-keyword">else</span>:<br>        st.info(<span class="hljs-string">&quot;📝 状态：等待上传PDF&quot;</span>)<br><br>    st.markdown(<span class="hljs-string">&quot;---&quot;</span>)<br><br>    <span class="hljs-comment"># 文件上传</span><br>    pdf_doc = st.file_uploader(<br>        <span class="hljs-string">&quot;📎 上传PDF文件&quot;</span>,<br>        accept_multiple_files=<span class="hljs-literal">True</span>,<br>        <span class="hljs-built_in">type</span>=[<span class="hljs-string">&#x27;pdf&#x27;</span>],<br>        <span class="hljs-built_in">help</span>=<span class="hljs-string">&quot;支持上传多个PDF文件&quot;</span><br>    )<br><br>    <span class="hljs-keyword">if</span> pdf_doc:<br>        st.info(<span class="hljs-string">f&quot;📄 已选择 <span class="hljs-subst">&#123;<span class="hljs-built_in">len</span>(pdf_doc)&#125;</span> 个文件&quot;</span>)<br>        <span class="hljs-keyword">for</span> i, pdf <span class="hljs-keyword">in</span> <span class="hljs-built_in">enumerate</span>(pdf_doc, <span class="hljs-number">1</span>):<br>            st.write(<span class="hljs-string">f&quot;<span class="hljs-subst">&#123;i&#125;</span>. <span class="hljs-subst">&#123;pdf.name&#125;</span>&quot;</span>)<br><br>    <span class="hljs-comment"># 处理按钮</span><br>    process_button = st.button(<br>        <span class="hljs-string">&quot;🚀 提交并处理&quot;</span>,<br>        disabled=<span class="hljs-keyword">not</span> pdf_doc,<br>        use_container_width=<span class="hljs-literal">True</span><br>    )<br><br>    <span class="hljs-keyword">if</span> process_button:<br>        <span class="hljs-keyword">if</span> pdf_doc:<br>            <span class="hljs-keyword">with</span> st.spinner(<span class="hljs-string">&quot;📊 正在处理PDF文件...&quot;</span>):<br>                <span class="hljs-keyword">try</span>:<br>                    <span class="hljs-comment"># 读取PDF内容</span><br>                    raw_text = pdf_read(pdf_doc)<br><br>                    <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> raw_text.strip():<br>                        st.error(<span class="hljs-string">&quot;❌ 无法从PDF中提取文本，请检查文件是否有效&quot;</span>)<br>                        <span class="hljs-keyword">return</span><br><br>                    <span class="hljs-comment"># 分割文本</span><br>                    text_chunks = get_chunks(raw_text)<br>                    st.info(<span class="hljs-string">f&quot;📝 文本已分割为 <span class="hljs-subst">&#123;<span class="hljs-built_in">len</span>(text_chunks)&#125;</span> 个片段&quot;</span>)<br><br>                    <span class="hljs-comment"># 创建向量数据库</span><br>                    vector_store(text_chunks)<br><br>                    st.success(<span class="hljs-string">&quot;✅ PDF处理完成！现在可以开始提问了&quot;</span>)<br>                    st.balloons()<br>                    st.rerun()<br><br>                <span class="hljs-keyword">except</span> Exception <span class="hljs-keyword">as</span> e:<br>                    st.error(<span class="hljs-string">f&quot;❌ 处理PDF时出错: <span class="hljs-subst">&#123;<span class="hljs-built_in">str</span>(e)&#125;</span>&quot;</span>)<br>        <span class="hljs-keyword">else</span>:<br>            st.warning(<span class="hljs-string">&quot;⚠️ 请先选择PDF文件&quot;</span>)<br><br>    <span class="hljs-comment"># 使用说明</span><br>    <span class="hljs-keyword">with</span> st.expander(<span class="hljs-string">&quot;💡 使用说明&quot;</span>):<br>        st.markdown(<span class="hljs-string">&quot;&quot;&quot;</span><br><span class="hljs-string">                **步骤：**</span><br><span class="hljs-string">                1. 📎 上传一个或多个PDF文件</span><br><span class="hljs-string">                2. 🚀 点击&quot;Submit &amp; Process&quot;处理文档</span><br><span class="hljs-string">                3. 💬 在主页面输入您的问题</span><br><span class="hljs-string">                4. 🤖 AI将基于PDF内容回答问题</span><br><span class="hljs-string"></span><br><span class="hljs-string">                **提示：**</span><br><span class="hljs-string">                - 支持多个PDF文件同时上传</span><br><span class="hljs-string">                - 处理大文件可能需要一些时间</span><br><span class="hljs-string">                - 可以随时清除数据库重新开始</span><br><span class="hljs-string">                &quot;&quot;&quot;</span>)<br><br><span class="hljs-keyword">if</span> __name__ == <span class="hljs-string">&quot;__main__&quot;</span>:<br>    main()<br></code></pre></td></tr></table></figure>

<p>基于此，我们能够实现：</p>
<ul>
<li><strong>LangChain 的多模块能力</strong>（向量搜索 + Agent工具）</li>
<li><strong>Streamlit 前端交互</strong></li>
<li><strong>FAISS 向量数据库</strong></li>
<li><strong>DashScope Embedding + DeepSeek 模型接入</strong></li>
<li>并完成了完整的 RAG（检索增强生成）流程</li>
</ul>
<p>以下是各部分功能实现代码讲解：</p>
<p>🔧 1. 导入库 &amp; 环境初始化</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">import</span> streamlit <span class="hljs-keyword">as</span> st<br><span class="hljs-keyword">from</span> PyPDF2 <span class="hljs-keyword">import</span> PdfReader<br><span class="hljs-keyword">from</span> langchain.text_splitter <span class="hljs-keyword">import</span> RecursiveCharacterTextSplitter<br>...<br>load_dotenv(override=<span class="hljs-literal">True</span>)<br></code></pre></td></tr></table></figure>

<ul>
<li><p><code>Streamlit</code> 用于构建网页界面。</p>
</li>
<li><p><code>PyPDF2</code> 用来读取 PDF 文本。</p>
</li>
<li><p><code>load_dotenv()</code> 加载 <code>.env</code> 中的 API Key，例如：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs dotenv">DEEPSEEK_API_KEY=sk-xxx<br>DASHSCOPE_API_KEY=xxx<br></code></pre></td></tr></table></figure></li>
</ul>
<hr>
<p>🔐 2. 加载 API 密钥与设置环境变量</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs python">DeepSeek_API_KEY = os.getenv(<span class="hljs-string">&quot;DEEPSEEK_API_KEY&quot;</span>)<br>dashscope_api_key = os.getenv(<span class="hljs-string">&quot;dashscope_api_key&quot;</span>)<br>os.environ[<span class="hljs-string">&quot;KMP_DUPLICATE_LIB_OK&quot;</span>]=<span class="hljs-string">&quot;TRUE&quot;</span><br></code></pre></td></tr></table></figure>

<ul>
<li>从环境变量中读取 DashScope 和 DeepSeek API。</li>
<li>设置 <code>KMP_DUPLICATE_LIB_OK</code> 避免某些 MKL 多线程报错。</li>
</ul>
<hr>
<p>🧠 3. 初始化向量 Embedding 模型</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs python">embeddings = DashScopeEmbeddings(<br>    model=<span class="hljs-string">&quot;text-embedding-v1&quot;</span>, dashscope_api_key=dashscope_api_key<br>)<br></code></pre></td></tr></table></figure>

<ul>
<li>用阿里云 DashScope 提供的 <code>text-embedding-v1</code> 将文本转为向量表示，用于相似度搜索。</li>
</ul>
<hr>
<p>📄 4. 处理 PDF 文本与向量化逻辑</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">def</span> <span class="hljs-title function_">pdf_read</span>(<span class="hljs-params">pdf_doc</span>):<br>    ...<br><span class="hljs-keyword">def</span> <span class="hljs-title function_">get_chunks</span>(<span class="hljs-params">text</span>):<br>    ...<br><span class="hljs-keyword">def</span> <span class="hljs-title function_">vector_store</span>(<span class="hljs-params">text_chunks</span>):<br>    ...<br></code></pre></td></tr></table></figure>

<ul>
<li><code>pdf_read</code>：逐页读取 PDF 内容并拼接。</li>
<li><code>get_chunks</code>：将长文本切片为多个段落（chunk），每段 1000 字，重叠 200 字。</li>
<li><code>vector_store</code>：用 FAISS 建立向量索引，并保存到本地 <code>faiss_db/</code>。</li>
</ul>
<hr>
<p>🔁 5. Agent对话链 + 工具调用（核心 RAG）</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">def</span> <span class="hljs-title function_">get_conversational_chain</span>(<span class="hljs-params">tools, ques</span>):<br>    llm = init_chat_model(<span class="hljs-string">&quot;deepseek-chat&quot;</span>, model_provider=<span class="hljs-string">&quot;deepseek&quot;</span>)<br>    ...<br>    agent_executor = AgentExecutor(...)<br>    response = agent_executor.invoke(&#123;<span class="hljs-string">&quot;input&quot;</span>: ques&#125;)<br>    ...<br></code></pre></td></tr></table></figure>

<ul>
<li><p>初始化 DeepSeek 模型为 Agent。</p>
</li>
<li><p>使用 LangChain 的 <code>create_tool_calling_agent</code> 构造 Agent，输入：</p>
<ul>
<li>prompt（你设定的系统角色）</li>
<li>工具（retriever 工具）</li>
</ul>
</li>
<li><p><code>AgentExecutor.invoke</code>：LangChain 自动判断是否调用工具，完成“读取上下文 → 查询 → 回答”流程。</p>
</li>
</ul>
<hr>
<p>🔍 6. 用户提问逻辑（调用 FAISS）</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">def</span> <span class="hljs-title function_">user_input</span>(<span class="hljs-params">user_question</span>):<br>    ...<br>    new_db = FAISS.load_local(<span class="hljs-string">&quot;faiss_db&quot;</span>, embeddings, ...)<br>    retriever = new_db.as_retriever()<br>    retrieval_chain = create_retriever_tool(retriever, <span class="hljs-string">&quot;pdf_extractor&quot;</span>, ...)<br>    get_conversational_chain(retrieval_chain, user_question)<br></code></pre></td></tr></table></figure>

<ul>
<li>加载本地 FAISS 向量库；</li>
<li>将其转为 LangChain 的检索工具；</li>
<li>交由 Agent 调用完成回答。</li>
</ul>
<hr>
<p>🧠 7. 检查数据库是否存在</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">def</span> <span class="hljs-title function_">check_database_exists</span>():<br>    <span class="hljs-keyword">return</span> os.path.exists(<span class="hljs-string">&quot;faiss_db&quot;</span>) <span class="hljs-keyword">and</span> os.path.exists(<span class="hljs-string">&quot;faiss_db/index.faiss&quot;</span>)<br></code></pre></td></tr></table></figure>

<p>简单检查本地是否已有向量化数据。</p>
<hr>
<p>🌐 8. 主界面逻辑（Streamlit）</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">def</span> <span class="hljs-title function_">main</span>():<br>    st.set_page_config(...)<br>    ...<br></code></pre></td></tr></table></figure>

<ul>
<li><p>页面标题与界面配置。</p>
</li>
<li><p><code>st.columns</code> 分栏：左边显示提示，右边放置“清空数据库”按钮。</p>
</li>
<li><p>主输入框：<code>st.text_input(&quot;请输入问题&quot;)</code></p>
<ul>
<li>只有当数据库存在时才能提问。</li>
</ul>
</li>
<li><p>侧边栏：</p>
<ul>
<li>PDF 上传器；</li>
<li>提交按钮（处理上传的 PDF → 分片 → 向量化 → 存储）。</li>
</ul>
</li>
</ul>
<hr>
<p>🎯 9. 提交 PDF 后执行的逻辑</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">if</span> process_button:<br>    raw_text = pdf_read(pdf_doc)<br>    ...<br>    text_chunks = get_chunks(raw_text)<br>    vector_store(text_chunks)<br></code></pre></td></tr></table></figure>

<ul>
<li><p>当点击“提交并处理”后：</p>
<ol>
<li>读取上传的 PDF；</li>
<li>切片文本；</li>
<li>向量化入库；</li>
<li>弹出气球提示，并 <code>st.rerun()</code> 刷新页面状态。</li>
</ol>
</li>
</ul>
<hr>
<p>📎 项目结构总结</p>
<table>
<thead>
<tr>
<th>模块</th>
<th>说明</th>
</tr>
</thead>
<tbody><tr>
<td>🧾 PDF解析</td>
<td>读取用户上传的 PDF</td>
</tr>
<tr>
<td>✂️ 文本切片</td>
<td>按段落分割内容</td>
</tr>
<tr>
<td>📊 向量化</td>
<td>DashScope Embedding + FAISS 建库</td>
</tr>
<tr>
<td>🔁 查询接口</td>
<td>用户输入 → 召回相关 chunk</td>
</tr>
<tr>
<td>🤖 DeepSeek Agent</td>
<td>调用检索工具并给出回答</td>
</tr>
<tr>
<td>💻 UI层</td>
<td>Streamlit 实现全部交互</td>
</tr>
</tbody></table>
<p>其中<code>LangChain RAG</code>核心功能相关代码如下：</p>
<p>Step 1：PDF 文件上传与文本提取</p>
<p>使用 <code>st.file_uploader()</code> 组件支持多文件上传，并通过 <code>PyPDF2.PdfReader</code> 对每页内容进行提取，组合为整体文本。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">def</span> <span class="hljs-title function_">pdf_read</span>(<span class="hljs-params">pdf_doc</span>):<br>    text = <span class="hljs-string">&quot;&quot;</span><br>    <span class="hljs-keyword">for</span> pdf <span class="hljs-keyword">in</span> pdf_doc:<br>        pdf_reader = PdfReader(pdf)<br>        <span class="hljs-keyword">for</span> page <span class="hljs-keyword">in</span> pdf_reader.pages:<br>            text += page.extract_text()<br>    <span class="hljs-keyword">return</span> text<br></code></pre></td></tr></table></figure>

<p>Step 2：文本分块与向量数据库构建</p>
<p>使用 <code>RecursiveCharacterTextSplitter</code> 将长文档切割为固定长度（1000字）+ 重叠（200字）的小块，将文本块通过 <code>DashScopeEmbeddings</code> 嵌入为向量，使用 <code>FAISS</code> 本地存储向量数据库。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs python">chunks = text_splitter.split_text(text)<br>vector_store = FAISS.from_texts(chunks, embedding=embeddings)<br>vector_store.save_local(<span class="hljs-string">&quot;faiss_db&quot;</span>)<br></code></pre></td></tr></table></figure>

<p>Step 3：用户提问与语义检索</p>
<p>通过 <code>Streamlit</code> 获取用户输入问题，如果向量数据库存在，则加载 <code>FAISS</code> 检索器，使用 <code>create_retriever_tool()</code> 构建 <code>LangChain</code> 工具，交由 <code>AgentExecutor</code> 执行，自动调用检索器并生成答案。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs python">retrieval_chain = create_retriever_tool(retriever, ...)<br>agent = create_tool_calling_agent(llm, [retrieval_chain], prompt)<br>response = agent_executor.invoke(&#123;<span class="hljs-string">&quot;input&quot;</span>: ques&#125;)<br></code></pre></td></tr></table></figure>

<p>下面再<strong>基于LangChain搭建AI数据分析智能体Data Agent</strong></p>
<p>接下来，我们进一步丰富智能问答系统的功能，接下来的案例中，我们构建一个基于 <code>Streamlit + LangChain + DashScope + DeepSeek</code> 的智能化数据分析助手，融合两个典型的企业级大模型应用场景：</p>
<ul>
<li><p>PDF 智能问答：支持上传多个 PDF 文档，自动完成内容提取、文本切块、语义向量化，并构建 FAISS 本地检索库，结合大模型进行问答；</p>
</li>
<li><p>CSV 数据智能分析：通过自然语言指令分析结构化数据，包括统计查询、代码生成与图表绘制；</p>
</li>
</ul>
<p>完整代码如下所示：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">pip install langchain_experimental matplotlib tabulate<br></code></pre></td></tr></table></figure>

<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">import</span> streamlit <span class="hljs-keyword">as</span> st<br><span class="hljs-keyword">import</span> pandas <span class="hljs-keyword">as</span> pd<br><span class="hljs-keyword">import</span> os<br><span class="hljs-keyword">from</span> PyPDF2 <span class="hljs-keyword">import</span> PdfReader<br><span class="hljs-keyword">from</span> langchain.text_splitter <span class="hljs-keyword">import</span> RecursiveCharacterTextSplitter<br><span class="hljs-keyword">from</span> langchain_core.prompts <span class="hljs-keyword">import</span> ChatPromptTemplate<br><span class="hljs-keyword">from</span> langchain_community.vectorstores <span class="hljs-keyword">import</span> FAISS<br><span class="hljs-keyword">from</span> langchain.tools.retriever <span class="hljs-keyword">import</span> create_retriever_tool<br><span class="hljs-keyword">from</span> langchain.agents <span class="hljs-keyword">import</span> AgentExecutor, create_tool_calling_agent<br><span class="hljs-keyword">from</span> langchain_community.embeddings <span class="hljs-keyword">import</span> DashScopeEmbeddings<br><span class="hljs-keyword">from</span> langchain.chat_models <span class="hljs-keyword">import</span> init_chat_model<br><span class="hljs-keyword">from</span> langchain_experimental.tools <span class="hljs-keyword">import</span> PythonAstREPLTool<br><span class="hljs-keyword">import</span> matplotlib<br><br>matplotlib.use(<span class="hljs-string">&#x27;Agg&#x27;</span>)<br><span class="hljs-keyword">import</span> os<br><span class="hljs-keyword">from</span> dotenv <span class="hljs-keyword">import</span> load_dotenv<br><br>load_dotenv(override=<span class="hljs-literal">True</span>)<br><br>DeepSeek_API_KEY = os.getenv(<span class="hljs-string">&quot;DEEPSEEK_API_KEY&quot;</span>)<br>dashscope_api_key = os.getenv(<span class="hljs-string">&quot;dashscope_api_key&quot;</span>)<br><br><span class="hljs-comment"># 设置环境变量</span><br>os.environ[<span class="hljs-string">&quot;KMP_DUPLICATE_LIB_OK&quot;</span>] = <span class="hljs-string">&quot;TRUE&quot;</span><br><br><span class="hljs-comment"># 页面配置</span><br>st.set_page_config(<br>    page_title=<span class="hljs-string">&quot;By九天Hector&quot;</span>,<br>    page_icon=<span class="hljs-string">&quot;🤖&quot;</span>,<br>    layout=<span class="hljs-string">&quot;wide&quot;</span>,<br>    initial_sidebar_state=<span class="hljs-string">&quot;expanded&quot;</span><br>)<br><br><span class="hljs-comment"># 自定义CSS样式</span><br>st.markdown(<span class="hljs-string">&quot;&quot;&quot;</span><br><span class="hljs-string">    &lt;style&gt;</span><br><span class="hljs-string">        /* 主题色彩 */</span><br><span class="hljs-string">        :root &#123;</span><br><span class="hljs-string">            --primary-color: #1f77b4;</span><br><span class="hljs-string">            --secondary-color: #ff7f0e;</span><br><span class="hljs-string">            --success-color: #2ca02c;</span><br><span class="hljs-string">            --warning-color: #ff9800;</span><br><span class="hljs-string">            --error-color: #d62728;</span><br><span class="hljs-string">            --background-color: #f8f9fa;</span><br><span class="hljs-string">        &#125;</span><br><span class="hljs-string"></span><br><span class="hljs-string">        /* 隐藏默认的Streamlit样式 */</span><br><span class="hljs-string">        #MainMenu &#123;visibility: hidden;&#125;</span><br><span class="hljs-string">        footer &#123;visibility: hidden;&#125;</span><br><span class="hljs-string">        header &#123;visibility: hidden;&#125;</span><br><span class="hljs-string"></span><br><span class="hljs-string">        /* 标题样式 */</span><br><span class="hljs-string">        .main-header &#123;</span><br><span class="hljs-string">            background: linear-gradient(90deg, #1f77b4, #ff7f0e);</span><br><span class="hljs-string">            -webkit-background-clip: text;</span><br><span class="hljs-string">            -webkit-text-fill-color: transparent;</span><br><span class="hljs-string">            font-size: 3rem;</span><br><span class="hljs-string">            font-weight: bold;</span><br><span class="hljs-string">            text-align: center;</span><br><span class="hljs-string">            margin-bottom: 2rem;</span><br><span class="hljs-string">        &#125;</span><br><span class="hljs-string"></span><br><span class="hljs-string">        /* 卡片样式 */</span><br><span class="hljs-string">        .info-card &#123;</span><br><span class="hljs-string">            background: white;</span><br><span class="hljs-string">            padding: 1.5rem;</span><br><span class="hljs-string">            border-radius: 10px;</span><br><span class="hljs-string">            box-shadow: 0 2px 10px rgba(0,0,0,0.1);</span><br><span class="hljs-string">            margin: 1rem 0;</span><br><span class="hljs-string">            border-left: 4px solid var(--primary-color);</span><br><span class="hljs-string">        &#125;</span><br><span class="hljs-string"></span><br><span class="hljs-string">        .success-card &#123;</span><br><span class="hljs-string">            background: linear-gradient(135deg, #e8f5e8, #f0f8f0);</span><br><span class="hljs-string">            border-left: 4px solid var(--success-color);</span><br><span class="hljs-string">        &#125;</span><br><span class="hljs-string"></span><br><span class="hljs-string">        .warning-card &#123;</span><br><span class="hljs-string">            background: linear-gradient(135deg, #fff8e1, #fffbf0);</span><br><span class="hljs-string">            border-left: 4px solid var(--warning-color);</span><br><span class="hljs-string">        &#125;</span><br><span class="hljs-string"></span><br><span class="hljs-string">        /* 按钮样式 */</span><br><span class="hljs-string">        .stButton &gt; button &#123;</span><br><span class="hljs-string">            background: linear-gradient(45deg, #1f77b4, #2196F3);</span><br><span class="hljs-string">            color: white;</span><br><span class="hljs-string">            border: none;</span><br><span class="hljs-string">            border-radius: 8px;</span><br><span class="hljs-string">            padding: 0.5rem 1rem;</span><br><span class="hljs-string">            font-weight: 600;</span><br><span class="hljs-string">            transition: all 0.3s ease;</span><br><span class="hljs-string">            box-shadow: 0 2px 8px rgba(31, 119, 180, 0.3);</span><br><span class="hljs-string">        &#125;</span><br><span class="hljs-string"></span><br><span class="hljs-string">        .stButton &gt; button:hover &#123;</span><br><span class="hljs-string">            transform: translateY(-2px);</span><br><span class="hljs-string">            box-shadow: 0 4px 12px rgba(31, 119, 180, 0.4);</span><br><span class="hljs-string">        &#125;</span><br><span class="hljs-string"></span><br><span class="hljs-string">        /* Tab样式 */</span><br><span class="hljs-string">        .stTabs [data-baseweb=&quot;tab-list&quot;] &#123;</span><br><span class="hljs-string">            gap: 8px;</span><br><span class="hljs-string">            background-color: #f8f9fa;</span><br><span class="hljs-string">            border-radius: 10px;</span><br><span class="hljs-string">            padding: 0.5rem;</span><br><span class="hljs-string">        &#125;</span><br><span class="hljs-string"></span><br><span class="hljs-string">        .stTabs [data-baseweb=&quot;tab&quot;] &#123;</span><br><span class="hljs-string">            height: 60px;</span><br><span class="hljs-string">            background-color: white;</span><br><span class="hljs-string">            border-radius: 8px;</span><br><span class="hljs-string">            padding: 0 24px;</span><br><span class="hljs-string">            font-weight: 600;</span><br><span class="hljs-string">            border: 2px solid transparent;</span><br><span class="hljs-string">            transition: all 0.3s ease;</span><br><span class="hljs-string">        &#125;</span><br><span class="hljs-string"></span><br><span class="hljs-string">        .stTabs [aria-selected=&quot;true&quot;] &#123;</span><br><span class="hljs-string">            background: linear-gradient(45deg, #1f77b4, #2196F3);</span><br><span class="hljs-string">            color: white !important;</span><br><span class="hljs-string">            border: 2px solid #1f77b4;</span><br><span class="hljs-string">        &#125;</span><br><span class="hljs-string"></span><br><span class="hljs-string">        /* 侧边栏样式 */</span><br><span class="hljs-string">        .css-1d391kg &#123;</span><br><span class="hljs-string">            background: linear-gradient(180deg, #f8f9fa, #ffffff);</span><br><span class="hljs-string">        &#125;</span><br><span class="hljs-string"></span><br><span class="hljs-string">        /* 文件上传区域 */</span><br><span class="hljs-string">        .uploadedFile &#123;</span><br><span class="hljs-string">            background: #f8f9fa;</span><br><span class="hljs-string">            border: 2px dashed #1f77b4;</span><br><span class="hljs-string">            border-radius: 10px;</span><br><span class="hljs-string">            padding: 1rem;</span><br><span class="hljs-string">            text-align: center;</span><br><span class="hljs-string">            margin: 1rem 0;</span><br><span class="hljs-string">        &#125;</span><br><span class="hljs-string"></span><br><span class="hljs-string">        /* 状态指示器 */</span><br><span class="hljs-string">        .status-indicator &#123;</span><br><span class="hljs-string">            display: inline-flex;</span><br><span class="hljs-string">            align-items: center;</span><br><span class="hljs-string">            gap: 0.5rem;</span><br><span class="hljs-string">            padding: 0.5rem 1rem;</span><br><span class="hljs-string">            border-radius: 20px;</span><br><span class="hljs-string">            font-weight: 600;</span><br><span class="hljs-string">            font-size: 0.9rem;</span><br><span class="hljs-string">        &#125;</span><br><span class="hljs-string"></span><br><span class="hljs-string">        .status-ready &#123;</span><br><span class="hljs-string">            background: #e8f5e8;</span><br><span class="hljs-string">            color: #2ca02c;</span><br><span class="hljs-string">            border: 1px solid #2ca02c;</span><br><span class="hljs-string">        &#125;</span><br><span class="hljs-string"></span><br><span class="hljs-string">        .status-waiting &#123;</span><br><span class="hljs-string">            background: #fff8e1;</span><br><span class="hljs-string">            color: #ff9800;</span><br><span class="hljs-string">            border: 1px solid #ff9800;</span><br><span class="hljs-string">        &#125;</span><br><span class="hljs-string">    &lt;/style&gt;</span><br><span class="hljs-string">    &quot;&quot;&quot;</span>, unsafe_allow_html=<span class="hljs-literal">True</span>)<br><br><br><span class="hljs-comment"># 初始化embeddings</span><br><span class="hljs-meta">@st.cache_resource</span><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">init_embeddings</span>():<br>    <span class="hljs-keyword">return</span> DashScopeEmbeddings(<br>        model=<span class="hljs-string">&quot;text-embedding-v1&quot;</span>,<br>        dashscope_api_key=dashscope_api_key<br>    )<br><br><br><span class="hljs-comment"># 初始化LLM</span><br><span class="hljs-meta">@st.cache_resource</span><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">init_llm</span>():<br>    <span class="hljs-keyword">return</span> init_chat_model(<span class="hljs-string">&quot;deepseek-chat&quot;</span>, model_provider=<span class="hljs-string">&quot;deepseek&quot;</span>)<br><br><br><span class="hljs-comment"># 初始化会话状态</span><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">init_session_state</span>():<br>    <span class="hljs-keyword">if</span> <span class="hljs-string">&#x27;pdf_messages&#x27;</span> <span class="hljs-keyword">not</span> <span class="hljs-keyword">in</span> st.session_state:<br>        st.session_state.pdf_messages = []<br>    <span class="hljs-keyword">if</span> <span class="hljs-string">&#x27;csv_messages&#x27;</span> <span class="hljs-keyword">not</span> <span class="hljs-keyword">in</span> st.session_state:<br>        st.session_state.csv_messages = []<br>    <span class="hljs-keyword">if</span> <span class="hljs-string">&#x27;df&#x27;</span> <span class="hljs-keyword">not</span> <span class="hljs-keyword">in</span> st.session_state:<br>        st.session_state.df = <span class="hljs-literal">None</span><br><br><br><span class="hljs-comment"># PDF处理函数</span><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">pdf_read</span>(<span class="hljs-params">pdf_doc</span>):<br>    text = <span class="hljs-string">&quot;&quot;</span><br>    <span class="hljs-keyword">for</span> pdf <span class="hljs-keyword">in</span> pdf_doc:<br>        pdf_reader = PdfReader(pdf)<br>        <span class="hljs-keyword">for</span> page <span class="hljs-keyword">in</span> pdf_reader.pages:<br>            text += page.extract_text()<br>    <span class="hljs-keyword">return</span> text<br><br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">get_chunks</span>(<span class="hljs-params">text</span>):<br>    text_splitter = RecursiveCharacterTextSplitter(chunk_size=<span class="hljs-number">1000</span>, chunk_overlap=<span class="hljs-number">200</span>)<br>    chunks = text_splitter.split_text(text)<br>    <span class="hljs-keyword">return</span> chunks<br><br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">vector_store</span>(<span class="hljs-params">text_chunks</span>):<br>    embeddings = init_embeddings()<br>    vector_store = FAISS.from_texts(text_chunks, embedding=embeddings)<br>    vector_store.save_local(<span class="hljs-string">&quot;faiss_db&quot;</span>)<br><br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">check_database_exists</span>():<br>    <span class="hljs-keyword">return</span> os.path.exists(<span class="hljs-string">&quot;faiss_db&quot;</span>) <span class="hljs-keyword">and</span> os.path.exists(<span class="hljs-string">&quot;faiss_db/index.faiss&quot;</span>)<br><br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">get_pdf_response</span>(<span class="hljs-params">user_question</span>):<br>    <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> check_database_exists():<br>        <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;❌ 请先上传PDF文件并点击&#x27;Submit &amp; Process&#x27;按钮来处理文档！&quot;</span><br><br>    <span class="hljs-keyword">try</span>:<br>        embeddings = init_embeddings()<br>        llm = init_llm()<br><br>        new_db = FAISS.load_local(<span class="hljs-string">&quot;faiss_db&quot;</span>, embeddings, allow_dangerous_deserialization=<span class="hljs-literal">True</span>)<br>        retriever = new_db.as_retriever()<br><br>        prompt = ChatPromptTemplate.from_messages([<br>            (<span class="hljs-string">&quot;system&quot;</span>,<br>             <span class="hljs-string">&quot;&quot;&quot;你是AI助手，请根据提供的上下文回答问题，确保提供所有细节，如果答案不在上下文中，请说&quot;答案不在上下文中&quot;，不要提供错误的答案&quot;&quot;&quot;</span>),<br>            (<span class="hljs-string">&quot;placeholder&quot;</span>, <span class="hljs-string">&quot;&#123;chat_history&#125;&quot;</span>),<br>            (<span class="hljs-string">&quot;human&quot;</span>, <span class="hljs-string">&quot;&#123;input&#125;&quot;</span>),<br>            (<span class="hljs-string">&quot;placeholder&quot;</span>, <span class="hljs-string">&quot;&#123;agent_scratchpad&#125;&quot;</span>),<br>        ])<br><br>        retrieval_chain = create_retriever_tool(retriever, <span class="hljs-string">&quot;pdf_extractor&quot;</span>,<br>                                                <span class="hljs-string">&quot;This tool is to give answer to queries from the pdf&quot;</span>)<br>        agent = create_tool_calling_agent(llm, [retrieval_chain], prompt)<br>        agent_executor = AgentExecutor(agent=agent, tools=[retrieval_chain], verbose=<span class="hljs-literal">True</span>)<br><br>        response = agent_executor.invoke(&#123;<span class="hljs-string">&quot;input&quot;</span>: user_question&#125;)<br>        <span class="hljs-keyword">return</span> response[<span class="hljs-string">&#x27;output&#x27;</span>]<br><br>    <span class="hljs-keyword">except</span> Exception <span class="hljs-keyword">as</span> e:<br>        <span class="hljs-keyword">return</span> <span class="hljs-string">f&quot;❌ 处理问题时出错: <span class="hljs-subst">&#123;<span class="hljs-built_in">str</span>(e)&#125;</span>&quot;</span><br><br><br><span class="hljs-comment"># CSV处理函数</span><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">get_csv_response</span>(<span class="hljs-params">query: <span class="hljs-built_in">str</span></span>) -&gt; <span class="hljs-built_in">str</span>:<br>    <span class="hljs-keyword">if</span> st.session_state.df <span class="hljs-keyword">is</span> <span class="hljs-literal">None</span>:<br>        <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;请先上传CSV文件&quot;</span><br><br>    llm = init_llm()<br>    locals_dict = &#123;<span class="hljs-string">&#x27;df&#x27;</span>: st.session_state.df&#125;<br>    tools = [PythonAstREPLTool(<span class="hljs-built_in">locals</span>=locals_dict)]<br><br>    system = <span class="hljs-string">f&quot;&quot;&quot;Given a pandas dataframe `df` answer user&#x27;s query.</span><br><span class="hljs-string">        Here&#x27;s the output of `df.head().to_markdown()` for your reference, you have access to full dataframe as `df`:</span><br></code></pre></td></tr></table></figure>
<pre><code>    &#123;st.session_state.df.head().to_markdown()&#125;
    <figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs plaintext">Give final answer as soon as you have enough data, otherwise generate code using `df` and call required tool.<br>If user asks you to make a graph, save it as `plot.png`, and output GRAPH:&lt;graph title&gt;.<br>Example:<br></code></pre></td></tr></table></figure>
    plt.hist(df[&#39;Age&#39;])
    plt.xlabel(&#39;Age&#39;)
    plt.ylabel(&#39;Count&#39;)
    plt.title(&#39;Age Histogram&#39;)
    plt.savefig(&#39;plot.png&#39;)
    <figure class="highlight plaintext"><figcaption><span>GRAPH:Age histogram</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br></pre></td><td class="code"><pre><code class="hljs output:">        Query:&quot;&quot;&quot;<br><br>    prompt = ChatPromptTemplate.from_messages([<br>        (&quot;system&quot;, system),<br>        (&quot;placeholder&quot;, &quot;&#123;chat_history&#125;&quot;),<br>        (&quot;human&quot;, &quot;&#123;input&#125;&quot;),<br>        (&quot;placeholder&quot;, &quot;&#123;agent_scratchpad&#125;&quot;),<br>    ])<br><br>    agent = create_tool_calling_agent(llm=llm, tools=tools, prompt=prompt)<br>    agent_executor = AgentExecutor(agent=agent, tools=tools, verbose=True)<br><br>    return agent_executor.invoke(&#123;&quot;input&quot;: query&#125;)[&#x27;output&#x27;]<br><br><br>def main():<br>    init_session_state()<br><br>    # 主标题<br>    st.markdown(&#x27;&lt;h1 class=&quot;main-header&quot;&gt;🤖 LangChain B站公开课 By九天Hector&lt;/h1&gt;&#x27;, unsafe_allow_html=True)<br>    st.markdown(<br>        &#x27;&lt;div style=&quot;text-align: center; margin-bottom: 2rem; color: #666;&quot;&gt;集PDF问答与数据分析于一体的智能助手&lt;/div&gt;&#x27;,<br>        unsafe_allow_html=True)<br><br>    # 创建两个主要功能的标签页<br>    tab1, tab2 = st.tabs([&quot;📄 PDF智能问答&quot;, &quot;📊 CSV数据分析&quot;])<br><br>    # PDF问答模块<br>    with tab1:<br>        col1, col2 = st.columns([2, 1])<br><br>        with col1:<br>            st.markdown(&quot;### 💬 与PDF文档对话&quot;)<br><br>            # 显示数据库状态<br>            if check_database_exists():<br>                st.markdown(<br>                    &#x27;&lt;div class=&quot;info-card success-card&quot;&gt;&lt;span class=&quot;status-indicator status-ready&quot;&gt;✅ PDF数据库已准备就绪&lt;/span&gt;&lt;/div&gt;&#x27;,<br>                    unsafe_allow_html=True)<br>            else:<br>                st.markdown(<br>                    &#x27;&lt;div class=&quot;info-card warning-card&quot;&gt;&lt;span class=&quot;status-indicator status-waiting&quot;&gt;⚠️ 请先上传并处理PDF文件&lt;/span&gt;&lt;/div&gt;&#x27;,<br>                    unsafe_allow_html=True)<br><br>            # 聊天界面<br>            for message in st.session_state.pdf_messages:<br>                with st.chat_message(message[&quot;role&quot;]):<br>                    st.markdown(message[&quot;content&quot;])<br><br>            # 用户输入<br>            if pdf_query := st.chat_input(&quot;💭 向PDF提问...&quot;, disabled=not check_database_exists()):<br>                st.session_state.pdf_messages.append(&#123;&quot;role&quot;: &quot;user&quot;, &quot;content&quot;: pdf_query&#125;)<br>                with st.chat_message(&quot;user&quot;):<br>                    st.markdown(pdf_query)<br><br>                with st.chat_message(&quot;assistant&quot;):<br>                    with st.spinner(&quot;🤔 AI正在分析文档...&quot;):<br>                        response = get_pdf_response(pdf_query)<br>                    st.markdown(response)<br>                    st.session_state.pdf_messages.append(&#123;&quot;role&quot;: &quot;assistant&quot;, &quot;content&quot;: response&#125;)<br><br>        with col2:<br>            st.markdown(&quot;### 📁 文档管理&quot;)<br><br>            # 文件上传<br>            pdf_docs = st.file_uploader(<br>                &quot;📎 上传PDF文件&quot;,<br>                accept_multiple_files=True,<br>                type=[&#x27;pdf&#x27;],<br>                help=&quot;支持上传多个PDF文件&quot;<br>            )<br><br>            if pdf_docs:<br>                st.success(f&quot;📄 已选择 &#123;len(pdf_docs)&#125; 个文件&quot;)<br>                for i, pdf in enumerate(pdf_docs, 1):<br>                    st.write(f&quot;• &#123;pdf.name&#125;&quot;)<br><br>            # 处理按钮<br>            if st.button(&quot;🚀 上传并处理PDF文档&quot;, disabled=not pdf_docs, use_container_width=True):<br>                with st.spinner(&quot;📊 正在处理PDF文件...&quot;):<br>                    try:<br>                        raw_text = pdf_read(pdf_docs)<br>                        if not raw_text.strip():<br>                            st.error(&quot;❌ 无法从PDF中提取文本&quot;)<br>                            return<br><br>                        text_chunks = get_chunks(raw_text)<br>                        st.info(f&quot;📝 文本已分割为 &#123;len(text_chunks)&#125; 个片段&quot;)<br><br>                        vector_store(text_chunks)<br>                        st.success(&quot;✅ PDF处理完成！&quot;)<br>                        st.balloons()<br>                        st.rerun()<br><br>                    except Exception as e:<br>                        st.error(f&quot;❌ 处理PDF时出错: &#123;str(e)&#125;&quot;)<br><br>            # 清除数据库<br>            if st.button(&quot;🗑️ 清除PDF数据库&quot;, use_container_width=True):<br>                try:<br>                    import shutil<br>                    if os.path.exists(&quot;faiss_db&quot;):<br>                        shutil.rmtree(&quot;faiss_db&quot;)<br>                    st.session_state.pdf_messages = []<br>                    st.success(&quot;数据库已清除&quot;)<br>                    st.rerun()<br>                except Exception as e:<br>                    st.error(f&quot;清除失败: &#123;e&#125;&quot;)<br><br>    # CSV数据分析模块<br>    with tab2:<br>        col1, col2 = st.columns([2, 1])<br><br>        with col1:<br>            st.markdown(&quot;### 📈 数据分析对话&quot;)<br><br>            # 显示数据状态<br>            if st.session_state.df is not None:<br>                st.markdown(<br>                    &#x27;&lt;div class=&quot;info-card success-card&quot;&gt;&lt;span class=&quot;status-indicator status-ready&quot;&gt;✅ 数据已加载完成&lt;/span&gt;&lt;/div&gt;&#x27;,<br>                    unsafe_allow_html=True)<br>            else:<br>                st.markdown(<br>                    &#x27;&lt;div class=&quot;info-card warning-card&quot;&gt;&lt;span class=&quot;status-indicator status-waiting&quot;&gt;⚠️ 请先上传CSV文件&lt;/span&gt;&lt;/div&gt;&#x27;,<br>                    unsafe_allow_html=True)<br><br>            # 聊天界面<br>            for message in st.session_state.csv_messages:<br>                with st.chat_message(message[&quot;role&quot;]):<br>                    if message[&quot;type&quot;] == &quot;dataframe&quot;:<br>                        st.dataframe(message[&quot;content&quot;])<br>                    elif message[&quot;type&quot;] == &quot;image&quot;:<br>                        st.write(message[&quot;content&quot;])<br>                        if os.path.exists(&#x27;plot.png&#x27;):<br>                            st.image(&#x27;plot.png&#x27;)<br>                    else:<br>                        st.markdown(message[&quot;content&quot;])<br><br>            # 用户输入<br>            if csv_query := st.chat_input(&quot;📊 分析数据...&quot;, disabled=st.session_state.df is None):<br>                st.session_state.csv_messages.append(&#123;&quot;role&quot;: &quot;user&quot;, &quot;content&quot;: csv_query, &quot;type&quot;: &quot;text&quot;&#125;)<br>                with st.chat_message(&quot;user&quot;):<br>                    st.markdown(csv_query)<br><br>                with st.chat_message(&quot;assistant&quot;):<br>                    with st.spinner(&quot;🔄 正在分析数据...&quot;):<br>                        response = get_csv_response(csv_query)<br><br>                    if isinstance(response, pd.DataFrame):<br>                        st.dataframe(response)<br>                        st.session_state.csv_messages.append(<br>                            &#123;&quot;role&quot;: &quot;assistant&quot;, &quot;content&quot;: response, &quot;type&quot;: &quot;dataframe&quot;&#125;)<br>                    elif &quot;GRAPH&quot; in str(response):<br>                        text = str(response)[str(response).find(&quot;GRAPH&quot;) + 6:]<br>                        st.write(text)<br>                        if os.path.exists(&#x27;plot.png&#x27;):<br>                            st.image(&#x27;plot.png&#x27;)<br>                        st.session_state.csv_messages.append(&#123;&quot;role&quot;: &quot;assistant&quot;, &quot;content&quot;: text, &quot;type&quot;: &quot;image&quot;&#125;)<br>                    else:<br>                        st.markdown(response)<br>                        st.session_state.csv_messages.append(&#123;&quot;role&quot;: &quot;assistant&quot;, &quot;content&quot;: response, &quot;type&quot;: &quot;text&quot;&#125;)<br><br>        with col2:<br>            st.markdown(&quot;### 📊 数据管理&quot;)<br><br>            # CSV文件上传<br>            csv_file = st.file_uploader(&quot;📈 上传CSV文件&quot;, type=&#x27;csv&#x27;)<br>            if csv_file:<br>                st.session_state.df = pd.read_csv(csv_file)<br>                st.success(f&quot;✅ 数据加载成功!&quot;)<br><br>                # 显示数据预览<br>                with st.expander(&quot;👀 数据预览&quot;, expanded=True):<br>                    st.dataframe(st.session_state.df.head())<br>                    st.write(f&quot;📏 数据维度: &#123;st.session_state.df.shape[0]&#125; 行 × &#123;st.session_state.df.shape[1]&#125; 列&quot;)<br><br>            # 数据信息<br>            if st.session_state.df is not None:<br>                if st.button(&quot;📋 显示数据信息&quot;, use_container_width=True):<br>                    with st.expander(&quot;📊 数据统计信息&quot;, expanded=True):<br>                        st.write(&quot;**基本信息:**&quot;)<br>                        st.text(f&quot;行数: &#123;st.session_state.df.shape[0]&#125;&quot;)<br>                        st.text(f&quot;列数: &#123;st.session_state.df.shape[1]&#125;&quot;)<br>                        st.write(&quot;**列名:**&quot;)<br>                        st.write(list(st.session_state.df.columns))<br>                        st.write(&quot;**数据类型:**&quot;)<br>                        # 修复：将dtypes转换为字符串格式显示<br>                        dtype_info = pd.DataFrame(&#123;<br>                            &#x27;列名&#x27;: st.session_state.df.columns,<br>                            &#x27;数据类型&#x27;: [str(dtype) for dtype in st.session_state.df.dtypes]<br>                        &#125;)<br>                        st.dataframe(dtype_info, use_container_width=True)<br><br>            # 清除数据<br>            if st.button(&quot;🗑️ 清除CSV数据&quot;, use_container_width=True):<br>                st.session_state.df = None<br>                st.session_state.csv_messages = []<br>                if os.path.exists(&#x27;plot.png&#x27;):<br>                    os.remove(&#x27;plot.png&#x27;)<br>                st.success(&quot;数据已清除&quot;)<br>                st.rerun()<br><br>    # 底部信息<br>    st.markdown(&quot;---&quot;)<br>    col1, col2, col3 = st.columns(3)<br>    with col1:<br>        st.markdown(&quot;**🔧 技术栈:**&quot;)<br>        st.markdown(&quot;• LangChain • Streamlit • FAISS • DeepSeek&quot;)<br>    with col2:<br>        st.markdown(&quot;**✨ 功能特色:**&quot;)<br>        st.markdown(&quot;• PDF智能问答 • 数据可视化分析&quot;)<br>    with col3:<br>        st.markdown(&quot;**💡 使用提示:**&quot;)<br>        st.markdown(&quot;• 支持多文件上传 • 实时对话交互&quot;)<br><br><br>if __name__ == &quot;__main__&quot;:<br>    main() <br></code></pre></td></tr></table></figure>
</code></pre>
<p>✅ 总结（核心功能架构）</p>
<table>
<thead>
<tr>
<th>模块</th>
<th>技术组件</th>
<th>说明</th>
</tr>
</thead>
<tbody><tr>
<td>PDF 问答</td>
<td>FAISS + Retriever Tool</td>
<td>构成 RAG 检索增强流程</td>
</tr>
<tr>
<td>CSV 分析</td>
<td>PythonAstREPLTool + Pandas</td>
<td>实现代码生成 + 可视化</td>
</tr>
<tr>
<td>LLM</td>
<td>DeepSeek Chat</td>
<td>统一 Agent 调用</td>
</tr>
<tr>
<td>向量库</td>
<td>DashScope Embedding + FAISS</td>
<td>支持中文语义匹配</td>
</tr>
<tr>
<td>UI</td>
<td>Streamlit + 自定义 CSS</td>
<td>提供多 Tab 页面与交互式聊天</td>
</tr>
<tr>
<td>状态管理</td>
<td><code>st.session_state</code></td>
<td>管理历史、数据、图片等上下文</td>
</tr>
</tbody></table>
<p>这里不再重复赘述<code>PDF</code>智能问答的流程，重点说明<code>CSV</code>数据智能分析的流程。</p>
<p>Step 1. CSV 文件上传与 DataFrame 显示</p>
<p>用户上传 .csv 文件后由 pandas.read_csv() 加载为 DataFrame，实时预览数据行列、列名、类型等信息。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs python">st.session_state.df = pd.read_csv(csv_file)<br>st.dataframe(st.session_state.df.head())<br></code></pre></td></tr></table></figure>

<p>Step 2. 构建代码执行工具 Agent</p>
<p>构建系统提示，注入 DataFrame 的 .head() 输出增强语境理解，使用 PythonAstREPLTool 工具允许模型执行基于 df 的代码分析，通过 create_tool_calling_agent 构建分析 Agent，可执行筛选、分组、聚合等 pandas 操作，图表绘制（保存为 plot.png，关键词识别后渲染）。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs python">tools = [PythonAstREPLTool(<span class="hljs-built_in">locals</span>=&#123;<span class="hljs-string">&quot;df&quot;</span>: st.session_state.df&#125;)]<br></code></pre></td></tr></table></figure>

<p>Step 3. 图表识别与自动展示</p>
<p>若模型返回内容中包含 “GRAPH:”，则自动读取 plot.png 并展示；支持 plt.hist()、plt.bar() 等可视化命令；会话记录中分类保存文本、图像与表格类型内容。</p>
<div id="paginator"></div></div><div id="post-footer"><div id="pages"><div class="footer-link" style="width: 50%;text-align:right;border-right:1px #fe2 solid"><a href="/2025/08/13/%E9%98%BF%E9%87%8C%E4%BA%91%E6%9C%8D%E5%8A%A1%E5%99%A8-%E5%AE%9D%E5%A1%94%E9%9D%A2%E6%9D%BF/">← Next 基于阿里云服务器配置宝塔面板</a></div><div class="footer-link" style="width: 50%;right:1px;border-left:1px #fe2 solid"><a href="/2025/08/07/AutoDL/">AutoDL教程 Prev →</a></div></div></div></div><div class="bottom-btn"><div><a class="i-top" id="to-top" onClick="scrolls.scrolltop();" title="To Top" style="opacity: 0; display: none;">∧ </a><a class="i-index" id="to-index" href="#toc-div" title="To Catalog">≡</a><a class="i-color" id="color-mode" onClick="colorMode.change()" title="Change Theme"></a></div></div></article><aside><div id="about"><a href="/" id="logo"><img src="https://ak.hypergryph.com/assets/index/images/ak/pc/faction/1.png" alt="Logo"></a><h1 id="Dr"><a href="/">Zenith</a></h1><div id="description"><p>未经审视的人生是不值得过的人生</p></div></div><div id="aside-block"><div id="toc-div"><h1>Catalog</h1><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#%E4%B8%80%E3%80%81%E5%90%84%E7%B1%BB%E5%A4%A7%E8%AF%AD%E8%A8%80%E6%A8%A1%E5%9E%8B%E6%8E%A5%E5%85%A5-LangChain"><span class="toc-number">1.</span> <span class="toc-text">一、各类大语言模型接入 LangChain</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E4%BA%8C%E3%80%81LangChain-%E6%A0%B8%E5%BF%83%E5%8A%9F%E8%83%BD-Chain-%E7%9A%84%E6%90%AD%E5%BB%BA"><span class="toc-number">2.</span> <span class="toc-text">二、LangChain 核心功能 Chain 的搭建</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E4%B8%89%E3%80%81LangChain-%E8%AE%B0%E5%BF%86%E5%AD%98%E5%82%A8%E4%B8%8E%E6%90%AD%E5%BB%BA%E5%A4%9A%E8%BD%AE%E5%AF%B9%E8%AF%9D%E6%9C%BA%E5%99%A8%E4%BA%BA"><span class="toc-number">3.</span> <span class="toc-text">三、LangChain 记忆存储与搭建多轮对话机器人</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%9B%9B%E3%80%81LangChain-%E6%8E%A5%E5%85%A5%E5%B7%A5%E5%85%B7%E6%B5%81%E7%A8%8B"><span class="toc-number">4.</span> <span class="toc-text">四、LangChain 接入工具流程</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E4%BA%94%E3%80%81LangChain-Agent%E8%BF%9B%E9%98%B6%E5%8A%9F%E8%83%BD%E4%BB%8B%E7%BB%8D"><span class="toc-number">5.</span> <span class="toc-text">五、LangChain Agent进阶功能介绍</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%85%AD%E3%80%81LangChain-%E6%8E%A5%E5%85%A5-MCP-%E6%8A%80%E6%9C%AF%E5%AE%9E%E7%8E%B0%E6%B5%81%E7%A8%8B"><span class="toc-number">6.</span> <span class="toc-text">六、LangChain 接入 MCP 技术实现流程</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E4%B8%83%E3%80%81LangChain-RAG%E7%9F%A5%E8%AF%86%E5%BA%93%E6%A3%80%E7%B4%A2%E7%B3%BB%E7%BB%9F%E5%BC%80%E5%8F%91"><span class="toc-number">7.</span> <span class="toc-text">七、LangChain RAG知识库检索系统开发</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%94%B1%E4%BA%8E%E8%BF%99%E4%B8%80%E9%83%A8%E5%88%86%E6%AF%94%E8%BE%83%E5%A4%8D%E6%9D%82%EF%BC%8C%E5%9B%A0%E6%AD%A4%E5%9C%A8%E8%BF%99%E4%BB%85%E7%BB%99%E5%87%BA%E7%A4%BA%E4%BE%8B%E4%BB%A3%E7%A0%81%EF%BC%8C%E5%90%8E%E7%BB%AD%E5%86%8D%E5%81%9A%E8%A1%A5%E5%85%85%EF%BC%88%E5%90%8E%E9%9D%A2%E7%9A%84%E5%86%85%E5%AE%B9%E6%9C%89%E9%9C%80%E8%A6%81%E5%8F%AF%E4%BB%A5%E7%9C%8B%EF%BC%8C%E4%B9%9F%E5%8F%AF%E4%BB%A5%E7%AD%89%E5%90%8E%E7%BB%AD%E7%BB%99%E5%87%BA%E6%9B%B4%E8%AF%A6%E7%BB%86%E7%9A%84%E6%95%99%E7%A8%8B%EF%BC%89"><span class="toc-number">7.1.</span> <span class="toc-text">由于这一部分比较复杂，因此在这仅给出示例代码，后续再做补充（后面的内容有需要可以看，也可以等后续给出更详细的教程）</span></a></li></ol></li></ol></div></div><footer><nobr><span class="icp-title">♖</span><a class="icp-content" href="https://smallgoodgood.top/about/">关于本站</a></nobr><br><nobr>Pubulished by <a href="http://smallgoodgood.top">Zenith <br></a></nobr><wbr><!-- 添加网站运行时间 --><span id="timeDate">载入天数...</span><span id="times">载入时分秒...</span><script>var now = new Date();

function createtime() {
  var grt = new Date("02/09/2024 00:00:00"); //此处修改你的建站时间或者网站上线时间 
  now.setTime(now.getTime() + 250);
  days = (now - grt) / 1000 / 60 / 60 / 24;
  dnum = Math.floor(days);
  hours = (now - grt) / 1000 / 60 / 60 - (24 * dnum);
  hnum = Math.floor(hours);
  if (String(hnum).length == 1) {
      hnum = "0" + hnum;
  }
  minutes = (now - grt) / 1000 / 60 - (24 * 60 * dnum) - (60 * hnum);
  mnum = Math.floor(minutes);
  if (String(mnum).length == 1) {
      mnum = "0" + mnum;
  }
  seconds = (now - grt) / 1000 - (24 * 60 * 60 * dnum) - (60 * 60 * hnum) - (60 * mnum);
  snum = Math.round(seconds);
  if (String(snum).length == 1) {
      snum = "0" + snum;
  }
  document.getElementById("timeDate").innerHTML = " | 本站已安全运行 " + dnum + " 天 ";
  document.getElementById("times").innerHTML = hnum + " 小时 " + mnum + " 分 " + snum + " 秒";
}
setInterval("createtime()", 250);
<!-- 添加网站运行时间 -->

</script></footer></aside></main><canvas id="canvas-dust"></canvas><script src="/live2dw/lib/L2Dwidget.min.js?094cbace49a39548bed64abff5988b05"></script><script>L2Dwidget.init({"model":{"jsonPath":"/live2dw/assets/hijiki.model.json"},"display":{"position":"left","width":150,"height":300},"mobile":{"show":true},"log":false,"pluginJsPath":"lib/","pluginModelPath":"assets/","pluginRootPath":"live2dw/","tagMode":false});</script></body></html>