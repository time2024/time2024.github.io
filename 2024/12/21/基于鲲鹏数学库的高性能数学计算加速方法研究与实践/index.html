<!DOCTYPE html><html lang="zh-CN" theme-mode="auto"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1.0"><title>基于鲲鹏数学库的高性能数学计算加速方法研究与实践 | Zenith</title><link rel="icon" type="image/x-icon" href="/favicon.ico"><link rel="preload" as="font" crossorigin="anonymous" href="/font/Bender.ttf"><link rel="preload" as="font" crossorigin="anonymous" href="/font/BenderLight.ttf"><link rel="preload" as="font" crossorigin="anonymous" href="/font/JetBrainsMono-Regular.woff2"><link rel="stylesheet" href="/css/arknights.css"><style>@font-face {
  font-family: Bender;
  src: local('Bender'), url("/font/Bender.ttf"), url("/font/Bender.otf");
}
@font-face {
  font-family: BenderLight;
  src: local('BenderLight'), url("/font/BenderLight.ttf");
}
@font-face {
  font-family: 'JetBrains Mono';
  src: local('JetBrains Mono'), url('/font/JetBrainsMono-Regular.woff2') format('woff2');
}
</style><script>var config = {"root":"/","search":{"preload":false,"activeHolder":"键入以继续","blurHolder":"数据检索","noResult":"无 $0 相关数据"},"code":{"codeInfo":"$0 - $1 行","copy":"复制"}}</script><link type="text/css" rel="stylesheet" href="/lib/encrypt/hbe.style.css"><script src="//unpkg.com/mermaid@10.5.0/dist/mermaid.min.js"></script><link type="text/css" rel="stylesheet" href="//unpkg.com/lightgallery@2.7.1/css/lightgallery.css"><link type="text/css" rel="stylesheet" href="//unpkg.com/lightgallery@2.7.1/css/lg-zoom.css"><link type="text/css" rel="stylesheet" href="//unpkg.com/lightgallery@2.7.1/css/lg-thumbnail.css"><link type="text/css" rel="stylesheet" href="/lib/fontawesome/css/all.min.css"><script>if (window.localStorage.getItem('theme-mode') === 'light' || window.matchMedia('(prefers-color-scheme:light)').matches)
 document.documentElement.setAttribute('theme-mode', 'light')
if (window.localStorage.getItem('theme-mode') === 'dark' || window.matchMedia('(prefers-color-scheme:dark)').matches)
 document.documentElement.setAttribute('theme-mode', 'dark')</script><style>@font-face {
 font-family: BenderLight;
 src: local('Bender'), url("/font/BenderLight.woff2") format('woff2');
}
@font-face {
 font-family: 'JetBrains Mono';
 src: local('JetBrains Mono'), url('/font/JetBrainsMono-Regular.woff2') format('woff2');
}</style><style>:root {
 --dark-background: url('/img/yellow.jpg');
 --light-background: url('/img/red.png');
 --theme-encrypt-confirm: '确认'
}</style><script defer src="/js/arknights.js"></script><script defer src="/js/search.js"></script><script defer type="module">import mermaid from '//unpkg.com/mermaid@10.5.0/dist/mermaid.esm.mjs';
window.mermaid = mermaid;
code.paintMermaid();
</script><script async src="//unpkg.com/lightgallery@2.7.1/lightgallery.min.js"></script><script async src="//unpkg.com/lightgallery@2.7.1/plugins/zoom/lg-zoom.min.js"></script><script async src="//unpkg.com/lightgallery@2.7.1/plugins/thumbnail/lg-thumbnail.min.js"></script><script async src="/lib/encrypt/hbe.js"></script><script async src="/js/pjax.js"></script><script class="pjax-js">reset= () => {document.querySelector('.lg-container')?.remove()
lightGallery(document.getElementById('post-bg'), {
  plugins: [lgZoom,lgThumbnail],
  selector: '.item-img'})}</script><script>window.addEventListener("load",() => {pjax = new Pjax({
 cacheBust: false,
 selectors: ['title','article','#aside-block','.pjax-js','data-pjax','.busuanzi'],
 switches: {'article': Pjax.switches.sideBySide},
 switchesOptions: {
   'article': {
     classNames: {
       remove: "pjax-out",
       add: "pjax-in"
     }
   }
 }
});
document.addEventListener("pjax:complete", reset);reset()})</script><script class="pjax-js">reset= () => {document.querySelector('.lg-container')?.remove()
lightGallery(document.getElementById('post-bg'), {
  plugins: [lgZoom,lgThumbnail],
  selector: '.item-img'})}</script><script>window.addEventListener("load",() => {pjax = new Pjax({
 cacheBust: false,
 selectors: ['title','article','#aside-block','.pjax-js'],
 switches: {'article': Pjax.switches.sideBySide},
 switchesOptions: {
   'article': {
     classNames: {
       remove: "pjax-out",
       add: "pjax-in"
     }
   }
 }
});
document.addEventListener("pjax:complete", reset);reset()})</script><meta name="description" content="本博客介绍了我撰写的《基于鲲鹏数学库的高性能数学计算加速方法研究与实践》"><meta property="og:description" content="本博客介绍了我撰写的《基于鲲鹏数学库的高性能数学计算加速方法研究与实践》"><link rel="canonical" href="https://smallgoodgood.top/2024/12/21/%E5%9F%BA%E4%BA%8E%E9%B2%B2%E9%B9%8F%E6%95%B0%E5%AD%A6%E5%BA%93%E7%9A%84%E9%AB%98%E6%80%A7%E8%83%BD%E6%95%B0%E5%AD%A6%E8%AE%A1%E7%AE%97%E5%8A%A0%E9%80%9F%E6%96%B9%E6%B3%95%E7%A0%94%E7%A9%B6%E4%B8%8E%E5%AE%9E%E8%B7%B5/"><meta name="generator" content="Hexo 7.3.0"><link rel="alternate" href="/rss.xml" title="Zenith" type="application/rss+xml">
</head><body><script>(function () {  
    var a_idx = 0;  
    window.onclick = function (event) {  
        var a = new Array("Σ","Σ","Σ","Σ","Σ","Σ","Σ","Σ","Σ","Σ","这一路上走走停停","顺着少年漂流的痕迹","迈出车站的前一刻","竟有些犹豫","不禁笑这近乡情怯","仍无法避免","而长野的天","依旧那么暖","风吹起了从前",
        "从前初识这世间","万般流连","看着天边似在眼前","也甘愿赴汤蹈火去走它一遍","如今走过这世间","万般流连","翻过岁月不同侧脸","措不及防闯入你的笑颜","我曾难自拔于世界之大",
        "也沉溺于其中梦话","不得真假 不做挣扎 不惧笑话","我曾将青春翻涌成她","也曾指尖弹出盛夏","心之所动 且就随缘去吧","逆着光行走 任风吹雨打","短短的路走走停停","也有了几分的距离",
        "不知抚摸的是故事","还是段心情","也许期待的不过是","与时间为敌","再次见到你","微凉晨光里","笑得很甜蜜","从前初识这世间","万般流连","看着天边似在眼前","也甘愿赴汤蹈火去走它一遍",
        "如今走过这世间","万般流连","翻过岁月不同侧脸","措不及防闯入你的笑颜","我曾难自拔于世界之大","也沉溺于其中梦话","不做真假 不做挣扎 不惧笑话","我曾将青春翻涌成她","也曾指尖弹出盛夏",
        "心之所动 且就随缘去吧","晚风吹起你鬓间的白发","抚平回忆留下的疤","你的眼中 明暗交杂 一笑生花","暮色遮住你蹒跚的步伐","走进床头藏起的画","画中的你 低着头说话","我仍感叹于世界之大",
        "也沉醉于儿时情话","不剩真假 不做挣扎 无谓笑话","我终将青春还给了她","连同指尖弹出的盛夏","心之所动 就随风去了","以爱之名 你还愿意吗"
        );  

        var heart = document.createElement("p"); // 创建p元素，这里从b改为p  
        heart.onselectstart = function() { return false; }; // 简化防止拖动的代码  

        document.body.appendChild(heart).textContent = a[a_idx]; // 使用textContent代替innerHTML，因为这里只是文本  
        a_idx = (a_idx + 1) % a.length;  
        heart.style.cssText = "position: fixed;left:-100%;"; // 初始位置  

        var f = 16, // 字体大小  
            x = event.clientX - f / 2, // 横坐标  
            y = event.clientY - f, // 纵坐标  
            c = randomColor(), // 随机颜色  
            a = 1, // 透明度  
            s = 1.2; // 放大缩小比例  

        var timer = setInterval(function () { // 添加定时器  
            if (a <= 0) {  
                document.body.removeChild(heart);  
                clearInterval(timer);  
            } else {  
                heart.style.cssText = "font-size:" + f + "px;cursor: default;position: fixed;color:" +  
                    c + ";left:" + x + "px;top:" + y + "px;opacity:" + a + ";transform:scale(" +  
                    s + ");";  

                y--;  
                a -= 0.016;  
                s += 0.002;  
            }  
        }, 15);  
    }  

    // 随机颜色函数  
    function randomColor() {  
        //- return "rgb(" + (~~(Math.random() * 255)) + "," + (~~(Math.random() * 255)) + "," + (~~(Math.random() * 255)) + ")";  
        return "(255,240,245)";
    }  
}());</script><div class="loading" style="opacity: 0;"><div class="loadingBar left"></div><div class="loadingBar right"></div></div><main><header class="closed"><div class="navBtn"><i class="navBtnIcon"><span class="navBtnIconBar"></span><span class="navBtnIconBar"></span><span class="navBtnIconBar"></span></i></div><nav><div class="navItem" id="search-header"><span class="navItemTitle"><input autocomplete="off" autocorrect="off" autocapitalize="none" placeholder="数据检索" spellcheck="false" maxlength="50" type="text" id="search-input"></span></div><div class="navItem" id="search-holder"></div><div class="search-popup" tabindex="0"><div id="search-result"></div></div><ol class="navContent"><li class="navItem"><a class="navBlock" href="/"><span class="navItemTitle">首页</span></a></li><li class="navItem"><a class="navBlock" href="/about"><span class="navItemTitle">关于</span></a></li><li class="navItem" matchdata="categories,tags"><a class="navBlock" href="/archives/"><span class="navItemTitle">归档</span></a></li><li class="navItem"><a class="navBlock" href="/chat-zenith"><span class="navItemTitle">AI</span></a></li><li class="navItem"><a class="navBlock" href="/answer"><span class="navItemTitle">答案之书</span></a></li></ol></nav></header><article><div id="post-bg"><div id="post-title"><h1>基于鲲鹏数学库的高性能数学计算加速方法研究与实践</h1><div id="post-info"><span>文章发布时间: <div class="control"><time datetime="2024-12-21T04:00:00.000Z" id="date"> 2024-12-21</time></div></span><br><span>最后更新时间: <div class="control"><time datetime="2025-09-22T03:14:12.269Z" id="updated"> 2025-09-22</time></div></span><br><span>文章总字数: <div class="control">10.2k</div></span><br><span>预计阅读时间: <div class="control">48 分钟</div></span></div></div><hr><div id="post-content"><p>本博客介绍了我撰写的《基于鲲鹏数学库的高性能数学计算加速方法研究与实践》<span id="more"></span>，因为实际操作过程截图涉及个人信息，故图片已被屏蔽</p>
<h1 id="基于鲲鹏数学库的高性能数学计算加速方法研究与实践"><a href="#基于鲲鹏数学库的高性能数学计算加速方法研究与实践" class="headerlink" title="基于鲲鹏数学库的高性能数学计算加速方法研究与实践"></a><strong>基于鲲鹏数学库的高性能数学计算加速方法研究与实践</strong></h1><h2 id="1-实验目的"><a href="#1-实验目的" class="headerlink" title="1 实验目的"></a>1 实验目的</h2><h3 id="1-验证鲲鹏数学库的性能优化效果"><a href="#1-验证鲲鹏数学库的性能优化效果" class="headerlink" title="1. 验证鲲鹏数学库的性能优化效果"></a>1. <strong>验证鲲鹏数学库的性能优化效果</strong></h3><ul>
<li><strong>核心目标</strong>：通过一系列数学计算实验，系统验证基于鲲鹏架构的 Kunpeng Math Library (KML) 相较传统实现方式的性能提升程度。</li>
<li>细化目标<ul>
<li>验证 KML 在不同数学计算任务中的加速效果，包括基础数学运算（如三角函数计算）、矩阵计算（如矩阵乘法）和高级线性代数问题（如特征值分解）。</li>
<li>比较 KML 在单线程和多线程模式下的性能表现，探索其并行能力。</li>
</ul>
</li>
</ul>
<h3 id="2-探索鲲鹏架构的硬件适配性"><a href="#2-探索鲲鹏架构的硬件适配性" class="headerlink" title="2. 探索鲲鹏架构的硬件适配性"></a>2. <strong>探索鲲鹏架构的硬件适配性</strong></h3><ul>
<li>硬件架构支持验证<ul>
<li>检验 KML 对鲲鹏处理器的硬件特性（如 SIMD 指令集、多核并行）和内存架构（如 L1&#x2F;L2 缓存优化）的适配程度。</li>
<li>探索基于 ARM 架构优化的数学库在高性能计算（HPC）场景中的实际表现。</li>
</ul>
</li>
<li>平台优势探索<ul>
<li>评估 KML 在典型计算任务（如矩阵运算、快速傅里叶变换）中对其他平台（如 x86 架构）的相对性能优势，为基于鲲鹏的数学计算方案提供参考。</li>
</ul>
</li>
</ul>
<h3 id="3-优化实际科学计算任务"><a href="#3-优化实际科学计算任务" class="headerlink" title="3. 优化实际科学计算任务"></a>3. <strong>优化实际科学计算任务</strong></h3><ul>
<li>面向工程计算和科学研究<ul>
<li>通过 KML 的高性能计算加速，解决实际工程和科研中的计算瓶颈问题。例如，优化数据分析、机器学习训练中的矩阵运算，加速信号处理中的傅里叶变换等。</li>
</ul>
</li>
<li>扩展应用场景<ul>
<li>在本实验中探索 KML 在不同任务中的适配性，为其在更多计算场景（如气象模拟、分子动力学模拟等）提供基础。</li>
</ul>
</li>
</ul>
<h3 id="4-提升鲲鹏生态的实践经验"><a href="#4-提升鲲鹏生态的实践经验" class="headerlink" title="4. 提升鲲鹏生态的实践经验"></a>4. <strong>提升鲲鹏生态的实践经验</strong></h3><ul>
<li>用户指导与案例积累<ul>
<li>总结使用 KML 的安装、配置、调试方法，以及在各类任务中的具体实现步骤，为开发者提供实践指南。</li>
<li>为鲲鹏生态的推广提供优化实践案例，进一步推动基于 ARM 架构的高性能计算技术在行业中的普及。</li>
</ul>
</li>
<li>性能优化经验总结<ul>
<li>通过对比实验，提炼出优化数学计算性能的经验，如向量化处理、多线程并行优化、内存管理优化等，为后续开发高效的数学计算程序提供理论和实践依据。</li>
</ul>
</li>
</ul>
<h3 id="5-评估性能与准确性的平衡"><a href="#5-评估性能与准确性的平衡" class="headerlink" title="5. 评估性能与准确性的平衡"></a>5. <strong>评估性能与准确性的平衡</strong></h3><ul>
<li>性能测试<ul>
<li>在数学运算中，尤其是高级运算（如特征值分解、快速傅里叶变换），性能与准确性可能存在一定平衡点。实验目标之一是分析 KML 在保持高精度的同时实现性能提升的能力。</li>
</ul>
</li>
<li>结果一致性验证<ul>
<li>确保使用 KML 计算的结果在科学研究或工程应用中具有可接受的准确性，并验证其与传统实现方式的一致性。</li>
</ul>
</li>
</ul>
<h3 id="6-推动数学计算领域的技术进步"><a href="#6-推动数学计算领域的技术进步" class="headerlink" title="6. 推动数学计算领域的技术进步"></a>6. <strong>推动数学计算领域的技术进步</strong></h3><ul>
<li>实践新算法<ul>
<li>利用鲲鹏架构和 KML 优化数学运算的能力，探索传统算法在新型硬件架构下的优化潜力。</li>
</ul>
</li>
<li>高性能计算的技术转化<ul>
<li>将 KML 的优势推广到实际的工业和学术计算任务中，为数学计算领域的技术进步提供支持。</li>
</ul>
</li>
</ul>
<h2 id="2-实验设备"><a href="#2-实验设备" class="headerlink" title="2 实验设备"></a>2 实验设备</h2><ul>
<li><p>华为鲲鹏云服务器；</p>
</li>
<li><p>具备网络连接的个人电脑。</p>
</li>
</ul>
<h2 id="3-实验原理"><a href="#3-实验原理" class="headerlink" title="3 实验原理"></a>3 实验原理</h2><h3 id="1-数学库优化的核心思想"><a href="#1-数学库优化的核心思想" class="headerlink" title="1. 数学库优化的核心思想"></a>1. <strong>数学库优化的核心思想</strong></h3><p>鲲鹏数学库（KML）的设计理念是通过充分利用硬件特性提升数学运算的性能。以下是其核心优化思想：</p>
<ul>
<li>指令级优化<ul>
<li>KML 借助 ARMv8 架构的 SIMD（Single Instruction Multiple Data）指令集，能够在单次指令操作中对多个数据元素进行并行处理，从而显著提升运算速度。</li>
<li>使用如 Neon 指令等优化数学函数（如三角函数、对数函数等）的批量处理能力。</li>
</ul>
</li>
<li>多线程并行<ul>
<li>通过 pthread 和 OpenMP 等多线程技术，KML 可高效分解计算任务，充分利用多核处理器的计算资源。</li>
</ul>
</li>
<li>内存访问优化<ul>
<li>避免频繁的内存读取与写入，通过对内存对齐、缓存友好型算法等优化策略，减少数据传输瓶颈。</li>
</ul>
</li>
</ul>
<h3 id="2-硬件架构与性能优化的关系"><a href="#2-硬件架构与性能优化的关系" class="headerlink" title="2. 硬件架构与性能优化的关系"></a>2. <strong>硬件架构与性能优化的关系</strong></h3><p>鲲鹏服务器基于 ARM 架构，具备以下硬件特性，KML 在设计时针对这些特性进行了针对性优化：</p>
<ul>
<li><strong>高密度核心</strong>： 鲲鹏处理器具有高核数的特点，非常适合高并发计算任务，KML 可在矩阵运算、FFT 中有效分摊任务到多个核心，降低单核压力。</li>
<li><strong>宽向量寄存器</strong>： ARM 的 SIMD 技术利用宽向量寄存器，使得多数据并行计算成为可能。例如，KML_SVML 的优化实现可一次性处理多个向量元素。</li>
<li><strong>内存子系统优化</strong>： 鲲鹏架构的 L1 和 L2 缓存对矩阵计算中常见的密集存储访问模式进行了专门优化。KML 的矩阵运算函数充分利用了这一特性，通过块状处理减少了内存访问延迟。</li>
</ul>
<h3 id="3-数学计算的多层次优化方法"><a href="#3-数学计算的多层次优化方法" class="headerlink" title="3. 数学计算的多层次优化方法"></a>3. <strong>数学计算的多层次优化方法</strong></h3><p>KML 的优化覆盖了从低级指令到高级数学库的多个层次：</p>
<ul>
<li><strong>基础数学函数优化</strong>： 优化基本数学函数（如三角函数、指数函数）的实现，通过硬件寄存器和流水线指令集实现批量处理。</li>
<li>BLAS 和 LAPACK 优化<ul>
<li><strong>BLAS</strong>：优化矩阵-向量运算、矩阵-矩阵运算等基础线性代数运算，广泛用于科学计算中。</li>
<li><strong>LAPACK</strong>：在更高级别的线性代数操作（如特征值问题、奇异值分解）中，KML 将关键计算步骤分解为高效的 BLAS 调用，并结合硬件特性进行细粒度优化。</li>
</ul>
</li>
<li><strong>快速傅里叶变换（FFT）</strong>： FFT 算法中涉及复杂的递归和循环结构，KML 通过流水线技术和分块计算优化了时间复杂度，同时减少了内存访问次数。</li>
</ul>
<h3 id="4-实验的对比设计与性能评估策略"><a href="#4-实验的对比设计与性能评估策略" class="headerlink" title="4. 实验的对比设计与性能评估策略"></a>4. <strong>实验的对比设计与性能评估策略</strong></h3><p>为了全面评估 KML 的性能，实验采用了“传统实现”和“优化实现”的对比方式：</p>
<ul>
<li><strong>传统实现</strong>：直接使用标准数学库（如 <code>math.h</code>）或手动实现算法，模拟常规的计算方式。</li>
<li><strong>优化实现</strong>：基于 KML 提供的库函数完成相同计算任务。</li>
<li>性能评估<ul>
<li><strong>时间复杂度</strong>：记录不同方法的执行时间，量化性能提升。</li>
<li><strong>准确性</strong>：验证 KML 的计算结果是否与传统实现一致，确保在优化性能的同时保证结果的可靠性。</li>
<li><strong>资源利用率</strong>：观察 CPU、内存的使用情况，分析 KML 如何在硬件资源利用上占据优势。</li>
</ul>
</li>
</ul>
<h3 id="5-典型优化场景"><a href="#5-典型优化场景" class="headerlink" title="5. 典型优化场景"></a>5. <strong>典型优化场景</strong></h3><ul>
<li><strong>矩阵运算</strong>： 矩阵计算（如矩阵-向量乘法、矩阵分解）是科学计算中的核心任务。KML 针对矩阵密集型计算进行了特殊优化，减少了循环嵌套带来的性能瓶颈。</li>
<li><strong>高维向量运算</strong>： 例如三角函数计算，普通实现逐元素计算效率低下，而 KML 利用向量化技术和批量计算方法，可显著加速处理大规模数据。</li>
<li><strong>特征值问题</strong>： 对称矩阵特征值与特征向量计算涉及复杂的迭代算法，KML 在 LAPACK 的基础上进一步优化了矩阵操作的并行性。</li>
</ul>
<h3 id="6-KML-的接口设计与易用性"><a href="#6-KML-的接口设计与易用性" class="headerlink" title="6. KML 的接口设计与易用性"></a>6. <strong>KML 的接口设计与易用性</strong></h3><ul>
<li><strong>动态库链接</strong>： 用户可通过简单的编译选项链接 KML 提供的动态库，从而快速完成性能优化。</li>
<li><strong>模块化功能</strong>： 不同的子模块（如 BLAS、VML、SPBLAS 等）满足了从基础运算到高级线性代数的多种需求，提供了良好的兼容性和可扩展性。</li>
</ul>
<h2 id="4-实验任务操作指导"><a href="#4-实验任务操作指导" class="headerlink" title="4 实验任务操作指导"></a>4 实验任务操作指导</h2><h3 id="4-1安装KML"><a href="#4-1安装KML" class="headerlink" title="4.1安装KML"></a>4.1安装KML</h3><p>下面介绍如何安装KML</p>
<p>首先使用远程登录工具，登录到鲲鹏 ECS 服务器上</p>
<p>下载 WinSCP 客户端并安装。</p>
<p>启动WinSCP，启动后界面如下：</p>
<p class='item-img' data-src=''><img src=""></p>
<span class="hide"><object><p>看不见是正常的，别担心</p></object></span>

<p>填写说明：</p>
<ul>
<li><p>协议：选填 SFTP 或者 SCP 均可。</p>
</li>
<li><p>主机名：云服务器的公网 IP。登录管理控制台即可查看对应云服务器的公网 IP。</p>
</li>
<li><p>端口：默认 22。</p>
</li>
<li><p>用户名：云服务器的用户名。</p>
</li>
<li><p>使用“SSH密钥方式”登录云服务器时：</p>
<ul>
<li><p>如果是“CoreOS”的公共镜像，用户名为“core”。</p>
</li>
<li><p>如果是“非CoreOS”的公共镜像，用户名为“root”。</p>
</li>
</ul>
</li>
<li><p>使用“密码方式”登录云服务器，公共镜像（包括CoreOS）的用户名为：root。</p>
</li>
<li><p>密码：购买云服务器设置的密码或通过密钥方式转化后的密码。</p>
</li>
<li><p>单击“登录”，进入 “WinSCP” 文件传输界面。</p>
</li>
<li><p>登录成功之后，您可以选择左侧本地计算机的文件，拖拽到右侧的远程云服务器，完成文件上传到云服务器。</p>
</li>
</ul>
<p>具体操作可以参考：</p>
<p>本地Windows主机使用WinSCP上传文件到Linux云服务器 <a target="_blank" rel="noopener" href="https://support.huaweicloud.com/ecs_faq/zh-cn_topic_0166284971.html">https://support.huaweicloud.com/ecs_faq/zh-cn_topic_0166284971.html</a></p>
<p> 然后到<a target="_blank" rel="noopener" href="https://www.hikunpeng.com/developer/boostkit/library/detail?subtab=%E6%95%B0%E5%AD%A6%E5%BA%93%E8%8E%B7%E5%8F%96KML%E8%BD%AF%E4%BB%B6%E5%8C%85%EF%BC%88GCC%E7%89%88%E6%9C%AC%EF%BC%89">https://www.hikunpeng.com/developer/boostkit/library/detail?subtab=%E6%95%B0%E5%AD%A6%E5%BA%93获取KML软件包（GCC版本）</a></p>
<p class='item-img' data-src=''><img src=""></p>
<span class="hide"><object><p>看不见是正常的，别担心</p></object></span>

<p class='item-img' data-src=''><img src=""></p>
<span class="hide"><object><p>看不见是正常的，别担心</p></object></span>

<p>下载软件包后解压得到此文件：</p>
<p class='item-img' data-src=''><img src=""></p>
<span class="hide"><object><p>看不见是正常的，别担心</p></object></span>

<p>再通过“本地Windows主机使用WinSCP上传文件到Linux云服务器<a target="_blank" rel="noopener" href="https://support.huaweicloud.com/ecs_faq/zh-cn_topic_0166284971.html%E2%80%9D%E4%B8%AD%E6%89%80%E8%BF%B0%E7%9A%84%E8%BF%9C%E7%A8%8B%E7%99%BB%E5%BD%95%E5%B0%86%E8%AF%A5%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0%E5%88%B0%E4%BA%91%E6%9C%8D%E5%8A%A1%E5%99%A8">https://support.huaweicloud.com/ecs_faq/zh-cn_topic_0166284971.html”中所述的远程登录将该文件上传到云服务器</a></p>
<p>接下来安装KML。</p>
<p>步骤1 登录云服务器，进入刚刚上传文件所在的目录，输入</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs c">rpm -ivh kml-xxxx.aarch64.rpm<br></code></pre></td></tr></table></figure>

<p>安装软件包，其中命令中涉及的xxxx代表版本号，下图示中的版本号是2.4.0-1</p>
<p class='item-img' data-src=''><img src=""> </p>
<span class="hide"><object><p>看不见是正常的，别担心</p></object></span>

<p>步骤 2 安装后验证</p>
<p>执行source命令或重新登录终端让环境变量生效。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs c">source /etc/profile<br></code></pre></td></tr></table></figure>

<p class='item-img' data-src=''><img src=""></p>
<span class="hide"><object><p>看不见是正常的，别担心</p></object></span>

<p>查看环境变量LD_LIBRARY_PATH是否包含KML的安装路径“&#x2F;usr&#x2F;local&#x2F;kml&#x2F;lib”。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs c">env | grep LD_LIBRARY_PATH<br></code></pre></td></tr></table></figure>

<p>如果变量包含安装路径，说明安装成功。</p>
<p class='item-img' data-src=''><img src=""></p>
<span class="hide"><object><p>看不见是正常的，别担心</p></object></span>

<p>安装成功后在安装路径（默认路径是“&#x2F;usr&#x2F;local&#x2F;kml”）下生成相应文件，其中，include文件夹包含子库的头文件，lib文件夹包含了数学库的动态库文件。</p>
<p class='item-img' data-src=''><img src=""></p>
<span class="hide"><object><p>看不见是正常的，别担心</p></object></span>

<p>使用时，请在GCC编译选项中添加动态库所在路径，链接需要使用的动态库文件，添加编译选项后用ldd命令检查程序依赖库是否准确链接。</p>
<p>若需要使用KML_BLAS请添加如下代码，此处对官方给出的代码进行适当修改以正常使用：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs plaintext">单线程不加锁版本：-L /usr/local/kml/lib/kblas/nolocking -lkblas -I /usr/local/kml/include -pthread<br>单线程加锁版本：-L /usr/local/kml/lib/kblas/locking -lkblas -I /usr/local/kml/include -pthread<br>pthread实现多线程版本：-L /usr/local/kml/lib/kblas/pthread -lkblas -I /usr/local/kml/include -pthread<br>OpenMP实现多线程版本：-L /usr/local/kml/lib/kblas/omp -lkblas -I /usr/local/kml/include -pthread<br></code></pre></td></tr></table></figure>
<p>若需要使用KML_VML请添加：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs c">单线程版本：-L /usr/local/kml/lib/kvml/single -lkvml -L /usr/local/kml/lib -lkm -I /usr/local/kml/include -lm<br>多线程版本：-L /usr/local/kml/lib/kvml/multi -lkvml -L /usr/local/kml/lib -lkm -I /usr/local/kml/include -lm -fopenmp<br></code></pre></td></tr></table></figure>
<p>若需要使用KML_SPBLAS请添加：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs c">单线程版本：-L /usr/local/kml/lib/kspblas/single -lkspblas -I /usr/local/kml/include -pthread<br>多线程版本：-L /usr/local/kml/lib/kspblas/multi -lkspblas -I /usr/local/kml/include -pthread<br></code></pre></td></tr></table></figure>
<p>若需要使用KML_FFT请添加：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs c">单精度版本：-L /usr/local/kml/lib -lkfftf -I /usr/local/kml/include -pthread<br>双精度版本：-L /usr/local/kml/lib -lkfft -I /usr/local/kml/include -pthread<br></code></pre></td></tr></table></figure>
<p>若需要使用KML_MATH请添加：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs c">高性能版本：-L /usr/local/kml/lib -lkm -lm -I /usr/local/kml/include -pthread<br>高精度版本：-L /usr/local/kml/lib -lkm_l9 -lm -I /usr/local/kml/include -pthread<br></code></pre></td></tr></table></figure>
<p>若需要使用KML_SVML请添加：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs c">-L /usr/local/kml/lib -lksvml -lm -I /usr/local/kml/include -pthread<br></code></pre></td></tr></table></figure>
<p>若需要使用KML_VSL请添加：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs c">-L /usr/local/kml/lib -lkvsl -I /usr/local/kml/include -pthread -lm<br></code></pre></td></tr></table></figure>
<p>若需要使用KML_LAPACK：</p>
<p>先生成完整的LAPACK，然后添加：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs c">export KML_LAPACK_ROOT=/usr/local/kml/lib<br>export ADAPT_ROOT=/home/lapack_adapt<br>export KML_BLAS_ROOT=/usr/local/kml/lib/kblas/omp<br>gcc test.c -o test -fopenmp -I $KML_LAPACK_ROOT/include/kml<span class="hljs-number">-0.3</span>.<span class="hljs-number">0</span> -L /usr/local/kml/lib -lklapack -L $ADAPT_ROOT -l:liblapack_adapt.a -L $KML_BLAS_ROOT -lkblas -lgfortran -lm -lkservice -I /usr/local/kml/include<br></code></pre></td></tr></table></figure>
<p>若需要使用KML_IPL请添加：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs c">-L /usr/local/kml/lib -lkipl -lklapack_full -L /usr/local/kml/lib/kblas/pthread -lkblas -lm -I /usr/local/kml/include -pthread<br></code></pre></td></tr></table></figure>
<p>若需要使用KML_SCALAPACK ：<br>先生成完整的SCALAPACK，然后添加：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs c"># 动态<br>gcc test.c -o app  -fopenmp -I /usr/local/kml/lib/kblas/omp/include/kml<span class="hljs-number">-0.3</span>.<span class="hljs-number">0</span> -L /usr/local/kml/lib -l:libkscalapack.a -L /home/scalapack_adapt -l:libscalapack_adapt.a -L /usr/local/kml/lib/kblas/omp -l kblas -L /usr/local/kml/lib  -l:libkservice.a -L /home/lapack_adapt -l:liblapack_adapt.a  -lm -I /usr/local/kml/include<br><br># 静态<br>export KML_LAPACK_ROOT=/usr/local/kml/lib<br>export ADAPT_ROOT=/home/scalapack_adapt<br>export KML_BLAS_ROOT=/usr/local/kml/lib/kblas/omp<br><br>gcc test.c -o app  -fopenmp -I $KML_LAPACK_ROOT/include/kml<span class="hljs-number">-0.3</span>.<span class="hljs-number">0</span> -L /usr/local/kml/lib -l:libkscalapack.a -L $ADAPT_ROOT -l:libscalapack_adapt.a -L $KML_BLAS_ROOT -L /home/lapack_adapt -l:liblapack_adapt.a -l:libkservice.a -lm -I /usr/local/kml/include<br></code></pre></td></tr></table></figure>

<p>下面给出两个基础的测试程序用于测试是否已经成功安装</p>
<p>使用mkdir创建文件夹FFTTEST，使用cd FFTTEST进入，vim test.c创建测试文件</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdio.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&quot;km.h&quot;</span></span><br><br><span class="hljs-type">int</span> <span class="hljs-title function_">main</span><span class="hljs-params">()</span><br>&#123;<br>    <span class="hljs-type">double</span> pi = <span class="hljs-built_in">acos</span>(<span class="hljs-number">-1</span>); <br>    <span class="hljs-comment">// typical usage </span><br>    <span class="hljs-type">double</span> a = pi/<span class="hljs-number">6</span>, b = <span class="hljs-number">1.0</span>, c = <span class="hljs-number">-3</span>*pi/<span class="hljs-number">4</span>, d = pi/<span class="hljs-number">3</span>; <br>    <span class="hljs-comment">// print result </span><br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;sin(pi/6) = %.15f\n&quot;</span>, <span class="hljs-built_in">sin</span>(a)); <br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;sin(1.0) = %.15f\n&quot;</span>, <span class="hljs-built_in">sin</span>(b)); <br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;sin(-3*pi/4) = %.15f\n&quot;</span>, <span class="hljs-built_in">sin</span>(c)); <br>     <span class="hljs-comment">/* </span><br><span class="hljs-comment">     *  sin(pi/6) = 0.500000000000000 </span><br><span class="hljs-comment">     *  sin(1.0) = 0.841470984807897 </span><br><span class="hljs-comment">     *  sin(-3*pi/4) = -0.707106781186548 </span><br><span class="hljs-comment">     *  sin(pi/3) = 0.866025403784438 </span><br><span class="hljs-comment">     * */</span><br>        <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>利用</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs c">gcc test.c -I /usr/local/kml/include -L /usr/local/kml/lib -lkm_l9 -lm<br></code></pre></td></tr></table></figure>

<p>编译，生成a.out</p>
<p class='item-img' data-src=''><img src=""></p>
<span class="hide"><object><p>看不见是正常的，别担心</p></object></span>

<p>输入</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs c">./a.out<br></code></pre></td></tr></table></figure>

<p>运行，结果如下</p>
<p class='item-img' data-src=''><img src=""></p>
<span class="hide"><object><p>看不见是正常的，别担心</p></object></span>

<p>接下来尝试用牛顿迭代法求解非线性方程的根</p>
<p>依次执行命令 mkdir NEWTON、cd NEWTON 创建并进入到 NEWTON 目录。</p>
<p>创建 sum.c 文件，编写内容如下：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">//牛顿迭代法求解非线性方程的根</span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdio.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&quot;km.h&quot;</span></span><br><span class="hljs-type">double</span> <span class="hljs-title function_">f</span><span class="hljs-params">(<span class="hljs-type">double</span> x)</span> <br>&#123;<br>    <span class="hljs-keyword">return</span> x * x - <span class="hljs-number">2</span>; <span class="hljs-comment">// 函数 f(x) = x^2 - 2</span><br>&#125;<br><span class="hljs-type">double</span> <span class="hljs-title function_">df</span><span class="hljs-params">(<span class="hljs-type">double</span> x)</span> <br>&#123;<br>    <span class="hljs-keyword">return</span> <span class="hljs-number">2</span> * x; <span class="hljs-comment">// 函数的导数 f&#x27;(x) = 2x</span><br>&#125;<br><span class="hljs-type">double</span> <span class="hljs-title function_">newton</span><span class="hljs-params">(<span class="hljs-type">double</span> initial_guess, <span class="hljs-type">double</span> tolerance, <span class="hljs-type">int</span> max_iterations)</span><br> &#123;<br>    <span class="hljs-type">double</span> x = initial_guess;<br>    <span class="hljs-type">int</span> iteration = <span class="hljs-number">0</span>;<br>    <br>    <span class="hljs-keyword">while</span> (iteration &lt; max_iterations) &#123;<br>        <span class="hljs-type">double</span> fx = f(x);<br>        <span class="hljs-keyword">if</span> (<span class="hljs-built_in">fabs</span>(fx) &lt; tolerance) &#123;<br>            <span class="hljs-keyword">return</span> x; <span class="hljs-comment">// 找到根，返回当前值</span><br>        &#125;<br><span class="hljs-type">double</span> dfx = df(x);<br>        <span class="hljs-keyword">if</span> (dfx == <span class="hljs-number">0</span>) &#123;<br>            <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;Error: Derivative is zero. No solution found.\n&quot;</span>);<br>            <span class="hljs-keyword">return</span> x; <span class="hljs-comment">// 导数为零，无法继续</span><br>        &#125; <br>        x = x - fx / dfx; <span class="hljs-comment">// 牛顿迭代公式</span><br>        iteration++;<br>    &#125;<br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;Max iterations reached. Last approximation: %f\n&quot;</span>, x);<br>    <span class="hljs-keyword">return</span> x; <span class="hljs-comment">// 返回最后的近似值</span><br>&#125;<br><span class="hljs-type">int</span> <span class="hljs-title function_">main</span><span class="hljs-params">()</span> &#123;<br>    <span class="hljs-type">double</span> initial_guess = <span class="hljs-number">1.0</span>; <span class="hljs-comment">// 初始猜测</span><br>    <span class="hljs-type">double</span> tolerance = <span class="hljs-number">1e-7</span>; <span class="hljs-comment">// 容忍度</span><br>    <span class="hljs-type">int</span> max_iterations = <span class="hljs-number">100</span>; <span class="hljs-comment">// 最大迭代次数</span><br>    <span class="hljs-type">double</span> root;<br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;With KML:\n&quot;</span>);<br>    root = newton(initial_guess, tolerance, max_iterations);<br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;Root found: %f\n&quot;</span>, root);<br>    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>输入</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs c">gcc NEWTON_KML.c -I /usr/local/kml/include -L /usr/local/kml/lib -lkm -lm -o NEWTON_KML<br>./NEWTON_KML<br></code></pre></td></tr></table></figure>

<p>运行之，结构如下：</p>
<p class='item-img' data-src=''><img src=""></p>
<span class="hide"><object><p>看不见是正常的，别担心</p></object></span>

<p>至此说明kml安装成功</p>
<h3 id="4-2-矩阵-向量乘加运算对比实验"><a href="#4-2-矩阵-向量乘加运算对比实验" class="headerlink" title="4.2 矩阵-向量乘加运算对比实验"></a>4.2 矩阵-向量乘加运算对比实验</h3><p>该代码主要进行了如下工作：初始化规模为1000*300的矩阵A，长度为300的向量x，长度为1000的向量y1和y2。分别用两种方法求矩阵-向量乘加运算，即y&#x3D;alpha*A*x+beta*y： </p>
<p>（1）按照矩阵-向量的乘加规则实现算法求解 </p>
<p>（2）调用KML_BLAS提供的函数cblas_dgemv求解 分别用计时器记录两种方法消耗的时间，对比KML_BLAS与手动实现矩阵乘加的性能。 </p>
<p>编写代码如下：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">include</span><span class="hljs-string">&lt;stdio.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span><span class="hljs-string">&lt;time.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&quot;kblas.h&quot;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> M 1000</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> N 300</span><br><span class="hljs-type">int</span> <span class="hljs-title function_">main</span><span class="hljs-params">()</span><br>&#123;<br>    <span class="hljs-type">double</span> A[M*N]=&#123;<span class="hljs-number">0</span>&#125;;<br><span class="hljs-type">double</span> x[N]=&#123;<span class="hljs-number">0</span>&#125;;<br><span class="hljs-type">double</span> y1[M]=&#123;<span class="hljs-number">0</span>&#125;;<br><span class="hljs-type">double</span> y2[M]=&#123;<span class="hljs-number">0</span>&#125;;<br><span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> i=<span class="hljs-number">0</span>;i&lt;M*N;i++)<br>&#123;<br>   A[i]=i;<br>&#125;<br><span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> i=<span class="hljs-number">0</span>;i&lt;N;i++)<br>&#123;<br>   x[i]=i;<br>&#125;<br><span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> i=<span class="hljs-number">0</span>;i&lt;M;i++)<br>&#123;<br>   y1[i]=<span class="hljs-number">1</span>;<br>   y2[i]=<span class="hljs-number">1</span>;<br>&#125; <br><span class="hljs-type">double</span> alpha=<span class="hljs-number">1.2</span>;<br><span class="hljs-type">double</span> beta=<span class="hljs-number">2.5</span>;<br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">timespec</span> <span class="hljs-title">t1</span>,<span class="hljs-title">t2</span>;</span>    <span class="hljs-comment">//定义初始与结束时间</span><br><span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;Without KML:\n&quot;</span>);<br>clock_gettime(CLOCK_MONOTONIC,&amp;t1);      <span class="hljs-comment">//计算开始时间。</span><br><span class="hljs-keyword">for</span>(<span class="hljs-type">int</span> i=<span class="hljs-number">0</span>;i&lt;M;i++)<br>&#123;<br>   <span class="hljs-type">double</span> tmp=<span class="hljs-number">0</span>;<br>    <span class="hljs-keyword">for</span>(<span class="hljs-type">int</span> j=<span class="hljs-number">0</span>;j&lt;N;j++)<br>    &#123;<br>         tmp+=(A[i*N+j]*x[j]);<br>    &#125;<br>    y1[i]=alpha*tmp+beta*y1[i];<br>&#125;<br>clock_gettime(CLOCK_MONOTONIC,&amp;t2);    <span class="hljs-comment">//计算结束时间。</span><br><span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;Time:%11u ns\n&quot;</span>,t2.tv_nsec-t1.tv_nsec);  <br><span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;With KML:\n&quot;</span>);<br>clock_gettime(CLOCK_MONOTONIC,&amp;t1);      <span class="hljs-comment">//计算开始时间。</span><br>cblas_dgemv(CblasColMajor,CblasNoTrans, M, N, alpha, A, M, x, <span class="hljs-number">1</span>, beta, y2, <span class="hljs-number">1</span>); <br>clock_gettime(CLOCK_MONOTONIC,&amp;t2);    <span class="hljs-comment">//计算结束时间。</span><br><span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;Time:%11u ns\n&quot;</span>,t2.tv_nsec-t1.tv_nsec);  <br><br><span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br><br>&#125;<br></code></pre></td></tr></table></figure>

<p>输入：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs c">gcc kblas.c -o kblas -L /usr/local/kml/lib/kblas/nolocking -lkblas -I /usr/local/kml/include<br></code></pre></td></tr></table></figure>

<p>运行之，得到运行结果如下：</p>
<p class='item-img' data-src=''><img src=""></p>
<span class="hide"><object><p>看不见是正常的，别担心</p></object></span>

<p>可知KML_BLAS提供的函数cblas_dgemv对矩阵-向量乘加运算的优化效果十分显著</p>
<h3 id="4-3-调用KML-VML库计算100000个数的sin值和普通循环对比体现优化"><a href="#4-3-调用KML-VML库计算100000个数的sin值和普通循环对比体现优化" class="headerlink" title="4.3 调用KML_VML库计算100000个数的sin值和普通循环对比体现优化"></a>4.3 调用KML_VML库计算100000个数的sin值和普通循环对比体现优化</h3><p>使用多线程版本</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">include</span><span class="hljs-string">&lt;stdio.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span><span class="hljs-string">&lt;time.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span><span class="hljs-string">&lt;math.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span><span class="hljs-string">&quot;kvml.h&quot;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> LEN 100000</span><br><br><span class="hljs-type">int</span> <span class="hljs-title function_">main</span><span class="hljs-params">()</span><br>&#123;<br>   <span class="hljs-type">double</span> src[LEN]=&#123;<span class="hljs-number">0</span>&#125;;<br>   <span class="hljs-type">double</span> dst1[LEN]=&#123;<span class="hljs-number">0</span>&#125;;<br>   <span class="hljs-type">double</span> dst2[LEN]=&#123;<span class="hljs-number">0</span>&#125;;<br>   <span class="hljs-keyword">for</span>(<span class="hljs-type">int</span> i=<span class="hljs-number">0</span>;i&lt;LEN;i++)<br>       src[i]=i;<br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">timespec</span> <span class="hljs-title">t1</span>,<span class="hljs-title">t2</span>;</span>    <span class="hljs-comment">//定义初始与结束时间</span><br><br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;Without KML_VML &quot;</span>);<br>    clock_gettime(CLOCK_MONOTONIC,&amp;t1);      <span class="hljs-comment">//计算开始时间。</span><br>    <span class="hljs-keyword">for</span>(<span class="hljs-type">int</span> i=<span class="hljs-number">0</span>;i&lt;LEN;i++)<br>       dst1[i]=<span class="hljs-built_in">sin</span>(src[i]);<br>    clock_gettime(CLOCK_MONOTONIC,&amp;t2);    <span class="hljs-comment">//计算结束时间。</span><br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;Time:%11u ns\n&quot;</span>,t2.tv_nsec-t1.tv_nsec);  <span class="hljs-comment">//得出目标代码段的执行时间。</span><br><br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;With KML_VML &quot;</span>);<br>    clock_gettime(CLOCK_MONOTONIC,&amp;t1);      <span class="hljs-comment">//计算开始时间。</span><br>    vdsin(LEN,src,dst2);<br>    clock_gettime(CLOCK_MONOTONIC,&amp;t2);    <span class="hljs-comment">//计算结束时间。</span><br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;Time:%11u ns\n&quot;</span>,t2.tv_nsec-t1.tv_nsec);  <span class="hljs-comment">//得出目标代码段的执行时间。</span><br><br><span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br><br>&#125;<br></code></pre></td></tr></table></figure>

<p>输入</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs c">gcc vsin.c -o vsin -L /usr/local/kml/lib/kvml/multi -lkvml -L /usr/local/kml/lib -lkm -I /usr/local/kml/include -lm -fopenmp<br>./vsin<br></code></pre></td></tr></table></figure>

<p>运行结果如下所示：</p>
<p class='item-img' data-src=''><img src=""></p>
<span class="hide"><object><p>看不见是正常的，别担心</p></object></span>

<p>可知KML_VML库对三角函数运算的优化效果十分显著</p>
<h3 id="4-4-体现LAPACK库性能的对比实验"><a href="#4-4-体现LAPACK库性能的对比实验" class="headerlink" title="4.4 体现LAPACK库性能的对比实验"></a>4.4 体现LAPACK库性能的对比实验</h3><p>首先要生成完整的LAPACK用到的脚本</p>
<p>接下来的程序需要脚本才能正确运行</p>
<p>在&#x2F;home目录下创建sh.sh文件，接着编写如下代码：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-built_in">set</span> -eE<br><br>echo <span class="hljs-string">&quot;LAPACK_SRC_DIR         $&#123;LAPACK_SRC_DIR:-&lt;undefined&gt;&#125;&quot;</span><br>echo <span class="hljs-string">&quot;LAPACK_TGZ             $&#123;LAPACK_TGZ:=/home/lapack-3.12.0.tar.gz&#125;&quot;</span><br>echo <span class="hljs-string">&quot;LIBKLAPACK_A           $&#123;LIBKLAPACK_A:=/usr/local/kml/lib/libklapack.a&#125;&quot;</span><br>echo <span class="hljs-string">&quot;LIBKSERVICE_A          $&#123;LIBKSERVICE_A:=$&#123;LIBKLAPACK_A/klapack/kservice&#125;&#125;&quot;</span><br>echo <span class="hljs-string">&quot;ADAPT_DIR              $&#123;ADAPT_DIR:=./lapack_adapt&#125;&quot;</span><br>echo <span class="hljs-string">&quot;CMAKE_BUILD_TYPE       $&#123;CMAKE_BUILD_TYPE:=Release&#125;&quot;</span><br>echo <span class="hljs-string">&quot;LIBLAPACK_ADAPT_A      $&#123;LIBLAPACK_ADAPT_A:=liblapack_adapt.a&#125;&quot;</span><br>echo <span class="hljs-string">&quot;LIBKLAPACK_FULL_SO     $&#123;LIBKLAPACK_FULL_SO:=libklapack_full.so&#125;&quot;</span><br>echo <span class="hljs-string">&quot;CC                     $&#123;CC:=gcc&#125;&quot;</span><br>echo <span class="hljs-string">&quot;FC                     $&#123;FC:=gfortran&#125;&quot;</span><br><br>mkdir -p $&#123;ADAPT_DIR&#125;ZQ<br>cd $&#123;ADAPT_DIR&#125;<br><br><span class="hljs-meta"># build netlib lapack</span><br><span class="hljs-keyword">if</span> [ ! -r <span class="hljs-string">&quot;$&#123;LAPACK_SRC_DIR&#125;/CMakeLists.txt&quot;</span> ]; then<br>    mkdir -p <span class="hljs-title function_">netlib</span><br>    <span class="hljs-params">( cd netlib ; tar xzpf $&#123;LAPACK_TGZ&#125; )</span><br>    LAPACK_SRC_DIR=$(cd netlib/l* ; pwd)<br>fi<br><br>mkdir -p build<br>cmake_flags=(<br>    -DCMAKE_BUILD_TYPE=$&#123;CMAKE_BUILD_TYPE&#125;<br>    -DCMAKE_POSITION_INDEPENDENT_CODE=ON<br>    -DCMAKE_C_COMPILER=$&#123;CC&#125;<br>    -DCMAKE_Fortran_COMPILER=$&#123;FC&#125;<br>    -DCMAKE_RULE_MESSAGES=off<br>    -DBUILD_DEPRECATED=on<br>    -DBUILD_TESTING=off<br>)<br>( cd build ; cmake $&#123;cmake_flags[*]&#125; $&#123;LAPACK_SRC_DIR&#125; )<br>( cd build ; make -j )<br><br>cp build/lib/liblapack.a $&#123;LIBLAPACK_ADAPT_A&#125;<br><br><span class="hljs-meta"># get symbols defined both in klapack and netlib lapack</span><br>nm -g $&#123;LIBLAPACK_ADAPT_A&#125; | grep <span class="hljs-string">&#x27;T &#x27;</span> | grep -oP <span class="hljs-string">&#x27;\K\w+(?=_$)&#x27;</span> | sort | uniq &gt; netlib.sym<br>nm -g $&#123;LIBKLAPACK_A&#125; | grep <span class="hljs-string">&#x27;T &#x27;</span> | grep -oP <span class="hljs-string">&#x27;\K\w+(?=_$)&#x27;</span> | sort | uniq &gt; klapack.sym<br>comm <span class="hljs-number">-12</span> klapack.sym netlib.sym &gt; comm.sym<br><br><span class="hljs-meta"># update symbols name of $&#123;LIBLAPACK_ADAPT_A&#125;</span><br><span class="hljs-keyword">while</span> read sym; <span class="hljs-keyword">do</span><br>    (<br>        <span class="hljs-keyword">if</span> ! nm $&#123;LIBLAPACK_ADAPT_A&#125; | grep -qe <span class="hljs-string">&quot; T $&#123;sym&#125;_\$&quot;</span>; then<br>            <span class="hljs-keyword">continue</span><br>        fi<br>        ar x $&#123;LIBLAPACK_ADAPT_A&#125; $&#123;sym&#125;.f.o<br>        mv $&#123;sym&#125;.f.o $&#123;sym&#125;_netlib.f.o<br><br>        objcopy --redefine-sym $&#123;sym&#125;_=$&#123;sym&#125;_netlib_ $&#123;sym&#125;_netlib.f.o<br>    ) &amp;<br>done &lt; comm.sym<br>wait<br>ar d $&#123;LIBLAPACK_ADAPT_A&#125; $(sed -ne <span class="hljs-string">&#x27;s/$/.f.o/p&#x27;</span> comm.sym)<br>ar d $&#123;LIBLAPACK_ADAPT_A&#125; xerbla.f.o<br>ar ru $&#123;LIBLAPACK_ADAPT_A&#125; *_netlib.f.o<br>rm *_netlib.f.o<br></code></pre></td></tr></table></figure>

<p>在&#x2F;home目录下输入</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs c">sh sh.sh<br></code></pre></td></tr></table></figure>

<p>运行之，得到如下结果：</p>
<p class='item-img' data-src=''><img src=""></p>
<span class="hide"><object><p>看不见是正常的，别担心</p></object></span>

<p class='item-img' data-src=''><img src=""></p>
<span class="hide"><object><p>看不见是正常的，别担心</p></object></span>

<p>至此LAPACK用到的脚本已经生成完毕</p>
<p>接下来先展示如何使用一般c语言代码计算实对称矩阵的特征值与特征向量</p>
<p>编写eigenNoOpt.c文件，文件内容如下：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">include</span><span class="hljs-string">&lt;stdio.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span><span class="hljs-string">&lt;stdlib.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span><span class="hljs-string">&lt;math.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span><span class="hljs-string">&lt;time.h&gt;</span></span><br><br><span class="hljs-type">float</span>** <span class="hljs-title function_">Matrix_Jac_Eig</span><span class="hljs-params">(<span class="hljs-type">float</span> **<span class="hljs-built_in">array</span>, <span class="hljs-type">int</span> n, <span class="hljs-type">float</span> *eig)</span>;<br><span class="hljs-type">int</span> <span class="hljs-title function_">Matrix_Free</span><span class="hljs-params">(<span class="hljs-type">float</span> **tmp, <span class="hljs-type">int</span> m, <span class="hljs-type">int</span> n)</span>;<br><span class="hljs-type">int</span> <span class="hljs-title function_">main</span><span class="hljs-params">(<span class="hljs-type">void</span>)</span><br>&#123;<br>    <span class="hljs-type">int</span> n;<br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;请输入矩阵维度:\n&quot;</span>);<br>    <span class="hljs-built_in">scanf</span>(<span class="hljs-string">&quot;%d&quot;</span>, &amp;n);<br>    <span class="hljs-type">float</span> **<span class="hljs-built_in">array</span> = (<span class="hljs-type">float</span> **)<span class="hljs-built_in">malloc</span>(n * <span class="hljs-keyword">sizeof</span>(<span class="hljs-type">float</span> *));<br>    <span class="hljs-keyword">if</span> (<span class="hljs-built_in">array</span> == <span class="hljs-literal">NULL</span>)<br>    &#123;<br>        <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;error :申请数组内存空间失败\n&quot;</span>);<br>        <span class="hljs-keyword">return</span> <span class="hljs-number">-1</span>;<br>    &#125;<br>    <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> i = <span class="hljs-number">0</span>; i &lt; n; i++)<br>    &#123;<br>        <span class="hljs-built_in">array</span>[i] = (<span class="hljs-type">float</span> *)<span class="hljs-built_in">malloc</span>(n * <span class="hljs-keyword">sizeof</span>(<span class="hljs-type">float</span>));<br>        <span class="hljs-keyword">if</span> (<span class="hljs-built_in">array</span>[i] == <span class="hljs-literal">NULL</span>)<br>        &#123;<br>            <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;error :申请数组子内存空间失败\n&quot;</span>);<br>            <span class="hljs-keyword">return</span> <span class="hljs-number">-1</span>;<br>        &#125;<br>    &#125;<br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;请输入矩阵元素:\n&quot;</span>);<br>    <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> i = <span class="hljs-number">0</span>; i &lt; n; i++)<br>    &#123;<br>        <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> j = <span class="hljs-number">0</span>; j &lt; n; j++)<br>        &#123;<br>            <span class="hljs-built_in">scanf</span>(<span class="hljs-string">&quot;%f&quot;</span>, &amp;<span class="hljs-built_in">array</span>[i][j]);<br>        &#125;<br>    &#125;<br>    <span class="hljs-type">float</span> *eig = (<span class="hljs-type">float</span> *)<span class="hljs-built_in">malloc</span>(n * <span class="hljs-keyword">sizeof</span>(<span class="hljs-type">float</span>));<br>    <br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">timespec</span> <span class="hljs-title">t1</span>,<span class="hljs-title">t2</span>;</span><br><br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;Without KML:\n&quot;</span>);<br>    clock_gettime(CLOCK_MONOTONIC,&amp;t1);      <span class="hljs-comment">//计算开始时间。</span><br>    <span class="hljs-type">float</span> **Result = Matrix_Jac_Eig(<span class="hljs-built_in">array</span>, n, eig);<br>    clock_gettime(CLOCK_MONOTONIC,&amp;t2);    <span class="hljs-comment">//计算结束时间。</span><br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;Time:%11u ns\n&quot;</span>,t2.tv_nsec-t1.tv_nsec);  <br><br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;特征矩阵元素:\n&quot;</span>);<br>    <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> i = <span class="hljs-number">0</span>; i &lt; n; i++)<br>    &#123;<br>        <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> j = <span class="hljs-number">0</span>; j &lt; n; j++)<br>        &#123;<br>            <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;%f &quot;</span>, Result[i][j]);<br>        &#125;<br>        <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;\n&quot;</span>);<br>    &#125;<br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;特征根:\n&quot;</span>);<br>    <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> i = <span class="hljs-number">0</span>; i &lt; n; i++)<br>    &#123;<br>        <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;%f \n&quot;</span>, eig[i]);<br>    &#125;<br>    Matrix_Free(Result, n, n);<br>    <span class="hljs-built_in">free</span>(eig);<br>    eig = <span class="hljs-literal">NULL</span>;<br>    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>&#125;<br><span class="hljs-type">float</span>** <span class="hljs-title function_">Matrix_Jac_Eig</span><span class="hljs-params">(<span class="hljs-type">float</span> **<span class="hljs-built_in">array</span>, <span class="hljs-type">int</span> n, <span class="hljs-type">float</span> *eig)</span><br>&#123;<br>    <span class="hljs-type">int</span> i, j, flag, k;<br>    flag = <span class="hljs-number">0</span>;<br>    k = <span class="hljs-number">0</span>;<br>    <span class="hljs-type">float</span> sum = <span class="hljs-number">0</span>;<br>    <span class="hljs-type">float</span> **temp_mat = (<span class="hljs-type">float</span> **)<span class="hljs-built_in">malloc</span>(n * <span class="hljs-keyword">sizeof</span>(<span class="hljs-type">float</span> *));<br>    <span class="hljs-keyword">for</span> (i = <span class="hljs-number">0</span>; i &lt; n; i++)<br>    &#123;<br>        temp_mat[i] = (<span class="hljs-type">float</span> *)<span class="hljs-built_in">malloc</span>(n * <span class="hljs-keyword">sizeof</span>(<span class="hljs-type">float</span>));<br>    &#125;<br>    <span class="hljs-keyword">for</span> (i = <span class="hljs-number">0</span>; i &lt; n; i++)<br>    &#123;<br>        <span class="hljs-keyword">for</span> (j = <span class="hljs-number">0</span>; j &lt; n; j++)<br>        &#123;<br>            temp_mat[i][j] = <span class="hljs-built_in">array</span>[i][j];<br>        &#125;<br>    &#125;<br>    <span class="hljs-comment">//判断是否为对称矩阵</span><br>    <span class="hljs-keyword">for</span> (i = <span class="hljs-number">0</span>; i &lt; n; i++)<br>    &#123;<br>        <span class="hljs-keyword">for</span> (j = i; j &lt; n; j++)<br>        &#123;<br>            <span class="hljs-keyword">if</span> (<span class="hljs-built_in">array</span>[i][j] != <span class="hljs-built_in">array</span>[j][i])<br>            &#123;<br>                flag = <span class="hljs-number">1</span>;<br>                <span class="hljs-keyword">break</span>;<br>            &#125;<br>        &#125;<br>    &#125;<br>    <span class="hljs-keyword">if</span> (flag == <span class="hljs-number">1</span>)<br>    &#123;<br>        <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;error in Matrix_Eig: 输入并非是对称矩阵:\n&quot;</span>);<br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">NULL</span>;<br>    &#125;<br>    <span class="hljs-keyword">else</span><br>    &#123;<br>        <span class="hljs-comment">//开始执行算法</span><br>        <span class="hljs-type">int</span> p, q;<br>        <span class="hljs-type">float</span> thresh = <span class="hljs-number">0.0000000001</span>;<br>        <span class="hljs-type">float</span> max = <span class="hljs-built_in">array</span>[<span class="hljs-number">0</span>][<span class="hljs-number">1</span>];<br>        <span class="hljs-type">float</span> tan_angle, sin_angle, cos_angle;<br>        <span class="hljs-type">float</span> **result = (<span class="hljs-type">float</span> **)<span class="hljs-built_in">malloc</span>(n * <span class="hljs-keyword">sizeof</span>(<span class="hljs-type">float</span> *));<br>        <span class="hljs-keyword">if</span> (result == <span class="hljs-literal">NULL</span>)<br>        &#123;<br>            <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;error in Matrix_Eig:申请空间失败\n&quot;</span>);<br>            <span class="hljs-keyword">return</span> <span class="hljs-literal">NULL</span>;<br>        &#125;<br>        <span class="hljs-type">float</span> **result_temp = (<span class="hljs-type">float</span> **)<span class="hljs-built_in">malloc</span>(n * <span class="hljs-keyword">sizeof</span>(<span class="hljs-type">float</span> *));<br>        <span class="hljs-keyword">if</span> (result_temp == <span class="hljs-literal">NULL</span>)<br>        &#123;<br>            <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;error in Matrix_Eig:申请空间失败\n&quot;</span>);<br>            <span class="hljs-keyword">return</span> <span class="hljs-literal">NULL</span>;<br>        &#125;<br>        <span class="hljs-type">float</span> **rot = (<span class="hljs-type">float</span> **)<span class="hljs-built_in">malloc</span>(n * <span class="hljs-keyword">sizeof</span>(<span class="hljs-type">float</span> *));<br>        <span class="hljs-keyword">if</span> (rot == <span class="hljs-literal">NULL</span>)<br>        &#123;<br>            <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;error in Matrix_Eig:申请空间失败\n&quot;</span>);<br>            <span class="hljs-keyword">return</span> <span class="hljs-literal">NULL</span>;<br>        &#125;<br>        <span class="hljs-type">float</span> **mat = (<span class="hljs-type">float</span> **)<span class="hljs-built_in">malloc</span>(n * <span class="hljs-keyword">sizeof</span>(<span class="hljs-type">float</span> *));<br>        <span class="hljs-keyword">if</span> (mat == <span class="hljs-literal">NULL</span>)<br>        &#123;<br>            <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;error in Matrix_Eig:申请空间失败\n&quot;</span>);<br>            <span class="hljs-keyword">return</span> <span class="hljs-literal">NULL</span>;<br>        &#125;<br>        <span class="hljs-keyword">for</span> (i = <span class="hljs-number">0</span>; i &lt; n; i++)<br>        &#123;<br>            result[i] = (<span class="hljs-type">float</span> *)<span class="hljs-built_in">malloc</span>(n * <span class="hljs-keyword">sizeof</span>(<span class="hljs-type">float</span>));<br>            <span class="hljs-keyword">if</span> (result[i] == <span class="hljs-literal">NULL</span>)<br>            &#123;<br>                <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;error in Matrix_Eig:申请子空间失败\n&quot;</span>);<br>                <span class="hljs-keyword">return</span> <span class="hljs-literal">NULL</span>;<br>            &#125;<br>            result_temp[i] = (<span class="hljs-type">float</span> *)<span class="hljs-built_in">malloc</span>(n * <span class="hljs-keyword">sizeof</span>(<span class="hljs-type">float</span>));<br>            <span class="hljs-keyword">if</span> (result_temp[i] == <span class="hljs-literal">NULL</span>)<br>            &#123;<br>                <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;error in Matrix_Eig:申请子空间失败\n&quot;</span>);<br>                <span class="hljs-keyword">return</span> <span class="hljs-literal">NULL</span>;<br>            &#125;<br>            rot[i] = (<span class="hljs-type">float</span> *)<span class="hljs-built_in">malloc</span>(n * <span class="hljs-keyword">sizeof</span>(<span class="hljs-type">float</span>));<br>            <span class="hljs-keyword">if</span> (rot[i] == <span class="hljs-literal">NULL</span>)<br>            &#123;<br>                <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;error in Matrix_Eig:申请子空间失败\n&quot;</span>);<br>                <span class="hljs-keyword">return</span> <span class="hljs-literal">NULL</span>;<br>            &#125;<br>            mat[i] = (<span class="hljs-type">float</span> *)<span class="hljs-built_in">malloc</span>(n * <span class="hljs-keyword">sizeof</span>(<span class="hljs-type">float</span>));<br>            <span class="hljs-keyword">if</span> (mat[i] == <span class="hljs-literal">NULL</span>)<br>            &#123;<br>                <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;error in Matrix_Eig:申请子空间失败\n&quot;</span>);<br>                <span class="hljs-keyword">return</span> <span class="hljs-literal">NULL</span>;<br>            &#125;<br>        &#125;<br>        <span class="hljs-keyword">for</span> (i = <span class="hljs-number">0</span>; i &lt; n; i++)<br>        &#123;<br>            <span class="hljs-keyword">for</span> (j = <span class="hljs-number">0</span>; j &lt; n; j++)<br>            &#123;<br>                <span class="hljs-keyword">if</span> (i == j)<br>                &#123;<br>                    result[i][j] = <span class="hljs-number">1</span>;<br>                &#125;<br>                <span class="hljs-keyword">else</span><br>                &#123;<br>                    result[i][j] = <span class="hljs-number">0</span>;<br>                &#125;<br>            &#125;<br>        &#125;<br>        <span class="hljs-keyword">for</span> (i = <span class="hljs-number">0</span>; i &lt; n; i++)<br>        &#123;<br>            <span class="hljs-keyword">for</span> (j = <span class="hljs-number">0</span>; j &lt; n; j++)<br>            &#123;<br>                <span class="hljs-keyword">if</span> (i == j)<br>                &#123;<br>                    mat[i][j] = <span class="hljs-number">1</span>;<br>                &#125;<br>                <span class="hljs-keyword">else</span><br>                &#123;<br>                    mat[i][j] = <span class="hljs-number">0</span>;<br>                &#125;<br>            &#125;<br>        &#125;<br>        max = <span class="hljs-built_in">array</span>[<span class="hljs-number">0</span>][<span class="hljs-number">1</span>];<br>        <span class="hljs-keyword">for</span> (i = <span class="hljs-number">0</span>; i &lt; n; i++)<br>        &#123;<br>            <span class="hljs-keyword">for</span> (j = <span class="hljs-number">0</span>; j &lt; n; j++)<br>            &#123;<br>                <span class="hljs-keyword">if</span> (i == j)<br>                &#123;<br>                    <span class="hljs-keyword">continue</span>;<br>                &#125;<br>                <span class="hljs-keyword">else</span><br>                &#123;<br>                    <span class="hljs-keyword">if</span> (<span class="hljs-built_in">fabs</span>(<span class="hljs-built_in">array</span>[i][j]) &gt;= <span class="hljs-built_in">fabs</span>(max))<br>                    &#123;<br>                        max = <span class="hljs-built_in">array</span>[i][j];<br>                        p = i;<br>                        q = j;<br>                    &#125;<br>                    <span class="hljs-keyword">else</span><br>                    &#123;<br>                        <span class="hljs-keyword">continue</span>;<br>                    &#125;<br>                &#125;<br>            &#125;<br>        &#125;<br>        <span class="hljs-keyword">while</span> (<span class="hljs-built_in">fabs</span>(max) &gt; thresh)<br>        &#123;<br>            <span class="hljs-keyword">if</span> (<span class="hljs-built_in">fabs</span>(max) &lt; thresh)<br>            &#123;<br>                <span class="hljs-keyword">break</span>;<br>            &#125;<br>            tan_angle = <span class="hljs-number">-2</span> * <span class="hljs-built_in">array</span>[p][q] / (<span class="hljs-built_in">array</span>[q][q] - <span class="hljs-built_in">array</span>[p][p]);<br>            sin_angle = <span class="hljs-built_in">sin</span>(<span class="hljs-number">0.5</span>*<span class="hljs-built_in">atan</span>(tan_angle));<br>            cos_angle = <span class="hljs-built_in">cos</span>(<span class="hljs-number">0.5</span>*<span class="hljs-built_in">atan</span>(tan_angle));<br>            <span class="hljs-keyword">for</span> (i = <span class="hljs-number">0</span>; i &lt; n; i++)<br>            &#123;<br>                <span class="hljs-keyword">for</span> (j = <span class="hljs-number">0</span>; j &lt; n; j++)<br>                &#123;<br><br>                    <span class="hljs-keyword">if</span> (i == j)<br>                    &#123;<br>                        mat[i][j] = <span class="hljs-number">1</span>;<br>                    &#125;<br>                    <span class="hljs-keyword">else</span><br>                    &#123;<br>                        mat[i][j] = <span class="hljs-number">0</span>;<br>                    &#125;<br>                &#125;<br>            &#125;<br>            mat[p][p] = cos_angle;<br>            mat[q][q] = cos_angle;<br>            mat[q][p] = sin_angle;<br>            mat[p][q] = -sin_angle;<br>            <span class="hljs-keyword">for</span> (i = <span class="hljs-number">0</span>; i &lt; n; i++)<br>            &#123;<br>                <span class="hljs-keyword">for</span> (j = <span class="hljs-number">0</span>; j &lt; n; j++)<br>                &#123;<br>                    rot[i][j] = <span class="hljs-built_in">array</span>[i][j];<br>                &#125;<br>            &#125;<br>            <span class="hljs-keyword">for</span> (j = <span class="hljs-number">0</span>; j &lt; n; j++)<br>            &#123;<br>                rot[p][j] = cos_angle*<span class="hljs-built_in">array</span>[p][j] + sin_angle*<span class="hljs-built_in">array</span>[q][j];<br>                rot[q][j] = -sin_angle*<span class="hljs-built_in">array</span>[p][j] + cos_angle*<span class="hljs-built_in">array</span>[q][j];<br>                rot[j][p] = cos_angle*<span class="hljs-built_in">array</span>[j][p] + sin_angle*<span class="hljs-built_in">array</span>[j][q];<br>                rot[j][q] = -sin_angle*<span class="hljs-built_in">array</span>[j][p] + cos_angle*<span class="hljs-built_in">array</span>[j][q];<br>            &#125;<br>            rot[p][p] = <span class="hljs-built_in">array</span>[p][p] * cos_angle*cos_angle +<br>                <span class="hljs-built_in">array</span>[q][q] * sin_angle*sin_angle +<br>                <span class="hljs-number">2</span> * <span class="hljs-built_in">array</span>[p][q] * cos_angle*sin_angle;<br>            rot[q][q] = <span class="hljs-built_in">array</span>[q][q] * cos_angle*cos_angle +<br>                <span class="hljs-built_in">array</span>[p][p] * sin_angle*sin_angle -<br>                <span class="hljs-number">2</span> * <span class="hljs-built_in">array</span>[p][q] * cos_angle*sin_angle;<br>            rot[p][q] = <span class="hljs-number">0.5</span>*(<span class="hljs-built_in">array</span>[q][q] - <span class="hljs-built_in">array</span>[p][p]) * <span class="hljs-number">2</span> * sin_angle*cos_angle +<br>                <span class="hljs-built_in">array</span>[p][q] * (<span class="hljs-number">2</span> * cos_angle*cos_angle - <span class="hljs-number">1</span>);<br>            rot[q][p] = <span class="hljs-number">0.5</span>*(<span class="hljs-built_in">array</span>[q][q] - <span class="hljs-built_in">array</span>[p][p]) * <span class="hljs-number">2</span> * sin_angle*cos_angle +<br>                <span class="hljs-built_in">array</span>[p][q] * (<span class="hljs-number">2</span> * cos_angle*cos_angle - <span class="hljs-number">1</span>);<br>            <span class="hljs-keyword">for</span> (i = <span class="hljs-number">0</span>; i &lt; n; i++)<br>            &#123;<br>                <span class="hljs-keyword">for</span> (j = <span class="hljs-number">0</span>; j &lt; n; j++)<br>                &#123;<br>                    <span class="hljs-built_in">array</span>[i][j] = rot[i][j];<br>                &#125;<br>            &#125;<br>            max = <span class="hljs-built_in">array</span>[<span class="hljs-number">0</span>][<span class="hljs-number">1</span>];<br>            <span class="hljs-keyword">for</span> (i = <span class="hljs-number">0</span>; i &lt; n; i++)<br>            &#123;<br>                <span class="hljs-keyword">for</span> (j = <span class="hljs-number">0</span>; j &lt; n; j++)<br>                &#123;<br>                    <span class="hljs-keyword">if</span> (i == j)<br>                    &#123;<br>                        <span class="hljs-keyword">continue</span>;<br>                    &#125;<br>                    <span class="hljs-keyword">else</span><br>                    &#123;<br>                        <span class="hljs-keyword">if</span> (<span class="hljs-built_in">fabs</span>(<span class="hljs-built_in">array</span>[i][j]) &gt;= <span class="hljs-built_in">fabs</span>(max))<br>                        &#123;<br>                            max = <span class="hljs-built_in">array</span>[i][j];<br>                            p = i;<br>                            q = j;<br>                        &#125;<br>                        <span class="hljs-keyword">else</span><br>                        &#123;<br>                            <span class="hljs-keyword">continue</span>;<br>                        &#125;<br>                    &#125;<br>                &#125;<br>            &#125;<br>            <span class="hljs-keyword">for</span> (i = <span class="hljs-number">0</span>; i &lt; n; i++)<br>            &#123;<br>                eig[i] = <span class="hljs-built_in">array</span>[i][i];<br>            &#125;<br>            <span class="hljs-keyword">for</span> (i = <span class="hljs-number">0</span>; i &lt; n; i++)<br>            &#123;<br>                <span class="hljs-keyword">for</span> (j = <span class="hljs-number">0</span>; j &lt; n; j++)<br>                &#123;<br>                    sum = <span class="hljs-number">0</span>;<br>                    <span class="hljs-keyword">for</span> (k = <span class="hljs-number">0</span>; k &lt; n; k++)<br>                    &#123;<br>                        sum = sum + result[i][k] * mat[k][j];<br>                    &#125;<br>                    result_temp[i][j] = sum;<br>                &#125;<br>            &#125;<br>            <span class="hljs-keyword">for</span> (i = <span class="hljs-number">0</span>; i &lt; n; i++)<br>            &#123;<br>                <span class="hljs-keyword">for</span> (j = <span class="hljs-number">0</span>; j &lt; n; j++)<br>                &#123;<br>                    result[i][j] = result_temp[i][j];<br>                &#125;<br>            &#125;<br>        &#125;<br>        <span class="hljs-keyword">for</span> (i = <span class="hljs-number">0</span>; i &lt; n; i++)<br>        &#123;<br>            <span class="hljs-keyword">for</span> (j = <span class="hljs-number">0</span>; j &lt; n; j++)<br>            &#123;<br>                <span class="hljs-built_in">array</span>[i][j] = temp_mat[i][j];<br>            &#125;<br>        &#125;<br>        Matrix_Free(result_temp, n, n);<br>        Matrix_Free(rot, n, n);<br>        Matrix_Free(mat, n, n);<br>        Matrix_Free(temp_mat, n, n);<br>        <span class="hljs-keyword">return</span> result;<br>    &#125;<br>&#125;<br><span class="hljs-type">int</span> <span class="hljs-title function_">Matrix_Free</span><span class="hljs-params">(<span class="hljs-type">float</span> **tmp, <span class="hljs-type">int</span> m, <span class="hljs-type">int</span> n)</span><br>&#123;<br>    <span class="hljs-type">int</span> i, j;<br>    <span class="hljs-keyword">if</span> (tmp == <span class="hljs-literal">NULL</span>)<br>    &#123;<br>        <span class="hljs-keyword">return</span>(<span class="hljs-number">1</span>);<br>    &#125;<br>    <span class="hljs-keyword">for</span> (i = <span class="hljs-number">0</span>; i &lt; m; i++)<br>    &#123;<br>        <span class="hljs-keyword">if</span> (tmp[i] != <span class="hljs-literal">NULL</span>)<br>        &#123;<br>            <span class="hljs-built_in">free</span>(tmp[i]);<br>            tmp[i] = <span class="hljs-literal">NULL</span>;<br>        &#125;<br>    &#125;<br>    <span class="hljs-keyword">if</span> (tmp != <span class="hljs-literal">NULL</span>)<br>    &#123;<br>        <span class="hljs-built_in">free</span>(tmp);<br>        tmp = <span class="hljs-literal">NULL</span>;<br>    &#125;<br>    <span class="hljs-keyword">return</span>(<span class="hljs-number">0</span>);<br>&#125;<br></code></pre></td></tr></table></figure>

<p>输入如下代码对其进行编译并运行：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs c">gcc eigenNoOpt.c -o eigenNoOpt -lm<br>./eigenNoOpt    <br></code></pre></td></tr></table></figure>

<p>得到运行结果如下：</p>
<p class='item-img' data-src=''><img src=""></p>
<span class="hide"><object><p>看不见是正常的，别担心</p></object></span>

<p>对其进行改进，并作体现LAPACK库性能的对比实验如下：</p>
<p>将传统C语言算法的代码改为如下：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">include</span><span class="hljs-string">&lt;stdio.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span><span class="hljs-string">&lt;stdlib.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span><span class="hljs-string">&lt;math.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span><span class="hljs-string">&lt;time.h&gt;</span></span><br><br><span class="hljs-type">float</span>** <span class="hljs-title function_">Matrix_Jac_Eig</span><span class="hljs-params">(<span class="hljs-type">float</span> **<span class="hljs-built_in">array</span>, <span class="hljs-type">int</span> n, <span class="hljs-type">float</span> *eig)</span>;<br><span class="hljs-type">int</span> <span class="hljs-title function_">Matrix_Free</span><span class="hljs-params">(<span class="hljs-type">float</span> **tmp, <span class="hljs-type">int</span> m, <span class="hljs-type">int</span> n)</span>;<br><span class="hljs-type">int</span> <span class="hljs-title function_">main</span><span class="hljs-params">(<span class="hljs-type">void</span>)</span><br>&#123;<br>    <span class="hljs-type">int</span> n;<br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;请输入矩阵维度:\n&quot;</span>);<br>    <span class="hljs-built_in">scanf</span>(<span class="hljs-string">&quot;%d&quot;</span>, &amp;n);<br>    <span class="hljs-type">float</span> **<span class="hljs-built_in">array</span> = (<span class="hljs-type">float</span> **)<span class="hljs-built_in">malloc</span>(n * <span class="hljs-keyword">sizeof</span>(<span class="hljs-type">float</span> *));<br>    <span class="hljs-keyword">if</span> (<span class="hljs-built_in">array</span> == <span class="hljs-literal">NULL</span>)<br>    &#123;<br>        <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;error :申请数组内存空间失败\n&quot;</span>);<br>        <span class="hljs-keyword">return</span> <span class="hljs-number">-1</span>;<br>    &#125;<br>    <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> i = <span class="hljs-number">0</span>; i &lt; n; i++)<br>    &#123;<br>        <span class="hljs-built_in">array</span>[i] = (<span class="hljs-type">float</span> *)<span class="hljs-built_in">malloc</span>(n * <span class="hljs-keyword">sizeof</span>(<span class="hljs-type">float</span>));<br>        <span class="hljs-keyword">if</span> (<span class="hljs-built_in">array</span>[i] == <span class="hljs-literal">NULL</span>)<br>        &#123;<br>            <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;error :申请数组子内存空间失败\n&quot;</span>);<br>            <span class="hljs-keyword">return</span> <span class="hljs-number">-1</span>;<br>        &#125;<br>    &#125;<br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;请输入矩阵元素:\n&quot;</span>);<br>    <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> i = <span class="hljs-number">0</span>; i &lt; n; i++)<br>    &#123;<br>        <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> j = <span class="hljs-number">0</span>; j &lt; n; j++)<br>        &#123;<br>            <span class="hljs-built_in">scanf</span>(<span class="hljs-string">&quot;%f&quot;</span>, &amp;<span class="hljs-built_in">array</span>[i][j]);<br>        &#125;<br>    &#125;<br>    <span class="hljs-type">float</span> *eig = (<span class="hljs-type">float</span> *)<span class="hljs-built_in">malloc</span>(n * <span class="hljs-keyword">sizeof</span>(<span class="hljs-type">float</span>));<br>    <br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">timespec</span> <span class="hljs-title">t1</span>,<span class="hljs-title">t2</span>;</span><br><br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;Without KML:\n&quot;</span>);<br>    clock_gettime(CLOCK_MONOTONIC,&amp;t1);      <span class="hljs-comment">//计算开始时间。</span><br>    <span class="hljs-type">float</span> **Result = Matrix_Jac_Eig(<span class="hljs-built_in">array</span>, n, eig);<br>    clock_gettime(CLOCK_MONOTONIC,&amp;t2);    <span class="hljs-comment">//计算结束时间。</span><br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;Time:%11u ns\n&quot;</span>,t2.tv_nsec-t1.tv_nsec);  <br>    Matrix_Free(Result, n, n);<br>    <span class="hljs-built_in">free</span>(eig);<br>    eig = <span class="hljs-literal">NULL</span>;<br>    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>&#125;<br><span class="hljs-type">float</span>** <span class="hljs-title function_">Matrix_Jac_Eig</span><span class="hljs-params">(<span class="hljs-type">float</span> **<span class="hljs-built_in">array</span>, <span class="hljs-type">int</span> n, <span class="hljs-type">float</span> *eig)</span><br>&#123;<br>    <span class="hljs-type">int</span> i, j, flag, k;<br>    flag = <span class="hljs-number">0</span>;<br>    k = <span class="hljs-number">0</span>;<br>    <span class="hljs-type">float</span> sum = <span class="hljs-number">0</span>;<br>    <span class="hljs-type">float</span> **temp_mat = (<span class="hljs-type">float</span> **)<span class="hljs-built_in">malloc</span>(n * <span class="hljs-keyword">sizeof</span>(<span class="hljs-type">float</span> *));<br>    <span class="hljs-keyword">for</span> (i = <span class="hljs-number">0</span>; i &lt; n; i++)<br>    &#123;<br>        temp_mat[i] = (<span class="hljs-type">float</span> *)<span class="hljs-built_in">malloc</span>(n * <span class="hljs-keyword">sizeof</span>(<span class="hljs-type">float</span>));<br>    &#125;<br>    <span class="hljs-keyword">for</span> (i = <span class="hljs-number">0</span>; i &lt; n; i++)<br>    &#123;<br>        <span class="hljs-keyword">for</span> (j = <span class="hljs-number">0</span>; j &lt; n; j++)<br>        &#123;<br>            temp_mat[i][j] = <span class="hljs-built_in">array</span>[i][j];<br>        &#125;<br>    &#125;<br>    <span class="hljs-comment">//判断是否为对称矩阵</span><br>    <span class="hljs-keyword">for</span> (i = <span class="hljs-number">0</span>; i &lt; n; i++)<br>    &#123;<br>        <span class="hljs-keyword">for</span> (j = i; j &lt; n; j++)<br>        &#123;<br>            <span class="hljs-keyword">if</span> (<span class="hljs-built_in">array</span>[i][j] != <span class="hljs-built_in">array</span>[j][i])<br>            &#123;<br>                flag = <span class="hljs-number">1</span>;<br>                <span class="hljs-keyword">break</span>;<br>            &#125;<br>        &#125;<br>    &#125;<br>    <span class="hljs-keyword">if</span> (flag == <span class="hljs-number">1</span>)<br>    &#123;<br>        <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;error in Matrix_Eig: 输入并非是对称矩阵:\n&quot;</span>);<br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">NULL</span>;<br>    &#125;<br>    <span class="hljs-keyword">else</span><br>    &#123;<br>        <span class="hljs-comment">//开始执行算法</span><br>        <span class="hljs-type">int</span> p, q;<br>        <span class="hljs-type">float</span> thresh = <span class="hljs-number">0.0000000001</span>;<br>        <span class="hljs-type">float</span> max = <span class="hljs-built_in">array</span>[<span class="hljs-number">0</span>][<span class="hljs-number">1</span>];<br>        <span class="hljs-type">float</span> tan_angle, sin_angle, cos_angle;<br>        <span class="hljs-type">float</span> **result = (<span class="hljs-type">float</span> **)<span class="hljs-built_in">malloc</span>(n * <span class="hljs-keyword">sizeof</span>(<span class="hljs-type">float</span> *));<br>        <span class="hljs-keyword">if</span> (result == <span class="hljs-literal">NULL</span>)<br>        &#123;<br>            <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;error in Matrix_Eig:申请空间失败\n&quot;</span>);<br>            <span class="hljs-keyword">return</span> <span class="hljs-literal">NULL</span>;<br>        &#125;<br>        <span class="hljs-type">float</span> **result_temp = (<span class="hljs-type">float</span> **)<span class="hljs-built_in">malloc</span>(n * <span class="hljs-keyword">sizeof</span>(<span class="hljs-type">float</span> *));<br>        <span class="hljs-keyword">if</span> (result_temp == <span class="hljs-literal">NULL</span>)<br>        &#123;<br>            <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;error in Matrix_Eig:申请空间失败\n&quot;</span>);<br>            <span class="hljs-keyword">return</span> <span class="hljs-literal">NULL</span>;<br>        &#125;<br>        <span class="hljs-type">float</span> **rot = (<span class="hljs-type">float</span> **)<span class="hljs-built_in">malloc</span>(n * <span class="hljs-keyword">sizeof</span>(<span class="hljs-type">float</span> *));<br>        <span class="hljs-keyword">if</span> (rot == <span class="hljs-literal">NULL</span>)<br>        &#123;<br>            <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;error in Matrix_Eig:申请空间失败\n&quot;</span>);<br>            <span class="hljs-keyword">return</span> <span class="hljs-literal">NULL</span>;<br>        &#125;<br>        <span class="hljs-type">float</span> **mat = (<span class="hljs-type">float</span> **)<span class="hljs-built_in">malloc</span>(n * <span class="hljs-keyword">sizeof</span>(<span class="hljs-type">float</span> *));<br>        <span class="hljs-keyword">if</span> (mat == <span class="hljs-literal">NULL</span>)<br>        &#123;<br>            <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;error in Matrix_Eig:申请空间失败\n&quot;</span>);<br>            <span class="hljs-keyword">return</span> <span class="hljs-literal">NULL</span>;<br>        &#125;<br>        <span class="hljs-keyword">for</span> (i = <span class="hljs-number">0</span>; i &lt; n; i++)<br>        &#123;<br>            result[i] = (<span class="hljs-type">float</span> *)<span class="hljs-built_in">malloc</span>(n * <span class="hljs-keyword">sizeof</span>(<span class="hljs-type">float</span>));<br>            <span class="hljs-keyword">if</span> (result[i] == <span class="hljs-literal">NULL</span>)<br>            &#123;<br>                <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;error in Matrix_Eig:申请子空间失败\n&quot;</span>);<br>                <span class="hljs-keyword">return</span> <span class="hljs-literal">NULL</span>;<br>            &#125;<br>            result_temp[i] = (<span class="hljs-type">float</span> *)<span class="hljs-built_in">malloc</span>(n * <span class="hljs-keyword">sizeof</span>(<span class="hljs-type">float</span>));<br>            <span class="hljs-keyword">if</span> (result_temp[i] == <span class="hljs-literal">NULL</span>)<br>            &#123;<br>                <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;error in Matrix_Eig:申请子空间失败\n&quot;</span>);<br>                <span class="hljs-keyword">return</span> <span class="hljs-literal">NULL</span>;<br>            &#125;<br>            rot[i] = (<span class="hljs-type">float</span> *)<span class="hljs-built_in">malloc</span>(n * <span class="hljs-keyword">sizeof</span>(<span class="hljs-type">float</span>));<br>            <span class="hljs-keyword">if</span> (rot[i] == <span class="hljs-literal">NULL</span>)<br>            &#123;<br>                <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;error in Matrix_Eig:申请子空间失败\n&quot;</span>);<br>                <span class="hljs-keyword">return</span> <span class="hljs-literal">NULL</span>;<br>            &#125;<br>            mat[i] = (<span class="hljs-type">float</span> *)<span class="hljs-built_in">malloc</span>(n * <span class="hljs-keyword">sizeof</span>(<span class="hljs-type">float</span>));<br>            <span class="hljs-keyword">if</span> (mat[i] == <span class="hljs-literal">NULL</span>)<br>            &#123;<br>                <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;error in Matrix_Eig:申请子空间失败\n&quot;</span>);<br>                <span class="hljs-keyword">return</span> <span class="hljs-literal">NULL</span>;<br>            &#125;<br>        &#125;<br>        <span class="hljs-keyword">for</span> (i = <span class="hljs-number">0</span>; i &lt; n; i++)<br>        &#123;<br>            <span class="hljs-keyword">for</span> (j = <span class="hljs-number">0</span>; j &lt; n; j++)<br>            &#123;<br>                <span class="hljs-keyword">if</span> (i == j)<br>                &#123;<br>                    result[i][j] = <span class="hljs-number">1</span>;<br>                &#125;<br>                <span class="hljs-keyword">else</span><br>                &#123;<br>                    result[i][j] = <span class="hljs-number">0</span>;<br>                &#125;<br>            &#125;<br>        &#125;<br>        <span class="hljs-keyword">for</span> (i = <span class="hljs-number">0</span>; i &lt; n; i++)<br>        &#123;<br>            <span class="hljs-keyword">for</span> (j = <span class="hljs-number">0</span>; j &lt; n; j++)<br>            &#123;<br>                <span class="hljs-keyword">if</span> (i == j)<br>                &#123;<br>                    mat[i][j] = <span class="hljs-number">1</span>;<br>                &#125;<br>                <span class="hljs-keyword">else</span><br>                &#123;<br>                    mat[i][j] = <span class="hljs-number">0</span>;<br>                &#125;<br>            &#125;<br>        &#125;<br>        max = <span class="hljs-built_in">array</span>[<span class="hljs-number">0</span>][<span class="hljs-number">1</span>];<br>        <span class="hljs-keyword">for</span> (i = <span class="hljs-number">0</span>; i &lt; n; i++)<br>        &#123;<br>            <span class="hljs-keyword">for</span> (j = <span class="hljs-number">0</span>; j &lt; n; j++)<br>            &#123;<br>                <span class="hljs-keyword">if</span> (i == j)<br>                &#123;<br>                    <span class="hljs-keyword">continue</span>;<br>                &#125;<br>                <span class="hljs-keyword">else</span><br>                &#123;<br>                    <span class="hljs-keyword">if</span> (<span class="hljs-built_in">fabs</span>(<span class="hljs-built_in">array</span>[i][j]) &gt;= <span class="hljs-built_in">fabs</span>(max))<br>                    &#123;<br>                        max = <span class="hljs-built_in">array</span>[i][j];<br>                        p = i;<br>                        q = j;<br>                    &#125;<br>                    <span class="hljs-keyword">else</span><br>                    &#123;<br>                        <span class="hljs-keyword">continue</span>;<br>                    &#125;<br>                &#125;<br>            &#125;<br>        &#125;<br>        <span class="hljs-keyword">while</span> (<span class="hljs-built_in">fabs</span>(max) &gt; thresh)<br>        &#123;<br>            <span class="hljs-keyword">if</span> (<span class="hljs-built_in">fabs</span>(max) &lt; thresh)<br>            &#123;<br>                <span class="hljs-keyword">break</span>;<br>            &#125;<br>            tan_angle = <span class="hljs-number">-2</span> * <span class="hljs-built_in">array</span>[p][q] / (<span class="hljs-built_in">array</span>[q][q] - <span class="hljs-built_in">array</span>[p][p]);<br>            sin_angle = <span class="hljs-built_in">sin</span>(<span class="hljs-number">0.5</span>*<span class="hljs-built_in">atan</span>(tan_angle));<br>            cos_angle = <span class="hljs-built_in">cos</span>(<span class="hljs-number">0.5</span>*<span class="hljs-built_in">atan</span>(tan_angle));<br>            <span class="hljs-keyword">for</span> (i = <span class="hljs-number">0</span>; i &lt; n; i++)<br>            &#123;<br>                <span class="hljs-keyword">for</span> (j = <span class="hljs-number">0</span>; j &lt; n; j++)<br>                &#123;<br><br>                    <span class="hljs-keyword">if</span> (i == j)<br>                    &#123;<br>                        mat[i][j] = <span class="hljs-number">1</span>;<br>                    &#125;<br>                    <span class="hljs-keyword">else</span><br>                    &#123;<br>                        mat[i][j] = <span class="hljs-number">0</span>;<br>                    &#125;<br>                &#125;<br>            &#125;<br>            mat[p][p] = cos_angle;<br>            mat[q][q] = cos_angle;<br>            mat[q][p] = sin_angle;<br>            mat[p][q] = -sin_angle;<br>            <span class="hljs-keyword">for</span> (i = <span class="hljs-number">0</span>; i &lt; n; i++)<br>            &#123;<br>                <span class="hljs-keyword">for</span> (j = <span class="hljs-number">0</span>; j &lt; n; j++)<br>                &#123;<br>                    rot[i][j] = <span class="hljs-built_in">array</span>[i][j];<br>                &#125;<br>            &#125;<br>            <span class="hljs-keyword">for</span> (j = <span class="hljs-number">0</span>; j &lt; n; j++)<br>            &#123;<br>                rot[p][j] = cos_angle*<span class="hljs-built_in">array</span>[p][j] + sin_angle*<span class="hljs-built_in">array</span>[q][j];<br>                rot[q][j] = -sin_angle*<span class="hljs-built_in">array</span>[p][j] + cos_angle*<span class="hljs-built_in">array</span>[q][j];<br>                rot[j][p] = cos_angle*<span class="hljs-built_in">array</span>[j][p] + sin_angle*<span class="hljs-built_in">array</span>[j][q];<br>                rot[j][q] = -sin_angle*<span class="hljs-built_in">array</span>[j][p] + cos_angle*<span class="hljs-built_in">array</span>[j][q];<br>            &#125;<br>            rot[p][p] = <span class="hljs-built_in">array</span>[p][p] * cos_angle*cos_angle +<br>                <span class="hljs-built_in">array</span>[q][q] * sin_angle*sin_angle +<br>                <span class="hljs-number">2</span> * <span class="hljs-built_in">array</span>[p][q] * cos_angle*sin_angle;<br>            rot[q][q] = <span class="hljs-built_in">array</span>[q][q] * cos_angle*cos_angle +<br>                <span class="hljs-built_in">array</span>[p][p] * sin_angle*sin_angle -<br>                <span class="hljs-number">2</span> * <span class="hljs-built_in">array</span>[p][q] * cos_angle*sin_angle;<br>            rot[p][q] = <span class="hljs-number">0.5</span>*(<span class="hljs-built_in">array</span>[q][q] - <span class="hljs-built_in">array</span>[p][p]) * <span class="hljs-number">2</span> * sin_angle*cos_angle +<br>                <span class="hljs-built_in">array</span>[p][q] * (<span class="hljs-number">2</span> * cos_angle*cos_angle - <span class="hljs-number">1</span>);<br>            rot[q][p] = <span class="hljs-number">0.5</span>*(<span class="hljs-built_in">array</span>[q][q] - <span class="hljs-built_in">array</span>[p][p]) * <span class="hljs-number">2</span> * sin_angle*cos_angle +<br>                <span class="hljs-built_in">array</span>[p][q] * (<span class="hljs-number">2</span> * cos_angle*cos_angle - <span class="hljs-number">1</span>);<br>            <span class="hljs-keyword">for</span> (i = <span class="hljs-number">0</span>; i &lt; n; i++)<br>            &#123;<br>                <span class="hljs-keyword">for</span> (j = <span class="hljs-number">0</span>; j &lt; n; j++)<br>                &#123;<br>                    <span class="hljs-built_in">array</span>[i][j] = rot[i][j];<br>                &#125;<br>            &#125;<br>            max = <span class="hljs-built_in">array</span>[<span class="hljs-number">0</span>][<span class="hljs-number">1</span>];<br>            <span class="hljs-keyword">for</span> (i = <span class="hljs-number">0</span>; i &lt; n; i++)<br>            &#123;<br>                <span class="hljs-keyword">for</span> (j = <span class="hljs-number">0</span>; j &lt; n; j++)<br>                &#123;<br>                    <span class="hljs-keyword">if</span> (i == j)<br>                    &#123;<br>                        <span class="hljs-keyword">continue</span>;<br>                    &#125;<br>                    <span class="hljs-keyword">else</span><br>                    &#123;<br>                        <span class="hljs-keyword">if</span> (<span class="hljs-built_in">fabs</span>(<span class="hljs-built_in">array</span>[i][j]) &gt;= <span class="hljs-built_in">fabs</span>(max))<br>                        &#123;<br>                            max = <span class="hljs-built_in">array</span>[i][j];<br>                            p = i;<br>                            q = j;<br>                        &#125;<br>                        <span class="hljs-keyword">else</span><br>                        &#123;<br>                            <span class="hljs-keyword">continue</span>;<br>                        &#125;<br>                    &#125;<br>                &#125;<br>            &#125;<br>            <span class="hljs-keyword">for</span> (i = <span class="hljs-number">0</span>; i &lt; n; i++)<br>            &#123;<br>                eig[i] = <span class="hljs-built_in">array</span>[i][i];<br>            &#125;<br>            <span class="hljs-keyword">for</span> (i = <span class="hljs-number">0</span>; i &lt; n; i++)<br>            &#123;<br>                <span class="hljs-keyword">for</span> (j = <span class="hljs-number">0</span>; j &lt; n; j++)<br>                &#123;<br>                    sum = <span class="hljs-number">0</span>;<br>                    <span class="hljs-keyword">for</span> (k = <span class="hljs-number">0</span>; k &lt; n; k++)<br>                    &#123;<br>                        sum = sum + result[i][k] * mat[k][j];<br>                    &#125;<br>                    result_temp[i][j] = sum;<br>                &#125;<br>            &#125;<br>            <span class="hljs-keyword">for</span> (i = <span class="hljs-number">0</span>; i &lt; n; i++)<br>            &#123;<br>                <span class="hljs-keyword">for</span> (j = <span class="hljs-number">0</span>; j &lt; n; j++)<br>                &#123;<br>                    result[i][j] = result_temp[i][j];<br>                &#125;<br>            &#125;<br>        &#125;<br>        <span class="hljs-keyword">for</span> (i = <span class="hljs-number">0</span>; i &lt; n; i++)<br>        &#123;<br>            <span class="hljs-keyword">for</span> (j = <span class="hljs-number">0</span>; j &lt; n; j++)<br>            &#123;<br>                <span class="hljs-built_in">array</span>[i][j] = temp_mat[i][j];<br>            &#125;<br>        &#125;<br>        Matrix_Free(result_temp, n, n);<br>        Matrix_Free(rot, n, n);<br>        Matrix_Free(mat, n, n);<br>        Matrix_Free(temp_mat, n, n);<br>        <span class="hljs-keyword">return</span> result;<br>    &#125;<br>&#125;<br><span class="hljs-type">int</span> <span class="hljs-title function_">Matrix_Free</span><span class="hljs-params">(<span class="hljs-type">float</span> **tmp, <span class="hljs-type">int</span> m, <span class="hljs-type">int</span> n)</span><br>&#123;<br>    <span class="hljs-type">int</span> i, j;<br>    <span class="hljs-keyword">if</span> (tmp == <span class="hljs-literal">NULL</span>)<br>    &#123;<br>        <span class="hljs-keyword">return</span>(<span class="hljs-number">1</span>);<br>    &#125;<br>    <span class="hljs-keyword">for</span> (i = <span class="hljs-number">0</span>; i &lt; m; i++)<br>    &#123;<br>        <span class="hljs-keyword">if</span> (tmp[i] != <span class="hljs-literal">NULL</span>)<br>        &#123;<br>            <span class="hljs-built_in">free</span>(tmp[i]);<br>            tmp[i] = <span class="hljs-literal">NULL</span>;<br>        &#125;<br>    &#125;<br>    <span class="hljs-keyword">if</span> (tmp != <span class="hljs-literal">NULL</span>)<br>    &#123;<br>        <span class="hljs-built_in">free</span>(tmp);<br>        tmp = <span class="hljs-literal">NULL</span>;<br>    &#125;<br>    <span class="hljs-keyword">return</span>(<span class="hljs-number">0</span>);<br>&#125;<br></code></pre></td></tr></table></figure>

<p>将调用KML库的那段代码中改为：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">include</span><span class="hljs-string">&lt;stdio.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdlib.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span><span class="hljs-string">&lt;time.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span><span class="hljs-string">&lt;stdlib.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&quot;klapack.h&quot;</span></span><br><br><span class="hljs-type">int</span> <span class="hljs-title function_">main</span><span class="hljs-params">()</span><br>&#123;  <br>    <span class="hljs-type">char</span> jobz = <span class="hljs-string">&#x27;V&#x27;</span>; <br>    <span class="hljs-type">char</span> uplo = <span class="hljs-string">&#x27;L&#x27;</span>; <br>    <span class="hljs-type">int</span> n = <span class="hljs-number">10</span>; <br>    <span class="hljs-type">int</span> lda = <span class="hljs-number">10</span>; <br>    <span class="hljs-type">int</span> info = <span class="hljs-number">0</span>; <br>    <span class="hljs-type">double</span> w[<span class="hljs-number">10</span>]; <br>    <span class="hljs-type">double</span> *work = <span class="hljs-literal">NULL</span>; <br>    <span class="hljs-type">double</span> qwork; <br>    <span class="hljs-type">int</span> lwork = <span class="hljs-number">-1</span>; <br>    <span class="hljs-type">int</span> *iwork = <span class="hljs-literal">NULL</span>; <br>    <span class="hljs-type">int</span> qiwork; <br>    <span class="hljs-type">int</span> liwork = <span class="hljs-number">-1</span>; <br><br>    <span class="hljs-type">double</span> a[] =<br>     &#123;  <br><span class="hljs-number">1.23</span>, <span class="hljs-number">2.75</span>, <span class="hljs-number">3.10</span>, <span class="hljs-number">4.56</span>, <span class="hljs-number">5.92</span>, <span class="hljs-number">7.01</span>, <span class="hljs-number">8.40</span>, <span class="hljs-number">9.88</span>, <span class="hljs-number">6.34</span>, <span class="hljs-number">4.59</span>, <br><span class="hljs-number">2.75</span>, <span class="hljs-number">1.56</span>, <span class="hljs-number">2.49</span>, <span class="hljs-number">3.31</span>, <span class="hljs-number">4.47</span>, <span class="hljs-number">5.90</span>, <span class="hljs-number">6.55</span>, <span class="hljs-number">7.10</span>, <span class="hljs-number">8.22</span>, <span class="hljs-number">5.78</span>,  <br><span class="hljs-number">3.10</span>, <span class="hljs-number">2.49</span>, <span class="hljs-number">1.88</span>, <span class="hljs-number">5.39</span>, <span class="hljs-number">6.23</span>, <span class="hljs-number">7.68</span>, <span class="hljs-number">3.79</span>, <span class="hljs-number">4.12</span>, <span class="hljs-number">6.44</span>, <span class="hljs-number">7.85</span>,  <br><span class="hljs-number">4.56</span>, <span class="hljs-number">3.31</span>, <span class="hljs-number">5.39</span>, <span class="hljs-number">8.94</span>, <span class="hljs-number">4.58</span>, <span class="hljs-number">2.53</span>, <span class="hljs-number">6.83</span>, <span class="hljs-number">7.46</span>, <span class="hljs-number">1.56</span>, <span class="hljs-number">3.21</span>,  <br><span class="hljs-number">5.92</span>, <span class="hljs-number">4.47</span>, <span class="hljs-number">6.23</span>, <span class="hljs-number">4.58</span>, <span class="hljs-number">9.76</span>, <span class="hljs-number">8.90</span>, <span class="hljs-number">5.12</span>, <span class="hljs-number">3.98</span>, <span class="hljs-number">2.63</span>, <span class="hljs-number">6.34</span>,  <br><span class="hljs-number">7.01</span>, <span class="hljs-number">5.90</span>, <span class="hljs-number">7.68</span>, <span class="hljs-number">2.53</span>, <span class="hljs-number">8.90</span>, <span class="hljs-number">6.75</span>, <span class="hljs-number">4.80</span>, <span class="hljs-number">1.94</span>, <span class="hljs-number">3.55</span>, <span class="hljs-number">2.88</span>,  <br><span class="hljs-number">8.40</span>, <span class="hljs-number">6.55</span>, <span class="hljs-number">3.79</span>, <span class="hljs-number">6.83</span>, <span class="hljs-number">5.12</span>, <span class="hljs-number">4.80</span>, <span class="hljs-number">1.64</span>, <span class="hljs-number">9.20</span>, <span class="hljs-number">5.90</span>, <span class="hljs-number">4.75</span>,  <br><span class="hljs-number">9.88</span>, <span class="hljs-number">7.10</span>, <span class="hljs-number">4.12</span>, <span class="hljs-number">7.46</span>, <span class="hljs-number">3.98</span>, <span class="hljs-number">1.94</span>, <span class="hljs-number">9.20</span>, <span class="hljs-number">7.44</span>, <span class="hljs-number">2.38</span>, <span class="hljs-number">6.71</span>,  <br><span class="hljs-number">6.34</span>, <span class="hljs-number">8.22</span>, <span class="hljs-number">6.44</span>, <span class="hljs-number">1.56</span>, <span class="hljs-number">2.63</span>, <span class="hljs-number">3.55</span>, <span class="hljs-number">5.90</span>, <span class="hljs-number">2.38</span>, <span class="hljs-number">0.76</span>, <span class="hljs-number">2.13</span>,  <br><span class="hljs-number">4.59</span>, <span class="hljs-number">5.78</span>, <span class="hljs-number">7.85</span>, <span class="hljs-number">3.21</span>, <span class="hljs-number">6.34</span>, <span class="hljs-number">2.88</span>, <span class="hljs-number">4.75</span>, <span class="hljs-number">6.71</span>, <span class="hljs-number">2.13</span>, <span class="hljs-number">9.32</span>    &#125;; <br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">timespec</span> <span class="hljs-title">t1</span>,<span class="hljs-title">t2</span>;</span>    <span class="hljs-comment">//定义初始与结束时间</span><br>    <span class="hljs-comment">/* Query optimal work size */</span> <br>    dsyevd_(&amp;jobz, &amp;uplo, &amp;n, a, &amp;lda, w, &amp;qwork, &amp;lwork, &amp;qiwork, &amp;liwork, &amp;info); <br>    <span class="hljs-keyword">if</span> (info != <span class="hljs-number">0</span>) <br>    &#123; <br>        <span class="hljs-keyword">return</span> <span class="hljs-number">-1</span>; <br>    &#125; <br>    lwork = (<span class="hljs-type">int</span>)qwork; <br>    work = (<span class="hljs-type">double</span> *)<span class="hljs-built_in">malloc</span>(<span class="hljs-keyword">sizeof</span>(<span class="hljs-type">double</span>) * lwork); <br>    liwork = (<span class="hljs-type">int</span>)qiwork; <br>    iwork = (<span class="hljs-type">int</span> *)<span class="hljs-built_in">malloc</span>(<span class="hljs-keyword">sizeof</span>(<span class="hljs-type">int</span>) * liwork); <br>    <span class="hljs-comment">/* Calculate eigenvalues and eigenvectors */</span> <br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;With KML:\n&quot;</span>);<br>    clock_gettime(CLOCK_MONOTONIC,&amp;t1);      <span class="hljs-comment">//计算开始时间。</span><br>    dsyevd_(&amp;jobz, &amp;uplo, &amp;n, a, &amp;lda, w, work, &amp;lwork, iwork, &amp;liwork, &amp;info); <br>    clock_gettime(CLOCK_MONOTONIC,&amp;t2);    <span class="hljs-comment">//计算结束时间。  </span><br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;Time:%11u ns\n&quot;</span>,t2.tv_nsec-t1.tv_nsec);  <br><br>    <span class="hljs-built_in">free</span>(work); <br>    <span class="hljs-built_in">free</span>(iwork); <br><br>     <br>     <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>编译并运行，得到结果如下：</p>
<p class='item-img' data-src=''><img src=""></p>
<span class="hide"><object><p>看不见是正常的，别担心</p></object></span>

<p>可知LAPACK库对运算的优化效果十分显著</p>
<h3 id="4-5-使用KML库函数实现R2R变换优化"><a href="#4-5-使用KML库函数实现R2R变换优化" class="headerlink" title="4.5 使用KML库函数实现R2R变换优化"></a>4.5 使用KML库函数实现R2R变换优化</h3><p>首先是使用一般C语言实现R2R变换</p>
<p>编写without.c文件，文件内容如下：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdio.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdlib.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;math.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;time.h&gt;</span></span><br><br><span class="hljs-type">void</span> <span class="hljs-title function_">r2r_fft</span><span class="hljs-params">(<span class="hljs-type">double</span> *in, <span class="hljs-type">double</span> *out, <span class="hljs-type">int</span> n)</span> <br>&#123;<br>    <span class="hljs-type">int</span> k, m, j;<br>    <span class="hljs-type">double</span> wr, wi, arg, c, s;<br>    <span class="hljs-type">double</span> *temp = (<span class="hljs-type">double</span>*)<span class="hljs-built_in">malloc</span>(n * <span class="hljs-keyword">sizeof</span>(<span class="hljs-type">double</span>));<br>    <br>    <span class="hljs-comment">// 实数的 R2R FFT 变换实现</span><br>    <span class="hljs-keyword">for</span> (k = <span class="hljs-number">0</span>; k &lt; n; k++) &#123;<br>        temp[k] = in[k];<br>    &#125;<br><br>    <span class="hljs-comment">// R2R FFT 变换</span><br>    <span class="hljs-keyword">for</span> (m = <span class="hljs-number">1</span>; m &lt;= n / <span class="hljs-number">2</span>; m *= <span class="hljs-number">2</span>) &#123;<br>        wr = <span class="hljs-built_in">cos</span>(M_PI / m);<br>        wi = <span class="hljs-built_in">sin</span>(M_PI / m);<br>        <span class="hljs-keyword">for</span> (k = <span class="hljs-number">0</span>; k &lt; n; k += <span class="hljs-number">2</span> * m) &#123;<br>            <span class="hljs-keyword">for</span> (j = <span class="hljs-number">0</span>; j &lt; m; j++) &#123;<br>                arg = j * (<span class="hljs-number">2</span> * M_PI / (<span class="hljs-number">2</span> * m));<br>                c = <span class="hljs-built_in">cos</span>(arg);<br>                s = <span class="hljs-built_in">sin</span>(arg);<br>                <span class="hljs-type">double</span> u1 = temp[k + j];<br>                <span class="hljs-type">double</span> u2 = temp[k + j + m];<br>                <span class="hljs-type">double</span> v1 = temp[k + j + m + <span class="hljs-number">1</span>];<br>                out[k + j] = u1 + u2 * c - v1 * s;<br>                out[k + j + <span class="hljs-number">1</span>] = u1 * s + u2 * v1 * c;<br>            &#125;<br>        &#125;<br>    &#125;<br><br>    <span class="hljs-built_in">free</span>(temp);<br>&#125;<br><br><span class="hljs-type">int</span> <span class="hljs-title function_">main</span><span class="hljs-params">()</span> &#123;<br>    <span class="hljs-type">int</span> rank = <span class="hljs-number">2</span>; <br>    <span class="hljs-type">int</span> *n; <br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">timespec</span> <span class="hljs-title">t1</span>, <span class="hljs-title">t2</span>;</span> <br><br>    n = (<span class="hljs-type">int</span>*)<span class="hljs-built_in">malloc</span>(<span class="hljs-keyword">sizeof</span>(<span class="hljs-type">int</span>) * rank); <br>    n[<span class="hljs-number">0</span>] = <span class="hljs-number">128</span>;  <span class="hljs-comment">// 修改数据规模</span><br>    n[<span class="hljs-number">1</span>] = <span class="hljs-number">128</span>;  <span class="hljs-comment">// 修改数据规模</span><br><br>    <span class="hljs-type">double</span> *in = (<span class="hljs-type">double</span>*)<span class="hljs-built_in">malloc</span>(<span class="hljs-keyword">sizeof</span>(<span class="hljs-type">double</span>) * n[<span class="hljs-number">0</span>] * n[<span class="hljs-number">1</span>]); <br>    <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> i = <span class="hljs-number">0</span>; i &lt; n[<span class="hljs-number">0</span>] * n[<span class="hljs-number">1</span>]; i++) &#123; <br>        in[i] = (<span class="hljs-type">double</span>)(i % <span class="hljs-number">10</span>);  <span class="hljs-comment">// 用一些基本的数值初始化输入数据</span><br>    &#125; <br><br>    <span class="hljs-type">double</span> *out = (<span class="hljs-type">double</span>*)<span class="hljs-built_in">malloc</span>(<span class="hljs-keyword">sizeof</span>(<span class="hljs-type">double</span>) * n[<span class="hljs-number">0</span>] * n[<span class="hljs-number">1</span>]);<br><br>    clock_gettime(CLOCK_MONOTONIC, &amp;t1);      <span class="hljs-comment">// 计算开始时间</span><br>    r2r_fft(in, out, n[<span class="hljs-number">0</span>] * n[<span class="hljs-number">1</span>]);            <span class="hljs-comment">// 执行 R2R FFT</span><br>    clock_gettime(CLOCK_MONOTONIC, &amp;t2);      <span class="hljs-comment">// 计算结束时间</span><br><br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;Without KML:\n&quot;</span>);<br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;Time: %11u ns\n&quot;</span>, t2.tv_nsec - t1.tv_nsec);  <br><br>    <span class="hljs-built_in">free</span>(n);<br>    <span class="hljs-built_in">free</span>(in); <br>    <span class="hljs-built_in">free</span>(out);<br><br>    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>使用如下代码编译并运行</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs c">gcc without.c -o without -lm<br>./without    <br></code></pre></td></tr></table></figure>

<p>得到结果如下：</p>
<p class='item-img' data-src=''><img src=""></p>
<span class="hide"><object><p>看不见是正常的，别担心</p></object></span>

<p>接着再使用KML_FFT库函数进行优化：</p>
<p>编写FFT.c文件，内容如下：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdio.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;time.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;math.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&quot;kfft.h&quot;</span></span><br><br><span class="hljs-type">int</span> <span class="hljs-title function_">main</span><span class="hljs-params">()</span> &#123;<br>    <span class="hljs-type">int</span> rank = <span class="hljs-number">2</span>; <br>    <span class="hljs-type">int</span> *n; <br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">timespec</span> <span class="hljs-title">t1</span>, <span class="hljs-title">t2</span>;</span>    <span class="hljs-comment">// 定义初始与结束时间</span><br><br>    n = (<span class="hljs-type">int</span>*)kml_fft_malloc(<span class="hljs-keyword">sizeof</span>(<span class="hljs-type">int</span>) * rank); <br>    n[<span class="hljs-number">0</span>] = <span class="hljs-number">128</span>;  <span class="hljs-comment">// 修改数据规模</span><br>    n[<span class="hljs-number">1</span>] = <span class="hljs-number">128</span>;  <span class="hljs-comment">// 修改数据规模</span><br><br>    <span class="hljs-type">double</span> *in = (<span class="hljs-type">double</span>*)kml_fft_malloc(<span class="hljs-keyword">sizeof</span>(<span class="hljs-type">double</span>) * n[<span class="hljs-number">0</span>] * n[<span class="hljs-number">1</span>]); <br>    <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> i = <span class="hljs-number">0</span>; i &lt; n[<span class="hljs-number">0</span>] * n[<span class="hljs-number">1</span>]; i++) &#123; <br>        in[i] = (<span class="hljs-type">double</span>)(i % <span class="hljs-number">10</span>);  <span class="hljs-comment">// 用一些基本的数值初始化输入数据</span><br>    &#125; <br><br>    <span class="hljs-type">double</span> *out = (<span class="hljs-type">double</span>*)kml_fft_malloc(<span class="hljs-keyword">sizeof</span>(<span class="hljs-type">double</span>) * n[<span class="hljs-number">0</span>] * n[<span class="hljs-number">1</span>]); <br>    kml_fft_r2r_kind *kind = (kml_fft_r2r_kind*)kml_fft_malloc(<span class="hljs-keyword">sizeof</span>(kml_fft_r2r_kind) * rank); <br>    kind[<span class="hljs-number">0</span>] = KML_FFT_DHT; <br>    kind[<span class="hljs-number">1</span>] = KML_FFT_DHT; <br><br>    kml_fft_plan plan; <br>    clock_gettime(CLOCK_MONOTONIC, &amp;t1);      <span class="hljs-comment">// 计算开始时间</span><br>    plan = kml_fft_plan_r2r(rank, n, in, out, kind, KML_FFT_ESTIMATE); <br>    kml_fft_execute_r2r(plan, in, out); <br>    clock_gettime(CLOCK_MONOTONIC, &amp;t2);      <span class="hljs-comment">// 计算结束时间 </span><br><br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;With KML:\n&quot;</span>);<br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;Time: %11u ns\n&quot;</span>, t2.tv_nsec - t1.tv_nsec);  <br><br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;\n&quot;</span>);<br><br>    kml_fft_destroy_plan(plan); <br>    kml_fft_free(n); <br>    kml_fft_free(kind); <br>    kml_fft_free(in); <br>    kml_fft_free(out); <br><br>    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>使用如下代码编译并运行</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs c">gcc FFT.c -o FFT -L /usr/local/kml/lib -lkfft -I /usr/local/kml/include -pthread<br>./FFT<br></code></pre></td></tr></table></figure>

<p>得到运行结果如下：</p>
<p class='item-img' data-src=''><img src=""></p>
<span class="hide"><object><p>看不见是正常的，别担心</p></object></span>

<p>可知KML库对R2R FFT运算的优化效果十分显著</p>
<h2 id="5-实验结果分析"><a href="#5-实验结果分析" class="headerlink" title="5.实验结果分析"></a>5.实验结果分析</h2><h3 id="1-牛顿迭代法求解非线性方程的根"><a href="#1-牛顿迭代法求解非线性方程的根" class="headerlink" title="1. 牛顿迭代法求解非线性方程的根"></a>1. <strong>牛顿迭代法求解非线性方程的根</strong></h3><ul>
<li>实现了牛顿迭代法，通过简单的非线性方程（如 $f(x)&#x3D;x2−2$）验证计算结果的准确性。</li>
<li>传统实现和 KML 的计算结果一致，说明 KML 提供的数学库可以准确求解非线性问题。</li>
</ul>
<h3 id="2-矩阵-向量乘加运算性能对比"><a href="#2-矩阵-向量乘加运算性能对比" class="headerlink" title="2. 矩阵-向量乘加运算性能对比"></a>2. <strong>矩阵-向量乘加运算性能对比</strong></h3><ul>
<li>在矩阵规模为 1000×300 的情况下，KML 的矩阵乘加操作（<code>cblas_dgemv</code>）相比手动实现加速显著。</li>
<li>时间数据<ul>
<li>手动实现耗时较长，主要由于逐元素计算导致的循环开销。</li>
<li>调用 KML 提供的 BLAS 库后，耗时明显减少，充分利用了向量化和并行化。</li>
</ul>
</li>
<li><strong>结论</strong>：KML 在矩阵计算场景中展现了出色的性能提升。</li>
</ul>
<h3 id="3-KML-VML-向量数学运算优化"><a href="#3-KML-VML-向量数学运算优化" class="headerlink" title="3. KML_VML 向量数学运算优化"></a>3. <strong>KML_VML 向量数学运算优化</strong></h3><ul>
<li>比较普通循环与 KML 的矢量数学库处理大规模向量（如 100,000 元素）的性能。</li>
<li>时间数据<ul>
<li>传统实现逐元素计算，耗时较长。</li>
<li>KML 利用硬件寄存器和 SIMD 指令对数据进行批量处理，极大缩短了运算时间。</li>
</ul>
</li>
<li><strong>分析</strong>：适合高频调用数学函数的场景，例如模拟计算和信号处理。</li>
</ul>
<h3 id="4-快速傅里叶变换（FFT）优化"><a href="#4-快速傅里叶变换（FFT）优化" class="headerlink" title="4. 快速傅里叶变换（FFT）优化"></a>4. <strong>快速傅里叶变换（FFT）优化</strong></h3><ul>
<li>对比一般 FFT 算法和 KML_FFT 实现的性能。</li>
<li>时间数据<ul>
<li>手动实现 FFT 的时间复杂度较高。</li>
<li>KML 的 <code>kml_fft_plan_r2r</code> 方法不仅加速了计算，还简化了实现过程。</li>
</ul>
</li>
<li><strong>结论</strong>：KML 的 FFT 模块对高维变换计算尤为高效。</li>
</ul>
<h3 id="5-LAPACK-在实对称矩阵特征值计算中的优化"><a href="#5-LAPACK-在实对称矩阵特征值计算中的优化" class="headerlink" title="5. LAPACK 在实对称矩阵特征值计算中的优化"></a>5. <strong>LAPACK 在实对称矩阵特征值计算中的优化</strong></h3><ul>
<li><strong>测试任务</strong>：计算 $10\times10$ 实对称矩阵的特征值和特征向量。</li>
<li>结果分析<ul>
<li>传统实现（如 Jacobi 方法）存在显著计算瓶颈。</li>
<li>调用 KML 提供的 LAPACK 接口后，计算时间大幅缩短，进一步展示了 KML 在线性代数中的优化潜力。</li>
</ul>
</li>
</ul>
<p>通过上述实验，验证了鲲鹏数学库（KML）的性能和适用性。无论是基础数学运算、矩阵计算，还是更复杂的快速变换与特征值问题，KML 的表现均优于传统实现。同时，实验中总结出的优化方法对未来的高性能计算实践提供了有力支持。</p>
<h2 id="6-思考题"><a href="#6-思考题" class="headerlink" title="6 思考题"></a>6 思考题</h2><h3 id="使用KML-SVML进行短向量的数学运算优化"><a href="#使用KML-SVML进行短向量的数学运算优化" class="headerlink" title="使用KML_SVML进行短向量的数学运算优化"></a>使用KML_SVML进行短向量的数学运算优化</h3><p>KML_SVML是短向量的数学运算，包括幂函数、三角函数、指数函数、双曲函数、对数函数等。 KML_SVML通过Neon指令优化、内联汇编等方法，对输入向量进行批量处理，充分利用了鲲鹏架构下的寄存器特点，实现了在鲲鹏服务器上的性能提升。</p>
<p>请在下面代码空缺处将调用KML_SVML库函数对短向量的数学运算进行优化的代码补充完整</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">include</span><span class="hljs-string">&lt;stdio.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span><span class="hljs-string">&lt;time.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span><span class="hljs-string">&lt;math.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span><span class="hljs-string">&quot;ksvml.h&quot;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> LEN 100000</span><br><br><span class="hljs-type">int</span> <span class="hljs-title function_">main</span><span class="hljs-params">()</span><br>&#123;<br><span class="hljs-type">double</span> src[LEN]=&#123;<span class="hljs-number">0</span>&#125;;<br><span class="hljs-type">double</span> dst1[LEN]=&#123;<span class="hljs-number">0</span>&#125;;<br><span class="hljs-type">double</span> dst2[LEN]=&#123;<span class="hljs-number">0</span>&#125;;<br><span class="hljs-type">float32x4_t</span> src2;<br><span class="hljs-type">float32x4_t</span> dst;<br><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">timespec</span> <span class="hljs-title">t1</span>,<span class="hljs-title">t2</span>;</span> <span class="hljs-comment">//定义初始与结束时间</span><br><span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;Without KML_SVML &quot;</span>);<br>clock_gettime(CLOCK_MONOTONIC,&amp;t1); <span class="hljs-comment">//计算开始时间。</span><br><span class="hljs-keyword">for</span>(<span class="hljs-type">int</span> i=<span class="hljs-number">0</span>;i&lt;LEN;i++)<br>src[i]=i;<br><span class="hljs-keyword">for</span>(<span class="hljs-type">int</span> i=<span class="hljs-number">0</span>;i&lt;LEN;i++)<br>dst1[i]=<span class="hljs-built_in">sin</span>(src[i]);<br>clock_gettime(CLOCK_MONOTONIC,&amp;t2); <span class="hljs-comment">//计算结束时间。</span><br><span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;Time:%11u ns\n&quot;</span>,t2.tv_nsec-t1.tv_nsec); <span class="hljs-comment">//得出目标代码段的执行时间。</span><br><br><span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;With KML_SVML &quot;</span>);<br>clock_gettime(CLOCK_MONOTONIC,&amp;t1); <span class="hljs-comment">//计算开始时间。  </span><br><span class="hljs-keyword">for</span>(<span class="hljs-type">int</span> i=<span class="hljs-number">0</span>;i&lt;LEN;i+=<span class="hljs-number">4</span>)<br>&#123;<br>   <br>	<span class="hljs-comment">//请在此处补充调用KML_SVML库函数对短向量的数学运算进行优化的代码</span><br>    <br>&#125;<br>clock_gettime(CLOCK_MONOTONIC,&amp;t2); <span class="hljs-comment">//计算结束时间。</span><br><span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;Time:%11u ns\n&quot;</span>,t2.tv_nsec-t1.tv_nsec); <span class="hljs-comment">//得出目标代码段的执行时间。</span><br><br><span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br><br>&#125;<br></code></pre></td></tr></table></figure>

<p>答案如下：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">include</span><span class="hljs-string">&lt;stdio.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span><span class="hljs-string">&lt;time.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span><span class="hljs-string">&lt;math.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span><span class="hljs-string">&quot;ksvml.h&quot;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> LEN 100000</span><br><br><span class="hljs-type">int</span> <span class="hljs-title function_">main</span><span class="hljs-params">()</span><br>&#123;<br><span class="hljs-type">double</span> src[LEN]=&#123;<span class="hljs-number">0</span>&#125;;<br><span class="hljs-type">double</span> dst1[LEN]=&#123;<span class="hljs-number">0</span>&#125;;<br><span class="hljs-type">double</span> dst2[LEN]=&#123;<span class="hljs-number">0</span>&#125;;<br><span class="hljs-type">float32x4_t</span> src2;<br><span class="hljs-type">float32x4_t</span> dst;<br><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">timespec</span> <span class="hljs-title">t1</span>,<span class="hljs-title">t2</span>;</span> <span class="hljs-comment">//定义初始与结束时间</span><br><span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;Without KML_SVML &quot;</span>);<br>clock_gettime(CLOCK_MONOTONIC,&amp;t1); <span class="hljs-comment">//计算开始时间。</span><br><span class="hljs-keyword">for</span>(<span class="hljs-type">int</span> i=<span class="hljs-number">0</span>;i&lt;LEN;i++)<br>src[i]=i;<br><span class="hljs-keyword">for</span>(<span class="hljs-type">int</span> i=<span class="hljs-number">0</span>;i&lt;LEN;i++)<br>dst1[i]=<span class="hljs-built_in">sin</span>(src[i]);<br>clock_gettime(CLOCK_MONOTONIC,&amp;t2); <span class="hljs-comment">//计算结束时间。</span><br><span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;Time:%11u ns\n&quot;</span>,t2.tv_nsec-t1.tv_nsec); <span class="hljs-comment">//得出目标代码段的执行时间。</span><br><br><span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;With KML_SVML &quot;</span>);<br>clock_gettime(CLOCK_MONOTONIC,&amp;t1); <span class="hljs-comment">//计算开始时间。  </span><br><span class="hljs-keyword">for</span>(<span class="hljs-type">int</span> i=<span class="hljs-number">0</span>;i&lt;LEN;i+=<span class="hljs-number">4</span>)<br>&#123;<br>    src2[<span class="hljs-number">0</span>]=i;<br>    src2[<span class="hljs-number">1</span>]=i+<span class="hljs-number">1</span>;<br>    src2[<span class="hljs-number">2</span>]=i+<span class="hljs-number">2</span>;<br>    src2[<span class="hljs-number">3</span>]=i+<span class="hljs-number">3</span>;<br>    dst = svml128_sin_f32(src2);<br>&#125;<br>clock_gettime(CLOCK_MONOTONIC,&amp;t2); <span class="hljs-comment">//计算结束时间。</span><br><span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;Time:%11u ns\n&quot;</span>,t2.tv_nsec-t1.tv_nsec); <span class="hljs-comment">//得出目标代码段的执行时间。</span><br><br><span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br><br>&#125;<br></code></pre></td></tr></table></figure>

<p>输入</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs c">gcc svsin.c -o svsin -I /usr/local/kml/include -L /usr/local/kml/lib -lksvml -lm<br>./svsin<br></code></pre></td></tr></table></figure>

<p>编译并运行得到运行结果如下：</p>
<p class='item-img' data-src=''><img src=""></p>
<span class="hide"><object><p>看不见是正常的，别担心</p></object></span>

<p>通过对比可知使用KML_SVML进行短向量的数学运算优化的优化效果十分显著</p>
<div id="paginator"></div></div><div id="post-footer"><div id="pages"><div class="footer-link" style="width: 50%;text-align:right;border-right:1px #fe2 solid"><a href="/2024/12/26/%E7%BE%8E%E8%B5%9B%E8%8B%9F%E6%B4%BB%E5%A4%A7%E6%B3%95/">← 下一篇 美赛苟活大法</a></div><div class="footer-link" style="width: 50%;right:1px;border-left:1px #fe2 solid"><a href="/2024/11/20/copy_wrong/">复制黏贴时内容异常出错原因分析 上一篇 →</a></div></div></div><details id="reward"><summary>打赏</summary><div><span>微信 | Wechat</span><br><img src="/images/WeChat.jpg"></div></details></div><div class="bottom-btn"><div><a class="i-top" id="to-top" onClick="scrolls.scrolltop();" title="回到顶部" style="opacity: 0; display: none;">∧ </a><a class="i-index" id="to-index" href="#toc-div" title="文章目录">≡</a><a class="i-color" id="color-mode" onClick="colorMode.change()" title="切换主题"></a></div></div></article><aside><div id="about"><a href="/" id="logo"><img src="/img/faction/1.png" alt="Logo"></a><h1 id="Dr"><a href="/">Zenith</a></h1><div id="description"><p>未经审视的人生是不值得过的人生。<br>大连理工大学软件工程本科在读。<br>本博客用于记录学习与生活点滴。</p></div></div><div id="aside-block"><div id="toc-div"><h1>目录</h1><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%9F%BA%E4%BA%8E%E9%B2%B2%E9%B9%8F%E6%95%B0%E5%AD%A6%E5%BA%93%E7%9A%84%E9%AB%98%E6%80%A7%E8%83%BD%E6%95%B0%E5%AD%A6%E8%AE%A1%E7%AE%97%E5%8A%A0%E9%80%9F%E6%96%B9%E6%B3%95%E7%A0%94%E7%A9%B6%E4%B8%8E%E5%AE%9E%E8%B7%B5"><span class="toc-number">1.</span> <span class="toc-text">基于鲲鹏数学库的高性能数学计算加速方法研究与实践</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#1-%E5%AE%9E%E9%AA%8C%E7%9B%AE%E7%9A%84"><span class="toc-number">1.1.</span> <span class="toc-text">1 实验目的</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1-%E9%AA%8C%E8%AF%81%E9%B2%B2%E9%B9%8F%E6%95%B0%E5%AD%A6%E5%BA%93%E7%9A%84%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96%E6%95%88%E6%9E%9C"><span class="toc-number">1.1.1.</span> <span class="toc-text">1. 验证鲲鹏数学库的性能优化效果</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-%E6%8E%A2%E7%B4%A2%E9%B2%B2%E9%B9%8F%E6%9E%B6%E6%9E%84%E7%9A%84%E7%A1%AC%E4%BB%B6%E9%80%82%E9%85%8D%E6%80%A7"><span class="toc-number">1.1.2.</span> <span class="toc-text">2. 探索鲲鹏架构的硬件适配性</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-%E4%BC%98%E5%8C%96%E5%AE%9E%E9%99%85%E7%A7%91%E5%AD%A6%E8%AE%A1%E7%AE%97%E4%BB%BB%E5%8A%A1"><span class="toc-number">1.1.3.</span> <span class="toc-text">3. 优化实际科学计算任务</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4-%E6%8F%90%E5%8D%87%E9%B2%B2%E9%B9%8F%E7%94%9F%E6%80%81%E7%9A%84%E5%AE%9E%E8%B7%B5%E7%BB%8F%E9%AA%8C"><span class="toc-number">1.1.4.</span> <span class="toc-text">4. 提升鲲鹏生态的实践经验</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#5-%E8%AF%84%E4%BC%B0%E6%80%A7%E8%83%BD%E4%B8%8E%E5%87%86%E7%A1%AE%E6%80%A7%E7%9A%84%E5%B9%B3%E8%A1%A1"><span class="toc-number">1.1.5.</span> <span class="toc-text">5. 评估性能与准确性的平衡</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#6-%E6%8E%A8%E5%8A%A8%E6%95%B0%E5%AD%A6%E8%AE%A1%E7%AE%97%E9%A2%86%E5%9F%9F%E7%9A%84%E6%8A%80%E6%9C%AF%E8%BF%9B%E6%AD%A5"><span class="toc-number">1.1.6.</span> <span class="toc-text">6. 推动数学计算领域的技术进步</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2-%E5%AE%9E%E9%AA%8C%E8%AE%BE%E5%A4%87"><span class="toc-number">1.2.</span> <span class="toc-text">2 实验设备</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#3-%E5%AE%9E%E9%AA%8C%E5%8E%9F%E7%90%86"><span class="toc-number">1.3.</span> <span class="toc-text">3 实验原理</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1-%E6%95%B0%E5%AD%A6%E5%BA%93%E4%BC%98%E5%8C%96%E7%9A%84%E6%A0%B8%E5%BF%83%E6%80%9D%E6%83%B3"><span class="toc-number">1.3.1.</span> <span class="toc-text">1. 数学库优化的核心思想</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-%E7%A1%AC%E4%BB%B6%E6%9E%B6%E6%9E%84%E4%B8%8E%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96%E7%9A%84%E5%85%B3%E7%B3%BB"><span class="toc-number">1.3.2.</span> <span class="toc-text">2. 硬件架构与性能优化的关系</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-%E6%95%B0%E5%AD%A6%E8%AE%A1%E7%AE%97%E7%9A%84%E5%A4%9A%E5%B1%82%E6%AC%A1%E4%BC%98%E5%8C%96%E6%96%B9%E6%B3%95"><span class="toc-number">1.3.3.</span> <span class="toc-text">3. 数学计算的多层次优化方法</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4-%E5%AE%9E%E9%AA%8C%E7%9A%84%E5%AF%B9%E6%AF%94%E8%AE%BE%E8%AE%A1%E4%B8%8E%E6%80%A7%E8%83%BD%E8%AF%84%E4%BC%B0%E7%AD%96%E7%95%A5"><span class="toc-number">1.3.4.</span> <span class="toc-text">4. 实验的对比设计与性能评估策略</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#5-%E5%85%B8%E5%9E%8B%E4%BC%98%E5%8C%96%E5%9C%BA%E6%99%AF"><span class="toc-number">1.3.5.</span> <span class="toc-text">5. 典型优化场景</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#6-KML-%E7%9A%84%E6%8E%A5%E5%8F%A3%E8%AE%BE%E8%AE%A1%E4%B8%8E%E6%98%93%E7%94%A8%E6%80%A7"><span class="toc-number">1.3.6.</span> <span class="toc-text">6. KML 的接口设计与易用性</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#4-%E5%AE%9E%E9%AA%8C%E4%BB%BB%E5%8A%A1%E6%93%8D%E4%BD%9C%E6%8C%87%E5%AF%BC"><span class="toc-number">1.4.</span> <span class="toc-text">4 实验任务操作指导</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#4-1%E5%AE%89%E8%A3%85KML"><span class="toc-number">1.4.1.</span> <span class="toc-text">4.1安装KML</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4-2-%E7%9F%A9%E9%98%B5-%E5%90%91%E9%87%8F%E4%B9%98%E5%8A%A0%E8%BF%90%E7%AE%97%E5%AF%B9%E6%AF%94%E5%AE%9E%E9%AA%8C"><span class="toc-number">1.4.2.</span> <span class="toc-text">4.2 矩阵-向量乘加运算对比实验</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4-3-%E8%B0%83%E7%94%A8KML-VML%E5%BA%93%E8%AE%A1%E7%AE%97100000%E4%B8%AA%E6%95%B0%E7%9A%84sin%E5%80%BC%E5%92%8C%E6%99%AE%E9%80%9A%E5%BE%AA%E7%8E%AF%E5%AF%B9%E6%AF%94%E4%BD%93%E7%8E%B0%E4%BC%98%E5%8C%96"><span class="toc-number">1.4.3.</span> <span class="toc-text">4.3 调用KML_VML库计算100000个数的sin值和普通循环对比体现优化</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4-4-%E4%BD%93%E7%8E%B0LAPACK%E5%BA%93%E6%80%A7%E8%83%BD%E7%9A%84%E5%AF%B9%E6%AF%94%E5%AE%9E%E9%AA%8C"><span class="toc-number">1.4.4.</span> <span class="toc-text">4.4 体现LAPACK库性能的对比实验</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4-5-%E4%BD%BF%E7%94%A8KML%E5%BA%93%E5%87%BD%E6%95%B0%E5%AE%9E%E7%8E%B0R2R%E5%8F%98%E6%8D%A2%E4%BC%98%E5%8C%96"><span class="toc-number">1.4.5.</span> <span class="toc-text">4.5 使用KML库函数实现R2R变换优化</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#5-%E5%AE%9E%E9%AA%8C%E7%BB%93%E6%9E%9C%E5%88%86%E6%9E%90"><span class="toc-number">1.5.</span> <span class="toc-text">5.实验结果分析</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1-%E7%89%9B%E9%A1%BF%E8%BF%AD%E4%BB%A3%E6%B3%95%E6%B1%82%E8%A7%A3%E9%9D%9E%E7%BA%BF%E6%80%A7%E6%96%B9%E7%A8%8B%E7%9A%84%E6%A0%B9"><span class="toc-number">1.5.1.</span> <span class="toc-text">1. 牛顿迭代法求解非线性方程的根</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-%E7%9F%A9%E9%98%B5-%E5%90%91%E9%87%8F%E4%B9%98%E5%8A%A0%E8%BF%90%E7%AE%97%E6%80%A7%E8%83%BD%E5%AF%B9%E6%AF%94"><span class="toc-number">1.5.2.</span> <span class="toc-text">2. 矩阵-向量乘加运算性能对比</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-KML-VML-%E5%90%91%E9%87%8F%E6%95%B0%E5%AD%A6%E8%BF%90%E7%AE%97%E4%BC%98%E5%8C%96"><span class="toc-number">1.5.3.</span> <span class="toc-text">3. KML_VML 向量数学运算优化</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4-%E5%BF%AB%E9%80%9F%E5%82%85%E9%87%8C%E5%8F%B6%E5%8F%98%E6%8D%A2%EF%BC%88FFT%EF%BC%89%E4%BC%98%E5%8C%96"><span class="toc-number">1.5.4.</span> <span class="toc-text">4. 快速傅里叶变换（FFT）优化</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#5-LAPACK-%E5%9C%A8%E5%AE%9E%E5%AF%B9%E7%A7%B0%E7%9F%A9%E9%98%B5%E7%89%B9%E5%BE%81%E5%80%BC%E8%AE%A1%E7%AE%97%E4%B8%AD%E7%9A%84%E4%BC%98%E5%8C%96"><span class="toc-number">1.5.5.</span> <span class="toc-text">5. LAPACK 在实对称矩阵特征值计算中的优化</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#6-%E6%80%9D%E8%80%83%E9%A2%98"><span class="toc-number">1.6.</span> <span class="toc-text">6 思考题</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BD%BF%E7%94%A8KML-SVML%E8%BF%9B%E8%A1%8C%E7%9F%AD%E5%90%91%E9%87%8F%E7%9A%84%E6%95%B0%E5%AD%A6%E8%BF%90%E7%AE%97%E4%BC%98%E5%8C%96"><span class="toc-number">1.6.1.</span> <span class="toc-text">使用KML_SVML进行短向量的数学运算优化</span></a></li></ol></li></ol></li></ol></div></div><footer><nobr><span class="icp-title">♖</span><a class="icp-content" href="https://smallgoodgood.top/about/">关于本站</a></nobr><br><nobr>Pubulished by <a href="http://smallgoodgood.top">Zenith <br></a></nobr><wbr><!-- 添加网站运行时间 --><span id="timeDate">载入天数...</span><span id="times">载入时分秒...</span><script>var now = new Date();

function createtime() {
  var grt = new Date("02/09/2024 00:00:00"); //此处修改你的建站时间或者网站上线时间 
  now.setTime(now.getTime() + 250);
  days = (now - grt) / 1000 / 60 / 60 / 24;
  dnum = Math.floor(days);
  hours = (now - grt) / 1000 / 60 / 60 - (24 * dnum);
  hnum = Math.floor(hours);
  if (String(hnum).length == 1) {
      hnum = "0" + hnum;
  }
  minutes = (now - grt) / 1000 / 60 - (24 * 60 * dnum) - (60 * hnum);
  mnum = Math.floor(minutes);
  if (String(mnum).length == 1) {
      mnum = "0" + mnum;
  }
  seconds = (now - grt) / 1000 - (24 * 60 * 60 * dnum) - (60 * 60 * hnum) - (60 * mnum);
  snum = Math.round(seconds);
  if (String(snum).length == 1) {
      snum = "0" + snum;
  }
  document.getElementById("timeDate").innerHTML = " | 本站已安全运行 " + dnum + " 天 ";
  document.getElementById("times").innerHTML = hnum + " 小时 " + mnum + " 分 " + snum + " 秒";
}
setInterval("createtime()", 250);
<!-- 添加网站运行时间 -->

</script></footer></aside></main><canvas id="canvas-dust"></canvas><script src="/live2dw/lib/L2Dwidget.min.js?094cbace49a39548bed64abff5988b05"></script><script>L2Dwidget.init({"model":{"jsonPath":"/live2dw/assets/hijiki.model.json"},"display":{"position":"left","width":150,"height":300},"mobile":{"show":true},"log":false,"pluginJsPath":"lib/","pluginModelPath":"assets/","pluginRootPath":"live2dw/","tagMode":false});</script></body></html>